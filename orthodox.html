<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>KETADATA // ICON PANEL</title>
<style>
:root{
  --bg:#000;
  --ink:rgba(255,255,255,.88);
  --muted:rgba(255,255,255,.54);
  --line:rgba(255,255,255,.14);
  --line2:rgba(255,255,255,.26);

  --gold1: rgba(255,214,118,.95);
  --gold2: rgba(255,214,118,.45);
  --gold3: rgba(255,214,118,.18);

  --crimson: rgba(205,40,40,.86);
  --lapis: rgba(40,90,170,.78);
  --smoke: rgba(255,255,255,.06);

  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  --sans: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

  --top:44px;
  --bot:34px;

  --ring: 1.25px;
  --pad: 10px;
  --gap: 10px;

  --I_GOLD: 0.50;    /* gold halo intensity */
  --I_GRAIN: 0.22;   /* paint/grain */
  --I_GLOW: 0.22;    /* ambient glow */
  --I_RAY:  0.22;    /* rayburst */
  --I_VIGN: 0.46;    /* vignette */
  --I_INVERT: 0;     /* invert toggle */
  --I_NULL: 0;       /* null blackout toggle */

  --motion: 1;       /* motion toggle */
}

*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  background:var(--bg);
  color:var(--ink);
  font-family:var(--sans);
  overflow:hidden;
}
a{color:inherit}
#root{
  position:fixed; inset:0;
  user-select:none;
}
#root.invert{ filter: invert(1) hue-rotate(180deg); }
#root.blackout .bar,
#root.blackout #botbar{ display:none; }
#root.blackout #stage{ inset:0; }
#root.blackout #sig{ display:none; }

.bar{
  position:fixed; left:0; right:0;
  height:var(--top);
  display:flex; align-items:center;
  padding:0 var(--pad);
  background:rgba(0,0,0,.72);
  border-bottom:1px solid var(--line);
  z-index:50;
}
#botbar{
  position:fixed; left:0; right:0; bottom:0;
  height:var(--bot);
  display:flex; align-items:center;
  padding:0 var(--pad);
  background:rgba(0,0,0,.72);
  border-top:1px solid var(--line);
  z-index:50;
}
.left, .right { display:flex; align-items:center; gap:10px; }
.left{ min-width: 380px; }
.mid{
  flex:1;
  display:flex; align-items:center; justify-content:center;
  gap:10px;
  overflow:hidden;
}
.right{ min-width: 360px; justify-content:flex-end; }

.pip{
  width:10px; height:10px;
  border:1px solid var(--line2);
  background:rgba(255,255,255,.04);
}
.brand{
  display:flex; flex-direction:column;
  line-height:1.05;
}
.brand .t{ font-family:var(--mono); font-size:12px; letter-spacing:.10em; opacity:.92; }
.brand .s{ font-family:var(--mono); font-size:11px; letter-spacing:.10em; opacity:.55; }

.btn{
  border:1px solid var(--line2);
  background:rgba(255,255,255,.04);
  color:var(--ink);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.08em;
  padding:6px 8px;
  cursor:pointer;
}
.btn:active{ transform: translateY(1px); }
.btn.tog.on{
  border-color: rgba(255,214,118,.55);
  box-shadow: 0 0 0 1px rgba(255,214,118,.18) inset;
}

.kv{
  display:flex; align-items:center; gap:8px;
  font-family:var(--mono); font-size:11px; letter-spacing:.08em;
  opacity:.86;
}
.kv .k{ opacity:.55; }
.kv .v{ opacity:.92; }

.sep{ width:1px; height:18px; background:var(--line); }

.range{
  display:flex; align-items:center; gap:8px;
  font-family:var(--mono); font-size:11px; letter-spacing:.06em;
}
.range label{ opacity:.62; }
.range input[type="range"]{ width:120px; }

#stage{
  position:fixed;
  inset: var(--top) 0 var(--bot) 0;
  overflow:hidden;
  background:#000;
}

/* ===== ICON PANEL ===== */
#panel{
  position:absolute;
  inset: 14px;
  border:1px solid var(--line);
  background:
    radial-gradient(1000px 650px at 50% 42%, rgba(255,214,118,.08), rgba(0,0,0,0) 60%),
    linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,0) 18%),
    rgba(0,0,0,.55);
  display:grid;
  grid-template-columns: 1.2fr .8fr;
  gap: 14px;
  padding: 14px;
}

/* left: icon */
#iconWrap{
  position:relative;
  border:1px solid var(--line);
  background:
    radial-gradient(900px 700px at 50% 38%, rgba(255,214,118, calc(var(--I_GOLD)*.18)), rgba(0,0,0,0) 62%),
    radial-gradient(900px 700px at 50% 60%, rgba(255,255,255, calc(var(--I_GLOW)*.06)), rgba(0,0,0,0) 66%),
    rgba(0,0,0,.46);
  overflow:hidden;
}

/* subtle “gesso” */
#gesso{
  position:absolute; inset:-40px;
  background:
    repeating-linear-gradient(0deg, rgba(255,255,255, calc(var(--I_GRAIN)*.045)) 0 1px, rgba(0,0,0,0) 1px 6px),
    repeating-linear-gradient(90deg, rgba(255,255,255, calc(var(--I_GRAIN)*.032)) 0 1px, rgba(0,0,0,0) 1px 8px);
  mix-blend-mode: overlay;
  opacity: .85;
  pointer-events:none;
  filter: blur(.2px);
}

/* “gold leaf” sheet */
#gold{
  position:absolute; inset:-20px;
  background:
    radial-gradient(1200px 900px at 40% 35%, rgba(255,214,118, calc(var(--I_GOLD)*.22)), rgba(0,0,0,0) 60%),
    radial-gradient(900px 700px at 70% 55%, rgba(255,214,118, calc(var(--I_GOLD)*.12)), rgba(0,0,0,0) 62%),
    conic-gradient(from 210deg at 50% 45%,
      rgba(255,214,118, calc(var(--I_GOLD)*.10)),
      rgba(255,214,118, 0) 22%,
      rgba(255,214,118, calc(var(--I_GOLD)*.08)) 38%,
      rgba(255,214,118, 0) 62%,
      rgba(255,214,118, calc(var(--I_GOLD)*.10)) 86%,
      rgba(255,214,118, 0)
    );
  opacity: .95;
  mix-blend-mode: screen;
  pointer-events:none;
  filter: blur(.2px);
}

/* rayburst behind halo */
#rays{
  position:absolute; inset:-80px;
  background:
    repeating-conic-gradient(from 0deg at 50% 44%,
      rgba(255,214,118, calc(var(--I_RAY)*.10)) 0 2deg,
      rgba(0,0,0,0) 2deg 7deg);
  opacity:.9;
  filter: blur(.4px);
  transform: rotate(12deg);
  mix-blend-mode: screen;
  pointer-events:none;
}

/* vignette */
#vign{
  position:absolute; inset:0;
  background: radial-gradient(closest-side at 50% 46%,
    rgba(0,0,0,0) 58%,
    rgba(0,0,0, calc(.55*var(--I_VIGN))) 78%,
    rgba(0,0,0, calc(.92*var(--I_VIGN))) 100%);
  pointer-events:none;
}

#iconSVG{
  position:absolute; inset:0;
  width:100%; height:100%;
}

/* right: inscription + controls */
#side{
  position:relative;
  border:1px solid var(--line);
  background: rgba(0,0,0,.46);
  overflow:hidden;
  padding: 12px;
  display:flex;
  flex-direction:column;
  gap: 12px;
}
.block{
  border:1px solid var(--line);
  background: rgba(255,255,255,.03);
  padding: 10px;
}
.block .h{
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.10em;
  opacity:.78;
  margin-bottom:8px;
  display:flex; justify-content:space-between; gap:10px;
}
.block .h .sub{opacity:.55}
.insc{
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.08em;
  line-height:1.35;
  white-space:pre-wrap;
  color:rgba(255,255,255,.78);
}
.small{
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.08em;
  opacity:.66;
  line-height:1.35;
}
.grid2{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}
.sliderRow{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  font-family:var(--mono);
  font-size:11px; letter-spacing:.06em;
}
.sliderRow span{opacity:.62}
.sliderRow input[type="range"]{ width: 160px; }

textarea{
  width:100%;
  min-height: 120px;
  resize: vertical;
  background: rgba(0,0,0,.55);
  color: rgba(255,255,255,.84);
  border:1px solid var(--line2);
  outline:none;
  font-family: var(--mono);
  font-size: 12px;
  padding: 10px;
  line-height: 1.35;
}

/* floating signature */
#sig{
  position:fixed;
  left:10px;
  bottom: calc(var(--bot) + 10px);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.10em;
  opacity:.58;
  z-index:60;
  pointer-events:none;
}

/* motion (subtle living panel) */
@keyframes drift{
  0%,100%{ transform: translate3d(0,0,0) }
  50%{ transform: translate3d(0,-8px,0) }
}
@keyframes shimmer{
  0%,100%{ filter: brightness(1) contrast(1) }
  50%{ filter: brightness(1.08) contrast(1.05) }
}
#root.motion #gold{ animation: shimmer 7s ease-in-out infinite; }
#root.motion #rays{ animation: shimmer 6s ease-in-out infinite; }
#root.motion #gesso{ animation: shimmer 10s ease-in-out infinite; }
#root.motion #panel{ animation: drift 12s ease-in-out infinite; }

</style>
</head>
<body>
<div id="root">
  <div class="bar" id="topbar">
    <div class="left">
      <div class="pip" title="KETADATA"></div>
      <div class="brand">
        <div class="t">KETADATA // ICON PANEL</div>
        <div class="s">SHELL8 KERNEL v2 · LOCAL · SINGLE-FILE</div>
      </div>
      <div class="sep"></div>
      <button class="btn tog" id="invertBtn" title="Shift+I">INVERT</button>
      <button class="btn tog" id="nullBtn" title="Shift+N">NULL</button>
      <button class="btn tog on" id="motionBtn" title="Motion">MOTION</button>
    </div>

    <div class="mid">
      <div class="kv"><span class="k">GOLD</span><span class="v" id="gLabel">50</span></div>
      <div class="sep"></div>
      <div class="kv"><span class="k">GRAIN</span><span class="v" id="grLabel">22</span></div>
      <div class="sep"></div>
      <div class="kv"><span class="k">RAYS</span><span class="v" id="rLabel">22</span></div>
      <div class="sep"></div>
      <div class="kv"><span class="k">VIGN</span><span class="v" id="vLabel">46</span></div>
    </div>

    <div class="right">
      <button class="btn" id="randomizeBtn">RE-INK</button>
      <button class="btn" id="resetBtn">RESET</button>
    </div>
  </div>

  <div id="stage">
    <div id="panel">
      <div id="iconWrap" aria-label="Icon surface">
        <div id="gold"></div>
        <div id="rays"></div>
        <div id="gesso"></div>

        <!-- SVG ICON (abstract icon-language; avoids direct religious icon replication) -->
        <svg id="iconSVG" viewBox="0 0 1000 1000" role="img" aria-label="Icon-inspired panel">
          <defs>
            <filter id="softGlow" x="-20%" y="-20%" width="140%" height="140%">
              <feGaussianBlur stdDeviation="2.4" result="b"/>
              <feColorMatrix in="b" type="matrix"
                values="1 0 0 0 0
                        0 1 0 0 0
                        0 0 1 0 0
                        0 0 0 .65 0" result="a"/>
              <feMerge>
                <feMergeNode in="a"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>

            <linearGradient id="robe" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="rgba(205,40,40,.88)"/>
              <stop offset="1" stop-color="rgba(205,40,40,.22)"/>
            </linearGradient>

            <linearGradient id="mantle" x1="1" y1="0" x2="0" y2="1">
              <stop offset="0" stop-color="rgba(40,90,170,.80)"/>
              <stop offset="1" stop-color="rgba(40,90,170,.22)"/>
            </linearGradient>

            <radialGradient id="halo" cx="50%" cy="44%" r="46%">
              <stop offset="0" stop-color="rgba(255,214,118,.22)"/>
              <stop offset="0.55" stop-color="rgba(255,214,118,.14)"/>
              <stop offset="1" stop-color="rgba(255,214,118,0)"/>
            </radialGradient>

            <pattern id="microCrackle" width="18" height="18" patternUnits="userSpaceOnUse">
              <path d="M2 4 L16 7" stroke="rgba(255,255,255,.10)" stroke-width="1"/>
              <path d="M3 15 L14 2" stroke="rgba(255,255,255,.08)" stroke-width="1"/>
              <path d="M1 9 L9 17" stroke="rgba(255,255,255,.06)" stroke-width="1"/>
            </pattern>
          </defs>

          <!-- frame -->
          <rect x="34" y="34" width="932" height="932" fill="rgba(0,0,0,.18)" stroke="rgba(255,255,255,.14)" stroke-width="2"/>
          <rect x="64" y="64" width="872" height="872" fill="rgba(0,0,0,.28)" stroke="rgba(255,255,255,.10)" stroke-width="2"/>

          <!-- halo field -->
          <circle cx="500" cy="430" r="290" fill="url(#halo)" opacity="0.95"/>

          <!-- stylized “figure” abstraction -->
          <!-- head -->
          <ellipse cx="500" cy="430" rx="120" ry="148" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.22)" stroke-width="2" filter="url(#softGlow)"/>
          <ellipse cx="500" cy="430" rx="92" ry="118" fill="rgba(0,0,0,.26)" stroke="rgba(255,255,255,.10)" stroke-width="2"/>

          <!-- eyes -->
          <ellipse cx="458" cy="430" rx="18" ry="12" fill="rgba(255,255,255,.60)"/>
          <ellipse cx="542" cy="430" rx="18" ry="12" fill="rgba(255,255,255,.60)"/>
          <circle cx="458" cy="431" r="6" fill="rgba(0,0,0,.85)"/>
          <circle cx="542" cy="431" r="6" fill="rgba(0,0,0,.85)"/>

          <!-- nose line -->
          <path d="M500 442 L490 480 L510 480" fill="none" stroke="rgba(255,255,255,.22)" stroke-width="2"/>
          <!-- mouth -->
          <path d="M465 505 Q500 522 535 505" fill="none" stroke="rgba(255,255,255,.22)" stroke-width="2"/>

          <!-- cross in halo (abstract) -->
          <path d="M500 240 L500 610" stroke="rgba(255,214,118,.50)" stroke-width="6" opacity="0.55"/>
          <path d="M360 430 L640 430" stroke="rgba(255,214,118,.50)" stroke-width="6" opacity="0.55"/>

          <!-- robes (two-layer geometry) -->
          <path d="M260 880
                   Q500 660 740 880
                   L820 880
                   Q760 640 640 560
                   Q560 510 500 510
                   Q440 510 360 560
                   Q240 640 180 880 Z"
                fill="url(#robe)" opacity="0.92" stroke="rgba(255,255,255,.10)" stroke-width="2"/>

          <path d="M310 880
                   Q500 720 690 880
                   L740 880
                   Q690 700 585 625
                   Q540 595 500 592
                   Q460 595 415 625
                   Q310 700 260 880 Z"
                fill="url(#mantle)" opacity="0.88" stroke="rgba(255,255,255,.08)" stroke-width="2"/>

          <!-- “script” bands -->
          <g opacity="0.55">
            <rect x="110" y="120" width="260" height="60" fill="rgba(0,0,0,.25)" stroke="rgba(255,255,255,.12)" stroke-width="2"/>
            <rect x="630" y="120" width="260" height="60" fill="rgba(0,0,0,.25)" stroke="rgba(255,255,255,.12)" stroke-width="2"/>
            <path d="M130 150 H350" stroke="rgba(255,214,118,.28)" stroke-width="3"/>
            <path d="M650 150 H870" stroke="rgba(255,214,118,.28)" stroke-width="3"/>
            <path d="M130 166 H330" stroke="rgba(255,214,118,.18)" stroke-width="2"/>
            <path d="M650 166 H840" stroke="rgba(255,214,118,.18)" stroke-width="2"/>
          </g>

          <!-- crackle overlay -->
          <rect x="64" y="64" width="872" height="872" fill="url(#microCrackle)" opacity="0.28" />

          <!-- lower seal -->
          <g opacity="0.75">
            <rect x="110" y="810" width="780" height="96" fill="rgba(0,0,0,.28)" stroke="rgba(255,255,255,.12)" stroke-width="2"/>
            <path d="M130 846 H870" stroke="rgba(255,214,118,.22)" stroke-width="3"/>
            <text x="500" y="878" text-anchor="middle"
              font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace"
              font-size="22"
              letter-spacing="6"
              fill="rgba(255,255,255,.66)">KETA // DATA</text>
          </g>
        </svg>

        <div id="vign"></div>
      </div>

      <div id="side">
        <div class="block">
          <div class="h"><span>INSCRIPTION</span><span class="sub">editable</span></div>
          <div class="insc" id="inscPreview"></div>
        </div>

        <div class="block">
          <div class="h"><span>INTENSIFIERS</span><span class="sub">local only</span></div>

          <div class="sliderRow"><span>GOLD</span><input id="goldR" type="range" min="0" max="100" value="50"/></div>
          <div class="sliderRow"><span>GRAIN</span><input id="grainR" type="range" min="0" max="100" value="22"/></div>
          <div class="sliderRow"><span>GLOW</span><input id="glowR" type="range" min="0" max="100" value="22"/></div>
          <div class="sliderRow"><span>RAYS</span><input id="raysR" type="range" min="0" max="100" value="22"/></div>
          <div class="sliderRow"><span>VIGNETTE</span><input id="vignR" type="range" min="0" max="100" value="46"/></div>

          <div class="grid2" style="margin-top:10px">
            <button class="btn" id="stampBtn">STAMP</button>
            <button class="btn" id="exportBtn">EXPORT TXT</button>
          </div>
        </div>

        <div class="block">
          <div class="h"><span>KETA_NOTE</span><span class="sub">optional capture</span></div>
          <textarea id="note" spellcheck="false"></textarea>
          <div class="small" id="noteHint">
            Shift+I invert · Shift+N null · Shift+F fullscreen · data stays local (localStorage).
          </div>
        </div>

        <div class="block">
          <div class="h"><span>STATUS</span><span class="sub" id="statusSub">ready</span></div>
          <div class="small" id="status"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="botbar">
    <div class="left">
      <div class="kv"><span class="k">FILE</span><span class="v" id="fileId"></span></div>
      <div class="sep"></div>
      <div class="kv"><span class="k">UPDATED</span><span class="v" id="updatedAt"></span></div>
    </div>
    <div class="mid">
      <div class="kv"><span class="k">LIGHT</span><span class="v" id="lightLabel">1</span></div>
      <div class="sep"></div>
      <div class="kv"><span class="k">MODE</span><span class="v" id="modeLabel">ICON</span></div>
    </div>
    <div class="right">
      <button class="btn" id="lightDownBtn" title="Light -">L-</button>
      <button class="btn" id="lightUpBtn" title="Light +">L+</button>
      <button class="btn" id="saveBtn">SAVE</button>
    </div>
  </div>

  <div id="sig"></div>
</div>

<script>
/* =========================
   KETADATA // ICON PANEL
   Local-first single-file.
   ========================= */

/* ----- helpers ----- */
const $ = (id)=>document.getElementById(id);
const clamp01 = (n)=>Math.max(0, Math.min(1, n));

/* ----- identity & state ----- */
const FILE_ID = (() => {
  const k = "KETA_ICON_FILE_ID_v1";
  let v = localStorage.getItem(k);
  if(!v){
    v = "KETA-ICON-" + Math.random().toString(16).slice(2,10).toUpperCase();
    localStorage.setItem(k, v);
  }
  return v;
})();

const LS_KEY = "KETA_ICON_STATE_v1::" + FILE_ID;

const DEFAULT = {
  ui: { invert:false, null:false, fullscreen:false, motion:true, light:1 },
  intens: { gold:.50, grain:.22, glow:.22, rays:.22, vign:.46 },
  text: {
    insc:
`KETADATA // ICON PANEL
NOT A REPLICA — AN INTERFACE ICON.
GOLD = SIGNAL.
BLACK = GROUND.
THE NOTE IS OPTIONAL.
THE SYSTEM IS LOCAL.`,
    note: ""
  },
  meta: { createdAt: new Date().toISOString(), updatedAt: new Date().toISOString(), version:"v1" }
};

let STATE = loadState();

/* ----- load/save ----- */
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return structuredClone(DEFAULT);
    const parsed = JSON.parse(raw);
    return deepFill(structuredClone(DEFAULT), parsed);
  }catch(e){
    return structuredClone(DEFAULT);
  }
}
function saveState(reason="save"){
  STATE.meta.updatedAt = new Date().toISOString();
  localStorage.setItem(LS_KEY, JSON.stringify(STATE));
  setStatus(`saved (${reason})`);
  render();
}
function deepFill(base, incoming){
  if(incoming==null || typeof incoming!=="object") return base;
  for(const k of Object.keys(incoming)){
    if(!(k in base)){
      base[k]=incoming[k];
      continue;
    }
    if(base[k] && typeof base[k]==="object" && !Array.isArray(base[k])
       && incoming[k] && typeof incoming[k]==="object" && !Array.isArray(incoming[k])){
      base[k]=deepFill(base[k], incoming[k]);
    }else{
      base[k]=incoming[k];
    }
  }
  return base;
}

/* ----- rendering ----- */
function setRootVars(){
  const r = document.documentElement.style;
  r.setProperty("--I_GOLD", String(clamp01(STATE.intens.gold)));
  r.setProperty("--I_GRAIN", String(clamp01(STATE.intens.grain)));
  r.setProperty("--I_GLOW", String(clamp01(STATE.intens.glow)));
  r.setProperty("--I_RAY",  String(clamp01(STATE.intens.rays)));
  r.setProperty("--I_VIGN", String(clamp01(STATE.intens.vign)));
  r.setProperty("--motion", STATE.ui.motion ? "1":"0");

  // tie some visuals to "glow" for extra life
  $("iconWrap").style.boxShadow =
    `0 0 ${Math.round(40*STATE.intens.glow)}px rgba(255,214,118,${(0.10*STATE.intens.glow).toFixed(3)}) inset,
     0 0 ${Math.round(24*STATE.intens.glow)}px rgba(255,255,255,${(0.06*STATE.intens.glow).toFixed(3)})`;
  $("stage").style.filter = `brightness(${(1 + 0.10*STATE.intens.glow).toFixed(3)})`;
}

function render(){
  const root=$("root");
  root.classList.toggle("invert", !!STATE.ui.invert);
  root.classList.toggle("blackout", !!STATE.ui.null);
  root.classList.toggle("motion", !!STATE.ui.motion);
  root.classList.toggle("fs", !!STATE.ui.fullscreen);

  setRootVars();

  $("invertBtn").classList.toggle("on", !!STATE.ui.invert);
  $("nullBtn").classList.toggle("on", !!STATE.ui.null);
  $("motionBtn").classList.toggle("on", !!STATE.ui.motion);

  $("goldR").value = String(Math.round(STATE.intens.gold*100));
  $("grainR").value = String(Math.round(STATE.intens.grain*100));
  $("glowR").value  = String(Math.round(STATE.intens.glow*100));
  $("raysR").value  = String(Math.round(STATE.intens.rays*100));
  $("vignR").value  = String(Math.round(STATE.intens.vign*100));

  $("gLabel").textContent  = String(Math.round(STATE.intens.gold*100));
  $("grLabel").textContent = String(Math.round(STATE.intens.grain*100));
  $("rLabel").textContent  = String(Math.round(STATE.intens.rays*100));
  $("vLabel").textContent  = String(Math.round(STATE.intens.vign*100));

  $("inscPreview").textContent = STATE.text.insc || "";
  $("note").value = STATE.text.note || "";

  $("fileId").textContent = FILE_ID;
  $("updatedAt").textContent = isoShort(STATE.meta.updatedAt);
  $("lightLabel").textContent = String(STATE.ui.light||1);

  $("sig").textContent = signatureLine();
}

/* ----- status ----- */
let statusTimer=null;
function setStatus(msg){
  $("statusSub").textContent = msg;
  $("status").textContent =
    `LS_KEY: ${LS_KEY}
INVERT: ${STATE.ui.invert ? "ON":"OFF"} · NULL: ${STATE.ui.null ? "ON":"OFF"} · MOTION: ${STATE.ui.motion ? "ON":"OFF"} · LIGHT: ${STATE.ui.light}
INTENS: gold=${round2(STATE.intens.gold)} grain=${round2(STATE.intens.grain)} glow=${round2(STATE.intens.glow)} rays=${round2(STATE.intens.rays)} vign=${round2(STATE.intens.vign)}
UPDATED: ${STATE.meta.updatedAt}`;
  clearTimeout(statusTimer);
  statusTimer=setTimeout(()=>{$("statusSub").textContent="ready";}, 900);
}
function round2(n){ return (Math.round(n*100)/100).toFixed(2); }
function isoShort(s){
  try{
    const d=new Date(s);
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const da=String(d.getDate()).padStart(2,"0");
    const hh=String(d.getHours()).padStart(2,"0");
    const mm=String(d.getMinutes()).padStart(2,"0");
    return `${y}-${m}-${da} ${hh}:${mm}`;
  }catch(e){ return String(s||""); }
}

/* ----- signature ----- */
function signatureLine(){
  const updated = isoShort(STATE.meta.updatedAt);
  return `AE/EE/WB · FILE_ID=${FILE_ID} · ROOM_ID=ICON_PANEL · VERSION=${STATE.meta.version} · UPDATED_AT=${updated} · CHANGELOG=init(icon-inspired panel)`;
}

/* ----- bindings ----- */
function bind(){
  $("invertBtn").onclick = ()=>{ STATE.ui.invert=!STATE.ui.invert; saveState("invert"); };
  $("nullBtn").onclick   = ()=>{ STATE.ui.null=!STATE.ui.null; saveState("null"); };
  $("motionBtn").onclick = ()=>{ STATE.ui.motion=!STATE.ui.motion; saveState("motion"); };

  $("saveBtn").onclick = ()=> saveState("manual");
  $("resetBtn").onclick = ()=>{
    const keepId = FILE_ID; // file id is stable
    STATE = structuredClone(DEFAULT);
    STATE.meta.createdAt = new Date().toISOString();
    STATE.meta.updatedAt = new Date().toISOString();
    saveState("reset");
    $("fileId").textContent = keepId;
  };

  $("randomizeBtn").onclick = ()=>{
    // controlled “re-ink”: small perturbations
    const j = (v,amt)=>clamp01(v + (Math.random()*2-1)*amt);
    STATE.intens.gold  = j(STATE.intens.gold,  0.12);
    STATE.intens.grain = j(STATE.intens.grain, 0.10);
    STATE.intens.glow  = j(STATE.intens.glow,  0.10);
    STATE.intens.rays  = j(STATE.intens.rays,  0.12);
    STATE.intens.vign  = j(STATE.intens.vign,  0.08);
    saveState("re-ink");
  };

  const bindR = (id, key)=>{
    $(id).addEventListener("input", (e)=>{
      const v = Number(e.target.value)/100;
      STATE.intens[key]=clamp01(v);
      render();
    });
    $(id).addEventListener("change", ()=> saveState("intensity"));
  };
  bindR("goldR","gold");
  bindR("grainR","grain");
  bindR("glowR","glow");
  bindR("raysR","rays");
  bindR("vignR","vign");

  $("note").addEventListener("input", (e)=>{
    STATE.text.note = e.target.value || "";
    // auto-save lightly (debounced)
    debounceSave("note");
  });

  $("stampBtn").onclick = ()=>{
    // append stamp to note, without overwriting
    const stamp = "\n\n" + signatureLine();
    STATE.text.note = (STATE.text.note || "") + stamp;
    $("note").value = STATE.text.note;
    saveState("stamp");
  };

  $("exportBtn").onclick = ()=>{
    const txt =
`KETADATA // ICON PANEL EXPORT
FILE_ID: ${FILE_ID}
UPDATED_AT: ${STATE.meta.updatedAt}

INSCRIPTION:
${STATE.text.insc}

NOTE:
${STATE.text.note}

STAMP:
${signatureLine()}
`;
    downloadText(`KETADATA_ICON_${FILE_ID}.txt`, txt);
    setStatus("exported");
  };

  $("lightDownBtn").onclick = ()=>{ STATE.ui.light = Math.max(1, (STATE.ui.light||1)-1); saveState("light"); };
  $("lightUpBtn").onclick   = ()=>{ STATE.ui.light = Math.min(6, (STATE.ui.light||1)+1); saveState("light"); };

  // inscription editing: click preview to edit in place via prompt-less textarea swap
  $("inscPreview").addEventListener("dblclick", ()=>{
    const current = STATE.text.insc || "";
    const next = window.prompt("Edit inscription text:", current);
    if(next===null) return;
    STATE.text.insc = String(next);
    saveState("inscription");
  });

  // hotkeys
  window.addEventListener("keydown", (e)=>{
    const t = (e.target && (e.target.tagName||"")).toLowerCase();
    const typing = (t==="textarea" || t==="input");
    if(e.shiftKey && e.key.toLowerCase()==="i"){
      e.preventDefault();
      STATE.ui.invert=!STATE.ui.invert; saveState("invert(hk)");
      return;
    }
    if(e.shiftKey && e.key.toLowerCase()==="n"){
      e.preventDefault();
      STATE.ui.null=!STATE.ui.null; saveState("null(hk)");
      return;
    }
    if(e.shiftKey && e.key.toLowerCase()==="f"){
      e.preventDefault();
      toggleFullscreen();
      return;
    }
    // lights 1–6 (even while typing, per your usual rule)
    const k = e.key;
    if(k>="1" && k<="6"){
      STATE.ui.light = Number(k);
      saveState("light(hk)");
      return;
    }
    // space toggles motion when not typing
    if(!typing && e.code==="Space"){
      e.preventDefault();
      STATE.ui.motion=!STATE.ui.motion; saveState("motion(space)");
      return;
    }
  });

  // autosave inscription if user pasted into note header convention
  setStatus("ready");
}

/* ----- debounce save ----- */
let dsT=null;
function debounceSave(reason){
  clearTimeout(dsT);
  dsT=setTimeout(()=>saveState(reason), 450);
}

/* ----- download ----- */
function downloadText(filename, text){
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 500);
}

/* ----- fullscreen ----- */
function toggleFullscreen(){
  const el = document.documentElement;
  if(!document.fullscreenElement){
    el.requestFullscreen?.();
    STATE.ui.fullscreen=true;
  }else{
    document.exitFullscreen?.();
    STATE.ui.fullscreen=false;
  }
  saveState("fullscreen");
}

/* init */
(function init(){
  $("fileId").textContent = FILE_ID;
  bind();
  render();
})();
</script>

<!--
AE/EE/WB · FILE_ID=KETA_ICON_FILE_ID_v1 · ROOM_ID=ICON_PANEL · VERSION=v1 · UPDATED_AT=local · CHANGELOG=init(icon-inspired panel)
-->
</body>
</html>
