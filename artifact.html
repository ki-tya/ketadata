<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KETADATA // BLACK BOOK CORPUS</title>

  <!-- AE ▸ BLACK GLASS ▸ SHARP EDGE LAW ▸ SAFE TO CARVE -->
  <style>
    :root{
      --bg:#000;
      --ink:#fff;
      --muted:#9a9a9a;
      --hair:#1b1b1b;
      --hair2:#2a2a2a;

      --topH:56px;
      --stripH:140px;

      --stageBg:#fff;          /* white background */
      --stageFrame:#0b0b0b;     /* black frame */
      --stageEdge:#2a2a2a;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, sans-serif;

      --noteBorder:#fff;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:var(--sans);
      overflow:hidden;
    }

    header{
      height:var(--topH);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 12px;
      border-bottom:1px solid var(--hair);
      background:#000;
      user-select:none;
    }
    .brand{ display:flex; flex-direction:column; line-height:1.05; min-width:0; }
    .brand .top{ font-weight:700; letter-spacing:.14em; font-size:12px; }
    .brand .sub{
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
      letter-spacing:.08em;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:52vw;
    }

    .topActions{ display:flex; gap:10px; align-items:center; min-width:0; }
    .btn{
      border:1px solid var(--hair2);
      background:#000;
      color:var(--ink);
      padding:7px 10px;
      font-size:11px;
      font-family:var(--mono);
      letter-spacing:.06em;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ border-color:#3b3b3b; }
    .btn:active{ transform:translateY(1px); }

    .mini{
      border:1px solid var(--hair2);
      background:#000;
      color:#fff;
      font-family:var(--mono);
      font-size:11px;
      padding:7px 10px;
      max-width:260px;
      min-width:180px;
    }
    .mini:focus{ outline:none; border-color:#3b3b3b; }

    .pill{
      border:1px solid var(--hair2);
      padding:2px 6px;
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
      letter-spacing:.06em;
      white-space:nowrap;
    }

    /* AE ▸ NOTE ICON LAW (filled when collapsed) */
    .noteIconBtn{
      width:30px; height:30px;
      border:1px solid var(--hair2);
      background:#000;
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
    }
    .noteIconBtn:hover{ border-color:#3b3b3b; }
    .sqIcon{
      width:12px; height:12px;
      border:1px solid var(--noteBorder);
      background:#000; /* visible note = hollow */
    }
    .sqIcon.filled{ background:#fff; } /* collapsed = filled */

    /* Layout */
    #wrap{
      height:calc(100% - var(--topH));
      display:grid;
      grid-template-rows: 1fr var(--stripH);
    }

    /* Stage */
    #stage{
      position:relative;
      background:var(--stageBg);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #frame{
      width:min(86vw, 980px);
      height:min(68vh, 760px);
      background:var(--stageFrame);
      border:1px solid var(--stageEdge);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
    }
    #imgWrap{
      width:100%;
      height:100%;
      background:#fff; /* white paper field */
      border:1px solid #fff;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    #mainImg{
      max-width:100%;
      max-height:100%;
      width:auto;
      height:auto;
      object-fit:contain; /* EE ▸ aspect preservation */
      image-rendering:auto;
      transform: translateZ(0);
    }

    #centerHUD{
      position:absolute;
      top:10px;
      left:10px;
      right:10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
    }
    .hudBox{
      pointer-events:auto;
      border:1px solid rgba(0,0,0,.25);
      background:rgba(255,255,255,.9);
      padding:6px 8px;
      font-family:var(--mono);
      font-size:10px;
      color:#000;
      letter-spacing:.06em;
      display:flex;
      gap:10px;
      align-items:center;
      max-width:70%;
      overflow:hidden;
    }
    .hudBox strong{ font-weight:700; }
    .hudRight{ justify-content:flex-end; max-width:30%; }

    /* Strip */
    #strip{
      border-top:1px solid var(--hair);
      background:#000;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    #stripTop{
      height:38px;
      border-bottom:1px solid var(--hair);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      user-select:none;
    }
    #stripTop .t{
      font-family:var(--mono);
      font-size:11px;
      letter-spacing:.14em;
    }
    #stripTop .m{
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
      letter-spacing:.08em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:60%;
      text-align:right;
    }
    #thumbs{
      height:calc(var(--stripH) - 38px);
      overflow:auto;
      padding:10px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .thumb{
      width:92px;
      height:92px;
      border:1px solid var(--hair2);
      background:#050505;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      flex:0 0 auto;
      position:relative;
    }
    .thumb:hover{ border-color:#3b3b3b; }
    .thumb.on{ border-color:#fff; }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:contain;
      background:#fff;
    }
    .thumb .n{
      position:absolute;
      bottom:3px;
      right:4px;
      font-family:var(--mono);
      font-size:10px;
      color:#000;
      background:rgba(255,255,255,.92);
      border:1px solid rgba(0,0,0,.25);
      padding:1px 4px;
    }

    /* Controls drawer */
    #drawer{
      position:fixed;
      right:12px;
      top:calc(var(--topH) + 12px);
      width:360px;
      max-height:calc(100vh - var(--topH) - 24px);
      background:#000;
      border:1px solid var(--hair2);
      z-index:40;
      display:flex;
      flex-direction:column;
    }
    #drawer.hidden{ display:none; }
    #drawerHead{
      height:42px;
      border-bottom:1px solid var(--hair);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      user-select:none;
      font-family:var(--mono);
      font-size:11px;
      letter-spacing:.14em;
      cursor:move;
    }
    #drawerBody{
      padding:10px;
      overflow:auto;
    }
    .box{
      border:1px solid var(--hair);
      padding:10px;
      margin-bottom:10px;
    }
    .label{
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
      letter-spacing:.14em;
      margin-bottom:6px;
      text-transform:uppercase;
    }
    .hint{
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
      letter-spacing:.06em;
      line-height:1.35;
      margin-top:8px;
    }
    .row2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:end; }

    input[type="range"]{ width:100%; }
    input[type="text"], textarea{
      width:100%;
      border:1px solid var(--hair2);
      background:#000;
      color:#fff;
      font-family:var(--mono);
      font-size:11px;
      padding:10px;
      outline:none;
    }
    textarea{ min-height:110px; resize:vertical; }

    .iconBtn{
      width:26px; height:26px;
      border:1px solid var(--hair2);
      display:grid; place-items:center;
      font-family:var(--mono);
      cursor:pointer;
      user-select:none;
      color:#fff;
    }
    .iconBtn:hover{ border-color:#3b3b3b; }

    /* Floating notes (global + book) */
    .floatNote{
      position:fixed;
      top:calc(var(--topH) + 14px);
      left:14px;
      width:360px;
      height:240px;
      border:1px solid #fff;
      background:#000;
      z-index:60;
      display:flex;
      flex-direction:column;
    }
    .floatNote.hidden{ display:none; }
    .floatNoteHead{
      height:38px;
      border-bottom:1px solid var(--hair);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      cursor:move;
      user-select:none;
      font-family:var(--mono);
      font-size:11px;
      letter-spacing:.12em;
    }
    .floatNoteBody{ padding:10px; height:100%; }
    .floatNoteText{
      height:100%;
      width:100%;
      resize:none;
      border:1px solid var(--hair2);
      background:#000;
      color:#fff;
      font-family:var(--mono);
      font-size:11px;
      padding:8px;
      outline:none;
    }
    .resizer{
      position:absolute;
      right:2px; bottom:2px;
      width:14px; height:14px;
      border:1px solid var(--hair2);
      cursor:nwse-resize;
    }

    ::-webkit-scrollbar{ width:10px; height:10px; }
    ::-webkit-scrollbar-thumb{ background:#222; border:2px solid #000; }
    ::-webkit-scrollbar-track{ background:#000; }
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <div class="top">KETADATA</div>
      <div class="sub" id="subline">BLACK BOOK CORPUS // GLASS BOX MODE // INVERT LAW</div>
    </div>

    <div class="topActions">
      <!-- WB ▸ ICONS (two notes) -->
      <div class="noteIconBtn" id="globalNoteBtn" title="GLOBAL KETA NOTE (N)">
        <div class="sqIcon" id="globalNoteSq"></div>
      </div>
      <div class="noteIconBtn" id="bookNoteBtn" title="BOOK NOTE (B)">
        <div class="sqIcon" id="bookNoteSq"></div>
      </div>

      <select class="mini" id="bookSel" title="Select book"></select>

      <button class="btn" id="prevBtn">PREV</button>
      <div class="pill" id="pagePill">—</div>
      <button class="btn" id="nextBtn">NEXT</button>

      <button class="btn" id="drawerBtn">CONTROLS</button>
      <button class="btn" id="exportBtn">EXPORT STATE</button>
    </div>
  </header>

  <div id="wrap">
    <section id="stage">
      <div id="centerHUD">
        <div class="hudBox" id="hudLeft"><strong>—</strong><span id="hudInfo">—</span></div>
        <div class="hudBox hudRight" id="hudRight"><span id="hudStatus">READY</span></div>
      </div>

      <div id="frame">
        <div id="imgWrap">
          <img id="mainImg" alt="page" />
        </div>
      </div>
    </section>

    <section id="strip">
      <div id="stripTop">
        <div class="t">PAGES</div>
        <div class="m" id="stripMeta">—</div>
      </div>
      <div id="thumbs"></div>
    </section>
  </div>

  <!-- AE ▸ CONTROLS DRAWER (hidable) -->
  <aside id="drawer" class="hidden">
    <div id="drawerHead">
      <div>CONTROLS</div>
      <div style="display:flex;gap:8px;">
        <div class="iconBtn" id="drawerClose" title="close">×</div>
      </div>
    </div>
    <div id="drawerBody">
      <div class="box">
        <div class="label">MANIFEST / BOOKS INPUT</div>
        <div class="hint">EE ▸ Preferred: load the manifest JSON from the Manifest+Validator tool. This viewer cannot list your repo directories on its own.</div>
        <div style="height:10px"></div>
        <div class="row2">
          <div>
            <div class="label">LOAD MANIFEST JSON (FILE)</div>
            <input id="manifestFile" type="file" accept="application/json" />
          </div>
          <div>
            <div class="label">LOAD MANIFEST JSON (URL)</div>
            <input id="manifestUrl" type="text" placeholder="e.g. blackbooks/manifest.json" />
          </div>
        </div>
        <div style="height:10px"></div>
        <button class="btn" id="loadManifestBtn" style="width:100%;">LOAD</button>
        <div class="hint">WB ▸ If you host the manifest at <span style="color:#fff;">blackbooks/manifest.json</span>, URL load is frictionless.</div>
      </div>

      <div class="box">
        <div class="label">VISUAL LAW</div>
        <div class="hint">Ritual: White field + black page + inverted ink. Default = enforced.</div>

        <div style="height:10px"></div>
        <div class="label">INVERT (0–100)</div>
        <input id="invert" type="range" min="0" max="100" value="100" />

        <div style="height:10px"></div>
        <div class="label">CONTRAST (50–250)</div>
        <input id="contrast" type="range" min="50" max="250" value="140" />

        <div style="height:10px"></div>
        <div class="label">BRIGHTNESS (50–200)</div>
        <input id="brightness" type="range" min="50" max="200" value="110" />

        <div style="height:10px"></div>
        <div class="label">SATURATION (0–250)</div>
        <input id="saturation" type="range" min="0" max="250" value="100" />

        <div style="height:10px"></div>
        <div class="row2">
          <div>
            <div class="label">SHARPEN (CSS)</div>
            <select id="sharpen" class="mini" style="width:100%;">
              <option value="0">OFF</option>
              <option value="1">SOFT</option>
              <option value="2">HARD</option>
            </select>
          </div>
          <div>
            <div class="label">MODE</div>
            <select id="mode" class="mini" style="width:100%;">
              <option value="canon">CANON</option>
              <option value="freak">FREAK</option>
              <option value="xray">XRAY</option>
              <option value="night">NIGHT</option>
            </select>
          </div>
        </div>

        <div style="height:10px"></div>
        <button class="btn" id="resetVisualBtn" style="width:100%;">RESET VISUALS</button>
      </div>

      <div class="box">
        <div class="label">BOOK ICON / THUMBS</div>
        <div class="hint">EE ▸ First page is the icon. Thumbs are lazy-loaded.</div>
        <div style="height:10px"></div>
        <div class="row2">
          <div>
            <div class="label">THUMB SIZE</div>
            <input id="thumbSize" type="range" min="64" max="160" value="92" />
          </div>
          <div>
            <div class="label">PREFETCH</div>
            <select id="prefetch" class="mini" style="width:100%;">
              <option value="0">OFF</option>
              <option value="6">6 PAGES</option>
              <option value="12">12 PAGES</option>
              <option value="24">24 PAGES</option>
            </select>
          </div>
        </div>
      </div>

      <div class="box">
        <div class="label">KEYS</div>
        <div class="hint">
          ←/→ page · ↑/↓ book · N global note · B book note · C controls · E export state
        </div>
      </div>
    </div>
  </aside>

  <!-- GLOBAL NOTE -->
  <div class="floatNote" id="globalNote">
    <div class="floatNoteHead" id="globalNoteHead">
      <div style="display:flex;gap:10px;align-items:center;">
        <div style="width:10px;height:10px;border:1px solid #fff;background:#000;"></div>
        <div>GLOBAL KETA NOTE</div>
      </div>
      <div style="display:flex;gap:8px;">
        <div class="iconBtn" id="globalMin" title="collapse">–</div>
        <div class="iconBtn" id="globalClose" title="hide">×</div>
      </div>
    </div>
    <div class="floatNoteBody">
      <textarea class="floatNoteText" id="globalText" placeholder="MECHANISM // LAWS // NEXT ACTIONS"></textarea>
    </div>
    <div class="resizer" id="globalRes"></div>
  </div>

  <!-- BOOK NOTE -->
  <div class="floatNote" id="bookNote" style="left:392px;">
    <div class="floatNoteHead" id="bookNoteHead">
      <div style="display:flex;gap:10px;align-items:center;min-width:0;">
        <div style="width:10px;height:10px;border:1px solid #fff;background:#000;"></div>
        <div id="bookNoteTitle" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">BOOK NOTE</div>
      </div>
      <div style="display:flex;gap:8px;">
        <div class="iconBtn" id="bookMin" title="collapse">–</div>
        <div class="iconBtn" id="bookClose" title="hide">×</div>
      </div>
    </div>
    <div class="floatNoteBody">
      <textarea class="floatNoteText" id="bookText" placeholder="BOOK RITE // TAGS // THEMES // EXTRACTIONS"></textarea>
    </div>
    <div class="resizer" id="bookRes"></div>
  </div>

  <!-- EE ▸ DEFAULT BOOKS (replace or load manifest) -->
  <script>
    /* EE ▸ BOOKS ARRAY (seed) ▸ replace with your own OR load manifest */
    const BOOKS = [
      /* Example:
      { id:"bb01", title:"BLACK BOOK I", basePath:"blackbooks/bb01/pages", pageCount:120, pad:3, ext:"jpg" }
      */
    ];
  </script>

  <script>
    /* WB ▸ SELECTORS ▸ DO NOT RENAME IDs */
    const $ = (id)=>document.getElementById(id);

    const els = {
      subline:$("subline"),
      bookSel:$("bookSel"),
      prevBtn:$("prevBtn"),
      nextBtn:$("nextBtn"),
      pagePill:$("pagePill"),
      drawerBtn:$("drawerBtn"),
      exportBtn:$("exportBtn"),

      stage:$("stage"),
      mainImg:$("mainImg"),
      hudLeft:$("hudLeft"),
      hudInfo:$("hudInfo"),
      hudStatus:$("hudStatus"),
      stripMeta:$("stripMeta"),
      thumbs:$("thumbs"),

      drawer:$("drawer"),
      drawerClose:$("drawerClose"),
      drawerHead:$("drawerHead"),

      manifestFile:$("manifestFile"),
      manifestUrl:$("manifestUrl"),
      loadManifestBtn:$("loadManifestBtn"),

      invert:$("invert"),
      contrast:$("contrast"),
      brightness:$("brightness"),
      saturation:$("saturation"),
      sharpen:$("sharpen"),
      mode:$("mode"),
      resetVisualBtn:$("resetVisualBtn"),
      thumbSize:$("thumbSize"),
      prefetch:$("prefetch"),

      globalNoteBtn:$("globalNoteBtn"),
      globalNoteSq:$("globalNoteSq"),
      globalNote:$("globalNote"),
      globalNoteHead:$("globalNoteHead"),
      globalMin:$("globalMin"),
      globalClose:$("globalClose"),
      globalText:$("globalText"),
      globalRes:$("globalRes"),

      bookNoteBtn:$("bookNoteBtn"),
      bookNoteSq:$("bookNoteSq"),
      bookNote:$("bookNote"),
      bookNoteHead:$("bookNoteHead"),
      bookNoteTitle:$("bookNoteTitle"),
      bookMin:$("bookMin"),
      bookClose:$("bookClose"),
      bookText:$("bookText"),
      bookRes:$("bookRes"),
    };

    (function assert(){
      const miss = Object.entries(els).filter(([k,v])=>!v).map(([k])=>k);
      if(miss.length){
        document.body.innerHTML = `<pre style="padding:16px;background:#000;color:#fff;font-family:monospace;">WB ▸ MISSING BINDINGS:\n${miss.join("\n")}</pre>`;
        throw new Error(miss.join(","));
      }
    })();

    /* EE ▸ STATE ▸ SINGLE SOURCE ▸ PERSIST */
    const STORAGE_KEY = "ketadata_blackbooks_viewer_v1";
    const STATE = {
      version:"ketadata-blackbooks-viewer-v1",
      books: [],
      bookId: null,
      page: 1,

      visual: {
        invert: 100,
        contrast: 140,
        brightness: 110,
        saturation: 100,
        sharpen: "0",
        mode: "canon"
      },
      thumbs: { size: 92, prefetch: "0" },

      notes: {
        global: "",
        byBook: {} // bookId -> text
      },

      ui: {
        drawerOpen: false,
        globalNoteOpen: true,
        bookNoteOpen: true,
        drawerPos: { top: null, left: null }, // optional
      }
    };

    function save(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE)); }catch{} }
    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const s = JSON.parse(raw);
        if(s && s.version === STATE.version){
          Object.assign(STATE, s);
        }
      }catch{}
    }

    function status(t){ els.hudStatus.textContent = t; }
    function pad(n, w){ return String(n).padStart(w, "0"); }

    function currentBook(){ return STATE.books.find(b=>b.id===STATE.bookId) || STATE.books[0] || null; }

    function setGlobalNoteIcon(){ els.globalNoteSq.classList.toggle("filled", !STATE.ui.globalNoteOpen); }
    function setBookNoteIcon(){ els.bookNoteSq.classList.toggle("filled", !STATE.ui.bookNoteOpen); }

    /* EE ▸ VISUAL FILTER RITE */
    function applyVisual(){
      const v = STATE.visual;
      const inv = (v.invert/100).toFixed(2);
      const con = (v.contrast/100).toFixed(2);
      const bri = (v.brightness/100).toFixed(2);
      const sat = (v.saturation/100).toFixed(2);

      // Mode modifiers (minimal, no flair)
      let hue = "0deg";
      let extra = "";
      if(v.mode==="freak"){ hue = "180deg"; extra = "sepia(0.25)"; }
      if(v.mode==="xray"){ extra = "grayscale(1)"; con = (Math.min(2.5, v.contrast/80)).toFixed(2); }
      if(v.mode==="night"){ extra = "grayscale(0.6)"; bri = (Math.max(0.6, v.brightness/130)).toFixed(2); }

      // Sharpen proxy (CSS filter trick; intentionally simple)
      // 0 off, 1 soft, 2 hard
      const sharp = v.sharpen==="0" ? "" : (v.sharpen==="1" ? "contrast(1.05)" : "contrast(1.12)");

      els.mainImg.style.filter = `invert(${inv}) contrast(${con}) brightness(${bri}) saturate(${sat}) hue-rotate(${hue}) ${extra} ${sharp}`.trim();

      // Apply same to thumbs via CSS variable on container (set inline on each thumb img at render)
      save();
    }

    /* EE ▸ URL CONJURE */
    function pageUrl(book, n){
      return `${book.basePath}/page_${pad(n, book.pad)}.${book.ext}`;
    }

    /* EE ▸ RENDER ▸ BOOK SELECT */
    function renderBooks(){
      els.bookSel.innerHTML = "";
      for(const b of STATE.books){
        const opt = document.createElement("option");
        opt.value = b.id;
        opt.textContent = `${b.id.toUpperCase()} // ${b.title}`;
        els.bookSel.appendChild(opt);
      }
      if(!STATE.bookId && STATE.books.length) STATE.bookId = STATE.books[0].id;
      els.bookSel.value = STATE.bookId || "";
    }

    /* EE ▸ THUMBS ▸ LAZY RITE */
    let thumbObserver = null;
    function buildThumbObserver(){
      if(thumbObserver) thumbObserver.disconnect();
      thumbObserver = new IntersectionObserver((entries)=>{
        entries.forEach(e=>{
          if(!e.isIntersecting) return;
          const img = e.target.querySelector("img[data-src]");
          if(img){
            img.src = img.dataset.src;
            img.removeAttribute("data-src");
          }
          thumbObserver.unobserve(e.target);
        });
      }, { root: els.thumbs, threshold: 0.1 });
    }

    function renderThumbs(){
      const b = currentBook();
      els.thumbs.innerHTML = "";
      if(!b){ els.stripMeta.textContent="no books"; return; }

      const size = Number(STATE.thumbs.size || 92);
      els.thumbs.style.gap = "10px";
      const count = b.pageCount || 0;

      els.stripMeta.textContent = `${b.title} // ${count} pages // icon = page 1`;

      buildThumbObserver();

      for(let i=1;i<=count;i++){
        const cell = document.createElement("div");
        cell.className = "thumb" + (i===STATE.page ? " on" : "");
        cell.style.width = size + "px";
        cell.style.height = size + "px";

        const img = document.createElement("img");
        img.alt = `p${i}`;
        img.style.filter = els.mainImg.style.filter || "";

        // lazy: use data-src
        img.dataset.src = pageUrl(b, i);

        const n = document.createElement("div");
        n.className = "n";
        n.textContent = String(i);

        cell.appendChild(img);
        cell.appendChild(n);

        cell.addEventListener("click", ()=>{
          STATE.page = i;
          save();
          render();
        });

        els.thumbs.appendChild(cell);
        thumbObserver.observe(cell);
      }

      // Auto-scroll current thumb into view (ritual: center)
      requestAnimationFrame(()=>{
        const on = els.thumbs.querySelector(".thumb.on");
        if(on) on.scrollIntoView({behavior:"smooth", inline:"center", block:"nearest"});
      });

      // Prefetch near pages if requested
      const pf = parseInt(STATE.thumbs.prefetch || "0", 10);
      if(pf>0) prefetchAround(b, STATE.page, pf);
    }

    /* EE ▸ PREFETCH RITE */
    function prefetchAround(book, page, span){
      const start = Math.max(1, page - Math.floor(span/2));
      const end = Math.min(book.pageCount, start + span - 1);
      for(let i=start;i<=end;i++){
        const img = new Image();
        img.src = pageUrl(book, i);
      }
    }

    /* EE ▸ MAIN RENDER */
    function render(){
      const b = currentBook();
      if(!b){
        els.hudLeft.innerHTML = `<strong>NO BOOKS</strong>`;
        els.hudInfo.textContent = "Load manifest or edit BOOKS[]";
        els.mainImg.removeAttribute("src");
        els.pagePill.textContent = "—";
        els.bookNoteTitle.textContent = "BOOK NOTE";
        return;
      }

      // Clamp page
      const max = b.pageCount || 1;
      if(STATE.page < 1) STATE.page = 1;
      if(STATE.page > max) STATE.page = max;

      // HUD
      els.hudLeft.innerHTML = `<strong>${b.id.toUpperCase()}</strong>`;
      els.hudInfo.textContent = `${b.title} // page ${STATE.page}/${max}`;
      els.pagePill.textContent = `${STATE.page}/${max}`;
      els.bookNoteTitle.textContent = `BOOK NOTE // ${b.id.toUpperCase()} // ${b.title}`;

      // Book note content
      const bn = STATE.notes.byBook[b.id] || "";
      els.bookText.value = bn;

      // Main image load
      const url = pageUrl(b, STATE.page);
      status("LOADING");
      els.mainImg.onload = ()=> status("READY");
      els.mainImg.onerror = ()=> status("MISSING");
      els.mainImg.src = url;

      // Ensure visuals are applied
      applyVisual();

      // Update thumbs
      renderThumbs();

      // Persist selection
      save();
    }

    /* EE ▸ MANIFEST INGEST */
    function ingestBooks(rawBooks){
      const clean = (rawBooks||[])
        .map(b => ({
          id: String(b.id),
          title: String(b.title || b.id),
          basePath: String(b.basePath || b.pagesPath || ""),
          pageCount: Number(b.pageCount || b.maxPage || 0),
          pad: Number(b.pad || 3),
          ext: String(b.ext || "jpg").toLowerCase()
        }))
        .filter(b => b.id && b.basePath && b.pageCount > 0);

      STATE.books = clean;
      if(!STATE.bookId || !clean.find(x=>x.id===STATE.bookId)) STATE.bookId = clean[0]?.id || null;
      STATE.page = 1;
      save();
      renderBooks();
      render();
    }

    async function loadManifestFromUrl(url){
      const res = await fetch(url, {cache:"no-store"});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    }

    function parseManifestJson(obj){
      // Accept either: {books:[...]} OR direct array
      if(Array.isArray(obj)) return obj;
      if(obj && Array.isArray(obj.books)) return obj.books;
      if(obj && obj.manifest && Array.isArray(obj.manifest.books)) return obj.manifest.books;
      return [];
    }

    /* WB ▸ NOTE TOGGLES */
    function openDrawer(on){
      STATE.ui.drawerOpen = !!on;
      els.drawer.classList.toggle("hidden", !STATE.ui.drawerOpen);
      save();
    }
    function openGlobalNote(on){
      STATE.ui.globalNoteOpen = !!on;
      els.globalNote.classList.toggle("hidden", !STATE.ui.globalNoteOpen);
      setGlobalNoteIcon();
      save();
    }
    function openBookNote(on){
      STATE.ui.bookNoteOpen = !!on;
      els.bookNote.classList.toggle("hidden", !STATE.ui.bookNoteOpen);
      setBookNoteIcon();
      save();
    }

    /* EE ▸ EXPORT STATE */
    function exportState(){
      const out = {
        version: STATE.version,
        exportedAt: new Date().toISOString(),
        selected: { bookId: STATE.bookId, page: STATE.page },
        visual: STATE.visual,
        thumbs: STATE.thumbs,
        notes: STATE.notes,
        books: STATE.books
      };
      const txt = JSON.stringify(out, null, 2);
      const blob = new Blob([txt], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `ketadata_blackbooks_state_${new Date().toISOString().replace(/[:.]/g,"-")}.json`;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
    }

    /* WB ▸ DRAG/RESIZE RITUAL (drawer + notes) */
    function makeDraggable(box, head){
      let dragging=false, sx=0, sy=0, sl=0, st=0;
      head.addEventListener("mousedown",(e)=>{
        dragging=true;
        const r = box.getBoundingClientRect();
        sl=r.left; st=r.top; sx=e.clientX; sy=e.clientY;
        document.addEventListener("mousemove", mv);
        document.addEventListener("mouseup", up);
        e.preventDefault();
      });
      function mv(e){
        if(!dragging) return;
        box.style.left = (sl + (e.clientX - sx)) + "px";
        box.style.top  = (st + (e.clientY - sy)) + "px";
        box.style.right = "auto";
      }
      function up(){
        dragging=false;
        document.removeEventListener("mousemove", mv);
        document.removeEventListener("mouseup", up);
      }
    }

    function makeResizable(box, resizer){
      let resizing=false, sx=0, sy=0, sw=0, sh=0;
      resizer.addEventListener("mousedown",(e)=>{
        e.preventDefault();
        resizing=true;
        const r = box.getBoundingClientRect();
        sw=r.width; sh=r.height; sx=e.clientX; sy=e.clientY;
        document.addEventListener("mousemove", mv);
        document.addEventListener("mouseup", up);
      });
      function mv(e){
        if(!resizing) return;
        box.style.width  = Math.max(260, sw + (e.clientX - sx)) + "px";
        box.style.height = Math.max(160, sh + (e.clientY - sy)) + "px";
      }
      function up(){
        resizing=false;
        document.removeEventListener("mousemove", mv);
        document.removeEventListener("mouseup", up);
      }
    }

    /* EE ▸ BOOT */
    function boot(){
      load();

      // Seed: if STATE has books, use them; else use BOOKS const
      if(Array.isArray(STATE.books) && STATE.books.length){
        // ok
      } else if(Array.isArray(BOOKS) && BOOKS.length){
        STATE.books = BOOKS.map(b=>({...b}));
      }

      // Apply persisted UI
      openDrawer(!!STATE.ui.drawerOpen);
      openGlobalNote(STATE.ui.globalNoteOpen !== false);
      openBookNote(STATE.ui.bookNoteOpen !== false);

      // Hydrate controls
      els.invert.value = String(STATE.visual.invert ?? 100);
      els.contrast.value = String(STATE.visual.contrast ?? 140);
      els.brightness.value = String(STATE.visual.brightness ?? 110);
      els.saturation.value = String(STATE.visual.saturation ?? 100);
      els.sharpen.value = String(STATE.visual.sharpen ?? "0");
      els.mode.value = String(STATE.visual.mode ?? "canon");

      els.thumbSize.value = String(STATE.thumbs.size ?? 92);
      els.prefetch.value = String(STATE.thumbs.prefetch ?? "0");

      els.globalText.value = STATE.notes.global || "";

      renderBooks();
      if(!STATE.bookId && STATE.books.length) STATE.bookId = STATE.books[0].id;

      // Apply visuals early
      applyVisual();

      // Wire drag/resize
      makeDraggable(els.drawer, els.drawerHead);
      makeDraggable(els.globalNote, els.globalNoteHead);
      makeDraggable(els.bookNote, els.bookNoteHead);
      makeResizable(els.globalNote, els.globalRes);
      makeResizable(els.bookNote, els.bookRes);

      render();
      status("READY");
    }

    /* WB ▸ EVENTS */
    els.bookSel.addEventListener("change", ()=>{
      STATE.bookId = els.bookSel.value;
      STATE.page = 1;
      save();
      render();
    });

    els.prevBtn.addEventListener("click", ()=>{
      STATE.page -= 1;
      save();
      render();
    });

    els.nextBtn.addEventListener("click", ()=>{
      STATE.page += 1;
      save();
      render();
    });

    els.drawerBtn.addEventListener("click", ()=> openDrawer(!STATE.ui.drawerOpen));
    els.drawerClose.addEventListener("click", ()=> openDrawer(false));

    els.exportBtn.addEventListener("click", exportState);

    els.globalNoteBtn.addEventListener("click", ()=> openGlobalNote(!STATE.ui.globalNoteOpen));
    els.bookNoteBtn.addEventListener("click", ()=> openBookNote(!STATE.ui.bookNoteOpen));
    els.globalMin.addEventListener("click", ()=> openGlobalNote(false));
    els.globalClose.addEventListener("click", ()=> openGlobalNote(false));
    els.bookMin.addEventListener("click", ()=> openBookNote(false));
    els.bookClose.addEventListener("click", ()=> openBookNote(false));

    // Notes persistence
    els.globalText.addEventListener("input", ()=>{
      STATE.notes.global = els.globalText.value || "";
      save();
    });
    els.bookText.addEventListener("input", ()=>{
      const b = currentBook();
      if(!b) return;
      STATE.notes.byBook[b.id] = els.bookText.value || "";
      save();
    });

    // Visual controls
    function syncVisual(){
      STATE.visual.invert = Number(els.invert.value);
      STATE.visual.contrast = Number(els.contrast.value);
      STATE.visual.brightness = Number(els.brightness.value);
      STATE.visual.saturation = Number(els.saturation.value);
      STATE.visual.sharpen = String(els.sharpen.value);
      STATE.visual.mode = String(els.mode.value);
      applyVisual();
      // update thumb filters live
      els.thumbs.querySelectorAll(".thumb img").forEach(img=> img.style.filter = els.mainImg.style.filter || "");
      save();
    }
    ["invert","contrast","brightness","saturation","sharpen","mode"].forEach(k=>{
      els[k].addEventListener(k==="mode" || k==="sharpen" ? "change" : "input", syncVisual);
    });

    els.resetVisualBtn.addEventListener("click", ()=>{
      // EE ▸ CANON DEFAULTS
      STATE.visual = { invert:100, contrast:140, brightness:110, saturation:100, sharpen:"0", mode:"canon" };
      els.invert.value="100"; els.contrast.value="140"; els.brightness.value="110"; els.saturation.value="100";
      els.sharpen.value="0"; els.mode.value="canon";
      syncVisual();
    });

    els.thumbSize.addEventListener("input", ()=>{
      STATE.thumbs.size = Number(els.thumbSize.value);
      save();
      renderThumbs();
    });

    els.prefetch.addEventListener("change", ()=>{
      STATE.thumbs.prefetch = String(els.prefetch.value);
      save();
      renderThumbs();
    });

    // Manifest loading
    els.loadManifestBtn.addEventListener("click", async ()=>{
      try{
        status("LOADING MANIFEST");
        // file takes precedence if provided
        if(els.manifestFile.files && els.manifestFile.files[0]){
          const txt = await els.manifestFile.files[0].text();
          const obj = JSON.parse(txt);
          const books = parseManifestJson(obj);
          ingestBooks(books);
          status("MANIFEST OK");
          return;
        }
        const url = (els.manifestUrl.value || "").trim();
        if(!url) throw new Error("No manifest file or URL provided.");
        const obj = await loadManifestFromUrl(url);
        const books = parseManifestJson(obj);
        ingestBooks(books);
        status("MANIFEST OK");
      }catch(err){
        status("MANIFEST FAIL");
        alert("Manifest load failed:\n" + (err?.message || String(err)));
      }
    });

    // Keyboard rites
    document.addEventListener("keydown",(e)=>{
      const tag = (document.activeElement?.tagName || "").toLowerCase();
      const typing = tag === "input" || tag === "textarea" || tag === "select";
      if(typing) return;

      if(e.key === "ArrowLeft"){ STATE.page--; save(); render(); }
      if(e.key === "ArrowRight"){ STATE.page++; save(); render(); }
      if(e.key === "ArrowUp"){
        const i = STATE.books.findIndex(b=>b.id===STATE.bookId);
        if(i>0){ STATE.bookId = STATE.books[i-1].id; STATE.page=1; save(); renderBooks(); render(); }
      }
      if(e.key === "ArrowDown"){
        const i = STATE.books.findIndex(b=>b.id===STATE.bookId);
        if(i>=0 && i<STATE.books.length-1){ STATE.bookId = STATE.books[i+1].id; STATE.page=1; save(); renderBooks(); render(); }
      }
      if(e.key.toLowerCase()==="n") openGlobalNote(!STATE.ui.globalNoteOpen);
      if(e.key.toLowerCase()==="b") openBookNote(!STATE.ui.bookNoteOpen);
      if(e.key.toLowerCase()==="c") openDrawer(!STATE.ui.drawerOpen);
      if(e.key.toLowerCase()==="e") exportState();
    });

    boot();
  </script>
</body>
</html>
