<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KETADATA_SHELL_KERNEL_v1.html</title>

<!-- =========================================================
AE ▸ AESTHETIC ▸ VOID KERNEL (ALL BLACK / SHARP / FOCUS)
========================================================= -->
<style>
:root{
  --bg:#000; --fg:#fff; --muted:#8a8a8a; --line:#222; --line2:#333;
  --top:44px; --bot:34px;

  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  --sans: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

  /* controllers: slightly rounded, neutral, semi-transparent */
  --ctl-radius:8px;
  --ctl-alpha:0.86;
  --ctl-bg: rgba(6,6,6,var(--ctl-alpha));
}

*{box-sizing:border-box}
html,body{height:100%; margin:0}
body{
  background:var(--bg);
  color:var(--fg);
  font-family:var(--sans);
  overflow:hidden;
  user-select:none;
}

/* Invert applies to ROOT, not body, so strobe filters can still run */
#root{
  position:fixed;
  inset:0;
  background:#000;
}
#root.invert{
  filter: invert(1);
}

/* Stage is what the "lights" manipulate (background + filter) */
#stage{
  position:absolute;
  inset:0;
  background:#000;
  filter:none;
}

/* =========================================================
AE ▸ TOP BAR (minimal)
========================================================= */
.topbar{
  position:absolute;
  top:0; left:0; right:0;
  height:var(--top);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 10px;
  border-bottom:1px solid var(--line);
  background:linear-gradient(180deg,#070707,#000);
  z-index:10;
}
.brand{
  display:flex; align-items:center; gap:10px;
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.08em;
  text-transform:uppercase;
}
.brand .sq{
  width:10px; height:10px;
  border:1px solid var(--fg);
  background:#000;
}
.actions{
  display:flex; align-items:center; gap:8px;
  font-family:var(--mono);
  font-size:12px;
}
.btn{
  background:transparent;
  color:var(--fg);
  border:1px solid var(--line2);
  padding:6px 10px;
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.06em;
  text-transform:uppercase;
  cursor:pointer;
}
.btn:hover{border-color:var(--fg)}
.btn:active{transform:translateY(1px)}
.kbd{border:1px solid var(--line2); padding:2px 6px; color:var(--muted); font-size:11px}

/* Far-right KETA NOTE icon:
   - filled white when collapsed
   - hollow (black inside) when open
*/
.ketaIcon{
  width:16px; height:16px;
  border:2px solid var(--fg);
  background:var(--fg); /* collapsed: filled */
  cursor:pointer;
}
.ketaIcon.open{ background:#000; } /* open: hollow */

/* =========================================================
AE ▸ BOTTOM BAR + SYSTEM DRAWER
========================================================= */
.bottombar{
  position:absolute;
  left:0; right:0; bottom:0;
  height:var(--bot);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 10px;
  border-top:1px solid var(--line);
  background:linear-gradient(0deg,#070707,#000);
  z-index:10;
  font-family:var(--mono);
  font-size:11px;
  color:var(--muted);
}
.toggle{
  border:1px solid var(--line2);
  background:transparent;
  color:var(--fg);
  padding:4px 8px;
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.06em;
  text-transform:uppercase;
  cursor:pointer;
}
.toggle:hover{border-color:var(--fg)}

.drawer{
  position:absolute;
  left:0; right:0;
  bottom:var(--bot);
  height:38%;
  min-height:220px;
  border-top:1px solid var(--line);
  background:linear-gradient(180deg,#060606,#000);
  display:none;
  z-index:20;
}
.drawer.open{display:flex; flex-direction:column}
.drawerHead{
  padding:8px 10px;
  border-bottom:1px solid var(--line);
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.06em;
  text-transform:uppercase;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.drawerBody{padding:10px; min-height:0; flex:1; overflow:auto}
textarea{
  width:100%;
  border:1px solid var(--line2);
  background:#050505;
  color:var(--fg);
  font-family:var(--mono);
  font-size:12px;
  padding:10px;
  line-height:1.35;
  outline:none;
  resize:vertical;
  min-height:140px;
}

/* =========================================================
AE ▸ KETA NOTE (BLACK NOTE + HIGH INTENSITY OUTLINE)
========================================================= */
.ketaNote{
  position:absolute;
  top:60px; right:16px;
  width:360px; height:240px;
  display:none;
  z-index:30;
  resize:both;
  overflow:hidden;
  border-radius:var(--ctl-radius);
  background:var(--ctl-bg);
  border:2px solid #fff;              /* high intensity outline */
  box-shadow: 0 0 0 1px #fff, 0 0 18px rgba(255,255,255,0.10);
  backdrop-filter: blur(6px);
}
.ketaNote.open{display:flex; flex-direction:column}
.ketaHead{
  padding:8px 10px;
  border-bottom:1px solid var(--line);
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.06em;
  text-transform:uppercase;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:move;
}
.ketaBody{padding:10px; min-height:0; flex:1}
.ketaNote textarea{
  background:#000;                     /* black by default */
  color:#fff;
  border:2px solid #fff;               /* internal outline */
  width:100%;
  height:100%;
  resize:none;
  box-shadow: 0 0 0 1px #000 inset;
}

/* Toast */
.toast{
  position:absolute;
  left:12px;
  top:calc(var(--top) + 12px);
  padding:8px 10px;
  border:1px solid var(--line2);
  background:rgba(8,8,8,0.82);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.04em;
  color:var(--fg);
  display:none;
  z-index:40;
  border-radius:var(--ctl-radius);
}
</style>
</head>

<body>
  <div id="root">
    <div id="stage" aria-label="KETADATA STAGE"></div>

    <div class="toast" id="toast"></div>

    <!-- WB ▸ TOPBAR -->
    <div class="topbar">
      <div class="brand">
        <span class="sq"></span>
        <span>KETADATA // SHELL // KERNEL</span>
        <span style="color:var(--muted); letter-spacing:.02em; text-transform:none">v1</span>
      </div>
      <div class="actions">
        <button class="btn" id="btnImport">IMPORT</button>
        <button class="btn" id="btnExport">EXPORT</button>
        <button class="btn" id="btnCopy">COPY</button>
        <span class="kbd" title="Invert all colors">Shift+I</span>
        <span class="kbd" title="Select light preset">1–6</span>
        <span class="kbd" title="Toggle light on/off">Space</span>
        <div id="ketaIcon" class="ketaIcon" title="KETA_NOTE"></div>
      </div>
    </div>

    <!-- WB ▸ SYSTEM DRAWER -->
    <div class="drawer" id="drawer">
      <div class="drawerHead">
        <div>SYSTEM UNIVERSALS</div>
        <div style="display:flex; gap:8px; align-items:center">
          <span id="sig" style="color:var(--muted); font-family:var(--mono); font-size:11px">∅</span>
          <button class="btn" id="btnCopyUniversals">COPY</button>
          <button class="btn" id="btnCloseDrawer">CLOSE</button>
        </div>
      </div>
      <div class="drawerBody">
        <textarea id="universals" placeholder="LAWS / CONSTRAINTS / REFERENCES"></textarea>
        <div style="margin-top:8px; color:var(--muted); font-family:var(--mono); font-size:11px">
          EE: axiom → KETADATA ⇒ KETA_NOTE ⇒ EXPORTABLE STATE
        </div>
      </div>
    </div>

    <!-- WB ▸ BOTTOMBAR -->
    <div class="bottombar">
      <div style="display:flex; gap:10px; align-items:center">
        <button class="toggle" id="toggleDrawer">SYSTEM</button>
        <span>STATE: <span id="sig2">∅</span></span>
      </div>
      <div style="display:flex; gap:12px; align-items:center">
        <span>LIGHT: <span id="lightLabel">1</span></span>
        <span>RUN: <span id="runLabel">OFF</span></span>
      </div>
    </div>

    <!-- WB ▸ KETA NOTE -->
    <div class="ketaNote" id="ketaNote">
      <div class="ketaHead" id="ketaHead">
        <div>KETA NOTE</div>
        <div style="display:flex; gap:8px; align-items:center">
          <button class="btn" id="btnHideNote">HIDE</button>
        </div>
      </div>
      <div class="ketaBody">
        <textarea id="ketaText" placeholder="GLOBAL NOTE"></textarea>
      </div>
    </div>

    <input id="file" type="file" accept="application/json" style="display:none" />
  </div>

<script>
/* =========================================================
EE ▸ ENGINE ▸ KERNEL LAW (STATE + INVERT + LIGHTS + TRANSPORT)
========================================================= */

const DEFAULT = {
  version: "KETADATA_SHELL_KERNEL_v1",
  updatedAt: new Date().toISOString(),

  // mandatory atoms
  ketaNote: "",
  universals: "",

  ui: {
    invert:false,

    // "default lights" (1–6) + space toggles on/off
    lightPreset: 1,
    lightRunning: false
  },

  // extension surface for future layers
  payload: {}
};

let STATE = loadLocal() || structuredClone(DEFAULT);

const $ = (id)=>document.getElementById(id);
const stage = $("stage");
const root = $("root");

function nowISO(){ return new Date().toISOString(); }

function stableSig(){
  const core = JSON.stringify({
    v:STATE.version,
    i:STATE.ui.invert,
    p:STATE.ui.lightPreset,
    r:STATE.ui.lightRunning,
    k:(STATE.ketaNote||"").length,
    u:(STATE.universals||"").length
  });
  let h=2166136261;
  for(let i=0;i<core.length;i++){ h^=core.charCodeAt(i); h=Math.imul(h,16777619); }
  return (h>>>0).toString(16).slice(0,8);
}

function persist(){
  STATE.updatedAt = nowISO();
  try{ localStorage.setItem("ketadata.shell.kernel.v1", JSON.stringify(STATE)); }catch(e){}
  render();
}

function loadLocal(){
  try{
    const raw = localStorage.getItem("ketadata.shell.kernel.v1");
    if(!raw) return null;
    const parsed = JSON.parse(raw);
    return mergeDefault(parsed);
  }catch(e){ return null; }
}

function mergeDefault(obj){
  const out = structuredClone(DEFAULT);
  Object.assign(out, obj||{});
  out.ui = Object.assign(structuredClone(DEFAULT.ui), (obj&&obj.ui)||{});
  out.payload = Object.assign({}, (obj&&obj.payload)||{});
  return out;
}

function exportState(){ return JSON.stringify(STATE, null, 2); }
function importState(text){
  const parsed = JSON.parse(text);
  STATE = mergeDefault(parsed);
  // restart light loop if needed
  stopLight();
  if(STATE.ui.lightRunning) startLight(STATE.ui.lightPreset);
  persist();
}

/* =========================================================
EE ▸ ENGINE ▸ INVERT (Shift+I) — invert ALL colors
Implementation: invert ROOT (not stage), so stage filters can still run.
========================================================= */
function setInvert(on){
  STATE.ui.invert = !!on;
  persist();
}

/* =========================================================
EE ▸ ENGINE ▸ LIGHTS (1–6 presets from your pages)
- 1: black/white strobe
- 2: chromatic pulse
- 3: xray sequence
- 4: red/black intensity
- 5: ultraviolet spiral hue rotate
- 6: paparazzi flashes
Space toggles light on/off. Keys 1–6 select preset (and if running, switch live).
========================================================= */

let lightInterval = null;
let lightCount = 0;     // used by some presets
let lightAuxA = 0;      // used by some presets
let lightAuxB = 0;

function resetStage(){
  stage.style.backgroundColor = "#000000";
  stage.style.filter = "none";
  lightCount = 0; lightAuxA = 0; lightAuxB = 0;
}

function startLight(preset){
  stopLight(true);
  resetStage();

  STATE.ui.lightPreset = preset;
  STATE.ui.lightRunning = true;

  if(preset === 1){
    // from 1.html: toggle bg every 50ms
    lightInterval = setInterval(()=>{
      const curr = stage.style.backgroundColor || "black";
      stage.style.backgroundColor = (curr === "black" || curr === "rgb(0, 0, 0)") ? "white" : "black";
      stage.style.filter = "none";
    }, 50);
  }

  if(preset === 2){
    // from 2.html: hsl hue + pulse every 10ms
    lightInterval = setInterval(()=>{
      lightAuxA = (lightAuxA + 30) % 360;  // hue
      lightAuxB += 0.5;                    // pulse
      const lightness = 50 + Math.sin(lightAuxB) * 40;
      stage.style.backgroundColor = `hsl(${lightAuxA}, 100%, ${lightness}%)`;
      stage.style.filter = "none";
    }, 10);
  }

  if(preset === 3){
    // from 3.html: xray beat sequence every 30ms
    lightInterval = setInterval(()=>{
      lightCount++;
      const beat = lightCount % 16;

      if (beat === 0 || beat === 1) {
        stage.style.backgroundColor = "#ffffff";
        stage.style.filter = "invert(1) contrast(3) brightness(2)";
      } else if (beat === 2) {
        stage.style.backgroundColor = "#000000";
        stage.style.filter = "invert(1) contrast(2)";
      } else if (beat === 3) {
        stage.style.backgroundColor = "#00ff00";
        stage.style.filter = "contrast(2) saturate(3)";
      } else if (beat === 4) {
        stage.style.backgroundColor = "#ff00ff";
        stage.style.filter = "invert(1) hue-rotate(90deg)";
      } else if (beat === 5 || beat === 6) {
        stage.style.backgroundColor = "#00ffff";
        stage.style.filter = "invert(0.7) contrast(2)";
      } else if (beat === 7) {
        stage.style.backgroundColor = "#ffffff";
        stage.style.filter = "invert(1) brightness(3)";
      } else if (beat === 8) {
        stage.style.backgroundColor = "#000000";
        stage.style.filter = "invert(1) contrast(3)";
      } else if (beat === 9 || beat === 10) {
        stage.style.backgroundColor = "#00ff00";
        stage.style.filter = "saturate(5) contrast(2)";
      } else if (beat === 11) {
        stage.style.backgroundColor = "#ff00ff";
        stage.style.filter = "invert(1) saturate(3)";
      } else {
        stage.style.backgroundColor = "#0088ff";
        stage.style.filter = "contrast(1.5) brightness(1.2)";
      }
    }, 30);
  }

  if(preset === 4){
    // from 4.html: red/black pulse every 20ms
    lightInterval = setInterval(()=>{
      lightAuxA += 0.08; // intensity
      lightCount++;      // flashCount

      const red = Math.abs(Math.sin(lightAuxA)) * 255;
      const pulse = Math.abs(Math.sin(lightAuxA * 0.5));
      const contrast = 2 + pulse * 2;
      const saturation = 4 + pulse * 2;

      if (lightCount % 8 === 0) {
        stage.style.backgroundColor = "#000000";
        stage.style.filter = "brightness(3) contrast(3)";
      } else if (lightCount % 8 === 1) {
        stage.style.backgroundColor = `rgb(${red}, 0, 0)`;
        stage.style.filter = `contrast(${contrast + 1}) saturate(${saturation + 2}) brightness(${1.5 + pulse * 0.5})`;
      } else {
        stage.style.backgroundColor = `rgb(${red}, 0, 0)`;
        stage.style.filter = `contrast(${contrast}) saturate(${saturation}) brightness(${1.2 + pulse * 0.5})`;
      }
    }, 20);
  }

  if(preset === 5){
    // from 5.html: ultraviolet spiral hue rotate every 25ms
    lightInterval = setInterval(()=>{
      lightAuxA += 15;                   // angle
      lightAuxB = (lightAuxB + 2) % 100; // radius

      const hue = 260 + Math.sin(lightAuxA * 0.1) * 40;
      const saturation = 80 + Math.cos(lightAuxA * 0.05) * 20;
      const lightness = 30 + Math.sin(lightAuxB * 0.1) * 30;

      const spiralBrightness = 1 + Math.abs(Math.sin(lightAuxA * 0.05)) * 0.8;
      const spiralContrast = 1.5 + Math.abs(Math.cos(lightAuxA * 0.08)) * 1;

      stage.style.backgroundColor = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
      stage.style.filter = `contrast(${spiralContrast}) saturate(2) brightness(${spiralBrightness}) hue-rotate(${lightAuxA * 0.5}deg)`;
    }, 25);
  }

  if(preset === 6){
    // from 6.html: paparazzi flashes every 30ms
    lightInterval = setInterval(()=>{
      lightCount++;

      if (lightCount % 50 === 0) {
        stage.style.backgroundColor = "#ffffff";
        stage.style.filter = "brightness(5) contrast(5)";
      } else if (lightCount % 50 === 1) {
        stage.style.backgroundColor = "#000000";
        stage.style.filter = "none";
      } else if (lightCount % 50 === 2) {
        stage.style.backgroundColor = "#ffffff";
        stage.style.filter = "brightness(5) contrast(5)";
      } else {
        stage.style.backgroundColor = "#000000";
        stage.style.filter = "none";
      }
    }, 30);
  }

  toast(`LIGHT ${preset} ON`);
  persist();
}

function stopLight(silent=false){
  if(lightInterval){ clearInterval(lightInterval); lightInterval = null; }
  STATE.ui.lightRunning = false;
  resetStage();
  if(!silent) toast("LIGHT OFF");
  persist();
}

function toggleLight(){
  if(STATE.ui.lightRunning) stopLight();
  else startLight(STATE.ui.lightPreset);
}

function selectPreset(preset){
  STATE.ui.lightPreset = preset;
  if(STATE.ui.lightRunning){
    startLight(preset); // live switch
  }else{
    persist();
    toast(`LIGHT ${preset} SELECTED`);
  }
}

/* =========================================================
WB ▸ WIRING ▸ UI / IO / NOTE / DRAWER / HOTKEYS
========================================================= */

function setDrawer(open){ $("drawer").classList.toggle("open", !!open); }

function setKetaNote(open){
  $("ketaNote").classList.toggle("open", !!open);
  $("ketaIcon").classList.toggle("open", !!open); // open => hollow
}

function download(filename, text){
  const blob = new Blob([text], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 800);
}

async function copy(text){
  try{ await navigator.clipboard.writeText(text); toast("COPIED"); }
  catch(e){ toast("COPY FAILED"); }
}

let toastTimer=null;
function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ t.style.display="none"; }, 900);
}

function render(){
  root.classList.toggle("invert", !!STATE.ui.invert);

  $("ketaText").value = STATE.ketaNote || "";
  $("universals").value = STATE.universals || "";

  const s = stableSig();
  $("sig").textContent = s;
  $("sig2").textContent = s;

  $("lightLabel").textContent = String(STATE.ui.lightPreset);
  $("runLabel").textContent = STATE.ui.lightRunning ? "ON" : "OFF";
}

$("btnImport").addEventListener("click", ()=> $("file").click());
$("file").addEventListener("change", async (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const txt = await f.text();
  importState(txt);
  e.target.value = "";
  toast("STATE IMPORTED");
});

$("btnExport").addEventListener("click", ()=>{
  download("KETADATA_SHELL_KERNEL_v1_state.json", exportState());
  toast("STATE EXPORTED");
});
$("btnCopy").addEventListener("click", ()=> copy(exportState()));

$("toggleDrawer").addEventListener("click", ()=> setDrawer(!$("drawer").classList.contains("open")));
$("btnCloseDrawer").addEventListener("click", ()=> setDrawer(false));
$("btnCopyUniversals").addEventListener("click", ()=> copy(STATE.universals || ""));

$("universals").addEventListener("input", ()=>{
  STATE.universals = $("universals").value;
  persist();
});

$("ketaIcon").addEventListener("click", ()=>{
  const open = !$("ketaNote").classList.contains("open");
  setKetaNote(open);
  toast(open ? "KETA_NOTE OPEN" : "KETA_NOTE CLOSED");
});
$("btnHideNote").addEventListener("click", ()=> setKetaNote(false));
$("ketaText").addEventListener("input", ()=>{
  STATE.ketaNote = $("ketaText").value;
  persist();
});

/* HOTKEYS
- Shift+I: invert ALL colors
- 1–6: select light preset (switch live if running)
- Space: toggle light on/off
- Esc: close drawer + note + stop light
*/
document.addEventListener("keydown", (e)=>{
  const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
  const typing = (tag==="textarea" || tag==="input");

  if(e.shiftKey && e.key.toLowerCase()==="i"){
    e.preventDefault();
    setInvert(!STATE.ui.invert);
    toast(STATE.ui.invert ? "INVERT ON" : "INVERT OFF");
    return;
  }

  if(!typing && /^[1-6]$/.test(e.key)){
    e.preventDefault();
    selectPreset(parseInt(e.key,10));
    return;
  }

  if(!typing && (e.code==="Space" || e.key===" ")){
    e.preventDefault();
    toggleLight();
    return;
  }

  if(e.key==="Escape"){
    setDrawer(false);
    setKetaNote(false);
    stopLight(true);
    toast("CLOSED");
    return;
  }
});

/* Drag KETA NOTE */
(function dragNote(){
  const box = $("ketaNote");
  const head = $("ketaHead");
  let dragging=false, ox=0, oy=0;

  head.addEventListener("mousedown", (e)=>{
    if(e.target.closest("button")) return;
    dragging=true;
    const r = box.getBoundingClientRect();
    ox = e.clientX - r.left;
    oy = e.clientY - r.top;
    box.style.left = r.left + "px";
    box.style.top  = r.top + "px";
    box.style.right = "auto";
  });
  window.addEventListener("mousemove", (e)=>{
    if(!dragging) return;
    box.style.left = (e.clientX - ox) + "px";
    box.style.top  = (e.clientY - oy) + "px";
  });
  window.addEventListener("mouseup", ()=> dragging=false);
})();

/* BOOT */
render();

/* =========================================================
AE: all black kernel, sharp edges, semi-transparent controllers
EE: state export/import, invert-all-colors, lights 1–6, space toggle
WB: hotkeys, drawer, note, localStorage, clipboard, drag
========================================================= */
</script>
</body>
</html>
