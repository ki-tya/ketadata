<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KETADATA RESEARCH</title>
<style>
  :root{
    --bg:#0b0b0b;
    --fg:#f2f2f2;
    --muted:#a8a8a8;
    --line:#2a2a2a;
    --panel:#121212;
    --panel2:#0f0f0f;
    --danger:#ff5a5a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--fg);
    font-family: Arial, Helvetica, sans-serif;
    font-size:12px; /* uniform text size */
    line-height:1.2;
    letter-spacing:0.2px;
    overflow:hidden;
  }
  button,input,textarea,select{
    font:inherit;
    color:inherit;
    background:transparent;
    border:1px solid var(--line);
    padding:6px 8px;
    outline:none;
  }
  button{cursor:pointer}
  button:hover{border-color:var(--muted)}
  button:active{transform:translateY(1px)}
  input,textarea{width:100%}
  textarea{resize:none}
  .app{
    height:100%;
    display:grid;
    grid-template-columns: 330px 1fr 380px;
    gap:8px;
    padding:8px;
  }
  .col{
    background:var(--panel);
    border:1px solid var(--line);
    display:flex;
    flex-direction:column;
    min-height:0;
  }
  .bar{
    display:flex;
    gap:6px;
    padding:8px;
    border-bottom:1px solid var(--line);
    background:var(--panel2);
    align-items:center;
    flex-wrap:wrap;
  }
  .grow{flex:1}
  .pill{
    border:1px solid var(--line);
    padding:2px 6px;
    color:var(--muted);
    white-space:nowrap;
  }
  .muted{color:var(--muted)}
  .danger{color:var(--danger)}
  .content{
    padding:8px;
    display:flex;
    flex-direction:column;
    gap:8px;
    min-height:0;
  }
  .row{display:flex; gap:6px; align-items:center}
  .list{
    border:1px solid var(--line);
    min-height:0;
    overflow:auto;
    background:#0d0d0d;
  }
  .item{
    display:grid;
    grid-template-columns: 1fr auto;
    gap:6px;
    padding:6px 8px;
    border-bottom:1px solid #1a1a1a;
    align-items:center;
  }
  .item:last-child{border-bottom:none}
  .item.sel{background:#151515}
  .item .title{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .tinybtn{padding:4px 6px; border-color:#1f1f1f}
  .tinybtn:hover{border-color:var(--muted)}
  .panel{
    border:1px solid var(--line);
    background:#0d0d0d;
    padding:8px;
    min-height:0;
    overflow:auto;
  }
  .divider{height:1px; background:var(--line)}
  .statusline{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    padding:6px 8px;
    border-top:1px solid var(--line);
    background:var(--panel2);
    align-items:center;
  }
  .kbd{border:1px solid var(--line); padding:2px 4px; color:var(--muted)}
  .chip{
    border:1px solid var(--line);
    padding:2px 6px;
    color:var(--muted);
    cursor:pointer;
    user-select:none;
  }
  .chip.on{background:#161616; color:var(--fg); border-color:#3a3a3a}
  a{color:var(--fg); text-decoration:none}
  a:hover{text-decoration:underline}
  .two{
    display:grid;
    grid-template-rows:auto 1fr;
    gap:8px;
    min-height:0;
  }
  .grid2{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:8px;
  }
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
</style>
</head>
<body>
<div class="app" id="app">

  <!-- LEFT: INDEX -->
  <div class="col" id="colIndex">
    <div class="bar">
      <span class="pill">KETADATA RESEARCH</span>
      <span class="grow"></span>
      <button class="tinybtn" id="btnNew">NEW</button>
      <button class="tinybtn" id="btnDup">DUP</button>
      <button class="tinybtn" id="btnDel">DEL</button>
    </div>

    <div class="content" style="min-height:0">
      <div class="row">
        <input id="search" placeholder="search title / tags / notes" />
      </div>
      <div class="row">
        <input id="tagFilter" placeholder="filter tags: comma separated (e.g. ai, occult)" />
      </div>
      <div class="list" id="rabbitList" aria-label="Rabbit holes"></div>
      <div class="muted">objects, not folders. export is ownership.</div>
    </div>

    <div class="statusline">
      <span class="muted">hotkeys:</span>
      <span class="kbd">SHIFT+I</span><span class="muted">invert</span>
      <span class="kbd">SHIFT+N</span><span class="muted">null</span>
      <span class="kbd">SHIFT+S</span><span class="muted">save</span>
      <span class="kbd">CTRL/⌘+K</span><span class="muted">focus search</span>
    </div>
  </div>

  <!-- CENTER: DETAIL -->
  <div class="col" id="colDetail">
    <div class="bar">
      <span class="pill">DETAIL</span>
      <span class="grow"></span>
      <button class="tinybtn" id="btnOpenAll">OPEN LINKS</button>
      <button class="tinybtn" id="btnAddLink">ADD LINK</button>
      <button class="tinybtn" id="btnRemoveSelLink">REMOVE LINK</button>
    </div>

    <div class="content two">
      <div class="grid2">
        <input id="title" placeholder="title" />
        <input id="tags" placeholder="tags (comma separated)" />
      </div>

      <div class="panel" style="display:flex; flex-direction:column; gap:8px; min-height:0;">
        <div class="row">
          <span class="pill">NOTES</span>
          <span class="grow"></span>
          <span class="muted" id="metaLine">—</span>
        </div>
        <textarea id="notes" spellcheck="false" style="flex:1; min-height:140px" placeholder="what is this hole? why does it matter? what are the threads?"></textarea>

        <div class="divider"></div>

        <div class="row">
          <span class="pill">LINKS</span>
          <span class="grow"></span>
          <button class="tinybtn" id="btnCopyLinks">COPY</button>
        </div>
        <div class="list" id="linkList" style="min-height:0; flex:1;"></div>

        <div class="divider"></div>

        <div class="row">
          <span class="pill">THREADS</span>
          <span class="grow"></span>
          <button class="tinybtn" id="btnAddThread">ADD</button>
          <button class="tinybtn" id="btnDelThread">DEL</button>
        </div>
        <div class="list" id="threadList" style="min-height:120px;"></div>
      </div>
    </div>

    <div class="statusline">
      <span class="muted" id="selLine">selected: none</span>
      <span class="muted" id="dirtyLine"></span>
    </div>
  </div>

  <!-- RIGHT: EXPORT / IMPORT / TAGS -->
  <div class="col" id="colIO">
    <div class="bar">
      <span class="pill">IO</span>
      <span class="grow"></span>
      <button class="tinybtn" id="btnExportJson">EXPORT JSON</button>
      <button class="tinybtn" id="btnExportTxt">EXPORT TXT</button>
      <button class="tinybtn" id="btnExportAll">EXPORT ALL</button>
    </div>

    <div class="content" style="min-height:0">

      <div class="panel">
        <div class="row" style="margin-bottom:6px">
          <span class="pill">IMPORT</span>
          <span class="grow"></span>
          <span class="muted">json / txt</span>
        </div>
        <div class="row">
          <input type="file" id="fileInput" accept=".json,.txt,application/json,text/plain" />
        </div>
        <div class="row" style="margin-top:6px">
          <label class="muted" style="display:flex;align-items:center;gap:6px;cursor:pointer">
            <input type="checkbox" id="chkReplace" style="width:auto" />
            replace selected
          </label>
          <span class="grow"></span>
          <button class="tinybtn" id="btnLoadFile">LOAD</button>
        </div>
        <div class="muted" style="margin-top:6px">
          import without replace creates a new rabbit hole.
        </div>
      </div>

      <div class="panel" style="min-height:0; display:flex; flex-direction:column; gap:8px;">
        <div class="row">
          <span class="pill">TAG CLOUD</span>
          <span class="grow"></span>
          <button class="tinybtn" id="btnClearTagFilter">CLEAR FILTER</button>
        </div>
        <div class="panel" id="tagCloud" style="flex:1;"></div>
      </div>

      <div class="panel">
        <div class="row" style="margin-bottom:6px">
          <span class="pill">PROMPT EXPORT</span>
          <span class="grow"></span>
          <button class="tinybtn" id="btnCopyPrompt">COPY</button>
        </div>
        <div class="muted">one object → compact text prompt payload</div>
        <div class="divider" style="margin:8px 0"></div>
        <div class="panel mono" id="promptBox" style="max-height:180px; overflow:auto;"></div>
      </div>

    </div>

    <div class="statusline">
      <span class="muted" id="storageLine">storage: —</span>
    </div>
  </div>

</div>

<script>
(() => {
  "use strict";

  const LS_KEY = "KETADATA_RESEARCH_V1::state";
  const uid = () => "RH_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  const nowISO = () => new Date().toISOString();
  const $ = (id) => document.getElementById(id);

  const els = {
    app: $("app"),
    colIndex: $("colIndex"),
    colIO: $("colIO"),
    search: $("search"),
    tagFilter: $("tagFilter"),
    rabbitList: $("rabbitList"),

    title: $("title"),
    tags: $("tags"),
    notes: $("notes"),
    metaLine: $("metaLine"),

    linkList: $("linkList"),
    btnAddLink: $("btnAddLink"),
    btnOpenAll: $("btnOpenAll"),
    btnCopyLinks: $("btnCopyLinks"),
    btnRemoveSelLink: $("btnRemoveSelLink"),

    threadList: $("threadList"),
    btnAddThread: $("btnAddThread"),
    btnDelThread: $("btnDelThread"),

    btnNew: $("btnNew"),
    btnDup: $("btnDup"),
    btnDel: $("btnDel"),

    btnExportJson: $("btnExportJson"),
    btnExportTxt: $("btnExportTxt"),
    btnExportAll: $("btnExportAll"),

    fileInput: $("fileInput"),
    chkReplace: $("chkReplace"),
    btnLoadFile: $("btnLoadFile"),

    tagCloud: $("tagCloud"),
    btnClearTagFilter: $("btnClearTagFilter"),

    selLine: $("selLine"),
    dirtyLine: $("dirtyLine"),
    storageLine: $("storageLine"),

    btnCopyPrompt: $("btnCopyPrompt"),
    promptBox: $("promptBox"),
  };

  const defaultState = () => ({
    fileId: "KETADATA_RESEARCH_V1_" + Date.now().toString(16),
    version: "V1",
    updatedAt: nowISO(),
    system: { invert:false, nullMode:false },
    ui: { search:"", tagFilter:"", selectedRabbitId:null, selectedLinkIdx:null, selectedThreadId:null },
    rabbits: [],
  });

  let state = loadState();
  let dirty = false;

  function seedOne(){
    return {
      id: uid(),
      title: "untitled rabbit hole",
      tags: ["research"],
      notes: "",
      links: [],
      threads: [],
      createdAt: nowISO(),
      updatedAt: nowISO()
    };
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw){
        const s = defaultState();
        const r = seedOne();
        s.rabbits.push(r);
        s.ui.selectedRabbitId = r.id;
        localStorage.setItem(LS_KEY, JSON.stringify(s));
        return s;
      }
      const s = JSON.parse(raw);
      if(!s.rabbits) s.rabbits = [];
      if(!s.ui) s.ui = { search:"", tagFilter:"", selectedRabbitId:null, selectedLinkIdx:null, selectedThreadId:null };
      if(!s.system) s.system = { invert:false, nullMode:false };
      if(!s.fileId) s.fileId = "KETADATA_RESEARCH_V1_" + Date.now().toString(16);
      if(!s.version) s.version = "V1";
      if(s.rabbits.length === 0){
        const r = seedOne();
        s.rabbits.push(r);
        s.ui.selectedRabbitId = r.id;
      }
      if(!s.ui.selectedRabbitId || !s.rabbits.find(x => x.id === s.ui.selectedRabbitId)){
        s.ui.selectedRabbitId = s.rabbits[0].id;
      }
      return s;
    }catch(e){
      const s = defaultState();
      const r = seedOne();
      s.rabbits.push(r);
      s.ui.selectedRabbitId = r.id;
      return s;
    }
  }

  function saveState(next = state){
    next.updatedAt = nowISO();
    localStorage.setItem(LS_KEY, JSON.stringify(next));
    state = next;
    dirty = false;
    render();
  }

  function markDirty(){
    dirty = true;
    els.dirtyLine.textContent = "unsaved";
  }

  function selectedRabbit(){
    return state.rabbits.find(r => r.id === state.ui.selectedRabbitId) || null;
  }

  function normTags(str){
    return (str || "")
      .split(",")
      .map(s => s.trim())
      .filter(Boolean)
      .map(s => s.toLowerCase());
  }

  function uniq(arr){
    const out = [];
    const seen = new Set();
    for(const x of arr){
      if(seen.has(x)) continue;
      seen.add(x);
      out.push(x);
    }
    return out;
  }

  // ---------- UI system modes ----------
  function applySystemModes(){
    document.body.style.filter = state.system.invert ? "invert(1)" : "none";
    if(state.system.nullMode){
      els.app.style.gridTemplateColumns = "0px 1fr 0px";
      els.colIndex.style.visibility = "hidden";
      els.colIO.style.visibility = "hidden";
      els.colIndex.style.pointerEvents = "none";
      els.colIO.style.pointerEvents = "none";
    }else{
      els.app.style.gridTemplateColumns = "330px 1fr 380px";
      els.colIndex.style.visibility = "visible";
      els.colIO.style.visibility = "visible";
      els.colIndex.style.pointerEvents = "auto";
      els.colIO.style.pointerEvents = "auto";
    }
  }

  // ---------- Render ----------
  function render(){
    els.storageLine.textContent = `storage: ${LS_KEY} | fileId: ${state.fileId}`;
    els.search.value = state.ui.search || "";
    els.tagFilter.value = state.ui.tagFilter || "";

    renderRabbitList();
    renderDetail();
    renderTagCloud();
    renderPromptBox();
    applySystemModes();
  }

  function matchesFilters(r){
    const q = (state.ui.search || "").toLowerCase().trim();
    const tf = normTags(state.ui.tagFilter || "");
    const hay = [
      r.title || "",
      (r.tags || []).join(" "),
      r.notes || "",
      (r.links || []).join(" "),
      (r.threads || []).map(t => t.title || "").join(" ")
    ].join("\n").toLowerCase();

    if(q && !hay.includes(q)) return false;
    if(tf.length){
      const set = new Set((r.tags || []).map(t => t.toLowerCase()));
      for(const t of tf){
        if(!set.has(t)) return false;
      }
    }
    return true;
  }

  function renderRabbitList(){
    els.rabbitList.innerHTML = "";
    const items = state.rabbits
      .filter(matchesFilters)
      .slice()
      .sort((a,b) => (b.updatedAt || "").localeCompare(a.updatedAt || ""));

    for(const r of items){
      const div = document.createElement("div");
      div.className = "item" + (r.id === state.ui.selectedRabbitId ? " sel" : "");

      const left = document.createElement("div");
      left.className = "title";
      left.textContent = r.title || "untitled";

      const right = document.createElement("div");
      right.className = "muted";
      right.textContent = String((r.links?.length || 0));

      div.appendChild(left);
      div.appendChild(right);

      div.addEventListener("click", () => {
        state.ui.selectedRabbitId = r.id;
        state.ui.selectedLinkIdx = null;
        state.ui.selectedThreadId = null;
        markDirty();
        render();
      });

      els.rabbitList.appendChild(div);
    }
  }

  function renderDetail(){
    const r = selectedRabbit();
    if(!r){
      els.title.value = "";
      els.tags.value = "";
      els.notes.value = "";
      els.metaLine.textContent = "—";
      els.linkList.innerHTML = "";
      els.threadList.innerHTML = "";
      els.selLine.textContent = "selected: none";
      return;
    }

    els.title.value = r.title || "";
    els.tags.value = (r.tags || []).join(", ");
    els.notes.value = r.notes || "";
    els.metaLine.textContent = `created ${r.createdAt || "—"} | updated ${r.updatedAt || "—"}`;

    els.selLine.textContent = `selected: ${r.title || "untitled"}`;

    // links
    els.linkList.innerHTML = "";
    const links = r.links || [];
    links.forEach((url, idx) => {
      const div = document.createElement("div");
      div.className = "item" + (idx === state.ui.selectedLinkIdx ? " sel" : "");

      const left = document.createElement("div");
      left.className = "title";
      // show host + path trimmed
      let label = url;
      try{
        const u = new URL(url);
        label = u.host + u.pathname + (u.search ? "…" : "");
      }catch(_){}
      left.textContent = label;

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.gap = "6px";

      const open = document.createElement("a");
      open.className = "tinybtn";
      open.textContent = "OPEN";
      open.href = url;
      open.target = "_blank";
      open.rel = "noopener";

      const up = document.createElement("button");
      up.className = "tinybtn";
      up.textContent = "UP";
      up.addEventListener("click", (e) => { e.stopPropagation(); moveLink(idx, -1); });

      const dn = document.createElement("button");
      dn.className = "tinybtn";
      dn.textContent = "DN";
      dn.addEventListener("click", (e) => { e.stopPropagation(); moveLink(idx, +1); });

      right.appendChild(open);
      right.appendChild(up);
      right.appendChild(dn);

      div.appendChild(left);
      div.appendChild(right);

      div.addEventListener("click", () => {
        state.ui.selectedLinkIdx = idx;
        markDirty();
        renderDetail();
        renderPromptBox();
      });

      els.linkList.appendChild(div);
    });

    // threads
    els.threadList.innerHTML = "";
    const threads = r.threads || [];
    threads.forEach((t) => {
      const div = document.createElement("div");
      div.className = "item" + (t.id === state.ui.selectedThreadId ? " sel" : "");

      const left = document.createElement("div");
      left.className = "title";
      left.textContent = t.title || "thread";

      const right = document.createElement("div");
      right.className = "muted";
      right.textContent = String((t.links?.length || 0));

      div.appendChild(left);
      div.appendChild(right);

      div.addEventListener("click", () => {
        state.ui.selectedThreadId = t.id;
        markDirty();
        renderThreadsModal(t);
      });

      els.threadList.appendChild(div);
    });

    renderPromptBox();
  }

  function renderThreadsModal(thread){
    // minimal: use prompt() editing to stay frictionless and single-file
    // edit title
    const r = selectedRabbit();
    if(!r) return;

    const choice = prompt(
`THREAD
title: ${thread.title || ""}
links: ${(thread.links||[]).length}

type:
1 = rename
2 = edit notes
3 = add link
4 = copy links
5 = cancel`, "5");

    if(!choice) return;

    if(choice === "1"){
      const t2 = prompt("thread title", thread.title || "thread");
      if(t2 !== null){
        thread.title = (t2 || "thread").trim();
        thread.updatedAt = nowISO();
        r.updatedAt = nowISO();
        markDirty();
        renderDetail();
      }
      return;
    }
    if(choice === "2"){
      const n2 = prompt("thread notes", thread.notes || "");
      if(n2 !== null){
        thread.notes = n2;
        thread.updatedAt = nowISO();
        r.updatedAt = nowISO();
        markDirty();
        renderDetail();
      }
      return;
    }
    if(choice === "3"){
      const u = prompt("paste url", "https://");
      if(u){
        thread.links = thread.links || [];
        thread.links.push(u.trim());
        thread.updatedAt = nowISO();
        r.updatedAt = nowISO();
        markDirty();
        renderDetail();
      }
      return;
    }
    if(choice === "4"){
      const txt = (thread.links || []).join("\n") + ((thread.links||[]).length ? "\n" : "");
      navigator.clipboard.writeText(txt).catch(()=>{});
      return;
    }
  }

  function renderTagCloud(){
    const tags = [];
    for(const r of state.rabbits){
      for(const t of (r.tags || [])) tags.push(t.toLowerCase());
    }
    const counts = new Map();
    tags.forEach(t => counts.set(t, (counts.get(t) || 0) + 1));
    const sorted = Array.from(counts.entries()).sort((a,b) => b[1] - a[1] || a[0].localeCompare(b[0]));

    els.tagCloud.innerHTML = "";
    for(const [t, c] of sorted){
      const span = document.createElement("span");
      span.className = "chip" + (normTags(state.ui.tagFilter).includes(t) ? " on" : "");
      span.textContent = `${t} (${c})`;
      span.style.margin = "2px";
      span.addEventListener("click", () => {
        const cur = normTags(state.ui.tagFilter);
        const set = new Set(cur);
        if(set.has(t)) set.delete(t); else set.add(t);
        state.ui.tagFilter = Array.from(set).join(", ");
        markDirty();
        render();
      });
      els.tagCloud.appendChild(span);
    }
  }

  function renderPromptBox(){
    const r = selectedRabbit();
    if(!r){
      els.promptBox.textContent = "";
      return;
    }
    const payload =
`KETADATA_RESEARCH_OBJECT
TITLE: ${r.title || "untitled"}
TAGS: ${(r.tags || []).join(", ")}
LINKS:
${(r.links || []).slice(0,200).join("\n")}
NOTES:
${(r.notes || "").slice(0,5000)}
THREADS:
${(r.threads || []).map(t => `- ${t.title || "thread"} | links=${(t.links||[]).length}`).join("\n")}`;

    els.promptBox.textContent = payload;
  }

  // ---------- Actions ----------
  function newRabbit(){
    const r = seedOne();
    const name = prompt("rabbit hole title", r.title);
    if(name !== null) r.title = (name || "untitled rabbit hole").trim();
    state.rabbits.unshift(r);
    state.ui.selectedRabbitId = r.id;
    state.ui.selectedLinkIdx = null;
    state.ui.selectedThreadId = null;
    markDirty();
    render();
  }

  function dupRabbit(){
    const r = selectedRabbit();
    if(!r) return;
    const copy = JSON.parse(JSON.stringify(r));
    copy.id = uid();
    copy.title = (r.title || "untitled") + " _copy";
    copy.createdAt = nowISO();
    copy.updatedAt = nowISO();
    // fresh thread ids
    copy.threads = (copy.threads || []).map(t => ({...t, id: uid(), createdAt: nowISO(), updatedAt: nowISO()}));
    state.rabbits.unshift(copy);
    state.ui.selectedRabbitId = copy.id;
    state.ui.selectedLinkIdx = null;
    state.ui.selectedThreadId = null;
    markDirty();
    render();
  }

  function delRabbit(){
    const r = selectedRabbit();
    if(!r) return;
    if(!confirm(`delete "${r.title}"?`)) return;
    state.rabbits = state.rabbits.filter(x => x.id !== r.id);
    if(state.rabbits.length === 0){
      const n = seedOne();
      state.rabbits.push(n);
      state.ui.selectedRabbitId = n.id;
    }else{
      state.ui.selectedRabbitId = state.rabbits[0].id;
    }
    state.ui.selectedLinkIdx = null;
    state.ui.selectedThreadId = null;
    markDirty();
    render();
  }

  function addLink(){
    const r = selectedRabbit();
    if(!r) return;
    const u = prompt("paste url", "https://");
    if(!u) return;
    r.links = r.links || [];
    r.links.push(u.trim());
    r.updatedAt = nowISO();
    markDirty();
    renderDetail();
    renderPromptBox();
  }

  function moveLink(idx, dir){
    const r = selectedRabbit();
    if(!r) return;
    const j = idx + dir;
    if(j < 0 || j >= r.links.length) return;
    const tmp = r.links[idx];
    r.links[idx] = r.links[j];
    r.links[j] = tmp;
    r.updatedAt = nowISO();
    markDirty();
    renderDetail();
    renderPromptBox();
  }

  function removeSelectedLink(){
    const r = selectedRabbit();
    if(!r) return;
    const idx = state.ui.selectedLinkIdx;
    if(idx === null || idx === undefined) return;
    r.links.splice(idx, 1);
    state.ui.selectedLinkIdx = null;
    r.updatedAt = nowISO();
    markDirty();
    renderDetail();
    renderPromptBox();
  }

  function openAllLinks(){
    const r = selectedRabbit();
    if(!r) return;
    const ok = confirm(`open ${r.links.length} links in new tabs?`);
    if(!ok) return;
    for(const u of (r.links || [])){
      try{ window.open(u, "_blank", "noopener"); }catch(_){}
    }
  }

  function copyLinks(){
    const r = selectedRabbit();
    if(!r) return;
    const txt = (r.links || []).join("\n") + ((r.links||[]).length ? "\n" : "");
    navigator.clipboard.writeText(txt).catch(()=>{});
  }

  function addThread(){
    const r = selectedRabbit();
    if(!r) return;
    const title = prompt("thread title", "thread");
    if(title === null) return;
    r.threads = r.threads || [];
    r.threads.push({
      id: uid(),
      title: (title || "thread").trim(),
      notes: "",
      links: [],
      createdAt: nowISO(),
      updatedAt: nowISO()
    });
    r.updatedAt = nowISO();
    markDirty();
    renderDetail();
    renderPromptBox();
  }

  function delThread(){
    const r = selectedRabbit();
    if(!r) return;
    if(!state.ui.selectedThreadId){
      alert("select a thread first");
      return;
    }
    if(!confirm("delete selected thread?")) return;
    r.threads = (r.threads || []).filter(t => t.id !== state.ui.selectedThreadId);
    state.ui.selectedThreadId = null;
    r.updatedAt = nowISO();
    markDirty();
    renderDetail();
    renderPromptBox();
  }

  function downloadBlob(filename, mime, content){
    const blob = new Blob([content], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 250);
  }

  function exportSelectedJSON(){
    const r = selectedRabbit();
    if(!r) return;
    const payload = {
      type: "KETADATA_RESEARCH_OBJECT",
      version: "V1",
      title: r.title,
      tags: r.tags || [],
      notes: r.notes || "",
      links: r.links || [],
      threads: r.threads || [],
      createdAt: r.createdAt,
      updatedAt: r.updatedAt
    };
    const safe = (r.title || "rabbit_hole").replace(/[^\w\-]+/g, "_").slice(0,60);
    downloadBlob(`${safe}.ketadata.research.json`, "application/json", JSON.stringify(payload, null, 2));
  }

  function exportSelectedTXT(){
    const r = selectedRabbit();
    if(!r) return;
    const safe = (r.title || "rabbit_hole").replace(/[^\w\-]+/g, "_").slice(0,60);
    const txt =
`KETADATA_RESEARCH_OBJECT
TITLE: ${r.title || "untitled"}
TAGS: ${(r.tags||[]).join(", ")}
CREATED: ${r.createdAt || ""}
UPDATED: ${r.updatedAt || ""}

LINKS:
${(r.links||[]).join("\n")}

NOTES:
${r.notes || ""}

THREADS:
${(r.threads||[]).map(t => `- ${t.title || "thread"}\n  ${(t.links||[]).join("\n  ")}`).join("\n\n")}

`;
    downloadBlob(`${safe}.ketadata.research.txt`, "text/plain", txt);
  }

  function exportAllJSON(){
    const payload = {
      type: "KETADATA_RESEARCH_EXPORT",
      version: "V1",
      fileId: state.fileId,
      exportedAt: nowISO(),
      rabbits: state.rabbits
    };
    downloadBlob(`KETADATA_RESEARCH_ALL_V1.json`, "application/json", JSON.stringify(payload, null, 2));
  }

  async function loadFile(){
    const file = els.fileInput.files && els.fileInput.files[0];
    if(!file) return;
    const text = await file.text();

    let obj = null;
    try{ obj = JSON.parse(text); }catch(_){ obj = null; }

    const replace = !!els.chkReplace.checked;

    if(obj && obj.type === "KETADATA_RESEARCH_OBJECT"){
      const incoming = obj;
      const r = {
        id: uid(),
        title: String(incoming.title || "imported rabbit hole"),
        tags: Array.isArray(incoming.tags) ? incoming.tags.map(String) : [],
        notes: String(incoming.notes || ""),
        links: Array.isArray(incoming.links) ? incoming.links.map(String) : [],
        threads: Array.isArray(incoming.threads) ? incoming.threads : [],
        createdAt: incoming.createdAt || nowISO(),
        updatedAt: nowISO()
      };

      if(replace){
        const cur = selectedRabbit();
        if(cur){
          Object.assign(cur, r, { id: cur.id, createdAt: cur.createdAt || r.createdAt });
          state.ui.selectedRabbitId = cur.id;
        }else{
          state.rabbits.unshift(r);
          state.ui.selectedRabbitId = r.id;
        }
      }else{
        state.rabbits.unshift(r);
        state.ui.selectedRabbitId = r.id;
      }

      state.ui.selectedLinkIdx = null;
      state.ui.selectedThreadId = null;
      markDirty();
      render();
      els.fileInput.value = "";
      els.chkReplace.checked = false;
      return;
    }

    // TXT import: make a new rabbit hole, treat file as notes + parse urls
    const urls = (text.match(/https?:\/\/[^\s)]+/g) || []).map(s => s.trim());
    const r2 = seedOne();
    r2.title = file.name.replace(/\.[^.]+$/, "") || "imported rabbit hole";
    r2.links = uniq(urls);
    r2.notes = text.slice(0, 20000);
    r2.updatedAt = nowISO();

    if(replace){
      const cur = selectedRabbit();
      if(cur){
        cur.title = r2.title;
        cur.tags = r2.tags;
        cur.links = r2.links;
        cur.notes = r2.notes;
        cur.updatedAt = nowISO();
        state.ui.selectedRabbitId = cur.id;
      }else{
        state.rabbits.unshift(r2);
        state.ui.selectedRabbitId = r2.id;
      }
    }else{
      state.rabbits.unshift(r2);
      state.ui.selectedRabbitId = r2.id;
    }

    state.ui.selectedLinkIdx = null;
    state.ui.selectedThreadId = null;
    markDirty();
    render();
    els.fileInput.value = "";
    els.chkReplace.checked = false;
  }

  // ---------- Wire events ----------
  els.btnNew.addEventListener("click", newRabbit);
  els.btnDup.addEventListener("click", dupRabbit);
  els.btnDel.addEventListener("click", delRabbit);

  els.search.addEventListener("input", () => { state.ui.search = els.search.value; markDirty(); renderRabbitList(); });
  els.tagFilter.addEventListener("input", () => { state.ui.tagFilter = els.tagFilter.value; markDirty(); renderRabbitList(); renderTagCloud(); });

  els.btnClearTagFilter.addEventListener("click", () => { state.ui.tagFilter = ""; markDirty(); render(); });

  els.title.addEventListener("input", () => {
    const r = selectedRabbit(); if(!r) return;
    r.title = els.title.value;
    r.updatedAt = nowISO();
    markDirty();
    renderRabbitList();
    renderPromptBox();
  });

  els.tags.addEventListener("input", () => {
    const r = selectedRabbit(); if(!r) return;
    r.tags = uniq(normTags(els.tags.value));
    r.updatedAt = nowISO();
    markDirty();
    renderRabbitList();
    renderTagCloud();
    renderPromptBox();
  });

  els.notes.addEventListener("input", () => {
    const r = selectedRabbit(); if(!r) return;
    r.notes = els.notes.value;
    r.updatedAt = nowISO();
    markDirty();
    renderPromptBox();
  });

  els.btnAddLink.addEventListener("click", addLink);
  els.btnOpenAll.addEventListener("click", openAllLinks);
  els.btnCopyLinks.addEventListener("click", copyLinks);
  els.btnRemoveSelLink.addEventListener("click", removeSelectedLink);

  els.btnAddThread.addEventListener("click", addThread);
  els.btnDelThread.addEventListener("click", delThread);

  els.btnExportJson.addEventListener("click", exportSelectedJSON);
  els.btnExportTxt.addEventListener("click", exportSelectedTXT);
  els.btnExportAll.addEventListener("click", exportAllJSON);

  els.btnLoadFile.addEventListener("click", loadFile);

  els.btnCopyPrompt.addEventListener("click", async () => {
    const txt = els.promptBox.textContent || "";
    try{ await navigator.clipboard.writeText(txt); }catch(_){}
  });

  // Manual save (deliberate)
  function doSave(){
    saveState(state);
    els.dirtyLine.textContent = "";
  }

  // Hotkeys
  document.addEventListener("keydown", (e) => {
    const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
    const typing = (tag === "input" || tag === "textarea");

    if(e.shiftKey && e.key.toLowerCase() === "i"){
      e.preventDefault();
      state.system.invert = !state.system.invert;
      markDirty();
      applySystemModes();
      return;
    }
    if(e.shiftKey && e.key.toLowerCase() === "n"){
      e.preventDefault();
      state.system.nullMode = !state.system.nullMode;
      markDirty();
      applySystemModes();
      return;
    }
    if(e.shiftKey && e.key.toLowerCase() === "s"){
      e.preventDefault();
      doSave();
      return;
    }
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k"){
      e.preventDefault();
      els.search.focus();
      els.search.select();
      return;
    }

    // If not typing, allow quick link selection
    if(!typing){
      if(e.key === "ArrowUp" || e.key === "ArrowDown"){
        const r = selectedRabbit();
        if(!r) return;
        const n = (r.links || []).length;
        if(n === 0) return;
        let idx = (state.ui.selectedLinkIdx === null || state.ui.selectedLinkIdx === undefined) ? -1 : state.ui.selectedLinkIdx;
        idx = (e.key === "ArrowUp") ? Math.max(0, idx <= 0 ? 0 : idx - 1) : Math.min(n - 1, idx < 0 ? 0 : idx + 1);
        state.ui.selectedLinkIdx = idx;
        markDirty();
        renderDetail();
      }
      if(e.key === "Delete" || e.key === "Backspace"){
        const tag2 = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
        const typing2 = (tag2 === "input" || tag2 === "textarea");
        if(typing2) return;
        removeSelectedLink();
      }
    }
  });

  // Initial render
  render();

  // minimal debug handle
  window.__KETADATA_RESEARCH__ = {
    getState: () => JSON.parse(JSON.stringify(state)),
    save: () => saveState(state),
    reset: () => { localStorage.removeItem(LS_KEY); location.reload(); }
  };
})();
</script>

<!--
AE: BRUTAL_MIN_UNIFORM_TEXT
EE: LOCAL_FIRST_RESEARCH_OBJECTS / LINKS_THREADS_TAGS / EXPORT_OWNERSHIP / PROMPT_PAYLOAD
WB: LS_KEY=KETADATA_RESEARCH_V1::state / HOTKEYS SHIFT+I invert SHIFT+N null SHIFT+S save / CTRL+K search
FILE_ID: KETADATA_RESEARCH_V1
ROOM_ID: KD_TOOL
VERSION: V1
UPDATED_AT: 2026-01-04T00:00:00.000-05:00
CHANGELOG:
- V1: rabbit-hole objects with title/tags/notes/links/threads; search+tag filter; link reorder; export JSON/TXT + export all; import JSON/TXT; prompt payload copy; minimal invert/null; deliberate save.
-->
</body>
</html>
