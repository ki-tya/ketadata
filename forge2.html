<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>KETADATA // FORGE v1 (INDUSTRIAL)</title>
<style>
:root{
  --bg:#000;
  --fg:#fff;
  --muted:rgba(255,255,255,.58);
  --line:rgba(255,255,255,.14);
  --line2:rgba(255,255,255,.22);
  --panel:rgba(255,255,255,.03);
  --panel2:rgba(255,255,255,.05);
  --ui: Arial, Helvetica, sans-serif;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  --pad:12px;
  --gap:10px;
  --h: 44px;  /* header height */
}
*{ box-sizing:border-box; }
html,body{ height:100%; margin:0; background:var(--bg); color:var(--fg); overflow:hidden; }
body{
  font-family:var(--ui);
}
body::before{
  content:"";
  position:fixed; inset:0;
  background:
    linear-gradient(rgba(255,255,255,.09) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,.09) 1px, transparent 1px);
  background-size: 36px 36px;
  opacity:.26;
  pointer-events:none;
}
body::after{
  content:"";
  position:fixed; inset:0;
  background: radial-gradient(1200px 700px at 50% -10%, rgba(255,255,255,.06), transparent 60%);
  pointer-events:none;
}

.top{
  height:var(--h);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  border-bottom:1px solid var(--line);
  background:#000;
  position:relative;
  z-index:5;
}
.brand{
  font-weight:900;
  font-size:11px;
  letter-spacing:.22em;
  text-transform:uppercase;
  user-select:none;
}
.statusline{
  display:flex;
  gap:12px;
  align-items:center;
  font-family:var(--mono);
  font-size:10px;
  color:var(--muted);
}
.pill{
  border:1px solid var(--line);
  padding:4px 8px;
  text-transform:uppercase;
  letter-spacing:.14em;
  font-family:var(--ui);
  font-size:9px;
  color:var(--muted);
}
.pill strong{ color:#fff; font-weight:900; }
.actions{
  display:flex;
  align-items:center;
  gap:10px;
}
.btn{
  border:1px solid var(--line);
  background:transparent;
  color:#fff;
  font-size:10px;
  letter-spacing:.18em;
  text-transform:uppercase;
  padding:6px 10px;
  cursor:pointer;
  user-select:none;
}
.btn:hover{ border-color:#fff; }
.btn.primary{
  border-color:var(--line2);
}
.btn.primary:hover{
  border-color:#fff;
}
.btn.danger{ border-color:rgba(255,255,255,.18); }
.btn.danger:hover{ border-color:#fff; }
.btn:disabled{
  opacity:.35;
  cursor:not-allowed;
}

.noteIcon{
  width:14px;
  height:14px;
  border:1px solid #fff;
  background:#fff;
  cursor:pointer;
}
.noteIcon.open{ background:transparent; }

.main{
  height:calc(100% - var(--h));
  display:grid;
  grid-template-columns: 240px 1fr 420px;
}

.rail{
  height:100%;
  border-right:1px solid var(--line);
  display:flex;
  flex-direction:column;
  min-width:0;
}
.rail:last-child{ border-right:none; }

.railHead{
  padding:var(--pad);
  border-bottom:1px solid var(--line);
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.railTitle{
  font-size:10px;
  letter-spacing:.18em;
  text-transform:uppercase;
  font-weight:900;
}
.railBody{
  padding:var(--pad);
  overflow:auto;
  display:flex;
  flex-direction:column;
  gap:var(--gap);
}

.stepList{
  border:1px solid var(--line);
}
.step{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 10px;
  border-bottom:1px solid var(--line);
  cursor:pointer;
  user-select:none;
}
.step:last-child{ border-bottom:none; }
.step .left{
  display:flex;
  gap:10px;
  align-items:center;
  min-width:0;
}
.stepNum{
  font-family:var(--mono);
  font-size:10px;
  color:var(--muted);
  width:18px;
}
.stepName{
  font-size:10px;
  letter-spacing:.18em;
  text-transform:uppercase;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.step.active{
  background:rgba(255,255,255,.08);
}
.stepState{
  font-family:var(--mono);
  font-size:10px;
  color:var(--muted);
}
.step.active .stepState{ color:#fff; }

.kbd{
  font-family:var(--mono);
  font-size:10px;
  color:var(--muted);
}
.help{
  margin-top:auto;
  border-top:1px solid var(--line);
  padding-top:10px;
  font-family:var(--mono);
  font-size:10px;
  color:var(--muted);
  line-height:1.6;
}

.center{
  display:flex;
  flex-direction:column;
}
.centerHead{
  padding:var(--pad);
  border-bottom:1px solid var(--line);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.centerTitle{
  font-size:10px;
  letter-spacing:.18em;
  text-transform:uppercase;
  font-weight:900;
}
.centerSub{
  font-family:var(--mono);
  font-size:10px;
  color:var(--muted);
}
.centerBody{
  padding:var(--pad);
  overflow:auto;
  display:flex;
  flex-direction:column;
  gap:var(--gap);
}

label{
  font-size:10px;
  letter-spacing:.14em;
  text-transform:uppercase;
  color:var(--muted);
}
input, textarea, select{
  width:100%;
  background:transparent;
  color:#fff;
  border:1px solid var(--line);
  padding:8px;
  font-family:var(--mono);
  font-size:11px;
  outline:none;
}
textarea{ resize:vertical; min-height:90px; }
.row{
  display:flex;
  gap:10px;
}
.row > *{ flex:1; }

.card{
  border:1px solid var(--line);
  background:rgba(255,255,255,.02);
}
.cardPad{ padding:12px; }
.cardTitle{
  font-size:10px;
  letter-spacing:.18em;
  text-transform:uppercase;
  font-weight:900;
  margin:0 0 10px 0;
}
.hr{
  height:1px;
  background:var(--line);
  margin:8px 0;
}

.grid2{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}
.chk{
  display:flex;
  gap:10px;
  align-items:flex-start;
  border:1px solid var(--line);
  padding:10px;
  background:rgba(255,255,255,.01);
  cursor:pointer;
  user-select:none;
}
.chk:hover{ border-color:rgba(255,255,255,.26); }
.chk input{ margin-top:2px; }
.chk .meta{
  display:flex;
  flex-direction:column;
  gap:4px;
  min-width:0;
}
.chk .name{
  font-size:10px;
  letter-spacing:.16em;
  text-transform:uppercase;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.chk .desc{
  font-family:var(--mono);
  font-size:10px;
  color:var(--muted);
  line-height:1.35;
}

.warn{
  border:1px solid rgba(255,255,255,.22);
  background:rgba(255,255,255,.03);
  padding:10px;
  font-family:var(--mono);
  font-size:10px;
  color:var(--muted);
  line-height:1.5;
}
.warn strong{ color:#fff; }

.outputBox{
  border:1px solid var(--line);
  background:rgba(255,255,255,.02);
  padding:10px;
  font-family:var(--mono);
  font-size:11px;
  white-space:pre-wrap;
  line-height:1.45;
  min-height:240px;
}

.rightHead{
  padding:var(--pad);
  border-bottom:1px solid var(--line);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.rightTitle{
  font-size:10px;
  letter-spacing:.18em;
  text-transform:uppercase;
  font-weight:900;
}
.rightBody{
  padding:var(--pad);
  overflow:auto;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.small{
  font-family:var(--mono);
  font-size:10px;
  color:var(--muted);
}

.note{
  position:fixed;
  top:110px;
  right:120px;
  width:360px;
  height:360px;
  border:1px solid #fff;
  background:#000;
  display:none;
  z-index:20;
}
.note.open{ display:block; }
.noteHead{
  padding:8px;
  border-bottom:1px solid var(--line);
  font-size:10px;
  letter-spacing:.18em;
  text-transform:uppercase;
  cursor:move;
  user-select:none;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.noteClose{
  border:1px solid var(--line);
  width:18px;height:18px;
  display:flex;align-items:center;justify-content:center;
  font-family:var(--mono);
  cursor:pointer;
}
.noteClose:hover{ border-color:#fff; }
.noteBody{ height:calc(100% - 34px); }
.noteBody textarea{
  height:100%;
  border:none;
  outline:none;
}

.toast{
  position:fixed;
  bottom:14px;
  left:14px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.85);
  padding:10px 12px;
  font-family:var(--mono);
  font-size:10px;
  color:var(--muted);
  display:none;
  z-index:50;
  max-width:520px;
}
.toast.show{ display:block; }
.toast strong{ color:#fff; }

select{
  font-family:var(--mono);
}
</style>
</head>
<body>

<div class="top">
  <div style="display:flex; align-items:center; gap:12px;">
    <div class="brand">KETADATA // FORGE v1</div>
    <div class="statusline">
      <div class="pill">MODE: <strong id="modePill">ROOMS</strong></div>
      <div class="pill">STEP: <strong id="stepPill">1</strong></div>
      <div class="pill">STATUS: <strong id="statusPill">DRAFT</strong></div>
    </div>
  </div>

  <div class="actions">
    <button class="btn" id="exportJSON">export.json</button>
    <button class="btn" id="importJSON">import.json</button>
    <button class="btn primary" id="exportRoom" disabled>export room</button>
    <button class="btn danger" id="resetDraft">reset</button>
    <div class="noteIcon" id="noteIcon" title="SYSTEM NOTE"></div>
  </div>
</div>

<div class="main">

  <!-- LEFT: STEP RAIL -->
  <div class="rail">
    <div class="railHead">
      <div class="railTitle">Pipeline</div>
      <div class="kbd">1–5</div>
    </div>
    <div class="railBody">
      <div class="stepList" id="stepList"></div>

      <div class="help">
        <div><strong>HOTKEYS</strong></div>
        <div>1–5: steps</div>
        <div>Cmd+;: system note</div>
        <div>Ctrl/Cmd+S: save draft</div>
        <div>C: copy output</div>
        <div>E: export room</div>
      </div>
    </div>
  </div>

  <!-- CENTER: ACTIVE WORK ZONE -->
  <div class="rail center">
    <div class="centerHead">
      <div>
        <div class="centerTitle" id="centerTitle">DEFINE ROOM</div>
        <div class="centerSub" id="centerSub">Create a room definition. No other edits allowed in this step.</div>
      </div>
      <div style="display:flex; gap:10px;">
        <button class="btn" id="prevStep">prev</button>
        <button class="btn" id="nextStep">next</button>
      </div>
    </div>

    <div class="centerBody" id="centerBody">
      <!-- injected -->
    </div>
  </div>

  <!-- RIGHT: OUTPUT (READ ONLY) -->
  <div class="rail">
    <div class="rightHead">
      <div class="rightTitle">Generated Output</div>
      <div class="kbd">C</div>
    </div>
    <div class="rightBody">
      <div class="outputBox" id="outputBox">(complete steps 1–4, then generate)</div>
      <div class="small" id="outputMeta">No output yet.</div>
    </div>
  </div>

</div>

<!-- SYSTEM NOTE -->
<div class="note" id="note">
  <div class="noteHead" id="noteHead">
    <span>SYSTEM NOTE</span>
    <div class="noteClose" id="noteClose">x</div>
  </div>
  <div class="noteBody">
    <textarea id="systemNote" placeholder="global free-form"></textarea>
  </div>
</div>

<input type="file" id="filePick" accept="application/json" style="display:none"/>

<div class="toast" id="toast"><strong>OK</strong> <span id="toastMsg"></span></div>

<script>
/* =========================================================
   KETADATA FORGE v1 (INDUSTRIAL)
   - Step pipeline UI (no scroll mixing)
   - Draft-based generation
   - Deterministic room export
   - Local-first persistence
   ========================================================= */

const LS_KEY_STATE = "KETADATA_FORGE_V1_STATE";
const LS_KEY_DRAFT = "KETADATA_FORGE_V1_DRAFT";
const LS_KEY_UI    = "KETADATA_FORGE_V1_UI";

const STEPS = [
  { id: 1, name: "DEFINE ROOM",  sub: "Identity + metadata. Required." },
  { id: 2, name: "ATTACH MODULES", sub: "Select modules. Optional." },
  { id: 3, name: "SET FLOW", sub: "Snap / keys / rails. Optional." },
  { id: 4, name: "REVIEW", sub: "Read-only summary + validation." },
  { id: 5, name: "GENERATE", sub: "Generate output + export." }
];

const DEFAULT_MODULES = [
  { id:"registry", name:"REGISTRY", desc:"Table/list surface for items" },
  { id:"ledger", name:"LEDGER", desc:"Transactions / proof-of-motion panel" },
  { id:"gallery", name:"GALLERY", desc:"Grid gallery for images/media" },
  { id:"vi_surface", name:"VI–DI SURFACE SLOT", desc:"Controlled visual surface mount" },
  { id:"capture", name:"CAPTURE PACKET", desc:"Export state/capture hooks" },
  { id:"prompt_export", name:"PROMPT EXPORT", desc:"Prompt pack exporter panel" },
  { id:"audit", name:"AUDIT", desc:"Continuity / invariants checklist" }
];

const DEFAULT_FLOW = {
  rails: true,
  snap: false,
  sections: 1,
  keys: true,
  palette: "mono"
};

let state = loadJSON(LS_KEY_STATE) || { rooms: [], systemNote: "" };
let draft = loadJSON(LS_KEY_DRAFT) || freshDraft();
let ui = loadJSON(LS_KEY_UI) || { step: 1 };

const els = {
  stepList: document.getElementById("stepList"),
  centerBody: document.getElementById("centerBody"),
  centerTitle: document.getElementById("centerTitle"),
  centerSub: document.getElementById("centerSub"),
  prevStep: document.getElementById("prevStep"),
  nextStep: document.getElementById("nextStep"),
  outputBox: document.getElementById("outputBox"),
  outputMeta: document.getElementById("outputMeta"),
  exportRoom: document.getElementById("exportRoom"),
  exportJSON: document.getElementById("exportJSON"),
  importJSON: document.getElementById("importJSON"),
  resetDraft: document.getElementById("resetDraft"),
  filePick: document.getElementById("filePick"),
  noteIcon: document.getElementById("noteIcon"),
  note: document.getElementById("note"),
  noteHead: document.getElementById("noteHead"),
  noteClose: document.getElementById("noteClose"),
  systemNote: document.getElementById("systemNote"),
  modePill: document.getElementById("modePill"),
  stepPill: document.getElementById("stepPill"),
  statusPill: document.getElementById("statusPill"),
  toast: document.getElementById("toast"),
  toastMsg: document.getElementById("toastMsg")
};

function toast(msg){
  els.toastMsg.textContent = msg;
  els.toast.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>els.toast.classList.remove("show"), 1200);
}

function uid(){
  return Math.random().toString(36).slice(2,9) + "-" + Date.now().toString(36);
}
function nowISO(){ return new Date().toISOString(); }

function freshDraft(){
  return {
    id: "",
    title: "",
    tags: [],
    access: "public",
    notes: "",
    modules: [],
    flow: { ...DEFAULT_FLOW },
    version: "v1",
    createdAt: nowISO(),
    updatedAt: nowISO()
  };
}

function saveAll(){
  localStorage.setItem(LS_KEY_STATE, JSON.stringify(state, null, 2));
  localStorage.setItem(LS_KEY_DRAFT, JSON.stringify(draft, null, 2));
  localStorage.setItem(LS_KEY_UI, JSON.stringify(ui));
}
function loadJSON(k){
  try{ return JSON.parse(localStorage.getItem(k)); }catch(e){ return null; }
}

function stepMeta(step){
  return STEPS.find(s=>s.id===step) || STEPS[0];
}

function setStep(step){
  ui.step = Math.max(1, Math.min(5, step));
  saveAll();
  render();
}

function validateDraft(){
  const errs = [];
  const id = (draft.id||"").trim();
  const title = (draft.title||"").trim();
  if(!id) errs.push("Missing room id.");
  if(!/^[a-z0-9_-]+$/i.test(id)) errs.push("Room id must be alphanumeric/underscore/dash.");
  if(!title) errs.push("Missing room title.");
  if(draft.flow.snap){
    const n = Number(draft.flow.sections||0);
    if(!Number.isFinite(n) || n<1 || n>64) errs.push("Snap sections must be 1–64.");
  }
  return errs;
}

function draftStatus(){
  const errs = validateDraft();
  if(errs.length) return { label:"DRAFT", ok:false, errs };
  return { label:"READY", ok:true, errs:[] };
}

function renderSteps(){
  els.stepList.innerHTML = "";
  const st = draftStatus();
  STEPS.forEach(s=>{
    const div = document.createElement("div");
    div.className = "step" + (ui.step===s.id ? " active":"");
    div.innerHTML = `
      <div class="left">
        <div class="stepNum">${s.id}</div>
        <div class="stepName">${s.name}</div>
      </div>
      <div class="stepState">${ui.step===s.id ? "ACTIVE" : ""}</div>
    `;
    div.onclick = ()=>setStep(s.id);
    els.stepList.appendChild(div);
  });

  els.stepPill.textContent = String(ui.step);
  els.statusPill.textContent = st.label;
  els.modePill.textContent = "ROOMS";
  els.exportRoom.disabled = !st.ok;
}

function renderCenterHeader(){
  const meta = stepMeta(ui.step);
  els.centerTitle.textContent = meta.name;
  els.centerSub.textContent = meta.sub;
  els.prevStep.disabled = ui.step===1;
  els.nextStep.disabled = ui.step===5;
}

function field(labelText, inputEl){
  const wrap = document.createElement("div");
  const lab = document.createElement("label");
  lab.textContent = labelText;
  wrap.appendChild(lab);
  wrap.appendChild(inputEl);
  return wrap;
}

function inputText(value, placeholder, oninput){
  const i = document.createElement("input");
  i.value = value || "";
  i.placeholder = placeholder || "";
  i.addEventListener("input", ()=>oninput(i.value));
  return i;
}

function textarea(value, placeholder, oninput){
  const t = document.createElement("textarea");
  t.value = value || "";
  t.placeholder = placeholder || "";
  t.addEventListener("input", ()=>oninput(t.value));
  return t;
}

function select(value, options, onchange){
  const s = document.createElement("select");
  options.forEach(o=>{
    const opt = document.createElement("option");
    opt.value = o.value;
    opt.textContent = o.label;
    if(o.value===value) opt.selected = true;
    s.appendChild(opt);
  });
  s.addEventListener("change", ()=>onchange(s.value));
  return s;
}

function renderStep1(){
  const box = document.createElement("div");
  box.className = "card";
  box.innerHTML = `<div class="cardPad">
    <div class="cardTitle">ROOM DEFINITION</div>
  </div>`;
  const pad = box.querySelector(".cardPad");

  const id = inputText(draft.id, "e.g. lab / studio / vault", v=>{
    draft.id = v.trim();
    draft.updatedAt = nowISO();
    saveAll();
    renderRightPreview();
  });

  const title = inputText(draft.title, "e.g. LAB", v=>{
    draft.title = v;
    draft.updatedAt = nowISO();
    saveAll();
    renderRightPreview();
  });

  const tags = inputText((draft.tags||[]).join(", "), "e.g. research,tools", v=>{
    draft.tags = v.split(",").map(x=>x.trim()).filter(Boolean);
    draft.updatedAt = nowISO();
    saveAll();
    renderRightPreview();
  });

  const access = select(draft.access || "public", [
    {value:"public", label:"public"},
    {value:"internal", label:"internal"},
    {value:"private", label:"private"}
  ], v=>{
    draft.access = v;
    draft.updatedAt = nowISO();
    saveAll();
    renderRightPreview();
  });

  const notes = textarea(draft.notes, "", v=>{
    draft.notes = v;
    draft.updatedAt = nowISO();
    saveAll();
  });

  const row1 = document.createElement("div");
  row1.className = "row";
  row1.appendChild(field("ID", id));
  row1.appendChild(field("ACCESS", access));

  pad.appendChild(row1);
  pad.appendChild(field("TITLE", title));
  pad.appendChild(field("TAGS (COMMA)", tags));
  pad.appendChild(field("NOTES", notes));

  const hint = document.createElement("div");
  hint.className = "warn";
  hint.innerHTML = `<strong>RULE</strong><br>Room ID is a stable identifier. Use alphanumeric, dash, underscore only.`;
  pad.appendChild(hint);

  return box;
}

function renderStep2(){
  const wrap = document.createElement("div");
  wrap.className = "card";
  wrap.innerHTML = `<div class="cardPad">
    <div class="cardTitle">MODULES</div>
    <div class="small">Select modules to include in the generated room scaffold.</div>
    <div class="hr"></div>
    <div class="grid2" id="mods"></div>
  </div>`;
  const mods = wrap.querySelector("#mods");

  DEFAULT_MODULES.forEach(m=>{
    const c = document.createElement("div");
    c.className = "chk";
    const checked = (draft.modules||[]).includes(m.id);
    c.innerHTML = `
      <input type="checkbox" ${checked ? "checked":""} />
      <div class="meta">
        <div class="name">${m.name}</div>
        <div class="desc">${m.desc}</div>
      </div>
    `;
    const cb = c.querySelector("input");
    const toggle = ()=>{
      const set = new Set(draft.modules||[]);
      if(cb.checked) set.add(m.id); else set.delete(m.id);
      draft.modules = Array.from(set);
      draft.updatedAt = nowISO();
      saveAll();
      renderRightPreview();
    };
    c.addEventListener("click",(e)=>{
      if(e.target.tagName.toLowerCase() !== "input") cb.checked = !cb.checked;
      toggle();
    });
    cb.addEventListener("click",(e)=>e.stopPropagation());
    cb.addEventListener("change", toggle);
    mods.appendChild(c);
  });

  return wrap;
}

function renderStep3(){
  const wrap = document.createElement("div");
  wrap.className = "card";
  wrap.innerHTML = `<div class="cardPad">
    <div class="cardTitle">FLOW / NAV</div>
    <div class="small">Configure snap navigation and operator controls.</div>
    <div class="hr"></div>
    <div id="flowFields"></div>
  </div>`;
  const ff = wrap.querySelector("#flowFields");

  const railsSel = select(String(!!draft.flow.rails), [
    {value:"true", label:"on"},
    {value:"false", label:"off"}
  ], v=>{
    draft.flow.rails = (v==="true");
    draft.updatedAt = nowISO();
    saveAll(); renderRightPreview();
  });

  const snapSel = select(String(!!draft.flow.snap), [
    {value:"false", label:"off"},
    {value:"true", label:"on"}
  ], v=>{
    draft.flow.snap = (v==="true");
    if(!draft.flow.snap) draft.flow.sections = 1;
    draft.updatedAt = nowISO();
    saveAll(); renderRightPreview();
    render(); // re-render for sections enable/disable
  });

  const sections = inputText(String(draft.flow.sections||1), "1", v=>{
    const n = Number(v);
    if(Number.isFinite(n)) draft.flow.sections = Math.max(1, Math.min(64, Math.floor(n)));
    draft.updatedAt = nowISO();
    saveAll(); renderRightPreview();
  });

  const keysSel = select(String(!!draft.flow.keys), [
    {value:"true", label:"on"},
    {value:"false", label:"off"}
  ], v=>{
    draft.flow.keys = (v==="true");
    draft.updatedAt = nowISO();
    saveAll(); renderRightPreview();
  });

  const paletteSel = select(draft.flow.palette || "mono", [
    {value:"mono", label:"mono"},
    {value:"grey", label:"grey"},
    {value:"white_mode", label:"white_mode"}
  ], v=>{
    draft.flow.palette = v;
    draft.updatedAt = nowISO();
    saveAll(); renderRightPreview();
  });

  const r1 = document.createElement("div");
  r1.className="row";
  r1.appendChild(field("RAILS", railsSel));
  r1.appendChild(field("SNAP", snapSel));
  ff.appendChild(r1);

  const r2 = document.createElement("div");
  r2.className="row";
  const secWrap = field("SECTIONS", sections);
  if(!draft.flow.snap) secWrap.style.opacity = "0.35";
  sections.disabled = !draft.flow.snap;
  r2.appendChild(secWrap);
  r2.appendChild(field("KEYBOARD", keysSel));
  ff.appendChild(r2);

  ff.appendChild(field("PALETTE", paletteSel));

  const hint = document.createElement("div");
  hint.className="warn";
  hint.innerHTML = `<strong>RULE</strong><br>If SNAP is on, the room generates ${draft.flow.sections||1} fixed-height sections and enforces discrete navigation.`;
  ff.appendChild(hint);

  return wrap;
}

function renderStep4(){
  const st = draftStatus();
  const wrap = document.createElement("div");
  wrap.className="card";
  wrap.innerHTML = `<div class="cardPad">
    <div class="cardTitle">REVIEW</div>
    <div class="small">Read-only. Fix errors in steps 1–3.</div>
    <div class="hr"></div>
    <div class="outputBox" id="reviewBox"></div>
    <div class="hr"></div>
    <div class="warn" id="valBox"></div>
  </div>`;
  const rb = wrap.querySelector("#reviewBox");
  rb.textContent = JSON.stringify({
    id: (draft.id||"").trim(),
    title: (draft.title||"").trim(),
    tags: draft.tags || [],
    access: draft.access,
    modules: draft.modules || [],
    flow: draft.flow || {}
  }, null, 2);

  const vb = wrap.querySelector("#valBox");
  if(st.ok){
    vb.innerHTML = `<strong>VALIDATION</strong><br>OK. Draft is ready to generate.`;
  } else {
    vb.innerHTML = `<strong>VALIDATION</strong><br>${st.errs.map(e=>"• "+e).join("<br>")}`;
  }
  return wrap;
}

function roomScaffoldHTML(d){
  const roomId = (d.id||"room").trim() || "room";
  const title  = (d.title||roomId.toUpperCase()).trim() || roomId.toUpperCase();
  const tags   = (d.tags||[]).join(", ");
  const snapOn = !!(d.flow && d.flow.snap);
  const sections = snapOn ? Math.max(1, Math.min(64, Number(d.flow.sections||1))) : 1;
  const railsOn = !!(d.flow && d.flow.rails);
  const keysOn  = !!(d.flow && d.flow.keys);

  // Minimal modules as placeholders (non-drifting)
  const moduleBlocks = (d.modules||[]).map(mid=>{
    const m = DEFAULT_MODULES.find(x=>x.id===mid);
    const name = m ? m.name : mid.toUpperCase();
    return `<div class="box"><div class="h">${name}</div><div class="mono">placeholder</div></div>`;
  }).join("\n");

  const snapCSS = snapOn ? `
.stage{ overflow:auto; scroll-snap-type:y mandatory; }
.section{ height:100vh; scroll-snap-align:start; }` : `
.stage{ overflow:auto; }
.section{ min-height:100vh; }`;

  const railsCSS = railsOn ? `
.stageInner{ display:grid; grid-template-columns:320px 1fr 420px; min-height:100%; }
.rail{ border-right:1px solid rgba(255,255,255,.14); }
.rail:last-child{ border-right:none; }` : `
.stageInner{ display:block; min-height:100%; }
.rail{ border:none; }`;

  const sectionsHTML = Array.from({length:sections}).map((_,i)=>{
    const idx = i+1;
    return `<section class="section">
  <div class="stageInner">
    ${railsOn ? `
    <div class="rail pad">
      <div class="h">LEFT RAIL</div>
      <div class="box"><div class="mono">inputs / controls</div></div>
    </div>
    <div class="rail pad">
      <div class="h">CENTER STAGE</div>
      <div class="box"><div class="mono">content</div></div>
      ${idx===1 ? `<div class="box"><div class="h">MODULES</div>${moduleBlocks || `<div class="mono">none</div>`}</div>` : ``}
    </div>
    <div class="rail pad">
      <div class="h">RIGHT RAIL</div>
      <div class="box"><div class="mono">output</div></div>
    </div>` : `
    <div class="pad">
      <div class="h">STAGE</div>
      <div class="box"><div class="mono">content</div></div>
      ${idx===1 ? `<div class="box"><div class="h">MODULES</div>${moduleBlocks || `<div class="mono">none</div>`}</div>` : ``}
    </div>`}
  </div>
</section>`;
  }).join("\n");

  const keysJS = keysOn ? `
  document.addEventListener('keydown', (e)=>{
    // j/k step; arrows step
    const stage = document.querySelector('.stage');
    if(!stage) return;
    const snap = ${snapOn ? "true":"false"};
    if(!snap) return;
    const h = window.innerHeight;
    const down = (e.key==='j' || e.key==='ArrowDown' || e.key==='PageDown');
    const up   = (e.key==='k' || e.key==='ArrowUp'   || e.key==='PageUp');
    if(down || up){
      e.preventDefault();
      stage.scrollTo({ top: stage.scrollTop + (down ? h : -h), behavior:'smooth' });
    }
  });` : "";

  return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>${title} // KETADATA</title>

<link rel="stylesheet" href="/ketadata-core.css">
<script defer src="/ketadata-core.js"></script>

<style>
html,body{height:100%;margin:0;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif;overflow:hidden}
body::before{
  content:"";position:fixed;inset:0;
  background:linear-gradient(rgba(255,255,255,.09) 1px, transparent 1px),
             linear-gradient(90deg, rgba(255,255,255,.09) 1px, transparent 1px);
  background-size:36px 36px;opacity:.26;pointer-events:none;
}
.top{
  position:fixed;left:0;right:0;top:0;
  height:44px;display:flex;align-items:center;justify-content:space-between;
  padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.14);
  background:#000;z-index:5;
}
.brand{font-weight:900;font-size:11px;letter-spacing:.22em;text-transform:uppercase}
.meta{font-family:ui-monospace,Menlo,monospace;font-size:10px;color:rgba(255,255,255,.58)}
.noteIcon{width:14px;height:14px;border:1px solid #fff;background:#fff;cursor:pointer}
.noteIcon.open{background:transparent}
.stage{ position:absolute; inset:44px 0 0 0; }
${snapCSS}
${railsCSS}
.pad{ padding:12px; }
.h{ font-size:10px; letter-spacing:.18em; text-transform:uppercase; color:rgba(255,255,255,.58); margin-bottom:8px; font-weight:900; }
.mono{ font-family:ui-monospace,Menlo,monospace; font-size:11px; color:rgba(255,255,255,.9); }
.box{ border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.02); padding:10px; margin-bottom:10px; }
.note{
  position:fixed;top:120px;right:120px;width:360px;height:360px;border:1px solid #fff;background:#000;display:none;z-index:20
}
.note.open{display:block}
.noteHead{padding:8px;border-bottom:1px solid rgba(255,255,255,.14);font-size:10px;letter-spacing:.18em;text-transform:uppercase;cursor:move;user-select:none;display:flex;justify-content:space-between}
.noteClose{border:1px solid rgba(255,255,255,.14);width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-family:ui-monospace,Menlo,monospace;cursor:pointer}
.noteBody{height:calc(100% - 34px)}
.noteBody textarea{height:100%;width:100%;border:none;outline:none;background:transparent;color:#fff;padding:10px;font-family:ui-monospace,Menlo,monospace;font-size:11px;resize:none}
</style>
</head>
<body>

<div class="top">
  <div>
    <div class="brand">${title} // KETADATA</div>
    <div class="meta">id:${roomId} | access:${d.access || "public"} | tags:${tags || "-"}</div>
  </div>
  <div style="display:flex; align-items:center; gap:12px;">
    <div class="noteIcon" id="noteIcon" title="SYSTEM NOTE"></div>
  </div>
</div>

<div class="stage">
${sectionsHTML}
</div>

<div class="note" id="note">
  <div class="noteHead" id="noteHead">
    <span>SYSTEM NOTE</span>
    <div class="noteClose" id="noteClose">x</div>
  </div>
  <div class="noteBody">
    <textarea id="systemNote">SYSTEM NOTE</textarea>
  </div>
</div>

<script>
(() => {
  const noteIcon = document.getElementById('noteIcon');
  const note = document.getElementById('note');
  const noteClose = document.getElementById('noteClose');
  const systemNote = document.getElementById('systemNote');
  const noteHead = document.getElementById('noteHead');

  function toggle(open){
    const isOpen = open ?? !note.classList.contains('open');
    note.classList.toggle('open', isOpen);
    noteIcon.classList.toggle('open', isOpen);
  }
  noteIcon.addEventListener('click', ()=>toggle());
  noteClose.addEventListener('click', ()=>toggle(false));

  document.addEventListener('keydown', (e)=>{
    const isCmd = e.metaKey || e.ctrlKey;
    if(isCmd && e.key === ';'){ e.preventDefault(); toggle(); }
  });

  // drag
  let dragging=false, ox=0, oy=0;
  noteHead.addEventListener('mousedown', (e)=>{
    dragging=true;
    const r = note.getBoundingClientRect();
    ox = e.clientX - r.left;
    oy = e.clientY - r.top;
  });
  window.addEventListener('mousemove', (e)=>{
    if(!dragging) return;
    note.style.left = (e.clientX - ox) + 'px';
    note.style.top  = (e.clientY - oy) + 'px';
    note.style.right = 'auto';
  });
  window.addEventListener('mouseup', ()=>dragging=false);

  // persistence
  const KEY = 'KETADATA_ROOM_NOTE_${roomId}';
  systemNote.value = localStorage.getItem(KEY) || systemNote.value;
  systemNote.addEventListener('input', ()=>localStorage.setItem(KEY, systemNote.value));

  ${keysJS}
})();
</script>
</body>
</html>`;
}

function renderStep5(){
  const st = draftStatus();

  const wrap = document.createElement("div");
  wrap.className="card";
  wrap.innerHTML = `<div class="cardPad">
    <div class="cardTitle">GENERATE</div>
    <div class="small">This step writes the room into the registry and produces deterministic output.</div>
    <div class="hr"></div>
    <div class="warn" id="genWarn"></div>
    <div class="hr"></div>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn primary" id="btnGenerate" ${st.ok ? "" : "disabled"}>generate output</button>
      <button class="btn" id="btnSaveRegistry" ${st.ok ? "" : "disabled"}>save to registry</button>
      <button class="btn" id="btnCopyOut" ${st.ok ? "" : "disabled"}>copy output</button>
    </div>
  </div>`;

  const gw = wrap.querySelector("#genWarn");
  if(st.ok){
    gw.innerHTML = `<strong>READY</strong><br>Generate creates output. Save writes/updates the room in registry by id.`;
  } else {
    gw.innerHTML = `<strong>BLOCKED</strong><br>${st.errs.map(e=>"• "+e).join("<br>")}`;
  }

  const btnGenerate = wrap.querySelector("#btnGenerate");
  const btnSaveReg = wrap.querySelector("#btnSaveRegistry");
  const btnCopyOut = wrap.querySelector("#btnCopyOut");

  btnGenerate.onclick = ()=>{
    const html = roomScaffoldHTML(draft);
    els.outputBox.textContent = html;
    els.outputMeta.textContent = `Generated: ${nowISO()} | chars: ${html.length}`;
    toast("output generated");
    renderSteps();
  };

  btnSaveReg.onclick = ()=>{
    const id = (draft.id||"").trim();
    const idx = (state.rooms||[]).findIndex(r=>String(r.id).trim()===id);
    const record = {
      id,
      title: (draft.title||"").trim(),
      tags: draft.tags || [],
      access: draft.access || "public",
      notes: draft.notes || "",
      modules: draft.modules || [],
      flow: draft.flow || {},
      version: draft.version || "v1",
      updatedAt: nowISO(),
      createdAt: (idx>=0 ? state.rooms[idx].createdAt : nowISO())
    };
    if(idx>=0) state.rooms[idx] = record;
    else state.rooms.push(record);
    saveAll();
    toast(idx>=0 ? "registry updated" : "registry added");
  };

  btnCopyOut.onclick = async ()=>{
    const txt = els.outputBox.textContent || "";
    if(!txt || txt.startsWith("(complete")) return;
    try{
      await navigator.clipboard.writeText(txt);
      toast("output copied");
    }catch(e){
      toast("copy failed (browser)");
    }
  };

  return wrap;
}

function renderCenter(){
  els.centerBody.innerHTML = "";
  let node;
  if(ui.step===1) node = renderStep1();
  if(ui.step===2) node = renderStep2();
  if(ui.step===3) node = renderStep3();
  if(ui.step===4) node = renderStep4();
  if(ui.step===5) node = renderStep5();
  els.centerBody.appendChild(node);
}

function renderRightPreview(){
  const st = draftStatus();
  // show compact preview always; full output only when generated
  const preview = {
    id: (draft.id||"").trim(),
    title: (draft.title||"").trim(),
    tags: draft.tags || [],
    access: draft.access || "public",
    modules: draft.modules || [],
    flow: draft.flow || {}
  };
  if(els.outputBox.textContent.startsWith("<!DOCTYPE html>")){
    // keep generated output
    return;
  }
  els.outputBox.textContent =
`DRAFT PREVIEW
${JSON.stringify(preview, null, 2)}

Validation:
${st.ok ? "OK" : st.errs.map(e=>" - "+e).join("\n")}

Go to step 5 to generate output.`;
  els.outputMeta.textContent = `Draft updated: ${draft.updatedAt || nowISO()}`;
}

function exportForgeJSON(){
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "ketadata.forge.state.json";
  a.click();
  toast("exported forge state");
}

function importForgeJSONFile(file){
  file.text().then(txt=>{
    const incoming = JSON.parse(txt);
    state.rooms = Array.isArray(incoming.rooms) ? incoming.rooms : [];
    state.systemNote = String(incoming.systemNote || "");
    saveAll();
    toast("imported forge state");
  }).catch(()=>alert("IMPORT FAILED: invalid JSON"));
}

function exportRoomHTML(){
  const st = draftStatus();
  if(!st.ok) return;
  const html = roomScaffoldHTML(draft);
  const id = (draft.id||"room").trim() || "room";
  const blob = new Blob([html], {type:"text/html"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${id}.html`;
  a.click();
  toast("exported room html");
}

function resetDraft(){
  draft = freshDraft();
  saveAll();
  els.outputBox.textContent = "(complete steps 1–4, then generate)";
  els.outputMeta.textContent = "No output yet.";
  toast("draft reset");
  render();
}

function render(){
  renderSteps();
  renderCenterHeader();
  renderCenter();
  renderRightPreview();
}

function toggleSystemNote(force){
  const open = force ?? !els.note.classList.contains("open");
  els.note.classList.toggle("open", open);
  els.noteIcon.classList.toggle("open", open);
}
function initNote(){
  els.systemNote.value = state.systemNote || "";
  els.noteIcon.onclick = ()=>toggleSystemNote();
  els.noteClose.onclick = ()=>toggleSystemNote(false);
  els.systemNote.addEventListener("input", ()=>{
    state.systemNote = els.systemNote.value;
    saveAll();
  });

  // drag
  let dragging=false, ox=0, oy=0;
  els.noteHead.addEventListener("mousedown", (e)=>{
    dragging=true;
    const r = els.note.getBoundingClientRect();
    ox = e.clientX - r.left;
    oy = e.clientY - r.top;
  });
  window.addEventListener("mousemove",(e)=>{
    if(!dragging) return;
    els.note.style.left = (e.clientX - ox) + "px";
    els.note.style.top  = (e.clientY - oy) + "px";
    els.note.style.right = "auto";
  });
  window.addEventListener("mouseup", ()=>dragging=false);
}

function initEvents(){
  els.prevStep.onclick = ()=>setStep(ui.step - 1);
  els.nextStep.onclick = ()=>setStep(ui.step + 1);

  els.exportJSON.onclick = exportForgeJSON;
  els.importJSON.onclick = ()=>els.filePick.click();
  els.filePick.onchange = ()=>{
    const f = els.filePick.files && els.filePick.files[0];
    if(f) importForgeJSONFile(f);
    els.filePick.value = "";
  };

  els.exportRoom.onclick = exportRoomHTML;
  els.resetDraft.onclick = resetDraft;

  // hotkeys
  document.addEventListener("keydown",(e)=>{
    const isCmd = e.metaKey || e.ctrlKey;

    // steps 1-5
    if(!isCmd && /^[1-5]$/.test(e.key)){
      setStep(Number(e.key));
      return;
    }

    // system note Cmd+;
    if(isCmd && e.key === ";"){
      e.preventDefault();
      toggleSystemNote();
      return;
    }

    // save draft Cmd+S
    if(isCmd && (e.key === "s" || e.key === "S")){
      e.preventDefault();
      draft.updatedAt = nowISO();
      saveAll();
      toast("draft saved");
      renderRightPreview();
      return;
    }

    // copy output
    if(!isCmd && (e.key === "c" || e.key === "C")){
      const txt = els.outputBox.textContent || "";
      if(!txt || txt.startsWith("(")) return;
      navigator.clipboard.writeText(txt).then(()=>toast("output copied")).catch(()=>toast("copy failed"));
      return;
    }

    // export room
    if(!isCmd && (e.key === "e" || e.key === "E")){
      exportRoomHTML();
      return;
    }
  });
}

/* boot */
(function boot(){
  initNote();
  initEvents();
  render();

  // ensure output meta is stable
  const st = draftStatus();
  els.exportRoom.disabled = !st.ok;
})();
</script>

</body>
</html>
