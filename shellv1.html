<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KETADATA // SHELL // KERNEL v1</title>

<!-- =========================================================
AE ▸ AESTHETIC ▸ KERNEL LOOK (VOID / SHARP / MINIMAL)
========================================================= -->
<style>
:root{
  --bg:#000; --fg:#fff; --muted:#8a8a8a; --line:#222; --line2:#333;
  --hud:#0a0a0a; --hud2:#050505;
  --top:44px; --bot:34px;

  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  --sans: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

  /* AE: slight rounding only on controllers to reduce severity */
  --ctl-radius:8px;
  --ctl-alpha:0.86;
}

*{box-sizing:border-box}
html,body{height:100%; margin:0}
body{
  background:var(--bg);
  color:var(--fg);
  font-family:var(--sans);
  overflow:hidden;
  user-select:none;
}

/* Core viewport */
#void{
  position:fixed;
  inset:0;
  background:#000;
}

/* Top bar (kernel minimal) */
.topbar{
  position:fixed;
  top:0; left:0; right:0;
  height:var(--top);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 10px;
  border-bottom:1px solid var(--line);
  background:linear-gradient(180deg,#070707,#000);
  z-index:10;
}
.brand{
  display:flex; align-items:center; gap:10px;
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.08em;
  text-transform:uppercase;
}
.brand .sq{
  width:10px; height:10px;
  border:1px solid var(--fg);
  background:#000;
}
.actions{
  display:flex; align-items:center; gap:8px;
  font-family:var(--mono);
  font-size:12px;
}
.btn{
  background:transparent;
  color:var(--fg);
  border:1px solid var(--line2);
  padding:6px 10px;
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.06em;
  text-transform:uppercase;
  cursor:pointer;
}
.btn:hover{border-color:var(--fg)}
.btn:active{transform:translateY(1px)}
.kbd{border:1px solid var(--line2); padding:2px 6px; color:var(--muted); font-size:11px}

/* Far-right KETA NOTE icon behavior:
   - filled white when collapsed
   - hollow (black inside) when open
*/
.ketaIcon{
  width:16px; height:16px;
  border:2px solid var(--fg);
  background:var(--fg); /* collapsed: filled */
  cursor:pointer;
}
.ketaIcon.open{ background:#000; } /* open: hollow */

/* Bottom system drawer trigger */
.bottombar{
  position:fixed;
  left:0; right:0; bottom:0;
  height:var(--bot);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 10px;
  border-top:1px solid var(--line);
  background:linear-gradient(0deg,#070707,#000);
  z-index:10;
  font-family:var(--mono);
  font-size:11px;
  color:var(--muted);
}
.toggle{
  border:1px solid var(--line2);
  background:transparent;
  color:var(--fg);
  padding:4px 8px;
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.06em;
  text-transform:uppercase;
  cursor:pointer;
}
.toggle:hover{border-color:var(--fg)}

/* System drawer (universals/refs/constraints) */
.drawer{
  position:fixed;
  left:0; right:0;
  bottom:var(--bot);
  height:38%;
  min-height:220px;
  border-top:1px solid var(--line);
  background:linear-gradient(180deg,#060606,#000);
  display:none;
  z-index:20;
}
.drawer.open{display:flex; flex-direction:column}
.drawerHead{
  padding:8px 10px;
  border-bottom:1px solid var(--line);
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.06em;
  text-transform:uppercase;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.drawerBody{padding:10px; min-height:0; flex:1; overflow:auto}
textarea{
  width:100%;
  border:1px solid var(--line2);
  background:#050505;
  color:var(--fg);
  font-family:var(--mono);
  font-size:12px;
  padding:10px;
  line-height:1.35;
  outline:none;
  resize:vertical;
  min-height:140px;
}

/* Floating KETA NOTE (white note) */
.ketaNote{
  position:fixed;
  top:60px; right:16px;
  width:360px; height:240px;
  border:1px solid var(--line2);
  background:rgba(10,10,10,var(--ctl-alpha));
  backdrop-filter: blur(6px);
  display:none;
  z-index:30;
  resize:both;
  overflow:hidden;
  border-radius:var(--ctl-radius); /* AE: slightly rounded controller */
}
.ketaNote.open{display:flex; flex-direction:column}
.ketaHead{
  padding:8px 10px;
  border-bottom:1px solid var(--line);
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.06em;
  text-transform:uppercase;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:move;
  border-top-left-radius:var(--ctl-radius);
  border-top-right-radius:var(--ctl-radius);
}
.ketaBody{padding:10px; min-height:0; flex:1}
.ketaNote textarea{
  background:#fff;
  color:#000;
  border:1px solid #000;
  width:100%;
  height:100%;
  resize:none;
}

/* Strobe overlay */
#strobe{
  position:fixed;
  inset:0;
  background:#000;
  opacity:0;
  pointer-events:none;
  z-index:5;
}

/* Minimal HUD toast */
.toast{
  position:fixed;
  left:12px;
  top:calc(var(--top) + 12px);
  padding:8px 10px;
  border:1px solid var(--line2);
  background:rgba(8,8,8,0.82);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.04em;
  color:var(--fg);
  display:none;
  z-index:40;
  border-radius:var(--ctl-radius);
}

/* Invert (Shift+I) — invert entire UI */
body.invert{
  filter: invert(1);
}
body.invert #void{background:#fff} /* makes void white after invert */
</style>
</head>

<body>
  <!-- AE: VOID -->
  <div id="void" aria-label="KETADATA VOID"></div>
  <div id="strobe" aria-hidden="true"></div>
  <div class="toast" id="toast"></div>

  <!-- WB: TOPBAR -->
  <div class="topbar">
    <div class="brand">
      <span class="sq"></span>
      <span>KETADATA // SHELL // KERNEL</span>
      <span style="color:var(--muted); letter-spacing:.02em; text-transform:none">v1</span>
    </div>
    <div class="actions">
      <button class="btn" id="btnImport">IMPORT STATE</button>
      <button class="btn" id="btnExport">EXPORT STATE</button>
      <button class="btn" id="btnCopy">COPY STATE</button>
      <span class="kbd" title="Invert">Shift+I</span>
      <span class="kbd" title="Strobe presets">1–6</span>
      <span class="kbd" title="Transport">Space</span>
      <div id="ketaIcon" class="ketaIcon" title="KETA_NOTE"></div>
    </div>
  </div>

  <!-- WB: SYSTEM DRAWER -->
  <div class="drawer" id="drawer">
    <div class="drawerHead">
      <div>SYSTEM UNIVERSALS</div>
      <div style="display:flex; gap:8px; align-items:center">
        <span id="sig" style="color:var(--muted); font-family:var(--mono); font-size:11px">∅</span>
        <button class="btn" id="btnCopyUniversals">COPY</button>
        <button class="btn" id="btnCloseDrawer">CLOSE</button>
      </div>
    </div>
    <div class="drawerBody">
      <textarea id="universals" placeholder="LAWS / CONSTRAINTS / REFERENCES"></textarea>
      <div style="margin-top:8px; color:var(--muted); font-family:var(--mono); font-size:11px">
        EE: Kernel axiom → KETADATA ⇒ KETA_NOTE ⇒ EXPORTABLE STATE
      </div>
    </div>
  </div>

  <!-- WB: BOTTOMBAR -->
  <div class="bottombar">
    <div style="display:flex; gap:10px; align-items:center">
      <button class="toggle" id="toggleDrawer">SYSTEM</button>
      <span>STATE: <span id="sig2">∅</span></span>
    </div>
    <div style="display:flex; gap:12px; align-items:center">
      <span>Invert: Shift+I</span>
      <span>Strobe: 1–6</span>
      <span>Transport: Space</span>
    </div>
  </div>

  <!-- WB: KETA NOTE -->
  <div class="ketaNote" id="ketaNote">
    <div class="ketaHead" id="ketaHead">
      <div>KETA NOTE</div>
      <div style="display:flex; gap:8px; align-items:center">
        <button class="btn" id="btnHideNote">HIDE</button>
      </div>
    </div>
    <div class="ketaBody">
      <textarea id="ketaText" placeholder="WHITE NOTE. GLOBAL PAGE NOTE."></textarea>
    </div>
  </div>

  <input id="file" type="file" accept="application/json" style="display:none" />

<script>
/* =========================================================
EE ▸ ENGINE ▸ KERNEL LAW (STATE + HOTKEYS + STROBE + TRANSPORT)
========================================================= */

const DEFAULT = {
  version: "KETADATA_SHELL_KERNEL_v1",
  updatedAt: new Date().toISOString(),

  // EE: mandatory atoms
  ketaNote: "",
  universals: "",

  // EE: global toggles
  ui: {
    invert:false,
    strobePreset: 0,      // 0 off, 1-6 on
    strobeEnabled:false,
    motionOn:false        // Transport: space toggles this flag (for future layers)
  },

  // WB: placeholder space for future layers to store their own state
  payload: {}
};

let STATE = loadLocal() || structuredClone(DEFAULT);

const $ = (id)=>document.getElementById(id);

function nowISO(){ return new Date().toISOString(); }
function clamp(n,a,b){ n=+n; return Math.max(a, Math.min(b, isFinite(n)?n:a)); }

function stableSig(){
  const core = JSON.stringify({
    v:STATE.version,
    i:STATE.ui.invert,
    s:STATE.ui.strobePreset,
    e:STATE.ui.strobeEnabled,
    m:STATE.ui.motionOn,
    k:(STATE.ketaNote||"").length,
    u:(STATE.universals||"").length
  });
  let h=2166136261;
  for(let i=0;i<core.length;i++){ h^=core.charCodeAt(i); h=Math.imul(h,16777619); }
  return (h>>>0).toString(16).slice(0,8);
}

function persist(){
  STATE.updatedAt = nowISO();
  try{ localStorage.setItem("ketadata.shell.kernel.v1", JSON.stringify(STATE)); }catch(e){}
  render();
}

function loadLocal(){
  try{
    const raw = localStorage.getItem("ketadata.shell.kernel.v1");
    if(!raw) return null;
    const parsed = JSON.parse(raw);
    return mergeDefault(parsed);
  }catch(e){ return null; }
}

function mergeDefault(obj){
  const out = structuredClone(DEFAULT);
  Object.assign(out, obj||{});
  out.ui = Object.assign(structuredClone(DEFAULT.ui), (obj&&obj.ui)||{});
  out.payload = Object.assign({}, (obj&&obj.payload)||{});
  return out;
}

function exportState(){
  return JSON.stringify(STATE, null, 2);
}

function importState(text){
  const parsed = JSON.parse(text);
  STATE = mergeDefault(parsed);
  persist();
}

/* =========================================================
EE ▸ ENGINE ▸ STROBE (PRESETS 1–6)
========================================================= */

let strobeTimer = null;

function strobeParams(preset){
  // EE: keep this tight. Presets differ by frequency + duty cycle.
  // duty: percent time "on" (white flash)
  const map = {
    1:{hz:2,   duty:35},
    2:{hz:4,   duty:30},
    3:{hz:7,   duty:25},
    4:{hz:10,  duty:20},
    5:{hz:14,  duty:18},
    6:{hz:20,  duty:15}
  };
  return map[preset] || {hz:0,duty:0};
}

function startStrobe(preset){
  stopStrobe();
  const {hz, duty} = strobeParams(preset);
  if(!hz) return;

  STATE.ui.strobePreset = preset;
  STATE.ui.strobeEnabled = true;

  const period = 1000 / hz;
  const onTime = period * (duty/100);

  const strobeEl = $("strobe");
  let phaseOn = false;

  strobeTimer = setInterval(()=>{
    phaseOn = !phaseOn;
    if(phaseOn){
      strobeEl.style.opacity = "1";
      // off after onTime
      setTimeout(()=>{ strobeEl.style.opacity = "0"; }, onTime);
    }
  }, period);

  toast(`STROBE ${preset}  (${hz}hz / duty ${duty}%)`);
  persist();
}

function stopStrobe(){
  if(strobeTimer){ clearInterval(strobeTimer); strobeTimer = null; }
  $("strobe").style.opacity = "0";
  STATE.ui.strobeEnabled = false;
  STATE.ui.strobePreset = 0;
  persist();
}

function toggleStrobePreset(preset){
  if(STATE.ui.strobeEnabled && STATE.ui.strobePreset === preset){
    stopStrobe();
    toast("STROBE OFF");
  }else{
    startStrobe(preset);
  }
}

/* =========================================================
EE ▸ ENGINE ▸ TRANSPORT (SPACE toggles motionOn)
========================================================= */
function toggleTransport(){
  STATE.ui.motionOn = !STATE.ui.motionOn;
  toast(STATE.ui.motionOn ? "TRANSPORT: ON" : "TRANSPORT: OFF");
  persist();
}

/* =========================================================
WB ▸ WIRING ▸ UI: NOTE + DRAWER + IO
========================================================= */

function setInvert(on){
  STATE.ui.invert = !!on;
  persist();
}

function setDrawer(open){
  $("drawer").classList.toggle("open", !!open);
}

function setKetaNote(open){
  $("ketaNote").classList.toggle("open", !!open);
  $("ketaIcon").classList.toggle("open", !!open); // open = hollow
  // AE requirement: icon filled on collapse, hollow when open (handled by CSS class)
}

function download(filename, text){
  const blob = new Blob([text], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 800);
}

async function copy(text){
  try{ await navigator.clipboard.writeText(text); toast("COPIED"); }
  catch(e){ toast("COPY FAILED"); }
}

let toastTimer=null;
function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ t.style.display="none"; }, 900);
}

function render(){
  document.body.classList.toggle("invert", !!STATE.ui.invert);
  $("ketaText").value = STATE.ketaNote || "";
  $("universals").value = STATE.universals || "";

  const s = stableSig();
  $("sig").textContent = s;
  $("sig2").textContent = s;

  // maintain strobe if enabled
  // (restart strobe timer on render only if needed and timer missing)
  if(STATE.ui.strobeEnabled && !strobeTimer && STATE.ui.strobePreset){
    startStrobe(STATE.ui.strobePreset);
  }
}

/* =========================================================
WB ▸ EVENTS
========================================================= */

$("btnImport").addEventListener("click", ()=> $("file").click());
$("file").addEventListener("change", async (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const txt = await f.text();
  importState(txt);
  e.target.value = "";
  toast("STATE IMPORTED");
});

$("btnExport").addEventListener("click", ()=>{
  download("KETADATA_SHELL_KERNEL_v1_state.json", exportState());
  toast("STATE EXPORTED");
});
$("btnCopy").addEventListener("click", ()=> copy(exportState()));

$("toggleDrawer").addEventListener("click", ()=> setDrawer(!$("drawer").classList.contains("open")));
$("btnCloseDrawer").addEventListener("click", ()=> setDrawer(false));
$("btnCopyUniversals").addEventListener("click", ()=> copy(STATE.universals || ""));

$("universals").addEventListener("input", ()=>{
  STATE.universals = $("universals").value;
  persist();
});

$("ketaIcon").addEventListener("click", ()=>{
  const open = !$("ketaNote").classList.contains("open");
  setKetaNote(open);
  toast(open ? "KETA_NOTE OPEN" : "KETA_NOTE CLOSED");
});
$("btnHideNote").addEventListener("click", ()=> setKetaNote(false));
$("ketaText").addEventListener("input", ()=>{
  STATE.ketaNote = $("ketaText").value;
  persist();
});

// Hotkeys: Shift+I invert, 1-6 strobe presets, Space transport
document.addEventListener("keydown", (e)=>{
  // Avoid interfering with typing in textareas
  const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
  const typing = (tag==="textarea" || tag==="input");

  // Shift+I: invert (safe even when typing, but user requested Shift+I to avoid collisions)
  if(e.shiftKey && e.key.toLowerCase()==="i"){
    e.preventDefault();
    setInvert(!STATE.ui.invert);
    toast(STATE.ui.invert ? "INVERT ON" : "INVERT OFF");
    return;
  }

  // 1-6: strobe presets (do not fire while typing)
  if(!typing && /^[1-6]$/.test(e.key)){
    e.preventDefault();
    toggleStrobePreset(parseInt(e.key,10));
    return;
  }

  // Space: transport toggle (do not fire while typing)
  if(!typing && (e.code==="Space" || e.key===" ")){
    e.preventDefault();
    toggleTransport();
    return;
  }

  // Esc: quick close drawer + keta note
  if(e.key==="Escape"){
    setDrawer(false);
    setKetaNote(false);
    toast("CLOSED");
    return;
  }
});

// Drag KETA NOTE
(function dragNote(){
  const box = $("ketaNote");
  const head = $("ketaHead");
  let dragging=false, ox=0, oy=0;

  head.addEventListener("mousedown", (e)=>{
    if(e.target.closest("button")) return;
    dragging=true;
    const r = box.getBoundingClientRect();
    ox = e.clientX - r.left;
    oy = e.clientY - r.top;
    box.style.left = r.left + "px";
    box.style.top  = r.top + "px";
    box.style.right = "auto";
  });
  window.addEventListener("mousemove", (e)=>{
    if(!dragging) return;
    box.style.left = (e.clientX - ox) + "px";
    box.style.top  = (e.clientY - oy) + "px";
  });
  window.addEventListener("mouseup", ()=> dragging=false);
})();

/* BOOT */
render();

/* =========================================================
AE: VOID / SHARP / MINIMAL / SLIGHTLY ROUNDED CONTROLLERS
EE: STATE / EXPORT-IMPORT / INVERT / STROBE 1-6 / TRANSPORT SPACE
WB: HOTKEYS / NOTE + DRAWER / LOCALSTORAGE / CLIPBOARD / DRAG
========================================================= */
</script>
</body>
</html>
