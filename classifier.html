<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KETADATA // SCREENSHOT + HTML CLASSIFIER</title>

  <!-- =========================================================
       AESTHETIC (SAFE TO EDIT)
       - You can change spacing, borders, fonts, sizes, colors here.
       - Do NOT remove IDs/classes referenced in JS (WIRING).
  ========================================================== -->
  <style>
    :root{
      --bg:#fff;
      --ink:#111;
      --muted:#666;
      --hair:#e9e9e9;
      --hair2:#d8d8d8;
      --card:#fff;
      --shadow: 0 8px 30px rgba(0,0,0,.06);
      --radius:12px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, sans-serif;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family: var(--sans);
      overflow:hidden;
    }
    header{
      height:52px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 14px;
      border-bottom:1px solid var(--hair);
      background:#fff;
    }
    .brand{
      display:flex; flex-direction:column; line-height:1.05;
    }
    .brand .top{ font-weight:700; letter-spacing:.5px; font-size:13px; }
    .brand .sub{ font-size:11px; color:var(--muted); font-family:var(--mono); }
    .actions{ display:flex; gap:8px; align-items:center; }
    .btn{
      border:1px solid var(--hair2);
      background:#fff;
      color:var(--ink);
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.ghost{ background:#fff; }
    .btn.dark{ background:#111; color:#fff; border-color:#111; }

    main{
      height:calc(100% - 52px);
      display:grid;
      grid-template-columns: 340px 1fr 320px;
      gap:0;
    }

    /* Left rail: categories */
    .rail{
      border-right:1px solid var(--hair);
      padding:12px;
      overflow:auto;
    }
    .rail h3{
      margin:6px 0 10px;
      font-size:11px;
      letter-spacing:.18em;
      font-weight:700;
      color:#111;
    }
    .hint{ font-size:11px; color:var(--muted); margin-bottom:10px; line-height:1.35; }
    .cat{
      border:1px solid var(--hair2);
      border-radius: var(--radius);
      background:var(--card);
      box-shadow:none;
      margin-bottom:10px;
      overflow:hidden;
    }
    .catHead{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 10px;
      border-bottom:1px solid var(--hair);
      cursor:pointer;
      user-select:none;
    }
    .catTitle{
      display:flex; align-items:center; gap:8px;
      font-weight:700;
      font-size:12px;
    }
    .pill{
      font-size:10px;
      font-family:var(--mono);
      color:var(--muted);
      border:1px solid var(--hair2);
      border-radius:999px;
      padding:2px 8px;
      background:#fff;
    }
    .catBody{
      padding:10px;
      display:none;
      gap:10px;
    }
    .catBody.open{ display:grid; }
    .drop{
      border:1px dashed var(--hair2);
      border-radius: 10px;
      padding:10px;
      min-height:88px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-size:11px;
      color:var(--muted);
      background:#fff;
    }
    .drop.dragover{
      border-style:solid;
      color:#111;
    }
    .list{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .item{
      border:1px solid var(--hair);
      border-radius:10px;
      padding:8px 8px;
      display:grid;
      grid-template-columns: 18px 1fr auto;
      gap:8px;
      align-items:center;
      background:#fff;
    }
    .sq{
      width:12px; height:12px;
      border:1px solid #111;
      background:#fff;
      border-radius:2px;
      flex:0 0 auto;
    }
    .item .meta{
      font-size:11px;
      color:#111;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .item .type{
      font-size:10px; color:var(--muted); font-family:var(--mono);
      border:1px solid var(--hair2);
      padding:2px 6px;
      border-radius:999px;
    }

    /* Center stage */
    .stage{
      position:relative;
      padding:14px;
      overflow:hidden;
    }
    .stageGrid{
      height:100%;
      border:1px solid var(--hair2);
      border-radius: var(--radius);
      background:#fff;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:grid;
      grid-template-rows: 44px 1fr 40px;
    }
    .stageTop{
      border-bottom:1px solid var(--hair);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      gap:10px;
      background:#fff;
    }
    .stageTop .left{
      display:flex; align-items:center; gap:8px;
      min-width: 0;
    }
    .stageTop .title{
      font-weight:700; font-size:12px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .stageTop .sub{
      font-size:10px; font-family:var(--mono); color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .stageTop .right{
      display:flex; gap:8px; align-items:center;
    }
    .seg{
      display:flex; align-items:center; gap:6px;
      border:1px solid var(--hair2);
      border-radius:999px;
      padding:4px 8px;
      font-size:11px;
      color:var(--muted);
    }
    .seg b{ color:#111; font-weight:700; }
    .stageMid{
      display:grid;
      grid-template-columns: 1fr;
      background:#fff;
      overflow:auto;
    }
    .canvasWrap{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .frame{
      width:min(980px, 100%);
      height:min(640px, 100%);
      border:1px solid var(--hair2);
      border-radius: 12px;
      overflow:hidden;
      background:#fff;
      display:grid;
      place-items:center;
      position:relative;
    }
    .frame.empty::before{
      content:"DROP SCREENSHOT OR PASTE HTML";
      font-family: var(--mono);
      font-size:12px;
      color:var(--muted);
      letter-spacing:.08em;
    }

    #imgView{
      max-width:100%;
      max-height:100%;
      display:none;
      object-fit:contain;
    }
    #htmlView{
      width:100%;
      height:100%;
      border:0;
      display:none;
      background:#fff;
    }

    .stageBot{
      border-top:1px solid var(--hair);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      font-size:11px;
      color:var(--muted);
      background:#fff;
    }
    .kbd{
      font-family:var(--mono);
      border:1px solid var(--hair2);
      padding:2px 6px;
      border-radius:6px;
      color:#111;
      background:#fff;
      font-size:10px;
    }

    /* Right rail: global note + diagnostics */
    .rightRail{
      border-left:1px solid var(--hair);
      padding:12px;
      overflow:auto;
      background:#fff;
    }
    .panel{
      border:1px solid var(--hair2);
      border-radius: var(--radius);
      background:#fff;
      overflow:hidden;
      margin-bottom:10px;
    }
    .panelHead{
      padding:10px 10px;
      border-bottom:1px solid var(--hair);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .panelHead .label{
      display:flex; align-items:center; gap:8px;
      font-weight:700; font-size:12px;
    }
    .panelBody{
      padding:10px;
    }
    textarea{
      width:100%;
      min-height:140px;
      resize:vertical;
      border:1px solid var(--hair2);
      border-radius:10px;
      padding:10px;
      font-family:var(--mono);
      font-size:11px;
      outline:none;
    }
    .small{
      font-size:10px; color:var(--muted); font-family:var(--mono);
      line-height:1.35;
    }
    .diag{
      font-family:var(--mono);
      font-size:11px;
      white-space:pre-wrap;
      color:#111;
      border:1px solid var(--hair2);
      border-radius:10px;
      padding:10px;
      background:#fff;
      min-height:110px;
    }

    /* Floating note widget (white square icon) */
    .floatNote{
      position:absolute;
      top:74px;
      right:340px; /* visually in center area; adjust safely */
      width:320px;
      height:240px;
      border:1px solid var(--hair2);
      border-radius:14px;
      background:#fff;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      z-index:30;
    }
    .floatHead{
      height:38px;
      border-bottom:1px solid var(--hair);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      user-select:none;
      cursor:move;
      gap:10px;
    }
    .floatHead .left{
      display:flex; align-items:center; gap:8px; min-width:0;
      font-weight:700; font-size:12px;
    }
    .floatHead .right{ display:flex; gap:6px; }
    .iconBtn{
      width:26px; height:26px;
      border:1px solid var(--hair2);
      border-radius:8px;
      display:grid;
      place-items:center;
      cursor:pointer;
      background:#fff;
      font-size:12px;
      color:#111;
      user-select:none;
    }
    .floatBody{
      padding:10px;
      height:100%;
    }
    .floatBody textarea{
      height:100%;
      min-height: 0;
      resize:none;
    }
    .resizer{
      position:absolute;
      width:14px; height:14px;
      right:4px; bottom:4px;
      cursor:nwse-resize;
      border:1px solid var(--hair2);
      border-radius:4px;
      background:#fff;
    }

    .hidden{ display:none !important; }

    /* Scrollbars minimal */
    ::-webkit-scrollbar{ width:10px; height:10px; }
    ::-webkit-scrollbar-thumb{ background:#e5e5e5; border-radius:999px; border:2px solid #fff; }
    ::-webkit-scrollbar-track{ background:#fff; }
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <div class="top">KETADATA</div>
      <div class="sub">SCREENSHOT + HTML INTAKE // CLASSIFIER + NOTES</div>
    </div>
    <div class="actions">
      <button class="btn ghost" id="exportBtn">EXPORT JSON</button>
      <button class="btn" id="clearBtn">CLEAR</button>
    </div>
  </header>

  <main>
    <!-- =========================================================
         WIRING (DO NOT RENAME IDs)
         LEFT RAIL: Categories with per-category notes + inbox list
    ========================================================== -->
    <section class="rail">
      <h3>CATEGORIES</h3>
      <div class="hint">
        Drop items into categories. Each category has its own note.
        Center stage shows the selected item (screenshot or HTML).
      </div>

      <div id="cats"></div>
    </section>

    <!-- =========================================================
         WIRING (DO NOT RENAME IDs)
         CENTER STAGE: selected screenshot or HTML preview
    ========================================================== -->
    <section class="stage" id="stage">
      <div class="stageGrid">
        <div class="stageTop">
          <div class="left">
            <div class="title" id="stageTitle">CENTER STAGE</div>
            <div class="sub" id="stageSub">drop screenshot or paste html</div>
          </div>
          <div class="right">
            <div class="seg"><b id="selKind">—</b>&nbsp;<span id="selMeta">no selection</span></div>
            <button class="btn" id="pasteHtmlBtn">PASTE HTML</button>
            <label class="btn" style="cursor:pointer;">
              <input id="fileInput" type="file" accept="image/*,.html,.htm,text/html" style="display:none;">
              IMPORT
            </label>
          </div>
        </div>

        <div class="stageMid">
          <div class="canvasWrap">
            <div class="frame empty" id="frame">
              <img id="imgView" alt="screenshot preview" />
              <iframe id="htmlView" sandbox="allow-same-origin allow-forms allow-scripts"></iframe>
            </div>
          </div>
        </div>

        <div class="stageBot">
          <div>
            Keys: <span class="kbd">1–8</span> quick-open categories ·
            <span class="kbd">N</span> toggle floating note ·
            <span class="kbd">Esc</span> clear selection
          </div>
          <div class="small" id="status">READY.</div>
        </div>
      </div>

      <!-- =========================================================
           WIRING + AESTHETIC
           Floating KETA NOTE (white square icon; move/resize/collapse)
      ========================================================== -->
      <div class="floatNote" id="floatNote" aria-label="KETA NOTE">
        <div class="floatHead" id="floatHead">
          <div class="left">
            <span class="sq" title="white square note icon"></span>
            <span>GLOBAL KETA NOTE</span>
          </div>
          <div class="right">
            <div class="iconBtn" id="floatCollapse" title="collapse">–</div>
            <div class="iconBtn" id="floatClose" title="hide">×</div>
          </div>
        </div>
        <div class="floatBody" id="floatBody">
          <textarea id="globalNote" placeholder="SYSTEM NOTE // decisions, constraints, next actions"></textarea>
        </div>
        <div class="resizer" id="floatResizer" title="resize"></div>
      </div>
    </section>

    <!-- =========================================================
         WIRING (DO NOT RENAME IDs)
         RIGHT RAIL: Global Keta Note + diagnostics (static panel)
         (Global note is also available as floating widget.)
    ========================================================== -->
    <aside class="rightRail">
      <div class="panel">
        <div class="panelHead">
          <div class="label"><span class="sq"></span> KETA NOTE</div>
          <div class="small">PAGE-LEVEL</div>
        </div>
        <div class="panelBody">
          <textarea id="globalNoteMirror" placeholder="SYSTEM NOTE // decisions, constraints, next actions"></textarea>
          <div class="small" style="margin-top:8px;">
            This mirrors the floating note (same content).
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panelHead">
          <div class="label">DIAGNOSTICS</div>
          <div class="small">LOCAL ONLY</div>
        </div>
        <div class="panelBody">
          <div class="diag" id="diag">—</div>
        </div>
      </div>
    </aside>
  </main>

  <!-- =========================================================
       ENGINE (FUNCTIONAL LOGIC)
       - Intake: drag/drop + file import + paste HTML
       - Classification: assign to category
       - Notes: per-category notes + global note
       - Export: JSON snapshot
       - Floating note: move/resize/collapse
  ========================================================== -->
  <script>
    /* =========================
       WIRING: required IDs
    ========================== */
    const $ = (id) => document.getElementById(id);
    const els = {
      cats: $("cats"),
      stage: $("stage"),
      frame: $("frame"),
      imgView: $("imgView"),
      htmlView: $("htmlView"),
      stageTitle: $("stageTitle"),
      stageSub: $("stageSub"),
      selKind: $("selKind"),
      selMeta: $("selMeta"),
      status: $("status"),
      diag: $("diag"),
      fileInput: $("fileInput"),
      pasteHtmlBtn: $("pasteHtmlBtn"),
      clearBtn: $("clearBtn"),
      exportBtn: $("exportBtn"),
      // global notes
      globalNote: $("globalNote"),
      globalNoteMirror: $("globalNoteMirror"),
      // floating
      floatNote: $("floatNote"),
      floatHead: $("floatHead"),
      floatBody: $("floatBody"),
      floatResizer: $("floatResizer"),
      floatCollapse: $("floatCollapse"),
      floatClose: $("floatClose"),
    };

    function assertWiring(){
      const missing = Object.entries(els).filter(([k,v]) => !v).map(([k])=>k);
      if(missing.length){
        document.body.innerHTML = "<pre style='padding:16px;font-family:monospace'>WIRING ERROR: Missing IDs:\\n" + missing.join("\\n") + "</pre>";
        throw new Error("Missing IDs: " + missing.join(", "));
      }
    }
    assertWiring();

    /* =========================
       ENGINE: state model
    ========================== */
    const STATE = {
      version: "ketadata-classifier-v1",
      createdAt: new Date().toISOString(),
      globalNote: "",
      categories: [
        { id:"source",  title:"SOURCE INBOX", note:"", items:[] },
        { id:"interface", title:"INTERFACE / UI", note:"", items:[] },
        { id:"layout", title:"LAYOUT / GRID", note:"", items:[] },
        { id:"typography", title:"TYPOGRAPHY", note:"", items:[] },
        { id:"motion", title:"MOTION / FEEL", note:"", items:[] },
        { id:"controls", title:"CONTROLS / INPUTS", note:"", items:[] },
        { id:"engine", title:"ENGINE / LOGIC", note:"", items:[] },
        { id:"bugs", title:"BUGS / RISKS", note:"", items:[] },
      ],
      selection: { catId:null, itemId:null }
    };

    const uid = () => Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);

    /* =========================
       ENGINE: diagnostics + status
    ========================== */
    function diag(msg){
      els.diag.textContent = msg || "—";
    }
    function status(msg){
      els.status.textContent = msg;
    }

    /* =========================
       ENGINE: global note mirror sync
    ========================== */
    function syncGlobalNoteFrom(sourceEl){
      STATE.globalNote = sourceEl.value || "";
      // mirror
      if(sourceEl !== els.globalNote) els.globalNote.value = STATE.globalNote;
      if(sourceEl !== els.globalNoteMirror) els.globalNoteMirror.value = STATE.globalNote;
    }
    els.globalNote.addEventListener("input", () => syncGlobalNoteFrom(els.globalNote));
    els.globalNoteMirror.addEventListener("input", () => syncGlobalNoteFrom(els.globalNoteMirror));

    /* =========================
       ENGINE: category UI rendering
    ========================== */
    function renderCategories(){
      els.cats.innerHTML = "";
      STATE.categories.forEach((cat, idx) => {
        const wrap = document.createElement("div");
        wrap.className = "cat";
        wrap.dataset.cat = cat.id;

        const head = document.createElement("div");
        head.className = "catHead";
        head.innerHTML = `
          <div class="catTitle">
            <span class="sq" aria-hidden="true"></span>
            <span>${cat.title}</span>
          </div>
          <div class="pill">${cat.items.length} items</div>
        `;

        const body = document.createElement("div");
        body.className = "catBody";
        body.innerHTML = `
          <div class="drop" data-drop="${cat.id}">
            DROP HERE<br><span style="font-family:var(--mono)">image/html</span>
          </div>
          <textarea class="catNote" data-note="${cat.id}" placeholder="NOTE // ${cat.title}"></textarea>
          <div class="list" data-list="${cat.id}"></div>
        `;

        // open default for inbox, closed for others
        if(cat.id === "source") body.classList.add("open");

        head.addEventListener("click", () => {
          body.classList.toggle("open");
        });

        wrap.appendChild(head);
        wrap.appendChild(body);
        els.cats.appendChild(wrap);

        // note value
        const ta = body.querySelector(`textarea[data-note="${cat.id}"]`);
        ta.value = cat.note || "";
        ta.addEventListener("input", () => {
          cat.note = ta.value || "";
        });

        // list items render
        renderList(cat.id);
      });

      wireDropzones();
    }

    function renderList(catId){
      const cat = STATE.categories.find(c => c.id === catId);
      const listEl = document.querySelector(`[data-list="${catId}"]`);
      if(!cat || !listEl) return;

      listEl.innerHTML = "";
      cat.items.forEach(item => {
        const row = document.createElement("div");
        row.className = "item";
        row.draggable = true;
        row.dataset.item = item.id;
        row.dataset.cat = catId;
        row.innerHTML = `
          <div class="sq" title="note icon"></div>
          <div class="meta" title="${escapeHtml(item.label)}">${escapeHtml(item.label)}</div>
          <div class="type">${item.kind}</div>
        `;

        row.addEventListener("click", () => {
          selectItem(catId, item.id);
        });

        row.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("text/plain", JSON.stringify({ catId, itemId:item.id }));
          e.dataTransfer.effectAllowed = "move";
        });

        listEl.appendChild(row);
      });

      // update pill counts
      const pill = document.querySelector(`.cat[data-cat="${catId}"] .pill`);
      if(pill) pill.textContent = `${cat.items.length} items`;
    }

    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    /* =========================
       ENGINE: selection + preview
    ========================== */
    function clearStage(){
      STATE.selection = { catId:null, itemId:null };
      els.frame.classList.add("empty");
      els.imgView.style.display = "none";
      els.htmlView.style.display = "none";
      els.imgView.src = "";
      els.htmlView.srcdoc = "";
      els.stageTitle.textContent = "CENTER STAGE";
      els.stageSub.textContent = "drop screenshot or paste html";
      els.selKind.textContent = "—";
      els.selMeta.textContent = "no selection";
      status("CLEARED.");
    }

    function selectItem(catId, itemId){
      const cat = STATE.categories.find(c => c.id === catId);
      const item = cat?.items.find(i => i.id === itemId);
      if(!item) return;

      STATE.selection = { catId, itemId };
      els.stageTitle.textContent = cat.title;
      els.stageSub.textContent = item.label;
      els.selKind.textContent = item.kind.toUpperCase();
      els.selMeta.textContent = itemId.slice(0,8);

      if(item.kind === "image"){
        els.frame.classList.remove("empty");
        els.htmlView.style.display = "none";
        els.imgView.style.display = "block";
        els.imgView.src = item.dataUrl;
      } else {
        els.frame.classList.remove("empty");
        els.imgView.style.display = "none";
        els.htmlView.style.display = "block";
        els.htmlView.srcdoc = item.html;
      }

      status(`SELECTED: ${cat.title} → ${item.kind}`);
    }

    /* =========================
       ENGINE: intake (file input + drop + paste HTML)
    ========================== */
    async function addItemTo(catId, item){
      const cat = STATE.categories.find(c => c.id === catId);
      if(!cat) return;

      cat.items.unshift(item);
      renderList(catId);

      // auto select
      selectItem(catId, item.id);
    }

    async function handleFile(file, targetCatId="source"){
      const name = file.name || "untitled";
      const ext = name.split(".").pop().toLowerCase();

      if(file.type.startsWith("image/")){
        const dataUrl = await fileToDataURL(file);
        return addItemTo(targetCatId, {
          id: uid(),
          kind:"image",
          label: name,
          dataUrl,
          createdAt: new Date().toISOString()
        });
      }

      // html file
      if(file.type === "text/html" || ext === "html" || ext === "htm"){
        const html = await file.text();
        return addItemTo(targetCatId, {
          id: uid(),
          kind:"html",
          label: name,
          html,
          createdAt: new Date().toISOString()
        });
      }

      throw new Error(`Unsupported file: ${name}`);
    }

    function fileToDataURL(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = () => reject(r.error || new Error("FileReader failed"));
        r.readAsDataURL(file);
      });
    }

    // file input
    els.fileInput.addEventListener("change", async () => {
      diag("—");
      const f = els.fileInput.files?.[0];
      if(!f) return;
      status("IMPORTING…");
      try{
        await handleFile(f, "source");
        status("IMPORTED.");
      }catch(e){
        diag(String(e));
        status("IMPORT FAILED.");
      }finally{
        els.fileInput.value = "";
      }
    });

    // paste html modal (minimal prompt)
    els.pasteHtmlBtn.addEventListener("click", async () => {
      const html = prompt("PASTE HTML (raw). This will render in a sandboxed iframe.");
      if(!html) return;
      await addItemTo("source", {
        id: uid(),
        kind:"html",
        label: "PASTED_HTML_" + new Date().toISOString().slice(0,19),
        html,
        createdAt: new Date().toISOString()
      });
      status("PASTED HTML ADDED.");
    });

    // stage drop: default to inbox
    wireStageDrop();
    function wireStageDrop(){
      const target = els.frame;
      ["dragenter","dragover"].forEach(ev => target.addEventListener(ev, (e)=>{
        e.preventDefault();
        e.dataTransfer.dropEffect = "copy";
        target.classList.remove("empty");
      }));
      target.addEventListener("dragleave", (e)=>{
        // leave: no-op (avoid flicker)
      });
      target.addEventListener("drop", async (e)=>{
        e.preventDefault();
        diag("—");
        const dt = e.dataTransfer;
        // internal move (from list)
        const moved = dt.getData("text/plain");
        try{
          const obj = JSON.parse(moved);
          if(obj && obj.catId && obj.itemId){
            // treat as select, not drop
            selectItem(obj.catId, obj.itemId);
            status("SELECTED (DRAG).");
            return;
          }
        }catch(_){}

        const files = Array.from(dt.files || []);
        if(!files.length) return;
        status(`IMPORTING ${files.length}…`);
        try{
          for(const f of files) await handleFile(f, "source");
          status("DROP IMPORT COMPLETE.");
        }catch(e2){
          diag(String(e2));
          status("DROP IMPORT FAILED.");
        }
      });
    }

    // category dropzones: allow moving items between categories + importing new files directly
    function wireDropzones(){
      document.querySelectorAll("[data-drop]").forEach(zone => {
        const catId = zone.getAttribute("data-drop");

        zone.addEventListener("dragover", (e)=>{
          e.preventDefault();
          zone.classList.add("dragover");
          e.dataTransfer.dropEffect = "move";
        });
        zone.addEventListener("dragleave", ()=>{
          zone.classList.remove("dragover");
        });
        zone.addEventListener("drop", async (e)=>{
          e.preventDefault();
          zone.classList.remove("dragover");
          diag("—");

          const dt = e.dataTransfer;

          // move existing item
          const payload = dt.getData("text/plain");
          if(payload){
            try{
              const obj = JSON.parse(payload);
              if(obj && obj.catId && obj.itemId){
                moveItem(obj.catId, obj.itemId, catId);
                status(`MOVED → ${catId.toUpperCase()}`);
                return;
              }
            }catch(_){}
          }

          // import new files
          const files = Array.from(dt.files || []);
          if(files.length){
            status(`IMPORTING ${files.length}…`);
            try{
              for(const f of files) await handleFile(f, catId);
              status("IMPORT COMPLETE.");
            }catch(err){
              diag(String(err));
              status("IMPORT FAILED.");
            }
          }
        });
      });
    }

    function moveItem(fromCatId, itemId, toCatId){
      if(fromCatId === toCatId) return;
      const from = STATE.categories.find(c=>c.id===fromCatId);
      const to = STATE.categories.find(c=>c.id===toCatId);
      if(!from || !to) return;

      const idx = from.items.findIndex(i=>i.id===itemId);
      if(idx < 0) return;

      const [item] = from.items.splice(idx, 1);
      to.items.unshift(item);

      renderList(fromCatId);
      renderList(toCatId);
      selectItem(toCatId, item.id);
    }

    /* =========================
       ENGINE: export / clear
    ========================== */
    function exportJSON(){
      const snapshot = JSON.parse(JSON.stringify(STATE));
      snapshot.globalNote = STATE.globalNote;
      snapshot.exportedAt = new Date().toISOString();
      const blob = new Blob([JSON.stringify(snapshot, null, 2)], { type:"application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `ketadata_classifier_${new Date().toISOString().replace(/[:.]/g,"-")}.json`;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
      status("EXPORTED JSON.");
    }
    els.exportBtn.addEventListener("click", exportJSON);

    function clearAll(){
      STATE.categories.forEach(c => { c.items = []; c.note = ""; });
      STATE.globalNote = "";
      els.globalNote.value = "";
      els.globalNoteMirror.value = "";
      renderCategories();
      clearStage();
      diag("—");
      status("RESET.");
    }
    els.clearBtn.addEventListener("click", clearAll);

    /* =========================
       ENGINE: floating note (move/resize/collapse/hide)
    ========================== */
    function setFloatCollapsed(isCollapsed){
      els.floatBody.classList.toggle("hidden", isCollapsed);
      els.floatResizer.classList.toggle("hidden", isCollapsed);
      els.floatCollapse.textContent = isCollapsed ? "+" : "–";
    }

    let floatCollapsed = false;
    els.floatCollapse.addEventListener("click", () => {
      floatCollapsed = !floatCollapsed;
      setFloatCollapsed(floatCollapsed);
    });

    els.floatClose.addEventListener("click", () => {
      els.floatNote.classList.add("hidden");
      status("FLOAT NOTE HIDDEN. Press N to toggle.");
    });

    function toggleFloatNote(){
      els.floatNote.classList.toggle("hidden");
      status(els.floatNote.classList.contains("hidden") ? "FLOAT NOTE HIDDEN." : "FLOAT NOTE SHOWN.");
    }

    // drag move
    (function(){
      let dragging = false;
      let startX=0, startY=0, startLeft=0, startTop=0;

      els.floatHead.addEventListener("mousedown", (e)=>{
        if(e.target === els.floatCollapse || e.target === els.floatClose) return;
        dragging = true;
        startX = e.clientX;
        startY = e.clientY;
        const r = els.floatNote.getBoundingClientRect();
        startLeft = r.left;
        startTop = r.top;
        document.addEventListener("mousemove", onMove);
        document.addEventListener("mouseup", onUp);
      });

      function onMove(e){
        if(!dragging) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        els.floatNote.style.left = (startLeft + dx) + "px";
        els.floatNote.style.top  = (startTop + dy) + "px";
        els.floatNote.style.right = "auto";
      }
      function onUp(){
        dragging = false;
        document.removeEventListener("mousemove", onMove);
        document.removeEventListener("mouseup", onUp);
      }
    })();

    // resize
    (function(){
      let resizing=false;
      let startX=0, startY=0, startW=0, startH=0;

      els.floatResizer.addEventListener("mousedown", (e)=>{
        e.preventDefault();
        resizing = true;
        const r = els.floatNote.getBoundingClientRect();
        startX = e.clientX;
        startY = e.clientY;
        startW = r.width;
        startH = r.height;
        document.addEventListener("mousemove", onResize);
        document.addEventListener("mouseup", onUp);
      });

      function onResize(e){
        if(!resizing) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        els.floatNote.style.width = Math.max(240, startW + dx) + "px";
        els.floatNote.style.height = Math.max(160, startH + dy) + "px";
      }
      function onUp(){
        resizing=false;
        document.removeEventListener("mousemove", onResize);
        document.removeEventListener("mouseup", onUp);
      }
    })();

    /* =========================
       ENGINE: keyboard shortcuts
    ========================== */
    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        clearStage();
      }
      if(e.key.toLowerCase() === "n"){
        toggleFloatNote();
      }
      // 1–8 open category panels
      const n = parseInt(e.key, 10);
      if(n >= 1 && n <= 8){
        const cat = STATE.categories[n-1];
        if(!cat) return;
        const body = document.querySelector(`.cat[data-cat="${cat.id}"] .catBody`);
        if(body){
          body.classList.add("open");
          body.scrollIntoView({ behavior:"smooth", block:"center" });
          status(`FOCUS: ${cat.title}`);
        }
      }
    });

    /* =========================
       BOOT
    ========================== */
    (function boot(){
      renderCategories();
      clearStage();
      diag("READY. Drop a screenshot or import an HTML file.");
      status("READY.");
      // Initialize note mirror linkage
      els.globalNote.value = STATE.globalNote;
      els.globalNoteMirror.value = STATE.globalNote;
    })();
  </script>
</body>
</html>
