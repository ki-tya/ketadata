<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KETADATA // PRIMITIVES (ROOM-SORTER GRID)</title>
  <style>
    :root{
      --bg:#000;
      --fg:#fff;
      --stroke:rgba(255,255,255,0.16);
      --stroke2:rgba(255,255,255,0.10);
      --glass:rgba(255,255,255,0.06);
      --panel:rgba(0,0,0,0.92);
      --muted:rgba(255,255,255,0.55);
      --muted2:rgba(255,255,255,0.38);
      --shadow:rgba(0,0,0,0.82);
      --danger:rgba(255,120,120,0.75);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:Arial, Helvetica, sans-serif;}
    body{overflow:hidden;}
    button,input,select,textarea{font-family:inherit}
    ::selection{background:rgba(255,255,255,0.18);}
    a{color:inherit}

    /* TOPBAR */
    #topbar{
      position:fixed; left:0; right:0; top:0;
      height:48px;
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid var(--stroke2);
      background:#000;
      user-select:none;
      z-index:80;
    }
    #brand{
      display:flex; align-items:center; gap:10px;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.80);
      min-width:240px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .whiteBox{width:10px;height:10px;background:#fff;display:inline-block;}
    .btn{
      border:1px solid var(--stroke);
      background:transparent;
      color:rgba(255,255,255,0.86);
      padding:7px 10px;
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{background:var(--glass);border-color:rgba(255,255,255,0.34);}
    .btnPrimary{background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.30);}
    .btnPrimary:hover{background:rgba(255,255,255,0.09);border-color:rgba(255,255,255,0.44);}
    .btnDanger{border-color:rgba(255,120,120,0.35);color:rgba(255,190,190,0.85);}
    .btnDanger:hover{background:rgba(255,120,120,0.10);border-color:rgba(255,120,120,0.55);}

    #noteIcon{
      width:28px;height:28px;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,0.20);
      background:rgba(255,255,255,0.10);
      cursor:pointer;
      padding:0;
    }
    #noteIcon:hover{border-color:rgba(255,255,255,0.36);background:rgba(255,255,255,0.14);}

    /* MAIN: LEFT INPUT | CENTER WORK | RIGHT OUTPUT */
    #main{
      position:fixed; inset:48px 0 0 0;
      display:grid;
      grid-template-columns: 360px 1fr 420px;
      min-height:0;
    }

    /* LEFT */
    #left{
      border-right:1px solid var(--stroke2);
      background:rgba(0,0,0,0.90);
      display:flex; flex-direction:column;
      min-height:0;
    }
    #leftHeader{
      padding:12px;
      border-bottom:1px solid var(--stroke2);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      user-select:none;
    }
    #leftHeader .title{
      margin:0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.78);
      display:flex;align-items:center;gap:10px;
    }
    #leftBody{
      padding:12px;
      overflow:auto;
      min-height:0;
    }

    .field{display:grid;gap:6px;margin-bottom:12px;}
    label{
      font-size:11px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.60);
    }
    input[type="text"], textarea, select{
      width:100%;
      border:1px solid rgba(255,255,255,0.16);
      background:rgba(255,255,255,0.04);
      color:rgba(255,255,255,0.90);
      padding:9px 10px;
      font-size:12px;
      outline:none;
    }
    textarea{min-height:90px;resize:vertical;}
    input[type="text"]:focus, textarea:focus, select:focus{
      border-color:rgba(255,255,255,0.36);
      background:rgba(255,255,255,0.06);
    }
    .hint{
      font-size:11px;
      line-height:1.35;
      color:rgba(255,255,255,0.48);
      letter-spacing:0.04em;
    }
    .pill{
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.55);
      border:1px solid rgba(255,255,255,0.14);
      padding:3px 6px;
      background:rgba(0,0,0,0.40);
      white-space:nowrap;
    }
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}

    /* CENTER: ROOM-SORTER STYLE GRID OF PRIMITIVE MODULES */
    #center{
      position:relative;
      min-height:0;
      overflow:hidden;
      background:#000;
      display:flex;
      flex-direction:column;
    }
    #centerHeader{
      padding:12px 14px;
      border-bottom:1px solid var(--stroke2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    #centerHeader .title{
      margin:0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.78);
      display:flex;align-items:center;gap:10px;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .chip{
      border:1px solid rgba(255,255,255,0.16);
      background:transparent;
      color:rgba(255,255,255,0.72);
      padding:7px 10px;
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .chip:hover{background:var(--glass);border-color:rgba(255,255,255,0.34);}
    .chip.on{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.40);color:rgba(255,255,255,0.88);}

    #centerBody{
      flex:1;
      min-height:0;
      overflow:auto;
      padding:14px;
    }

    /* "Room sorter" grid: many modules visible at once */
    #primGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
      align-items:start;
    }

    /* Each primitive module = its own collapsible "room module" */
    .primModule{
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.03);
      padding:10px;
      display:grid;
      gap:10px;
      min-height:120px;
    }
    .primModule.active{
      border-color:rgba(255,255,255,0.34);
      background:rgba(255,255,255,0.05);
    }

    .modTop{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      user-select:none;
    }
    .modTitle{
      display:flex;align-items:center;gap:10px;
      min-width:0;
    }
    .modTitleText{
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.88);
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
      max-width:100%;
    }
    .modMeta{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end;}
    .modBtns{display:flex;gap:6px;align-items:center;flex-wrap:wrap;justify-content:flex-end;}
    .miniBtn{
      border:1px solid rgba(255,255,255,0.14);
      background:transparent;
      color:rgba(255,255,255,0.70);
      padding:5px 7px;
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
    }
    .miniBtn:hover{background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.30);}
    .caret{
      width:9px;height:9px;
      border-right:1px solid rgba(255,255,255,0.60);
      border-bottom:1px solid rgba(255,255,255,0.60);
      transform:rotate(45deg);
      opacity:0.72;
      margin-left:10px;
    }
    .collapsed .caret{transform:rotate(-45deg);}

    .modBody{
      display:grid;
      gap:10px;
      min-height:0;
    }
    .collapsed .modBody{display:none;}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .muted{color:rgba(255,255,255,0.46);font-size:11px;letter-spacing:0.04em;line-height:1.35;}
    .line{
      height:1px;
      background:rgba(255,255,255,0.10);
      margin:2px 0;
    }

    /* RIGHT OUTPUT */
    #right{
      border-left:1px solid var(--stroke2);
      background:rgba(0,0,0,0.92);
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    #rightHeader{
      padding:12px;
      border-bottom:1px solid var(--stroke2);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      user-select:none;
    }
    #rightHeader .title{
      margin:0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.78);
      display:flex;align-items:center;gap:10px;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    #promptWrap{
      padding:12px;
      overflow:auto;
      min-height:0;
      display:grid;
      gap:10px;
    }
    pre{
      margin:0;
      padding:12px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.03);
      color:rgba(255,255,255,0.82);
      font-size:11px;
      line-height:1.35;
      letter-spacing:0.04em;
      white-space:pre-wrap;
      word-break:break-word;
    }

    /* DRAGGABLE SYSTEM NOTE WINDOW (NON-INTERFERING) */
    #noteLayer{
      position:absolute; inset:0;
      pointer-events:none; /* critical: never blocks grid interactions */
      z-index:140;
    }
    .noteWin{
      position:absolute;
      width:420px;
      max-width:calc(100% - 24px);
      border:1px solid rgba(255,255,255,0.22);
      background:rgba(0,0,0,0.92);
      box-shadow:0 28px 110px rgba(0,0,0,0.82);
      pointer-events:auto; /* only the window is interactive */
      user-select:none;
    }
    .noteHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 10px 8px 10px;
      border-bottom:1px solid rgba(255,255,255,0.10);
      cursor:grab;
    }
    .noteHead:active{cursor:grabbing;}
    .noteTitle{
      margin:0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.82);
      display:flex;align-items:center;gap:10px;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .noteBody{
      padding:10px;
      display:grid;
      gap:10px;
      user-select:text;
    }
    .noteBody textarea{
      min-height:120px;
      resize:vertical;
      pointer-events:auto;
      user-select:text;
    }
    .ghost{opacity:0.90;border:1px dashed rgba(255,255,255,0.28);}

    /* LOAD MODAL */
    #loadBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.72);
      display:none;
      z-index:200;
    }
    #loadModal{
      position:absolute; left:50%; top:84px;
      transform:translateX(-50%);
      width:min(680px, calc(100% - 32px));
      border:1px solid rgba(255,255,255,0.22);
      background:rgba(0,0,0,0.92);
      box-shadow:0 28px 110px rgba(0,0,0,0.82);
      padding:12px;
    }
    #loadTitle{
      margin:0 0 10px 0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.82);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      user-select:none;
    }

    /* TOAST */
    #toast{
      position:fixed;
      left:50%;
      top:68px;
      transform:translateX(-50%);
      padding:8px 10px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.72);
      color:rgba(255,255,255,0.65);
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      display:none;
      z-index:260;
    }

    @media (max-width: 1350px){
      #primGrid{grid-template-columns: repeat(2, minmax(0,1fr));}
    }
    @media (max-width: 1100px){
      #main{grid-template-columns: 340px 1fr 380px;}
      #primGrid{grid-template-columns: repeat(2, minmax(0,1fr));}
    }
    @media (max-width: 980px){
      #main{grid-template-columns: 1fr;}
      #left{display:none;}
      #right{display:none;}
      #primGrid{grid-template-columns: repeat(2, minmax(0,1fr));}
    }
  </style>
</head>

<body>
  <div id="topbar">
    <div id="brand">
      <span class="whiteBox" aria-hidden="true"></span>
      <span>KETADATA // PRIMITIVES</span>
    </div>
    <div class="row">
      <button id="exportState" class="btn btnPrimary" type="button">Export State</button>
      <button id="loadState" class="btn" type="button">Load State</button>
      <button id="exportPromptTop" class="btn" type="button">Export Prompt</button>
      <button id="noteIcon" type="button" aria-label="System Note"><span class="whiteBox" aria-hidden="true"></span></button>
    </div>
  </div>

  <div id="main">
    <!-- LEFT: INPUT -->
    <div id="left">
      <div id="leftHeader">
        <p class="title"><span class="whiteBox" aria-hidden="true"></span> Input</p>
        <button id="addPrim" class="btn btnPrimary" type="button">Add Primitive</button>
      </div>
      <div id="leftBody">
        <div class="field">
          <label for="project">Project</label>
          <input id="project" type="text" />
        </div>

        <div class="field">
          <label for="scopeFilter">Scope Filter</label>
          <select id="scopeFilter">
            <option value="">ALL</option>
            <option>SYSTEM</option>
            <option>ROOM</option>
            <option>INTERFACE</option>
            <option>MODULE</option>
            <option>CONTROL</option>
            <option>NOTE</option>
            <option>STATE</option>
            <option>PROMPT</option>
            <option>ACCESS</option>
            <option>MODE</option>
          </select>
          <div class="hint">Filter primitives without leaving the grid.</div>
        </div>

        <div class="field">
          <label for="search">Search</label>
          <input id="search" type="text" placeholder="name / tags / scope" />
        </div>

        <div class="field">
          <label>Batch</label>
          <div class="row">
            <button id="collapseAll" class="btn" type="button">Collapse All</button>
            <button id="expandAll" class="btn" type="button">Expand All</button>
          </div>
          <div class="hint">The workflow: add primitive → fill → collapse → add next.</div>
        </div>

        <div class="field">
          <label>Stats</label>
          <div class="row">
            <span class="pill" id="countPill">0 PRIMITIVES</span>
            <span class="pill" id="activePill">ACTIVE: —</span>
          </div>
        </div>

        <div class="field">
          <label>View</label>
          <div class="row">
            <button id="viewGrid" class="chip on" type="button">Grid</button>
            <button id="viewList" class="chip" type="button">List</button>
          </div>
          <div class="hint">Grid = room sorter. List = single column.</div>
        </div>
      </div>
    </div>

    <!-- CENTER: ACTIVE WORK (GRID OF PRIMITIVE MODULES) -->
    <div id="center">
      <div id="centerHeader">
        <p class="title">
          <span class="whiteBox" aria-hidden="true"></span>
          <span>Active Work</span>
        </p>
        <div class="row">
          <span class="pill" id="centerHint">click a module title to collapse/expand</span>
        </div>
      </div>

      <div id="centerBody">
        <div id="primGrid"></div>
      </div>

      <!-- draggable system note window lives here; never blocks -->
      <div id="noteLayer"></div>
    </div>

    <!-- RIGHT: OUTPUT -->
    <div id="right">
      <div id="rightHeader">
        <p class="title"><span class="whiteBox" aria-hidden="true"></span> Output</p>
        <button id="copyPromptRight" class="btn btnPrimary" type="button">Copy Prompt</button>
      </div>
      <div id="promptWrap">
        <pre id="promptPre">—</pre>
        <div class="hint">Exports reflect the whole primitive grid + system note.</div>
      </div>
    </div>
  </div>

  <!-- LOAD STATE MODAL -->
  <div id="loadBack" aria-hidden="true">
    <div id="loadModal" role="dialog" aria-label="Load State">
      <div id="loadTitle">
        <span><span class="whiteBox" style="width:9px;height:9px;"></span> LOAD STATE</span>
        <button id="closeLoad" class="btn" type="button">Close</button>
      </div>
      <div class="field">
        <label for="stateInput">Paste state URL or base64</label>
        <textarea id="stateInput" placeholder="Paste exported URL (#state=...) or raw base64."></textarea>
      </div>
      <div class="row">
        <button id="applyState" class="btn btnPrimary" type="button">Apply</button>
        <button id="clearStateInput" class="btn" type="button">Clear</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    // =========================================================
    // KETADATA // PRIMITIVES (Room-sorter grid)
    // - Each primitive is a module in the CENTER grid (like your room sorter).
    // - Add primitive -> fill fields inside module -> collapse module -> add next.
    // - Top-right white square opens a DRAGGABLE system note window.
    //   Note layer does NOT block interactions: pointer-events none.
    // - Right column is output (prompt preview + copy).
    // - Export state / Load state / Export prompt on top bar.
    // =========================================================

    const el = (id)=>document.getElementById(id);
    const uid = ()=>Math.random().toString(36).slice(2, 9)+"-"+Date.now().toString(36);

    const toastEl = el('toast');
    function toast(msg, ms=650){
      toastEl.textContent = msg;
      toastEl.style.display = 'block';
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>{ toastEl.style.display='none'; }, ms);
    }

    async function copyText(s){
      try{ await navigator.clipboard.writeText(s); toast("COPIED"); }
      catch{ window.prompt("Copy:", s); }
    }

    function encode(obj){ return btoa(unescape(encodeURIComponent(JSON.stringify(obj)))); }
    function decode(b64){ return JSON.parse(decodeURIComponent(escape(atob(b64)))); }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (m)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

    function makePrim(){
      return {
        id: uid(),
        name: "NEW_PRIMITIVE",
        scope: "SYSTEM",
        tags: [],
        def: "",
        why: "",
        ui: "",
        rules: "",
        api: "",
        version: "v1",
        semantics: "",
        collapsed: false
      };
    }

    // Draggable system note window state
    function makeSystemNoteWin(){
      return {
        open: false,
        x: 40,
        y: 40,
        w: 460,
        z: 180
      };
    }

    let state = {
      v: 4,
      project: "KETADATA",
      view: "grid", // grid|list (list = 1-column grid in center)
      primitives: [],
      activeId: null,
      systemNoteText: "",
      systemNoteWin: makeSystemNoteWin()
    };

    // Load from hash
    (function(){
      const m = location.hash.match(/state=([^&]+)/);
      if(!m){
        const p = makePrim();
        p.name = "NOTE_WHITE_SQUARE";
        p.scope = "SYSTEM";
        p.tags = ["angular","mind","export","UI"];
        p.def = "Notes are the universal metadata atom; visible as a white square.";
        p.why = "All pages must emit note metadata; entry point must be invariant.";
        p.ui = "Top-right white square toggles the system note window (draggable, non-blocking).";
        p.rules = "Must exist on every page; must export; must support tags + glossary; must not block main UX.";
        p.api = "note:{id,title,tags,body,anchors[]}; exportState(); exportPrompt()";
        p.version = "v1";
        p.semantics = "mind=angular; senses=circular; note=white square";
        state.primitives = [p];
        state.activeId = p.id;
        state.systemNoteText = "SYSTEM NOTE = global free-form. Window is movable and never blocks.";
        return;
      }
      try{
        const s = decode(m[1]);
        if(!s || (s.v !== 1 && s.v !== 2 && s.v !== 3 && s.v !== 4)) throw new Error("bad");
        state = { ...state, ...s, v: 4 };
        state.primitives = state.primitives || [];
        if(!state.primitives.length){
          const p = makePrim();
          state.primitives = [p];
          state.activeId = p.id;
        }
        state.activeId = state.activeId || state.primitives[0].id;
        state.systemNoteWin = state.systemNoteWin || makeSystemNoteWin();
      }catch{
        const p = makePrim();
        state.primitives = [p];
        state.activeId = p.id;
      }
    })();

    // LEFT controls
    const projectEl = el('project');
    const scopeFilterEl = el('scopeFilter');
    const searchEl = el('search');

    const countPill = el('countPill');
    const activePill = el('activePill');

    const addPrimBtn = el('addPrim');
    const collapseAllBtn = el('collapseAll');
    const expandAllBtn = el('expandAll');

    const viewGridBtn = el('viewGrid');
    const viewListBtn = el('viewList');

    // CENTER
    const primGrid = el('primGrid');

    // RIGHT
    const promptPre = el('promptPre');
    const copyPromptRight = el('copyPromptRight');

    // TOP
    const exportStateBtn = el('exportState');
    const loadStateBtn = el('loadState');
    const exportPromptTop = el('exportPromptTop');
    const noteIcon = el('noteIcon');

    // LOAD MODAL
    const loadBack = el('loadBack');
    const closeLoad = el('closeLoad');
    const stateInput = el('stateInput');
    const applyStateBtn = el('applyState');
    const clearStateInputBtn = el('clearStateInput');

    // NOTE LAYER
    const noteLayer = el('noteLayer');

    function activePrim(){
      return state.primitives.find(p=>p.id===state.activeId) || state.primitives[0];
    }

    function filteredPrimitives(){
      const q = searchEl.value.trim().toLowerCase();
      const scopeF = scopeFilterEl.value;
      return state.primitives.filter(p=>{
        if(scopeF && p.scope !== scopeF) return false;
        if(!q) return true;
        const blob = [
          p.name, p.scope, (p.tags||[]).join(" "),
          p.def, p.why, p.ui, p.rules, p.api, p.version, p.semantics
        ].join(" ").toLowerCase();
        return blob.includes(q);
      });
    }

    function updateStats(){
      countPill.textContent = state.primitives.length + " PRIMITIVES";
      const p = activePrim();
      activePill.textContent = "ACTIVE: " + (p?.name || "—");
      projectEl.value = state.project || "KETADATA";
      viewGridBtn.classList.toggle('on', state.view === 'grid');
      viewListBtn.classList.toggle('on', state.view === 'list');
      // list view in center = 1 column
      primGrid.style.gridTemplateColumns = (state.view === 'list') ? "1fr" : "";
    }

    // Render primitive module (room-sorter style)
    function primModuleHTML(p){
      const tags = (p.tags||[]).join(", ");
      const defLine = p.def ? p.def : "—";

      return `
        <div class="primModule ${p.id===state.activeId ? "active" : ""} ${p.collapsed ? "collapsed" : ""}" data-id="${p.id}">
          <div class="modTop">
            <div class="modTitle" data-act="toggle">
              <span class="whiteBox" style="width:9px;height:9px;"></span>
              <span class="modTitleText">${escapeHtml(p.name || "UNNAMED")}</span>
              <span class="caret" aria-hidden="true"></span>
            </div>
            <div class="modMeta">
              <span class="pill">${escapeHtml(p.scope || "—")}</span>
              <span class="pill">${escapeHtml(p.version || "v1")}</span>
            </div>
          </div>

          <div class="mini">${escapeHtml(defLine)}</div>

          <div class="modBody">
            <div class="line"></div>

            <div class="grid2">
              <div class="field" style="margin:0;">
                <label>Name</label>
                <input type="text" data-k="name" value="${escapeHtml(p.name||"")}" placeholder="PRIMITIVE_NAME" />
              </div>
              <div class="field" style="margin:0;">
                <label>Scope</label>
                <select data-k="scope">
                  ${["SYSTEM","ROOM","INTERFACE","MODULE","CONTROL","NOTE","STATE","PROMPT","ACCESS","MODE"].map(s=>{
                    const sel = (p.scope===s) ? "selected" : "";
                    return `<option ${sel}>${s}</option>`;
                  }).join("")}
                </select>
              </div>
            </div>

            <div class="field" style="margin:0;">
              <label>Tags (comma)</label>
              <input type="text" data-k="tags" value="${escapeHtml(tags)}" placeholder="angular, mind, ..." />
            </div>

            <div class="field" style="margin:0;">
              <label>One-line definition</label>
              <input type="text" data-k="def" value="${escapeHtml(p.def||"")}" placeholder="What it is." />
            </div>

            <div class="field" style="margin:0;">
              <label>Why it exists</label>
              <textarea data-k="why" placeholder="Constraint / system need.">${escapeHtml(p.why||"")}</textarea>
            </div>

            <div class="field" style="margin:0;">
              <label>UI manifestation</label>
              <textarea data-k="ui" placeholder="How it appears.">${escapeHtml(p.ui||"")}</textarea>
            </div>

            <div class="field" style="margin:0;">
              <label>Rules (invariants)</label>
              <textarea data-k="rules" placeholder="Hard rules.">${escapeHtml(p.rules||"")}</textarea>
            </div>

            <div class="grid2">
              <div class="field" style="margin:0;">
                <label>State / metadata keys</label>
                <input type="text" data-k="api" value="${escapeHtml(p.api||"")}" placeholder="exportState(); ..." />
              </div>
              <div class="field" style="margin:0;">
                <label>Version</label>
                <input type="text" data-k="version" value="${escapeHtml(p.version||"v1")}" />
              </div>
            </div>

            <div class="field" style="margin:0;">
              <label>Semantics note</label>
              <textarea data-k="semantics" placeholder="mind=angular; senses=circular; ...">${escapeHtml(p.semantics||"")}</textarea>
            </div>

            <div class="row" style="justify-content:space-between;">
              <div class="row">
                <button class="miniBtn" data-act="setActive">set active</button>
                <button class="miniBtn" data-act="collapse">collapse</button>
              </div>
              <div class="row">
                <button class="miniBtn" data-act="duplicate">duplicate</button>
                <button class="miniBtn btnDanger" data-act="delete">delete</button>
              </div>
            </div>

            <div class="muted">Workflow: fill → collapse → add next. Collapse hides internals but keeps the definition line visible.</div>
          </div>
        </div>
      `;
    }

    function renderGrid(){
      const items = filteredPrimitives();
      primGrid.innerHTML = items.map(primModuleHTML).join("");

      // attach events once (delegation)
      primGrid.onclick = (e)=>{
        const mod = e.target.closest('.primModule');
        if(!mod) return;
        const id = mod.dataset.id;
        const p = state.primitives.find(x=>x.id===id);
        if(!p) return;

        const act = e.target.dataset.act;

        if(act === "toggle"){
          p.collapsed = !p.collapsed;
          if(!p.collapsed) state.activeId = p.id;
          renderAll();
          return;
        }
        if(act === "setActive"){
          state.activeId = p.id;
          renderAll();
          toast("ACTIVE");
          return;
        }
        if(act === "collapse"){
          p.collapsed = true;
          renderAll();
          return;
        }
        if(act === "duplicate"){
          const copy = JSON.parse(JSON.stringify(p));
          copy.id = uid();
          copy.name = (p.name || "PRIMITIVE") + "_COPY";
          state.primitives.unshift(copy);
          state.activeId = copy.id;
          renderAll();
          toast("DUP");
          return;
        }
        if(act === "delete"){
          if(state.primitives.length <= 1){ toast("KEEP ONE"); return; }
          state.primitives = state.primitives.filter(x=>x.id!==p.id);
          state.activeId = state.primitives[0].id;
          renderAll();
          toast("DELETED");
          return;
        }

        // click the module area sets active (without toggling)
        if(!act){
          state.activeId = p.id;
          updateStats();
          renderPromptPreview();
        }
      };

      primGrid.oninput = (e)=>{
        const mod = e.target.closest('.primModule');
        if(!mod) return;
        const id = mod.dataset.id;
        const p = state.primitives.find(x=>x.id===id);
        if(!p) return;

        const k = e.target.dataset.k;
        if(!k) return;

        if(k === "tags"){
          p.tags = e.target.value.split(",").map(s=>s.trim()).filter(Boolean);
        }else{
          p[k] = e.target.value;
        }

        // Keep definition line live + prompt live
        const mini = mod.querySelector('.mini');
        if(mini && (k==="def" || k==="name" || k==="scope" || k==="version")){
          // quick inline refresh by rerendering all (simple, consistent)
          // still fast enough at this scale; if you later hit 200+ primitives, optimize.
          renderAll(false);
          return;
        }
        renderPromptPreview();
      };
    }

    // =========================
    // Draggable system note window (non-blocking)
    // =========================
    function renderSystemNote(){
      noteLayer.innerHTML = "";
      if(!state.systemNoteWin.open) return;

      const win = document.createElement('div');
      win.className = "noteWin";
      win.style.left = (state.systemNoteWin.x|0) + "px";
      win.style.top  = (state.systemNoteWin.y|0) + "px";
      win.style.width= (state.systemNoteWin.w||460) + "px";
      win.style.zIndex = String(state.systemNoteWin.z || 180);

      win.innerHTML = `
        <div class="noteHead">
          <p class="noteTitle"><span class="whiteBox" style="width:9px;height:9px;"></span> SYSTEM NOTE</p>
          <div class="row">
            <button class="miniBtn" data-act="min">min</button>
            <button class="miniBtn" data-act="close">close</button>
          </div>
        </div>
        <div class="noteBody">
          <div class="field" style="margin:0;">
            <label>Free-form note</label>
            <textarea id="sysNoteArea" placeholder="global constraints / laws / reminders">${escapeHtml(state.systemNoteText||"")}</textarea>
            <div class="hint">Movable. Never blocks primitive grid interaction.</div>
          </div>
          <div class="row">
            <button class="btn btnPrimary" data-act="save">Save</button>
            <button class="btn" data-act="clear">Clear</button>
          </div>
        </div>
      `;
      noteLayer.appendChild(win);

      // bring to front on mousedown
      win.addEventListener('mousedown', ()=>{
        state.systemNoteWin.z = (state.systemNoteWin.z||180) + 1;
        win.style.zIndex = String(state.systemNoteWin.z);
      });

      // drag on header only
      const head = win.querySelector('.noteHead');
      let dragging = false, dx = 0, dy = 0;

      const centerRect = el('center').getBoundingClientRect();

      function onMove(e){
        if(!dragging) return;
        const x = clamp(e.clientX - centerRect.left - dx, 6, centerRect.width - 40);
        const y = clamp(e.clientY - centerRect.top - dy, 6, centerRect.height - 40);
        win.style.left = x + "px";
        win.style.top  = y + "px";
      }
      function onUp(){
        dragging = false;
        head.classList.remove('ghost');
        document.removeEventListener('mousemove', onMove);
        state.systemNoteWin.x = parseFloat(win.style.left) || state.systemNoteWin.x;
        state.systemNoteWin.y = parseFloat(win.style.top) || state.systemNoteWin.y;
      }

      head.addEventListener('mousedown', (e)=>{
        // don't start drag from buttons
        if(e.target && e.target.tagName && e.target.tagName.toLowerCase()==='button') return;
        dragging = true;
        head.classList.add('ghost');
        const r = win.getBoundingClientRect();
        dx = e.clientX - r.left;
        dy = e.clientY - r.top;
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp, { once:true });
      });

      // textarea input
      win.querySelector('#sysNoteArea').addEventListener('input', (e)=>{
        state.systemNoteText = e.target.value;
        renderPromptPreview();
      });

      // actions
      win.addEventListener('click', (e)=>{
        const act = e.target.dataset.act;
        if(!act) return;
        if(act === "close"){
          state.systemNoteWin.open = false;
          renderSystemNote();
          renderPromptPreview();
        }
        if(act === "min"){
          const body = win.querySelector('.noteBody');
          body.style.display = (body.style.display === "none") ? "grid" : "none";
        }
        if(act === "save"){
          toast("SAVED");
          renderPromptPreview();
        }
        if(act === "clear"){
          state.systemNoteText = "";
          win.querySelector('#sysNoteArea').value = "";
          toast("CLEARED");
          renderPromptPreview();
        }
      });
    }

    // =========================
    // Prompt preview
    // =========================
    function buildPrompt(){
      const payload = {
        system: "KETADATA",
        page: "primitives-grid",
        project: state.project,
        view: state.view,
        systemNote: state.systemNoteText || "",
        primitives: state.primitives.map(p=>({
          id:p.id,
          name:p.name,
          scope:p.scope,
          tags:p.tags,
          def:p.def,
          why:p.why,
          ui:p.ui,
          rules:p.rules,
          api:p.api,
          version:p.version,
          semantics:p.semantics,
          collapsed: !!p.collapsed
        })),
        activeId: state.activeId
      };

      const active = activePrim();
      return [
        "KETADATA PRIMITIVES / EXPORT PROMPT",
        "RULES:",
        "- Center grid behaves like room sorter: each primitive is a module.",
        "- User flow: add primitive → fill → collapse → add next (many visible at once).",
        "- System note is draggable and does NOT block interactions (noteLayer pointer-events:none).",
        "- Left=input controls, center=active work, right=output.",
        "",
        `PROJECT: ${state.project}`,
        `ACTIVE: ${active?.name || "—"}`,
        "",
        "SYSTEM NOTE:",
        state.systemNoteText ? state.systemNoteText : "(none)",
        "",
        "STATE(JSON):",
        JSON.stringify(payload, null, 2)
      ].join("\\n");
    }
    function renderPromptPreview(){
      promptPre.textContent = buildPrompt();
    }

    // =========================
    // Export / Load State
    // =========================
    function exportState(){
      const safe = JSON.parse(JSON.stringify(state));
      const b64 = encode(safe);
      const url = location.origin + location.pathname + "#state=" + b64;
      return { safe, url };
    }
    function showLoad(){
      loadBack.style.display = 'block';
      loadBack.setAttribute('aria-hidden','false');
      stateInput.value = "";
      setTimeout(()=>stateInput.focus(), 0);
    }
    function hideLoad(){
      loadBack.style.display = 'none';
      loadBack.setAttribute('aria-hidden','true');
    }
    function applyStateFromText(txt){
      const t = (txt||"").trim();
      if(!t){ toast("EMPTY"); return; }
      let b64 = t;
      const m = t.match(/#state=([^&\\s]+)/);
      if(m) b64 = m[1];
      try{
        const s = decode(b64);
        if(!s || (s.v !== 1 && s.v !== 2 && s.v !== 3 && s.v !== 4)) throw new Error("bad");
        state = { ...state, ...s, v: 4 };
        state.primitives = state.primitives || [];
        if(!state.primitives.length){
          const p = makePrim();
          state.primitives = [p];
          state.activeId = p.id;
        }
        state.activeId = state.activeId || state.primitives[0].id;
        state.systemNoteWin = state.systemNoteWin || makeSystemNoteWin();
        toast("LOADED");
        location.hash = "state=" + b64;
        renderAll();
        hideLoad();
      }catch{
        toast("INVALID");
      }
    }

    // =========================
    // Controls
    // =========================
    projectEl.addEventListener('input', ()=>{
      state.project = projectEl.value;
      renderPromptPreview();
    });
    scopeFilterEl.addEventListener('change', renderAll);
    searchEl.addEventListener('input', renderAll);

    viewGridBtn.addEventListener('click', ()=>{
      state.view = "grid";
      updateStats();
      renderAll();
    });
    viewListBtn.addEventListener('click', ()=>{
      state.view = "list";
      updateStats();
      renderAll();
    });

    addPrimBtn.addEventListener('click', ()=>{
      const p = makePrim();
      state.primitives.unshift(p);
      state.activeId = p.id;
      renderAll();
      toast("ADDED");
    });

    collapseAllBtn.addEventListener('click', ()=>{
      state.primitives.forEach(p=>p.collapsed = true);
      renderAll();
      toast("COLLAPSED");
    });
    expandAllBtn.addEventListener('click', ()=>{
      state.primitives.forEach(p=>p.collapsed = false);
      renderAll();
      toast("EXPANDED");
    });

    exportStateBtn.addEventListener('click', async ()=>{
      const { url } = exportState();
      await copyText(url);
      location.hash = url.split("#")[1];
    });
    loadStateBtn.addEventListener('click', showLoad);
    exportPromptTop.addEventListener('click', async ()=> await copyText(buildPrompt()));
    copyPromptRight.addEventListener('click', async ()=> await copyText(buildPrompt()));

    noteIcon.addEventListener('click', ()=>{
      state.systemNoteWin.open = !state.systemNoteWin.open;
      // default placement near top-right of center
      if(state.systemNoteWin.open){
        const c = el('center').getBoundingClientRect();
        state.systemNoteWin.x = clamp(Math.floor(c.width - (state.systemNoteWin.w||460) - 20), 10, c.width - 40);
        state.systemNoteWin.y = 14;
      }
      renderSystemNote();
      renderPromptPreview();
    });

    // load modal
    closeLoad.addEventListener('click', hideLoad);
    loadBack.addEventListener('click', (e)=>{ if(e.target===loadBack) hideLoad(); });
    applyStateBtn.addEventListener('click', ()=> applyStateFromText(stateInput.value));
    clearStateInputBtn.addEventListener('click', ()=> stateInput.value = "");

    // keyboard
    window.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){
        if(loadBack.style.display === 'block') hideLoad();
        if(state.systemNoteWin.open){
          state.systemNoteWin.open = false;
          renderSystemNote();
        }
      }
      // fast add primitive: Shift+A
      if((e.key === 'A' || e.key === 'a') && e.shiftKey){
        const a = document.activeElement;
        const tag = a && a.tagName ? a.tagName.toLowerCase() : '';
        if(tag !== 'input' && tag !== 'textarea' && tag !== 'select'){
          const p = makePrim();
          state.primitives.unshift(p);
          state.activeId = p.id;
          renderAll();
          toast("ADDED");
        }
      }
    });

    // keep note bounded on resize
    window.addEventListener('resize', ()=>{
      const c = el('center').getBoundingClientRect();
      state.systemNoteWin.x = clamp(state.systemNoteWin.x, 6, c.width - 40);
      state.systemNoteWin.y = clamp(state.systemNoteWin.y, 6, c.height - 40);
      renderSystemNote();
    });

    // =========================
    // Render
    // =========================
    function renderAll(withNote=true){
      updateStats();
      renderGrid();
      if(withNote) renderSystemNote();
      renderPromptPreview();
    }

    // init
    updateStats();
    renderAll();
  </script>
</body>
</html>
