<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SHELL8 // KDTV1 WRAP (SYSTEM.HTML)</title>
  <style>
    :root{
      /* ===== Shell8 system tokens (kept minimal; cosmetic later) ===== */
      --S8_BG:#000;
      --S8_PANEL: rgba(255,255,255,.035);
      --S8_PANEL2: rgba(255,255,255,.02);
      --S8_LINE: rgba(255,255,255,.10);
      --S8_LINE2: rgba(255,255,255,.16);
      --S8_TEXT: rgba(255,255,255,.86);
      --S8_MUTED: rgba(255,255,255,.56);
      --S8_MUTED2: rgba(255,255,255,.40);
      --S8_RED: #ff2a2a;
      --S8_R: 10px;
      --S8_R2: 12px;

      /* Lights (continuous) */
      --S8_LIGHT: 0.0; /* 0..1 */

      /* KDTV originals */
      --bg:#000;
      --panel: rgba(255,255,255,.035);
      --panel2: rgba(255,255,255,.02);
      --line: rgba(255,255,255,.10);
      --line2: rgba(255,255,255,.16);
      --text: rgba(255,255,255,.86);
      --muted: rgba(255,255,255,.56);
      --muted2: rgba(255,255,255,.40);
      --red: #ff2a2a;
      --r: 10px;
      --r2: 12px;

      --heroH: 100vh;

      /* multi default */
      --gridCols: 3;
      --gridGap: 10px;
      --tileMinH: 220px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow-x:hidden;
    }

    /* ===== Shell8 layout ===== */
    .s8Wrap{
      min-height:100vh;
      background: var(--S8_BG);
      position:relative;
      isolation:isolate;
    }

    .s8Top, .s8Bottom{
      position:fixed;
      left:12px; right:12px;
      z-index:1000;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 12px;
      border:1px solid var(--S8_LINE);
      border-radius: 999px;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(12px);
    }
    .s8Top{ top:12px; }
    .s8Bottom{ bottom:12px; }

    .s8Top.hidden, .s8Bottom.hidden{ display:none !important; }

    .s8Brand{
      user-select:none;
      display:flex;
      align-items:baseline;
      gap:10px;
      padding: 7px 10px;
      border:1px solid var(--S8_LINE);
      border-radius: 999px;
      background: rgba(0,0,0,.35);
      letter-spacing:.22em;
      text-transform:uppercase;
      font-size:11px;
      color: var(--S8_MUTED);
      white-space:nowrap;
    }
    .s8Brand strong{
      color: rgba(255,255,255,.88);
      font-weight:700;
      letter-spacing:.26em;
    }
    .s8Brand .slash{ opacity:.6; }

    .s8Group{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .s8Btn{
      cursor:pointer;
      user-select:none;
      border:1px solid var(--S8_LINE);
      background: rgba(255,255,255,.03);
      color: var(--S8_MUTED);
      border-radius: 999px;
      padding: 8px 10px;
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      transition: border-color .15s ease, color .15s ease, background .15s ease;
    }
    .s8Btn:hover{ border-color: var(--S8_LINE2); color: rgba(255,255,255,.75); background: rgba(255,255,255,.045); }
    .s8Btn:active{ transform: translateY(1px); }
    .s8Btn.red{
      border-color: rgba(255,42,42,.55);
      background: rgba(255,42,42,.06);
      color: rgba(255,255,255,.72);
    }
    .s8Pill{
      border:1px solid var(--S8_LINE);
      border-radius: 999px;
      padding: 8px 10px;
      background: rgba(0,0,0,.35);
      color: var(--S8_MUTED2);
      font-size:11px;
      letter-spacing:.10em;
      text-transform:uppercase;
      white-space:nowrap;
      user-select:none;
    }

    .s8Lights{
      display:flex;
      gap:6px;
      align-items:center;
      padding: 6px 8px;
      border:1px solid var(--S8_LINE);
      border-radius: 999px;
      background: rgba(255,255,255,.02);
      user-select:none;
    }
    .s8LightDot{
      width:14px; height:14px;
      border-radius:999px;
      border:1px solid var(--S8_LINE);
      background: rgba(255,255,255,.02);
      cursor:pointer;
      position:relative;
      overflow:hidden;
    }
    .s8LightDot::after{
      content:"";
      position:absolute; inset:0;
      background: rgba(255,255,255, var(--S8_LIGHT));
      opacity: .9;
    }
    .s8LightDot[data-i="1"]::after{ opacity: clamp(0, (var(--S8_LIGHT) - 0.00) / 0.20, 1); }
    .s8LightDot[data-i="2"]::after{ opacity: clamp(0, (var(--S8_LIGHT) - 0.20) / 0.20, 1); }
    .s8LightDot[data-i="3"]::after{ opacity: clamp(0, (var(--S8_LIGHT) - 0.40) / 0.20, 1); }
    .s8LightDot[data-i="4"]::after{ opacity: clamp(0, (var(--S8_LIGHT) - 0.60) / 0.20, 1); }
    .s8LightDot[data-i="5"]::after{ opacity: clamp(0, (var(--S8_LIGHT) - 0.80) / 0.20, 1); }
    .s8LightDot[data-i="6"]::after{
      opacity: clamp(0, (var(--S8_LIGHT) - 1.00) / 0.20, 1);
      display:none; /* placeholder: keep 6 dots but 0..1 mapping is enough */
    }

    /* KETA_NOTE */
    .s8Note{
      position:fixed;
      right: 12px;
      bottom: 72px;
      width: min(520px, calc(100vw - 24px));
      max-height: min(70vh, 720px);
      z-index:1100;
      border:1px solid var(--S8_LINE);
      border-radius: var(--S8_R2);
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(12px);
      display:none;
      overflow:hidden;
      box-shadow: 0 30px 120px rgba(0,0,0,.68);
    }
    .s8Note.on{ display:flex; flex-direction:column; }
    .s8NoteHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .s8NoteHead .t{
      letter-spacing:.18em;
      text-transform:uppercase;
      font-size:11px;
      color: var(--S8_MUTED);
      user-select:none;
    }
    .s8NoteBody{
      padding: 10px 12px;
      overflow:auto;
    }
    .s8Note textarea{
      width:100%;
      min-height: 240px;
      resize:vertical;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 10px;
      background: rgba(255,255,255,.02);
      color: var(--S8_TEXT);
      outline:none;
      padding: 10px 10px;
      font-size:12px;
      letter-spacing:.02em;
      line-height:1.35;
    }

    /* ===== KDTV ORIGINAL STYLES (UNCHANGED) ===== */

    /* subtle vignette + grain (very restrained) */
    .fx{
      position:fixed; inset:0;
      pointer-events:none;
      background:
        radial-gradient(70% 60% at 50% 40%, rgba(255,255,255,.045) 0%, rgba(0,0,0,0) 58%),
        radial-gradient(120% 90% at 50% 50%, rgba(0,0,0,0) 0%, rgba(0,0,0,.88) 72%);
      opacity:.95;
      z-index:0;
    }

    /* HERO (immersive) */
    .hero{
      position:relative;
      height: var(--heroH);
      min-height: 640px;
      width: 100%;
      z-index:1;
      padding-top: 70px;   /* space for Shell8 top bar */
      padding-bottom: 70px;/* space for Shell8 bottom bar */
    }

    .heroStage{
      position:absolute; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }

    .playerShell{
      position:relative;
      width: min(1320px, 100%);
      height: min(740px, calc(100vh - 140px));
      border-radius: var(--r2);
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      overflow:hidden;
      box-shadow: 0 30px 120px rgba(0,0,0,.68);
    }

    .playerMedia{
      position:absolute; inset:0;
      /* visual filter pipeline */
      filter: var(--kdfilter, none);
      transform: translateZ(0);
    }

    iframe, video{
      width:100%;
      height:100%;
      border:0;
      display:block;
      background:#000;
    }

    /* minimal top HUD in hero */
    .hud{
      position:absolute;
      top: 14px;
      left: 14px;
      right: 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      pointer-events:none;
    }

    .brand{
      pointer-events:auto;
      user-select:none;
      display:flex;
      align-items:baseline;
      gap:10px;
      padding: 8px 10px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      letter-spacing:.22em;
      text-transform:uppercase;
      font-size:11px;
      color: var(--muted);
    }
    .brand strong{
      color: rgba(255,255,255,.88);
      font-weight:700;
      letter-spacing:.26em;
    }
    .brand .slash{ opacity:.6; }

    .hudRight{
      pointer-events:auto;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      cursor:pointer;
      user-select:none;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      border-radius: 999px;
      padding: 8px 10px;
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      transition: border-color .15s ease, color .15s ease, background .15s ease;
    }
    .btn:hover{ border-color: var(--line2); color: rgba(255,255,255,.75); background: rgba(255,255,255,.045); }
    .btn:active{ transform: translateY(1px); }
    .btn.red{
      border-color: rgba(255,42,42,.55);
      background: rgba(255,42,42,.06);
      color: rgba(255,255,255,.72);
    }

    /* input bar (minimal) */
    .inputBar{
      position:absolute;
      left: 14px;
      right: 14px;
      bottom: 14px;
      display:flex;
      gap:10px;
      align-items:center;
      pointer-events:auto;
    }
    .input{
      flex: 1;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      min-width:0;
    }
    .input .hint{
      color: var(--muted2);
      font-size:11px;
      letter-spacing:.10em;
      text-transform:uppercase;
      white-space:nowrap;
    }
    .input input{
      flex:1;
      min-width:0;
      border:0;
      outline:0;
      background: transparent;
      color: var(--text);
      font-size:12px;
      letter-spacing:.02em;
    }
    .fileBtn{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .fileBtn input[type="file"]{
      display:none;
    }
    .pill{
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 8px 10px;
      background: rgba(0,0,0,.35);
      color: var(--muted2);
      font-size:11px;
      letter-spacing:.10em;
      text-transform:uppercase;
      white-space:nowrap;
    }

    /* Sticky control bar (appears on scroll) */
    .sticky{
      position:fixed;
      left: 16px;
      right: 16px;
      top: 86px; /* pushed below Shell8 top bar */
      z-index:40;
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 12px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(12px);
    }
    .sticky.on{ display:flex; }

    .sticky .search{
      flex: 1;
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .sticky input{
      width:100%;
      border:0;
      outline:0;
      background: transparent;
      color: var(--text);
      font-size:12px;
      letter-spacing:.02em;
    }
    .sticky .k{
      color: var(--muted2);
      font-size:11px;
      letter-spacing:.12em;
      text-transform:uppercase;
      white-space:nowrap;
    }

    /* COLLECTION */
    .collection{
      position:relative;
      z-index:1;
      width: min(1320px, calc(100% - 32px));
      margin: 0 auto;
      padding: 20px 0 110px; /* allow bottom bar */
    }

    .controlsRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      padding: 14px 0 12px;
    }

    .chip{
      cursor:pointer;
      user-select:none;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      color: var(--muted);
      border-radius: 999px;
      padding: 7px 10px;
      font-size:11px;
      letter-spacing:.10em;
      text-transform:uppercase;
    }
    .chip.active{
      border-color: var(--line2);
      background: rgba(255,255,255,.045);
      color: rgba(255,255,255,.74);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    @media (max-width: 1100px){
      .grid{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 720px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: var(--r2);
      overflow:hidden;
      cursor:pointer;
      transition: border-color .15s ease, background .15s ease, transform .15s ease;
    }
    .card:hover{
      border-color: var(--line2);
      background: rgba(255,255,255,.03);
      transform: translateY(-1px);
    }

    .cardTop{
      display:flex;
      align-items:stretch;
      gap:0;
    }
    .thumb{
      width: 40%;
      min-height: 108px;
      border-right:1px solid var(--line);
      background: rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--muted2);
      font-size:11px;
      letter-spacing:.10em;
      text-transform:uppercase;
      position:relative;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      filter: grayscale(15%) contrast(1.05) brightness(.92);
    }
    .meta{
      flex:1;
      padding: 10px 12px;
      display:flex;
      flex-direction:column;
      gap: 8px;
      min-width:0;
    }
    .meta .t{
      font-size:12px;
      color: rgba(255,255,255,.82);
      font-weight:700;
      letter-spacing:.03em;
      line-height:1.25;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .meta .s{
      font-size:11px;
      color: var(--muted);
      letter-spacing:.02em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tags{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:2px;
    }
    .tag{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 999px;
      padding: 4px 8px;
      font-size:10px;
      color: var(--muted2);
      letter-spacing:.12em;
      text-transform:uppercase;
      background: rgba(255,255,255,.015);
    }

    /* Minimal YT nod: red bracket around data only */
    .ytData{
      position:absolute;
      top: 8px;
      right: 8px;
      border:1px solid rgba(255,42,42,.75);
      border-radius: 8px;
      padding: 6px 8px;
      background: rgba(255,42,42,.06);
      color: rgba(255,255,255,.74);
      font-size:10px;
      letter-spacing:.14em;
      text-transform:uppercase;
      line-height:1.1;
      text-align:right;
      box-shadow: 0 0 0 1px rgba(255,42,42,.08) inset;
    }

    /* MULTI MODE overlay */
    .multi{
      position:fixed; inset:0;
      background:#000;
      z-index:60;
      display:none;
      flex-direction:column;
    }
    .multi.on{ display:flex; }

    .multiTop{
      padding: 12px 16px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.78);
      backdrop-filter: blur(12px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .multiTop .left, .multiTop .right{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .slider{
      display:flex;
      align-items:center;
      gap:10px;
      border:1px solid var(--line);
      border-radius:999px;
      padding: 8px 10px;
      background: rgba(255,255,255,.02);
      color: var(--muted2);
      font-size:11px;
      letter-spacing:.10em;
      text-transform:uppercase;
    }
    .slider input{ width: 120px; }

    .multiStage{
      flex:1;
      padding: 14px 16px 18px;
      overflow:auto;
    }

    .survGrid{
      display:grid;
      grid-template-columns: repeat(var(--gridCols), 1fr);
      gap: var(--gridGap);
      align-items:stretch;
    }

    .tile{
      border:1px solid var(--line);
      border-radius: var(--r2);
      background: rgba(255,255,255,.02);
      overflow:hidden;
      cursor:pointer;
      transition: border-color .15s ease, background .15s ease, transform .15s ease;
      min-height: var(--tileMinH);
      position:relative;
      resize: both;
      overflow: hidden;
    }

    /* tile header */
    .tileHud{
      position:absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      pointer-events:none;
    }
    .tileHud .mini{
      pointer-events:auto;
      border:1px solid var(--line);
      border-radius:999px;
      padding: 6px 8px;
      background: rgba(0,0,0,.40);
      color: var(--muted2);
      font-size:10px;
      letter-spacing:.14em;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 70%;
    }
    .tileHud .mini.red{
      border-color: rgba(255,42,42,.55);
      background: rgba(255,42,42,.06);
      color: rgba(255,255,255,.70);
    }

    .tileMedia{
      position:absolute; inset:0;
      filter: var(--tilefilter, none);
      transform: translateZ(0);
    }

    /* Effects drawers (hidden until expanded) */
    .drawer{
      position:absolute;
      left: 10px;
      right: 10px;
      bottom: 10px;
      border:1px solid var(--line);
      border-radius: var(--r2);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .drawerHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
    }
    .drawerHead .label{
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color: var(--muted);
      user-select:none;
    }
    .drawerBody{
      display:none;
      border-top:1px solid rgba(255,255,255,.08);
      padding: 10px;
      gap: 10px;
    }
    .drawer.open .drawerBody{ display:grid; }
    .drawerBody .row{
      display:grid;
      grid-template-columns: 120px 1fr 70px;
      gap:10px;
      align-items:center;
    }
    .drawerBody .row span{
      font-size:10px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: var(--muted2);
    }
    .drawerBody input[type="range"]{ width:100%; }
    .drawerBody .val{
      text-align:right;
      color: rgba(255,255,255,.70);
      font-size:10px;
      letter-spacing:.12em;
      text-transform:uppercase;
    }
    .drawerBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:6px;
    }

    /* small helper text */
    .note{
      color: var(--muted2);
      font-size:11px;
      line-height:1.35;
      letter-spacing:.02em;
    }

    /* clean transitions */
    .fadeOut{
      animation: fadeOut .42s ease forwards;
    }
    .fadeIn{
      animation: fadeIn .50s ease forwards;
    }
    @keyframes fadeOut{ to{ opacity:0; transform: scale(.995); } }
    @keyframes fadeIn{ from{ opacity:0; transform: scale(1.005);} to{ opacity:1; transform: scale(1);} }

    /* small utility */
    .hide{ display:none !important; }

    /* ===== Your requested behavior: immersive controls vanish unless hovered ===== */
    .kdtvControlsAutoHide .hud,
    .kdtvControlsAutoHide .inputBar,
    .kdtvControlsAutoHide #heroDrawer{
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease;
    }
    .kdtvControlsAutoHide:hover .hud,
    .kdtvControlsAutoHide:hover .inputBar,
    .kdtvControlsAutoHide:hover #heroDrawer{
      opacity: 1;
      pointer-events:auto;
    }
    /* If user forces controls visible (Shift+C), we override */
    .kdtvControlsForceShow .hud,
    .kdtvControlsForceShow .inputBar,
    .kdtvControlsForceShow #heroDrawer{
      opacity: 1 !important;
      pointer-events:auto !important;
    }

    /* ===== NULL mode: only hide system bars + controllers (stage remains) ===== */
    .s8Null .s8Top,
    .s8Null .s8Bottom{ display:none !important; }
    .s8Null .sticky{ display:none !important; } /* optional: keep stage dominant */
    .s8Null .s8Note{ display:none !important; } /* note is a controller */
    .s8Null .playerShell:not(.kdtvControlsForceShow) .hud,
    .s8Null .playerShell:not(.kdtvControlsForceShow) .inputBar,
    .s8Null .playerShell:not(.kdtvControlsForceShow) #heroDrawer{
      opacity: 0 !important;
      pointer-events:none !important;
    }
  </style>
</head>
<body>
  <div class="s8Wrap" id="s8Wrap">
    <div class="fx"></div>

    <!-- ===== Shell8 TOP BAR ===== -->
    <div class="s8Top" id="s8Top">
      <div class="s8Brand" title="Shell8 System">
        <strong>SHELL8</strong><span class="slash">//</span><span>KDTV1</span>
      </div>

      <div class="s8Group" style="justify-content:center;">
        <div class="s8Lights" title="LIGHTS (1-6) continuous intensity">
          <div class="s8LightDot" data-i="1" title="1"></div>
          <div class="s8LightDot" data-i="2" title="2"></div>
          <div class="s8LightDot" data-i="3" title="3"></div>
          <div class="s8LightDot" data-i="4" title="4"></div>
          <div class="s8LightDot" data-i="5" title="5"></div>
          <div class="s8LightDot" data-i="6" title="6"></div>
        </div>

        <button class="s8Btn" id="s8InvertBtn" title="SHIFT+I">invert</button>
        <button class="s8Btn red" id="s8NullBtn" title="SHIFT+N">null</button>
        <button class="s8Btn" id="s8NoteBtn" title="SHIFT+O">keta_note</button>
      </div>

      <div class="s8Group">
        <button class="s8Btn" id="s8HomeBtn" title="SHIFT+B">home</button>
        <button class="s8Btn" id="s8LandingBtn" title="SHIFT+K">landing</button>
        <button class="s8Btn" id="s8StateExportBtn" title="export system state">export</button>
        <button class="s8Btn" id="s8StateImportBtn" title="import system state">import</button>
        <div class="s8Pill" id="s8Status">READY</div>
      </div>
    </div>

    <!-- ===== Shell8 BOTTOM BAR ===== -->
    <div class="s8Bottom" id="s8Bottom">
      <div class="s8Pill" id="s8Hotkeys">
        HOTKEYS: 1-6 LIGHTS · SHIFT+I INVERT · SHIFT+N NULL · SHIFT+B HOME · SHIFT+K LANDING · SHIFT+O NOTE · SHIFT+C CONTROLS · SHIFT+M MULTI · SHIFT+P PLAYLIST
      </div>
      <div class="s8Group">
        <button class="s8Btn" id="s8ControlsBtn" title="SHIFT+C">controls</button>
        <button class="s8Btn red" id="s8MultiToggleBtn" title="SHIFT+M">kdtv multi</button>
      </div>
    </div>

    <!-- ===== KETA_NOTE ===== -->
    <div class="s8Note" id="s8Note">
      <div class="s8NoteHead">
        <div class="t">KETA_NOTE</div>
        <div class="s8Group">
          <button class="s8Btn" id="s8NoteSaveBtn">save</button>
          <button class="s8Btn red" id="s8NoteCloseBtn">close</button>
        </div>
      </div>
      <div class="s8NoteBody">
        <textarea id="s8NoteText" spellcheck="false" placeholder="KETA_NOTE..."></textarea>
      </div>
    </div>

    <!-- ===== Sticky bar appears after scroll (original) ===== -->
    <div class="sticky" id="sticky">
      <div class="brand" style="padding:7px 10px;">
        <strong>KDTV</strong><span class="slash">//</span><span>CINEMA</span>
      </div>
      <div class="search">
        <span class="k">search</span>
        <input id="search2" type="text" placeholder="title / tag / channel" />
      </div>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <button class="btn" id="toTop">top</button>
        <button class="btn red" id="openMulti2">kdtv multi</button>
      </div>
    </div>

    <!-- ===== HERO (IMMERSIVE) ===== -->
    <section class="hero" id="hero">
      <div class="heroStage">
        <!-- playerShell gets auto-hide behavior -->
        <div class="playerShell kdtvControlsAutoHide" id="playerShell">
          <div class="playerMedia" id="playerMedia"></div>

          <div class="hud">
            <div class="brand" title="KDTV Cinema">
              <strong>KDTV</strong><span class="slash">//</span><span>CINEMA</span>
              <span style="opacity:.45; letter-spacing:.10em;">IMMERSIVE</span>
            </div>
            <div class="hudRight">
              <button class="btn" id="effectsBtn">effects</button>
              <button class="btn red" id="openMulti">kdtv multi</button>
              <button class="btn" id="exportBtn">export</button>
              <button class="btn" id="importBtn">import</button>
            </div>
          </div>

          <div class="inputBar">
            <div class="input">
              <div class="hint">youtube url / id</div>
              <input id="ytInput" type="text" placeholder="paste: https://youtube.com/watch?v=…  or  ytid" />
            </div>

            <div class="fileBtn">
              <label class="btn" for="fileInput">local file</label>
              <input id="fileInput" type="file" accept="video/*,audio/*" />
            </div>

            <button class="btn" id="loadBtn">load</button>
            <button class="btn red" id="boilerRoomBtn" title="Load Boiler Room Archive">⚡ BR</button>
            <button class="btn" id="playlistBtn" title="SHIFT+P">list</button>
            <button class="btn" id="prevBtn" title="SHIFT+←">prev</button>
            <button class="btn" id="nextBtn" title="SHIFT+→">next</button>
            <div class="pill" id="modePill">YT MODE</div>
          </div>

          <!-- HERO effects drawer (original) -->
          <div class="drawer" id="heroDrawer" style="left:14px; right:14px; bottom:58px;">
            <div class="drawerHead">
              <div class="label">KETADATA EFFECTS</div>
              <div style="display:flex; gap:10px; align-items:center;">
                <div class="note" id="audioNote" style="max-width: 520px;">
                  Audio effects require local media (browser security prevents processing YouTube iframe audio).
                </div>
                <button class="btn" id="drawerToggle">expand</button>
              </div>
            </div>
            <div class="drawerBody" id="heroDrawerBody">
              <!-- sliders injected -->
              <div class="drawerBtns">
                <button class="btn" id="presetClean">clean</button>
                <button class="btn" id="presetInfra">infra</button>
                <button class="btn" id="presetXray">x-ray</button>
                <button class="btn" id="presetSurv">surveillance</button>
                <button class="btn" id="presetNull">null</button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- ===== COLLECTION (original) ===== -->
    <section class="collection" id="collection">
      <div class="controlsRow">
        <div class="note" style="flex:1; min-width:240px;">
          Scroll-state UI: search + categories + tags. Selecting a video routes it back into the immersive stage.
        </div>
        <div class="input" style="max-width:520px; padding:8px 12px; border-radius:999px;">
          <div class="hint">search</div>
          <input id="search" type="text" placeholder="title / tag / channel" />
        </div>
      </div>

      <div class="controlsRow" id="categoryRow"></div>
      <div class="controlsRow" id="tagRow"></div>

      <div class="grid" id="cards"></div>
    </section>

    <!-- ===== MULTI MODE (original) ===== -->
    <section class="multi" id="multi" aria-hidden="true">
      <div class="multiTop">
        <div class="left">
          <div class="brand" style="padding:7px 10px;">
            <strong>KDTV</strong><span class="slash">//</span><span>MULTI</span>
            <span style="opacity:.45; letter-spacing:.10em;">SURVEILLANCE LAYOUT</span>
          </div>

          <div class="slider" title="Grid columns">
            cols
            <input id="cols" type="range" min="1" max="6" value="3" />
            <span id="colsVal" style="color:rgba(255,255,255,.72);">3</span>
          </div>

          <div class="slider" title="Gap">
            gap
            <input id="gap" type="range" min="4" max="22" value="10" />
            <span id="gapVal" style="color:rgba(255,255,255,.72);">10</span>
          </div>

          <div class="slider" title="Minimum tile height">
            min h
            <input id="minh" type="range" min="160" max="420" value="220" />
            <span id="minhVal" style="color:rgba(255,255,255,.72);">220</span>
          </div>
        </div>

        <div class="right">
          <button class="btn" id="addTile">add module</button>
          <button class="btn" id="clearTiles">clear</button>
          <button class="btn" id="exportMulti">export</button>
          <button class="btn" id="importMulti">import</button>
          <button class="btn red" id="closeMulti">close</button>
        </div>
      </div>

      <div class="multiStage" id="multiStage">
        <div class="survGrid" id="survGrid"></div>
        <div class="note" style="margin-top:12px;">
          Modules are resizable (bottom-right handle). Effects drawers are invisible until expanded. YouTube audio cannot be processed in-browser; local media can.
        </div>
      </div>
    </section>

    <script>
      /************************************************************
       * SHELL8 SYSTEM WRAP (minimal, photobooth-continuity)
       ************************************************************/
      // Two critical "don't break it" rules:
      // Do not change FILE_ID, ROOM_ID, VERSION_ID unless you intend a new sovereign storage namespace.
      // Make sure SHELL_HOME_URL matches your actual shell filename.
      const FILE_ID = "SHELL8_SYSTEM_HTML";       // KEEP STABLE
      const ROOM_ID = "KDTV1_CINEMA";             // KEEP STABLE
      const VERSION_ID = "SHELL8_WRAP_V1";        // KEEP STABLE (change only for sovereign namespace change)
      const SHELL_HOME_URL = "system.html";       // YOU SAID IT IS system.html

      const STORAGE_KEY = `${FILE_ID}::${ROOM_ID}::${VERSION_ID}`;

      const s8Wrap = document.getElementById("s8Wrap");
      const s8Top = document.getElementById("s8Top");
      const s8Bottom = document.getElementById("s8Bottom");
      const s8Status = document.getElementById("s8Status");

      const s8InvertBtn = document.getElementById("s8InvertBtn");
      const s8NullBtn = document.getElementById("s8NullBtn");
      const s8HomeBtn = document.getElementById("s8HomeBtn");
      const s8LandingBtn = document.getElementById("s8LandingBtn");
      const s8NoteBtn = document.getElementById("s8NoteBtn");
      const s8StateExportBtn = document.getElementById("s8StateExportBtn");
      const s8StateImportBtn = document.getElementById("s8StateImportBtn");
      const s8ControlsBtn = document.getElementById("s8ControlsBtn");
      const s8MultiToggleBtn = document.getElementById("s8MultiToggleBtn");

      const s8Note = document.getElementById("s8Note");
      const s8NoteText = document.getElementById("s8NoteText");
      const s8NoteSaveBtn = document.getElementById("s8NoteSaveBtn");
      const s8NoteCloseBtn = document.getElementById("s8NoteCloseBtn");

      let S8 = {
        light: 0.0,        // 0..1 continuous
        invert: false,
        nullMode: false,
        noteOpen: false,
        ketaNote: "",
      };

      function clamp01(x){ return Math.max(0, Math.min(1, x)); }

      function setStatus(msg){
        s8Status.textContent = String(msg || "READY").toUpperCase();
      }

      function applySystemVisuals(){
        document.documentElement.style.setProperty("--S8_LIGHT", String(S8.light));

        // Invert: simple global invert at root (kept clean)
        document.documentElement.style.filter = S8.invert ? "invert(1) hue-rotate(180deg)" : "none";

        // Null: hide only system + controllers; stage remains
        s8Wrap.classList.toggle("s8Null", !!S8.nullMode);

        // Note
        s8Note.classList.toggle("on", !!S8.noteOpen);
      }

      function saveSystemState(){
        try{
          const payload = {
            meta: {
              FILE_ID, ROOM_ID, VERSION_ID,
              updatedAt: new Date().toISOString(),
              shellHomeUrl: SHELL_HOME_URL
            },
            S8
          };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
          setStatus("SAVED");
        }catch(e){
          setStatus("SAVE_FAIL");
        }
      }

      function loadSystemState(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          if(!raw) return false;
          const obj = JSON.parse(raw);
          if(obj && obj.S8){
            S8 = { ...S8, ...obj.S8 };
            s8NoteText.value = S8.ketaNote || "";
            applySystemVisuals();
            setStatus("LOADED");
            return true;
          }
        }catch(e){}
        return false;
      }

      function exportSystemState(){
        const payload = {
          meta: {
            FILE_ID, ROOM_ID, VERSION_ID,
            exportedAt: new Date().toISOString(),
            shellHomeUrl: SHELL_HOME_URL
          },
          S8,
          KDTV: { hero: state?.hero, filter: state?.filter, multi: state?.multi } // state exists below
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "shell8_system_state.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(a.href);
        setStatus("EXPORTED");
      }

      function importSystemState(){
        const inp = document.createElement("input");
        inp.type = "file";
        inp.accept = "application/json";
        inp.onchange = async ()=>{
          const f = inp.files && inp.files[0];
          if(!f) return;
          try{
            const text = await f.text();
            const obj = JSON.parse(text);

            if(obj && obj.S8){
              S8 = { ...S8, ...obj.S8 };
              s8NoteText.value = S8.ketaNote || "";
              applySystemVisuals();
              saveSystemState();
            }

            // Optional: restore KDTV state if present
            if(obj && obj.KDTV){
              if(obj.KDTV.hero){
                state.hero = { ...state.hero, ...obj.KDTV.hero };
                if(state.hero.mode === "local") state.hero.mode = "yt"; // portable safety
                renderHeroFxUI();
                renderHeroPlayer({autoplay:false});
              }
              if(obj.KDTV.filter){
                state.filter = { ...state.filter, ...obj.KDTV.filter };
                search.value = state.filter.q || "";
                search2.value = state.filter.q || "";
                renderChips();
                renderCards();
              }
              if(obj.KDTV.multi){
                // safe import: strip local urls
                state.multi.cols = Number(obj.KDTV.multi.cols || state.multi.cols);
                state.multi.gap  = Number(obj.KDTV.multi.gap  || state.multi.gap);
                state.multi.minh = Number(obj.KDTV.multi.minh || state.multi.minh);
                state.multi.tiles = Array.isArray(obj.KDTV.multi.tiles) ? obj.KDTV.multi.tiles.map(t=>({
                  ...newTile(),
                  ...t,
                  localUrl: null,
                  mode: (t.mode === "local") ? "yt" : (t.mode || "yt")
                })) : state.multi.tiles;
                applyMultiVars();
                renderMulti();
              }
            }

            setStatus("IMPORTED");
          }catch(e){
            setStatus("IMPORT_FAIL");
            alert("Invalid JSON.");
          }
        };
        inp.click();
      }

      // System UI wiring
      s8InvertBtn.addEventListener("click", ()=>{ S8.invert = !S8.invert; applySystemVisuals(); saveSystemState(); setStatus("INVERT"); });
      s8NullBtn.addEventListener("click", ()=>{ S8.nullMode = !S8.nullMode; applySystemVisuals(); saveSystemState(); setStatus(S8.nullMode ? "NULL" : "LIVE"); });
      s8HomeBtn.addEventListener("click", ()=>{ window.location.href = SHELL_HOME_URL; });
      s8LandingBtn.addEventListener("click", ()=>{ window.location.href = "https://ketadata.com/index11.html"; });
      s8NoteBtn.addEventListener("click", ()=>{ S8.noteOpen = !S8.noteOpen; applySystemVisuals(); setStatus("NOTE"); });
      s8StateExportBtn.addEventListener("click", exportSystemState);
      s8StateImportBtn.addEventListener("click", importSystemState);

      s8NoteSaveBtn.addEventListener("click", ()=>{
        S8.ketaNote = s8NoteText.value || "";
        saveSystemState();
        setStatus("NOTE_SAVED");
      });
      s8NoteCloseBtn.addEventListener("click", ()=>{
        S8.noteOpen = false;
        applySystemVisuals();
        setStatus("NOTE_CLOSED");
      });

      // Lights (1-6): set continuous intensity by dot click
      document.querySelectorAll(".s8LightDot").forEach(dot=>{
        dot.addEventListener("click", ()=>{
          const i = Number(dot.dataset.i || "1");
          const mapping = {1:0.0,2:0.2,3:0.4,4:0.6,5:0.8,6:1.0};
          S8.light = mapping[i] ?? 0.0;
          applySystemVisuals();
          saveSystemState();
          setStatus("LIGHT " + i);
        });
      });

      /************************************************************
       * KDTV CINEMA (ORIGINAL SOURCE) — minimal targeted changes only:
       * - MULTI: always exit (Shift+M toggle + backdrop close)
       * - Immersive controls: autohide on not-hover, force-show via Shift+C
       * - Playlist: paste list -> autoplay queue + Next/Prev hotkeys
       * - BOILER ROOM PRESET: hardcoded archive
       ************************************************************/

      // ---------- Curated collection (add your own later) ----------
      const CURATED = [];

      // ============ DJ PRESETS (PERMANENT COLLECTIONS) ============
      const DJ_PRESETS = {
        boilerRoom: {
          name: "BOILER ROOM ARCHIVE",
          ids: ["A59i7lby9KY","PvAk70mLsqo","4JvB-kAXyCE","Fc2_G75VRZk","0wwilrU6jgY","5bgV6B7Tctk","J8cxJborIWw","us5hnp-kAvc","0Aj6AYO3cnc","j8SJ2w5m9oY","tGbQmyYht3w","Mn9MdC_mIAc","qwdNNF63m14","2i7FaJJjB34","JlczNryXSvQ","LdWXCNO5lw4","mjC9Aa8uG8g","B7TIWlLrU6M","bJZcslLbmOI","GaoVTatNllI","GJq3wCcrV8U","sG1cwdu0IFc","-aO4zCYVqEo","UyqBSncE7LQ","TlqineUUptE","nfjVAeXzAX4","clDFZBL0KFc","OemRJZdx1LU","bj2xzFkNJBs","IaMrQXjOYwM","75mxRg7ucx4","1E3WsoHSxNM","PAEwXkzVyEw","2fXLW1i0iAg","oK9nX___MF4","Lv5i_yvwjAY","OLnPQPcX4u0","a5djI8LG7tU","IRXrVm9_VxQ","oTNW_sKfKuA","uCfpdJNReRI","XktGUY-02Nc","UWLL18GIHDY","_EQh4gh_SzU","30JJXb1NjQY","GYEcEGThh-M","D-7Dftqi0Qs","gjcOv3NzU0k","WO9pQ5NUtVQ","_09ElLgy0vg","CjLS_pEqIQY","Y1Bl_FZLI48","23Oh1LHavuE","thHcs7wUwX0","UrFcNqOj-_o","ykKJwhO8ff4","Y89VtVlcpfc","0Ahjqyo876s","G2eGt0lrt5U","Fi6mrGwy0yM","UmBQhWnJ7U8","4NSB7_oCBJQ","A5vk3Sth7ro","BnkqvBn4OiE","B1EybwYJwS8","DU7ACo0S-wo","a4beS2iGv_E","aKj_gfNdRr4","3jIVX95zSWM","3CyyXig4sHY","WZKbGyt4u8Q","DaQyZdTDKQY","f4E-K1o7BbQ","80y-nrLm9rc","vDoSZv6S5Kc","uaoJcVhHktQ","Aw24W7gJJxU","LZzxq4hLFhU","NJkSqIZyPFE","6ev4QI50ZdA","9WLuSIIh9KQ","71ZxUb4Z_-c","EyGOE74kn2E","3fqz-7T6Y6w","UkOloGmRxaY","JUDUC87VuPU","FZACY7FXsKU","rAOHJqJMYDA","jQgsMTJ8X4Q","1-kTOeW3VEI","ZIl27YEX3a0","sDnmfHjqasM","Df_r5mM9CrM","x9RMejdaggM","DKOAAZtOFBs","n7DXfW2JOT4","y04fy7TY2Lg","Qh8QJomu8OM","4GWMzJykhMc","q-4CuFRNvDs","Zl_D4VpHNVU","kY8uRBzEYUc","EsMyuMY76VE","yX1Li0D_tuE","ArlPDAaECf8","r_niEkkh30E","NIxfWamKgMg","afN88bzUBko","8oqubbsZqY4","J4YkvpKZfxk","dlgie10GE2U","NsR7kVgxFLs","WVgGKyG3T-4","fLYSOBmJROU","G5SaBJxYHE0","M4YS9hZmd6I","jqb6_c0rIfU","-jHqkFTgn90","WD4bU1JoXx8","v639h4JfPec","t2QsXfE881E","rEw2EtRfBsI","cC3SC28AAM8","zMej8UCUdww","IJEtpROQ68I","MIZyoer9jwM","VDDMTMrFjr8","fiE5cTK1xXQ","uxRb4f65HOk","dECFo2-_l48","8CpMsz_Q9bE","pz8TaoyQrVI","M6GVfDhduMI","sV617yhtX1Q","vrd3cLbAn_w","he_SyzGUCK8","eUQqKajqUhE","L76oVDG-zqo","ljoFVOgHS0o","NZW3_XQCxv4","aWSmDZISlMM","FABtQ9qqJMQ","QbB98nwx5Ro","d07JOHK14A0","G7YqkLKVszk","Dhzp6esYfeY","qovTvJF4bI4","X0JTqmcZcHg","8EERCWrOzI4","_3JHt5Fvqbs","DuIEhfVVqaU","nBCirpAIK5Y","hkd1AqdIIrU","tWIWlaCawwM","jGPGMi-3DdA","ZhBizOLPRT8","WVS2AN7QcNc","aKC-5yiB7x0","0KYBYIbMbhU","bLVpVprpAcc","Urlzqo94Aro","qcgIV-GV2II","ZvbYNWAJt-A","DWEoS7fTn2Q","9QASL0SjNGQ","s3rjrd6jOrk","Dh-U43LjnOA","BB-iQY8K0fQ","vvOn3Whk6Mw","N9PzRKuttHk","AhKBtCkSW4E","owNHtnanXbk","T5KCwVDjUro","sHmCyjgZ1Jo","FvtjyRHN-hk","sRyjDviI3Ig","Msr-L81BF2s","pme0_g_0aPs","KDwNx6f1a3k","YJY04VjHts0","Q9FaUe4b0wI","JN21DtXtsoM","01JfULwkvJE","Yy5B4krLUKU","cp0ALhNGN7M","qVzW8WpOpvw","cOoiwq8NT7M","9bYG3NJWE2g","H8nnJGdMqCw","iWOl80uktE8","zV97rIWPvDw","XRWFyXZNJEY","CGna2sP3fYc","5gijsy-47dA","aTjO0_y-r2w","Z2mxcfnSumI","SVJZb7YYxzQ","E4ZaxXQO5RA","x-hpPYo7tts","Vh__xbU981o","aKpxa98_KGw","wW6c6HCwk3A","aSM_McpmIy4","-JbmJhEY5ps","k37mT1vS2po","V3doDDJTmRM","6b0aha2t_K0","q9ctusNx1Q0","n600QOmq6VA","79Di_xQguSY","_IeVvqgn3BE","i5FWcMSOUao","hq40brcn5QY","GQmLxnJ4Ssw","rR4i4vX_dpo","_gvJxc6dY8g","kx8Ahh44Mjs","Rccnaasy6I0","I8EBT1O4Cxc","QA0dcTPKq3g","xKaOJrI7YsM","pRPlk1K4dR0","tjorBk9MTs8","TXFggcNJzMs","zyWtfUrQKSw","l3dy_6e-fSs","_cePad5h_a0","u0wNgryx0PU","5NuRC714fv8","K0BsVqZf85U","lFMfbUZgWRU","9VrgUFZ-ChE","Vcw-J3Thiwk","zf4zYD3wtSk","rzJwpJ_eqkU","VTxJeQ_PEKs","6s3VVTB6jPE","yozpFmqagpA","g4X86niK7Zc","PRrp53xz1UI","geCF_s94s1Y","FWkrxfjzylo","vN1zGIHko9g","HutAae6vSGg","5l3lrZPAjgA","vzwYAsClZTY","827VYu9C_gs","aFgCYBgDq60","By9BV6QdB0k","q_FFGmE3QSg","v1lORLDt9pg","fZAEJ-jqvHc","YXcGHc_hiNc","O802Ux0yncg","YNPGycZY8TI","RqP0KFtr_0I","dZRXSapkXRQ","6-idZO2HdXQ","SzUQoQokppk","aYxc2PpMRVU","257wOj5Eh5o","CnYSCQU9GJA","odRsmrpFaz8","ZGc1yOQmHGw","5275fFtf_Bk","OiHqkzfXbI8","b5hOSJjPyYQ","OybACU5Fyew","JE9YlpGg6zE","615x47JgRnA","WTCOM0xHAm0","hfD34iyd33U","30rUWMngBr8","Fn8zVfYdJEU","Num2jhJnfGU","YTUAoa_e8js","WEt2N1PwUpE","KfNo3TSBvbo","O6hzjGiVROM","3yVBnLkKQvk","mQ5wP0YazOE","1l89EbTmkb4","oofdTRkuc-o","febW8nY4M_Y","9TqPdp-DlNs","_UiUmmNVWTE","xzj6ehxAsOA","qlHYj3ZOQ2I","zRnF6mQiie0","6TS1-pcdGZE","VvGVeH9EOEo","8iBDjxcbuXA","saT1UEtL8Pg","LYp-ctf_Cbw","74f9abZOUMU","01jMuOjNOag","cSnQSjmty8w","AYmtcd9IPSE","ISlSmlBniFg","V3tOWXzPmGU","Z6y5Zp0_hqk","pZ3uRt69uW8","mahb4eDyWUQ","ILafejrGP7U","Kq1tGRpx3Rc","8R-ax3w_Xfs","LuRUWXit29A","EOIF7j-rgJs","T1tcUfUhR5U","d-3CSL6DAHI","KFmsmhNNiyY","Fa8LQLy4C5A","c0KPm41OlQM","it0w2zniMOI","rqS6MU-_LOY","yeN7x0pvAqg","TZ8yVWkSeug","rJ1A1Y5MN4U","-w3xYI64LSo","j0ioMWSjVbE","Htj7hZ_NhxU","451uZ7DTGbI","-rJSU6KdmvU","s1_SAgO92L0","T7RYWAs7MWE","PuOZ7QjFytw","NCr9qlUsLAU","5nnVauFwD5k","MzXKJr79Wsw","4pYm-GhD49A","uQMthOH6k1I","qsWmPVU3d60","9Nk9Of8XGtg","LkDdLloDJxs","03lATP61sm4","5DmCnR7r8B0","SXvZYpbpoDY","kwJLkkzsHNU","Oof6kecGpd8","qvBqyKrKm0Q","l3lNYD9J7V8","5ulz7xMQSnw","AxsojYUFLjo","GgTRkywB3NY","goqOn8bafYY","pquRDrFAUSI","KA_xY8GA1-k","QxHCq0M1OSs","9bfee3Cm0iM","siANMB82E_U","H-k_OMfzCtk","QAvo3M7glBk","k92TEzPAwuM","jO4TuseZ7q4","RLDN4UvmZR8","T3o__B1sWXE","bRH1iHOs6ew","q0lgRJQHHJA","kFAIBFWmfp4","scLwiA1lKp0","F6zNJbZzuO0","RagSkoBronc","-rEfUwsBKFI","cO3KXZNg87s","OxEI-JcQu8k","7UQk9CluxrU","2Tanj42oBXw","mfI5HHdc1ig","D_flQsBigEA","lVMsguwPvU4","6zPr1rk0Ans","TlKUoFWdEKc","cx3NMEBGXOw","QHKQz76fvrU","4Nz272hNPNk","2MWioZLsY0M","zBJ_PCFXyF0","7r_Uc9Ek4s4","1MCU6TjJ7Ys","GoEYxQadWfY","A__cs_n7rAw","uCZ-5pJP2Js","-FXjTeq_2iA","eWy2v84QEkg"]
        }
      };

      // ---------- State ----------
      const state = {
        // hero
        hero: {
          mode: "yt",     // "yt" | "local"
          ytId: DJ_PRESETS.boilerRoom.ids[0],
          localUrl: null,
          title: "BOILER ROOM ARCHIVE",
          // effects
          fx: defaultFx(),
        },
        // collection filters
        filter: {
          q: "",
          category: "All",
          tag: "All",
        },
        // multi
        multi: {
          cols: 3,
          gap: 10,
          minh: 220,
          tiles: []
        },
        // playlist
        playlist: {
          items: [],     // array of ytIds
          idx: 0,
          active: false
        }
      };

      // ---------- DOM ----------
      const hero = document.getElementById('hero');
      const sticky = document.getElementById('sticky');
      const toTop = document.getElementById('toTop');

      const playerShell = document.getElementById('playerShell');
      const playerMedia = document.getElementById('playerMedia');
      const ytInput = document.getElementById('ytInput');
      const fileInput = document.getElementById('fileInput');
      const loadBtn = document.getElementById('loadBtn');
      const modePill = document.getElementById('modePill');

      const boilerRoomBtn = document.getElementById('boilerRoomBtn');
      const playlistBtn = document.getElementById('playlistBtn');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');

      const effectsBtn = document.getElementById('effectsBtn');
      const heroDrawer = document.getElementById('heroDrawer');
      const heroDrawerBody = document.getElementById('heroDrawerBody');
      const drawerToggle = document.getElementById('drawerToggle');

      const search = document.getElementById('search');
      const search2 = document.getElementById('search2');
      const categoryRow = document.getElementById('categoryRow');
      const tagRow = document.getElementById('tagRow');
      const cards = document.getElementById('cards');

      const openMulti = document.getElementById('openMulti');
      const openMulti2 = document.getElementById('openMulti2');
      const multi = document.getElementById('multi');
      const closeMulti = document.getElementById('closeMulti');
      const survGrid = document.getElementById('survGrid');

      const cols = document.getElementById('cols');
      const gap = document.getElementById('gap');
      const minh = document.getElementById('minh');
      const colsVal = document.getElementById('colsVal');
      const gapVal = document.getElementById('gapVal');
      const minhVal = document.getElementById('minhVal');

      const addTile = document.getElementById('addTile');
      const clearTiles = document.getElementById('clearTiles');

      const exportBtn = document.getElementById('exportBtn');
      const importBtn = document.getElementById('importBtn');
      const exportMulti = document.getElementById('exportMulti');
      const importMulti = document.getElementById('importMulti');

      // ---------- Utilities ----------
      function defaultFx(){
        return {
          brightness: 1.00,
          contrast: 1.00,
          saturate: 1.00,
          hue: 0,
          blur: 0,
          grayscale: 0,
          invert: 0,
          sepia: 0,
        };
      }

      function fxToFilter(fx){
        return [
          `brightness(${fx.brightness})`,
          `contrast(${fx.contrast})`,
          `saturate(${fx.saturate})`,
          `hue-rotate(${fx.hue}deg)`,
          `blur(${fx.blur}px)`,
          `grayscale(${fx.grayscale}%)`,
          `invert(${fx.invert}%)`,
          `sepia(${fx.sepia}%)`,
        ].join(' ');
      }

      function parseYouTubeId(input){
        const s = (input||"").trim();
        if(!s) return null;
        if(/^[a-zA-Z0-9_-]{8,15}$/.test(s) && !s.includes("http")) return s;
        try{
          const u = new URL(s);
          if(u.searchParams.get("v")) return u.searchParams.get("v");
          const parts = u.pathname.split("/").filter(Boolean);
          if(u.hostname.includes("youtu.be") && parts[0]) return parts[0];
          const embedIdx = parts.indexOf("embed");
          if(embedIdx >= 0 && parts[embedIdx+1]) return parts[embedIdx+1];
        }catch(e){
          return null;
        }
        return null;
      }

      function parseYouTubeList(text){
        // split by lines, commas, spaces; keep only valid IDs
        const raw = String(text || "")
          .split(/\n|,|\s+/g)
          .map(x=>x.trim())
          .filter(Boolean);
        const ids = [];
        for(const token of raw){
          const id = parseYouTubeId(token);
          if(id) ids.push(id);
        }
        // dedupe while preserving order
        return [...new Set(ids)];
      }

      function escapeHtml(str){
        return String(str ?? "").replace(/[&<>"']/g, c=>({
          "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
        }[c]));
      }

      function setCSSVar(name, val){
        document.documentElement.style.setProperty(name, val);
      }

      // ---------- Hero Player ----------
      function ytEmbedSrc(id){
        return `https://www.youtube.com/embed/${id}?rel=0&modestbranding=1&controls=1&iv_load_policy=3`;
      }

      function renderHeroPlayer({autoplay=false} = {}){
        playerMedia.innerHTML = "";
        document.documentElement.style.setProperty("--kdfilter", fxToFilter(state.hero.fx));

        if(state.hero.mode === "local" && state.hero.localUrl){
          const v = document.createElement("video");
          v.src = state.hero.localUrl;
          v.controls = true;
          v.playsInline = true;
          v.autoplay = !!autoplay;
          v.loop = false;
          v.preload = "metadata";
          playerMedia.appendChild(v);
          modePill.textContent = "LOCAL MODE";
        }else{
          const id = state.hero.ytId;
          const ifr = document.createElement("iframe");
          const src = ytEmbedSrc(id) + (autoplay ? "&autoplay=1" : "");
          ifr.src = src;
          ifr.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
          ifr.allowFullscreen = true;
          ifr.title = state.hero.title || "KDTV";
          playerMedia.appendChild(ifr);
          modePill.textContent = state.playlist.active ? `YT MODE · QUEUE ${state.playlist.idx+1}/${state.playlist.items.length}` : "YT MODE";
        }
      }

      function softFlashRed(){
        const shell = document.getElementById("playerShell");
        shell.animate([
          { boxShadow: "0 30px 120px rgba(0,0,0,.68), 0 0 0 0 rgba(255,42,42,.0)" },
          { boxShadow: "0 30px 120px rgba(0,0,0,.68), 0 0 0 1px rgba(255,42,42,.25)" },
          { boxShadow: "0 30px 120px rgba(0,0,0,.68), 0 0 0 0 rgba(255,42,42,.0)" }
        ], { duration: 520, easing:"ease-out" });
      }

      function loadFromInput(){
        const id = parseYouTubeId(ytInput.value);
        if(!id) return;

        // manual load kills playlist active unless user loads list explicitly
        state.playlist.active = false;
        state.playlist.items = [];
        state.playlist.idx = 0;

        state.hero.mode = "yt";
        state.hero.ytId = id;
        state.hero.localUrl = null;
        state.hero.title = `YT:${id}`;
        renderHeroPlayer({autoplay:true});
        softFlashRed();
      }

      function loadPlaylistPrompt(){
        const text = prompt("PASTE YOUTUBE LINKS/IDS (ANY SEPARATOR). FIRST ITEM WILL AUTOLOAD:", "");
        if(text === null) return;
        const ids = parseYouTubeList(text);
        if(ids.length === 0){
          alert("No valid YouTube IDs found.");
          return;
        }
        state.playlist.items = ids;
        state.playlist.idx = 0;
        state.playlist.active = true;

        state.hero.mode = "yt";
        state.hero.ytId = ids[0];
        state.hero.localUrl = null;
        state.hero.title = `QUEUE:${ids[0]}`;
        renderHeroPlayer({autoplay:true});
        softFlashRed();
      }

      // ============ PRESET LOADER ============
      function loadPreset(presetKey) {
        const preset = DJ_PRESETS[presetKey];
        if (!preset?.ids?.length) {
          alert("Preset empty!");
          return;
        }
        
        state.playlist.items = preset.ids;
        state.playlist.idx = 0;
        state.playlist.active = true;
        
        state.hero.mode = "yt";
        state.hero.ytId = preset.ids[0];
        state.hero.localUrl = null;
        state.hero.title = preset.name;
        
        renderHeroPlayer({autoplay: true});
        softFlashRed();
        setStatus(`▶ ${preset.name} (${preset.ids.length} SETS)`);
      }

      function playlistNext(){
        if(!state.playlist.active || state.playlist.items.length === 0) return;
        state.playlist.idx = (state.playlist.idx + 1) % state.playlist.items.length;
        const id = state.playlist.items[state.playlist.idx];
        state.hero.mode = "yt";
        state.hero.ytId = id;
        state.hero.localUrl = null;
        state.hero.title = `QUEUE:${id}`;
        renderHeroPlayer({autoplay:true});
        softFlashRed();
      }

      function playlistPrev(){
        if(!state.playlist.active || state.playlist.items.length === 0) return;
        state.playlist.idx = (state.playlist.idx - 1 + state.playlist.items.length) % state.playlist.items.length;
        const id = state.playlist.items[state.playlist.idx];
        state.hero.mode = "yt";
        state.hero.ytId = id;
        state.hero.localUrl = null;
        state.hero.title = `QUEUE:${id}`;
        renderHeroPlayer({autoplay:true});
        softFlashRed();
      }

      fileInput.addEventListener("change", ()=>{
        const f = fileInput.files && fileInput.files[0];
        if(!f) return;
        const url = URL.createObjectURL(f);

        // local load disables playlist
        state.playlist.active = false;
        state.playlist.items = [];
        state.playlist.idx = 0;

        state.hero.mode = "local";
        state.hero.localUrl = url;
        state.hero.title = f.name;
        renderHeroPlayer({autoplay:true});
        softFlashRed();
      });

      loadBtn.addEventListener("click", loadFromInput);
      ytInput.addEventListener("keydown", (e)=>{ if(e.key === "Enter") loadFromInput(); });

      boilerRoomBtn.addEventListener("click", () => loadPreset("boilerRoom"));
      playlistBtn.addEventListener("click", loadPlaylistPrompt);
      nextBtn.addEventListener("click", playlistNext);
      prevBtn.addEventListener("click", playlistPrev);

      // ---------- Effects Drawer ----------
      function makeSlider(label, key, min, max, step){
        const row = document.createElement("div");
        row.className = "row";

        const l = document.createElement("span");
        l.textContent = label;

        const r = document.createElement("input");
        r.type = "range";
        r.min = min;
        r.max = max;
        r.step = step;
        r.value = state.hero.fx[key];

        const v = document.createElement("div");
        v.className = "val";
        v.textContent = String(state.hero.fx[key]);

        r.addEventListener("input", ()=>{
          const val = Number(r.value);
          state.hero.fx[key] = val;
          v.textContent = String(val);
          document.documentElement.style.setProperty("--kdfilter", fxToFilter(state.hero.fx));
        });

        row.appendChild(l);
        row.appendChild(r);
        row.appendChild(v);
        return row;
      }

      function renderHeroFxUI(){
        const btns = heroDrawerBody.querySelector(".drawerBtns");
        heroDrawerBody.innerHTML = "";
        heroDrawerBody.appendChild(makeSlider("brightness","brightness",0.60,1.60,0.01));
        heroDrawerBody.appendChild(makeSlider("contrast","contrast",0.60,1.90,0.01));
        heroDrawerBody.appendChild(makeSlider("saturate","saturate",0.00,2.20,0.01));
        heroDrawerBody.appendChild(makeSlider("hue","hue",-180,180,1));
        heroDrawerBody.appendChild(makeSlider("blur","blur",0,8,0.1));
        heroDrawerBody.appendChild(makeSlider("grayscale","grayscale",0,100,1));
        heroDrawerBody.appendChild(makeSlider("invert","invert",0,100,1));
        heroDrawerBody.appendChild(makeSlider("sepia","sepia",0,100,1));
        heroDrawerBody.appendChild(btns);
      }

      function setPreset(name){
        if(name === "clean"){
          state.hero.fx = defaultFx();
        } else if(name === "infra"){
          state.hero.fx = { brightness:1.06, contrast:1.28, saturate:1.45, hue:18, blur:0, grayscale:0, invert:0, sepia:0 };
        } else if(name === "xray"){
          state.hero.fx = { brightness:1.12, contrast:1.55, saturate:0.10, hue:-30, blur:0.2, grayscale:40, invert:18, sepia:0 };
        } else if(name === "surveillance"){
          state.hero.fx = { brightness:0.92, contrast:1.42, saturate:0.70, hue:-10, blur:0, grayscale:22, invert:0, sepia:8 };
        } else if(name === "null"){
          state.hero.fx = { brightness:1.00, contrast:1.00, saturate:0.00, hue:0, blur:0, grayscale:100, invert:0, sepia:0 };
        }
        document.documentElement.style.setProperty("--kdfilter", fxToFilter(state.hero.fx));
        renderHeroFxUI();
      }

      document.getElementById("presetClean").addEventListener("click", ()=>setPreset("clean"));
      document.getElementById("presetInfra").addEventListener("click", ()=>setPreset("infra"));
      document.getElementById("presetXray").addEventListener("click", ()=>setPreset("xray"));
      document.getElementById("presetSurv").addEventListener("click", ()=>setPreset("surveillance"));
      document.getElementById("presetNull").addEventListener("click", ()=>setPreset("null"));

      function toggleDrawer(open){
        if(open === undefined) open = !heroDrawer.classList.contains("open");
        heroDrawer.classList.toggle("open", !!open);
        drawerToggle.textContent = open ? "collapse" : "expand";
      }

      effectsBtn.addEventListener("click", ()=>toggleDrawer(true));
      drawerToggle.addEventListener("click", ()=>toggleDrawer());

      renderHeroFxUI();
      toggleDrawer(false);

      // ---------- Collection ----------
      function unique(arr){ return [...new Set(arr)]; }

      function computeCategories(){
        return ["All", ...unique(CURATED.map(x=>x.category || "Other"))];
      }
      function computeTags(){
        const all = CURATED.flatMap(x=>x.tags || []);
        return ["All", ...unique(all)];
      }

      function renderChips(){
        categoryRow.innerHTML = "";
        tagRow.innerHTML = "";

        const cats = computeCategories();
        cats.forEach(c=>{
          const el = document.createElement("div");
          el.className = "chip" + (state.filter.category === c ? " active" : "");
          el.textContent = c;
          el.addEventListener("click", ()=>{
            state.filter.category = c;
            renderChips();
            renderCards();
          });
          categoryRow.appendChild(el);
        });

        const tags = computeTags();
        tags.forEach(t=>{
          const el = document.createElement("div");
          el.className = "chip" + (state.filter.tag === t ? " active" : "");
          el.textContent = t;
          el.addEventListener("click", ()=>{
            state.filter.tag = t;
            renderChips();
            renderCards();
          });
          tagRow.appendChild(el);
        });
      }

      function matchItem(it){
        const q = (state.filter.q || "").trim().toLowerCase();
        const cat = state.filter.category;
        const tag = state.filter.tag;

        const qOK = !q || (
          (it.title||"").toLowerCase().includes(q) ||
          (it.channel||"").toLowerCase().includes(q) ||
          (it.category||"").toLowerCase().includes(q) ||
          (it.tags||[]).some(t=>String(t).toLowerCase().includes(q))
        );
        const catOK = (cat === "All") || ((it.category||"Other") === cat);
        const tagOK = (tag === "All") || ((it.tags||[]).includes(tag));

        return qOK && catOK && tagOK;
      }

      function cardThumbUrl(ytId){
        return `https://i.ytimg.com/vi/${ytId}/hqdefault.jpg`;
      }

      function renderCards(){
        const list = CURATED.filter(matchItem);
        cards.innerHTML = "";

        list.forEach(it=>{
          const c = document.createElement("div");
          c.className = "card";
          c.innerHTML = `
            <div class="cardTop">
              <div class="thumb">
                <img alt="" src="${cardThumbUrl(it.yt)}" />
                <div class="ytData">YT DATA<br>${escapeHtml(it.dur || "—")}</div>
              </div>
              <div class="meta">
                <div class="t">${escapeHtml(it.title)}</div>
                <div class="s">${escapeHtml(it.channel || "—")} · ${escapeHtml(it.category || "Other")}</div>
                <div class="tags">${(it.tags||[]).slice(0,5).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join("")}</div>
              </div>
            </div>
          `;
          c.addEventListener("click", ()=>{
            playerMedia.classList.remove("fadeIn");
            playerMedia.classList.add("fadeOut");
            setTimeout(()=>{
              state.playlist.active = false;
              state.playlist.items = [];
              state.playlist.idx = 0;

              state.hero.mode = "yt";
              state.hero.ytId = it.yt;
              state.hero.localUrl = null;
              state.hero.title = it.title;
              renderHeroPlayer({autoplay:true});
              softFlashRed();
              playerMedia.classList.remove("fadeOut");
              playerMedia.classList.add("fadeIn");
              window.scrollTo({ top: 0, behavior: "smooth" });
            }, 220);
          });
          cards.appendChild(c);
        });
      }

      search.addEventListener("input", ()=>{
        state.filter.q = search.value;
        renderCards();
        if(search2.value !== search.value) search2.value = search.value;
      });
      search2.addEventListener("input", ()=>{
        state.filter.q = search2.value;
        renderCards();
        if(search.value !== search2.value) search.value = search2.value;
      });

      // ---------- Sticky bar behavior ----------
      const obs = new IntersectionObserver((entries)=>{
        const heroVisible = entries[0].isIntersecting;
        sticky.classList.toggle("on", !heroVisible);
      }, { threshold: 0.18 });
      obs.observe(hero);

      toTop.addEventListener("click", ()=>{ window.scrollTo({ top: 0, behavior:"smooth" }); });

      // ---------- MULTI MODE (intuitive exit/return) ----------
      function openMultiMode(){
        multi.classList.add("on");
        multi.setAttribute("aria-hidden","false");
        applyMultiVars();
        renderMulti();
        setStatus("MULTI");
      }
      function closeMultiMode(){
        multi.classList.remove("on");
        multi.setAttribute("aria-hidden","true");
        setStatus("IMMERSIVE");
      }
      function toggleMultiMode(){
        if(multi.classList.contains("on")) closeMultiMode();
        else openMultiMode();
      }

      openMulti.addEventListener("click", openMultiMode);
      openMulti2.addEventListener("click", openMultiMode);
      closeMulti.addEventListener("click", closeMultiMode);

      // click backdrop outside multiTop/multiStage closes (optional, intuitive)
      multi.addEventListener("mousedown", (e)=>{
        if(e.target === multi) closeMultiMode();
      });

      // ---------- Multi vars ----------
      function applyMultiVars(){
        setCSSVar("--gridCols", state.multi.cols);
        setCSSVar("--gridGap", state.multi.gap + "px");
        setCSSVar("--tileMinH", state.multi.minh + "px");
        cols.value = state.multi.cols;
        gap.value = state.multi.gap;
        minh.value = state.multi.minh;
        colsVal.textContent = String(state.multi.cols);
        gapVal.textContent = String(state.multi.gap);
        minhVal.textContent = String(state.multi.minh);
      }

      cols.addEventListener("input", ()=>{
        state.multi.cols = Number(cols.value);
        colsVal.textContent = String(state.multi.cols);
        applyMultiVars();
      });
      gap.addEventListener("input", ()=>{
        state.multi.gap = Number(gap.value);
        gapVal.textContent = String(state.multi.gap);
        applyMultiVars();
      });
      minh.addEventListener("input", ()=>{
        state.multi.minh = Number(minh.value);
        minhVal.textContent = String(state.multi.minh);
        applyMultiVars();
      });

      function newTile(){
        const brIds = DJ_PRESETS.boilerRoom.ids;
        return {
          id: "t_" + Math.random().toString(16).slice(2),
          mode: "yt",
          ytId: brIds[Math.floor(Math.random() * brIds.length)],
          localUrl: null,
          title: "module",
          fx: defaultFx(),
          drawerOpen: false
        };
      }

      addTile.addEventListener("click", ()=>{
        state.multi.tiles.push(newTile());
        renderMulti();
      });

      clearTiles.addEventListener("click", ()=>{
        state.multi.tiles = [];
        renderMulti();
      });

      function renderMulti(){
        survGrid.innerHTML = "";

        if(state.multi.tiles.length === 0){
          state.multi.tiles = [newTile(), newTile(), newTile()];
        }

        state.multi.tiles.forEach((t, idx)=>{
          const tile = document.createElement("div");
          tile.className = "tile";
          tile.style.setProperty("--tilefilter", fxToFilter(t.fx));
          tile.dataset.id = t.id;

          const title = (t.title && t.title !== "module") ? t.title : `module ${idx+1}`;
          tile.innerHTML = `
            <div class="tileMedia"></div>

            <div class="tileHud">
              <div class="mini">${escapeHtml(title)}</div>
              <div class="mini red">YT DATA</div>
            </div>

            <div class="drawer ${t.drawerOpen ? "open" : ""}">
              <div class="drawerHead">
                <div class="label">effects</div>
                <div style="display:flex; gap:10px; align-items:center;">
                  <button class="btn" data-act="load">load</button>
                  <button class="btn" data-act="toggle">${t.drawerOpen ? "collapse" : "expand"}</button>
                  <button class="btn" data-act="remove">remove</button>
                </div>
              </div>
              <div class="drawerBody" data-body></div>
            </div>
          `;

          const mediaHost = tile.querySelector(".tileMedia");

          if(t.mode === "local" && t.localUrl){
            const v = document.createElement("video");
            v.src = t.localUrl;
            v.controls = true;
            v.playsInline = true;
            v.preload = "metadata";
            mediaHost.appendChild(v);
          } else {
            const ifr = document.createElement("iframe");
            ifr.src = ytEmbedSrc(t.ytId);
            ifr.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
            ifr.allowFullscreen = true;
            ifr.title = title;
            mediaHost.appendChild(ifr);
          }

          const body = tile.querySelector("[data-body]");
          body.appendChild(tileSlider(t, "brightness","brightness",0.60,1.60,0.01, tile));
          body.appendChild(tileSlider(t, "contrast","contrast",0.60,1.90,0.01, tile));
          body.appendChild(tileSlider(t, "saturate","saturate",0.00,2.20,0.01, tile));
          body.appendChild(tileSlider(t, "hue","hue",-180,180,1, tile));
          body.appendChild(tileSlider(t, "blur","blur",0,8,0.1, tile));
          body.appendChild(tileSlider(t, "grayscale","grayscale",0,100,1, tile));
          body.appendChild(tileSlider(t, "invert","invert",0,100,1, tile));
          body.appendChild(tileSlider(t, "sepia","sepia",0,100,1, tile));

          const presetWrap = document.createElement("div");
          presetWrap.className = "drawerBtns";
          presetWrap.innerHTML = `
            <button class="btn" data-pre="clean">clean</button>
            <button class="btn" data-pre="infra">infra</button>
            <button class="btn" data-pre="xray">x-ray</button>
            <button class="btn" data-pre="surv">surveillance</button>
            <button class="btn" data-pre="null">null</button>
          `;
          body.appendChild(presetWrap);

          presetWrap.querySelectorAll("[data-pre]").forEach(b=>{
            b.addEventListener("click", ()=>{
              const p = b.dataset.pre;
              if(p === "clean") t.fx = defaultFx();
              if(p === "infra") t.fx = { brightness:1.06, contrast:1.28, saturate:1.45, hue:18, blur:0, grayscale:0, invert:0, sepia:0 };
              if(p === "xray") t.fx = { brightness:1.12, contrast:1.55, saturate:0.10, hue:-30, blur:0.2, grayscale:40, invert:18, sepia:0 };
              if(p === "surv") t.fx = { brightness:0.92, contrast:1.42, saturate:0.70, hue:-10, blur:0, grayscale:22, invert:0, sepia:8 };
              if(p === "null") t.fx = { brightness:1.00, contrast:1.00, saturate:0.00, hue:0, blur:0, grayscale:100, invert:0, sepia:0 };
              tile.style.setProperty("--tilefilter", fxToFilter(t.fx));
              renderMulti();
            });
          });

          tile.querySelectorAll("[data-act]").forEach(btn=>{
            btn.addEventListener("click", async ()=>{
              const act = btn.dataset.act;

              if(act === "toggle"){
                t.drawerOpen = !t.drawerOpen;
                renderMulti();
              }

              if(act === "remove"){
                state.multi.tiles = state.multi.tiles.filter(x=>x.id !== t.id);
                renderMulti();
              }

              if(act === "load"){
                const choice = prompt("Paste YouTube URL/ID (leave blank to load local file):", "");
                if(choice && choice.trim()){
                  const id = parseYouTubeId(choice);
                  if(id){
                    t.mode = "yt";
                    t.ytId = id;
                    t.localUrl = null;
                    t.title = `YT:${id}`;
                    renderMulti();
                  }
                } else {
                  const inp = document.createElement("input");
                  inp.type = "file";
                  inp.accept = "video/*,audio/*";
                  inp.onchange = ()=>{
                    const f = inp.files && inp.files[0];
                    if(!f) return;
                    const url = URL.createObjectURL(f);
                    t.mode = "local";
                    t.localUrl = url;
                    t.title = f.name;
                    renderMulti();
                  };
                  inp.click();
                }
              }
            });
          });

          tile.addEventListener("dblclick", ()=>{
            state.hero.fx = { ...t.fx };
            document.documentElement.style.setProperty("--kdfilter", fxToFilter(state.hero.fx));
            renderHeroFxUI();

            state.playlist.active = false;
            state.playlist.items = [];
            state.playlist.idx = 0;

            if(t.mode === "local" && t.localUrl){
              state.hero.mode = "local";
              state.hero.localUrl = t.localUrl;
              state.hero.title = t.title;
            } else {
              state.hero.mode = "yt";
              state.hero.ytId = t.ytId;
              state.hero.localUrl = null;
              state.hero.title = t.title;
            }
            renderHeroPlayer({autoplay:true});
            closeMultiMode();
            softFlashRed();
          });

          survGrid.appendChild(tile);
        });
      }

      function tileSlider(tileState, label, key, min, max, step, tileEl){
        const row = document.createElement("div");
        row.className = "row";

        const l = document.createElement("span");
        l.textContent = label;

        const r = document.createElement("input");
        r.type = "range";
        r.min = min;
        r.max = max;
        r.step = step;
        r.value = tileState.fx[key];

        const v = document.createElement("div");
        v.className = "val";
        v.textContent = String(tileState.fx[key]);

        r.addEventListener("input", ()=>{
          const val = Number(r.value);
          tileState.fx[key] = val;
          v.textContent = String(val);
          tileEl.style.setProperty("--tilefilter", fxToFilter(tileState.fx));
        });

        row.appendChild(l);
        row.appendChild(r);
        row.appendChild(v);
        return row;
      }

      // ---------- Export / Import (original) ----------
      function downloadJSON(obj, filename){
        const blob = new Blob([JSON.stringify(obj, null, 2)], { type:"application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(a.href);
      }

      function pickJSONFile(onLoad){
        const inp = document.createElement("input");
        inp.type = "file";
        inp.accept = "application/json";
        inp.onchange = async ()=>{
          const f = inp.files && inp.files[0];
          if(!f) return;
          const text = await f.text();
          try{
            const obj = JSON.parse(text);
            onLoad(obj);
          }catch(e){
            alert("Invalid JSON.");
          }
        };
        inp.click();
      }

      exportBtn.addEventListener("click", ()=>{
        downloadJSON({ hero: state.hero, filter: state.filter, playlist: state.playlist }, "kdtv_cinema_state.json");
      });

      importBtn.addEventListener("click", ()=>{
        pickJSONFile((obj)=>{
          if(obj.hero){
            state.hero = { ...state.hero, ...obj.hero };
            if(state.hero.mode === "local") state.hero.mode = "yt";
            renderHeroFxUI();
            renderHeroPlayer({autoplay:false});
          }
          if(obj.filter){
            state.filter = { ...state.filter, ...obj.filter };
            search.value = state.filter.q || "";
            search2.value = state.filter.q || "";
            renderChips();
            renderCards();
          }
          if(obj.playlist){
            state.playlist = { ...state.playlist, ...obj.playlist };
          }
        });
      });

      exportMulti.addEventListener("click", ()=>{
        const safeTiles = state.multi.tiles.map(t=>({
          ...t,
          localUrl: null,
          mode: t.mode === "local" ? "yt" : t.mode
        }));
        downloadJSON({ multi: { ...state.multi, tiles: safeTiles } }, "kdtv_multi_state.json");
      });

      importMulti.addEventListener("click", ()=>{
        pickJSONFile((obj)=>{
          if(obj.multi){
            state.multi.cols = Number(obj.multi.cols || state.multi.cols);
            state.multi.gap  = Number(obj.multi.gap  || state.multi.gap);
            state.multi.minh = Number(obj.multi.minh || state.multi.minh);
            state.multi.tiles = Array.isArray(obj.multi.tiles) ? obj.multi.tiles.map(t=>({
              ...newTile(),
              ...t,
              localUrl: null,
              mode: (t.mode === "local") ? "yt" : (t.mode || "yt")
            })) : state.multi.tiles;

            applyMultiVars();
            renderMulti();
          }
        });
      });

      // ---------- Shell8 control: immersive controls visibility (Shift+C) ----------
      function toggleImmersiveControls(force){
        if(force === undefined){
          playerShell.classList.toggle("kdtvControlsForceShow");
        }else{
          playerShell.classList.toggle("kdtvControlsForceShow", !!force);
        }
      }
      s8ControlsBtn.addEventListener("click", ()=>toggleImmersiveControls());

      // ---------- Shell8 multi toggle button (top-level) ----------
      s8MultiToggleBtn.addEventListener("click", toggleMultiMode);

      // ---------- Global hotkeys (system universal) ----------
      window.addEventListener("keydown", (e)=>{
        // allow typing in inputs
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
        const isTyping = (tag === "input" || tag === "textarea");
        if(isTyping) return;

        // Esc: always closes multi; also clears null if you want (kept conservative)
        if(e.key === "Escape"){
          if(multi.classList.contains("on")) { closeMultiMode(); e.preventDefault(); return; }
          return;
        }

        // 1-6 lights
        if(!e.shiftKey && /^[1-6]$/.test(e.key)){
          const n = Number(e.key);
          const mapping = {1:0.0,2:0.2,3:0.4,4:0.6,5:0.8,6:1.0};
          S8.light = mapping[n] ?? 0.0;
          applySystemVisuals();
          saveSystemState();
          setStatus("LIGHT " + n);
          e.preventDefault();
          return;
        }

        if(e.shiftKey){
          const k = e.key.toLowerCase();

          if(k === "i"){ S8.invert = !S8.invert; applySystemVisuals(); saveSystemState(); setStatus("INVERT"); e.preventDefault(); return; }
          if(k === "n"){ S8.nullMode = !S8.nullMode; applySystemVisuals(); saveSystemState(); setStatus(S8.nullMode ? "NULL" : "LIVE"); e.preventDefault(); return; }
          if(k === "o"){ S8.noteOpen = !S8.noteOpen; applySystemVisuals(); setStatus("NOTE"); e.preventDefault(); return; }
          if(k === "b"){ window.location.href = SHELL_HOME_URL; e.preventDefault(); return; }
          if(k === "k"){ window.location.href = "https://ketadata.com/index11.html"; e.preventDefault(); return; }
          if(k === "c"){ toggleImmersiveControls(); setStatus("CONTROLS"); e.preventDefault(); return; }
          if(k === "m"){ toggleMultiMode(); e.preventDefault(); return; }
          if(k === "p"){ loadPlaylistPrompt(); e.preventDefault(); return; }

          // playlist next/prev
          if(e.key === "ArrowRight"){ playlistNext(); e.preventDefault(); return; }
          if(e.key === "ArrowLeft"){ playlistPrev(); e.preventDefault(); return; }
        }
      });

      // ---------- Init ----------
      function init(){
        // attempt load system state
        loadSystemState();
        applySystemVisuals();

        // AUTOLOAD BOILER ROOM ARCHIVE
        state.playlist.items = DJ_PRESETS.boilerRoom.ids;
        state.playlist.idx = 0;
        state.playlist.active = true;

        // hero default
        renderHeroPlayer({autoplay:false});

        // collection
        renderChips();
        renderCards();

        // multi defaults
        applyMultiVars();

        setStatus("BOILER ROOM LOADED");
      }
      init();
    </script>

    <!-- ===========================================================
      AE/WB/EE SERIALIZATION STAMP (MANDATORY)
      AE: Aesthetic | EE: Engine | WB: Wiring Bridge
      FILE_ID / ROOM_ID / VERSION_ID govern sovereign storage namespace.
    ============================================================ -->
    <!--
      AE::FILE_ID=SHELL8_SYSTEM_HTML
      EE::ROOM_ID=KDTV1_CINEMA
      WB::VERSION_ID=SHELL8_WRAP_V1
      WB::SHELL_HOME_URL=system.html
      WB::UPDATED_AT=2026-01-03T00:00:00.000Z
      WB::CHANGELOG=
      - WRAP KDTV CINEMA INTO SHELL8 SYSTEM BARS + KETA_NOTE + SYSTEM STATE IO
      - NULL HIDES ONLY SYSTEM + CONTROLLERS; STAGE PERSISTS
      - MULTI TOGGLE FIX: SHIFT+M + BACKDROP CLOSE + ESC ALWAYS EXITS
      - IMMERSIVE CONTROLS AUTOHIDE (HOVER) + SHIFT+C FORCE SHOW
      - PLAYLIST QUEUE: SHIFT+P PASTE LIST; NEXT/PREV + HOTKEYS
      - BOILER ROOM PRESET: 400+ DJ SETS HARDCODED (⚡ BR BUTTON)
    -->
  </div>
</body>
</html>
