<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KETADATA // LINK SORT</title>
  <style>
    :root { color-scheme: dark; }
    html, body { margin:0; background:#000; color:#fff; font:12px/1.35 Arial, Helvetica, sans-serif; }
    * { box-sizing: border-box; }

    /* Layout */
    .topbar{
      position:fixed; top:0; left:0; right:0;
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      padding:10px 12px;
      background:#000;
      border-bottom:1px solid rgba(255,255,255,.16);
      z-index:50;
    }
    .topbar .title{ font-weight:700; letter-spacing:.14em; }
    .topbar .meta{ opacity:.65; letter-spacing:.06em; }
    .topbar .sp{ flex:1; }

    .btn{
      background:transparent; color:#fff;
      border:1px solid rgba(255,255,255,.22);
      padding:6px 8px;
      letter-spacing:.08em;
      cursor:pointer;
    }
    .btn:hover{ border-color:rgba(255,255,255,.5); }
    .btn.danger{ border-color: rgba(255,255,255,.22); opacity:.85; }
    .btn.danger:hover{ border-color: rgba(255,255,255,.5); opacity:1; }

    .inp, .sel, .ta{
      background:#000; color:#fff;
      border:1px solid rgba(255,255,255,.22);
      padding:6px 8px;
      outline:none;
      width:100%;
    }
    .inp:focus, .sel:focus, .ta:focus{ border-color: rgba(255,255,255,.55); }
    .ta{ min-height:74px; resize:vertical; }
    .ta.small{ min-height:54px; }

    .main{
      padding-top:56px;
      display:grid;
      grid-template-columns: 360px 1fr;
      min-height:100vh;
    }
    @media (max-width: 980px){
      .main{ grid-template-columns: 1fr; }
      .left{ border-right:none; border-bottom:1px solid rgba(255,255,255,.16); }
    }

    .left, .right{
      padding:12px;
    }
    .left{
      border-right:1px solid rgba(255,255,255,.16);
    }

    /* Sections */
    .sec{
      border:1px solid rgba(255,255,255,.16);
      padding:10px;
      margin-bottom:10px;
    }
    .secHd{
      display:flex; align-items:baseline; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .secHd .h{ font-weight:700; letter-spacing:.14em; }
    .secHd .sub{ opacity:.65; letter-spacing:.06em; }
    .row{ display:flex; gap:8px; }
    .row > *{ flex:1; }

    /* Cluster cards */
    .clusters{
      display:flex; flex-direction:column; gap:10px;
    }
    .cluster{
      border:1px solid rgba(255,255,255,.16);
      padding:10px;
      background:#000;
    }
    .cluster.depr{ opacity:.55; }
    .clTop{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
      margin-bottom:8px;
    }
    .drag{
      border:1px solid rgba(255,255,255,.16);
      padding:4px 6px;
      letter-spacing:.12em;
      cursor:grab;
      user-select:none;
      opacity:.8;
    }
    .drag:active{ cursor:grabbing; }
    .clName{
      font-weight:700;
      letter-spacing:.12em;
      flex:1;
      min-width:120px;
      border:none;
      border-bottom:1px solid rgba(255,255,255,.16);
      padding:4px 2px;
      background:transparent;
      color:#fff;
      outline:none;
    }
    .clName:focus{ border-bottom-color:rgba(255,255,255,.55); }
    .pill{
      border:1px solid rgba(255,255,255,.16);
      padding:4px 6px;
      letter-spacing:.08em;
      opacity:.8;
    }

    .clActions{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    .mini{
      background:transparent; color:#fff;
      border:1px solid rgba(255,255,255,.16);
      padding:4px 6px;
      letter-spacing:.08em;
      cursor:pointer;
      opacity:.85;
    }
    .mini:hover{ border-color:rgba(255,255,255,.5); opacity:1; }

    .clBody{ margin-top:8px; display:block; }
    .clBody.hidden{ display:none; }

    /* Items */
    .items{ display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .item{
      border:1px solid rgba(255,255,255,.12);
      padding:8px;
      background:#000;
    }
    .item.depr{ opacity:.55; }
    .itTop{
      display:grid;
      grid-template-columns: 24px 1fr 110px 110px 90px;
      gap:8px;
      align-items:center;
    }
    @media (max-width: 980px){
      .itTop{ grid-template-columns: 24px 1fr; }
      .itTop .colHide{ display:none; }
    }
    .itDrag{
      border:1px solid rgba(255,255,255,.16);
      padding:4px 0;
      text-align:center;
      letter-spacing:.12em;
      cursor:grab;
      user-select:none;
      opacity:.8;
    }
    .itDrag:active{ cursor:grabbing; }

    .itLink{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      border-bottom:1px solid rgba(255,255,255,.12);
      padding-bottom:6px;
      margin-bottom:6px;
    }
    .itLink a{
      color:#fff;
      text-decoration:none;
      border-bottom:1px solid rgba(255,255,255,.2);
    }
    .itLink a:hover{ border-bottom-color:rgba(255,255,255,.6); }

    .itGrid{
      display:grid;
      grid-template-columns: 1.3fr .7fr .7fr;
      gap:8px;
    }
    @media (max-width: 980px){
      .itGrid{ grid-template-columns: 1fr; }
    }

    /* Prompt export */
    .outBox{
      border:1px solid rgba(255,255,255,.16);
      padding:10px;
      white-space:pre-wrap;
      word-break:break-word;
      min-height:120px;
      max-height:360px;
      overflow:auto;
      background:#000;
      color:#fff;
    }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.78);
      display:none;
      align-items:center;
      justify-content:center;
      padding:12px;
      z-index:100;
    }
    .modal.show{ display:flex; }
    .panel{
      width:min(980px, 100%);
      background:#000;
      border:1px solid rgba(255,255,255,.18);
      padding:12px;
    }
    .panelHd{
      display:flex; align-items:baseline; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .panelHd .h{ font-weight:700; letter-spacing:.14em; }
    .panelHd .sub{ opacity:.65; letter-spacing:.06em; }
    .panelActions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .hr{ border-top:1px solid rgba(255,255,255,.12); margin:10px 0; }
    .hint{ opacity:.65; letter-spacing:.06em; }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="title">KETADATA // LINK SORT</div>
    <div class="meta" id="meta">READY</div>
    <div class="sp"></div>

    <button class="btn" id="btnAddCluster">ADD CLUSTER</button>
    <button class="btn" id="btnExportState">EXPORT STATE</button>
    <button class="btn" id="btnImportState">IMPORT STATE</button>
    <button class="btn" id="btnExportPrompt">PROMPT EXPORT</button>
    <button class="btn danger" id="btnNew">NEW</button>
  </div>

  <div class="main">
    <div class="left">
      <div class="sec">
        <div class="secHd">
          <div class="h">KETA_NOTE</div>
          <div class="sub">OPTIONAL / NON-INTERFERING</div>
        </div>
        <textarea class="ta" id="ketaNote" placeholder="KETA_NOTE (GLOBAL)"></textarea>
      </div>

      <div class="sec">
        <div class="secHd">
          <div class="h">FILTER</div>
          <div class="sub">CLUSTER / TAG / STATUS</div>
        </div>
        <div class="row">
          <select class="sel" id="fltCluster"></select>
          <select class="sel" id="fltStatus">
            <option value="active">ACTIVE ONLY</option>
            <option value="all">ALL</option>
            <option value="deprecated">DEPRECATED ONLY</option>
          </select>
        </div>
        <div style="height:8px"></div>
        <input class="inp" id="fltTag" placeholder="TAG CONTAINS (comma/space ok)" />
        <div style="height:8px"></div>
        <input class="inp" id="fltSearch" placeholder="SEARCH (path / url / note)" />
        <div style="height:8px"></div>
        <button class="btn" id="btnClearFilters" style="width:100%;">CLEAR FILTERS</button>
      </div>

      <div class="sec">
        <div class="secHd">
          <div class="h">STATE</div>
          <div class="sub">LABEL + VERSION</div>
        </div>
        <input class="inp" id="exportLabel" placeholder="EXPORT LABEL (HUMAN)" />
        <div style="height:8px"></div>
        <input class="inp" id="exportTag" placeholder="VERSION TAG (e.g. LINK_SORT_v1)" />
        <div style="height:8px"></div>
        <div class="hint">
          EXPORT STATE = literal UI recreation + link metadata.<br/>
          PROMPT EXPORT = pasteable grouping for other models/workflows.
        </div>
      </div>
    </div>

    <div class="right">
      <div class="sec">
        <div class="secHd">
          <div class="h">CLUSTERS</div>
          <div class="sub" id="counts">0 CLUSTERS / 0 LINKS</div>
        </div>
        <div class="clusters" id="clusters"></div>
      </div>
    </div>
  </div>

  <!-- Export / Import Modal -->
  <div class="modal" id="modal">
    <div class="panel">
      <div class="panelHd">
        <div class="h" id="modalTitle">EXPORT</div>
        <div class="sub" id="modalSub">STATE</div>
        <div style="flex:1"></div>
        <button class="btn" id="modalClose">CLOSE</button>
      </div>

      <div class="hr"></div>

      <textarea class="ta" id="modalText" placeholder="JSON OR PROMPT OUTPUT"></textarea>

      <div class="panelActions">
        <button class="btn" id="modalCopy">COPY</button>
        <button class="btn" id="modalApply">APPLY / IMPORT</button>
      </div>

      <div class="hr"></div>
      <div class="hint" id="modalHint"></div>
    </div>
  </div>

<script>
(() => {
  // -------------------------
  // Data model
  // -------------------------
  const DEFAULT_STATE = () => ({
    version: "KETADATA_LINK_SORT_v1",
    updatedAt: new Date().toISOString(),
    exportLabel: "",
    exportTag: "",
    ketaNote: "",
    ui: {
      filterClusterId: "ALL",
      filterStatus: "active",
      filterTag: "",
      filterSearch: ""
    },
    clusters: []
  });

  const uid = () => Math.random().toString(16).slice(2) + Math.random().toString(16).slice(2);
  const nowISO = () => new Date().toISOString();

  // -------------------------
  // DOM
  // -------------------------
  const $meta = document.getElementById("meta");
  const $counts = document.getElementById("counts");
  const $clusters = document.getElementById("clusters");

  const $ketaNote = document.getElementById("ketaNote");
  const $exportLabel = document.getElementById("exportLabel");
  const $exportTag = document.getElementById("exportTag");

  const $fltCluster = document.getElementById("fltCluster");
  const $fltStatus = document.getElementById("fltStatus");
  const $fltTag = document.getElementById("fltTag");
  const $fltSearch = document.getElementById("fltSearch");

  const $btnAddCluster = document.getElementById("btnAddCluster");
  const $btnExportState = document.getElementById("btnExportState");
  const $btnImportState = document.getElementById("btnImportState");
  const $btnExportPrompt = document.getElementById("btnExportPrompt");
  const $btnNew = document.getElementById("btnNew");
  const $btnClearFilters = document.getElementById("btnClearFilters");

  // Modal
  const $modal = document.getElementById("modal");
  const $modalTitle = document.getElementById("modalTitle");
  const $modalSub = document.getElementById("modalSub");
  const $modalText = document.getElementById("modalText");
  const $modalClose = document.getElementById("modalClose");
  const $modalCopy = document.getElementById("modalCopy");
  const $modalApply = document.getElementById("modalApply");
  const $modalHint = document.getElementById("modalHint");

  let state = loadLocal() || DEFAULT_STATE();
  let modalMode = "export_state"; // export_state | import_state | export_prompt

  // -------------------------
  // Persistence (local)
  // -------------------------
  const LS_KEY = "KETADATA_LINK_SORT_STATE_v1";

  function loadLocal(){
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return null;
      const obj = JSON.parse(raw);
      return normalizeState(obj);
    } catch {
      return null;
    }
  }
  function saveLocal(){
    try { localStorage.setItem(LS_KEY, JSON.stringify(state)); } catch {}
  }

  function normalizeState(s){
    const base = DEFAULT_STATE();
    if (!s || typeof s !== "object") return base;

    const out = {
      ...base,
      version: typeof s.version === "string" ? s.version : base.version,
      updatedAt: typeof s.updatedAt === "string" ? s.updatedAt : nowISO(),
      exportLabel: typeof s.exportLabel === "string" ? s.exportLabel : "",
      exportTag: typeof s.exportTag === "string" ? s.exportTag : "",
      ketaNote: typeof s.ketaNote === "string" ? s.ketaNote : "",
      ui: { ...base.ui, ...(s.ui && typeof s.ui === "object" ? s.ui : {}) },
      clusters: Array.isArray(s.clusters) ? s.clusters.map(normalizeCluster) : []
    };
    return out;
  }

  function normalizeCluster(c){
    const id = (c && typeof c.id === "string") ? c.id : uid();
    return {
      id,
      name: (c && typeof c.name === "string") ? c.name : "CLUSTER",
      deprecated: !!(c && c.deprecated),
      collapsed: !!(c && c.collapsed),
      tags: (c && typeof c.tags === "string") ? c.tags : "",
      note: (c && typeof c.note === "string") ? c.note : "",
      items: Array.isArray(c && c.items) ? c.items.map(normalizeItem) : []
    };
  }

  function normalizeItem(it){
    return {
      id: (it && typeof it.id === "string") ? it.id : uid(),
      path: (it && typeof it.path === "string") ? it.path : "",
      url: (it && typeof it.url === "string") ? it.url : "",
      tags: (it && typeof it.tags === "string") ? it.tags : "",
      version: (it && typeof it.version === "string") ? it.version : "",
      status: (it && typeof it.status === "string") ? it.status : "active", // active|deprecated
      note: (it && typeof it.note === "string") ? it.note : ""
    };
  }

  // -------------------------
  // Filters
  // -------------------------
  function currentFilters(){
    return {
      clusterId: $fltCluster.value || "ALL",
      status: $fltStatus.value || "active",
      tag: ($fltTag.value || "").trim(),
      search: ($fltSearch.value || "").trim().toLowerCase()
    };
  }

  function tagsMatch(tagNeedle, tagsString){
    if (!tagNeedle) return true;
    const need = tagNeedle.toLowerCase().split(/[, ]+/).filter(Boolean);
    const have = (tagsString || "").toLowerCase().split(/[, ]+/).filter(Boolean);
    return need.every(n => have.includes(n));
  }

  function searchMatch(search, fields){
    if (!search) return true;
    const blob = fields.join(" ").toLowerCase();
    return blob.includes(search);
  }

  // -------------------------
  // Rendering
  // -------------------------
  function setMeta(msg){ $meta.textContent = msg; }

  function refreshFilterClusterOptions(){
    const opts = [
      { value:"ALL", label:"ALL CLUSTERS" }
    ].concat(state.clusters.map(c => ({
      value: c.id,
      label: c.name || "CLUSTER"
    })));

    $fltCluster.innerHTML = "";
    for (const o of opts){
      const opt = document.createElement("option");
      opt.value = o.value;
      opt.textContent = o.label;
      $fltCluster.appendChild(opt);
    }
    // restore if possible
    if (state.ui.filterClusterId) $fltCluster.value = state.ui.filterClusterId;
    if (!$fltCluster.value) $fltCluster.value = "ALL";
  }

  function computeCounts(){
    const clustersN = state.clusters.length;
    const linksN = state.clusters.reduce((acc,c) => acc + (c.items?.length || 0), 0);
    $counts.textContent = `${clustersN} CLUSTERS / ${linksN} LINKS`;
  }

  function render(){
    // sync fields
    $ketaNote.value = state.ketaNote || "";
    $exportLabel.value = state.exportLabel || "";
    $exportTag.value = state.exportTag || "";

    // sync filters UI -> state
    const f = currentFilters();
    state.ui.filterClusterId = f.clusterId;
    state.ui.filterStatus = f.status;
    state.ui.filterTag = $fltTag.value || "";
    state.ui.filterSearch = $fltSearch.value || "";

    refreshFilterClusterOptions();
    computeCounts();

    // clusters
    $clusters.innerHTML = "";
    const f2 = currentFilters();

    for (const cl of state.clusters){
      const clEl = document.createElement("div");
      clEl.className = "cluster" + (cl.deprecated ? " depr" : "");
      clEl.dataset.clusterId = cl.id;
      clEl.draggable = true;

      // cluster header
      const top = document.createElement("div");
      top.className = "clTop";

      const drag = document.createElement("div");
      drag.className = "drag";
      drag.textContent = "↕";
      drag.title = "DRAG CLUSTER";
      top.appendChild(drag);

      const name = document.createElement("input");
      name.className = "clName";
      name.value = cl.name || "";
      name.placeholder = "CLUSTER NAME";
      name.addEventListener("input", () => { cl.name = name.value; saveAndSoftRefresh(); });
      top.appendChild(name);

      const pill = document.createElement("div");
      pill.className = "pill";
      pill.textContent = `${(cl.items||[]).length} LINKS`;
      top.appendChild(pill);

      const actions = document.createElement("div");
      actions.className = "clActions";

      const btnCollapse = document.createElement("button");
      btnCollapse.className = "mini";
      btnCollapse.textContent = cl.collapsed ? "EXPAND" : "COLLAPSE";
      btnCollapse.addEventListener("click", () => { cl.collapsed = !cl.collapsed; render(); saveLocal(); });
      actions.appendChild(btnCollapse);

      const btnDep = document.createElement("button");
      btnDep.className = "mini";
      btnDep.textContent = cl.deprecated ? "UNDEPRECATE" : "DEPRECATE";
      btnDep.addEventListener("click", () => { cl.deprecated = !cl.deprecated; render(); saveLocal(); });
      actions.appendChild(btnDep);

      const btnAdd = document.createElement("button");
      btnAdd.className = "mini";
      btnAdd.textContent = "ADD LINK";
      btnAdd.addEventListener("click", () => {
        cl.items.unshift(normalizeItem({ id: uid(), status:"active" }));
        render(); saveLocal(); setMeta("ADDED LINK");
      });
      actions.appendChild(btnAdd);

      const btnDel = document.createElement("button");
      btnDel.className = "mini";
      btnDel.textContent = "DELETE CLUSTER";
      btnDel.addEventListener("click", () => {
        if (!confirm("DELETE CLUSTER?")) return;
        state.clusters = state.clusters.filter(x => x.id !== cl.id);
        render(); saveLocal(); setMeta("CLUSTER DELETED");
      });
      actions.appendChild(btnDel);

      top.appendChild(actions);
      clEl.appendChild(top);

      const body = document.createElement("div");
      body.className = "clBody" + (cl.collapsed ? " hidden" : "");

      // cluster tags + note
      const grid = document.createElement("div");
      grid.className = "itGrid";

      const tags = document.createElement("input");
      tags.className = "inp";
      tags.value = cl.tags || "";
      tags.placeholder = "CLUSTER TAGS (comma/space)";
      tags.addEventListener("input", () => { cl.tags = tags.value; saveAndSoftRefresh(); });
      grid.appendChild(tags);

      const note = document.createElement("textarea");
      note.className = "ta small";
      note.value = cl.note || "";
      note.placeholder = "CLUSTER NOTE";
      note.addEventListener("input", () => { cl.note = note.value; saveAndSoftRefresh(); });
      grid.appendChild(note);

      const pad = document.createElement("div");
      pad.innerHTML = `<div class="hint">TIP: TAGS CAN BE USED AS CROSS-CLUSTER CLUSTERS.</div>`;
      grid.appendChild(pad);

      body.appendChild(grid);

      // items
      const itemsWrap = document.createElement("div");
      itemsWrap.className = "items";
      itemsWrap.dataset.clusterId = cl.id;

      for (const it of (cl.items || [])){
        // filter apply
        const statusOk =
          (f2.status === "all") ||
          (f2.status === "active" && it.status !== "deprecated") ||
          (f2.status === "deprecated" && it.status === "deprecated");

        const clusterOk =
          (f2.clusterId === "ALL") || (f2.clusterId === cl.id);

        const tagOk = tagsMatch(f2.tag, (cl.tags || "") + " " + (it.tags || ""));
        const searchOk = searchMatch(f2.search, [it.path, it.url, it.tags, it.note, cl.name, cl.note, cl.tags]);

        if (!statusOk || !clusterOk || !tagOk || !searchOk) continue;

        const itEl = document.createElement("div");
        itEl.className = "item" + (it.status === "deprecated" ? " depr" : "");
        itEl.dataset.itemId = it.id;
        itEl.draggable = true;

        const itTop = document.createElement("div");
        itTop.className = "itTop";

        const itDrag = document.createElement("div");
        itDrag.className = "itDrag";
        itDrag.textContent = "↕";
        itDrag.title = "DRAG LINK";
        itTop.appendChild(itDrag);

        const itPath = document.createElement("input");
        itPath.className = "inp";
        itPath.value = it.path || "";
        itPath.placeholder = "PATH / NAME (e.g. system.html)";
        itPath.addEventListener("input", () => { it.path = itPath.value; saveAndSoftRefresh(); });
        itTop.appendChild(itPath);

        const itVer = document.createElement("input");
        itVer.className = "inp colHide";
        itVer.value = it.version || "";
        itVer.placeholder = "VERSION";
        itVer.addEventListener("input", () => { it.version = itVer.value; saveAndSoftRefresh(); });
        itTop.appendChild(itVer);

        const itTags = document.createElement("input");
        itTags.className = "inp colHide";
        itTags.value = it.tags || "";
        itTags.placeholder = "TAGS";
        itTags.addEventListener("input", () => { it.tags = itTags.value; saveAndSoftRefresh(); });
        itTop.appendChild(itTags);

        const itStatus = document.createElement("select");
        itStatus.className = "sel colHide";
        itStatus.innerHTML = `
          <option value="active">ACTIVE</option>
          <option value="deprecated">DEPRECATED</option>
        `;
        itStatus.value = it.status || "active";
        itStatus.addEventListener("change", () => { it.status = itStatus.value; render(); saveLocal(); });
        itTop.appendChild(itStatus);

        itEl.appendChild(itTop);

        const itLink = document.createElement("div");
        itLink.className = "itLink";

        const urlInp = document.createElement("input");
        urlInp.className = "inp";
        urlInp.value = it.url || "";
        urlInp.placeholder = "URL (or leave blank)";
        urlInp.addEventListener("input", () => { it.url = urlInp.value; saveAndSoftRefresh(); });
        itLink.appendChild(urlInp);

        const a = document.createElement("a");
        a.href = safeHref(it);
        a.textContent = "OPEN";
        a.target = "_blank";
        a.rel = "noopener";
        a.addEventListener("click", (e) => {
          const href = safeHref(it);
          if (!href) { e.preventDefault(); setMeta("NO URL"); }
        });
        itLink.appendChild(a);

        const btnDelIt = document.createElement("button");
        btnDelIt.className = "mini";
        btnDelIt.textContent = "DELETE";
        btnDelIt.addEventListener("click", () => {
          cl.items = cl.items.filter(x => x.id !== it.id);
          render(); saveLocal(); setMeta("LINK DELETED");
        });
        itLink.appendChild(btnDelIt);

        itEl.appendChild(itLink);

        const itGrid = document.createElement("div");
        itGrid.className = "itGrid";

        const tags2 = document.createElement("input");
        tags2.className = "inp";
        tags2.value = it.tags || "";
        tags2.placeholder = "TAGS (comma/space)";
        tags2.addEventListener("input", () => { it.tags = tags2.value; saveAndSoftRefresh(); });
        itGrid.appendChild(tags2);

        const ver2 = document.createElement("input");
        ver2.className = "inp";
        ver2.value = it.version || "";
        ver2.placeholder = "VERSION (e.g. v3 / shell8 / old)";
        ver2.addEventListener("input", () => { it.version = ver2.value; saveAndSoftRefresh(); });
        itGrid.appendChild(ver2);

        const note2 = document.createElement("textarea");
        note2.className = "ta small";
        note2.value = it.note || "";
        note2.placeholder = "NOTE (PAGE / TODO / WARNING / CONTEXT)";
        note2.addEventListener("input", () => { it.note = note2.value; saveAndSoftRefresh(); });
        itGrid.appendChild(note2);

        itEl.appendChild(itGrid);

        // item drag within cluster
        itEl.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("text/plain", JSON.stringify({ type:"item", clusterId: cl.id, itemId: it.id }));
        });

        itemsWrap.appendChild(itEl);
      }

      // allow drop for item reordering
      itemsWrap.addEventListener("dragover", (e) => e.preventDefault());
      itemsWrap.addEventListener("drop", (e) => {
        e.preventDefault();
        try{
          const payload = JSON.parse(e.dataTransfer.getData("text/plain"));
          if (payload.type !== "item") return;
          if (payload.clusterId !== cl.id) return;

          const draggedId = payload.itemId;
          const target = e.target.closest(".item");
          if (!target) return;

          const targetId = target.dataset.itemId;
          if (!draggedId || !targetId || draggedId === targetId) return;

          const arr = cl.items.slice();
          const from = arr.findIndex(x => x.id === draggedId);
          const to = arr.findIndex(x => x.id === targetId);
          if (from < 0 || to < 0) return;

          const [moved] = arr.splice(from, 1);
          arr.splice(to, 0, moved);
          cl.items = arr;

          render(); saveLocal(); setMeta("LINK MOVED");
        } catch {}
      });

      body.appendChild(itemsWrap);
      clEl.appendChild(body);

      // cluster drag reorder
      clEl.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("text/plain", JSON.stringify({ type:"cluster", clusterId: cl.id }));
      });

      clEl.addEventListener("dragover", (e) => e.preventDefault());
      clEl.addEventListener("drop", (e) => {
        e.preventDefault();
        try{
          const payload = JSON.parse(e.dataTransfer.getData("text/plain"));
          if (payload.type !== "cluster") return;
          const draggedId = payload.clusterId;
          const targetId = cl.id;
          if (!draggedId || !targetId || draggedId === targetId) return;

          const arr = state.clusters.slice();
          const from = arr.findIndex(x => x.id === draggedId);
          const to = arr.findIndex(x => x.id === targetId);
          if (from < 0 || to < 0) return;

          const [moved] = arr.splice(from, 1);
          arr.splice(to, 0, moved);
          state.clusters = arr;

          render(); saveLocal(); setMeta("CLUSTER MOVED");
        } catch {}
      });

      $clusters.appendChild(clEl);
    }

    state.updatedAt = nowISO();
    saveLocal();
  }

  function safeHref(it){
    const u = (it.url || "").trim();
    if (u) return u;

    // If path looks like a Pages path, synthesize
    const p = (it.path || "").trim();
    if (!p) return "";
    // If already absolute, use it.
    if (/^https?:\/\//i.test(p)) return p;

    // Default to GitHub Pages rule (ketadata repo)
    return "https://ki-tya.github.io/ketadata/" + p.replace(/^\/+/, "");
  }

  function saveAndSoftRefresh(){
    state.ketaNote = $ketaNote.value || "";
    state.exportLabel = $exportLabel.value || "";
    state.exportTag = $exportTag.value || "";
    state.updatedAt = nowISO();
    saveLocal();
    setMeta("SAVED");
  }

  // -------------------------
  // Actions
  // -------------------------
  $ketaNote.addEventListener("input", saveAndSoftRefresh);
  $exportLabel.addEventListener("input", saveAndSoftRefresh);
  $exportTag.addEventListener("input", saveAndSoftRefresh);

  $fltCluster.addEventListener("change", () => { render(); });
  $fltStatus.addEventListener("change", () => { render(); });
  $fltTag.addEventListener("input", () => { render(); });
  $fltSearch.addEventListener("input", () => { render(); });

  $btnClearFilters.addEventListener("click", () => {
    state.ui.filterClusterId = "ALL";
    state.ui.filterStatus = "active";
    state.ui.filterTag = "";
    state.ui.filterSearch = "";
    $fltCluster.value = "ALL";
    $fltStatus.value = "active";
    $fltTag.value = "";
    $fltSearch.value = "";
    render();
    setMeta("FILTERS CLEARED");
  });

  $btnAddCluster.addEventListener("click", () => {
    state.clusters.unshift(normalizeCluster({
      id: uid(),
      name: "CLUSTER",
      deprecated: false,
      collapsed: false,
      tags: "",
      note: "",
      items: []
    }));
    render();
    setMeta("ADDED CLUSTER");
  });

  $btnNew.addEventListener("click", () => {
    if (!confirm("RESET TO NEW? (local state will be replaced)")) return;
    state = DEFAULT_STATE();
    render();
    setMeta("NEW");
  });

  $btnExportState.addEventListener("click", () => {
    modalMode = "export_state";
    openModal("EXPORT", "STATE", exportStateJSON(), "COPY JSON OR SAVE IT. IMPORT PASTES JSON BACK IN. (LOCAL AUTOSAVE ALSO ACTIVE)", true);
  });

  $btnImportState.addEventListener("click", () => {
    modalMode = "import_state";
    openModal("IMPORT", "STATE", "", "PASTE JSON STATE THEN APPLY.", true);
  });

  $btnExportPrompt.addEventListener("click", () => {
    modalMode = "export_prompt";
    openModal("EXPORT", "PROMPT", exportPromptText(), "PASTE THIS INTO A MODEL OR WORKFLOW. IT’S GROUPED BY CLUSTER + FLAGS DEPRECATED.", true);
  });

  function exportStateJSON(){
    // "Normal state way": literal UI recreation + metadata. No algorithms.
    const out = normalizeState({
      ...state,
      updatedAt: nowISO(),
      exportLabel: ($exportLabel.value || state.exportLabel || "").trim(),
      exportTag: ($exportTag.value || state.exportTag || "").trim(),
      ketaNote: $ketaNote.value || state.ketaNote || "",
      ui: {
        filterClusterId: $fltCluster.value || "ALL",
        filterStatus: $fltStatus.value || "active",
        filterTag: $fltTag.value || "",
        filterSearch: $fltSearch.value || ""
      }
    });
    return JSON.stringify(out, null, 2);
  }

  function exportPromptText(){
    // "Prompt way": pasteable summary for routing / planning / other models.
    // Includes: cluster name, cluster tags, notes, and each link with flags.
    const lines = [];
    const label = (($exportLabel.value || state.exportLabel || "").trim());
    const tag = (($exportTag.value || state.exportTag || "").trim());
    const stamp = nowISO();

    lines.push(`KETADATA LINK SORT PROMPT`);
    if (label) lines.push(`EXPORT_LABEL: ${label}`);
    if (tag) lines.push(`VERSION_TAG: ${tag}`);
    lines.push(`UPDATED_AT: ${stamp}`);
    lines.push(``);

    const globalNote = ($ketaNote.value || state.ketaNote || "").trim();
    if (globalNote){
      lines.push(`GLOBAL_KETA_NOTE:`);
      lines.push(globalNote);
      lines.push(``);
    }

    for (const cl of state.clusters){
      const clHdr = [];
      clHdr.push(`CLUSTER: ${cl.name || "CLUSTER"}`);
      if (cl.deprecated) clHdr.push(`[CLUSTER_DEPRECATED]`);
      const ct = (cl.tags || "").trim();
      if (ct) clHdr.push(`TAGS: ${ct}`);
      lines.push(clHdr.join("  "));
      const cn = (cl.note || "").trim();
      if (cn){
        lines.push(`CLUSTER_NOTE: ${cn}`);
      }

      // items
      for (const it of (cl.items || [])){
        const flags = [];
        if (it.status === "deprecated") flags.push("DEPRECATED");
        if ((it.version || "").trim()) flags.push(`VER:${(it.version||"").trim()}`);
        const t = (it.tags || "").trim();
        if (t) flags.push(`TAGS:${t}`);

        const url = safeHref(it);
        const path = (it.path || "").trim();

        lines.push(`- ${url}${path ? "  ("+path+")" : ""}${flags.length ? "  ["+flags.join(" | ")+"]" : ""}`);
        const n = (it.note || "").trim();
        if (n) lines.push(`  NOTE: ${n}`);
      }
      lines.push(``);
    }

    lines.push(`INSTRUCTIONS:`);
    lines.push(`- GROUP BY CLUSTER`);
    lines.push(`- PRIORITIZE ACTIVE LINKS`);
    lines.push(`- TREAT DEPRECATED AS HISTORICAL (DO NOT EDIT/TOUCH WITHOUT INTENT)`);
    lines.push(`- USE NOTES AS CONTEXT, NOT TRUTH`);
    return lines.join("\n");
  }

  // Modal helpers
  function openModal(title, sub, text, hint, showApply){
    $modalTitle.textContent = title;
    $modalSub.textContent = sub;
    $modalText.value = text || "";
    $modalHint.textContent = hint || "";
    $modalApply.style.display = showApply ? "inline-block" : "none";
    $modal.classList.add("show");
    $modalText.focus();
  }
  function closeModal(){
    $modal.classList.remove("show");
  }

  $modalClose.addEventListener("click", closeModal);
  $modal.addEventListener("click", (e) => { if (e.target === $modal) closeModal(); });

  $modalCopy.addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText($modalText.value || "");
      setMeta("COPIED");
    } catch {
      setMeta("COPY FAILED");
    }
  });

  $modalApply.addEventListener("click", () => {
    if (modalMode !== "import_state") return closeModal();
    try{
      const obj = JSON.parse($modalText.value || "");
      state = normalizeState(obj);
      // restore filters to UI
      $ketaNote.value = state.ketaNote || "";
      $exportLabel.value = state.exportLabel || "";
      $exportTag.value = state.exportTag || "";
      render();
      setMeta("IMPORTED");
      closeModal();
    } catch (e){
      setMeta("IMPORT FAILED");
      $modalHint.textContent = "INVALID JSON. FIX THEN APPLY.";
    }
  });

  // -------------------------
  // Initialize
  // -------------------------
  function init(){
    // restore filter inputs
    $ketaNote.value = state.ketaNote || "";
    $exportLabel.value = state.exportLabel || "";
    $exportTag.value = state.exportTag || "";
    $fltTag.value = state.ui.filterTag || "";
    $fltSearch.value = state.ui.filterSearch || "";
    $fltStatus.value = state.ui.filterStatus || "active";
    render();
    // ensure cluster filter selection
    refreshFilterClusterOptions();
    $fltCluster.value = state.ui.filterClusterId || "ALL";
    setMeta("READY");
  }

  init();

})();
</script>

<!--
AE/EE/WB SERIALIZATION STAMP (MANDATORY)
FILE_ID: link_sort
ROOM_ID: BASE
VERSION: KETADATA_LINK_SORT_v1
UPDATED_AT: 2025-12-27T00:00:00Z
CHANGELOG:
- v1: cluster modules + per-link tags/status/version/notes
- v1: export/import state JSON (literal UI recreation)
- v1: prompt export text (grouped by cluster, flags deprecated)
-->
</body>
</html>
