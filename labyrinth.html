<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KETADATA // LAB</title>

  <style>
    :root{
      /* LAB baseline: severe */
      --bg:#000;
      --fg:#fff;

      /* grid */
      --gridA: rgba(255,255,255,.045);
      --gridB: rgba(255,255,255,.020);
      --gridSize: 48px;
      --gridDrift: 1; /* 1 running, 0 frozen */

      /* chrome */
      --hair: rgba(255,255,255,.14);
      --hair2: rgba(255,255,255,.08);
      --hudOpacity: 1;

      /* typography */
      --uiFont: Arial, Helvetica, sans-serif;
      --uiSize: 12px;
      --nameFont: Arial, Helvetica, sans-serif;

      /* directory link */
      --linkRest: #7a7a7a;
      --linkHover: #ffffff;

      /* mild “crystallization” radiation (still severe) */
      --rx: 50%;
      --ry: 14%;
      --rA: 0.03;

      /* title size */
      --titleClamp: clamp(64px, 12vw, 220px);
      --titleSize: var(--titleClamp);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    html{ scroll-behavior:smooth; }

    body{
      margin:0;
      background: var(--bg);
      color: var(--fg);
      font-family: var(--uiFont);
      font-size: var(--uiSize);
      overflow-x:hidden;

      /* two-section snap like Studio */
      scroll-snap-type: y mandatory;
      scroll-snap-stop: always;
    }

    section{
      height:100vh;
      scroll-snap-align:start;
      position:relative;
      overflow:hidden;
    }

    /* ===== stage for lights behind everything ===== */
    #stage{
      position:fixed;
      inset:0;
      z-index:0;
      background:#000;
    }

    /* ===== lab field (grid) ===== */
    #field{
      position:fixed;
      inset:0;
      z-index:1;
      background:
        linear-gradient(var(--gridA) 1px, transparent 1px),
        linear-gradient(90deg, var(--gridB) 1px, transparent 1px);
      background-size: var(--gridSize) var(--gridSize);
      animation: drift 18s linear infinite;
      animation-play-state: running;
      pointer-events:none;
    }

    @keyframes drift{
      from{ background-position:0 0, 0 0; }
      to{ background-position:96px 96px, 96px 96px; }
    }

    /* subtle top radiation, still black */
    #radiation{
      position:fixed;
      inset:0;
      z-index:2;
      pointer-events:none;
      background:
        radial-gradient(900px 520px at var(--rx) var(--ry), rgba(255,255,255,var(--rA)), transparent 70%);
      mix-blend-mode: screen;
      opacity: .85;
    }

    /* scan texture */
    #fxScan{
      position:fixed;
      inset:0;
      z-index:3;
      pointer-events:none;
      opacity:0.35;
      background:
        repeating-linear-gradient(to bottom, rgba(255,255,255,0.010) 0px, rgba(255,255,255,0.00) 2px, rgba(0,0,0,0.00) 7px),
        repeating-linear-gradient(to right, rgba(255,255,255,0.006) 0px, rgba(255,255,255,0.00) 3px, rgba(0,0,0,0.00) 13px);
      mix-blend-mode:screen;
    }

    /* ===== system bars ===== */
    .topbar, .bottombar{
      position:fixed; left:0; right:0;
      height:44px;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 14px;
      z-index:2000;
      background:linear-gradient(to bottom, rgba(0,0,0,0.78), rgba(0,0,0,0.22));
      border-bottom:1px solid rgba(255,255,255,0.12);
      opacity: var(--hudOpacity);
    }
    .bottombar{
      top:auto; bottom:0;
      background:linear-gradient(to top, rgba(0,0,0,0.78), rgba(0,0,0,0.22));
      border-bottom:none;
      border-top:1px solid rgba(255,255,255,0.12);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-size:11px; letter-spacing:0.18em; text-transform:uppercase;
      color:rgba(255,255,255,0.86);
      user-select:none;
      pointer-events:none;
    }
    .whiteBox{ width:10px;height:10px;background:#fff;display:inline-block; }
    .mini{
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.70);
      user-select:none;
    }
    .mini b{ color:#fff; font-weight:600 }

    .btn{
      height:28px;
      padding:0 10px;
      border:1px solid rgba(255,255,255,0.24);
      background:rgba(0,0,0,0.52);
      color:rgba(255,255,255,0.86);
      font-size:11px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      cursor:pointer;
    }
    .btn:hover{ background:rgba(255,255,255,0.06); border-color:rgba(255,255,255,0.42); }
    .btn.on{ background:rgba(255,255,255,0.10); border-color:rgba(255,255,255,0.52); }

    /* KETA_NOTE icon: WHITE SQUARE ONLY */
    .noteIconBtn{
      width:28px;height:28px;
      display:inline-flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,0.24);
      background:rgba(0,0,0,0.52);
      cursor:pointer;
    }
    .noteIconBtn:hover{ background:rgba(255,255,255,0.06); border-color:rgba(255,255,255,0.42); }
    .ketaSquare{ width:10px;height:10px;background:#fff;display:inline-block; }

    /* ===== landing ===== */
    .landing{
      z-index:10;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 0 20px;
    }
    .title{
      margin:0;
      font-family: var(--nameFont);
      font-weight: 900;
      letter-spacing: .12em;
      text-transform: uppercase;
      line-height: .92;
      user-select:none;
      font-size: var(--titleSize);
      white-space:nowrap;
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    .subtitle{
      margin-top:22px;
      font-size:12px;
      letter-spacing:.32em;
      text-transform:uppercase;
      opacity:.70;
    }
    .navRow{
      margin-top:40px;
      display:flex;
      justify-content:center;
      align-items:center;
      gap: 2.4vw;
      flex-wrap:wrap;
    }
    a.klink{
      color: var(--linkRest);
      text-decoration:none;
      font-family: var(--uiFont);
      letter-spacing:.18em;
      text-transform:uppercase;
      font-weight:900;
      font-size: 11px;
      transition: color .14s ease, transform .14s ease, text-shadow .14s ease;
    }
    a.klink:hover{
      color: var(--linkHover);
      transform: translateY(-1px);
      text-shadow: 0 0 16px rgba(255,255,255,.18);
    }

    .hint{
      position:absolute;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: .92em;
      letter-spacing: .18em;
      text-transform: uppercase;
      color: rgba(255,255,255,.55);
      display:flex;
      align-items:center;
      gap: 10px;
      user-select:none;
      opacity: .85;
      z-index: 20;
    }
    .arrow{
      opacity:.7;
      animation: bob 1.4s ease-in-out infinite;
    }
    @keyframes bob{ 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(6px); } }

    /* ===== directory (Studio-like blueprint framing, but more severe) ===== */
    .directory{
      z-index:10;
      border-top: 1px solid rgba(255,255,255,.12);
      position:relative;
    }
    .blueprint{
      position:relative;
      width:100%;
      height:100%;
      background:
        linear-gradient(rgba(255,255,255,.045) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.030) 1px, transparent 1px),
        transparent;
      background-size: 44px 44px, 44px 44px, auto;
      background-position: 0 0, 0 0, center;
    }

    .bpTop{
      position:absolute;
      top:0; left:0; right:0;
      padding: 14px 18px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 14px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(6px);
      z-index: 5;
      opacity: var(--hudOpacity);
    }
    .bpBrand{
      display:flex;
      flex-direction:column;
      gap: 6px;
      min-width: 260px;
    }
    .bpBrand .line{
      font-weight: 900;
      letter-spacing: .20em;
      text-transform: uppercase;
      font-size: 12px;
      white-space:nowrap;
    }
    .bpBrand .sub{
      font-weight: 900;
      letter-spacing: .14em;
      text-transform: uppercase;
      font-size: 11px;
      color: rgba(255,255,255,.62);
    }
    .bpNav{
      display:flex;
      gap: 18px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
      padding-top: 2px;
    }

    .zone{
      position:absolute;
      width: min(420px, 30vw);
      padding: 0;
      z-index: 3;
    }
    .zone h2{
      margin:0 0 10px 0;
      font-weight: 900;
      letter-spacing: .22em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(255,255,255,.92);
    }
    .zone h2 .br{ color: rgba(255,255,255,.58); }
    .zoneList{
      display:flex;
      flex-direction:column;
      gap: 8px;
      padding-left: 0;
      margin:0;
      list-style:none;
    }
    .zoneList li{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      padding: 8px 0;
    }
    .zoneList .hintTxt{
      letter-spacing:.08em;
      color: rgba(255,255,255,.55);
      text-transform: uppercase;
      font-weight: 900;
      font-size: 10px;
      white-space:nowrap;
    }

    /* wires (severe) */
    .wires{
      position:absolute;
      inset:0;
      z-index: 1;
      pointer-events:none;
      opacity: .70;
      mix-blend-mode: screen;
    }
    .wires line{
      stroke: rgba(255,255,255,.12);
      stroke-width: 1;
    }
    .wires .dash{ stroke-dasharray: 6 8; }

    /* concierge */
    .concierge{
      position:absolute;
      bottom: 16px;
      left: 16px;
      right: 16px;
      z-index: 6;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      padding: 12px 14px;
      border-top: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(6px);
      opacity: var(--hudOpacity);
    }
    .concierge .search{
      flex: 1 1 auto;
      display:flex;
      gap: 10px;
      align-items:center;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
      padding: 10px 12px;
      min-width: 260px;
    }
    .concierge .search span{
      font-weight: 900;
      letter-spacing:.18em;
      text-transform: uppercase;
      opacity:.70;
      font-size: 11px;
      white-space:nowrap;
    }
    .concierge input{
      width:100%;
      border:none;
      outline:none;
      background: transparent;
      color: rgba(255,255,255,.92);
      font-weight: 900;
      letter-spacing:.12em;
      text-transform: uppercase;
      font-size: 11px;
    }

    /* ===== control panel ===== */
    .controlPanel{
      position:fixed;
      top: 60px;
      right: 16px;
      width: 320px;
      z-index: 2200;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.72);
      backdrop-filter: blur(8px);
      opacity: var(--hudOpacity);
      resize: both;
      overflow:auto;
      min-width: 240px;
      min-height: 54px;
      max-width: min(560px, 96vw);
      max-height: min(820px, 86vh);
      display:block;
    }
    .cpHead{
      height:34px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      border-bottom:1px solid rgba(255,255,255,0.10);
      cursor:move;
      user-select:none;
    }
    .cpHead .t{
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color: rgba(255,255,255,.86);
      font-weight:900;
    }
    .cpHead .actions{ display:flex; gap:8px; align-items:center; }
    .hbtn{
      height:22px;
      padding:0 8px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.25);
      color:rgba(255,255,255,0.82);
      font-size:12px;
      cursor:pointer;
    }
    .hbtn:hover{ background:rgba(255,255,255,0.06); border-color:rgba(255,255,255,0.36); }
    .cpBody{ padding:12px; }
    .cpBody.collapsed{ display:none; }

    .lbl{
      font-size: 10px;
      letter-spacing:.16em;
      text-transform: uppercase;
      opacity:.72;
      margin: 10px 0 6px;
      display:block;
      font-weight: 900;
    }
    .twoCol{ display:grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .mini2{
      font-size: 10px;
      letter-spacing:.14em;
      opacity:.72;
      text-transform: uppercase;
      line-height: 1.4;
      font-weight: 900;
    }
    input[type="range"], input[type="number"], input[type="color"], select{
      width: 100%;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.92);
      padding: 9px 10px;
      outline:none;
      font-family: var(--uiFont);
    }

    /* ===== global note ===== */
    .ketaNote{
      position:fixed;
      right: 16px;
      top: 60px;
      width:min(420px, calc(100vw - 40px));
      height:260px;
      z-index: 2300;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(0,0,0,0.76);
      display:none;
      flex-direction:column;
      user-select:none;
      box-shadow:0 0 0 1px rgba(0,0,0,0.65);
      opacity: var(--hudOpacity);
    }
    .ketaHead{
      height:34px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      border-bottom:1px solid rgba(255,255,255,0.10);
      cursor:move;
      font-size:11px; letter-spacing:0.18em; text-transform:uppercase;
      color:rgba(255,255,255,0.82);
    }
    .ketaBody{
      flex:1;
      padding:10px;
      display:flex;
      gap:10px;
      align-items:stretch;
    }
    .ketaIconCol{ width:18px; padding-top:2px; }
    .ketaBody textarea{
      flex:1;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(0,0,0,0.50);
      color:rgba(255,255,255,0.88);
      font-family:Arial, Helvetica, sans-serif;
      font-size:12px;
      letter-spacing:0.02em;
      padding:10px;
      outline:none;
      resize:none;
    }

    body.invert{ filter:invert(1); background:#fff; }

    @media (max-width: 860px){
      .zone{ width: calc(100% - 32px); position:relative; left:auto; top:auto; }
      .blueprint{ overflow:auto; padding-top: 86px; padding-bottom: 88px; }
      .wires{ display:none; }
      .concierge{ position: sticky; bottom:0; left:0; right:0; margin-top: 18px; }
    }
  </style>
</head>

<body>
  <!-- Lights behind everything -->
  <div id="stage"></div>

  <!-- LAB layers -->
  <div id="field" aria-hidden="true"></div>
  <div id="radiation" aria-hidden="true"></div>
  <div id="fxScan" aria-hidden="true"></div>

  <!-- SYSTEM TOP BAR -->
  <div class="topbar" id="topbar">
    <div class="brand"><span class="whiteBox"></span><span>KETADATA // LAB</span></div>

    <div style="display:flex;gap:10px;align-items:center">
      <button class="btn" id="btnPanel" type="button">PANEL</button>

      <!-- KETA_NOTE ICON: WHITE SQUARE ONLY -->
      <button class="noteIconBtn" id="btnNoteIcon" type="button" aria-label="KETA_NOTE">
        <span class="ketaSquare"></span>
      </button>
    </div>
  </div>

  <!-- SYSTEM BOTTOM BAR -->
  <div class="bottombar" id="bottombar">
    <div class="mini">NULL: <b id="nullLabel">OFF</b> · INVERT: <b id="invLabel">OFF</b></div>
    <div class="mini">LIGHT: <b id="lightLabel">1</b> · RUN: <b id="runLabel">OFF</b> · GRID: <b id="gridLabel">RUN</b></div>
  </div>

  <!-- DRAGGABLE CONTROL PANEL (collapsed by default) -->
  <div class="controlPanel" id="controlPanel">
    <div class="cpHead" id="cpHead">
      <div class="t">LAB CONTROL</div>
      <div class="actions">
        <button class="hbtn" id="cpToggle" type="button">+</button>
        <button class="hbtn" id="cpHide" type="button">-</button>
      </div>
    </div>
    <div class="cpBody collapsed" id="cpBody">
      <span class="lbl">GRID</span>
      <div class="twoCol">
        <div>
          <div class="mini2">FREEZE</div>
          <button class="btn" id="btnFreeze" type="button">OFF</button>
        </div>
        <div>
          <div class="mini2">SIZE</div>
          <input id="gridSize" type="range" min="28" max="84" step="1" value="48" />
        </div>
      </div>

      <span class="lbl">RADIATION</span>
      <div class="twoCol">
        <div>
          <div class="mini2">INTENSITY</div>
          <input id="radA" type="range" min="0.00" max="0.10" step="0.001" value="0.030" />
        </div>
        <div>
          <div class="mini2">Y POSITION</div>
          <input id="radY" type="range" min="6" max="40" step="1" value="14" />
        </div>
      </div>

      <span class="lbl">TYPE</span>
      <div class="twoCol">
        <div>
          <div class="mini2">UI SIZE</div>
          <input id="uiSize" type="number" min="10" max="18" step="1" value="12" />
        </div>
        <div>
          <div class="mini2">FONT</div>
          <select id="uiFont">
            <option value="Arial, Helvetica, sans-serif">ARIAL</option>
            <option value="Helvetica Neue, Helvetica, Arial, sans-serif">HELVETICA</option>
            <option value="Inter, system-ui, -apple-system, Arial, sans-serif">INTER</option>
            <option value="IBM Plex Mono, ui-monospace, Menlo, Monaco, Consolas, monospace">IBM PLEX MONO</option>
            <option value="JetBrains Mono, ui-monospace, Menlo, Monaco, Consolas, monospace">JETBRAINS MONO</option>
            <option value="Space Mono, ui-monospace, Menlo, Monaco, Consolas, monospace">SPACE MONO</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- GLOBAL KETA_NOTE PANEL -->
  <div class="ketaNote" id="ketaNote">
    <div class="ketaHead" id="ketaHead">
      <div>KETA_NOTE</div>
      <button class="hbtn" id="btnHideNote" type="button">-</button>
    </div>
    <div class="ketaBody">
      <div class="ketaIconCol"><span class="ketaSquare"></span></div>
      <textarea id="ketaText" placeholder="GLOBAL NOTE" spellcheck="false"></textarea>
    </div>
  </div>

  <!-- LANDING -->
  <section class="landing" id="top">
    <div>
      <h1 class="title" id="bigTitle">
        <span>KETADATA</span>
        <span>[LAB]</span>
      </h1>
      <div class="subtitle"> CONTROLLED / / / OUTPUT</div>

      <div class="navRow">
        <a class="klink" href="#directory">[DIRECTORY]</a>
        <a class="klink" href="studio.html">[STUDIO]</a>
        <a class="klink" href="observatory.html">[OBSERVATORY]</a>
        <a class="klink" href="room.html">[ROOM]</a>
        <a class="klink" href="library.html">[LIBRARY]</a>
      </div>
    </div>

    <div class="hint">SCROLL <span class="arrow">↓</span></div>
  </section>

  <!-- DIRECTORY -->
  <section class="directory" id="directory">
    <div class="blueprint" id="bp">

      <svg class="wires" viewBox="0 0 1000 1000" preserveAspectRatio="none" aria-hidden="true">
        <line class="dash" x1="120" y1="210" x2="520" y2="250"></line>
        <line class="dash" x1="520" y1="250" x2="860" y2="220"></line>
        <line class="dash" x1="520" y1="250" x2="500" y2="520"></line>
        <line class="dash" x1="500" y1="520" x2="190" y2="730"></line>
        <line class="dash" x1="500" y1="520" x2="860" y2="720"></line>
      </svg>

      <div class="bpTop">
        <div class="bpBrand">
          <div class="line">KETADATA // LAB DIRECTORY</div>
          <div class="sub">INPUT → PROCESS → OUTPUT · CONTROLLED INSTABILITY</div>
        </div>
        <div class="bpNav">
          <a class="klink" href="#top">[TOP]</a>
          <a class="klink" href="system.html">[SYSTEM]</a>
          <a class="klink" href="index11.html">[LANDING]</a>
        </div>
      </div>

      <!-- Zones mapped from your original LAB blocks :contentReference[oaicite:1]{index=1} -->
   <div class="zone" style="left: 18px; top: 820px;">
  <h2><span class="br">[</span>TOOLS<span class="br">]</span></h2>
  <ul class="zoneList">

    <li>
      <a class="klink" href="classifier.html">[CLASSIFIER]</a>
      <span class="hintTxt">CODE + INTERFACE (WHITE)</span>
    </li>

    <li>
      <a class="klink" href="classifier1.html">[CLASSIFIER]</a>
      <span class="hintTxt">CODE + INTERFACE (BLACK)</span>
    </li>

    <li>
      <a class="klink" href="compiler.html">[COMPILER]</a>
      <span class="hintTxt">LLM CHAT COMPILER</span>
    </li>

    <li>
      <a class="klink" href="contextifier.html">[CONTEXTIFIER]</a>
      <span class="hintTxt">LLM CONTEXTIFIER</span>
    </li>

    <li>
      <a class="klink" href="html.html">[HTML]</a>
      <span class="hintTxt">HTML RENDERER</span>
    </li>

    <li>
      <a class="klink" href="interfacer.html">[INTERFACER]</a>
      <span class="hintTxt">INTERFACE</span>
    </li>

    <li>
      <a class="klink" href="interfacer1.html">[INTERFACER 1]</a>
      <span class="hintTxt">INTERFACE</span>
    </li>

    <li>
      <a class="klink" href="interfacer2.html">[INTERFACER 2]</a>
      <span class="hintTxt">INTERFACE</span>
    </li>

    <li>
      <a class="klink" href="interfacer3.html">[INTERFACER 3]</a>
      <span class="hintTxt">INTERFACE</span>
    </li>

    <li>
      <a class="klink" href="manifest.html">[MANIFEST]</a>
      <span class="hintTxt">MANIFEST GENERATOR</span>
    </li>

    <li>
      <a class="klink" href="forge3.html">[FORGE 1]</a>
      <span class="hintTxt">PAGE FORGE</span>
    </li>

    <li>
      <a class="klink" href="forge4.html">[FORGE 2]</a>
      <span class="hintTxt">PAGE FORGE</span>
    </li>

    <li>
      <a class="klink" href="forge5.html">[FORGE 3]</a>
      <span class="hintTxt">PAGE FORGE</span>
    </li>

    <li>
      <a class="klink" href="forge7.html">[FORGE 4]</a>
      <span class="hintTxt">PAGE FORGE</span>
    </li>

    <li>
      <a class="klink" href="lab.html">[LAB]</a>
      <span class="hintTxt">LAB DIRECTORY</span>
    </li>

    <li>
      <a class="klink" href="lab1.html">[LAB ROUTER]</a>
      <span class="hintTxt">ROUTER</span>
    </li>

    <li>
      <a class="klink" href="lab3.html">[ANNOTATOR]</a>
      <span class="hintTxt">IMAGE / INTERFACE</span>
    </li>

    <li>
      <a class="klink" href="lab9.html">[ANNOTATOR]</a>
      <span class="hintTxt">INTERFACE</span>
    </li>

    <li>
      <a class="klink" href="linkorg4.html">[LINK ORG]</a>
      <span class="hintTxt">THE MIND CRYSTALLIZES</span>
    </li>

  </ul>
</div>

  </section>

  <script>
    /* =========================================================
       WB ▸ NAV (keep continuity with your current setup)
    ========================================================= */
    const SHELL_HOME_URL = "system.html";     // your shell is in system.html right now
    const LANDING_URL = "index11.html";       // your landing request

    /* =========================================================
       WB ▸ STORAGE NAMESPACE (LAB page state)
    ========================================================= */
    const FILE_ID = "KETADATA_LAB";
    const ROOM_ID = "LAB";
    const VERSION_ID = "lab.v1";
    const STORAGE_KEY = `KDT::STATE::${FILE_ID}::${ROOM_ID}::${VERSION_ID}`;

    /* GLOBAL NOTE continuity (shared across pages) */
    const GLOBAL_KETA_NOTE_KEY = "KDT_GLOBAL_KETA_NOTE_V1";

    const DEFAULT = {
      ui: {
        invert:false,
        nullMode:false,
        lightPreset:1,
        lightRunning:false,
        panelVisible:true,
        panelCollapsed:true,
        noteVisible:false
      },
      grid: {
        frozen:false,
        size:48
      },
      rad: {
        a:0.030,
        y:14
      },
      type: {
        uiSize:12,
        uiFont:"Arial, Helvetica, sans-serif"
      }
    };

    const $=(id)=>document.getElementById(id);
    const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){ return null; }
    }
    function mergeDefault(s){
      const out = structuredClone(DEFAULT);
      s = s || {};
      out.ui = Object.assign(structuredClone(DEFAULT.ui), s.ui||{});
      out.grid = Object.assign(structuredClone(DEFAULT.grid), s.grid||{});
      out.rad = Object.assign(structuredClone(DEFAULT.rad), s.rad||{});
      out.type = Object.assign(structuredClone(DEFAULT.type), s.type||{});
      return out;
    }
    let STATE = mergeDefault(loadState());

    function persist(){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE)); }catch(e){}
      renderHud();
    }

    function loadGlobalNote(){
      try{ return localStorage.getItem(GLOBAL_KETA_NOTE_KEY) || ""; }catch(e){ return ""; }
    }
    function saveGlobalNote(v){
      try{ localStorage.setItem(GLOBAL_KETA_NOTE_KEY, String(v||"")); }catch(e){}
    }

    /* ===== Title auto-fit ===== */
    const bigTitle = $("bigTitle");
    function fitTitle(){
      if(!bigTitle) return;
      let lo = 48, hi = 260, best = lo;
      for(let i=0;i<18;i++){
        const mid = (lo+hi)/2;
        document.documentElement.style.setProperty("--titleSize", mid+"px");
        const r = bigTitle.getBoundingClientRect();
        if(r.width <= window.innerWidth - 40 && r.height <= window.innerHeight * 0.55){
          best = mid; lo = mid;
        }else hi = mid;
      }
      document.documentElement.style.setProperty("--titleSize", best+"px");
    }

    /* ===== Apply LAB visuals ===== */
    const field = $("field");
    function applyGrid(){
      document.documentElement.style.setProperty("--gridSize", (STATE.grid.size||48) + "px");
      field.style.animationPlayState = STATE.grid.frozen ? "paused" : "running";
      $("gridLabel").textContent = STATE.grid.frozen ? "FROZ" : "RUN";
    }
    function applyRadiation(){
      document.documentElement.style.setProperty("--rA", String(STATE.rad.a || 0.03));
      document.documentElement.style.setProperty("--ry", (STATE.rad.y || 14) + "%");
    }
    function applyType(){
      document.documentElement.style.setProperty("--uiSize", (STATE.type.uiSize||12) + "px");
      document.documentElement.style.setProperty("--uiFont", STATE.type.uiFont || "Arial, Helvetica, sans-serif");
    }

    /* ===== HUD render ===== */
    function renderHud(){
      document.body.classList.toggle("invert", !!STATE.ui.invert);
      document.documentElement.style.setProperty("--hudOpacity", STATE.ui.nullMode ? "0" : "1");
      $("nullLabel").textContent = STATE.ui.nullMode ? "ON" : "OFF";
      $("invLabel").textContent = STATE.ui.invert ? "ON" : "OFF";
      $("lightLabel").textContent = String(STATE.ui.lightPreset||1);
      $("runLabel").textContent = STATE.ui.lightRunning ? "ON" : "OFF";

      $("controlPanel").style.display = (STATE.ui.panelVisible && !STATE.ui.nullMode) ? "block" : "none";
      $("cpBody").classList.toggle("collapsed", !!STATE.ui.panelCollapsed);

      $("ketaNote").style.display = (STATE.ui.noteVisible && !STATE.ui.nullMode) ? "flex" : "none";
    }

    /* ===== Scroll snap “bam” like Studio ===== */
    let wheelLock=false;
    function snapTo(id){
      const el = document.getElementById(id);
      if(!el) return;
      el.scrollIntoView({behavior:"smooth", block:"start"});
    }
    window.addEventListener("wheel", (e)=>{
      if(wheelLock) return;
      const dy = e.deltaY || 0;
      const atTop = (window.scrollY || window.pageYOffset || 0) < 8;
      if(atTop && dy > 6){
        wheelLock=true;
        snapTo("directory");
        setTimeout(()=>wheelLock=false, 420);
      }else if(!atTop && dy < -6){
        wheelLock=true;
        snapTo("top");
        setTimeout(()=>wheelLock=false, 420);
      }
    }, {passive:true});

    /* ===== Search ===== */
    const q = $("q");
    const allLinks = Array.from(document.querySelectorAll(".zoneList a.klink"));
    const norm = (s)=> (s||"").toLowerCase().trim();
    function applySearch(){
      const term = norm(q.value);
      allLinks.forEach(a=>{
        const pass = !term || norm(a.textContent).includes(term);
        a.closest("li").style.display = pass ? "" : "none";
      });
    }
    function openFirstVisible(){
      const first = allLinks.find(a => a.closest("li").style.display !== "none");
      if(first) window.location.href = first.getAttribute("href");
    }
    q.addEventListener("input", applySearch);
    q.addEventListener("keydown", (event)=>{
      if(event.key === "Enter") openFirstVisible();
      if(event.key === "Escape"){ q.value=""; applySearch(); }
    });

    /* ===== Control panel wiring ===== */
    const btnFreeze = $("btnFreeze");
    const gridSize = $("gridSize");
    const radA = $("radA");
    const radY = $("radY");
    const uiSize = $("uiSize");
    const uiFont = $("uiFont");

    btnFreeze.addEventListener("click", ()=>{
      STATE.grid.frozen = !STATE.grid.frozen;
      btnFreeze.classList.toggle("on", STATE.grid.frozen);
      btnFreeze.textContent = STATE.grid.frozen ? "ON" : "OFF";
      applyGrid();
      persist();
    });

    gridSize.addEventListener("input", (e)=>{
      STATE.grid.size = parseInt(e.target.value,10) || 48;
      applyGrid();
      persist();
    });

    radA.addEventListener("input", (e)=>{
      STATE.rad.a = parseFloat(e.target.value);
      applyRadiation();
      persist();
    });

    radY.addEventListener("input", (e)=>{
      STATE.rad.y = parseInt(e.target.value,10) || 14;
      applyRadiation();
      persist();
    });

    uiSize.addEventListener("input", (e)=>{
      STATE.type.uiSize = parseInt(e.target.value,10) || 12;
      applyType();
      fitTitle();
      persist();
    });

    uiFont.addEventListener("change", (e)=>{
      STATE.type.uiFont = e.target.value;
      applyType();
      fitTitle();
      persist();
    });

    /* ===== Panel show/hide ===== */
    $("btnPanel").addEventListener("click", ()=>{
      STATE.ui.panelVisible = !STATE.ui.panelVisible;
      persist();
    });
    $("cpToggle").addEventListener("click", ()=>{
      STATE.ui.panelCollapsed = !STATE.ui.panelCollapsed;
      $("cpToggle").textContent = STATE.ui.panelCollapsed ? "+" : "–";
      persist();
    });
    $("cpHide").addEventListener("click", ()=>{
      STATE.ui.panelVisible = false;
      persist();
    });

    /* ===== Global KETA_NOTE ===== */
    function setNoteVisible(on){
      STATE.ui.noteVisible = !!on;
      persist();
    }
    $("btnNoteIcon").addEventListener("click", ()=> setNoteVisible(!STATE.ui.noteVisible));
    $("btnHideNote").addEventListener("click", ()=> setNoteVisible(false));

    const ketaText = $("ketaText");
    ketaText.value = loadGlobalNote();
    ketaText.addEventListener("input", ()=> saveGlobalNote(ketaText.value || ""));

    /* draggable note */
    (function noteDrag(){
      const note = $("ketaNote");
      const head = $("ketaHead");
      let isDrag=false, ox=0, oy=0;
      head.addEventListener("mousedown", (e)=>{
        isDrag=true;
        const r=note.getBoundingClientRect();
        ox=e.clientX-r.left; oy=e.clientY-r.top;
        e.preventDefault();
      });
      window.addEventListener("mousemove", (e)=>{
        if(!isDrag) return;
        note.style.left=""; note.style.right="auto";
        note.style.top = clamp(e.clientY-oy, 50, window.innerHeight - note.offsetHeight - 50) + "px";
        note.style.left = clamp(e.clientX-ox, 6, window.innerWidth - note.offsetWidth - 6) + "px";
      });
      window.addEventListener("mouseup", ()=> isDrag=false);
    })();

    /* draggable panel */
    (function panelDrag(){
      const panel = $("controlPanel");
      const head = $("cpHead");
      let isDrag=false, ox=0, oy=0;
      head.addEventListener("mousedown", (e)=>{
        isDrag=true;
        const r=panel.getBoundingClientRect();
        ox=e.clientX-r.left; oy=e.clientY-r.top;
        e.preventDefault();
      });
      window.addEventListener("mousemove", (e)=>{
        if(!isDrag) return;
        panel.style.left="auto";
        panel.style.right="auto";
        panel.style.top = clamp(e.clientY-oy, 50, window.innerHeight - panel.offsetHeight - 50) + "px";
        panel.style.left = clamp(e.clientX-ox, 6, window.innerWidth - panel.offsetWidth - 6) + "px";
      });
      window.addEventListener("mouseup", ()=> isDrag=false);
    })();

    /* ===== Lights 1–6 behind LAB ===== */
    const stage = $("stage");
    let lightInterval=null, lightCount=0, lightAuxA=0, lightAuxB=0;

    function resetStage(){
      stage.style.backgroundColor = "#000000";
      stage.style.filter = "none";
      lightCount=0; lightAuxA=0; lightAuxB=0;
    }
    function stopLight(silent){
      if(lightInterval) clearInterval(lightInterval);
      lightInterval=null;
      STATE.ui.lightRunning=false;
      resetStage();
      if(!silent) persist();
    }
    function startLight(preset){
      stopLight(true);
      resetStage();
      STATE.ui.lightPreset=preset;
      STATE.ui.lightRunning=true;

      if(preset===1){
        lightInterval=setInterval(()=>{
          const curr = stage.style.backgroundColor || "black";
          stage.style.backgroundColor = (curr==="black" || curr==="rgb(0, 0, 0)") ? "white" : "black";
          stage.style.filter="none";
        }, 50);
      }
      if(preset===2){
        lightInterval=setInterval(()=>{
          lightAuxA=(lightAuxA+30)%360;
          lightAuxB+=0.5;
          const lightness = 50 + Math.sin(lightAuxB) * 40;
          stage.style.backgroundColor = `hsl(${lightAuxA}, 100%, ${lightness}%)`;
          stage.style.filter="none";
        }, 10);
      }
      if(preset===3){
        lightInterval=setInterval(()=>{
          lightCount++;
          const beat=lightCount%16;
          if(beat===0 || beat===1){
            stage.style.backgroundColor="#ffffff";
            stage.style.filter="invert(1) contrast(3) brightness(2)";
          } else if(beat===2){
            stage.style.backgroundColor="#000000";
            stage.style.filter="invert(1) contrast(2)";
          } else {
            stage.style.backgroundColor="#000000";
            stage.style.filter="none";
          }
        }, 50);
      }
      if(preset===4){
        lightInterval=setInterval(()=>{
          lightAuxB += 0.08;
          const v = 0.5 + 0.5*Math.sin(lightAuxB);
          const a = 0.18 + 0.42*v;
          stage.style.backgroundColor = "#000000";
          stage.style.filter = `brightness(${1+a}) contrast(${1.2+v*1.6})`;
        }, 16);
      }
      if(preset===5){
        lightInterval=setInterval(()=>{
          lightAuxB += 0.11;
          const v = 0.5 + 0.5*Math.sin(lightAuxB);
          stage.style.backgroundColor = v>0.5 ? "#ffffff" : "#000000";
          stage.style.filter = `contrast(${2.2})`;
        }, 90);
      }
      if(preset===6){
        lightInterval=setInterval(()=>{
          lightAuxB += 0.06;
          const v = 0.5 + 0.5*Math.sin(lightAuxB);
          stage.style.backgroundColor = "#000000";
          stage.style.filter = `invert(${v}) contrast(${1.6+v*1.2}) brightness(${1.0+v*0.6})`;
        }, 16);
      }

      persist();
    }

    function toggleTransport(){
      if(STATE.ui.lightRunning) stopLight(true);
      else startLight(STATE.ui.lightPreset || 1);
      persist();
    }

    /* ===== SYSTEM UNIVERSALS ONLY ===== */
    window.addEventListener("keydown", (e)=>{
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
      const typing = (tag==="textarea" || tag==="input" || tag==="select");

      if(!typing && e.shiftKey && e.key === "I"){
        STATE.ui.invert = !STATE.ui.invert;
        persist();
      }

      if(!typing && e.shiftKey && e.key === "0"){
        STATE.ui.nullMode = !STATE.ui.nullMode;
        if(STATE.ui.nullMode) STATE.ui.noteVisible = false;
        persist();
      }

      if(!typing && e.shiftKey && (e.key === "B" || e.key === "b")){
        window.location.href = SHELL_HOME_URL;
      }

      if(!typing && e.shiftKey && (e.key === "K" || e.key === "k")){
        window.location.href = LANDING_URL;
      }

      if(!typing && e.code === "Space"){
        e.preventDefault();
        toggleTransport();
      }

      if(!typing && !e.shiftKey && !e.ctrlKey && !e.metaKey){
        const n = parseInt(e.key, 10);
        if(n>=1 && n<=6) startLight(n);
      }

      if(!typing && e.key === "Escape"){
        if(STATE.ui.nullMode){
          STATE.ui.nullMode = false;
          persist();
        }
      }
    });

    /* ===== init ===== */
    function init(){
      // restore UI
      $("cpToggle").textContent = STATE.ui.panelCollapsed ? "+" : "–";

      // restore control values
      btnFreeze.classList.toggle("on", STATE.grid.frozen);
      btnFreeze.textContent = STATE.grid.frozen ? "ON" : "OFF";
      gridSize.value = String(STATE.grid.size || 48);
      radA.value = String(STATE.rad.a || 0.03);
      radY.value = String(STATE.rad.y || 14);
      uiSize.value = String(STATE.type.uiSize || 12);
      uiFont.value = STATE.type.uiFont || "Arial, Helvetica, sans-serif";

      applyType();
      applyGrid();
      applyRadiation();
      renderHud();
      fitTitle();
      persist();
    }

    window.addEventListener("resize", fitTitle);
    window.addEventListener("load", fitTitle);

    init();
  </script>
</body>
</html>

<!--
============================================================
KETADATA HTML SERIALIZATION STAMP
FILE_ID: KETADATA_LAB
ROOM_ID: LAB
VERSION: lab.v1
UPDATED_AT: 2025-12-24T00:00:00-05:00
CHANGELOG:
- LAB WRAPPED IN SYSTEM CHROME (TOP/BOTTOM BARS) WITH UNIVERSALS ONLY
- WHITE SQUARE KETA_NOTE ICON ANCHOR (NO DRIFT)
- GLOBAL KETA_NOTE CONTINUITY KEY: KDT_GLOBAL_KETA_NOTE_V1
- LIGHTS 1–6 BEHIND LAB SURFACES (STAGE LAYER)
- SEVERE BLACK/WHITE LAB AESTHETIC + GRID (FREEZE IS CLICK-FIRST)
- DRAGGABLE/RESIZABLE CONTROL PANEL, COLLAPSED BY DEFAULT
- STUDIO-LIKE TWO-SURFACE SNAP (TOP <-> DIRECTORY)
============================================================
-->
