<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KETADATA // ANNOTATOR (ELEGANT)</title>
  <style>
    :root{
      --bg:#000;
      --fg:#fff;
      --stroke:rgba(255,255,255,0.18);
      --stroke2:rgba(255,255,255,0.12);
      --glass:rgba(255,255,255,0.06);
      --panel:rgba(0,0,0,0.92);
      --muted:rgba(255,255,255,0.62);
      --muted2:rgba(255,255,255,0.40);
      --shadow:rgba(0,0,0,0.78);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:Arial, Helvetica, sans-serif;}
    body{overflow:hidden;}
    button,input,select,textarea{font-family:inherit}

    /* Topbar */
    #topbar{
      position:fixed; left:0; right:0; top:0;
      height:48px;
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid var(--stroke2);
      background:#000;
      user-select:none;
      z-index:20;
    }
    #brand{
      display:flex; align-items:center; gap:10px;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.80);
      min-width:240px;
    }
    .whiteBox{width:10px;height:10px;background:#fff;display:inline-block;}
    #topActions{display:flex;align-items:center;gap:8px;}
    .btn{
      border:1px solid var(--stroke);
      background:transparent;
      color:rgba(255,255,255,0.86);
      padding:7px 10px;
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      cursor:pointer;
    }
    .btn:hover{background:var(--glass);border-color:rgba(255,255,255,0.34);}
    .btnPrimary{background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.30);}
    .btnPrimary:hover{background:rgba(255,255,255,0.09);border-color:rgba(255,255,255,0.44);}

    /* REQUIRED: White note icon upper right */
    #noteIcon{
      width:28px;height:28px;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,0.20);
      background:rgba(255,255,255,0.10);
      cursor:pointer;
    }
    #noteIcon:hover{border-color:rgba(255,255,255,0.36);background:rgba(255,255,255,0.14);}

    /* Main layout */
    #main{
      position:fixed; inset:48px 0 0 0;
      display:grid;
      grid-template-columns: 340px 1fr;
      min-height:0;
    }

    /* Left */
    #left{
      border-right:1px solid var(--stroke2);
      background:rgba(0,0,0,0.90);
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    #leftHeader{
      padding:12px;
      border-bottom:1px solid var(--stroke2);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      user-select:none;
    }
    #leftHeader .title{
      margin:0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.78);
      display:flex;align-items:center;gap:10px;
    }
    #leftBody{
      padding:12px;
      overflow:auto;
      min-height:0;
    }

    .field{display:grid;gap:6px;margin-bottom:12px;}
    label{
      font-size:11px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.60);
    }
    input[type="text"], textarea, select{
      width:100%;
      border:1px solid rgba(255,255,255,0.16);
      background:rgba(255,255,255,0.04);
      color:rgba(255,255,255,0.90);
      padding:9px 10px;
      font-size:12px;
      outline:none;
    }
    textarea{min-height:78px;resize:vertical;}
    input[type="text"]:focus, textarea:focus, select:focus{
      border-color:rgba(255,255,255,0.36);
      background:rgba(255,255,255,0.06);
    }
    .hint{
      font-size:11px;
      line-height:1.35;
      color:rgba(255,255,255,0.48);
      letter-spacing:0.04em;
    }

    /* Tabs */
    #tabList{display:grid;gap:8px;margin-top:6px;}
    .tab{
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.03);
      padding:10px;
      cursor:pointer;
      display:flex;flex-direction:column;gap:6px;
    }
    .tab:hover{background:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.22);}
    .tab.active{background:rgba(255,255,255,0.07);border-color:rgba(255,255,255,0.32);}
    .tabTop{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .tabName{
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.86);
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .pill{
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.55);
      border:1px solid rgba(255,255,255,0.14);
      padding:3px 6px;
      background:rgba(0,0,0,0.40);
      white-space:nowrap;
    }

    /* Source toggle (simple) */
    #sourceRow{display:flex;gap:8px;flex-wrap:wrap;}
    .chip{
      border:1px solid rgba(255,255,255,0.16);
      background:transparent;
      color:rgba(255,255,255,0.72);
      padding:7px 10px;
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{background:var(--glass);border-color:rgba(255,255,255,0.34);}
    .chip.on{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.40);color:rgba(255,255,255,0.88);}

    /* Dropzone */
    #drop{
      border:1px dashed rgba(255,255,255,0.22);
      background:rgba(255,255,255,0.03);
      padding:12px;
      display:grid;
      gap:8px;
      cursor:pointer;
      user-select:none;
    }
    #drop:hover{background:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.34);}
    #drop.drag{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.44);}
    #dropTop{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.82);
    }
    #fileMeta{
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.44);
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    #fileInput{display:none;}

    /* Right stage */
    #stageWrap{
      position:relative;
      min-height:0;
      overflow:hidden;
      background:#000;
    }
    #viewer{
      position:absolute; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      background:#000;
    }
    #viewerInner{
      position:relative;
      width:min(94%, 1160px);
      height:min(92%, 820px);
      border:1px solid var(--stroke);
      box-shadow:0 22px 90px var(--shadow);
      background:#000;
      overflow:hidden;
    }
    #imgView{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:contain;
      background:#000;
      display:none;
    }
    #iframeView{
      position:absolute; inset:0;
      width:100%; height:100%;
      border:0;
      background:#000;
      display:none;
    }

    /* Annotation layer */
    #anno{
      position:absolute; inset:0;
      z-index:5;
      pointer-events:auto;
    }
    .pin{
      position:absolute;
      width:10px;height:10px;
      margin:-5px 0 0 -5px;
      border-radius:999px;
      background:rgba(255,255,255,0.28);
      border:1px solid rgba(255,255,255,0.14);
      cursor:pointer;
      opacity:0.65;
      transition:opacity 120ms linear, transform 120ms linear, background 120ms linear;
    }
    .pin:hover{opacity:0.95;}
    .pin.active{
      opacity:1;
      background:rgba(255,255,255,0.70);
      transform:scale(1.18);
      border-color:rgba(255,255,255,0.28);
    }

    /* Stage header */
    #stageHeader{
      position:absolute; left:14px; top:12px;
      z-index:10;
      pointer-events:none;
      display:flex;align-items:center;gap:10px;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.78);
    }
    #stageSub{
      margin-left:6px;
      color:rgba(255,255,255,0.40);
      letter-spacing:0.12em;
      font-size:10px;
      white-space:nowrap;
    }

    /* CC note card */
    #ccBtn{
      position:absolute; right:12px; top:12px;
      z-index:12;
      width:28px;height:28px;
      border:1px solid rgba(255,255,255,0.24);
      background:rgba(0,0,0,0.45);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      cursor:pointer;
      display:grid;place-items:center;
      padding:0;
    }
    #ccBtn:hover{background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.38);}
    #ccGlyph{width:10px;height:10px;border:1px solid rgba(255,255,255,0.55);opacity:0.85;}

    #noteCard{
      position:absolute; right:12px; top:48px;
      z-index:30;
      width:min(420px, calc(100% - 24px));
      border:1px solid rgba(255,255,255,0.22);
      background:var(--panel);
      box-shadow:0 28px 110px rgba(0,0,0,0.82);
      padding:12px;
      display:none;
    }
    #noteCard.open{display:block;}
    #noteCardHeader{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-bottom:10px;
      user-select:none;
    }
    #noteCardHeader .t{
      margin:0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.84);
      display:flex;align-items:center;gap:10px;
    }
    #closeCard{padding:6px 8px;font-size:10px;letter-spacing:0.16em;}

    #cardRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom:10px;
    }
    .cardField{display:grid;gap:6px;}

    #glossaryStrip{
      border-top:1px solid rgba(255,255,255,0.10);
      padding-top:10px;
      margin-top:10px;
      font-size:10px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.40);
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      user-select:none;
    }

    #whisper{
      position:absolute; left:14px; bottom:12px;
      z-index:10;
      color:rgba(255,255,255,0.34);
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      user-select:none;
      pointer-events:none;
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      max-width:75%;
    }

    /* Modal */
    #modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.72);
      display:none;
      z-index:50;
    }
    #modal{
      position:absolute; right:16px; top:58px;
      width:min(460px, calc(100% - 32px));
      border:1px solid rgba(255,255,255,0.22);
      background:rgba(0,0,0,0.92);
      box-shadow:0 28px 110px rgba(0,0,0,0.82);
      padding:12px;
    }
    #modalTitle{
      margin:0 0 10px 0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.82);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      user-select:none;
    }

    #toast{
      position:fixed;
      left:50%;
      top:68px;
      transform:translateX(-50%);
      padding:8px 10px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.72);
      color:rgba(255,255,255,0.65);
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      display:none;
      z-index:80;
    }
  </style>
</head>

<body>
  <div id="topbar">
    <div id="brand">
      <span class="whiteBox" aria-hidden="true"></span>
      <span>KETADATA // ANNOTATOR</span>
    </div>
    <div id="topActions">
      <button id="noteIcon" type="button" aria-label="Global Note">
        <span class="whiteBox" style="width:10px;height:10px;" aria-hidden="true"></span>
      </button>
      <button id="exportState" class="btn btnPrimary" type="button">Export State</button>
      <button id="exportPrompt" class="btn" type="button">Copy Prompt</button>
    </div>
  </div>

  <div id="main">
    <div id="left">
      <div id="leftHeader">
        <p class="title"><span class="whiteBox" aria-hidden="true"></span> Interfaces</p>
        <button id="newTab" class="btn btnPrimary" type="button">New</button>
      </div>

      <div id="leftBody">
        <div class="field">
          <label for="project">Project</label>
          <input id="project" type="text" value="KETADATA" />
        </div>

        <div class="field">
          <label for="room">Room Context</label>
          <select id="room">
            <option>ENTRY</option><option>LOBBY</option><option>TEMPLE</option>
            <option>STUDIO</option><option>LAB</option><option>VAULT</option>
            <option>BASEMENT</option><option>WHITE ROOM</option>
          </select>
          <div class="hint">Context only. Interface still declares VI / DI / VI-DI.</div>
        </div>

        <div class="field">
          <label for="ifaceType">Interface Type</label>
          <select id="ifaceType">
            <option>VI</option>
            <option>DI</option>
            <option selected>VI-DI</option>
          </select>
        </div>

        <div class="field">
          <label for="ifaceName">Interface Name</label>
          <input id="ifaceName" type="text" placeholder="e.g. photobooth-crunch-v2" />
        </div>

        <div class="field">
          <label>Source</label>
          <div id="sourceRow">
            <button id="srcImage" class="chip on" type="button">IMAGE</button>
            <button id="srcUrl" class="chip" type="button">URL</button>
            <button id="srcBlank" class="chip" type="button">BLANK</button>
          </div>
          <div class="hint">Image = stable markup pins. URL = visual plane pins only.</div>
        </div>

        <div class="field" id="urlField" style="display:none;">
          <label for="url">URL</label>
          <input id="url" type="text" placeholder="https://ketadata.com/studio.html" />
          <div class="hint">Auto-loads on blur/Enter.</div>
        </div>

        <div class="field" id="imgField">
          <label>Image</label>
          <div id="drop" tabindex="0" role="button" aria-label="Upload image">
            <div id="dropTop">
              <span>DROP / CLICK / PASTE</span>
              <span class="whiteBox" aria-hidden="true" style="width:9px;height:9px;"></span>
            </div>
            <div id="fileMeta">NO FILE</div>
            <div class="hint">Drag a PNG/JPG/WebP. Or paste a screenshot (Cmd/Ctrl+V).</div>
          </div>
          <input id="fileInput" type="file" accept="image/*" />
        </div>

        <div class="field">
          <label>Tabs</label>
          <div id="tabList"></div>
          <div class="hint">One interface per tab. Pins belong to the active tab.</div>
        </div>
      </div>
    </div>

    <div id="stageWrap">
      <div id="stageHeader">
        <span class="whiteBox" aria-hidden="true" style="width:9px;height:9px;"></span>
        <span id="stageTitle">NO INTERFACE</span>
        <span id="stageSub"></span>
      </div>

      <button id="ccBtn" type="button" aria-label="Command/Control">
        <span id="ccGlyph" aria-hidden="true"></span>
      </button>

      <div id="viewer">
        <div id="viewerInner">
          <img id="imgView" alt="Interface Reference" />
          <iframe id="iframeView" title="Interface Preview" sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
          <div id="anno"></div>

          <div id="noteCard" aria-label="Note editor">
            <div id="noteCardHeader">
              <p class="t"><span class="whiteBox" style="width:9px;height:9px;"></span> NOTE</p>
              <button id="closeCard" class="btn" type="button">Close</button>
            </div>

            <div id="cardRow">
              <div class="cardField">
                <label for="nTitle">Title</label>
                <input id="nTitle" type="text" placeholder="short label" />
              </div>
              <div class="cardField">
                <label for="nGlossary">Glossary Tag</label>
                <select id="nGlossary">
                  <option value="">—</option>
                  <option>ROOM</option><option>INTERFACE</option><option>MODULE</option><option>CONTROL</option>
                  <option>NOTE</option><option>STATE</option><option>PROMPT</option><option>LIGHT</option>
                  <option>COLLAPSE</option><option>MODE</option><option>ACCESS</option><option>TRANSITION</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label for="nComponent">Component</label>
              <input id="nComponent" type="text" placeholder="e.g. ccBtn / hotkeyNodes / drawer" />
            </div>

            <div class="field">
              <label for="nText">Body</label>
              <textarea id="nText" placeholder="type. no tricks."></textarea>
            </div>

            <div class="field">
              <label for="nTags">Tags (comma separated)</label>
              <input id="nTags" type="text" placeholder="collapse, nodes, hierarchy" />
            </div>

            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <button id="saveNote" class="btn btnPrimary" type="button">Save</button>
              <button id="deleteNote" class="btn" type="button">Delete</button>
            </div>

            <div id="glossaryStrip" aria-hidden="true">
              <span>ROOM=context</span>
              <span>INTERFACE=surface</span>
              <span>MODULE=collapsible</span>
              <span>CONTROL=variable</span>
              <span>NOTE=atom</span>
              <span>STATE=snapshot</span>
              <span>PROMPT=intent</span>
            </div>
          </div>
        </div>
      </div>

      <div id="whisper">
        <span>DOUBLE-CLICK = PIN</span>
        <span>CLICK PIN = EDIT</span>
        <span>DRAG PIN = MOVE</span>
        <span>CC = NOTE CARD</span>
        <span>PASTE = IMAGE</span>
      </div>
    </div>
  </div>

  <!-- GLOBAL NOTE MODAL -->
  <div id="modalBack" aria-hidden="true">
    <div id="modal" role="dialog" aria-label="Global Note">
      <div id="modalTitle">
        <span><span class="whiteBox" style="width:9px;height:9px;"></span> GLOBAL NOTE</span>
        <button id="closeModal" class="btn" type="button">Close</button>
      </div>
      <div class="field">
        <label for="globalNote">Text</label>
        <textarea id="globalNote" placeholder="system constraint note"></textarea>
        <div class="hint">Saved into state. Laws, constraints, reminders.</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button id="saveGlobal" class="btn btnPrimary" type="button">Save</button>
        <button id="clearGlobal" class="btn" type="button">Clear</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    // ================
    // KETADATA Annotator (Elegant)
    // - image upload is immediate and robust
    // - drag/drop + paste + click
    // - file input reset so same-file upload works
    // ================

    const el = (id)=>document.getElementById(id);
    const projectEl = el('project');
    const roomEl = el('room');
    const ifaceTypeEl = el('ifaceType');
    const ifaceNameEl = el('ifaceName');

    const srcImageBtn = el('srcImage');
    const srcUrlBtn = el('srcUrl');
    const srcBlankBtn = el('srcBlank');

    const urlField = el('urlField');
    const urlEl = el('url');
    const imgField = el('imgField');

    const drop = el('drop');
    const fileMeta = el('fileMeta');
    const fileInput = el('fileInput');

    const tabList = el('tabList');
    const newTabBtn = el('newTab');

    const stageTitleEl = el('stageTitle');
    const stageSubEl = el('stageSub');
    const imgView = el('imgView');
    const iframeView = el('iframeView');
    const anno = el('anno');

    const ccBtn = el('ccBtn');
    const noteCard = el('noteCard');
    const closeCard = el('closeCard');

    const nTitle = el('nTitle');
    const nGlossary = el('nGlossary');
    const nComponent = el('nComponent');
    const nText = el('nText');
    const nTags = el('nTags');
    const saveNoteBtn = el('saveNote');
    const deleteNoteBtn = el('deleteNote');

    const noteIcon = el('noteIcon');
    const modalBack = el('modalBack');
    const closeModal = el('closeModal');
    const globalNote = el('globalNote');
    const saveGlobal = el('saveGlobal');
    const clearGlobal = el('clearGlobal');

    const exportStateBtn = el('exportState');
    const exportPromptBtn = el('exportPrompt');
    const toastEl = el('toast');

    const uid = ()=>Math.random().toString(36).slice(2, 9)+"-"+Date.now().toString(36);
    const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
    const isTypingTarget = (t)=>{
      if(!t) return false;
      const tag = t.tagName ? t.tagName.toLowerCase() : '';
      return tag === 'input' || tag === 'textarea' || tag === 'select' || t.isContentEditable;
    };
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (m)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
    function toast(msg, ms=650){
      toastEl.textContent = msg;
      toastEl.style.display = 'block';
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>{ toastEl.style.display='none'; }, ms);
    }
    async function copyText(s){
      try{ await navigator.clipboard.writeText(s); toast("COPIED"); }
      catch{ window.prompt("Copy:", s); }
    }
    function encode(obj){ return btoa(unescape(encodeURIComponent(JSON.stringify(obj)))); }
    function decode(b64){ return JSON.parse(decodeURIComponent(escape(atob(b64)))); }

    function makeTab(){
      return {
        id: uid(),
        name: "NEW INTERFACE",
        type: "VI-DI",
        source: "image", // image|url|blank
        url: "",
        imageDataUrl: "",
        imageName: "",
        pins: []
      };
    }

    let state = {
      v: 2,
      project: "KETADATA",
      room: "STUDIO",
      globalNote: "",
      tabs: [makeTab()],
      activeTabId: null,
      activePinId: null
    };

    // load from hash if present
    (function(){
      const m = location.hash.match(/state=([^&]+)/);
      if(!m){ state.activeTabId = state.tabs[0].id; return; }
      try{
        const s = decode(m[1]);
        if(s && (s.v === 1 || s.v === 2)){
          // minimal forward-compat: v1->v2
          state = s;
          state.v = 2;
          if(!state.tabs?.length) state.tabs=[makeTab()];
          state.activeTabId = state.activeTabId || state.tabs[0].id;
          state.tabs.forEach(t=>{
            t.imageName = t.imageName || "";
          });
        } else {
          state.activeTabId = state.tabs[0].id;
        }
      }catch{
        state.activeTabId = state.tabs[0].id;
      }
    })();

    function activeTab(){
      return state.tabs.find(t=>t.id===state.activeTabId) || state.tabs[0];
    }
    function activePin(tab){
      if(!state.activePinId) return null;
      return tab.pins.find(p=>p.id===state.activePinId) || null;
    }

    function setSource(src){
      const t = activeTab();
      t.source = src;

      srcImageBtn.classList.toggle('on', src==='image');
      srcUrlBtn.classList.toggle('on', src==='url');
      srcBlankBtn.classList.toggle('on', src==='blank');

      urlField.style.display = (src==='url') ? 'block' : 'none';
      imgField.style.display = (src==='image') ? 'block' : 'none';

      // stage render updates
      renderStage();
      renderTabs();
    }

    function syncLeft(){
      projectEl.value = state.project || "KETADATA";
      roomEl.value = state.room || "STUDIO";

      const t = activeTab();
      ifaceTypeEl.value = t.type || "VI-DI";
      ifaceNameEl.value = t.name || "";
      urlEl.value = t.url || "";

      setSource(t.source || "image");

      // file meta
      if((t.source||"image")==="image"){
        fileMeta.textContent = t.imageName ? t.imageName.toUpperCase() : (t.imageDataUrl ? "IMAGE LOADED" : "NO FILE");
      }
    }

    function renderTabs(){
      tabList.innerHTML = "";
      state.tabs.forEach(t=>{
        const d = document.createElement('div');
        d.className = "tab" + (t.id===state.activeTabId ? " active" : "");
        d.innerHTML = `
          <div class="tabTop">
            <div class="tabName">${escapeHtml(t.name || "UNNAMED")}</div>
            <div class="pill">${escapeHtml(t.type || "—")}</div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <span class="pill">${escapeHtml((t.source||"blank").toUpperCase())}</span>
            <span class="pill">${t.pins.length} NOTES</span>
          </div>
        `;
        d.addEventListener('click', ()=>{
          state.activeTabId = t.id;
          state.activePinId = null;
          closeNoteCard();
          renderAll();
        });
        tabList.appendChild(d);
      });
    }

    function renderStage(){
      const t = activeTab();
      stageTitleEl.textContent = (t.name || "UNNAMED");
      stageSubEl.textContent = `// ${t.type} // ${(t.source||"blank").toUpperCase()} // ${t.pins.length} NOTES`;

      imgView.style.display = (t.source === "image") ? "block" : "none";
      iframeView.style.display = (t.source === "url") ? "block" : "none";

      if(t.source === "image"){
        imgView.src = t.imageDataUrl || "";
        iframeView.src = "about:blank";
      }else if(t.source === "url"){
        iframeView.src = t.url || "about:blank";
        imgView.src = "";
      }else{
        imgView.src = "";
        iframeView.src = "about:blank";
      }

      anno.innerHTML = "";
      t.pins.forEach(p=>{
        const pin = document.createElement('div');
        pin.className = "pin" + (p.id===state.activePinId ? " active" : "");
        pin.style.left = (p.x*100) + "%";
        pin.style.top = (p.y*100) + "%";
        pin.title = p.title || "NOTE";

        pin.addEventListener('click', (e)=>{
          e.stopPropagation();
          state.activePinId = p.id;
          openNoteCardForPin(p);
          renderStage();
        });

        let dragging = false;
        const onDown = (e)=>{
          e.preventDefault();
          e.stopPropagation();
          dragging = true;
          document.addEventListener('mousemove', onMove);
          document.addEventListener('mouseup', onUp, { once:true });
        };
        const onMove = (e)=>{
          if(!dragging) return;
          const r = anno.getBoundingClientRect();
          const nx = clamp((e.clientX - r.left)/r.width, 0, 1);
          const ny = clamp((e.clientY - r.top)/r.height, 0, 1);
          p.x = nx; p.y = ny;
          pin.style.left = (nx*100) + "%";
          pin.style.top = (ny*100) + "%";
        };
        const onUp = ()=>{
          dragging = false;
          document.removeEventListener('mousemove', onMove);
          toast("MOVED");
        };
        pin.addEventListener('mousedown', onDown);

        anno.appendChild(pin);
      });
    }

    function renderAll(){
      syncLeft();
      renderTabs();
      renderStage();
      globalNote.value = state.globalNote || "";
    }

    // ---- Image ingest (ONE path used by click/drag/paste) ----
    function loadImageFile(file){
      if(!file) return;
      if(!file.type || !file.type.startsWith("image/")){
        toast("NOT IMAGE");
        return;
      }
      const t = activeTab();
      setSource("image");

      const reader = new FileReader();
      reader.onload = ()=>{
        t.imageDataUrl = String(reader.result || "");
        t.imageName = file.name || "IMAGE";
        state.activePinId = null;
        closeNoteCard();
        renderAll();
        toast("LOADED");
      };
      reader.onerror = ()=>toast("READ ERROR");
      reader.readAsDataURL(file);

      // critical: reset input so selecting the same file again triggers change
      fileInput.value = "";
    }

    // click dropzone -> open file picker
    drop.addEventListener('click', ()=> fileInput.click());
    drop.addEventListener('keydown', (e)=>{
      if(e.key === "Enter" || e.key === " "){
        e.preventDefault();
        fileInput.click();
      }
    });
    fileInput.addEventListener('change', ()=>{
      const f = fileInput.files && fileInput.files[0];
      loadImageFile(f);
    });

    // drag/drop
    drop.addEventListener('dragenter', (e)=>{ e.preventDefault(); drop.classList.add('drag'); });
    drop.addEventListener('dragover', (e)=>{ e.preventDefault(); drop.classList.add('drag'); });
    drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
    drop.addEventListener('drop', (e)=>{
      e.preventDefault();
      drop.classList.remove('drag');
      const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
      loadImageFile(f);
    });

    // paste image from clipboard
    window.addEventListener('paste', (e)=>{
      // don’t hijack paste while typing in inputs/textareas
      if(isTypingTarget(document.activeElement)) return;
      const items = e.clipboardData && e.clipboardData.items ? [...e.clipboardData.items] : [];
      const imgItem = items.find(it=>it.type && it.type.startsWith("image/"));
      if(!imgItem) return;
      const file = imgItem.getAsFile();
      if(file) loadImageFile(file);
    });

    // ---- Pins ----
    function addPinAt(clientX, clientY){
      const t = activeTab();
      const r = anno.getBoundingClientRect();
      const x = clamp((clientX - r.left)/r.width, 0, 1);
      const y = clamp((clientY - r.top)/r.height, 0, 1);

      const p = { id: uid(), x, y, title:"NOTE", glossary:"", component:"", text:"", tags:[] };
      t.pins.push(p);
      state.activePinId = p.id;
      openNoteCardForPin(p);
      renderStage();
      renderTabs();
      toast("PIN");
    }

    anno.addEventListener('dblclick', (e)=>{
      if(isTypingTarget(e.target)) return;
      addPinAt(e.clientX, e.clientY);
    });

    anno.addEventListener('click', ()=>{
      state.activePinId = null;
      closeNoteCard();
      renderStage();
    });

    // ---- Note card ----
    function openNoteCardForPin(p){
      noteCard.classList.add('open');
      nTitle.value = p.title || "";
      nGlossary.value = p.glossary || "";
      nComponent.value = p.component || "";
      nText.value = p.text || "";
      nTags.value = (p.tags || []).join(", ");
      setTimeout(()=>{ nText.focus(); }, 0);
    }
    function closeNoteCard(){ noteCard.classList.remove('open'); }

    ccBtn.addEventListener('click', ()=>{
      if(noteCard.classList.contains('open')) return closeNoteCard();

      const t = activeTab();
      const p = activePin(t);
      if(p) return openNoteCardForPin(p);

      const r = anno.getBoundingClientRect();
      addPinAt(r.left + r.width/2, r.top + r.height/2);
    });
    closeCard.addEventListener('click', closeNoteCard);

    saveNoteBtn.addEventListener('click', ()=>{
      const t = activeTab();
      const p = activePin(t);
      if(!p){ toast("NO NOTE"); return; }
      p.title = (nTitle.value.trim() || "NOTE");
      p.glossary = nGlossary.value;
      p.component = nComponent.value.trim();
      p.text = nText.value;
      p.tags = nTags.value.split(",").map(s=>s.trim()).filter(Boolean);
      renderStage();
      renderTabs();
      toast("SAVED");
    });

    deleteNoteBtn.addEventListener('click', ()=>{
      const t = activeTab();
      if(!state.activePinId){ toast("NO NOTE"); return; }
      t.pins = t.pins.filter(p=>p.id !== state.activePinId);
      state.activePinId = null;
      closeNoteCard();
      renderStage();
      renderTabs();
      toast("DELETED");
    });

    // ---- Left edits ----
    projectEl.addEventListener('input', ()=>{ state.project = projectEl.value; });
    roomEl.addEventListener('change', ()=>{ state.room = roomEl.value; });

    ifaceTypeEl.addEventListener('change', ()=>{
      const t = activeTab();
      t.type = ifaceTypeEl.value;
      renderTabs(); renderStage();
    });

    ifaceNameEl.addEventListener('input', ()=>{
      const t = activeTab();
      t.name = ifaceNameEl.value;
      renderTabs(); renderStage();
    });

    // source chips
    srcImageBtn.addEventListener('click', ()=> setSource('image'));
    srcUrlBtn.addEventListener('click', ()=> setSource('url'));
    srcBlankBtn.addEventListener('click', ()=> setSource('blank'));

    // URL auto-load on Enter / blur
    urlEl.addEventListener('keydown', (e)=>{
      if(e.key === "Enter"){
        e.preventDefault();
        urlEl.blur();
      }
    });
    urlEl.addEventListener('blur', ()=>{
      const t = activeTab();
      t.url = urlEl.value.trim();
      setSource("url");
      toast("LOADED");
    });

    newTabBtn.addEventListener('click', ()=>{
      const t = makeTab();
      state.tabs.unshift(t);
      state.activeTabId = t.id;
      state.activePinId = null;
      closeNoteCard();
      renderAll();
      toast("NEW");
    });

    // ---- Global note modal ----
    function showModal(){
      modalBack.style.display = 'block';
      modalBack.setAttribute('aria-hidden','false');
      globalNote.value = state.globalNote || "";
      setTimeout(()=>{ globalNote.focus(); }, 0);
    }
    function hideModal(){
      modalBack.style.display = 'none';
      modalBack.setAttribute('aria-hidden','true');
    }
    noteIcon.addEventListener('click', showModal);
    closeModal.addEventListener('click', hideModal);
    modalBack.addEventListener('click', (e)=>{ if(e.target===modalBack) hideModal(); });

    saveGlobal.addEventListener('click', ()=>{
      state.globalNote = globalNote.value;
      toast("SAVED");
      hideModal();
    });
    clearGlobal.addEventListener('click', ()=>{
      state.globalNote = "";
      globalNote.value = "";
      toast("CLEARED");
    });

    // ---- Exports ----
    function buildPrompt(){
      const t = activeTab();
      const pack = {
        system: "KETADATA",
        tool: "Annotator",
        project: state.project,
        room: state.room,
        globalNote: state.globalNote || "",
        interface: {
          name: t.name,
          type: t.type,
          source: t.source,
          url: t.url || "",
          pins: t.pins.length
        },
        notes: t.pins.map(p=>({
          id: p.id, x: p.x, y: p.y,
          title: p.title,
          glossary: p.glossary,
          component: p.component,
          tags: p.tags,
          text: p.text
        }))
      };

      return [
        "KETADATA INTERFACE REVISION PROMPT",
        `PROJECT: ${pack.project}`,
        `ROOM CONTEXT: ${pack.room}`,
        `INTERFACE: ${pack.interface.name} (${pack.interface.type}) SOURCE=${pack.interface.source}${pack.interface.url?(" URL="+pack.interface.url):""}`,
        pack.globalNote ? `GLOBAL NOTE: ${pack.globalNote}` : "GLOBAL NOTE: (none)",
        "TASK: Implement changes implied by notes. Preserve black minimalism. Controls off-stage when possible. Hotkeys subtle. Notes are white-square primitives. Ensure state+prompt export compatibility.",
        "NOTES (JSON):",
        JSON.stringify(pack.notes, null, 2)
      ].join("\n");
    }

    function exportState(){
      const safe = JSON.parse(JSON.stringify(state));
      const b64 = encode(safe);
      const url = location.origin + location.pathname + "#state=" + b64;
      return { safe, url };
    }

    exportStateBtn.addEventListener('click', async ()=>{
      const { url } = exportState();
      await copyText(url);
      location.hash = url.split("#")[1];
    });

    exportPromptBtn.addEventListener('click', async ()=>{
      await copyText(buildPrompt());
    });

    // Escape closes overlays (safe)
    window.addEventListener('keydown', (e)=>{
      if(e.key !== 'Escape') return;
      if(noteCard.classList.contains('open')) closeNoteCard();
      if(modalBack.style.display === 'block') hideModal();
    });

    // init
    state.activeTabId = state.activeTabId || state.tabs[0].id;
    renderAll();
  </script>
</body>
</html>
