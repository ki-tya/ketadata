<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KETADATA // CONTRACT DOC</title>

  <!-- =========================================================
       AESTHETIC (SAFE TO EDIT)
       - Black-mode “Google Doc” feel: centered page, crisp type, sharp edges.
       - Do NOT rename IDs used by the ENGINE.
  ========================================================== -->
  <style>
    :root{
      --bg:#000;
      --ink:#fff;
      --muted:#9a9a9a;
      --hair:#1b1b1b;
      --hair2:#2a2a2a;

      --page:#050505;
      --pageEdge:#2a2a2a;

      --sans: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;

      --topH:56px;
      --leftW:360px;
      --rightW:420px;
      --bottomH:180px;
      --split:8px;

      --pageW: 860px;

      /* “Doc” typography */
      --h1: 18px;
      --h2: 12px;
      --body: 12px;
      --lh: 1.6;

      /* Note icon */
      --noteBorder:#fff;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:var(--sans);
      overflow:hidden;
    }

    header{
      height:var(--topH);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 12px;
      border-bottom:1px solid var(--hair);
      background:#000;
      user-select:none;
    }
    .brand{ display:flex; flex-direction:column; line-height:1.05; }
    .brand .top{ font-weight:700; letter-spacing:.14em; font-size:12px; }
    .brand .sub{
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
      letter-spacing:.08em;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:68vw;
    }

    .topActions{ display:flex; gap:10px; align-items:center; }
    .btn{
      border:1px solid var(--hair2);
      background:#000;
      color:var(--ink);
      padding:7px 10px;
      font-size:11px;
      font-family:var(--mono);
      letter-spacing:.06em;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn:hover{ border-color:#3b3b3b; }
    .btn:active{ transform:translateY(1px); }

    /* KETA NOTE icon (top bar) */
    .noteIconBtn{
      width:30px; height:30px;
      border:1px solid var(--hair2);
      background:#000;
      display:grid;
      place-items:center;
      cursor:pointer;
    }
    .noteIconBtn:hover{ border-color:#3b3b3b; }
    .sqIcon{
      width:12px; height:12px;
      border:1px solid var(--noteBorder);
      background:#000; /* visible note -> hollow */
    }
    .sqIcon.filled{ background:#fff; } /* collapsed -> filled */

    /* Layout */
    #viewport{
      height:calc(100% - var(--topH));
      display:grid;
      grid-template-columns: var(--leftW) var(--split) 1fr var(--split) var(--rightW);
      grid-template-rows: 1fr var(--split) var(--bottomH);
    }

    .panel{
      background:#000;
      border:1px solid var(--hair);
      overflow:hidden;
      min-width:240px;
      min-height:140px;
    }
    .panelHeader{
      height:44px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      border-bottom:1px solid var(--hair);
      user-select:none;
    }
    .panelHeader .title{
      font-family:var(--mono);
      font-size:11px;
      letter-spacing:.14em;
    }
    .panelHeader .meta{
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
      letter-spacing:.08em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:60%;
      text-align:right;
    }
    .panelBody{
      height:calc(100% - 44px);
      overflow:auto;
      padding:10px;
    }

    .splitV, .splitH{
      background:#000;
      position:relative;
      cursor:col-resize;
      border-left:1px solid var(--hair);
      border-right:1px solid var(--hair);
    }
    .splitH{
      cursor:row-resize;
      border-left:none; border-right:none;
      border-top:1px solid var(--hair);
      border-bottom:1px solid var(--hair);
      grid-column:1 / span 5;
    }
    .splitV::after{
      content:"";
      position:absolute;
      left:50%; top:8px; bottom:8px;
      width:2px; transform:translateX(-50%);
      background:var(--hair2);
    }
    .splitH::after{
      content:"";
      position:absolute;
      top:50%; left:8px; right:8px;
      height:2px; transform:translateY(-50%);
      background:var(--hair2);
    }

    .hint{
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
      letter-spacing:.06em;
      line-height:1.35;
      margin-bottom:10px;
    }

    /* Doc page */
    #docWrap{
      height:100%;
      display:flex;
      flex-direction:column;
    }
    #docTop{
      height:44px;
      border-bottom:1px solid var(--hair);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      user-select:none;
    }
    #docTop .left{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    #docTop .t{
      font-family:var(--mono);
      font-size:11px;
      letter-spacing:.14em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #docTop .s{
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
      letter-spacing:.08em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #docTop .right{ display:flex; gap:8px; align-items:center; }

    #docStage{
      flex:1 1 auto;
      overflow:auto;
      padding:18px;
      display:flex;
      justify-content:center;
      background:#000;
    }
    #page{
      width:min(var(--pageW), 96%);
      background:var(--page);
      border:1px solid var(--pageEdge);
      padding:22px;
      outline:none;
      box-shadow: 0 0 0 1px #000 inset;
    }

    /* “Google Doc” internal styles */
    .h1{
      font-family:var(--mono);
      font-size:var(--h1);
      letter-spacing:.14em;
      margin:0 0 10px 0;
      text-transform:uppercase;
    }
    .h2{
      font-family:var(--mono);
      font-size:var(--h2);
      letter-spacing:.14em;
      margin:16px 0 8px 0;
      color:#d9d9d9;
      text-transform:uppercase;
    }
    .p{
      font-family:var(--mono);
      font-size:var(--body);
      line-height:var(--lh);
      color:#fff;
      margin:0 0 8px 0;
      white-space:pre-wrap;
    }
    .field{
      border:1px solid var(--hair2);
      background:#000;
      padding:10px;
      margin:8px 0;
    }
    .field .label{
      font-family:var(--mono);
      font-size:10px;
      letter-spacing:.14em;
      color:var(--muted);
      margin-bottom:6px;
      text-transform:uppercase;
    }
    .field input, .field textarea{
      width:100%;
      border:1px solid var(--hair2);
      background:#000;
      color:#fff;
      font-family:var(--mono);
      font-size:11px;
      padding:10px;
      outline:none;
    }
    .field textarea{ min-height:90px; resize:vertical; }
    .row2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }

    .chipbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .chip{
      border:1px solid var(--hair2);
      padding:2px 6px;
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
      user-select:none;
    }

    /* Right panel: preview/export */
    textarea, input, select { outline:none; }
    .box{
      border:1px solid var(--hair);
      padding:10px;
      margin-bottom:10px;
    }
    .label{
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
      letter-spacing:.14em;
      margin-bottom:6px;
      text-transform:uppercase;
    }
    .monoTA{
      width:100%;
      min-height:160px;
      border:1px solid var(--hair2);
      background:#000;
      color:#fff;
      font-family:var(--mono);
      font-size:11px;
      padding:10px;
      resize:vertical;
    }

    /* Bottom rules */
    .kbd{ border:1px solid var(--hair2); padding:2px 6px; color:#fff; font-family:var(--mono); font-size:10px; }

    /* Floating Keta Note */
    #floatNote{
      position:fixed;
      top:calc(var(--topH) + 14px);
      left:14px;
      width:360px;
      height:240px;
      border:1px solid #fff;
      background:#000;
      z-index:50;
      display:flex;
      flex-direction:column;
    }
    #floatNote.hidden{ display:none; }
    #floatNoteHead{
      height:38px;
      border-bottom:1px solid var(--hair);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      cursor:move;
      user-select:none;
      font-family:var(--mono);
      font-size:11px;
      letter-spacing:.12em;
    }
    #floatNoteBody{ padding:10px; height:100%; }
    #floatNoteText{
      height:100%;
      width:100%;
      resize:none;
      border:1px solid var(--hair2);
      background:#000;
      color:#fff;
      font-family:var(--mono);
      font-size:11px;
      padding:8px;
      outline:none;
    }
    .iconBtn{
      width:26px; height:26px;
      border:1px solid var(--hair2);
      display:grid; place-items:center;
      font-family:var(--mono);
      cursor:pointer;
      user-select:none;
      color:#fff;
    }
    .iconBtn:hover{ border-color:#3b3b3b; }
    #floatResizer{
      position:absolute;
      right:2px; bottom:2px;
      width:14px; height:14px;
      border:1px solid var(--hair2);
      cursor:nwse-resize;
    }

    ::-webkit-scrollbar{ width:10px; height:10px; }
    ::-webkit-scrollbar-thumb{ background:#222; border:2px solid #000; }
    ::-webkit-scrollbar-track{ background:#000; }
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <div class="top">KETADATA</div>
      <div class="sub">BLACK DOC // CONTRACT SCHEMA FILLER // EXPORT LAWS</div>
    </div>
    <div class="topActions">
      <div class="noteIconBtn" id="noteIconBtn" title="Toggle KETA NOTE (N)">
        <div class="sqIcon" id="noteIconSq"></div>
      </div>

      <button class="btn" id="newBtn">NEW</button>
      <button class="btn" id="saveBtn">SAVE</button>
      <button class="btn" id="exportJsonBtn">EXPORT JSON</button>
      <button class="btn" id="exportMdBtn">EXPORT MD</button>
      <button class="btn" id="printBtn">PRINT</button>
    </div>
  </header>

  <div id="viewport">
    <!-- LEFT: outline / sections -->
    <section class="panel" style="grid-column:1;grid-row:1;">
      <div class="panelHeader">
        <div class="title">OUTLINE</div>
        <div class="meta" id="outlineMeta">contract v1</div>
      </div>
      <div class="panelBody">
        <div class="hint">
          Click a section to jump. This is a fill-out contract doc; export makes it repo-ready.
        </div>
        <div class="box">
          <div class="label">SECTIONS</div>
          <div id="nav"></div>
          <div class="hint" style="margin-top:10px;">
            Keys: <span class="kbd">Ctrl</span>+<span class="kbd">S</span> save · <span class="kbd">E</span> export json · <span class="kbd">N</span> note
          </div>
        </div>
      </div>
    </section>

    <div class="splitV" id="splitV1" style="grid-column:2;grid-row:1;"></div>

    <!-- CENTER: doc -->
    <main class="panel" style="grid-column:3;grid-row:1;">
      <div id="docWrap">
        <div id="docTop">
          <div class="left">
            <div class="t" id="docTitle">KETADATA CONTRACT // SYSTEM LAWS</div>
            <div class="s" id="docSub">Fill the schema; exports generate a single source of truth.</div>
          </div>
          <div class="right">
            <button class="btn" id="toggleEditBtn">EDIT: ON</button>
            <button class="btn" id="validateBtn">VALIDATE</button>
          </div>
        </div>

        <div id="docStage">
          <div id="page" contenteditable="false" aria-label="KETADATA doc page">
            <div class="h1">KETADATA CONTRACT // SYSTEM LAWS (V1)</div>
            <div class="p">Purpose: single source of truth for folder contracts, UI primitives, export schema, and tool boundaries.</div>
            <div class="chipbar">
              <div class="chip">BLACK MODE</div>
              <div class="chip">ENGINE/AESTHETIC SPLIT</div>
              <div class="chip">EXPORT ALWAYS</div>
              <div class="chip">LOCAL-FIRST</div>
            </div>

            <!-- SECTION: Hosting -->
            <div class="h2" id="sec-hosting">A) HOSTING / REPO</div>
            <div class="field">
              <div class="label">DOMAIN</div>
              <input data-k="hosting.domain" placeholder="e.g. ketadata.com" />
            </div>
            <div class="row2">
              <div class="field">
                <div class="label">HOSTING TYPE</div>
                <input data-k="hosting.type" placeholder="e.g. GitHub Pages" />
              </div>
              <div class="field">
                <div class="label">REPO NAME</div>
                <input data-k="hosting.repo" placeholder="e.g. ki-tya/ketadata" />
              </div>
            </div>

            <!-- SECTION: Canon folder contract -->
            <div class="h2" id="sec-folders">B) CANON FOLDER CONTRACT</div>
            <div class="field">
              <div class="label">ROOT FOLDERS (ONE PER LINE)</div>
              <textarea data-k="folders.roots" placeholder="blackbooks/\nstudio/\nlab/\nassets/"></textarea>
            </div>
            <div class="field">
              <div class="label">NAMING LAW</div>
              <textarea data-k="folders.namingLaw" placeholder="Rules: lowercase, no spaces, stable IDs, page_###.jpg, etc."></textarea>
            </div>

            <!-- SECTION: Blackbooks contract -->
            <div class="h2" id="sec-blackbooks">C) BLACK BOOKS CONTRACT</div>
            <div class="row2">
              <div class="field">
                <div class="label">BLACKBOOKS ROOT PATH</div>
                <input data-k="blackbooks.root" placeholder="blackbooks" />
              </div>
              <div class="field">
                <div class="label">PAGES SUBPATH</div>
                <input data-k="blackbooks.pagesSubpath" placeholder="pages" />
              </div>
            </div>
            <div class="row2">
              <div class="field">
                <div class="label">FILENAME PATTERN</div>
                <input data-k="blackbooks.filenamePattern" placeholder="page_###.jpg" />
              </div>
              <div class="field">
                <div class="label">PAD DIGITS</div>
                <input data-k="blackbooks.pad" placeholder="3" />
              </div>
            </div>
            <div class="field">
              <div class="label">BOOK IDS + TITLES (ONE PER LINE: id | title)</div>
              <textarea data-k="blackbooks.books" placeholder="bb01 | BLACK BOOK I\nbb02 | BLACK BOOK II\nbb03 | BLACK BOOK III\n..."></textarea>
            </div>

            <!-- SECTION: UI primitives -->
            <div class="h2" id="sec-ui">D) UI PRIMITIVES</div>
            <div class="row2">
              <div class="field">
                <div class="label">TOP BAR HEIGHT (PX)</div>
                <input data-k="ui.topBarHeight" placeholder="56" />
              </div>
              <div class="field">
                <div class="label">DEFAULT PANEL SIZES</div>
                <input data-k="ui.panelDefaults" placeholder="leftW=320,rightW=420,bottomH=180" />
              </div>
            </div>
            <div class="field">
              <div class="label">KETA NOTE RULE</div>
              <textarea data-k="ui.ketaNoteRule" placeholder="Icon in top bar. Filled when note collapsed. Movable/resizable. Persist via localStorage."></textarea>
            </div>
            <div class="field">
              <div class="label">GLOBAL CONTROLS RULE</div>
              <textarea data-k="ui.controlsRule" placeholder="Controls drawer: hide/show; intensity sliders; engine safe."></textarea>
            </div>

            <!-- SECTION: Export schema -->
            <div class="h2" id="sec-export">E) EXPORT / STATE SCHEMA</div>
            <div class="field">
              <div class="label">REQUIRED KEYS (ONE PER LINE)</div>
              <textarea data-k="export.requiredKeys" placeholder="version\npageId\ncreatedAt\nupdatedAt\nlayout\nketaNote\npayload"></textarea>
            </div>
            <div class="field">
              <div class="label">EXPORT RULES</div>
              <textarea data-k="export.rules" placeholder="Every tool exports JSON state + tool payload. Must be repo-ready. No secrets in client."></textarea>
            </div>

            <!-- SECTION: Engine vs aesthetic -->
            <div class="h2" id="sec-engine">F) ENGINE VS AESTHETIC SPLIT</div>
            <div class="field">
              <div class="label">ENGINE DEFINITION</div>
              <textarea data-k="dev.engineDefinition" placeholder="Engine: functional logic, data IO, exports, validators. Must not break."></textarea>
            </div>
            <div class="field">
              <div class="label">AESTHETIC DEFINITION</div>
              <textarea data-k="dev.aestheticDefinition" placeholder="Aesthetic: CSS + layout polish. Safe to edit without breaking engine."></textarea>
            </div>

            <!-- SECTION: Constraints -->
            <div class="h2" id="sec-constraints">G) SYSTEM-WIDE CONSTRAINTS</div>
            <div class="field">
              <div class="label">HARD NO’S</div>
              <textarea data-k="constraints.hardNos" placeholder="No rounded corners. No kitsch. No hidden dependencies. No scroll-jank."></textarea>
            </div>
            <div class="field">
              <div class="label">PERFORMANCE / SIZE LIMITS</div>
              <textarea data-k="constraints.performance" placeholder="e.g., viewer must handle 200 pages/book, lazy-load thumbs, avoid OOM."></textarea>
            </div>

            <div class="h2" id="sec-done">H) DONE CONDITION</div>
            <div class="field">
              <div class="label">WHAT “DONE” MEANS</div>
              <textarea data-k="done.definition" placeholder="e.g., All tools adhere to contract, validator passes, exports round-trip."></textarea>
            </div>

            <div class="p" style="margin-top:14px;color:var(--muted);">
              End. Export JSON becomes <span style="color:#fff;">KETADATA_LAWS.json</span> (or MD) and is the canonical reference for future builds.
            </div>
          </div>
        </div>
      </div>
    </main>

    <div class="splitV" id="splitV2" style="grid-column:4;grid-row:1;"></div>

    <!-- RIGHT: preview / staged export -->
    <section class="panel" style="grid-column:5;grid-row:1;">
      <div class="panelHeader">
        <div class="title">PREVIEW / EXPORT</div>
        <div class="meta" id="rightMeta">staged</div>
      </div>
      <div class="panelBody">
        <div class="box">
          <div class="label">JSON PREVIEW</div>
          <textarea id="jsonPreview" class="monoTA" readonly></textarea>
        </div>
        <div class="box">
          <div class="label">MARKDOWN PREVIEW</div>
          <textarea id="mdPreview" class="monoTA" readonly></textarea>
        </div>
        <div class="box">
          <div class="label">VALIDATION</div>
          <textarea id="valPreview" class="monoTA" readonly></textarea>
        </div>
      </div>
    </section>

    <div class="splitH" id="splitH" style="grid-row:2;"></div>

    <!-- BOTTOM: system-wide rules / references -->
    <section class="panel" style="grid-column:1 / span 5;grid-row:3;">
      <div class="panelHeader">
        <div class="title">SYSTEM WIDE RULES / REFERENCES</div>
        <div class="meta" id="bottomMeta">live</div>
      </div>
      <div class="panelBody">
        <div class="hint">
          Paste external reference snippets, invariants, and any “never again” bugs. This area exports with the contract.
        </div>
        <textarea id="bottomRules" class="monoTA" placeholder="SYSTEM RULES:\n- ...\nREFERENCES:\n- ..."></textarea>
      </div>
    </section>
  </div>

  <!-- Floating Keta Note -->
  <div id="floatNote">
    <div id="floatNoteHead">
      <div style="display:flex;gap:10px;align-items:center;">
        <div style="width:10px;height:10px;border:1px solid #fff;background:#000;"></div>
        <div>KETA NOTE</div>
      </div>
      <div style="display:flex;gap:8px;">
        <div class="iconBtn" id="noteMinBtn" title="collapse">–</div>
        <div class="iconBtn" id="noteCloseBtn" title="hide">×</div>
      </div>
    </div>
    <div id="floatNoteBody">
      <textarea id="floatNoteText" placeholder="GLOBAL NOTE // decisions, deviations, next actions"></textarea>
    </div>
    <div id="floatResizer"></div>
  </div>

  <!-- =========================================================
       ENGINE (FUNCTIONAL LOGIC)
       - Collect schema fields from the doc
       - Autosave localStorage
       - Export JSON + MD
       - Validate minimum required fields
       - Resizable panels + floating note
  ========================================================== -->
  <script>
    const $ = (id)=>document.getElementById(id);

    const els = {
      noteIconBtn:$("noteIconBtn"), noteIconSq:$("noteIconSq"),
      newBtn:$("newBtn"), saveBtn:$("saveBtn"),
      exportJsonBtn:$("exportJsonBtn"), exportMdBtn:$("exportMdBtn"),
      printBtn:$("printBtn"),

      splitV1:$("splitV1"), splitV2:$("splitV2"), splitH:$("splitH"),
      outlineMeta:$("outlineMeta"),
      nav:$("nav"),

      toggleEditBtn:$("toggleEditBtn"),
      validateBtn:$("validateBtn"),
      page:$("page"),
      docTitle:$("docTitle"),
      docSub:$("docSub"),

      jsonPreview:$("jsonPreview"),
      mdPreview:$("mdPreview"),
      valPreview:$("valPreview"),

      bottomRules:$("bottomRules"),
      bottomMeta:$("bottomMeta"),
      rightMeta:$("rightMeta"),

      floatNote:$("floatNote"), floatNoteHead:$("floatNoteHead"),
      floatNoteText:$("floatNoteText"),
      noteMinBtn:$("noteMinBtn"), noteCloseBtn:$("noteCloseBtn"),
      floatResizer:$("floatResizer"),
    };

    function hardFail(msg){
      document.body.innerHTML = `<pre style="padding:16px;background:#000;color:#fff;font-family:monospace;">${msg}</pre>`;
      throw new Error(msg);
    }
    (function assert(){
      const miss = Object.entries(els).filter(([k,v])=>!v).map(([k])=>k);
      if(miss.length) hardFail("WIRING ERROR:\n"+miss.join("\n"));
    })();

    const STORAGE_KEY = "ketadata_contract_doc_v1";

    const STATE = {
      version:"ketadata-contract-doc-v1",
      createdAt:null,
      updatedAt:null,
      editable:true,

      layout:{ leftW:360, rightW:420, bottomH:180 },

      contract:{},
      bottomRules:"",
      ketaNote:""
    };

    function nowISO(){ return new Date().toISOString(); }
    function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
    function setCSSVar(name, px){ document.documentElement.style.setProperty(name, px + "px"); }

    function save(){
      STATE.updatedAt = nowISO();
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE)); }catch{}
      renderPreviews();
    }
    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const s = JSON.parse(raw);
        if(s && s.version === STATE.version){
          Object.assign(STATE, s);
        }
      }catch{}
    }

    // ---- Schema binding ----
    function setByPath(obj, path, value){
      const parts = path.split(".");
      let cur = obj;
      for(let i=0;i<parts.length-1;i++){
        const k = parts[i];
        if(!(k in cur) || typeof cur[k] !== "object" || cur[k] === null) cur[k] = {};
        cur = cur[k];
      }
      cur[parts[parts.length-1]] = value;
    }
    function getByPath(obj, path){
      const parts = path.split(".");
      let cur = obj;
      for(const k of parts){
        if(!cur || typeof cur !== "object" || !(k in cur)) return undefined;
        cur = cur[k];
      }
      return cur;
    }

    function collectContract(){
      const fields = els.page.querySelectorAll("[data-k]");
      const out = {};
      fields.forEach(el=>{
        const key = el.getAttribute("data-k");
        const val = (el.value ?? "").toString();
        setByPath(out, key, val);
      });
      // attach bottom rules
      out.references = out.references || {};
      out.references.bottomPanel = els.bottomRules.value || "";
      STATE.contract = out;
    }

    function hydrateContract(){
      const fields = els.page.querySelectorAll("[data-k]");
      fields.forEach(el=>{
        const key = el.getAttribute("data-k");
        const v = getByPath(STATE.contract, key);
        if(typeof v === "string") el.value = v;
      });
      els.bottomRules.value = STATE.contract?.references?.bottomPanel || STATE.bottomRules || "";
      els.floatNoteText.value = STATE.ketaNote || "";
    }

    // ---- Export formats ----
    function toJSON(){
      collectContract();
      const out = {
        version: STATE.version,
        createdAt: STATE.createdAt,
        updatedAt: STATE.updatedAt,
        contract: STATE.contract,
        ketaNote: STATE.ketaNote
      };
      return JSON.stringify(out, null, 2);
    }

    function linesFromTextarea(v){
      return (v||"").split("\n").map(s=>s.trim()).filter(Boolean);
    }

    function toMD(){
      collectContract();
      const c = STATE.contract || {};
      const md = [];
      md.push("# KETADATA CONTRACT // SYSTEM LAWS (V1)");
      md.push("");
      md.push(`- createdAt: ${STATE.createdAt || ""}`);
      md.push(`- updatedAt: ${STATE.updatedAt || ""}`);
      md.push("");
      md.push("## A) Hosting / Repo");
      md.push(`- domain: ${c.hosting?.domain || ""}`);
      md.push(`- hosting: ${c.hosting?.type || ""}`);
      md.push(`- repo: ${c.hosting?.repo || ""}`);
      md.push("");
      md.push("## B) Canon Folder Contract");
      md.push("**roots:**");
      (linesFromTextarea(c.folders?.roots||"")).forEach(x=>md.push(`- ${x}`));
      md.push("");
      md.push("**naming law:**");
      md.push("```");
      md.push(c.folders?.namingLaw || "");
      md.push("```");
      md.push("");
      md.push("## C) Black Books Contract");
      md.push(`- root: ${c.blackbooks?.root || ""}`);
      md.push(`- pagesSubpath: ${c.blackbooks?.pagesSubpath || ""}`);
      md.push(`- filenamePattern: ${c.blackbooks?.filenamePattern || ""}`);
      md.push(`- pad: ${c.blackbooks?.pad || ""}`);
      md.push("");
      md.push("**books:**");
      md.push("```");
      md.push(c.blackbooks?.books || "");
      md.push("```");
      md.push("");
      md.push("## D) UI Primitives");
      md.push(`- topBarHeight: ${c.ui?.topBarHeight || ""}`);
      md.push(`- panelDefaults: ${c.ui?.panelDefaults || ""}`);
      md.push("");
      md.push("**keta note rule:**");
      md.push("```");
      md.push(c.ui?.ketaNoteRule || "");
      md.push("```");
      md.push("");
      md.push("**controls rule:**");
      md.push("```");
      md.push(c.ui?.controlsRule || "");
      md.push("```");
      md.push("");
      md.push("## E) Export / State Schema");
      md.push("**required keys:**");
      (linesFromTextarea(c.export?.requiredKeys||"")).forEach(x=>md.push(`- ${x}`));
      md.push("");
      md.push("**export rules:**");
      md.push("```");
      md.push(c.export?.rules || "");
      md.push("```");
      md.push("");
      md.push("## F) Engine vs Aesthetic");
      md.push("**engine:**");
      md.push("```");
      md.push(c.dev?.engineDefinition || "");
      md.push("```");
      md.push("");
      md.push("**aesthetic:**");
      md.push("```");
      md.push(c.dev?.aestheticDefinition || "");
      md.push("```");
      md.push("");
      md.push("## G) System-wide Constraints");
      md.push("**hard no’s:**");
      md.push("```");
      md.push(c.constraints?.hardNos || "");
      md.push("```");
      md.push("");
      md.push("**performance:**");
      md.push("```");
      md.push(c.constraints?.performance || "");
      md.push("```");
      md.push("");
      md.push("## H) Done Condition");
      md.push("```");
      md.push(c.done?.definition || "");
      md.push("```");
      md.push("");
      md.push("## Bottom Panel (Rules / References)");
      md.push("```");
      md.push(c.references?.bottomPanel || "");
      md.push("```");
      md.push("");
      md.push("## Keta Note");
      md.push("```");
      md.push(STATE.ketaNote || "");
      md.push("```");
      return md.join("\n");
    }

    // ---- Validation ----
    function validate(){
      collectContract();
      const c = STATE.contract || {};
      const issues = [];

      const req = (p, label)=>{
        const v = getByPath(c, p);
        if(!v || !String(v).trim()) issues.push(`MISSING: ${label} (${p})`);
      };

      req("hosting.domain", "domain");
      req("hosting.type", "hosting type");
      req("hosting.repo", "repo");
      req("blackbooks.root", "blackbooks root");
      req("blackbooks.pagesSubpath", "pages subpath");
      req("blackbooks.filenamePattern", "filename pattern");
      req("blackbooks.pad", "pad digits");
      req("export.requiredKeys", "export required keys");

      // sanity: pad is numeric
      const pad = parseInt(c.blackbooks?.pad || "", 10);
      if(!pad || pad < 2 || pad > 6) issues.push("BAD: blackbooks.pad should be a number between 2 and 6");

      // books lines format check
      const books = linesFromTextarea(c.blackbooks?.books || "");
      if(!books.length) issues.push("MISSING: blackbooks.books (at least one line)");
      else{
        const bad = books.filter(line => !line.includes("|"));
        if(bad.length) issues.push(`BAD: blackbooks.books lines should be "id | title" (bad lines: ${bad.length})`);
      }

      // required keys list must include payload
      const keys = linesFromTextarea(c.export?.requiredKeys || "");
      if(keys.length && !keys.includes("payload")) issues.push('BAD: export.requiredKeys should include "payload"');

      const out = issues.length ? issues.join("\n") : "VALIDATION: PASS";
      els.valPreview.value = out;
      els.rightMeta.textContent = issues.length ? "issues" : "clean";
      return { ok: !issues.length, issues };
    }

    function renderPreviews(){
      els.jsonPreview.value = toJSON();
      els.mdPreview.value = toMD();
      els.bottomMeta.textContent = "live";
    }

    // ---- Outline nav ----
    const NAV = [
      { id:"sec-hosting", label:"A) HOSTING / REPO" },
      { id:"sec-folders", label:"B) FOLDER CONTRACT" },
      { id:"sec-blackbooks", label:"C) BLACK BOOKS" },
      { id:"sec-ui", label:"D) UI PRIMITIVES" },
      { id:"sec-export", label:"E) EXPORT SCHEMA" },
      { id:"sec-engine", label:"F) ENGINE VS AESTHETIC" },
      { id:"sec-constraints", label:"G) CONSTRAINTS" },
      { id:"sec-done", label:"H) DONE" },
    ];

    function renderNav(){
      els.nav.innerHTML = "";
      NAV.forEach(n=>{
        const b = document.createElement("button");
        b.className = "btn";
        b.style.width = "100%";
        b.style.marginBottom = "8px";
        b.textContent = n.label;
        b.addEventListener("click", ()=>{
          const target = document.getElementById(n.id);
          if(target) target.scrollIntoView({behavior:"smooth", block:"start"});
        });
        els.nav.appendChild(b);
      });
    }

    // ---- Editable mode ----
    function setEditable(on){
      STATE.editable = !!on;
      els.page.setAttribute("contenteditable", "false"); // keep layout stable
      // We edit via inputs/textarea only; lock/unlock those.
      const inputs = els.page.querySelectorAll("input, textarea");
      inputs.forEach(el=> el.disabled = !STATE.editable);
      els.toggleEditBtn.textContent = `EDIT: ${STATE.editable ? "ON" : "OFF"}`;
      save();
    }

    // ---- Downloads ----
    function downloadText(filename, text){
      const blob = new Blob([text], {type:"text/plain"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
    }

    // ---- Keta note toggle ----
    let noteVisible = true;
    function setNoteIconState(){ els.noteIconSq.classList.toggle("filled", !noteVisible); }
    function showNote(){ noteVisible=true; els.floatNote.classList.remove("hidden"); setNoteIconState(); }
    function hideNote(){ noteVisible=false; els.floatNote.classList.add("hidden"); setNoteIconState(); }
    function toggleNote(){ noteVisible ? hideNote() : showNote(); }

    // draggable + resizable note
    (function noteMove(){
      let dragging=false, sx=0, sy=0, sl=0, st=0;
      els.floatNoteHead.addEventListener("mousedown", (e)=>{
        if(e.target === els.noteMinBtn || e.target === els.noteCloseBtn) return;
        dragging=true;
        const r = els.floatNote.getBoundingClientRect();
        sl=r.left; st=r.top; sx=e.clientX; sy=e.clientY;
        document.addEventListener("mousemove", mv);
        document.addEventListener("mouseup", up);
        e.preventDefault();
      });
      function mv(e){
        if(!dragging) return;
        els.floatNote.style.left = (sl + (e.clientX - sx)) + "px";
        els.floatNote.style.top  = (st + (e.clientY - sy)) + "px";
      }
      function up(){
        dragging=false;
        document.removeEventListener("mousemove", mv);
        document.removeEventListener("mouseup", up);
      }
    })();

    (function noteResize(){
      let resizing=false, sx=0, sy=0, sw=0, sh=0;
      els.floatResizer.addEventListener("mousedown", (e)=>{
        e.preventDefault();
        resizing=true;
        const r = els.floatNote.getBoundingClientRect();
        sw=r.width; sh=r.height; sx=e.clientX; sy=e.clientY;
        document.addEventListener("mousemove", mv);
        document.addEventListener("mouseup", up);
      });
      function mv(e){
        if(!resizing) return;
        els.floatNote.style.width  = Math.max(260, sw + (e.clientX - sx)) + "px";
        els.floatNote.style.height = Math.max(160, sh + (e.clientY - sy)) + "px";
      }
      function up(){
        resizing=false;
        document.removeEventListener("mousemove", mv);
        document.removeEventListener("mouseup", up);
      }
    })();

    // ---- Resizable panels ----
    function wireSplitters(){
      // left
      let dv=false, sx=0, start=0;
      els.splitV1.addEventListener("mousedown",(e)=>{
        dv=true; sx=e.clientX;
        start = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--leftW")) || 360;
        document.addEventListener("mousemove", mv);
        document.addEventListener("mouseup", up);
        e.preventDefault();
      });
      function mv(e){
        if(!dv) return;
        const next = clamp(start + (e.clientX - sx), 280, 760);
        setCSSVar("--leftW", next);
        STATE.layout.leftW = next;
      }
      function up(){
        dv=false;
        document.removeEventListener("mousemove", mv);
        document.removeEventListener("mouseup", up);
        save();
      }

      // right
      let dv2=false, sx2=0, start2=0;
      els.splitV2.addEventListener("mousedown",(e)=>{
        dv2=true; sx2=e.clientX;
        start2 = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--rightW")) || 420;
        document.addEventListener("mousemove", mv2);
        document.addEventListener("mouseup", up2);
        e.preventDefault();
      });
      function mv2(e){
        if(!dv2) return;
        const next = clamp(start2 - (e.clientX - sx2), 320, 900);
        setCSSVar("--rightW", next);
        STATE.layout.rightW = next;
      }
      function up2(){
        dv2=false;
        document.removeEventListener("mousemove", mv2);
        document.removeEventListener("mouseup", up2);
        save();
      }

      // bottom
      let dh=false, sy=0, startH=0;
      els.splitH.addEventListener("mousedown",(e)=>{
        dh=true; sy=e.clientY;
        startH = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--bottomH")) || 180;
        document.addEventListener("mousemove", mh);
        document.addEventListener("mouseup", uh);
        e.preventDefault();
      });
      function mh(e){
        if(!dh) return;
        const next = clamp(startH - (e.clientY - sy), 140, 480);
        setCSSVar("--bottomH", next);
        STATE.layout.bottomH = next;
      }
      function uh(){
        dh=false;
        document.removeEventListener("mousemove", mh);
        document.removeEventListener("mouseup", uh);
        save();
      }
    }

    // ---- Events ----
    els.noteIconBtn.addEventListener("click", toggleNote);
    els.noteMinBtn.addEventListener("click", hideNote);
    els.noteCloseBtn.addEventListener("click", hideNote);

    els.floatNoteText.addEventListener("input", ()=>{
      STATE.ketaNote = els.floatNoteText.value || "";
      save();
    });

    els.bottomRules.addEventListener("input", ()=>{
      // store in STATE and also mirrors into contract.references.bottomPanel on export
      STATE.bottomRules = els.bottomRules.value || "";
      save();
    });

    // Any schema field change -> autosave
    els.page.addEventListener("input", (e)=>{
      const t = e.target;
      if(t && t.matches && t.matches("[data-k]")) save();
    });

    els.newBtn.addEventListener("click", ()=>{
      if(!confirm("Reset contract fields? (local draft will be overwritten)")) return;
      STATE.contract = {};
      STATE.ketaNote = "";
      STATE.bottomRules = "";
      STATE.createdAt = nowISO();
      STATE.updatedAt = nowISO();
      hydrateContract();
      renderPreviews();
      els.valPreview.value = "";
    });

    els.saveBtn.addEventListener("click", ()=>{
      if(!STATE.createdAt) STATE.createdAt = nowISO();
      collectContract();
      // ensure bottom panel stored in contract.references.bottomPanel
      STATE.contract.references = STATE.contract.references || {};
      STATE.contract.references.bottomPanel = els.bottomRules.value || "";
      save();
    });

    els.exportJsonBtn.addEventListener("click", ()=>{
      if(!STATE.createdAt) STATE.createdAt = nowISO();
      validate();
      downloadText("KETADATA_LAWS.json", toJSON());
    });

    els.exportMdBtn.addEventListener("click", ()=>{
      if(!STATE.createdAt) STATE.createdAt = nowISO();
      validate();
      downloadText("KETADATA_LAWS.md", toMD());
    });

    els.printBtn.addEventListener("click", ()=> window.print());

    els.toggleEditBtn.addEventListener("click", ()=> setEditable(!STATE.editable));
    els.validateBtn.addEventListener("click", validate);

    // Keybinds
    document.addEventListener("keydown",(e)=>{
      const tag = (document.activeElement?.tagName || "").toLowerCase();
      const typing = tag === "input" || tag === "textarea" || tag === "select";
      if(e.key.toLowerCase()==="n") toggleNote();
      if(!typing && e.key.toLowerCase()==="e") els.exportJsonBtn.click();
      if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="s"){
        e.preventDefault();
        els.saveBtn.click();
      }
    });

    // ---- Boot ----
    (function boot(){
      load();
      if(!STATE.createdAt) STATE.createdAt = nowISO();
      if(STATE.layout?.leftW) setCSSVar("--leftW", STATE.layout.leftW);
      if(STATE.layout?.rightW) setCSSVar("--rightW", STATE.layout.rightW);
      if(STATE.layout?.bottomH) setCSSVar("--bottomH", STATE.layout.bottomH);

      renderNav();
      hydrateContract();
      setEditable(STATE.editable !== false);
      setNoteIconState();
      wireSplitters();
      renderPreviews();
      validate();
    })();
  </script>
</body>
</html>
