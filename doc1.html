<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KETADATA DOC</title>
  <style>
    :root{
      --BG:#000;
      --FG:#fff;
      --MUTED:rgba(255,255,255,0.35);
      --HAIR:rgba(255,255,255,0.12);
      --HAIR2:rgba(255,255,255,0.20);
      --PANEL:rgba(255,255,255,0.04);
      --PANEL2:rgba(255,255,255,0.06);
      --MAXW: 980px;
      --PAD: 28px;
    }
    html,body{height:100%;margin:0;background:var(--BG);color:var(--FG);font-family:Arial,Helvetica,sans-serif;overflow:hidden;}
    *{box-sizing:border-box;}
    ::selection{background:rgba(255,255,255,0.18);color:#fff;}

    /* ===== LAYOUT ===== */
    .topbar{
      position:fixed;left:0;top:0;right:0;height:64px;
      display:flex;align-items:center;gap:12px;
      padding:0 16px;border-bottom:1px solid var(--HAIR);
      background:rgba(0,0,0,0.92);
      z-index:50;user-select:none;
    }
    .brand{
      display:flex;align-items:center;gap:10px;min-width:260px;max-width:520px;
    }
    .sq{width:14px;height:14px;background:#fff;flex:0 0 auto;}
    .brandText{display:flex;flex-direction:column;gap:3px;min-width:0;}
    .brandTitle{
      font-size:12px;letter-spacing:0.28em;text-transform:uppercase;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .brandMeta{
      font-size:10px;letter-spacing:0.22em;text-transform:uppercase;color:var(--MUTED);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }

    .barBtns{display:flex;align-items:center;gap:8px;flex:1 1 auto;min-width:0;overflow:hidden;}
    .btn{
      border:1px solid var(--HAIR);
      background:var(--PANEL);
      color:var(--FG);
      padding:8px 10px;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      cursor:pointer;
      border-radius:0;
      white-space:nowrap;
    }
    .btn:hover{border-color:var(--HAIR2);background:var(--PANEL2);}
    .btn:active{transform:translateY(1px);}
    .btn.ghost{background:transparent;border-color:transparent;color:var(--MUTED);}
    .btn.ghost:hover{border-color:var(--HAIR);color:var(--FG);}
    .sep{width:1px;height:26px;background:var(--HAIR);margin:0 2px;flex:0 0 auto;}
    .status{
      font-size:10px;letter-spacing:0.24em;text-transform:uppercase;color:var(--MUTED);
      white-space:nowrap;
    }

    .wrap{
      position:fixed;left:0;right:0;top:64px;bottom:0;
      display:grid;grid-template-columns: 260px 1fr 320px;
      overflow:hidden;
    }
    .left, .right{
      background:rgba(255,255,255,0.02);
      border-color:var(--HAIR);
      overflow:auto;
    }
    .left{border-right:1px solid var(--HAIR);padding:14px 12px;}
    .right{border-left:1px solid var(--HAIR);padding:14px 12px;}

    .panelH{
      font-size:10px;letter-spacing:0.26em;text-transform:uppercase;color:var(--MUTED);
      margin:10px 6px 8px;
    }
    .kv{
      border:1px solid var(--HAIR);background:rgba(0,0,0,0.25);
      padding:12px;margin:8px 6px 14px;
    }
    .k{font-size:10px;letter-spacing:0.22em;text-transform:uppercase;color:var(--MUTED);margin-bottom:6px;}
    .v{font-size:12px;letter-spacing:0.08em;color:rgba(255,255,255,0.85);word-break:break-word;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;font-size:12px;line-height:1.45;white-space:pre-wrap;}

    .center{
      overflow:auto;
      padding:26px 18px 40px;
      background:
        radial-gradient(circle at 50% 0%, rgba(255,255,255,0.05), transparent 52%),
        linear-gradient(to bottom, rgba(255,255,255,0.02), rgba(0,0,0,0) 80%);
    }
    .page{
      width:min(var(--MAXW), 100%);
      margin:0 auto;
      border:1px solid var(--HAIR);
      outline:1px solid rgba(255,255,255,0.06);
      border-radius:0;
      background:transparent;
    }
    .pageInner{padding:var(--PAD);min-height:1200px;}

    .docHead{
      display:flex;justify-content:space-between;align-items:flex-end;gap:16px;
      border-bottom:1px solid var(--HAIR);
      padding-bottom:14px;margin-bottom:18px;
    }
    .docTitle{
      font-size:18px;letter-spacing:0.24em;text-transform:uppercase;margin:0;line-height:1.1;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:72%;
      cursor:text;
    }
    .docTitle:focus{outline:none;border-bottom:1px solid var(--HAIR2);}
    .docMeta{
      font-size:10px;letter-spacing:0.22em;text-transform:uppercase;color:var(--MUTED);
      text-align:right;white-space:nowrap;
    }

    /* ===== EDITOR (THE DOC BODY) ===== */
    .editor{
      outline:none;
      caret-color:#fff;
      font-size:16px;
      line-height:1.55;
      letter-spacing:0.02em;
    }
    .editor p{margin:0 0 14px;}
    .editor h2{
      margin:26px 0 10px;
      font-size:12px;
      letter-spacing:0.26em;
      text-transform:uppercase;
      font-weight:700;
    }
    .editor h3{
      margin:20px 0 8px;
      font-size:11px;
      letter-spacing:0.20em;
      text-transform:uppercase;
      font-weight:700;
      color:rgba(255,255,255,0.85);
    }
    .editor blockquote{
      margin:16px 0;
      padding:10px 14px;
      border-left:2px solid rgba(255,255,255,0.25);
      background:rgba(255,255,255,0.03);
      color:rgba(255,255,255,0.78);
    }
    .editor pre{
      margin:14px 0 18px;
      padding:14px;
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.10);
      overflow:auto;
    }
    .editor code{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
      font-size:13px;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      padding:2px 6px;
      border-radius:0;
    }

    /* ===== KETA_NOTE (MOVABLE, HIDEABLE) ===== */
    .ketaNote{
      position:fixed;
      left:18px;
      bottom:18px;
      width: 420px;
      max-width: calc(100vw - 36px);
      height: 220px;
      max-height: calc(100vh - 110px);
      border:1px solid var(--HAIR);
      background:rgba(0,0,0,0.90);
      z-index:200;
      display:flex;
      flex-direction:column;
      box-shadow:none;
    }
    .ketaNoteBar{
      display:flex;align-items:center;gap:8px;
      padding:10px;
      border-bottom:1px solid var(--HAIR);
      cursor:move;
      user-select:none;
      background:rgba(255,255,255,0.03);
    }
    .ketaNoteTitle{
      font-size:10px;
      letter-spacing:0.26em;
      text-transform:uppercase;
      flex:1 1 auto;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .ketaNoteBtn{
      border:1px solid var(--HAIR);
      background:rgba(255,255,255,0.04);
      color:var(--FG);
      padding:6px 8px;
      font-size:10px;
      letter-spacing:0.22em;
      text-transform:uppercase;
      cursor:pointer;
      border-radius:0;
    }
    .ketaNoteBtn:hover{border-color:var(--HAIR2);background:rgba(255,255,255,0.06);}
    .ketaNoteBtn:active{transform:translateY(1px);}
    .ketaNoteBody{
      padding:10px;
      flex:1 1 auto;
      overflow:auto;
    }
    .ketaNoteText{
      width:100%;
      height:100%;
      resize:none;
      border:none;
      outline:none;
      background:transparent;
      color:var(--FG);
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
      font-size:12px;
      line-height:1.45;
      letter-spacing:0.08em;
    }
    .ketaNoteFooter{
      border-top:1px solid var(--HAIR);
      padding:8px 10px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      color:var(--MUTED);
      font-size:10px;
      letter-spacing:0.22em;
      text-transform:uppercase;
      user-select:none;
    }
    .ketaNoteHidden{display:none;}

    /* ===== FOCUS MODE ===== */
    .focus .left, .focus .right{display:none;}
    .focus .wrap{grid-template-columns: 1fr;}
    .focus .hint{display:none;}

    .hint{
      position:fixed;
      right:16px;
      top:74px;
      z-index:60;
      font-size:10px;
      letter-spacing:0.24em;
      color:var(--MUTED);
      text-transform:uppercase;
      background:rgba(0,0,0,0.55);
      border:1px solid var(--HAIR);
      padding:8px 10px;
      user-select:none;
      pointer-events:none;
    }

    @media (max-width: 1100px){
      .wrap{grid-template-columns: 1fr;}
      .left,.right,.hint{display:none;}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="sq" title="INVARIANT"></div>
      <div class="brandText">
        <div class="brandTitle" id="brandTitle">KETADATA DOC</div>
        <div class="brandMeta" id="brandMeta">SOVEREIGN PAGE · LOCAL STATE · EXPORTABLE</div>
      </div>
    </div>

    <div class="barBtns">
      <button class="btn" id="bBold" title="CTRL+B">B</button>
      <button class="btn" id="bItalic" title="CTRL+I">I</button>
      <button class="btn" id="bUnderline" title="CTRL+U">U</button>
      <div class="sep"></div>
      <button class="btn" id="bH2">H2</button>
      <button class="btn" id="bH3">H3</button>
      <button class="btn" id="bQuote">QUOTE</button>
      <button class="btn" id="bPre">PRE</button>
      <div class="sep"></div>
      <button class="btn" id="bExport" title="CTRL+E">EXPORT</button>
      <button class="btn ghost" id="bImport" title="CTRL+SHIFT+E">IMPORT</button>
      <button class="btn ghost" id="bClear" title="CTRL+SHIFT+X">CLEAR</button>
      <div class="sep"></div>
      <button class="btn ghost" id="bToggleNote" title="N">NOTE</button>
      <button class="btn ghost" id="bFocus" title="F">FOCUS</button>
    </div>

    <div class="status" id="status">LOCAL</div>
  </div>

  <div class="hint">CTRL+E EXPORT · CTRL+SHIFT+E IMPORT · N NOTE · F FOCUS</div>

  <div class="wrap">
    <aside class="left">
      <div class="panelH">OBJECT IDS</div>

      <div class="kv">
        <div class="k">FILE_ID</div>
        <div class="v mono" id="fileId">ketadata_doc</div>
      </div>
      <div class="kv">
        <div class="k">ROOM_ID</div>
        <div class="v mono" id="roomId">BASE</div>
      </div>
      <div class="kv">
        <div class="k">STATE_ID</div>
        <div class="v mono" id="stateId">LOCAL_0000</div>
      </div>
      <div class="kv">
        <div class="k">CATEGORY_ID</div>
        <div class="v mono" id="categoryId">DOC</div>
      </div>

      <div class="panelH">LAWS</div>
      <div class="kv">
        <div class="k">SOVEREIGN</div>
        <div class="v mono">NO BACKEND REQUIRED</div>
      </div>
      <div class="kv">
        <div class="k">CONTINUITY</div>
        <div class="v mono">STATE MUST EXPORT + REIMPORT</div>
      </div>
      <div class="kv">
        <div class="k">INVARIANT</div>
        <div class="v mono">WHITE SQUARE IS NON-NEGOTIABLE</div>
      </div>
    </aside>

    <main class="center">
      <div class="page">
        <div class="pageInner">
          <div class="docHead">
            <div class="docTitle" id="docTitle" contenteditable="true" spellcheck="false">KETADATA DOC</div>
            <div class="docMeta" id="docMeta">
              FILE_ID: <span id="mFile">ketadata_doc</span><br/>
              ROOM_ID: <span id="mRoom">BASE</span><br/>
              STATE_ID: <span id="mState">LOCAL_0000</span>
            </div>
          </div>

          <div id="editor" class="editor" contenteditable="true" spellcheck="false">
            <p><span style="color:rgba(255,255,255,0.85); letter-spacing:0.08em;">THIS IS A SOVEREIGN DOC OBJECT.</span></p>
            <p><span style="color:rgba(255,255,255,0.65);">WRITE. EXPORT. REIMPORT. CONTINUITY HOLDS.</span></p>
            <h2>KETA_NOTE</h2>
            <p>—</p>
          </div>
        </div>
      </div>
    </main>

    <aside class="right">
      <div class="panelH">EXPORT</div>
      <div class="kv">
        <div class="k">UPDATED_AT</div>
        <div class="v mono" id="updatedAt">—</div>
      </div>
      <div class="kv">
        <div class="k">STATE (JSON)</div>
        <div class="v mono" id="exportBox">{}</div>
      </div>
      <div class="panelH">KETA_NOTE META</div>
      <div class="kv">
        <div class="k">NOTE_ROOM_ID</div>
        <div class="v mono" id="noteRoom">BASE</div>
      </div>
      <div class="kv">
        <div class="k">NOTE_STATE_ID</div>
        <div class="v mono" id="noteState">LOCAL_0000</div>
      </div>
    </aside>
  </div>

  <!-- KETA_NOTE (MOVABLE) -->
  <div class="ketaNote" id="ketaNote">
    <div class="ketaNoteBar" id="ketaNoteBar">
      <div class="sq" style="width:10px;height:10px;" title="NOTE INVARIANT"></div>
      <div class="ketaNoteTitle" id="ketaNoteTitle">KETA_NOTE</div>
      <button class="ketaNoteBtn" id="noteExport">EXPORT</button>
      <button class="ketaNoteBtn" id="noteHide">-</button>
    </div>
    <div class="ketaNoteBody">
      <textarea id="ketaNoteText" class="ketaNoteText" spellcheck="false">KETA_NOTE

FILE_ID: ketadata_doc
ROOM_ID: BASE
STATE_ID: LOCAL_0000
CATEGORY_ID: DOC

—</textarea>
    </div>
    <div class="ketaNoteFooter">
      <div id="ketaNoteFooterLeft">ROOM: BASE</div>
      <div id="ketaNoteFooterRight">STATE: LOCAL_0000</div>
    </div>
  </div>

  <script>
    /* ===== IDs + State ===== */
    const STORAGE_KEY = "KETADATA_DOC_SOVEREIGN_v1";

    const el = {
      status: document.getElementById("status"),
      brandTitle: document.getElementById("brandTitle"),
      docTitle: document.getElementById("docTitle"),
      docMeta: document.getElementById("docMeta"),
      editor: document.getElementById("editor"),
      exportBox: document.getElementById("exportBox"),
      updatedAt: document.getElementById("updatedAt"),

      fileId: document.getElementById("fileId"),
      roomId: document.getElementById("roomId"),
      stateId: document.getElementById("stateId"),
      categoryId: document.getElementById("categoryId"),

      mFile: document.getElementById("mFile"),
      mRoom: document.getElementById("mRoom"),
      mState: document.getElementById("mState"),

      noteRoom: document.getElementById("noteRoom"),
      noteState: document.getElementById("noteState"),

      ketaNote: document.getElementById("ketaNote"),
      ketaNoteBar: document.getElementById("ketaNoteBar"),
      ketaNoteTitle: document.getElementById("ketaNoteTitle"),
      ketaNoteText: document.getElementById("ketaNoteText"),
      ketaNoteFooterLeft: document.getElementById("ketaNoteFooterLeft"),
      ketaNoteFooterRight: document.getElementById("ketaNoteFooterRight"),
    };

    const DEFAULT = {
      fileId: "ketadata_doc",
      roomId: "BASE",
      stateId: "LOCAL_0000",
      categoryId: "DOC",
      title: "KETADATA DOC",
      editorHtml: "",
      ketaNoteText: "",
      ketaNotePos: { x: 18, y: null, bottom: 18 },
      ketaNoteHidden: false,
      updatedAt: ""
    };

    function nowISO(){ return new Date().toISOString(); }

    function setStatus(s){
      el.status.textContent = s;
      setTimeout(()=>{ el.status.textContent = "LOCAL"; }, 650);
    }

    function gather(){
      return {
        fileId: el.fileId.textContent.trim() || DEFAULT.fileId,
        roomId: el.roomId.textContent.trim() || DEFAULT.roomId,
        stateId: el.stateId.textContent.trim() || DEFAULT.stateId,
        categoryId: el.categoryId.textContent.trim() || DEFAULT.categoryId,
        title: el.docTitle.textContent.trim() || DEFAULT.title,
        editorHtml: el.editor.innerHTML,
        ketaNoteText: el.ketaNoteText.value,
        ketaNotePos: {
          x: parseInt(el.ketaNote.style.left || "18", 10),
          y: parseInt(el.ketaNote.style.top || "", 10) || null,
          bottom: parseInt(el.ketaNote.style.bottom || "18", 10)
        },
        ketaNoteHidden: el.ketaNote.classList.contains("ketaNoteHidden"),
        updatedAt: nowISO()
      };
    }

    function apply(s){
      const st = { ...DEFAULT, ...s };

      el.fileId.textContent = st.fileId;
      el.roomId.textContent = st.roomId;
      el.stateId.textContent = st.stateId;
      el.categoryId.textContent = st.categoryId;

      el.mFile.textContent = st.fileId;
      el.mRoom.textContent = st.roomId;
      el.mState.textContent = st.stateId;

      el.noteRoom.textContent = st.roomId;
      el.noteState.textContent = st.stateId;

      el.docTitle.textContent = st.title;
      el.brandTitle.textContent = st.title;

      if (st.editorHtml) el.editor.innerHTML = st.editorHtml;

      // KETA_NOTE continuity fields must mirror ids
      const baseNote = (st.ketaNoteText && st.ketaNoteText.trim().length)
        ? st.ketaNoteText
        : `KETA_NOTE\n\nFILE_ID: ${st.fileId}\nROOM_ID: ${st.roomId}\nSTATE_ID: ${st.stateId}\nCATEGORY_ID: ${st.categoryId}\n\n—`;

      el.ketaNoteText.value = enforceNoteIds(baseNote, st);

      el.ketaNoteFooterLeft.textContent = `ROOM: ${st.roomId}`;
      el.ketaNoteFooterRight.textContent = `STATE: ${st.stateId}`;

      if (st.ketaNoteHidden) el.ketaNote.classList.add("ketaNoteHidden");
      else el.ketaNote.classList.remove("ketaNoteHidden");

      // Position note
      el.ketaNote.style.left = (st.ketaNotePos?.x ?? 18) + "px";
      el.ketaNote.style.bottom = (st.ketaNotePos?.bottom ?? 18) + "px";
      el.ketaNote.style.top = ""; // use bottom anchoring by default

      el.updatedAt.textContent = st.updatedAt ? st.updatedAt : "—";

      renderExport(st);
    }

    function renderExport(st){
      const out = JSON.stringify(st, null, 2);
      el.exportBox.textContent = out;
    }

    function persist(){
      const st = gather();
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
        el.updatedAt.textContent = st.updatedAt;
        renderExport(st);
        setStatus("SAVED");
      }catch(e){
        setStatus("ERROR");
      }
    }

    /* ===== KETA_NOTE ENFORCER =====
       Law: KETA_NOTE must carry FILE_ID / ROOM_ID / STATE_ID / CATEGORY_ID
       We enforce these lines on every save/export.
    */
    function enforceNoteIds(text, st){
      const lines = String(text || "").split("\n");
      const wanted = {
        "FILE_ID": st.fileId,
        "ROOM_ID": st.roomId,
        "STATE_ID": st.stateId,
        "CATEGORY_ID": st.categoryId
      };

      const hasKey = (k) => lines.some(l => l.trim().startsWith(k + ":"));

      // Ensure a "KETA_NOTE" header exists at top
      if (!lines[0] || lines[0].trim() !== "KETA_NOTE"){
        lines.unshift("KETA_NOTE", "");
      }

      // Force/insert keys (near top after header)
      const insertAt = Math.min(3, lines.length);
      for (const k of Object.keys(wanted)){
        if (!hasKey(k)){
          lines.splice(insertAt, 0, `${k}: ${wanted[k]}`);
        }
      }

      // Normalize all key lines to current values
      for (let i=0;i<lines.length;i++){
        for (const k of Object.keys(wanted)){
          if (lines[i].trim().startsWith(k + ":")){
            lines[i] = `${k}: ${wanted[k]}`;
          }
        }
      }

      return lines.join("\n");
    }

    function syncIdsIntoNote(){
      const st = gather();
      el.ketaNoteText.value = enforceNoteIds(el.ketaNoteText.value, st);
      el.ketaNoteFooterLeft.textContent = `ROOM: ${st.roomId}`;
      el.ketaNoteFooterRight.textContent = `STATE: ${st.stateId}`;
      el.noteRoom.textContent = st.roomId;
      el.noteState.textContent = st.stateId;
    }

    /* ===== Init ===== */
    (function init(){
      let st = null;
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) st = JSON.parse(raw);
      }catch(e){}
      apply(st || DEFAULT);
      // enforce ids once on load
      syncIdsIntoNote();
      persist();
    })();

    /* ===== Autosave (debounced) ===== */
    let t = null;
    function scheduleSave(){
      clearTimeout(t);
      t = setTimeout(() => { syncIdsIntoNote(); persist(); }, 420);
    }
    el.editor.addEventListener("input", scheduleSave);
    el.docTitle.addEventListener("input", scheduleSave);
    el.ketaNoteText.addEventListener("input", scheduleSave);

    /* ===== Minimal format commands ===== */
    function cmd(name, val=null){ document.execCommand(name, false, val); el.editor.focus(); }
    document.getElementById("bBold").onclick = ()=>cmd("bold");
    document.getElementById("bItalic").onclick = ()=>cmd("italic");
    document.getElementById("bUnderline").onclick = ()=>cmd("underline");
    document.getElementById("bH2").onclick = ()=>cmd("formatBlock","h2");
    document.getElementById("bH3").onclick = ()=>cmd("formatBlock","h3");
    document.getElementById("bQuote").onclick = ()=>cmd("formatBlock","blockquote");
    document.getElementById("bPre").onclick = ()=>{
      // wrap selection in <pre><code>…</code></pre>
      const sel = window.getSelection();
      if (!sel || sel.rangeCount===0) return;
      const r = sel.getRangeAt(0);
      const txt = r.toString();
      if (!txt) return;
      const pre = document.createElement("pre");
      const code = document.createElement("code");
      code.textContent = txt;
      pre.appendChild(code);
      r.deleteContents();
      r.insertNode(pre);
      sel.removeAllRanges();
      scheduleSave();
    };

    /* ===== Export / Import ===== */
    function copyToClipboard(s){
      if (navigator.clipboard?.writeText) return navigator.clipboard.writeText(s);
      // fallback
      const ta = document.createElement("textarea");
      ta.value = s; document.body.appendChild(ta); ta.select();
      try{ document.execCommand("copy"); }catch(e){}
      document.body.removeChild(ta);
      return Promise.resolve();
    }

    document.getElementById("bExport").onclick = async ()=>{
      syncIdsIntoNote();
      const st = gather();
      const out = JSON.stringify(st, null, 2);
      el.exportBox.textContent = out;
      await copyToClipboard(out);
      setStatus("EXPORTED");
    };

    document.getElementById("bImport").onclick = ()=>{
      const raw = prompt("PASTE JSON STATE:");
      if (!raw) return;
      try{
        const st = JSON.parse(raw);
        apply(st);
        syncIdsIntoNote();
        persist();
        setStatus("IMPORTED");
      }catch(e){
        setStatus("ERROR");
      }
    };

    document.getElementById("bClear").onclick = ()=>{
      if (!confirm("CLEAR LOCAL STATE?")) return;
      try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
      apply(DEFAULT);
      syncIdsIntoNote();
      persist();
      setStatus("CLEARED");
    };

    /* ===== KETA_NOTE: toggle + export ===== */
    document.getElementById("bToggleNote").onclick = ()=>{
      el.ketaNote.classList.toggle("ketaNoteHidden");
      scheduleSave();
    };
    document.getElementById("noteHide").onclick = ()=>{
      el.ketaNote.classList.add("ketaNoteHidden");
      scheduleSave();
    };
    document.getElementById("noteExport").onclick = async ()=>{
      syncIdsIntoNote();
      await copyToClipboard(el.ketaNoteText.value);
      setStatus("NOTE_EXPORTED");
    };

    /* ===== Focus Mode ===== */
    let focus = false;
    document.getElementById("bFocus").onclick = ()=>{
      focus = !focus;
      document.body.classList.toggle("focus", focus);
    };

    /* ===== Movable KETA_NOTE ===== */
    (function makeDraggable(){
      let dragging=false, startX=0, startY=0, originLeft=0, originTop=0;

      el.ketaNoteBar.addEventListener("mousedown", (e)=>{
        dragging=true;
        startX=e.clientX; startY=e.clientY;

        const rect = el.ketaNote.getBoundingClientRect();
        originLeft = rect.left;
        originTop = rect.top;

        // switch from bottom anchoring to top anchoring while dragging
        el.ketaNote.style.left = originLeft + "px";
        el.ketaNote.style.top  = originTop + "px";
        el.ketaNote.style.bottom = "auto";
        document.body.style.cursor="move";
        e.preventDefault();
      });

      window.addEventListener("mousemove", (e)=>{
        if(!dragging) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        const newLeft = Math.max(0, Math.min(window.innerWidth - el.ketaNote.offsetWidth, originLeft + dx));
        const newTop  = Math.max(64, Math.min(window.innerHeight - el.ketaNote.offsetHeight, originTop + dy));
        el.ketaNote.style.left = newLeft + "px";
        el.ketaNote.style.top  = newTop + "px";
      });

      window.addEventListener("mouseup", ()=>{
        if(!dragging) return;
        dragging=false;
        document.body.style.cursor="default";
        scheduleSave();
      });
    })();

    /* ===== Hotkeys ===== */
    document.addEventListener("keydown", (e)=>{
      const k = e.key.toLowerCase();

      if (e.ctrlKey && !e.shiftKey && k==="e"){ e.preventDefault(); document.getElementById("bExport").click(); }
      if (e.ctrlKey && e.shiftKey && k==="e"){ e.preventDefault(); document.getElementById("bImport").click(); }
      if (e.ctrlKey && e.shiftKey && k==="x"){ e.preventDefault(); document.getElementById("bClear").click(); }
      if (!e.ctrlKey && !e.metaKey && k==="n"){ document.getElementById("bToggleNote").click(); }
      if (!e.ctrlKey && !e.metaKey && k==="f"){ document.getElementById("bFocus").click(); }
    });

    window.addEventListener("beforeunload", ()=>{
      try{
        syncIdsIntoNote();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(gather()));
      }catch(e){}
    });
  </script>

  <!--
  AE:
  - KETADATA BRUTALIST DOC OBJECT: BLACK FIELD, WHITE TYPE, HAIRLINE BORDERS, SHARP EDGES.
  - WHITE SQUARE INVARIANT PRESENT (TOPBAR + KETA_NOTE).
  - CONTROLS ALL CAPS. NO FRIENDLY UI. NO ROUNDING. NO DROP SHADOWS.

  EE:
  - SOVEREIGN PAGE: NO BACKEND REQUIRED. LOCALSTORAGE PERSISTENCE.
  - EXPORT/IMPORT FULL STATE (JSON).
  - KETA_NOTE IS MOVABLE + HIDEABLE, AND ENFORCED TO CONTAIN:
    FILE_ID / ROOM_ID / STATE_ID / CATEGORY_ID (AUTO-NORMALIZED ON SAVE/EXPORT).
  - IDs ARE FIRST-CLASS (VISIBLE, USED, AND SYNCED ACROSS UI).
  - FOCUS MODE (PANELS OFF) DOES NOT BREAK EXPORT/PERSISTENCE.

  WB:
  FILE_ID: ketadata_doc_sovereign
  ROOM_ID: BASE
  VERSION: v1.0.0
  UPDATED_AT: 2025-12-24
  CHANGELOG:
  - Implemented sovereign doc object w/ enforceable KETA_NOTE continuity fields.
  - Added export/import JSON state + note export.
  - Added movable/hideable KETA_NOTE panel (sharp, minimal).
  -->
</body>
</html>
