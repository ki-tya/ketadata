<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>KETADATA — SPLIT POPUP</title>
  <style>
    :root{
      --bg:#000; --fg:#f2f2f2; --muted:#9a9a9a; --line:#2a2a2a;
      --hud:rgba(255,255,255,0.03);
      --font:12px/1.15 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --r:12px;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:var(--font);overflow:hidden;}
    *{box-sizing:border-box;}
    button,input{font:var(--font);color:var(--fg);}
    input{
      height:28px;width:100%;
      background:rgba(0,0,0,0.28);
      border:1px solid var(--line);
      border-radius:10px;
      padding:6px 8px;
      outline:none;
      min-width:0;
    }
    button{
      height:28px;padding:0 10px;border:1px solid var(--line);
      background:transparent;border-radius:10px;cursor:pointer;
    }
    button:active{transform:translateY(1px);}
    button.on{background:rgba(255,255,255,0.06);}
    .pill{border:1px solid var(--line);border-radius:999px;padding:3px 6px;color:var(--muted);background:rgba(0,0,0,0.14);white-space:nowrap;}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .sp{flex:1;}
    .grid{display:grid;gap:8px;}
    .card{
      border:1px solid var(--line);
      border-radius:var(--r);
      background:rgba(255,255,255,0.02);
      padding:8px;
    }
    .k{color:var(--muted);}
    .mono{white-space:pre-wrap;}
    .sep{height:1px;background:rgba(255,255,255,0.06);margin:8px 0;}
    html.invert #app{filter: invert(1) hue-rotate(180deg);}
    html.null #hud, html.null #status{display:none;}

    #app{position:fixed;inset:0;display:flex;flex-direction:column;gap:10px;padding:10px;}
    #hud{
      border:1px solid var(--line);
      background:var(--hud);
      backdrop-filter: blur(6px);
      border-radius:var(--r);
      padding:8px;
      user-select:none;
    }
    #main{flex:1;display:grid;grid-template-columns:1fr 1fr;gap:10px;min-height:0;}
    #status{
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:8px;
      background:rgba(0,0,0,0.25);
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
    }
    .badge{border:1px solid rgba(255,255,255,0.10);border-radius:999px;padding:3px 6px;color:var(--muted);}
    .danger{border-color:rgba(255,255,255,0.18);}
    .danger:hover{border-color:rgba(255,255,255,0.35);}
    .tiny{height:26px;padding:0 8px;border-radius:999px;}
  </style>
</head>
<body>
<div id="app">
  <div id="hud">
    <div class="row">
      <span class="pill">KETADATA SPLIT — POPUPS</span>
      <span class="pill">SHIFT+I INVERT</span>
      <span class="pill">SHIFT+N NULL</span>
      <span class="pill">SHIFT+F FULL</span>
      <span class="pill">SHIFT+S SWAP</span>
      <span class="sp"></span>
      <span class="pill" id="filePill"></span>
    </div>
  </div>

  <div id="main">
    <!-- LEFT CONTROLLER -->
    <div class="card">
      <div class="row">
        <span class="k">LEFT (POPUP)</span>
        <span class="sp"></span>
        <span class="badge" id="leftState">CLOSED</span>
      </div>
      <div class="sep"></div>
      <div class="grid">
        <div class="k">URL</div>
        <input id="urlL" type="text" spellcheck="false" placeholder="https://chat.openai.com/"/>
        <div class="row">
          <button id="openL">OPEN</button>
          <button id="navL">GO</button>
          <button id="focusL">FOCUS</button>
          <button id="closeL" class="danger">CLOSE</button>
          <span class="sp"></span>
          <button id="dockL" class="tiny">DOCK LEFT</button>
        </div>
      </div>
      <div class="sep"></div>
      <div class="k mono">
Notes:
- Popups bypass iframe blocking.
- If your browser blocks popups, you must click OPEN (user gesture) to allow.
      </div>
    </div>

    <!-- RIGHT CONTROLLER -->
    <div class="card">
      <div class="row">
        <span class="k">RIGHT (POPUP)</span>
        <span class="sp"></span>
        <span class="badge" id="rightState">CLOSED</span>
      </div>
      <div class="sep"></div>
      <div class="grid">
        <div class="k">URL</div>
        <input id="urlR" type="text" spellcheck="false" placeholder="https://github.com/"/>
        <div class="row">
          <button id="openR">OPEN</button>
          <button id="navR">GO</button>
          <button id="focusR">FOCUS</button>
          <button id="closeR" class="danger">CLOSE</button>
          <span class="sp"></span>
          <button id="dockR" class="tiny">DOCK RIGHT</button>
        </div>
      </div>
      <div class="sep"></div>
      <div class="k mono">
Docking:
- "DOCK LEFT/RIGHT" positions the popup beside your screen.
- Works best on a single monitor; for dual monitors just drag windows manually.
      </div>
    </div>
  </div>

  <div id="status">
    <span class="k">STATE</span>
    <span class="pill" id="invPill">INVERT: OFF</span>
    <span class="pill" id="nullPill">NULL: OFF</span>
    <span class="pill" id="fullPill">FULL: OFF</span>
    <span class="sp"></span>
    <button id="swapBtn">SWAP URLS</button>
    <button id="openBothBtn">OPEN BOTH</button>
    <button id="closeBothBtn" class="danger">CLOSE BOTH</button>
    <button id="exportBtn">EXPORT (FILE)</button>
    <button id="importBtn">IMPORT (FILE)</button>
    <input id="importFile" type="file" accept="application/json" style="display:none"/>
  </div>
</div>

<script>
(() => {
  const FILE_ID = "KD_SPLIT_POPUP_V1";
  const STORE_KEY = "KD_STATE__" + FILE_ID;

  const $ = (id)=>document.getElementById(id);
  $("filePill").textContent = "FILE_ID: " + FILE_ID;

  const invPill = $("invPill");
  const nullPill = $("nullPill");
  const fullPill = $("fullPill");
  const leftState = $("leftState");
  const rightState = $("rightState");

  const urlL = $("urlL");
  const urlR = $("urlR");

  // popup handles (keep same-origin in mind: we won't read content, only set location)
  let winL = null;
  let winR = null;

  // ---------- STATE ----------
  const nowISO = ()=>new Date().toISOString();

  const defaultState = () => ({
    meta:{ fileId: FILE_ID, updatedAt: nowISO() },
    ui:{ invert:false, nullMode:false },
    panes:{
      L:{ url:"https://chat.openai.com/", dock:"left" },
      R:{ url:"https://github.com/", dock:"right" }
    }
  });

  let state = load();
  urlL.value = state.panes.L.url || "";
  urlR.value = state.panes.R.url || "";
  applyUI();

  let saveT=null;
  function scheduleSave(){
    if(saveT) clearTimeout(saveT);
    saveT=setTimeout(save, 220);
  }
  function save(){
    try{
      state.meta.updatedAt = nowISO();
      localStorage.setItem(STORE_KEY, JSON.stringify(state));
    }catch{}
  }
  function load(){
    try{
      const raw = localStorage.getItem(STORE_KEY);
      if(!raw) return defaultState();
      const p = JSON.parse(raw);
      if(!p || typeof p!=="object") return defaultState();
      if(!p.meta) p.meta={};
      if(!p.ui) p.ui={};
      if(!p.panes) p.panes={L:{},R:{}};
      if(!p.panes.L) p.panes.L={};
      if(!p.panes.R) p.panes.R={};
      p.meta.fileId = FILE_ID;
      const d = defaultState();
      p.ui.invert = !!p.ui.invert;
      p.ui.nullMode = !!p.ui.nullMode;
      p.panes.L.url = p.panes.L.url || d.panes.L.url;
      p.panes.R.url = p.panes.R.url || d.panes.R.url;
      p.panes.L.dock = p.panes.L.dock || d.panes.L.dock;
      p.panes.R.dock = p.panes.R.dock || d.panes.R.dock;
      return p;
    }catch{ return defaultState(); }
  }

  function applyUI(){
    document.documentElement.classList.toggle("invert", !!state.ui.invert);
    document.documentElement.classList.toggle("null", !!state.ui.nullMode);
    invPill.textContent = "INVERT: " + (state.ui.invert ? "ON" : "OFF");
    nullPill.textContent = "NULL: " + (state.ui.nullMode ? "ON" : "OFF");
    fullPill.textContent = "FULL: " + (document.fullscreenElement ? "ON" : "OFF");
  }

  // ---------- URL NORMALIZATION ----------
  function normUrl(u){
    u = String(u||"").trim();
    if(!u) return "";
    if(!/^https?:\/\//i.test(u) && !/^about:/i.test(u)) u = "https://" + u;
    return u;
  }

  // ---------- POPUP CORE ----------
  function openPopup(side){
    const isL = side==="L";
    const url = normUrl(isL ? urlL.value : urlR.value);
    if(!url) return;

    // persist url
    state.panes[side].url = url;
    scheduleSave();

    const w = Math.floor(window.screen.availWidth * 0.50);
    const h = Math.floor(window.screen.availHeight * 0.92);

    // default docking positions
    const x = isL ? 0 : Math.max(0, window.screen.availWidth - w);
    const y = 0;

    const features = [
      "popup=yes",
      "resizable=yes",
      "scrollbars=yes",
      "toolbar=yes",
      "location=yes",
      "menubar=no",
      "status=no",
      "width=" + w,
      "height=" + h,
      "left=" + x,
      "top=" + y
    ].join(",");

    const win = window.open(url, "KD_POP_" + side, features);
    if(!win){
      // blocked by browser
      setBadge(side, "BLOCKED");
      return;
    }

    if(isL) winL = win; else winR = win;
    setBadge(side, "OPEN");

    // keep badge in sync
    tickBadges();
  }

  function navPopup(side){
    const isL = side==="L";
    const win = isL ? winL : winR;
    const url = normUrl(isL ? urlL.value : urlR.value);
    if(!url) return;

    state.panes[side].url = url;
    scheduleSave();

    if(win && !win.closed){
      try{ win.location.href = url; }catch{ /* ignore */ }
      setBadge(side, "OPEN");
    }else{
      setBadge(side, "CLOSED");
      openPopup(side);
    }
  }

  function focusPopup(side){
    const win = (side==="L") ? winL : winR;
    if(win && !win.closed){
      try{ win.focus(); }catch{}
      setBadge(side, "OPEN");
    }else{
      setBadge(side, "CLOSED");
    }
  }

  function closePopup(side){
    const isL = side==="L";
    const win = isL ? winL : winR;
    if(win && !win.closed){
      try{ win.close(); }catch{}
    }
    if(isL) winL=null; else winR=null;
    setBadge(side, "CLOSED");
  }

  function dockPopup(side){
    const isL = side==="L";
    const win = isL ? winL : winR;
    const w = Math.floor(window.screen.availWidth * 0.50);
    const h = Math.floor(window.screen.availHeight * 0.92);
    const x = isL ? 0 : Math.max(0, window.screen.availWidth - w);
    const y = 0;

    state.panes[side].dock = isL ? "left" : "right";
    scheduleSave();

    if(win && !win.closed){
      try{
        win.moveTo(x, y);
        win.resizeTo(w, h);
        win.focus();
      }catch{}
      setBadge(side, "OPEN");
    }else{
      // open docked
      openPopup(side);
    }
  }

  function setBadge(side, text){
    const el = (side==="L") ? leftState : rightState;
    el.textContent = text;
  }

  function tickBadges(){
    const lOpen = winL && !winL.closed;
    const rOpen = winR && !winR.closed;
    setBadge("L", lOpen ? "OPEN" : "CLOSED");
    setBadge("R", rOpen ? "OPEN" : "CLOSED");
  }
  setInterval(tickBadges, 900);

  // ---------- EXPORT / IMPORT (REAL FILE DOWNLOAD) ----------
  function downloadJSON(filename, obj){
    const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function exportState(){
    const out = {
      ...state,
      runtime:{
        note:"Popups are not serialized. This file stores URLs and UI toggles only."
      }
    };
    downloadJSON(FILE_ID + "__STATE.json", out);
  }

  function importStateFromFile(file){
    const fr = new FileReader();
    fr.onload = () => {
      try{
        const parsed = JSON.parse(fr.result);
        if(!parsed || typeof parsed!=="object") return;

        const d = defaultState();
        state.ui = {
          invert: !!(parsed.ui && parsed.ui.invert),
          nullMode: !!(parsed.ui && parsed.ui.nullMode)
        };
        state.panes = {
          L:{ url: (parsed.panes && parsed.panes.L && parsed.panes.L.url) || d.panes.L.url, dock:"left" },
          R:{ url: (parsed.panes && parsed.panes.R && parsed.panes.R.url) || d.panes.R.url, dock:"right" }
        };

        urlL.value = state.panes.L.url;
        urlR.value = state.panes.R.url;

        applyUI();
        save();
      }catch{}
    };
    fr.readAsText(file);
  }

  // ---------- UI WIRING ----------
  $("openL").onclick  = ()=>openPopup("L");
  $("openR").onclick  = ()=>openPopup("R");
  $("navL").onclick   = ()=>navPopup("L");
  $("navR").onclick   = ()=>navPopup("R");
  $("focusL").onclick = ()=>focusPopup("L");
  $("focusR").onclick = ()=>focusPopup("R");
  $("closeL").onclick = ()=>closePopup("L");
  $("closeR").onclick = ()=>closePopup("R");
  $("dockL").onclick  = ()=>dockPopup("L");
  $("dockR").onclick  = ()=>dockPopup("R");

  urlL.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); navPopup("L"); }});
  urlR.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); navPopup("R"); }});

  $("swapBtn").onclick = ()=>{
    const a = urlL.value, b = urlR.value;
    urlL.value = b; urlR.value = a;
    state.panes.L.url = normUrl(urlL.value);
    state.panes.R.url = normUrl(urlR.value);
    scheduleSave();
  };

  $("openBothBtn").onclick = ()=>{
    openPopup("L");
    openPopup("R");
  };

  $("closeBothBtn").onclick = ()=>{
    closePopup("L");
    closePopup("R");
  };

  $("exportBtn").onclick = exportState;
  $("importBtn").onclick = ()=>$("importFile").click();
  $("importFile").onchange = ()=>{
    const f = $("importFile").files && $("importFile").files[0];
    $("importFile").value = "";
    if(f) importStateFromFile(f);
  };

  // keep state in sync when user types (but do not spam)
  urlL.addEventListener("input",()=>{ state.panes.L.url = normUrl(urlL.value) || ""; scheduleSave(); });
  urlR.addEventListener("input",()=>{ state.panes.R.url = normUrl(urlR.value) || ""; scheduleSave(); });

  // ---------- HOTKEYS ----------
  function toggleFull(){
    if(!document.fullscreenElement) document.documentElement.requestFullscreen?.();
    else document.exitFullscreen?.();
    setTimeout(applyUI, 50);
  }

  window.addEventListener("keydown",(e)=>{
    const tag=(document.activeElement && document.activeElement.tagName || "").toLowerCase();
    const typing=(tag==="input"||tag==="textarea");

    if(e.shiftKey && (e.key==="I"||e.key==="i")){
      e.preventDefault();
      state.ui.invert = !state.ui.invert;
      applyUI();
      scheduleSave();
    }

    if(e.shiftKey && (e.key==="N"||e.key==="n")){
      e.preventDefault();
      state.ui.nullMode = !state.ui.nullMode;
      applyUI();
      scheduleSave();
    }

    if(e.shiftKey && (e.key==="F"||e.key==="f")){
      e.preventDefault();
      toggleFull();
    }

    if(e.shiftKey && (e.key==="S"||e.key==="s")){
      e.preventDefault();
      $("swapBtn").click();
    }

    if(e.key==="Escape" && state.ui.nullMode){
      state.ui.nullMode=false;
      applyUI();
      scheduleSave();
    }

    // quick focus
    if(!typing && e.shiftKey && (e.key==="1")){
      e.preventDefault(); focusPopup("L");
    }
    if(!typing && e.shiftKey && (e.key==="2")){
      e.preventDefault(); focusPopup("R");
    }
  });

  // initial persist
  save();
  tickBadges();
})();
</script>

<!--
AE / EE / WB — KETADATA SERIALIZATION STAMP (MANDATORY)
AE: BLACK DEFAULT • UNIFORM TEXT SIZE • BRUTAL CONTROLLER • INVERT GLOBAL • NULL HIDES CHROME
EE: POPUP WINDOWS FOR L/R • OPEN/GO/FOCUS/CLOSE • DOCK LEFT/RIGHT • SWAP URLS • HOTKEYS
WB: LOCAL-FIRST URL + UI TOGGLES • EXPORT = REAL FILE DOWNLOAD • IMPORT = FILE PICKER READ

FILE_ID: "KD_SPLIT_POPUP_V1"
ROOM_ID: "K_CORE_UTIL"
VERSION_ID: "V1"
UPDATED_AT: "2026-01-04T00:00:00.000-05:00"
CHANGELOG:
- V1: Popup-based split workflow controller (avoids iframe embedding restrictions).
-->
</body>
</html>
