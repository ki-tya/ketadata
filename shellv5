<!--
KETADATA_HTML
NAME: KETADATA_SHELL_KERNEL
VERSION: v1.1.0
SERIAL: KHS-001-2025-12-23
ROLE: KERNEL / SHELL
PARENT: NONE
STATE_SCHEMA: KETADATA_STATE_v1
-->

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KETADATA_SHELL_KERNEL_v1.1.0.html</title>

<!-- =========================================================
[AE-01] AESTHETIC :: ROOT / VOID / TYPO
========================================================= -->
<style>
:root{
  --bg:#000; --fg:#fff; --muted:#8a8a8a;
  --line:#222; --line2:#333;

  --top:44px; --bot:34px;

  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  --sans: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

  --ctl-radius:0px;            /* SHARP */
  --ctl-alpha:0.80;
  --ctl-bg: rgba(0,0,0,var(--ctl-alpha));
  --note-border: rgba(255,255,255,0.58); /* THINNER */
  --note-border2: rgba(255,255,255,0.22);
}

*{box-sizing:border-box}
html,body{height:100%; margin:0}
body{
  background:var(--bg);
  color:var(--fg);
  font-family:var(--sans);
  overflow:hidden;
  user-select:none;
}

#root{ position:fixed; inset:0; background:#000; }
#root.invert{ filter: invert(1); }

#stage{
  position:absolute; inset:0;
  background:#000;
}

/* =========================================================
[AE-02] AESTHETIC :: MOTION LAYER (INDUSTRIAL SCANFLOW)
========================================================= */
#motion{
  position:absolute; inset:0;
  pointer-events:none;
  opacity:0;
  background:
    repeating-linear-gradient(
      135deg,
      rgba(255,255,255,0.06) 0px,
      rgba(255,255,255,0.06) 1px,
      rgba(0,0,0,0) 12px,
      rgba(0,0,0,0) 22px
    );
  mix-blend-mode: screen;
  transform: translate3d(0,0,0);
}
#motion.run{
  opacity:0.12;
  animation: scanflow 2.2s linear infinite;
}
@keyframes scanflow{
  0%   { transform: translate3d(-80px, 60px, 0); }
  100% { transform: translate3d(80px, -60px, 0); }
}

/* =========================================================
[AE-03] AESTHETIC :: TOP BAR (ALL CAPS)
========================================================= */
.topbar{
  position:absolute; top:0; left:0; right:0;
  height:var(--top);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 10px;
  border-bottom:1px solid var(--line);
  background:linear-gradient(180deg,#070707,#000);
  z-index:50;
}
.brand{
  display:flex; align-items:center; gap:10px;
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.10em;
  text-transform:uppercase;
}
.brand .sq{ width:10px; height:10px; border:1px solid var(--fg); background:#000; }

.roomBadge{
  display:flex; gap:8px; align-items:center;
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.10em;
  text-transform:uppercase;
  color:var(--muted);
  border:1px solid var(--line2);
  padding:4px 8px;
}

.actions{
  display:flex; align-items:center; gap:8px;
  font-family:var(--mono);
  font-size:12px;
}
.btn{
  background:transparent;
  color:var(--fg);
  border:1px solid var(--line2);
  padding:6px 10px;
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.08em;
  text-transform:uppercase;
  cursor:pointer;
}
.btn:hover{border-color:var(--fg)}
.btn:active{transform:translateY(1px)}
.kbd{
  border:1px solid var(--line2);
  padding:2px 6px;
  color:var(--muted);
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase; /* FIX: ALL CAPS */
}

/* KETA NOTE icon: filled when collapsed, hollow when open */
.ketaIcon{
  width:16px; height:16px;
  border:2px solid var(--fg);
  background:var(--fg);
  cursor:pointer;
}
.ketaIcon.open{ background:#000; }

/* =========================================================
[AE-04] AESTHETIC :: BOTTOM BAR / DRAWER
========================================================= */
.bottombar{
  position:absolute; left:0; right:0; bottom:0;
  height:var(--bot);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 10px;
  border-top:1px solid var(--line);
  background:linear-gradient(0deg,#070707,#000);
  z-index:50;
  font-family:var(--mono);
  font-size:11px;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:.08em;
}
.toggle{
  border:1px solid var(--line2);
  background:transparent;
  color:var(--fg);
  padding:4px 8px;
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
  cursor:pointer;
}
.toggle:hover{border-color:var(--fg)}

.drawer{
  position:absolute;
  left:0; right:0;
  bottom:var(--bot);
  height:42%;
  min-height:260px;
  border-top:1px solid var(--line);
  background:linear-gradient(180deg,#060606,#000);
  display:none;
  z-index:60;
}
.drawer.open{display:flex; flex-direction:column}
.drawerHead{
  padding:8px 10px;
  border-bottom:1px solid var(--line);
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.10em;
  text-transform:uppercase;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.drawerBody{padding:10px; min-height:0; flex:1; overflow:auto}
textarea{
  width:100%;
  border:1px solid var(--line2);
  background:#050505;
  color:var(--fg);
  font-family:var(--mono);
  font-size:12px;
  padding:10px;
  line-height:1.35;
  outline:none;
  resize:vertical;
  min-height:140px;
}

/* =========================================================
[AE-05] AESTHETIC :: FLOATING WINDOWS (KETA_NOTE / SPEC / SCREENS)
========================================================= */
.floatWin{
  position:absolute;
  z-index:80;
  resize:both;
  overflow:hidden;
  background:var(--ctl-bg);
  border:1px solid var(--note-border);
  backdrop-filter: blur(6px);
  border-radius:0;
  display:none;
}
.floatWin.open{ display:flex; flex-direction:column; }

.floatHead{
  padding:8px 10px;
  border-bottom:1px solid rgba(255,255,255,0.14);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.14em;
  text-transform:uppercase;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:move;
}
.floatHead .left{ display:flex; gap:10px; align-items:center; min-width:0; }
.floatHead .title{
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  max-width:240px;
}
.headBtn{
  background:transparent;
  color:var(--fg);
  border:1px solid rgba(255,255,255,0.18);
  padding:2px 8px;
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.08em;
  text-transform:uppercase;
  cursor:pointer;
}
.headBtn:hover{border-color:rgba(255,255,255,0.6)}
.floatBody{ padding:10px; min-height:0; flex:1; }
.floatBody textarea{
  background:#000;
  color:#fff;
  border:1px solid var(--note-border2);
  width:100%;
  height:100%;
  resize:none;
  padding:10px;
  outline:none;
}

/* Hidden micro-panel (bottom) for note formatting */
.noteTools{
  position:absolute;
  left:8px; right:8px; bottom:8px;
  display:flex;
  gap:8px;
  justify-content:flex-end;
  opacity:0;
  pointer-events:none;
  transition: opacity .12s ease;
}
.floatWin:hover .noteTools{
  opacity:1;
  pointer-events:auto;
}
.toolBtn{
  width:28px; height:22px;
  border:1px solid rgba(255,255,255,0.18);
  background:rgba(255,255,255,0.02);
  color:rgba(255,255,255,0.80);
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.08em;
  cursor:pointer;
}
.toolBtn:hover{ border-color:rgba(255,255,255,0.55); }

/* =========================================================
[AE-06] AESTHETIC :: MINI KDTV SCREEN (NO OUTLINE)
========================================================= */
.screenWin{
  border:0 !important;     /* NO EDGES OUTLINE */
  background:transparent;  /* PURE FLOAT */
  backdrop-filter:none;
}
.screenShell{
  position:absolute; inset:0;
  background:rgba(18,18,18,0.92);
  overflow:hidden;
}
.screenMedia{
  position:absolute; inset:0;
  filter: var(--kdfx, none);
}
.screenBlank{
  position:absolute; inset:0;
  background:linear-gradient(135deg, rgba(255,255,255,0.07), rgba(0,0,0,0.0));
  opacity:0.35;
}
.screenHud{
  position:absolute; left:8px; right:8px; top:8px;
  display:flex; justify-content:space-between; align-items:center;
  gap:8px;
  pointer-events:none;
}
.screenHud .pill{
  pointer-events:auto;
  border:1px solid rgba(255,255,255,0.14);
  background:rgba(0,0,0,0.35);
  color:rgba(255,255,255,0.65);
  font-family:var(--mono);
  font-size:10px;
  letter-spacing:.14em;
  text-transform:uppercase;
  padding:6px 8px;
}
.screenControls{
  position:absolute; left:8px; right:8px; bottom:8px;
  display:flex; gap:8px; justify-content:space-between; align-items:center;
  pointer-events:auto;
}
.screenControls .miniBtn{
  border:1px solid rgba(255,255,255,0.14);
  background:rgba(0,0,0,0.35);
  color:rgba(255,255,255,0.72);
  font-family:var(--mono);
  font-size:10px;
  letter-spacing:.14em;
  text-transform:uppercase;
  padding:6px 8px;
  cursor:pointer;
}
.screenControls .miniBtn:hover{ border-color:rgba(255,255,255,0.55); }
.screenControls .group{ display:flex; gap:8px; align-items:center; }

/* Toast */
.toast{
  position:absolute;
  left:12px;
  top:calc(var(--top) + 12px);
  padding:8px 10px;
  border:1px solid var(--line2);
  background:rgba(8,8,8,0.82);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.06em;
  text-transform:uppercase;
  color:var(--fg);
  display:none;
  z-index:100;
}

/* RoomUrl banner */
#roomJump{
  position:absolute;
  left:10px;
  top:calc(var(--top) + 10px);
  display:none;
  align-items:center;
  gap:10px;
  padding:8px 10px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,0.82);
  z-index:70;
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
}
#roomJump.show{display:flex}
</style>
</head>

<body>
<div id="root">
  <div id="stage" aria-label="KETADATA STAGE"></div>
  <div id="motion" aria-hidden="true"></div>

  <div id="roomJump">
    <span id="roomJumpTxt">ROOM LINK DETECTED</span>
    <button class="btn" id="btnGoRoom">GO</button>
    <button class="btn" id="btnDismissRoom">DISMISS</button>
  </div>

  <div class="toast" id="toast"></div>

  <!-- =========================================================
  [WB-01] WIRING :: TOPBAR
  ========================================================= -->
  <div class="topbar">
    <div style="display:flex; gap:10px; align-items:center">
      <div class="brand">
        <span class="sq"></span>
        <span>KETADATA // SHELL // KERNEL</span>
        <span style="color:var(--muted); letter-spacing:.02em; text-transform:none">v1.1.0</span>
      </div>
      <div class="roomBadge" title="Room in state">
        <span>ROOM</span>
        <span id="roomName">LOBBY</span>
      </div>
    </div>

    <div class="actions">
      <button class="btn" id="btnImport">IMPORT</button>
      <button class="btn" id="btnExport">EXPORT</button>
      <button class="btn" id="btnCopy">COPY</button>
      <button class="btn" id="btnSpec">SPEC</button>
      <button class="btn" id="btnScreen">SCREEN</button>

      <span class="kbd" title="Invert all colors">SHIFT+I</span>
      <span class="kbd" title="Select light preset">1–6</span>
      <span class="kbd" title="Toggle transport">SPACE</span>

      <div id="ketaIcon" class="ketaIcon" title="KETA_NOTE"></div>
    </div>
  </div>

  <!-- =========================================================
  [WB-02] WIRING :: SYSTEM DRAWER
  ========================================================= -->
  <div class="drawer" id="drawer">
    <div class="drawerHead">
      <div>SYSTEM UNIVERSALS</div>
      <div style="display:flex; gap:8px; align-items:center">
        <span id="sig" style="color:var(--muted); font-family:var(--mono); font-size:11px">∅</span>
        <button class="btn" id="btnCopyUniversals">COPY</button>
        <button class="btn" id="btnCloseDrawer">CLOSE</button>
      </div>
    </div>

    <div class="drawerBody">
      <textarea id="universals" placeholder="LAWS / CONSTRAINTS / REFERENCES"></textarea>

      <div style="margin-top:10px; color:var(--muted); font-family:var(--mono); font-size:11px; text-transform:uppercase; letter-spacing:.10em;">
        EE AXIOM :: KETADATA ⇒ KETA_NOTE ⇒ EXPORTABLE STATE
      </div>

      <div style="margin-top:12px; display:flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted)">
        <span>ROOM</span>
        <input id="roomInput" style="flex:1; background:#000; color:#fff; border:1px solid var(--line2); padding:6px 8px; font-family:var(--mono); outline:none" placeholder="E.G. VAULT / LAB / BASEMENT" />
      </div>

      <div style="margin-top:8px; display:flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted)">
        <span>ROOM URL</span>
        <input id="roomUrlInput" style="flex:1; background:#000; color:#fff; border:1px solid var(--line2); padding:6px 8px; font-family:var(--mono); outline:none" placeholder="OPTIONAL: KETADATA.COM/VAULT/INDEX.HTML" />
      </div>

      <div style="margin-top:8px; display:flex; gap:8px; align-items:center">
        <button class="btn" id="btnSaveRoom">SAVE ROOM</button>
      </div>

      <div style="margin-top:14px; border-top:1px solid var(--line); padding-top:10px;">
        <div style="font-family:var(--mono); font-size:11px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted); margin-bottom:8px;">
          SERIAL REGISTRY
        </div>
        <textarea id="serialRegistry" placeholder="AUTO-STORED SERIALS (READ/WRITE)"></textarea>
      </div>
    </div>
  </div>

  <!-- =========================================================
  [WB-03] WIRING :: BOTTOM BAR
  ========================================================= -->
  <div class="bottombar">
    <div style="display:flex; gap:10px; align-items:center">
      <button class="toggle" id="toggleDrawer">SYSTEM</button>
      <span>STATE: <span id="sig2">∅</span></span>
    </div>
    <div style="display:flex; gap:12px; align-items:center">
      <span>LIGHT: <span id="lightLabel">1</span></span>
      <span>RUN: <span id="runLabel">OFF</span></span>
      <span>MOTION: <span id="motionLabel">OFF</span></span>
    </div>
  </div>

  <!-- =========================================================
  [AE-07] AESTHETIC :: KETA NOTE WINDOW (GLOBAL)
  ========================================================= -->
  <div class="floatWin" id="ketaNote" style="top:60px; right:16px; width:360px; height:240px;">
    <div class="floatHead" id="ketaHead">
      <div class="left">
        <div class="title">KETA_NOTE</div>
      </div>
      <button class="headBtn" id="btnHideNote">-</button>
    </div>
    <div class="floatBody" style="position:relative;">
      <textarea id="ketaText" placeholder="GLOBAL NOTE"></textarea>
      <div class="noteTools" aria-label="KETA NOTE TOOLS">
        <button class="toolBtn" id="toolBold" title="Bold (**text**)">B</button>
        <button class="toolBtn" id="toolItalic" title="Italic (*text*)">I</button>
        <button class="toolBtn" id="toolStrike" title="Strike (~~text~~)">S</button>
      </div>
    </div>
  </div>

  <!-- =========================================================
  [AE-08] AESTHETIC :: SPEC NOTES CONTAINER
  ========================================================= -->
  <div id="specLayer"></div>

  <!-- =========================================================
  [AE-09] AESTHETIC :: MINI SCREENS CONTAINER
  ========================================================= -->
  <div id="screenLayer"></div>

  <input id="file" type="file" accept="application/json" style="display:none" />
</div>

<!-- =========================================================
[EE-01] ENGINE :: STATE / SCHEMA / PERSISTENCE
========================================================= -->
<script>
// EE_STATE_SCHEMA :: KETADATA_STATE_v1

const FILE_SERIAL = "KHS-001-2025-12-23";

const DEFAULT = {
  version: "KETADATA_SHELL_KERNEL_v1",
  updatedAt: new Date().toISOString(),

  ketaNote: "",
  universals: "",

  room: "LOBBY",
  roomUrl: "",

  ui: {
    invert:false,
    lightPreset: 1,
    lightRunning: false,
    motionOn: false
  },

  // payload is where we grow without breaking
  payload: {
    serialRegistry: [FILE_SERIAL],
    specNotes: [],     // {id,title,text,x,y,w,h,open}
    screens: []        // {id,mode,ytUrl,ytId,localName,fx:{...},x,y,w,h,open}
  }
};

let STATE = loadLocal() || structuredClone(DEFAULT);

const $ = (id)=>document.getElementById(id);
const root = $("root");
const stage = $("stage");
const motion = $("motion");

function nowISO(){ return new Date().toISOString(); }

function mergeDefault(obj){
  const out = structuredClone(DEFAULT);
  Object.assign(out, obj||{});
  out.ui = Object.assign(structuredClone(DEFAULT.ui), (obj&&obj.ui)||{});
  out.payload = Object.assign(structuredClone(DEFAULT.payload), (obj&&obj.payload)||{});

  if(!Array.isArray(out.payload.serialRegistry)) out.payload.serialRegistry = [FILE_SERIAL];
  if(!out.payload.serialRegistry.includes(FILE_SERIAL)) out.payload.serialRegistry.push(FILE_SERIAL);

  if(!Array.isArray(out.payload.specNotes)) out.payload.specNotes = [];
  if(!Array.isArray(out.payload.screens)) out.payload.screens = [];

  return out;
}

function loadLocal(){
  try{
    const raw = localStorage.getItem("ketadata.shell.kernel.v1");
    if(!raw) return null;
    return mergeDefault(JSON.parse(raw));
  }catch(e){ return null; }
}

function stableSig(){
  const core = JSON.stringify({
    v:STATE.version,
    room:STATE.room,
    i:STATE.ui.invert,
    p:STATE.ui.lightPreset,
    r:STATE.ui.lightRunning,
    m:STATE.ui.motionOn,
    k:(STATE.ketaNote||"").length,
    u:(STATE.universals||"").length,
    sn:(STATE.payload.serialRegistry||[]).length,
    sp:(STATE.payload.specNotes||[]).length,
    sc:(STATE.payload.screens||[]).length
  });
  let h=2166136261;
  for(let i=0;i<core.length;i++){ h^=core.charCodeAt(i); h=Math.imul(h,16777619); }
  return (h>>>0).toString(16).slice(0,8);
}

function persist(){
  STATE.updatedAt = nowISO();
  try{ localStorage.setItem("ketadata.shell.kernel.v1", JSON.stringify(STATE)); }catch(e){}
  render();
}

function exportState(){ return JSON.stringify(STATE, null, 2); }

function importState(text){
  const parsed = JSON.parse(text);
  STATE = mergeDefault(parsed);
  stopLight(true);
  if(STATE.ui.lightRunning) startLight(STATE.ui.lightPreset);
  persist();
}
</script>

<!-- =========================================================
[EE-02] ENGINE :: INVERT / TRANSPORT
========================================================= -->
<script>
// EE_FN_SET_INVERT
function setInvert(on){ STATE.ui.invert = !!on; persist(); }

// EE_FN_TOGGLE_TRANSPORT
function toggleTransport(){
  if(STATE.ui.lightRunning) stopLight(true);
  else startLight(STATE.ui.lightPreset);

  STATE.ui.motionOn = !STATE.ui.motionOn;
  toast(`TRANSPORT ${STATE.ui.lightRunning ? "ON" : "OFF"} / MOTION ${STATE.ui.motionOn ? "ON" : "OFF"}`);
  persist();
}
</script>

<!-- =========================================================
[EE-03] ENGINE :: LIGHTS 1–6 (DEFAULT ENGINES)
========================================================= -->
<script>
let lightInterval = null;
let lightCount = 0, lightAuxA = 0, lightAuxB = 0;

// EE_FN_RESET_STAGE
function resetStage(){
  stage.style.backgroundColor = "#000000";
  stage.style.filter = "none";
  lightCount = 0; lightAuxA = 0; lightAuxB = 0;
}

// EE_FN_START_LIGHT
function startLight(preset){
  stopLight(true);
  resetStage();
  STATE.ui.lightPreset = preset;
  STATE.ui.lightRunning = true;

  if(preset === 1){
    lightInterval = setInterval(()=>{
      const curr = stage.style.backgroundColor || "black";
      stage.style.backgroundColor = (curr === "black" || curr === "rgb(0, 0, 0)") ? "white" : "black";
      stage.style.filter = "none";
    }, 50);
  }

  if(preset === 2){
    lightInterval = setInterval(()=>{
      lightAuxA = (lightAuxA + 30) % 360;
      lightAuxB += 0.5;
      const lightness = 50 + Math.sin(lightAuxB) * 40;
      stage.style.backgroundColor = `hsl(${lightAuxA}, 100%, ${lightness}%)`;
      stage.style.filter = "none";
    }, 10);
  }

  if(preset === 3){
    lightInterval = setInterval(()=>{
      lightCount++;
      const beat = lightCount % 16;

      if (beat === 0 || beat === 1) {
        stage.style.backgroundColor = "#ffffff";
        stage.style.filter = "invert(1) contrast(3) brightness(2)";
      } else if (beat === 2) {
        stage.style.backgroundColor = "#000000";
        stage.style.filter = "invert(1) contrast(2)";
      } else if (beat === 3) {
        stage.style.backgroundColor = "#00ff00";
        stage.style.filter = "contrast(2) saturate(3)";
      } else if (beat === 4) {
        stage.style.backgroundColor = "#ff00ff";
        stage.style.filter = "invert(1) hue-rotate(90deg)";
      } else if (beat === 5 || beat === 6) {
        stage.style.backgroundColor = "#00ffff";
        stage.style.filter = "invert(0.7) contrast(2)";
      } else if (beat === 7) {
        stage.style.backgroundColor = "#ffffff";
        stage.style.filter = "invert(1) brightness(3)";
      } else if (beat === 8) {
        stage.style.backgroundColor = "#000000";
        stage.style.filter = "invert(1) contrast(3)";
      } else if (beat === 9 || beat === 10) {
        stage.style.backgroundColor = "#00ff00";
        stage.style.filter = "saturate(5) contrast(2)";
      } else if (beat === 11) {
        stage.style.backgroundColor = "#ff00ff";
        stage.style.filter = "invert(1) saturate(3)";
      } else {
        stage.style.backgroundColor = "#0088ff";
        stage.style.filter = "contrast(1.5) brightness(1.2)";
      }
    }, 30);
  }

  if(preset === 4){
    lightInterval = setInterval(()=>{
      lightAuxA += 0.08;
      lightCount++;

      const red = Math.abs(Math.sin(lightAuxA)) * 255;
      const pulse = Math.abs(Math.sin(lightAuxA * 0.5));
      const contrast = 2 + pulse * 2;
      const saturation = 4 + pulse * 2;

      if (lightCount % 8 === 0) {
        stage.style.backgroundColor = "#000000";
        stage.style.filter = "brightness(3) contrast(3)";
      } else if (lightCount % 8 === 1) {
        stage.style.backgroundColor = `rgb(${red}, 0, 0)`;
        stage.style.filter = `contrast(${contrast + 1}) saturate(${saturation + 2}) brightness(${1.5 + pulse * 0.5})`;
      } else {
        stage.style.backgroundColor = `rgb(${red}, 0, 0)`;
        stage.style.filter = `contrast(${contrast}) saturate(${saturation}) brightness(${1.2 + pulse * 0.5})`;
      }
    }, 20);
  }

  if(preset === 5){
    lightInterval = setInterval(()=>{
      lightAuxA += 15;
      lightAuxB = (lightAuxB + 2) % 100;

      const hue = 260 + Math.sin(lightAuxA * 0.1) * 40;
      const saturation = 80 + Math.cos(lightAuxA * 0.05) * 20;
      const lightness = 30 + Math.sin(lightAuxB * 0.1) * 30;

      const spiralBrightness = 1 + Math.abs(Math.sin(lightAuxA * 0.05)) * 0.8;
      const spiralContrast = 1.5 + Math.abs(Math.cos(lightAuxA * 0.08)) * 1;

      stage.style.backgroundColor = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
      stage.style.filter = `contrast(${spiralContrast}) saturate(2) brightness(${spiralBrightness}) hue-rotate(${lightAuxA * 0.5}deg)`;
    }, 25);
  }

  if(preset === 6){
    lightInterval = setInterval(()=>{
      lightCount++;
      if (lightCount % 50 === 0) {
        stage.style.backgroundColor = "#ffffff";
        stage.style.filter = "brightness(5) contrast(5)";
      } else if (lightCount % 50 === 1) {
        stage.style.backgroundColor = "#000000";
        stage.style.filter = "none";
      } else if (lightCount % 50 === 2) {
        stage.style.backgroundColor = "#ffffff";
        stage.style.filter = "brightness(5) contrast(5)";
      } else {
        stage.style.backgroundColor = "#000000";
        stage.style.filter = "none";
      }
    }, 30);
  }

  persist();
}

// EE_FN_STOP_LIGHT
function stopLight(silent=false){
  if(lightInterval){ clearInterval(lightInterval); lightInterval = null; }
  STATE.ui.lightRunning = false;
  resetStage();
  if(!silent) persist();
}

// EE_FN_SELECT_PRESET
function selectPreset(preset){
  STATE.ui.lightPreset = preset;
  if(STATE.ui.lightRunning) startLight(preset);
  else persist();
}
</script>

<!-- =========================================================
[WB-04] WIRING :: UI / IO / TOAST / DRAWER
========================================================= -->
<script>
function setDrawer(open){ $("drawer").classList.toggle("open", !!open); }
function setKetaNote(open){
  $("ketaNote").classList.toggle("open", !!open);
  $("ketaIcon").classList.toggle("open", !!open);
}

function download(filename, text){
  const blob = new Blob([text], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 800);
}

async function copy(text){
  try{ await navigator.clipboard.writeText(text); toast("COPIED"); }
  catch(e){ toast("COPY FAILED"); }
}

let toastTimer=null;
function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ t.style.display="none"; }, 900);
}
</script>

<!-- =========================================================
[EE-04] ENGINE :: NOTE FORMATTING (MARKDOWN WRAP)
========================================================= -->
<script>
// EE_FN_WRAP_SELECTION
function wrapSelection(textarea, left, right){
  const start = textarea.selectionStart ?? 0;
  const end = textarea.selectionEnd ?? 0;
  const v = textarea.value || "";
  const mid = v.slice(start,end) || "TEXT";
  const next = v.slice(0,start) + left + mid + right + v.slice(end);
  textarea.value = next;
  textarea.focus();
  textarea.selectionStart = start + left.length;
  textarea.selectionEnd = start + left.length + mid.length;
  textarea.dispatchEvent(new Event("input"));
}
</script>

<!-- =========================================================
[EE-05] ENGINE :: SPEC NOTES (SPAWN / RENDER)
========================================================= -->
<script>
const specLayer = document.getElementById("specLayer");

// EE_FN_NEW_SPEC_NOTE
function newSpecNote(){
  return {
    id: "SN_" + Math.random().toString(16).slice(2),
    title: "SPEC_NOTE",
    text: "",
    x: 40 + Math.floor(Math.random()*80),
    y: 80 + Math.floor(Math.random()*80),
    w: 360,
    h: 240,
    open: true
  };
}

// EE_FN_RENDER_SPEC_NOTES
function renderSpecNotes(){
  specLayer.innerHTML = "";
  (STATE.payload.specNotes || []).forEach((n)=>{
    const win = document.createElement("div");
    win.className = "floatWin" + (n.open ? " open" : "");
    win.style.left = n.x + "px";
    win.style.top  = n.y + "px";
    win.style.width = n.w + "px";
    win.style.height = n.h + "px";
    win.dataset.id = n.id;

    win.innerHTML = `
      <div class="floatHead">
        <div class="left">
          <div class="title" contenteditable="true" spellcheck="false">${escapeHtml(n.title || "SPEC_NOTE")}</div>
        </div>
        <div style="display:flex; gap:8px; align-items:center">
          <button class="headBtn" data-act="min">-</button>
        </div>
      </div>
      <div class="floatBody" style="position:relative;">
        <textarea placeholder="SPEC TEXT"></textarea>
        <div class="noteTools">
          <button class="toolBtn" data-fx="b" title="Bold (**text**)">B</button>
          <button class="toolBtn" data-fx="i" title="Italic (*text*)">I</button>
          <button class="toolBtn" data-fx="s" title="Strike (~~text~~)">S</button>
        </div>
      </div>
    `;

    const titleEl = win.querySelector(".title");
    const ta = win.querySelector("textarea");
    ta.value = n.text || "";

    titleEl.addEventListener("input", ()=>{
      n.title = titleEl.textContent.trim() || "SPEC_NOTE";
      persist();
    });

    ta.addEventListener("input", ()=>{
      n.text = ta.value;
      persist();
    });

    win.querySelectorAll("[data-fx]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const fx = btn.dataset.fx;
        if(fx==="b") wrapSelection(ta, "**","**");
        if(fx==="i") wrapSelection(ta, "*","*");
        if(fx==="s") wrapSelection(ta, "~~","~~");
      });
    });

    win.querySelector("[data-act='min']").addEventListener("click", ()=>{
      n.open = false;
      persist();
    });

    // drag + resize persistence
    makeDraggableResizable(win, n, { headSelector: ".floatHead" });

    specLayer.appendChild(win);
  });
}

// WB helper
function escapeHtml(str){
  return String(str ?? "").replace(/[&<>"']/g, c=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}
</script>

<!-- =========================================================
[EE-06] ENGINE :: MINI SCREENS (KDTV1 FLOAT MODULES)
========================================================= -->
<script>
const screenLayer = document.getElementById("screenLayer");

// EE_FN_DEFAULT_SCREEN_FX
function defaultScreenFx(){
  return { br:1.0, ct:1.0, sat:1.0, hue:0, inv:0 };
}

// EE_FN_PARSE_YT_ID
function parseYouTubeId(input){
  const s = (input||"").trim();
  if(!s) return null;
  if(/^[a-zA-Z0-9_-]{8,15}$/.test(s) && !s.includes("http")) return s;
  try{
    const u = new URL(s);
    if(u.searchParams.get("v")) return u.searchParams.get("v");
    const parts = u.pathname.split("/").filter(Boolean);
    if(u.hostname.includes("youtu.be") && parts[0]) return parts[0];
    const embedIdx = parts.indexOf("embed");
    if(embedIdx >= 0 && parts[embedIdx+1]) return parts[embedIdx+1];
  }catch(e){ return null; }
  return null;
}

// EE_FN_FX_TO_FILTER
function fxToFilter(fx){
  return `brightness(${fx.br}) contrast(${fx.ct}) saturate(${fx.sat}) hue-rotate(${fx.hue}deg) invert(${fx.inv}%)`;
}

// EE_FN_NEW_SCREEN
function newScreen(){
  return {
    id: "SC_" + Math.random().toString(16).slice(2),
    mode: "blank",     // blank | yt | local
    ytUrl: "",
    ytId: "",
    localName: "",
    fx: defaultScreenFx(),
    x: 420 + Math.floor(Math.random()*120),
    y: 80 + Math.floor(Math.random()*120),
    w: 320,
    h: 210,
    open: true
  };
}

// EE_FN_RENDER_SCREENS
function renderScreens(){
  screenLayer.innerHTML = "";

  (STATE.payload.screens || []).forEach((s)=>{
    const win = document.createElement("div");
    win.className = "floatWin screenWin" + (s.open ? " open" : "");
    win.style.left = s.x + "px";
    win.style.top  = s.y + "px";
    win.style.width = s.w + "px";
    win.style.height = s.h + "px";
    win.dataset.id = s.id;

    win.innerHTML = `
      <div class="screenShell">
        <div class="screenMedia" style="--kdfx:${fxToFilter(s.fx)}"></div>
        <div class="screenBlank"></div>

        <div class="screenHud">
          <div class="pill">KDTV1</div>
          <div class="pill">${escapeHtml(s.mode || "BLANK")}</div>
        </div>

        <div class="screenControls">
          <div class="group">
            <button class="miniBtn" data-act="load">LOAD</button>
            <button class="miniBtn" data-act="fx">FX</button>
            <button class="miniBtn" data-act="go">GO KDTV1</button>
          </div>
          <div class="group">
            <button class="miniBtn" data-act="min">-</button>
          </div>
        </div>
      </div>
    `;

    const mediaHost = win.querySelector(".screenMedia");
    const blank = win.querySelector(".screenBlank");

    // render media
    mediaHost.style.filter = fxToFilter(s.fx);

    if(s.mode === "yt" && s.ytId){
      blank.style.display = "none";
      mediaHost.innerHTML = "";
      const ifr = document.createElement("iframe");
      ifr.src = `https://www.youtube.com/embed/${s.ytId}?rel=0&modestbranding=1&controls=1&iv_load_policy=3`;
      ifr.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
      ifr.allowFullscreen = true;
      ifr.style.width="100%"; ifr.style.height="100%"; ifr.style.border="0";
      mediaHost.appendChild(ifr);
    } else if(s.mode === "local" && s._blobUrl){
      blank.style.display = "none";
      mediaHost.innerHTML = "";
      const v = document.createElement("video");
      v.src = s._blobUrl;
      v.controls = true;
      v.playsInline = true;
      v.style.width="100%"; v.style.height="100%"; v.style.display="block";
      mediaHost.appendChild(v);
    } else {
      blank.style.display = "block";
      mediaHost.innerHTML = "";
    }

    // controls
    win.querySelector("[data-act='min']").addEventListener("click", ()=>{
      s.open = false; persist();
    });

    win.querySelector("[data-act='go']").addEventListener("click", ()=>{
      window.location.href = "https://ketadata.com/kdtv1.html";
    });

    win.querySelector("[data-act='load']").addEventListener("click", ()=>{
      const choice = prompt("PASTE YOUTUBE URL/ID (LEAVE BLANK FOR LOCAL FILE):", s.ytUrl || "");
      if(choice && choice.trim()){
        const id = parseYouTubeId(choice);
        if(id){
          s.mode = "yt";
          s.ytUrl = choice.trim();
          s.ytId = id;
          s.localName = "";
          delete s._blobUrl;
          persist();
        } else {
          toast("INVALID YT");
        }
      } else {
        const inp = document.createElement("input");
        inp.type = "file";
        inp.accept = "video/*,audio/*";
        inp.onchange = ()=>{
          const f = inp.files && inp.files[0];
          if(!f) return;
          s.mode = "local";
          s.localName = f.name;
          s.ytUrl = ""; s.ytId = "";
          s._blobUrl = URL.createObjectURL(f); // local-only
          persist();
        };
        inp.click();
      }
    });

    win.querySelector("[data-act='fx']").addEventListener("click", ()=>{
      // minimal FX prompt (fast); sliders can come later
      const br = prompt("BRIGHTNESS (0.6–1.6):", String(s.fx.br));
      const ct = prompt("CONTRAST (0.6–1.9):", String(s.fx.ct));
      const sat = prompt("SATURATE (0–2.2):", String(s.fx.sat));
      const hue = prompt("HUE (-180–180):", String(s.fx.hue));
      const inv = prompt("INVERT (0–100):", String(s.fx.inv));
      const fx = {
        br: clampNum(br, 0.6, 1.6, s.fx.br),
        ct: clampNum(ct, 0.6, 1.9, s.fx.ct),
        sat: clampNum(sat, 0.0, 2.2, s.fx.sat),
        hue: clampNum(hue, -180, 180, s.fx.hue),
        inv: clampNum(inv, 0, 100, s.fx.inv)
      };
      s.fx = fx;
      persist();
    });

    makeDraggableResizable(win, s, { headSelector: ".screenHud" }); // drag via HUD region
    screenLayer.appendChild(win);
  });
}

function clampNum(v, min, max, fallback){
  const n = Number(v);
  if(Number.isFinite(n)) return Math.max(min, Math.min(max, n));
  return fallback;
}
</script>

<!-- =========================================================
[WB-05] WIRING :: DRAG + RESIZE PERSISTENCE (WINDOWS)
========================================================= -->
<script>
function makeDraggableResizable(win, model, opts){
  const head = win.querySelector(opts.headSelector) || win;
  let dragging=false, ox=0, oy=0;

  head.addEventListener("mousedown", (e)=>{
    // ignore buttons
    if(e.target.closest("button")) return;
    dragging=true;
    const r = win.getBoundingClientRect();
    ox = e.clientX - r.left;
    oy = e.clientY - r.top;
  });

  window.addEventListener("mousemove", (e)=>{
    if(!dragging) return;
    model.x = Math.max(0, e.clientX - ox);
    model.y = Math.max(0, e.clientY - oy);
    win.style.left = model.x + "px";
    win.style.top  = model.y + "px";
  });

  window.addEventListener("mouseup", ()=> dragging=false);

  // Resize observer for persistence
  const ro = new ResizeObserver(()=>{
    const r = win.getBoundingClientRect();
    model.w = Math.max(180, Math.round(r.width));
    model.h = Math.max(120, Math.round(r.height));
    // do NOT spam persist during resize; debounce
    debouncePersist();
  });
  ro.observe(win);
}

let _dp=null;
function debouncePersist(){
  if(_dp) clearTimeout(_dp);
  _dp = setTimeout(()=> persist(), 250);
}
</script>

<!-- =========================================================
[WB-06] WIRING :: EVENTS / HOTKEYS / RENDER
========================================================= -->
<script>
// Buttons
$("btnImport").addEventListener("click", ()=> $("file").click());
$("file").addEventListener("change", async (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const txt = await f.text();
  importState(txt);
  e.target.value = "";
  toast("STATE IMPORTED");
});

$("btnExport").addEventListener("click", ()=>{ download("KETADATA_SHELL_KERNEL_v1_state.json", exportState()); toast("STATE EXPORTED"); });
$("btnCopy").addEventListener("click", ()=> copy(exportState()));

$("toggleDrawer").addEventListener("click", ()=> setDrawer(!$("drawer").classList.contains("open")));
$("btnCloseDrawer").addEventListener("click", ()=> setDrawer(false));

$("btnCopyUniversals").addEventListener("click", ()=> copy(STATE.universals || ""));
$("universals").addEventListener("input", ()=>{ STATE.universals = $("universals").value; persist(); });

$("btnSaveRoom").addEventListener("click", ()=>{
  STATE.room = ($("roomInput").value || "LOBBY").trim();
  STATE.roomUrl = ($("roomUrlInput").value || "").trim();
  toast("ROOM SAVED");
  persist();
});

$("btnGoRoom").addEventListener("click", ()=>{
  if(!STATE.roomUrl) return;
  window.location.href = STATE.roomUrl;
});
$("btnDismissRoom").addEventListener("click", ()=>{
  STATE.roomUrl = "";
  persist();
});

// KETA NOTE icon
$("ketaIcon").addEventListener("click", ()=>{
  const open = !$("ketaNote").classList.contains("open");
  setKetaNote(open);
  toast(open ? "KETA_NOTE OPEN" : "KETA_NOTE CLOSED");
});
$("btnHideNote").addEventListener("click", ()=> setKetaNote(false));
$("ketaText").addEventListener("input", ()=>{ STATE.ketaNote = $("ketaText").value; persist(); });

// KETA NOTE formatting tools
$("toolBold").addEventListener("click", ()=> wrapSelection($("ketaText"), "**","**"));
$("toolItalic").addEventListener("click", ()=> wrapSelection($("ketaText"), "*","*"));
$("toolStrike").addEventListener("click", ()=> wrapSelection($("ketaText"), "~~","~~"));

// SPEC button = spawn spec note (discrete)
$("btnSpec").addEventListener("click", ()=>{
  const n = newSpecNote();
  STATE.payload.specNotes.push(n);
  toast("SPEC_NOTE SPAWNED");
  persist();
});

// SCREEN button = spawn screen
$("btnScreen").addEventListener("click", ()=>{
  const s = newScreen();
  STATE.payload.screens.push(s);
  toast("SCREEN SPAWNED");
  persist();
});

// universals serial registry
$("serialRegistry").addEventListener("input", ()=>{
  const raw = $("serialRegistry").value || "";
  const lines = raw.split("\n").map(x=>x.trim()).filter(Boolean);
  STATE.payload.serialRegistry = Array.from(new Set(lines));
  if(!STATE.payload.serialRegistry.includes(FILE_SERIAL)) STATE.payload.serialRegistry.push(FILE_SERIAL);
  persist();
});

// Hotkeys
document.addEventListener("keydown", (e)=>{
  const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
  const typing = (tag==="textarea" || tag==="input");

  if(e.shiftKey && e.key.toLowerCase()==="i"){
    e.preventDefault();
    setInvert(!STATE.ui.invert);
    toast(STATE.ui.invert ? "INVERT ON" : "INVERT OFF");
    return;
  }

  if(!typing && /^[1-6]$/.test(e.key)){
    e.preventDefault();
    selectPreset(parseInt(e.key,10));
    toast(`LIGHT ${STATE.ui.lightPreset} SELECTED`);
    return;
  }

  if(!typing && (e.code==="Space" || e.key===" ")){
    e.preventDefault();
    toggleTransport();
    return;
  }

  // CTRL+B / CTRL+I / CTRL+SHIFT+S for markdown wraps (works in any textarea)
  if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="b"){
    const ta = document.activeElement && document.activeElement.tagName==="TEXTAREA" ? document.activeElement : $("ketaText");
    wrapSelection(ta, "**","**");
    e.preventDefault(); return;
  }
  if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="i"){
    const ta = document.activeElement && document.activeElement.tagName==="TEXTAREA" ? document.activeElement : $("ketaText");
    wrapSelection(ta, "*","*");
    e.preventDefault(); return;
  }
  if((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase()==="s"){
    const ta = document.activeElement && document.activeElement.tagName==="TEXTAREA" ? document.activeElement : $("ketaText");
    wrapSelection(ta, "~~","~~");
    e.preventDefault(); return;
  }

  if(e.key==="Escape"){
    setDrawer(false);
    setKetaNote(false);
    stopLight(true);
    STATE.ui.motionOn = false;
    toast("CLOSED");
    persist();
  }
});

// Render
function render(){
  root.classList.toggle("invert", !!STATE.ui.invert);
  motion.classList.toggle("run", !!STATE.ui.motionOn);

  $("ketaText").value = STATE.ketaNote || "";
  $("universals").value = STATE.universals || "";

  $("roomName").textContent = (STATE.room || "LOBBY").toUpperCase();
  $("roomInput").value = STATE.room || "";
  $("roomUrlInput").value = STATE.roomUrl || "";

  const s = stableSig();
  $("sig").textContent = s;
  $("sig2").textContent = s;

  $("lightLabel").textContent = String(STATE.ui.lightPreset);
  $("runLabel").textContent = STATE.ui.lightRunning ? "ON" : "OFF";
  $("motionLabel").textContent = STATE.ui.motionOn ? "ON" : "OFF";

  // room jump
  const hasUrl = !!(STATE.roomUrl && String(STATE.roomUrl).trim());
  $("roomJump").classList.toggle("show", hasUrl);
  if(hasUrl) $("roomJumpTxt").textContent = `ROOM LINK: ${(STATE.room||"ROOM").toUpperCase()}`;

  // serial registry surface
  $("serialRegistry").value = (STATE.payload.serialRegistry || []).join("\n");

  // spec notes + screens
  renderSpecNotes();
  renderScreens();
}

// Boot: open keta note by default? keep last state
// If state lacks a ketaNote window open flag, we keep it closed until icon
// (minimalist default).
render();

/* =========================================================
CHANGELOG
v1.1.0 :: ALL CAPS TOPBAR FIX; THIN NOTE OUTLINE; NOTE TOOLS (B/I/S); SPEC_NOTES; MINI KDTV SCREENS; SERIAL REGISTRY
v1.0.0 :: initial kernel
========================================================= */
</script>
</body>
</html>
