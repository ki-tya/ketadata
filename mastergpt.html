<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KETADATA — V-I MASTERDOC</title>
  <style>
    :root{
      --bg:#000;
      --fg:rgba(255,255,255,.90);
      --muted:rgba(255,255,255,.55);
      --hair:rgba(255,255,255,.14);
      --panel:rgba(255,255,255,.04);
      --panel2:rgba(255,255,255,.02);
      --accent:rgba(255,255,255,.82);
      --danger:rgba(255,255,255,.82);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: Arial, Helvetica, sans-serif;
      --fs: 13px; /* uniform text size rule */
      --lh: 1.45;
      --pageW: 860px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font-family:var(--sans);
      font-size:var(--fs);
      line-height:var(--lh);
      overflow-x:hidden;
    }

    /* layout */
    .topbar{
      position:fixed;
      left:0; right:0; top:0;
      height:44px;
      display:flex;
      align-items:center;
      gap:10px;
      padding:0 12px;
      border-bottom:1px solid var(--hair);
      background:rgba(0,0,0,.85);
      backdrop-filter: blur(8px);
      z-index:50;
    }
    .brand{
      font-weight:700;
      letter-spacing:.14em;
      text-transform:uppercase;
      opacity:.92;
      white-space:nowrap;
      user-select:none;
    }
    .sub{
      color:var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.85;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      flex:1;
    }
    .btn{
      background:var(--panel);
      border:1px solid rgba(255,255,255,.18);
      color:var(--fg);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-size:var(--fs);
      line-height:1;
      user-select:none;
    }
    .btn:hover{ border-color:rgba(255,255,255,.32); background:rgba(255,255,255,.06); }
    .btn:active{ transform: translateY(1px); }
    .btn.ghost{ background:transparent; }
    .btn.warn{ border-color:rgba(255,255,255,.32); }
    .btn.small{ padding:6px 8px; border-radius:9px; }
    .sep{ width:1px; height:22px; background:var(--hair); }

    .wrap{
      padding:64px 12px 18px;
      display:flex;
      justify-content:center;
    }
    .page{
      width: min(var(--pageW), calc(100vw - 24px));
      border:1px solid var(--hair);
      border-radius:14px;
      background:var(--panel2);
      overflow:hidden;
      box-shadow: 0 0 0 1px rgba(255,255,255,.05) inset, 0 18px 60px rgba(0,0,0,.55);
    }
    .meta{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid var(--hair);
      background:rgba(0,0,0,.38);
    }
    .metaLeft{
      display:flex;
      gap:10px;
      align-items:center;
      min-width:0;
    }
    .pill{
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.25);
      padding:4px 8px;
      border-radius:999px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color:var(--muted);
      font-size:var(--fs);
      white-space:nowrap;
    }
    .status{
      color:var(--muted);
      font-variant-numeric: tabular-nums;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:var(--fs);
      white-space:nowrap;
    }

    .editor{
      width:100%;
      min-height: calc(100vh - 64px - 44px - 28px);
      border:0;
      outline:0;
      resize:vertical;
      display:block;
      padding:12px;
      font-family:var(--sans);
      font-size:var(--fs);
      line-height:var(--lh);
      background:transparent;
      color:var(--fg);
      white-space:pre-wrap;
      overflow-wrap:anywhere;
    }

    .footerStamp{
      padding:10px 12px 12px;
      border-top:1px solid var(--hair);
      background:rgba(0,0,0,.38);
      color:var(--muted);
      font-family:var(--mono);
      font-size:var(--fs);
      line-height:1.35;
      white-space:pre-wrap;
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:100;
      padding:12px;
    }
    .modal{
      width:min(860px, 100%);
      border:1px solid rgba(255,255,255,.20);
      border-radius:14px;
      background:rgba(0,0,0,.86);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 60px rgba(0,0,0,.75);
      overflow:hidden;
    }
    .modalHead{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.14);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:rgba(0,0,0,.60);
    }
    .modalTitle{
      letter-spacing:.12em;
      text-transform:uppercase;
      font-weight:700;
      color:var(--accent);
      font-size:var(--fs);
      white-space:nowrap;
    }
    .modalBody{
      padding:10px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .ioRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .box{
      width:100%;
      min-height: 200px;
      border:1px solid rgba(255,255,255,.16);
      border-radius:12px;
      background:rgba(255,255,255,.03);
      color:var(--fg);
      padding:10px;
      font-family:var(--mono);
      font-size:var(--fs);
      line-height:1.35;
      outline:none;
      resize:vertical;
      white-space:pre;
      overflow:auto;
    }
    .hint{
      color:var(--muted);
      letter-spacing:.06em;
      text-transform:uppercase;
      font-size:var(--fs);
      line-height:1.25;
    }

    /* Print / PDF */
    body.print-dark{ --printBg:#000; --printFg:#fff; }
    body.print-light{ --printBg:#fff; --printFg:#000; }

    @media print{
      /* remove chrome */
      .topbar, .modalBack{ display:none !important; }
      .wrap{ padding:0 !important; }
      .page{
        width: 100% !important;
        border:0 !important;
        border-radius:0 !important;
        box-shadow:none !important;
        background: transparent !important;
      }
      .meta{ border:0 !important; background:transparent !important; padding:0 0 8px 0 !important; }
      .editor{
        min-height: auto !important;
        padding:0 !important;
      }

      /* PDF mode */
      html, body{
        background: var(--printBg) !important;
        color: var(--printFg) !important;
      }
      .editor, .meta, .pill, .status, .footerStamp{
        color: var(--printFg) !important;
      }
      .pill{
        border-color: rgba(127,127,127,.55) !important;
        background: transparent !important;
      }
      .footerStamp{
        border-top:1px solid rgba(127,127,127,.55) !important;
        background: transparent !important;
      }

      /* keep whitespace */
      .editor{ white-space: pre-wrap !important; }
      @page{ margin: 16mm; }
    }
  </style>
</head>
<body class="print-dark">
  <div class="topbar">
    <div class="brand">KETADATA</div>
    <div class="sub" id="docLabel">V-I MASTERDOC · LOCAL-FIRST · DARK MODE</div>

    <div class="sep"></div>

    <button class="btn small" id="btnPDF">EXPORT PDF</button>
    <button class="btn small ghost" id="btnIO">IMPORT/EXPORT</button>

    <div class="sep"></div>

    <button class="btn small ghost" id="btnPrintMode">PDF MODE: DARK</button>
    <button class="btn small ghost" id="btnClear">CLEAR</button>
  </div>

  <div class="wrap">
    <div class="page">
      <div class="meta">
        <div class="metaLeft">
          <div class="pill" id="pillId">FILE_ID: —</div>
          <div class="pill" id="pillVer">VERSION: V-I</div>
        </div>
        <div class="status" id="status">—</div>
      </div>

      <textarea id="editor" class="editor" spellcheck="false"
        placeholder="KETADATA V-I MASTERDOC

1. PURPOSE
2. SYSTEM PRIMITIVES
3. ROOMS & SURFACES
4. STATE & PERSISTENCE
5. INTERACTION LAWS
6. FILE CANON
7. NON-GOALS
8. OPEN QUESTIONS (V-II)

Write directly. Everything autosaves locally."></textarea>

      <div class="footerStamp" id="stamp"></div>
    </div>
  </div>

  <div class="modalBack" id="modalBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="modalTitle">STATE IO</div>
        <div class="ioRow">
          <button class="btn small" id="btnDownload">DOWNLOAD .JSON</button>
          <button class="btn small ghost" id="btnLoad">LOAD .JSON</button>
          <input id="filePick" type="file" accept="application/json" style="display:none" />
          <button class="btn small ghost" id="btnClose">CLOSE</button>
        </div>
      </div>
      <div class="modalBody">
        <div class="hint">
          This is local-first. Export writes a downloadable JSON file. Import restores the exact text and metadata.
          PDF export uses your browser print dialog. For dark PDFs, enable “Background graphics” in the print dialog.
        </div>
        <textarea id="ioBox" class="box" spellcheck="false"></textarea>
        <div class="ioRow">
          <button class="btn small" id="btnApplyBox">APPLY FROM BOX</button>
          <button class="btn small ghost" id="btnCopyBox">COPY BOX</button>
          <button class="btn small ghost" id="btnRefreshBox">REFRESH BOX</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const LS_KEY = "KETADATA_MASTERDOC_VI_STATE_v1";

      const $ = (id) => document.getElementById(id);

      const editor = $("editor");
      const status = $("status");
      const pillId = $("pillId");
      const stamp = $("stamp");
      const docLabel = $("docLabel");

      const modalBack = $("modalBack");
      const ioBox = $("ioBox");
      const filePick = $("filePick");

      const btnPDF = $("btnPDF");
      const btnIO = $("btnIO");
      const btnClear = $("btnClear");
      const btnPrintMode = $("btnPrintMode");

      const btnClose = $("btnClose");
      const btnDownload = $("btnDownload");
      const btnLoad = $("btnLoad");
      const btnApplyBox = $("btnApplyBox");
      const btnCopyBox = $("btnCopyBox");
      const btnRefreshBox = $("btnRefreshBox");

      function nowISO(){ return new Date().toISOString(); }
      function uid(){
        // stable-enough local UID (not crypto; just unique per browser)
        const a = Math.random().toString(16).slice(2);
        const b = Date.now().toString(16);
        return ("MDOC_" + b + "_" + a).toUpperCase();
      }

      const state = {
        FILE_ID: null,
        ROOM_ID: "K_MASTERDOC",
        VERSION_ID: "V-I",
        UPDATED_AT: null,
        CHANGELOG: "INIT",
        text: ""
      };

      function hydrateDefault(){
        state.FILE_ID = uid();
        state.UPDATED_AT = nowISO();
        state.text = editor.value || "";
      }

      function load(){
        try{
          const raw = localStorage.getItem(LS_KEY);
          if (!raw){ hydrateDefault(); return; }
          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== "object"){ hydrateDefault(); return; }

          state.FILE_ID = parsed.FILE_ID || uid();
          state.ROOM_ID = parsed.ROOM_ID || "K_MASTERDOC";
          state.VERSION_ID = parsed.VERSION_ID || "V-I";
          state.UPDATED_AT = parsed.UPDATED_AT || nowISO();
          state.CHANGELOG = parsed.CHANGELOG || "LOAD";
          state.text = typeof parsed.text === "string" ? parsed.text : "";

          editor.value = state.text;
        } catch(e){
          hydrateDefault();
        }
      }

      function save(changelog){
        state.text = editor.value;
        state.UPDATED_AT = nowISO();
        state.CHANGELOG = changelog || state.CHANGELOG || "SAVE";
        localStorage.setItem(LS_KEY, JSON.stringify(state));
        renderMeta();
      }

      function renderMeta(){
        pillId.textContent = "FILE_ID: " + (state.FILE_ID || "—");
        const words = editor.value.trim() ? editor.value.trim().split(/\s+/).length : 0;
        const chars = editor.value.length;

        status.textContent =
          "UPDATED " + (state.UPDATED_AT ? state.UPDATED_AT.replace("T"," ").replace("Z","Z") : "—") +
          " · WORDS " + words +
          " · CHARS " + chars;

        docLabel.textContent = "V-I MASTERDOC · " + (state.FILE_ID || "—");
        stamp.textContent = buildStamp();
      }

      function buildStamp(){
        // Mandatory KETADATA single-file HTML serialization stamp (bottom of file)
        return [
          "AE/EE/WB SERIALIZATION STAMP",
          "FILE_ID: " + (state.FILE_ID || "—"),
          "ROOM_ID: " + (state.ROOM_ID || "—"),
          "VERSION_ID: " + (state.VERSION_ID || "—"),
          "UPDATED_AT: " + (state.UPDATED_AT || "—"),
          "CHANGELOG: " + (state.CHANGELOG || "—")
        ].join("\n");
      }

      // autosave (debounced)
      let t = null;
      editor.addEventListener("input", () => {
        clearTimeout(t);
        t = setTimeout(() => save("EDIT"), 250);
      });

      // IO modal
      function openIO(){
        modalBack.style.display = "flex";
        modalBack.setAttribute("aria-hidden", "false");
        refreshBox();
      }
      function closeIO(){
        modalBack.style.display = "none";
        modalBack.setAttribute("aria-hidden", "true");
      }
      btnIO.addEventListener("click", openIO);
      btnClose.addEventListener("click", closeIO);
      modalBack.addEventListener("click", (e) => {
        if (e.target === modalBack) closeIO();
      });

      function refreshBox(){
        ioBox.value = JSON.stringify(state, null, 2);
      }

      btnRefreshBox.addEventListener("click", refreshBox);

      btnCopyBox.addEventListener("click", async () => {
        try{
          await navigator.clipboard.writeText(ioBox.value);
          // no toast; update changelog quietly
          save("COPY_BOX");
        } catch(e){}
      });

      btnApplyBox.addEventListener("click", () => {
        try{
          const parsed = JSON.parse(ioBox.value);
          if (!parsed || typeof parsed !== "object") return;

          state.FILE_ID = parsed.FILE_ID || state.FILE_ID || uid();
          state.ROOM_ID = parsed.ROOM_ID || state.ROOM_ID || "K_MASTERDOC";
          state.VERSION_ID = parsed.VERSION_ID || state.VERSION_ID || "V-I";
          state.text = typeof parsed.text === "string" ? parsed.text : editor.value;

          editor.value = state.text;
          save("APPLY_BOX");
          refreshBox();
        } catch(e){}
      });

      // Download JSON
      function downloadJSON(){
        save("EXPORT_JSON");
        const blob = new Blob([JSON.stringify(state, null, 2)], { type:"application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        const safeId = (state.FILE_ID || "KETADATA_MASTERDOC").replace(/[^A-Z0-9_\-]/gi, "_");
        a.download = safeId + ".json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(a.href), 500);
      }
      btnDownload.addEventListener("click", downloadJSON);

      // Load JSON
      btnLoad.addEventListener("click", () => filePick.click());
      filePick.addEventListener("change", async () => {
        const f = filePick.files && filePick.files[0];
        if (!f) return;
        try{
          const txt = await f.text();
          const parsed = JSON.parse(txt);
          if (!parsed || typeof parsed !== "object") return;

          state.FILE_ID = parsed.FILE_ID || state.FILE_ID || uid();
          state.ROOM_ID = parsed.ROOM_ID || "K_MASTERDOC";
          state.VERSION_ID = parsed.VERSION_ID || "V-I";
          state.text = typeof parsed.text === "string" ? parsed.text : "";

          editor.value = state.text;
          save("IMPORT_JSON");
          refreshBox();
        } catch(e){}
        filePick.value = "";
      });

      // Clear (keeps FILE_ID unless user hard resets file)
      btnClear.addEventListener("click", () => {
        editor.value = "";
        save("CLEAR_TEXT");
      });

      // PDF mode toggle (dark/light)
      function updatePrintModeLabel(){
        const dark = document.body.classList.contains("print-dark");
        btnPrintMode.textContent = "PDF MODE: " + (dark ? "DARK" : "LIGHT");
      }
      btnPrintMode.addEventListener("click", () => {
        const dark = document.body.classList.contains("print-dark");
        document.body.classList.toggle("print-dark", !dark);
        document.body.classList.toggle("print-light", dark);
        updatePrintModeLabel();
      });
      updatePrintModeLabel();

      // Export PDF (browser print dialog)
      btnPDF.addEventListener("click", () => {
        save("EXPORT_PDF");
        // print dialog (user chooses Save as PDF)
        window.print();
      });

      // hotkeys (non-invasive)
      addEventListener("keydown", (e) => {
        // avoid interfering with typing
        if (e.target && (e.target.tagName === "TEXTAREA" || e.target.tagName === "INPUT")) {
          // allow Ctrl/Cmd+P and Ctrl/Cmd+S style commands
        }
        const mod = e.ctrlKey || e.metaKey;
        if (mod && (e.key === "p" || e.key === "P")) {
          e.preventDefault();
          btnPDF.click();
        }
        if (mod && (e.key === "e" || e.key === "E")) {
          e.preventDefault();
          openIO();
        }
      });

      // init
      load();
      if (!state.FILE_ID) hydrateDefault();
      save("BOOT");
      renderMeta();
      refreshBox();
    })();
  </script>

  <!--
  AE/EE/WB SERIALIZATION STAMP (MANDATORY)
  FILE_ID: KETADATA_MASTERDOC_HTML
  ROOM_ID: K_MASTERDOC
  VERSION_ID: V1
  UPDATED_AT: 2026-01-03T00:00:00.000Z
  CHANGELOG: INITIAL_TEMPLATE
  -->
</body>
</html>
