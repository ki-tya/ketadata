<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KETADATA_BASE_SYSTEM.html</title>

<!-- =========================================================
AE ▸ AESTHETIC LAYER
KETADATA BASE — BLACK / WHITE / GREY — SHARP / INDUSTRIAL
========================================================= -->
<style>
:root{
  --bg:#000; --fg:#fff; --muted:#8a8a8a; --line:#222; --line2:#333;
  --top:44px; --bot:34px;

  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  --sans: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

  --ctl-radius:0px;
  --ctl-alpha:0.82;
  --ctl-bg: rgba(0,0,0,var(--ctl-alpha));
  --note-border: rgba(255,255,255,0.78);
  --drawer-h: 0.42;
}
*{box-sizing:border-box}
html,body{height:100%; margin:0}
body{background:var(--bg); color:var(--fg); font-family:var(--sans); overflow:hidden; user-select:none}
#root{position:fixed; inset:0; background:#000}
#root.invert{filter:invert(1)}

/* FULLSCREEN: hides panels, keeps visuals alive */
#root.fs .topbar,
#root.fs .bottombar,
#root.fs .drawer,
#root.fs #pinnedPanel,
#root.fs #armedBar,
#root.fs .toast{display:none !important}

/* BLACKOUT: hard black screen, kills visuals + panels */
#root.blackout .topbar,
#root.blackout .bottombar,
#root.blackout .drawer,
#root.blackout #pinnedPanel,
#root.blackout #armedBar,
#root.blackout .toast,
#root.blackout .ketaNote{display:none !important}
#root.blackout #stage{background:#000 !important; filter:none !important}
#root.blackout #motion{display:none !important}

/* Stage */
#stage{position:absolute; inset:0; background:#000}
#motion{
  position:absolute; inset:0; pointer-events:none; opacity:0;
  background:repeating-linear-gradient(135deg, rgba(255,255,255,0.06) 0px, rgba(255,255,255,0.06) 1px, rgba(0,0,0,0) 12px, rgba(0,0,0,0) 22px);
  mix-blend-mode:screen;
  transform:translate3d(0,0,0);
}
#motion.run{opacity:0.12; animation:scanflow 2.2s linear infinite}
@keyframes scanflow{0%{transform:translate3d(-80px,60px,0)}100%{transform:translate3d(80px,-60px,0)}}

/* Top bar */
.topbar{
  position:absolute; top:0; left:0; right:0; height:var(--top);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 10px; border-bottom:1px solid var(--line);
  background:linear-gradient(180deg,#070707,#000);
  z-index:10;
}
.brand{display:flex; align-items:center; gap:10px; font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase}
.brand .sq{width:10px; height:10px; border:1px solid var(--fg); background:#000}
.roomBadge{display:flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted); border:1px solid var(--line2); padding:4px 8px}
.actions{display:flex; align-items:center; gap:8px; font-family:var(--mono); font-size:12px}
.btn{
  background:transparent; color:var(--fg);
  border:1px solid var(--line2);
  padding:6px 10px;
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.08em;
  text-transform:uppercase;
  cursor:pointer;
}
.btn:hover{border-color:var(--fg)}
.btn:active{transform:translateY(1px)}
.kbd{border:1px solid var(--line2); padding:2px 6px; color:var(--muted); font-size:11px}
.ketaIcon{
  width:16px; height:16px;
  border:2px solid var(--fg);
  background:var(--fg);
  cursor:pointer;
}
.ketaIcon.open{background:#000}

/* Bottom bar */
.bottombar{
  position:absolute; left:0; right:0; bottom:0; height:var(--bot);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 10px; border-top:1px solid var(--line);
  background:linear-gradient(0deg,#070707,#000);
  z-index:10;
  font-family:var(--mono); font-size:11px; color:var(--muted);
}
.toggle{
  border:1px solid var(--line2);
  background:transparent;
  color:var(--fg);
  padding:4px 8px;
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
  cursor:pointer;
}
.toggle:hover{border-color:var(--fg)}

/* Drawer (System panel) */
.drawer{
  position:absolute; left:0; right:0;
  bottom:var(--bot);
  height:calc((100% - var(--top) - var(--bot)) * var(--drawer-h));
  background:var(--ctl-bg);
  border-top:1px solid var(--line2);
  transform:translateY(100%);
  transition:transform 160ms linear;
  z-index:9;
}
.drawer.open{transform:translateY(0)}
.drawerInner{
  height:100%;
  display:grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap:10px;
  padding:10px;
}
.panel{
  border:1px solid var(--line2);
  background:rgba(0,0,0,0.58);
  min-height:0;
  display:flex;
  flex-direction:column;
}
.panelHeader{
  display:flex; align-items:center; justify-content:space-between;
  padding:8px 10px;
  border-bottom:1px solid var(--line2);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.10em;
  text-transform:uppercase;
}
.panelHeader .mini{color:var(--muted); font-size:10px}
.panelBody{padding:10px; overflow:auto; min-height:0}
.row{display:flex; gap:8px; align-items:center; margin-bottom:8px}
.field{
  width:100%;
  border:1px solid var(--line2);
  background:#000;
  color:var(--fg);
  padding:8px 10px;
  font-family:var(--mono);
  font-size:12px;
  outline:none;
}
.field::placeholder{color:#555}
.textarea{
  width:100%;
  min-height:120px;
  resize:none;
  border:1px solid var(--line2);
  background:#000;
  color:var(--fg);
  padding:10px;
  font-family:var(--mono);
  font-size:12px;
  outline:none;
}
.small{font-size:10px; color:var(--muted); font-family:var(--mono); line-height:1.35}
.hr{height:1px; background:var(--line2); margin:10px 0}
.pillRow{display:flex; flex-wrap:wrap; gap:6px}
.pill{
  border:1px solid var(--line2);
  padding:6px 8px;
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.08em;
  cursor:pointer;
  user-select:none;
}
.pill:hover{border-color:var(--fg)}
.pill.on{background:var(--fg); color:#000}

/* Registry list */
.list{display:flex; flex-direction:column; gap:6px}
.item{
  border:1px solid var(--line2);
  padding:8px 10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.06em;
}
.item .left{display:flex; flex-direction:column; gap:2px; min-width:0}
.item .name{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-transform:uppercase}
.item .url{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:var(--muted); font-size:10px}
.item .right{display:flex; gap:6px; flex-shrink:0}
.iconBtn{
  border:1px solid var(--line2);
  background:transparent;
  color:var(--fg);
  padding:6px 8px;
  font-family:var(--mono);
  font-size:11px;
  cursor:pointer;
}
.iconBtn:hover{border-color:var(--fg)}
.iconBtn.on{background:var(--fg); color:#000}

/* Pinned panel */
#pinnedPanel{
  position:absolute;
  top:var(--top);
  left:0;
  width:340px;
  max-height:calc(100% - var(--top) - var(--bot));
  border-right:1px solid var(--line2);
  background:rgba(0,0,0,0.78);
  z-index:8;
  display:none;
  flex-direction:column;
}
#pinnedPanel.show{display:flex}
#pinnedPanel .panelHeader{border-bottom:1px solid var(--line2)}
#pinnedPanel .panelBody{padding:10px}

/* Armed bar (Active room quick controls) */
#armedBar{
  position:absolute;
  right:10px;
  top:calc(var(--top) + 10px);
  border:1px solid var(--line2);
  background:rgba(0,0,0,0.72);
  padding:8px;
  z-index:8;
  display:flex;
  gap:6px;
}

/* KETA_NOTE */
.ketaNote{
  position:absolute;
  top:76px;
  right:18px;
  width:340px;
  height:220px;
  border:1px solid var(--note-border);
  background:rgba(0,0,0,0.72);
  z-index:11;
  display:none;
  flex-direction:column;
  resize:both;
  overflow:hidden;
}
.ketaNote.open{display:flex}
.ketaNoteHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:8px 10px;
  border-bottom:1px solid var(--line2);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.10em;
  text-transform:uppercase;
  cursor:move;
}
.ketaNoteHead .title{display:flex; align-items:center; gap:8px}
.ketaNoteHead .sq{width:10px; height:10px; border:1px solid var(--fg); background:var(--fg)}
.ketaNoteHead .sq.hollow{background:#000}
.ketaNoteBody{padding:10px; display:flex; flex-direction:column; gap:8px; height:100%}
.ketaNoteBody textarea{flex:1}

/* Toast */
.toast{
  position:absolute;
  left:50%;
  bottom:calc(var(--bot) + 10px);
  transform:translateX(-50%);
  border:1px solid var(--line2);
  background:rgba(0,0,0,0.78);
  padding:8px 12px;
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
  color:var(--fg);
  opacity:0;
  pointer-events:none;
  z-index:12;
  transition:opacity 120ms linear;
}
.toast.show{opacity:1}

/* Collapse */
.collapsed .panelBody{display:none}
.collapsed .panelHeader{border-bottom:none}

/* Small helpers */
a{color:inherit; text-decoration:none}
</style>
</head>
<body>
<div id="root">
  <div id="stage"></div>
  <div id="motion"></div>

  <div class="topbar">
    <div class="brand">
      <div class="sq"></div>
      <div>KETADATA / BASE</div>
      <div class="kbd">SHIFT+K</div>
      <div class="kbd">SHIFT+I</div>
      <div class="kbd">SHIFT+N</div>
      <div class="kbd">SHIFT+F</div>
      <div class="kbd">1–6</div>
    </div>
    <div class="roomBadge" id="roomBadge">ROOM: <span id="roomName">BASE</span></div>
    <div class="actions">
      <button class="btn" id="btnDrawer">SYSTEM</button>
      <div class="ketaIcon" id="ketaIcon" title="KETA_NOTE"></div>
      <button class="btn" id="btnExport">EXPORT</button>
      <button class="btn" id="btnImport">IMPORT</button>
      <button class="btn" id="btnReset">RESET</button>
    </div>
  </div>

  <div id="pinnedPanel" class="">
    <div class="panelHeader">
      <div>PINNED</div>
      <div class="mini">PERSIST UNTIL UNPINNED</div>
    </div>
    <div class="panelBody">
      <div class="small">ROOMS</div>
      <div class="hr"></div>
      <div class="list" id="pinnedRoomsList"></div>
      <div class="hr"></div>
      <div class="small">SETS</div>
      <div class="hr"></div>
      <div class="list" id="pinnedSetsList"></div>
    </div>
  </div>

  <div id="armedBar">
    <button class="iconBtn" id="armedGo">GO</button>
    <button class="iconBtn" id="armedNewTab">TAB</button>
    <button class="iconBtn" id="armedCopy">COPY</button>
  </div>

  <div class="drawer" id="drawer">
    <div class="drawerInner">

      <div class="panel" id="panelUniversals">
        <div class="panelHeader">
          <div>UNIVERSALS</div>
          <button class="iconBtn" id="btnCollapseUniversals">-</button>
        </div>
        <div class="panelBody">
          <div class="small">GLOBAL NOTES / RULES / REMINDERS</div>
          <div class="hr"></div>
          <textarea id="universals" class="textarea" placeholder="UNIVERSALS..."></textarea>
          <div class="hr"></div>
          <div class="row">
            <div class="small">MOTION</div>
            <div class="pillRow">
              <div class="pill" id="pillMotion">ON/OFF</div>
            </div>
          </div>
          <div class="row">
            <div class="small">LIGHTS</div>
            <div class="pillRow" id="lightPills"></div>
          </div>
        </div>
      </div>

      <div class="panel" id="panelRegistry">
        <div class="panelHeader">
          <div>REGISTRY</div>
          <button class="iconBtn" id="btnCollapseRegistry">-</button>
        </div>
        <div class="panelBody">
          <div class="small">ROOM PRESETS (NAME + URL). CORE PRESETS ALWAYS PRESENT.</div>
          <div class="hr"></div>
          <div class="row">
            <input id="roomInput" class="field" placeholder="ROOM NAME" />
          </div>
          <div class="row">
            <input id="roomUrlInput" class="field" placeholder="ROOM URL (RELATIVE OR ABSOLUTE)" />
          </div>
          <div class="row">
            <button class="btn" id="btnSaveRoom">SAVE</button>
            <button class="btn" id="btnSetActiveRoom">SET ACTIVE</button>
            <button class="btn" id="btnDeleteRoom">DELETE</button>
          </div>
          <div class="hr"></div>
          <div class="list" id="registryList"></div>
        </div>
      </div>

      <div class="panel" id="panelActive">
        <div class="panelHeader">
          <div>ACTIVE</div>
          <button class="iconBtn" id="btnCollapseActive">-</button>
        </div>
        <div class="panelBody">
          <div class="small">CURRENT ACTIVE ROOM (USED BY GO/TAB/COPY + HOTKEY NAV)</div>
          <div class="hr"></div>
          <div class="row">
            <input id="activeRoom" class="field" placeholder="ACTIVE ROOM" disabled />
          </div>
          <div class="row">
            <input id="activeUrl" class="field" placeholder="ACTIVE URL" disabled />
          </div>
          <div class="row">
            <button class="btn" id="btnGoActive">GO</button>
            <button class="btn" id="btnNewTabActive">TAB</button>
            <button class="btn" id="btnCopyActiveUrl">COPY URL</button>
          </div>
          <div class="hr"></div>
          <div class="small">PINNING IS SOVEREIGN (PERSISTS UNTIL YOU UNPIN).</div>
          <div class="row">
            <button class="btn" id="btnTogglePins">PINS</button>
          </div>
        </div>
      </div>

      <div class="panel" id="panelSets">
        <div class="panelHeader">
          <div>SETS</div>
          <button class="iconBtn" id="btnCollapseSets">-</button>
        </div>
        <div class="panelBody">
          <div class="small">SETS ARE CLUSTERS OF LINKS (PINNABLE). SIMPLE. PERMISSIVE.</div>
          <div class="hr"></div>
          <div class="row">
            <input id="setNameInput" class="field" placeholder="SET NAME" />
          </div>
          <div class="row">
            <button class="btn" id="btnCreateSet">CREATE</button>
            <button class="btn" id="btnRenameSet">RENAME</button>
            <button class="btn" id="btnDeleteSet">DELETE</button>
            <button class="btn" id="btnPinSet">PIN</button>
          </div>
          <div class="hr"></div>
          <div class="small">ITEMS (ONE URL PER LINE; OPTIONAL LABEL BEFORE URL)</div>
          <textarea id="setItemsInput" class="textarea" placeholder="LABEL https://...\nhttps://...\n..."></textarea>
          <div class="row">
            <button class="btn" id="btnSaveSetItems">SAVE ITEMS</button>
            <button class="btn" id="btnClearSetItems">CLEAR</button>
          </div>
          <div class="hr"></div>
          <div class="list" id="setsList"></div>
        </div>
      </div>

      <div class="panel" id="panelBulk">
        <div class="panelHeader">
          <div>BULK</div>
          <button class="iconBtn" id="btnCollapseBulk">-</button>
        </div>
        <div class="panelBody">
          <div class="small">BULK ADD ROOM PRESETS (ONE URL PER LINE). NAME AUTO-DERIVED IF OMITTED.</div>
          <div class="hr"></div>
          <textarea id="bulkInput" class="textarea" placeholder="CALENDAR calendar1.html\nmap.html\n..."></textarea>
          <div class="row">
            <button class="btn" id="btnBulkAdd">ADD</button>
            <button class="btn" id="btnBulkClear">CLEAR</button>
          </div>
          <div class="hr"></div>
          <div class="small">PROMPT EXPORT (RUTHLESS, NO FLUFF)</div>
          <div class="row">
            <button class="btn" id="btnPromptExport">COPY PROMPT</button>
          </div>
          <div class="small" id="promptPreview"></div>
        </div>
      </div>

      <div class="panel" id="panelPresets">
        <div class="panelHeader">
          <div>PRESETS</div>
          <button class="iconBtn" id="btnCollapsePresets">-</button>
        </div>
        <div class="panelBody">
          <div class="small">UNIVERSAL HOTKEYS: SHIFT+K (LANDING), SHIFT+X (CRUNCH1), SHIFT+Z (KDTV1), SHIFT+V (POD), SHIFT+W (WORLD), SHIFT+P (INFINITY)</div>
          <div class="hr"></div>
          <div class="row">
            <button class="btn" id="btnLanding">LANDING</button>
            <button class="btn" id="btnCrunch">CRUNCH1</button>
            <button class="btn" id="btnKDTV">KDTV1</button>
          </div>
          <div class="row">
            <button class="btn" id="btnPod">POD</button>
            <button class="btn" id="btnWorld">WORLD</button>
            <button class="btn" id="btnInfinity">INFINITY</button>
          </div>
          <div class="hr"></div>
          <div class="small">STATE: EXACT UI RECREATION ONLY. NO CONSTRAINTS. NO ALGORITHMS.</div>
        </div>
      </div>

    </div>
  </div>

  <div class="ketaNote" id="ketaNote">
    <div class="ketaNoteHead" id="ketaNoteHead">
      <div class="title">
        <div class="sq" id="ketaSq"></div>
        <div>KETA_NOTE</div>
      </div>
      <button class="iconBtn" id="btnHideNote">-</button>
    </div>
    <div class="ketaNoteBody">
      <textarea id="ketaText" class="textarea" placeholder="KETA_NOTE..."></textarea>
      <div class="small">DRAG + RESIZE. PERSISTS.</div>
    </div>
  </div>

  <div class="bottombar">
    <div>BASE_SYSTEM_SOVEREIGN</div>
    <div style="display:flex; gap:8px; align-items:center;">
      <button class="toggle" id="btnInvert">INVERT</button>
      <button class="toggle" id="btnBlackout">NULL</button>
      <button class="toggle" id="btnFullscreen">FULLSCREEN</button>
    </div>
    <div id="status">READY</div>
  </div>

  <div class="toast" id="toast">SAVED</div>

  <input id="file" type="file" accept="application/json" style="display:none" />
</div>

<!-- =========================================================
EE ▸ ENGINE LAYER
========================================================= -->
<script>
/* =========================================================
EE ▸ CONFIG (PATHS)
========================================================= */
const URLS = {
  LANDING: "index11.html",
  PHOTOBOOTH: "crunch1.html",
  KDTV: "kdtv1.html",
  POD: "room.html",
  WORLD: "map.html",
  INFINITY: "infinity.html",
  CALENDAR: "calendar1.html",
  STUDIO: "tester3.html",
  LAB: "labyrinth.html"
};

/* =========================================================
EE ▸ STORAGE — DUMBEST GUARANTEED FIX (SOVEREIGN KEY)
GOAL:
- Base persists across refresh, hotkey nav, back/forward, new tabs.
- No path scoping. No file name scoping. No PAGE_ID scoping.
- ONE KEY IS LAW.

Notes:
- We still migrate from older keys (v1/v2/path-scoped) into the sovereign key.
========================================================= */
const FILE_ID="KETADATA_SHELL8";
const PAGE_ID="BASE_SYSTEM";
const STORAGE_EPOCH="BASE_CANON";

function nowISO(){return new Date().toISOString();}
const $=(id)=>document.getElementById(id);

const root=$("root");
const stage=$("stage");
const motion=$("motion");

/* SOVEREIGN CANON KEYS (DUMB FIX: CONSTANT, UNCHANGING) */
const STORAGE_KEY_MAIN   = "KDT::BASE::SOVEREIGN::STATE";
const STORAGE_KEY_BACKUP = "KDT::BASE::SOVEREIGN::STATE::BACKUP";
const STORAGE_KEY_TMP    = "KDT::BASE::SOVEREIGN::STATE::TMP";

/* Cross-tab channel (same-origin) */
let BC = null;
try{ BC = new BroadcastChannel("KDT::BASE::SOVEREIGN::BC"); }catch(_){}

/* Previous keys (migration only) */
const STORAGE_KEY_CANON_OLD = `KDT::BASE::STATE::${FILE_ID}::${PAGE_ID}::CANON_v1`;
const STORAGE_KEY_BACKUP_OLD = `KDT::BASE::STATE::${FILE_ID}::${PAGE_ID}::CANON_v1::BACKUP`;
const STORAGE_KEY_TMP_OLD = `KDT::BASE::STATE::${FILE_ID}::${PAGE_ID}::CANON_v1::TMP`;

const STORAGE_KEY_LEGACY_OLD = `KDT::STATE::${FILE_ID}::${PAGE_ID}::${STORAGE_EPOCH}`;
const STORAGE_KEY_CANON_OLD2 = `KDT::STATE::${FILE_ID}::${PAGE_ID}::${STORAGE_EPOCH}::BASE`;

function loadFromKey(key){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){
    return null;
  }
}

/* migrate from any prior path-scoped v2 keys (any path) */
function findLastPathScopedV2Keys(){
  const mains=[], backups=[];
  try{
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      if(!k) continue;
      if(k.startsWith(`KDT::BASE::STATE::${FILE_ID}::${PAGE_ID}::`) && k.includes("CANON_v2")){
        if(k.endsWith("::BACKUP")) backups.push(k);
        else if(!k.endsWith("::TMP")) mains.push(k);
      }
    }
  }catch(e){}
  return { mains, backups };
}
function pickMostRecent(keys){
  // Prefer updatedAt inside payload if present.
  let bestKey="", bestTs=-1;
  for(const k of keys){
    const obj=loadFromKey(k);
    if(!obj) continue;
    const ts=Date.parse((obj && obj.updatedAt) || "") || 0;
    if(ts>bestTs){ bestTs=ts; bestKey=k; }
  }
  return bestKey || (keys[0]||"");
}

/* =========================================================
EE ▸ DEFAULT PRESETS (ALWAYS PRESENT)
========================================================= */
const CORE_PRESETS = [
  { room:"CALENDAR",  roomUrl:URLS.CALENDAR },
  { room:"POD",       roomUrl:URLS.POD },
  { room:"WORLD",     roomUrl:URLS.WORLD },
  { room:"KDTV",      roomUrl:URLS.KDTV },
  { room:"PHOTOBOOTH",roomUrl:URLS.PHOTOBOOTH },
  { room:"STUDIO",    roomUrl:URLS.STUDIO },
  { room:"LAB",       roomUrl:URLS.LAB }
];

/* =========================================================
EE ▸ STATE
========================================================= */
function uid8(){return Math.random().toString(16).slice(2,10).toUpperCase();}
function canonRoomName(s){
  s=String(s||"").trim().toUpperCase();
  if(!s) return "";
  return s.replace(/[^A-Z0-9_\\-]/g,"").slice(0,32);
}
function canonSetName(s){
  s=String(s||"").trim().toUpperCase();
  if(!s) return "";
  return s.replace(/[^A-Z0-9_\\- ]/g,"").replace(/\\s+/g," ").slice(0,40);
}
function deriveNameFromUrl(url){
  try{
    const u=new URL(url, location.href);
    const p=u.pathname.split("/").filter(Boolean).pop() || u.host;
    return canonRoomName((p||"LINK").replace(/\\.html?$/i,""));
  }catch(_){
    const p=String(url||"").split("/").filter(Boolean).pop()||"LINK";
    return canonRoomName(p.replace(/\\.html?$/i,""));
  }
}

const DEFAULT={
  version:"KETADATA_SHELL_KERNEL_v1",
  updatedAt:nowISO(),
  _rev: 0,
  ketaNote:"",
  universals:"",
  room:"BASE",
  roomUrl:"",
  ui: {
    invert:false,
    blackout:false,
    fullscreen:false,

    lightPreset:1,
    lightRunning:false,
    motionOn:false,

    pinnedRooms: [],
    pinnedSets: [],

    drawerOpen: false,
    noteOpen: false,

    universalsCollapsed: false,
    registryCollapsed: false,
    activeCollapsed: false,
    setsCollapsed: false,
    bulkCollapsed: false,
    presetsCollapsed: false,

    noteRect: { x:null, y:76, w:340, h:220 },
    drawerH: 0.42
  },
  payload:{
    roomPresets:[],
    sets:[]
  }
};

function mergeDefault(obj){
  const out=structuredClone(DEFAULT);
  Object.assign(out,obj||{});
  out.ui=Object.assign(structuredClone(DEFAULT.ui),(obj&&obj.ui)||{});
  out.payload=Object.assign(structuredClone(DEFAULT.payload),(obj&&obj.payload)||{});

  if(!Array.isArray(out.payload.roomPresets)) out.payload.roomPresets=[];
  if(!Array.isArray(out.payload.sets)) out.payload.sets=[];
  if(!Array.isArray(out.ui.pinnedRooms)) out.ui.pinnedRooms=[];
  if(!Array.isArray(out.ui.pinnedSets)) out.ui.pinnedSets=[];

  out.ui.pinnedRooms = out.ui.pinnedRooms.map(canonRoomName).filter(Boolean);
  out.ui.pinnedSets  = out.ui.pinnedSets.map(String).filter(Boolean);

  out.payload.sets = out.payload.sets.map(s=>{
    const id = String((s&&s.id)||"").trim() || `SET_${uid8()}`;
    const label = canonSetName((s&&s.label)||"SET") || "SET";
    const items = Array.isArray(s&&s.items) ? s.items : [];
    const normItems = items.map(it=>{
      const url = String((it&&it.url)||"").trim();
      if(!url) return null;
      const label2 = canonRoomName((it&&it.label)||"") || deriveNameFromUrl(url);
      return { label: label2, url };
    }).filter(Boolean);
    return { id, label, items: normItems, updatedAt:(s&&s.updatedAt)||nowISO(), createdAt:(s&&s.createdAt)||nowISO() };
  });

  if(!out.ui.noteRect || typeof out.ui.noteRect!=="object") out.ui.noteRect=structuredClone(DEFAULT.ui.noteRect);
  if(typeof out.ui.drawerH!=="number") out.ui.drawerH=DEFAULT.ui.drawerH;

  ["universalsCollapsed","registryCollapsed","activeCollapsed","setsCollapsed","bulkCollapsed","presetsCollapsed"].forEach(k=>{
    if(typeof out.ui[k]!=="boolean") out.ui[k]=DEFAULT.ui[k];
  });

  // ensure rev exists
  out._rev = Number(out._rev)||0;

  return out;
}

/* =========================================================
EE ▸ LOAD (SOVEREIGN)
Order:
1) SOVEREIGN MAIN
2) SOVEREIGN BACKUP
3) migrate from prior path-scoped v2 (most recent)
4) migrate older v1/legacy
========================================================= */
function loadLocal(){
  // 1) sovereign main
  let s = loadFromKey(STORAGE_KEY_MAIN);
  if(s) return mergeDefault(s);

  // 2) sovereign backup
  s = loadFromKey(STORAGE_KEY_BACKUP);
  if(s){
    const merged = mergeDefault(s);
    try{
      localStorage.setItem(STORAGE_KEY_MAIN, JSON.stringify(merged));
      localStorage.setItem(STORAGE_KEY_BACKUP, JSON.stringify(merged));
    }catch(e){}
    return merged;
  }

  // 3) migrate any path-scoped v2 (pick most recent)
  const { mains, backups } = findLastPathScopedV2Keys();
  const pick = pickMostRecent(mains.length?mains:backups);
  if(pick){
    s = loadFromKey(pick);
    if(s){
      const merged = mergeDefault(s);
      try{
        localStorage.setItem(STORAGE_KEY_MAIN, JSON.stringify(merged));
        localStorage.setItem(STORAGE_KEY_BACKUP, JSON.stringify(merged));
      }catch(e){}
      return merged;
    }
  }

  // 4) migrate prior canon v1
  s = loadFromKey(STORAGE_KEY_CANON_OLD) || loadFromKey(STORAGE_KEY_BACKUP_OLD);
  if(s){
    const merged = mergeDefault(s);
    try{
      localStorage.setItem(STORAGE_KEY_MAIN, JSON.stringify(merged));
      localStorage.setItem(STORAGE_KEY_BACKUP, JSON.stringify(merged));
    }catch(e){}
    return merged;
  }

  // 5) migrate older legacy keys
  s = loadFromKey(STORAGE_KEY_CANON_OLD2) || loadFromKey(STORAGE_KEY_LEGACY_OLD);
  if(s){
    const merged = mergeDefault(s);
    try{
      localStorage.setItem(STORAGE_KEY_MAIN, JSON.stringify(merged));
      localStorage.setItem(STORAGE_KEY_BACKUP, JSON.stringify(merged));
    }catch(e){}
    return merged;
  }

  return null;
}

function ensureCorePresets(){
  const map=new Map();
  (STATE.payload.roomPresets||[]).forEach(p=>{
    const k=canonRoomName(p.room);
    if(!k) return;
    map.set(k, Object.assign({}, p, { room:k }));
  });
  CORE_PRESETS.forEach(cp=>{
    const k=canonRoomName(cp.room);
    if(!map.has(k)){
      map.set(k, { room:k, roomUrl:cp.roomUrl, createdAt:nowISO(), updatedAt:nowISO() });
    }else{
      const cur=map.get(k);
      if(!String(cur.roomUrl||"").trim()) cur.roomUrl=cp.roomUrl;
      map.set(k, cur);
    }
  });
  STATE.payload.roomPresets=[...map.values()];
}

function ensurePinnedRooms(){
  if(!Array.isArray(STATE.ui.pinnedRooms)) STATE.ui.pinnedRooms=[];
  STATE.ui.pinnedRooms=STATE.ui.pinnedRooms.map(canonRoomName).filter(Boolean);
}
function ensurePinnedSets(){
  if(!Array.isArray(STATE.ui.pinnedSets)) STATE.ui.pinnedSets=[];
  STATE.ui.pinnedSets=STATE.ui.pinnedSets.map(String).filter(Boolean);
}

function getPreset(roomName){
  const room=canonRoomName(roomName);
  return (STATE.payload.roomPresets||[]).find(r=>canonRoomName(r.room)===room) || null;
}
function isPinned(roomName){
  ensurePinnedRooms();
  const r=canonRoomName(roomName);
  return STATE.ui.pinnedRooms.includes(r);
}
function togglePin(roomName){
  ensurePinnedRooms();
  const r=canonRoomName(roomName);
  const i=STATE.ui.pinnedRooms.indexOf(r);
  if(i>=0) STATE.ui.pinnedRooms.splice(i,1);
  else STATE.ui.pinnedRooms.push(r);
}
function isSetPinned(setId){
  ensurePinnedSets();
  return STATE.ui.pinnedSets.includes(String(setId));
}
function togglePinSet(setId){
  ensurePinnedSets();
  const id=String(setId);
  const i=STATE.ui.pinnedSets.indexOf(id);
  if(i>=0) STATE.ui.pinnedSets.splice(i,1);
  else STATE.ui.pinnedSets.push(id);
}

function upsertRoomPreset(roomName, roomUrl){
  const room=canonRoomName(roomName);
  if(!room) return;
  const url=String(roomUrl||"").trim();
  const list=STATE.payload.roomPresets||[];
  const idx=list.findIndex(r=>canonRoomName(r.room)===room);
  const now=nowISO();
  if(idx>=0){
    list[idx]=Object.assign({}, list[idx], { room, roomUrl:url, updatedAt:now });
  }else{
    list.push({ room, roomUrl:url, createdAt:now, updatedAt:now });
  }
  STATE.payload.roomPresets=list;
  ensureCorePresets();
}
function deleteRoomPreset(roomName){
  const room=canonRoomName(roomName);
  if(!room) return;
  STATE.payload.roomPresets=(STATE.payload.roomPresets||[]).filter(r=>canonRoomName(r.room)!==room);
  // if pinned, unpin
  ensurePinnedRooms();
  STATE.ui.pinnedRooms=STATE.ui.pinnedRooms.filter(r=>r!==room);
  ensureCorePresets();
}

function setActiveRoom(roomName, roomUrl){
  const room=canonRoomName(roomName)||"BASE";
  const url=String(roomUrl||"").trim();
  STATE.room=room;
  STATE.roomUrl=url;
}

function createSet(label){
  const now=nowISO();
  const s={ id:`SET_${uid8()}`, label:canonSetName(label)||"SET", items:[], createdAt:now, updatedAt:now };
  STATE.payload.sets.unshift(s);
  return s;
}
function renameSet(setId,label){
  const id=String(setId);
  const s=(STATE.payload.sets||[]).find(x=>String(x.id)===id);
  if(!s) return;
  s.label=canonSetName(label)||s.label;
  s.updatedAt=nowISO();
}
function deleteSet(setId){
  const id=String(setId);
  STATE.payload.sets=(STATE.payload.sets||[]).filter(x=>String(x.id)!==id);
  ensurePinnedSets();
  STATE.ui.pinnedSets=STATE.ui.pinnedSets.filter(x=>x!==id);
}
function parseSetItems(text){
  const lines=String(text||"").split(/\n+/).map(s=>s.trim()).filter(Boolean);
  const out=[];
  for(const ln of lines){
    const m=ln.match(/^(.*?)\s+(https?:\/\/\S+|\S+\.\S+|\S+\/\S+|\S+\.html?)$/i);
    if(m){
      const label=canonRoomName(m[1]) || deriveNameFromUrl(m[2]);
      const url=m[2].startsWith("http") ? m[2] : m[2];
      out.push({ label, url });
    }else{
      const url=ln;
      const label=deriveNameFromUrl(url);
      out.push({ label, url });
    }
  }
  return out;
}
function saveSetItems(setId,text){
  const id=String(setId);
  const s=(STATE.payload.sets||[]).find(x=>String(x.id)===id);
  if(!s) return;
  s.items=parseSetItems(text);
  s.updatedAt=nowISO();
}

function bulkAdd(text){
  const lines=String(text||"").split(/\n+/).map(s=>s.trim()).filter(Boolean);
  for(const ln of lines){
    const m=ln.match(/^(.*?)\s+(.*)$/);
    if(m){
      const maybeUrl=m[2].trim();
      const maybeName=m[1].trim();
      if(maybeUrl){
        upsertRoomPreset(maybeName || deriveNameFromUrl(maybeUrl), maybeUrl);
      }
    }else{
      upsertRoomPreset(deriveNameFromUrl(ln), ln);
    }
  }
}

/* =========================================================
EE ▸ UI HELPERS
========================================================= */
let toastTimer=null;
function toast(msg){
  $("toast").textContent=String(msg||"");
  $("toast").classList.add("show");
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>$("toast").classList.remove("show"),900);
}
async function copy(text){
  try{await navigator.clipboard.writeText(text); toast("COPIED");}
  catch(e){toast("COPY FAILED");}
}

/* =========================================================
EE ▸ PERSIST (SOVEREIGN, DUMB, RELIABLE)
- write MAIN + BACKUP every time
- also flush on lifecycle events
========================================================= */
let _BOOTING = true;

function persist(silent=false){
  if(_BOOTING) return;

  // ruthless: always mutate a revision so storage events propagate
  STATE.updatedAt = nowISO();
  STATE._rev = (Number(STATE._rev)||0) + 1;

  ensureCorePresets();
  root.style.setProperty("--drawer-h", String(STATE.ui.drawerH));

  const blob = JSON.stringify(STATE);

  try{
    // atomic-ish: TMP -> MAIN -> BACKUP
    localStorage.setItem(STORAGE_KEY_TMP, blob);
    localStorage.setItem(STORAGE_KEY_MAIN, blob);
    localStorage.setItem(STORAGE_KEY_BACKUP, blob);
  }catch(e){}

  // cross-tab sync: BroadcastChannel (fast) + storage (fallback)
  try{ if(BC) BC.postMessage({ t:"STATE", key:STORAGE_KEY_MAIN, rev:STATE._rev, blob }); }catch(e){}

  if(!silent) render();
}

/* lifecycle flush — guarantees most recent Base survives refresh/navigation */
(function bindLifecycleFlush(){
  const flush=()=>{ try{ persist(true); }catch(e){} };

  window.addEventListener("pagehide", flush, {capture:true});
  window.addEventListener("beforeunload", flush, {capture:true});
  document.addEventListener("visibilitychange", ()=>{
    if(document.visibilityState==="hidden") flush();
  }, {capture:true});
})();

/* export/import */
function exportState(){
  ensureCorePresets();
  return JSON.stringify({ STORAGE_KEY: STORAGE_KEY_MAIN, FILE_ID, PAGE_ID, STORAGE_EPOCH, STATE }, null, 2);
}
function importState(text){
  const parsed=JSON.parse(text);
  const incoming=(parsed && parsed.STATE) ? parsed.STATE : parsed;
  STATE=mergeDefault(incoming);
  ensureCorePresets();
  stopLight(true);
  if(STATE.ui.lightRunning && !STATE.ui.blackout) startLight(STATE.ui.lightPreset);
  persist(false);
}

/* =========================================================
EE ▸ LIGHTS
========================================================= */
let lightInterval=null;
let lightCount=0, lightAuxA=0, lightAuxB=0;

function resetStage(){
  stage.style.backgroundColor="#000";
  stage.style.filter="none";
  lightCount=0; lightAuxA=0; lightAuxB=0;
}
function stopLight(silent=false){
  if(lightInterval){clearInterval(lightInterval); lightInterval=null;}
  STATE.ui.lightRunning=false;
  resetStage();
  if(!silent) persist(false);
}
function startLight(preset){
  stopLight(true);
  resetStage();
  STATE.ui.lightPreset=preset;
  STATE.ui.lightRunning=true;

  if(preset===1){
    lightInterval=setInterval(()=>{
      const curr=stage.style.backgroundColor||"black";
      stage.style.backgroundColor=(curr==="black"||curr==="rgb(0, 0, 0)")?"white":"black";
      stage.style.filter="none";
    },50);
  }else if(preset===2){
    lightInterval=setInterval(()=>{
      lightAuxA=(lightAuxA+30)%360; lightAuxB+=0.5;
      stage.style.backgroundColor=`hsl(${lightAuxA}, 0%, ${40+30*Math.sin(lightAuxB)}%)`;
      stage.style.filter="none";
    },55);
  }else if(preset===3){
    lightInterval=setInterval(()=>{
      lightCount++;
      const v=(Math.sin(lightCount/3)*0.5+0.5);
      stage.style.backgroundColor="#000";
      stage.style.filter=`contrast(${1+v*6}) invert(${v>0.66?1:0})`;
    },45);
  }else if(preset===4){
    lightInterval=setInterval(()=>{
      lightCount++;
      const w= (lightCount%2===0)?0:1;
      stage.style.backgroundColor = w? "#fff":"#000";
      stage.style.filter=`blur(${w?0:0}px)`;
    },30);
  }else if(preset===5){
    lightInterval=setInterval(()=>{
      lightCount++;
      const t=lightCount/10;
      const g= Math.floor(255*(Math.sin(t)*0.5+0.5));
      stage.style.backgroundColor=`rgb(${g},${g},${g})`;
      stage.style.filter=`contrast(${2+Math.sin(t)*4})`;
    },40);
  }else if(preset===6){
    lightInterval=setInterval(()=>{
      lightCount++;
      const t=lightCount/9;
      const inv = (Math.sin(t)>0.2)?1:0;
      stage.style.backgroundColor= inv? "#fff":"#000";
      stage.style.filter=`invert(${inv}) contrast(6)`;
    },48);
  }

  persist(false);
}

/* =========================================================
EE ▸ NAV
========================================================= */
function go(url){
  if(!url) return;
  try{ persist(true); }catch(_){}
  location.href=url;
}
function openNewTab(url){
  if(!url) return;
  try{ persist(true); }catch(_){}
  window.open(url, "_blank", "noopener,noreferrer");
}

/* =========================================================
EE ▸ RENDER
========================================================= */
let ACTIVE_SET_ID="";

function render(){
  root.classList.toggle("invert", !!STATE.ui.invert);
  root.classList.toggle("blackout", !!STATE.ui.blackout);
  root.classList.toggle("fs", !!STATE.ui.fullscreen);

  $("drawer").classList.toggle("open", !!STATE.ui.drawerOpen);
  $("ketaNote").classList.toggle("open", !!STATE.ui.noteOpen);
  $("ketaIcon").classList.toggle("open", !!STATE.ui.noteOpen);

  $("roomName").textContent = canonRoomName(STATE.room)||"BASE";
  $("activeRoom").value = canonRoomName(STATE.room)||"BASE";
  $("activeUrl").value = String(STATE.roomUrl||"");
  $("status").textContent = STATE.ui.blackout ? "NULL" : (STATE.ui.fullscreen ? "FULLSCREEN" : "READY");

  // motion
  motion.classList.toggle("run", !!STATE.ui.motionOn && !STATE.ui.blackout);

  // panels collapse
  setCollapsed("panelUniversals", STATE.ui.universalsCollapsed);
  setCollapsed("panelRegistry", STATE.ui.registryCollapsed);
  setCollapsed("panelActive", STATE.ui.activeCollapsed);
  setCollapsed("panelSets", STATE.ui.setsCollapsed);
  setCollapsed("panelBulk", STATE.ui.bulkCollapsed);
  setCollapsed("panelPresets", STATE.ui.presetsCollapsed);

  // fields
  $("universals").value = String(STATE.universals||"");
  $("ketaText").value = String(STATE.ketaNote||"");

  // registry
  renderRegistry();
  renderSets();
  renderPins();

  // lights pills
  renderLightPills();

  // note rect
  applyNoteRect();

  // prompt preview
  $("promptPreview").textContent = buildPromptExport();
}

function setCollapsed(panelId, yes){
  const el=$(panelId);
  if(!el) return;
  el.classList.toggle("collapsed", !!yes);
}

function renderLightPills(){
  const wrap=$("lightPills");
  wrap.innerHTML="";
  for(let i=1;i<=6;i++){
    const d=document.createElement("div");
    d.className="pill"+((STATE.ui.lightRunning && STATE.ui.lightPreset===i)?" on":"");
    d.textContent=String(i);
    d.addEventListener("click", ()=>{
      if(STATE.ui.blackout) return;
      if(STATE.ui.lightRunning && STATE.ui.lightPreset===i){ stopLight(false); }
      else { startLight(i); }
    });
    wrap.appendChild(d);
  }
  $("pillMotion").classList.toggle("on", !!STATE.ui.motionOn);
}

function renderRegistry(){
  ensureCorePresets();
  const list=$("registryList");
  list.innerHTML="";
  const presets=[...(STATE.payload.roomPresets||[])].sort((a,b)=>String(a.room).localeCompare(String(b.room)));
  for(const p of presets){
    const room=canonRoomName(p.room);
    const url=String(p.roomUrl||"");
    const el=document.createElement("div");
    el.className="item";
    const left=document.createElement("div");
    left.className="left";
    const nm=document.createElement("div");
    nm.className="name";
    nm.textContent=room;
    const u=document.createElement("div");
    u.className="url";
    u.textContent=url || "(NO URL)";
    left.appendChild(nm); left.appendChild(u);

    const right=document.createElement("div");
    right.className="right";

    const pin=document.createElement("button");
    pin.className="iconBtn"+(isPinned(room)?" on":"");
    pin.textContent="PIN";
    pin.addEventListener("click", ()=>{
      togglePin(room);
      persist(false);
    });

    const set=document.createElement("button");
    set.className="iconBtn";
    set.textContent="SET";
    set.addEventListener("click", ()=>{
      $("roomInput").value=room;
      $("roomUrlInput").value=url;
      setActiveRoom(room,url);
      persist(false);
      toast("ACTIVE SET");
    });

    const goBtn=document.createElement("button");
    goBtn.className="iconBtn";
    goBtn.textContent="GO";
    goBtn.addEventListener("click", ()=>{
      setActiveRoom(room,url);
      persist(true);
      if(url) go(url); else toast("NO URL");
    });

    right.appendChild(pin);
    right.appendChild(set);
    right.appendChild(goBtn);

    el.appendChild(left);
    el.appendChild(right);
    list.appendChild(el);
  }
}

function renderSets(){
  const list=$("setsList");
  list.innerHTML="";
  const sets=STATE.payload.sets||[];
  for(const s of sets){
    const el=document.createElement("div");
    el.className="item";
    const left=document.createElement("div");
    left.className="left";
    const nm=document.createElement("div");
    nm.className="name";
    nm.textContent=String(s.label||"SET");
    const u=document.createElement("div");
    u.className="url";
    u.textContent=(s.items||[]).length ? `${(s.items||[]).length} ITEMS` : "EMPTY";
    left.appendChild(nm); left.appendChild(u);

    const right=document.createElement("div");
    right.className="right";

    const open=document.createElement("button");
    open.className="iconBtn"+(String(ACTIVE_SET_ID)===String(s.id)?" on":"");
    open.textContent="OPEN";
    open.addEventListener("click", ()=>{
      ACTIVE_SET_ID=String(s.id);
      setEditorFromSet(s);
      render();
    });

    const pin=document.createElement("button");
    pin.className="iconBtn"+(isSetPinned(s.id)?" on":"");
    pin.textContent="PIN";
    pin.addEventListener("click", ()=>{
      togglePinSet(s.id);
      persist(false);
    });

    right.appendChild(open);
    right.appendChild(pin);

    el.appendChild(left);
    el.appendChild(right);
    list.appendChild(el);
  }
}

function setEditorFromSet(s){
  $("setNameInput").value = String(s.label||"SET");
  $("setItemsInput").value = (s.items||[]).map(it=>{
    const label=String(it.label||"").trim();
    const url=String(it.url||"").trim();
    return label ? `${label} ${url}` : url;
  }).join("\n");
}

function renderPins(){
  ensurePinnedRooms();
  ensurePinnedSets();

  const show = (STATE.ui.pinnedRooms.length>0) || (STATE.ui.pinnedSets.length>0);
  $("pinnedPanel").classList.toggle("show", !!show);

  const pr=$("pinnedRoomsList");
  pr.innerHTML="";
  for(const room of STATE.ui.pinnedRooms){
    const p=getPreset(room);
    const url=p?String(p.roomUrl||""):"";
    const el=document.createElement("div");
    el.className="item";
    const left=document.createElement("div");
    left.className="left";
    const nm=document.createElement("div");
    nm.className="name";
    nm.textContent=room;
    const u=document.createElement("div");
    u.className="url";
    u.textContent=url || "(NO URL)";
    left.appendChild(nm); left.appendChild(u);

    const right=document.createElement("div");
    right.className="right";

    const un=document.createElement("button");
    un.className="iconBtn";
    un.textContent="UNPIN";
    un.addEventListener("click", ()=>{
      togglePin(room);
      persist(false);
    });

    const goBtn=document.createElement("button");
    goBtn.className="iconBtn";
    goBtn.textContent="GO";
    goBtn.addEventListener("click", ()=>{
      setActiveRoom(room,url);
      persist(true);
      if(url) go(url); else toast("NO URL");
    });

    right.appendChild(un);
    right.appendChild(goBtn);

    el.appendChild(left);
    el.appendChild(right);
    pr.appendChild(el);
  }

  const ps=$("pinnedSetsList");
  ps.innerHTML="";
  for(const id of STATE.ui.pinnedSets){
    const s=(STATE.payload.sets||[]).find(x=>String(x.id)===String(id));
    if(!s) continue;
    const el=document.createElement("div");
    el.className="item";
    const left=document.createElement("div");
    left.className="left";
    const nm=document.createElement("div");
    nm.className="name";
    nm.textContent=String(s.label||"SET");
    const u=document.createElement("div");
    u.className="url";
    u.textContent=(s.items||[]).length ? `${(s.items||[]).length} ITEMS` : "EMPTY";
    left.appendChild(nm); left.appendChild(u);

    const right=document.createElement("div");
    right.className="right";

    const un=document.createElement("button");
    un.className="iconBtn";
    un.textContent="UNPIN";
    un.addEventListener("click", ()=>{
      togglePinSet(id);
      persist(false);
    });

    const open=document.createElement("button");
    open.className="iconBtn";
    open.textContent="OPEN";
    open.addEventListener("click", ()=>{
      ACTIVE_SET_ID=String(s.id);
      setEditorFromSet(s);
      toast("SET OPEN");
      persist(false);
    });

    right.appendChild(un);
    right.appendChild(open);

    el.appendChild(left);
    el.appendChild(right);
    ps.appendChild(el);
  }
}

function buildPromptExport(){
  const lines=[];
  lines.push("KETADATA BASE / SOVEREIGN STATE SNAPSHOT");
  lines.push(`ROOM: ${(canonRoomName(STATE.room)||"BASE")}  URL: ${(String(STATE.roomUrl||"")||"(NONE)")}`);
  lines.push("");
  lines.push("UNIVERSALS:");
  lines.push(String(STATE.universals||"").trim() || "(EMPTY)");
  lines.push("");
  lines.push("ROOM PRESETS:");
  for(const p of (STATE.payload.roomPresets||[])){
    const room=canonRoomName(p.room);
    const url=String(p.roomUrl||"").trim();
    if(!room) continue;
    lines.push(`${room} ${url}`.trim());
  }
  lines.push("");
  lines.push("PINNED ROOMS:");
  lines.push((STATE.ui.pinnedRooms||[]).join(", ") || "(NONE)");
  lines.push("");
  lines.push("PINNED SETS:");
  const setLabels=(STATE.ui.pinnedSets||[]).map(id=>{
    const s=(STATE.payload.sets||[]).find(x=>String(x.id)===String(id));
    return s?String(s.label||id):String(id);
  });
  lines.push(setLabels.join(", ") || "(NONE)");
  return lines.join("\n");
}

/* =========================================================
EE ▸ NOTE RECT (PERSISTED)
========================================================= */
function clamp(n,min,max){return Math.max(min,Math.min(max,n));}

function applyNoteRect(){
  const box=$("ketaNote");
  const r=STATE.ui.noteRect||{};
  if(r.x==null){
    // keep right anchored as default
    box.style.right="18px";
    box.style.left="auto";
  }else{
    box.style.left = r.x+"px";
    box.style.top  = r.y+"px";
    box.style.right="auto";
  }
  box.style.width  = (r.w||340)+"px";
  box.style.height = (r.h||220)+"px";
}
function saveRect(){
  const box=$("ketaNote");
  const rect=box.getBoundingClientRect();
  STATE.ui.noteRect={
    x: Math.round(rect.left),
    y: Math.round(rect.top),
    w: Math.round(rect.width),
    h: Math.round(rect.height)
  };
  persist(true);
}

(function bindNoteDragResize(){
  const box=$("ketaNote");
  const head=$("ketaNoteHead");
  let dragging=false, ox=0, oy=0;

  head.addEventListener("mousedown",(ev)=>{
    if(ev.target.closest("button")) return;
    if(STATE.ui.blackout) return;
    dragging=true;
    const r=box.getBoundingClientRect();
    ox=ev.clientX-r.left; oy=ev.clientY-r.top;
    box.style.left=r.left+"px";
    box.style.top=r.top+"px";
    box.style.right="auto";
  });

  window.addEventListener("mousemove",(ev)=>{
    if(!dragging) return;
    box.style.left = clamp(ev.clientX-ox, 0, window.innerWidth-40) + "px";
    box.style.top  = clamp(ev.clientY-oy, 44, window.innerHeight-40) + "px";
  });

  window.addEventListener("mouseup",()=>{
    if(!dragging) return;
    dragging=false;
    saveRect();
  });

  try{
    const ro=new ResizeObserver(()=>{
      if(dragging) return;
      if(STATE.ui.blackout) return;
      saveRect();
    });
    ro.observe(box);
  }catch(_){}
})();

/* Cross-tab sync (SOVEREIGN key) */
function applyIncomingBlob(blob){
  if(!blob) return;
  try{
    const incoming = JSON.parse(blob);
    if(!incoming) return;
    // prefer higher rev/updatedAt
    const inRev = Number(incoming._rev)||0;
    const curRev = Number(STATE && STATE._rev)||0;
    const inTs = Date.parse(incoming.updatedAt||"")||0;
    const curTs = Date.parse((STATE&&STATE.updatedAt)||"")||0;
    if(inRev<curRev) return;
    if(inRev===curRev && inTs<=curTs) return;

    STATE = mergeDefault(incoming);
    ensureCorePresets();
    render();
  }catch(_){}
}

window.addEventListener("storage",(e)=>{
  if(e.key!==STORAGE_KEY_MAIN) return;
  if(!e.newValue) return;
  applyIncomingBlob(e.newValue);
});

/* BroadcastChannel sync (faster + fires even when value identical) */
if(BC){
  BC.onmessage = (ev)=>{
    try{
      const msg = ev.data||{};
      if(msg.key!==STORAGE_KEY_MAIN) return;
      applyIncomingBlob(msg.blob);
    }catch(_){}
  };
}

/* BFCache restore (reload sovereign state) */
window.addEventListener("pageshow",()=>{
  const stored=loadLocal();
  if(stored){
    STATE=stored;
    ensureCorePresets();
    render();
  }
});

/* =========================================================
EE ▸ BINDINGS + HOTKEYS (LOCKED)
========================================================= */
function setDrawer(open){
  STATE.ui.drawerOpen=!!open;
  persist(false);
}
function setKetaNote(open){
  STATE.ui.noteOpen=!!open;
  persist(false);
}
function setInvert(on){
  STATE.ui.invert=!!on;
  persist(false);
}
function setBlackout(on){
  STATE.ui.blackout=!!on;
  if(on){
    stopLight(true);
    STATE.ui.motionOn=false;
    STATE.ui.fullscreen=false;
  }
  persist(false);
}
function setFullscreen(on){
  if(STATE.ui.blackout) return;
  STATE.ui.fullscreen=!!on;
  persist(false);
}

function bindHotkeys(){
  window.addEventListener("keydown",(e)=>{
    if(e.repeat) return;

    const k=e.key.toLowerCase();
    const shift=e.shiftKey;

    // universal: SHIFT+I invert
    if(shift && k==="i"){ e.preventDefault(); setInvert(!STATE.ui.invert); return; }

    // universal: 1-6 lights (continuous). ignore when typing in inputs/textarea/contenteditable
    const tag=(e.target && e.target.tagName)||"";
    const typing = (tag==="INPUT" || tag==="TEXTAREA" || (e.target && e.target.isContentEditable));
    if(!typing && !shift){
      if(k>="1" && k<="6"){
        e.preventDefault();
        const n=Number(k);
        if(STATE.ui.blackout) return;
        if(STATE.ui.lightRunning && STATE.ui.lightPreset===n) stopLight(false);
        else startLight(n);
        return;
      }
    }

    // universal: SHIFT+N NULL blackout
    if(shift && k==="n"){ e.preventDefault(); setBlackout(!STATE.ui.blackout); return; }

    // universal: SHIFT+F fullscreen
    if(shift && k==="f"){ e.preventDefault(); setFullscreen(!STATE.ui.fullscreen); return; }

    // locked nav hotkeys
    if(shift && k==="k"){ e.preventDefault(); go(URLS.LANDING); return; }
    if(shift && k==="x"){ e.preventDefault(); go(URLS.PHOTOBOOTH); return; }
    if(shift && k==="z"){ e.preventDefault(); go(URLS.KDTV); return; }
    if(shift && k==="v"){ e.preventDefault(); go(URLS.POD); return; }
    if(shift && k==="w"){ e.preventDefault(); go(URLS.WORLD); return; }
    if(shift && k==="p"){ e.preventDefault(); go(URLS.INFINITY); return; }
  });
}

/* Buttons */
$("btnDrawer").addEventListener("click", ()=>{ if(STATE.ui.blackout) return; setDrawer(!STATE.ui.drawerOpen); });
$("btnInvert").addEventListener("click", ()=> setInvert(!STATE.ui.invert));
$("btnBlackout").addEventListener("click", ()=> setBlackout(!STATE.ui.blackout));
$("btnFullscreen").addEventListener("click", ()=> setFullscreen(!STATE.ui.fullscreen));

$("btnExport").addEventListener("click", ()=>{
  const txt=exportState();
  copy(txt);
});
$("btnImport").addEventListener("click", ()=>{
  $("file").value="";
  $("file").click();
});
$("file").addEventListener("change", async (e)=>{
  const f=e.target.files && e.target.files[0];
  if(!f) return;
  const text=await f.text();
  try{ importState(text); toast("IMPORTED"); }
  catch(_){ toast("IMPORT FAIL"); }
});
$("btnReset").addEventListener("click", ()=>{
  if(!confirm("RESET BASE STATE?")) return;
  STATE=structuredClone(DEFAULT);
  ensureCorePresets();
  stopLight(true);
  persist(false);
  toast("RESET");
});

$("pillMotion").addEventListener("click", ()=>{
  if(STATE.ui.blackout) return;
  STATE.ui.motionOn=!STATE.ui.motionOn;
  persist(false);
});

$("btnCollapseUniversals").addEventListener("click", ()=>{ STATE.ui.universalsCollapsed=!STATE.ui.universalsCollapsed; persist(false); });
$("btnCollapseRegistry").addEventListener("click", ()=>{ STATE.ui.registryCollapsed=!STATE.ui.registryCollapsed; persist(false); });
$("btnCollapseActive").addEventListener("click", ()=>{ STATE.ui.activeCollapsed=!STATE.ui.activeCollapsed; persist(false); });
$("btnCollapseSets").addEventListener("click", ()=>{ STATE.ui.setsCollapsed=!STATE.ui.setsCollapsed; persist(false); });
$("btnCollapseBulk").addEventListener("click", ()=>{ STATE.ui.bulkCollapsed=!STATE.ui.bulkCollapsed; persist(false); });
$("btnCollapsePresets").addEventListener("click", ()=>{ STATE.ui.presetsCollapsed=!STATE.ui.presetsCollapsed; persist(false); });

$("universals").addEventListener("input", ()=>{ STATE.universals=$("universals").value||""; persist(); });
$("ketaText").addEventListener("input", ()=>{ STATE.ketaNote=$("ketaText").value||""; persist(); });

$("ketaIcon").addEventListener("click", ()=>{
  if(STATE.ui.blackout) return;
  setKetaNote(!STATE.ui.noteOpen);
});
$("btnHideNote").addEventListener("click", ()=> setKetaNote(false));

$("btnSaveRoom").addEventListener("click", ()=>{
  upsertRoomPreset($("roomInput").value||"LINK", $("roomUrlInput").value||"");
  toast("SAVED");
  persist();
});
$("btnSetActiveRoom").addEventListener("click", ()=>{
  const r=$("roomInput").value||"BASE";
  const u=$("roomUrlInput").value||"";
  upsertRoomPreset(r,u);
  setActiveRoom(r,u);
  toast("ACTIVE SET");
  persist();
});
$("btnDeleteRoom").addEventListener("click", ()=>{
  const r=$("roomInput").value||"";
  if(!r.trim()){ toast("NO ROOM"); return; }
  deleteRoomPreset(r);
  toast("DELETED");
  persist();
});

$("btnTogglePins").addEventListener("click", ()=>{ toast("PINS = VISIBLE WHEN PINNED"); });

$("btnGoActive").addEventListener("click", ()=>{
  if(STATE.roomUrl) go(STATE.roomUrl);
  else toast("NO ACTIVE URL");
});
$("btnNewTabActive").addEventListener("click", ()=>{
  if(STATE.roomUrl) openNewTab(STATE.roomUrl);
  else toast("NO ACTIVE URL");
});
$("btnCopyActiveUrl").addEventListener("click", ()=>{ copy(String(STATE.roomUrl||"")); });

$("armedGo").addEventListener("click", ()=>{
  if(STATE.roomUrl) go(STATE.roomUrl);
  else toast("NO ACTIVE URL");
});
$("armedNewTab").addEventListener("click", ()=>{
  if(STATE.roomUrl) openNewTab(STATE.roomUrl);
  else toast("NO ACTIVE URL");
});
$("armedCopy").addEventListener("click", ()=>{ copy(String(STATE.roomUrl||"")); });

$("btnCreateSet").addEventListener("click", ()=>{
  const s=createSet($("setNameInput").value||"SET");
  ACTIVE_SET_ID=String(s.id);
  setEditorFromSet(s);
  toast("SET CREATED");
  persist();
});
$("btnRenameSet").addEventListener("click", ()=>{
  if(!ACTIVE_SET_ID){ toast("NO SET"); return; }
  renameSet(ACTIVE_SET_ID, $("setNameInput").value||"SET");
  toast("SET RENAMED");
  persist();
});
$("btnDeleteSet").addEventListener("click", ()=>{
  if(!ACTIVE_SET_ID){ toast("NO SET"); return; }
  deleteSet(ACTIVE_SET_ID);
  $("setNameInput").value="";
  $("setItemsInput").value="";
  ACTIVE_SET_ID="";
  toast("SET DELETED");
  persist();
});
$("btnPinSet").addEventListener("click", ()=>{
  if(!ACTIVE_SET_ID){ toast("NO SET"); return; }
  togglePinSet(ACTIVE_SET_ID);
  toast(isSetPinned(ACTIVE_SET_ID) ? "SET PINNED" : "SET UNPINNED");
  persist();
});
$("btnSaveSetItems").addEventListener("click", ()=>{
  if(!ACTIVE_SET_ID){ toast("NO SET"); return; }
  saveSetItems(ACTIVE_SET_ID, $("setItemsInput").value||"");
  toast("ITEMS SAVED");
  persist();
});
$("btnClearSetItems").addEventListener("click", ()=>{
  $("setItemsInput").value="";
  toast("CLEARED");
});

$("btnBulkAdd").addEventListener("click", ()=>{
  bulkAdd($("bulkInput").value||"");
  toast("BULK ADDED");
  persist();
});
$("btnBulkClear").addEventListener("click", ()=>{
  $("bulkInput").value="";
  toast("CLEARED");
});

$("btnPromptExport").addEventListener("click", ()=>{
  copy(buildPromptExport());
});

$("btnLanding").addEventListener("click", ()=>go(URLS.LANDING));
$("btnCrunch").addEventListener("click", ()=>go(URLS.PHOTOBOOTH));
$("btnKDTV").addEventListener("click", ()=>go(URLS.KDTV));
$("btnPod").addEventListener("click", ()=>go(URLS.POD));
$("btnWorld").addEventListener("click", ()=>go(URLS.WORLD));
$("btnInfinity").addEventListener("click", ()=>go(URLS.INFINITY));

/* =========================================================
BOOT
========================================================= */
const _BOOT_LOADED = loadLocal();
let STATE = _BOOT_LOADED ? _BOOT_LOADED : structuredClone(DEFAULT);
ensureCorePresets();
root.style.setProperty("--drawer-h", String(STATE.ui.drawerH));
bindHotkeys();

_BOOTING = false;
render();

/* Seed sovereign storage only if nothing exists yet */
if(!_BOOT_LOADED){
  persist(true);
}

/* Ensure running light resumes */
if(STATE.ui.lightRunning && !STATE.ui.blackout) startLight(STATE.ui.lightPreset||1);
</script>

<!-- =========================================================
AE/EE/WB SERIALIZATION STAMP (MANDATORY)
AE/EE/WB + FILE_ID/ROOM_ID/VERSION/UPDATED_AT/CHANGELOG
FILE_ID: KETADATA_SHELL8
ROOM_ID: BASE
VERSION: BASE_SYSTEM_SOVEREIGN_v5
UPDATED_AT: 2025-12-28T00:00:00-05:00
CHANGELOG:
- EE: SOVEREIGN KEY REMAINS SINGLE CONSTANT: "KDT::BASE::SOVEREIGN::STATE" (NO PATH/FILE/PAGE SCOPING)
- EE: ADD _rev COUNTER + BroadcastChannel SYNC FOR RELIABLE CROSS-TAB STATE
- EE: APPLY-INCOMING GUARD (REV/TIMESTAMP) TO PREVENT STALE TAB OVERRIDES
- EE: STILL MIGRATES PRIOR v1/v2/PATH-SCOPED KEYS INTO SOVEREIGN KEY ON FIRST BOOT
- EE: LIFECYCLE FLUSH (pagehide/beforeunload/visibilitychange) REMAINS
- WB: NO UI/AESTHETIC/INTERACTION CHANGES
========================================================= -->
</body>
</html>
