<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>KETADATA // MOB_TOYS_PLAYER v1</title>
<style>
:root{
  --bg:#000;
  --fg:rgba(255,255,255,.86);
  --muted:rgba(255,255,255,.52);
  --line:rgba(255,255,255,.12);
  --line2:rgba(255,255,255,.22);

  --top:44px;
  --bot:38px;

  --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
  --sans: Arial,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  --drawer-h:.58;
}
*{box-sizing:border-box}
html,body{height:100%; margin:0}
body{
  background:var(--bg);
  color:var(--fg);
  font-family:var(--sans);
  overflow:hidden;
  user-select:none;
  -webkit-user-select:none;
  -webkit-tap-highlight-color:transparent;
}
#root{position:fixed; inset:0; background:#000}

/* ===== SURFACE ===== */
#surface{
  position:absolute; inset:0;
  width:100%; height:100%;
  border:0; background:#000;
  display:block;
  z-index:1;
}

/* ===== BARS ===== */
.topbar{
  position:absolute; top:0; left:0; right:0; height:var(--top);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 10px;
  border-bottom:1px solid var(--line);
  background:linear-gradient(180deg,#070707,#000);
  z-index:20;
}
.brand{
  display:flex; align-items:center; gap:10px;
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.10em;
  text-transform:uppercase;
}
.brand .sq{
  width:10px; height:10px;
  border:1px solid rgba(255,255,255,.86);
}
.badge{
  color:var(--muted);
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.10em;
  text-transform:uppercase;
}
.btn{
  border:1px solid var(--line2);
  background:#000;
  color:var(--fg);
  height:28px;
  padding:0 10px;
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.08em;
  text-transform:uppercase;
  cursor:pointer;
}
.btn:active{transform:translateY(1px)}
.btn:disabled{opacity:.35; cursor:default; transform:none}

.bottombar{
  position:absolute; left:0; right:0; bottom:0; height:var(--bot);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 10px;
  border-top:1px solid var(--line);
  background:linear-gradient(0deg,#070707,#000);
  z-index:20;
}
.left{display:flex; gap:8px; align-items:center}
.status{
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.06em;
  color:var(--muted);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:56vw;
}

/* ===== PLAYER PANEL (collapsible) ===== */
.player{
  position:absolute;
  left:10px; right:10px;
  top:calc(var(--top) + 10px);
  bottom:calc(var(--bot) + 10px);
  border:1px solid rgba(255,255,255,.22);
  background:rgba(0,0,0,.84);
  backdrop-filter:blur(6px);
  z-index:25;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
.player.hidden{display:none}
.playerHead{
  padding:8px 10px;
  border-bottom:1px solid rgba(255,255,255,.14);
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.10em;
  text-transform:uppercase;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.playerBody{
  padding:10px;
  overflow:auto;
  min-height:0;
  flex:1;
}
.player.collapsed .playerBody{display:none}
.row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.label{
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.08em;
  text-transform:uppercase;
  color:var(--muted);
}

/* presets grid */
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  margin-top:10px;
}
@media (max-width:420px){ .grid{grid-template-columns:1fr} }

.presetBtn{
  height:34px;
  width:100%;
  text-align:left;
  padding:0 10px;
}
.presetBtn.sel{border-color:rgba(255,255,255,.86)}
.smallNote{
  margin-top:10px;
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.02em;
  color:var(--muted);
  text-transform:none;
}

/* ===== DRAWER ===== */
.drawer{
  position:absolute;
  left:0; right:0;
  bottom:var(--bot);
  height:calc((100vh - var(--top) - var(--bot)) * var(--drawer-h));
  background:linear-gradient(180deg,#060606,#000);
  border-top:1px solid var(--line);
  z-index:40;
  display:none;
  flex-direction:column;
}
.drawer.open{display:flex}
.drawerHead{
  padding:8px 10px;
  border-bottom:1px solid var(--line);
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.10em;
  text-transform:uppercase;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.drawerBody{padding:10px; overflow:auto; min-height:0; flex:1}
.section{
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.25);
  padding:10px;
  margin-bottom:10px;
}
textarea{
  width:100%;
  min-height:110px;
  outline:none;
  background:#000;
  color:#fff;
  border:1px solid var(--line2);
  font-family:var(--mono);
  font-size:12px;
  line-height:1.35;
  padding:8px;
  resize:vertical;
}

/* ===== IMPORTANT MOBILE CONTROLS ===== */
/* NULL: square bottom-right always available */
#nullSquare{
  position:absolute;
  right:10px;
  bottom:calc(var(--bot) + 10px);
  width:22px;
  height:22px;
  border:1px solid rgba(255,255,255,.78);
  background:transparent;
  z-index:999;
  cursor:pointer;
}
#nullSquare:active{transform:translateY(1px)}

/* invert indicator (no extra UI; just border inversion hint) */
#root.invert{filter:invert(1)}

/* blackout */
#root.blackout .topbar,
#root.blackout .bottombar,
#root.blackout .player,
#root.blackout .drawer{display:none!important}
#root.blackout #nullSquare{display:block}

/* subtle safe-area nudge for iOS home indicator */
@supports (padding: env(safe-area-inset-bottom)){
  #nullSquare{ bottom: calc(var(--bot) + 10px + env(safe-area-inset-bottom)); }
}
</style>
</head>

<body>
<div id="root">
  <iframe id="surface" title="SURFACE"></iframe>

  <div class="topbar">
    <!-- LONG TOUCH THIS BRAND BLOCK = INVERT -->
    <div class="brand" id="invertHold" title="LONG TOUCH = INVERT">
      <span class="sq"></span>
      <span>SHELL8 // KERNEL</span>
      <span class="badge">MOB_TOYS</span>
    </div>
    <div class="row" style="gap:8px">
      <button class="btn" id="btnPlayer">PLAYER</button>
      <button class="btn" id="btnSystem">SYSTEM</button>
    </div>
  </div>

  <div class="player" id="player">
    <div class="playerHead">
      <div>PLAYER</div>
      <div class="row" style="gap:6px">
        <button class="btn" id="btnPrev">◀</button>
        <button class="btn" id="btnPlay">PLAY</button>
        <button class="btn" id="btnNext">▶</button>
        <button class="btn" id="btnCollapse">—</button>
      </div>
    </div>

    <div class="playerBody">
      <div class="row" style="justify-content:space-between">
        <div class="label">NOW</div>
        <div class="label" id="nowLabel" style="color:var(--fg); max-width:68vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">—</div>
      </div>

      <div class="grid" id="presetGrid"></div>

      <div class="smallNote">
        TAP PRESET = LOAD. PLAY = SHOW IN SURFACE. LONG TOUCH TOP-LEFT = INVERT. NULL SQUARE = QUIET FULLSCREEN.
      </div>
    </div>
  </div>

  <div class="drawer" id="drawer">
    <div class="drawerHead">
      <div>SYSTEM</div>
      <div class="row">
        <button class="btn" id="btnInvert">INVERT</button>
        <button class="btn" id="btnCloseDrawer">CLOSE</button>
      </div>
    </div>

    <div class="drawerBody">
      <div class="section">
        <div class="row" style="justify-content:space-between; margin-bottom:8px">
          <span class="label">UNIVERSALS</span>
          <button class="btn" id="btnClearUniversals">CLEAR</button>
        </div>
        <textarea id="universals" spellcheck="false" autocomplete="off" placeholder="LAWS / REFERENCES"></textarea>
      </div>

      <div class="section">
        <div class="row" style="justify-content:space-between; margin-bottom:8px">
          <span class="label">STATE</span>
          <div class="row">
            <button class="btn" id="btnExport">EXPORT</button>
            <button class="btn" id="btnImport">IMPORT</button>
          </div>
        </div>
        <div class="label" style="text-transform:none; letter-spacing:.02em; color:var(--muted)">KEY:</div>
        <div class="label" id="keyHint" style="text-transform:none; letter-spacing:.02em; color:var(--muted); word-break:break-all"></div>
      </div>
    </div>
  </div>

  <div class="bottombar">
    <div class="left">
      <button class="btn" id="btnGo">GO</button>
    </div>
    <div class="status" id="status">READY</div>
  </div>

  <!-- NULL control -->
  <div id="nullSquare" title="NULL"></div>

  <input id="file" type="file" accept="application/json" style="display:none" />
</div>

<script>
/* ===== utils ===== */
const $=(id)=>document.getElementById(id);
function nowISO(){return new Date().toISOString();}
function hash8(str){
  const s=String(str||"");
  let h=2166136261;
  for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,16777619);}
  return (h>>>0).toString(16).slice(0,8);
}
function canon(s){return String(s||"").trim().toUpperCase();}
function normalizeUrl(raw){
  const u=String(raw||"").trim();
  if(!u) return "";
  if(/^(https?:|about:|data:|blob:)/i.test(u)) return u;
  try{ return new URL(u, location.href).href; }catch(e){ return u; }
}
function downloadJson(filename, text){
  const blob=new Blob([String(text||"")], {type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=filename||"KETADATA_STATE.json";
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 250);
}

/* ===== toy presets (LATEST: Tennis & Catball) ===== */
const TOYS = [
  {name:"CATBALL", url:"catball.html"},
  {name:"CATBALL_1", url:"catball1.html"},

  {name:"TENNISBALL_91", url:"tennisball91.html"},
  {name:"TENNISBALL_666", url:"tennisball666.html"},
  {name:"TENNISBALL_16", url:"tennisball16.html"},
  {name:"TENNISBALL_15", url:"tennisball15.html"},
  {name:"TENNISBALL_12", url:"tennisball12.html"},
  {name:"TENNISBALL_10", url:"tennisball10.html"},

  {name:"TENNISCOURT", url:"tenniscourt.html"},

  {name:"TBALL_7", url:"tball7.html"},
  {name:"TBALL_6", url:"tball6.html"},

  {name:"SERVE_2", url:"serve2.html"},
  {name:"KTBALL_1", url:"ktball1.html"}
];

/* ===== state (independent) ===== */
const PAGE_ID="KETADATA_MOB_TOYS_PLAYER_V1";
const STORAGE_KEY="KDT::MOB_TOYS::INDEP::"+hash8(location.pathname+"|"+PAGE_ID)+"::STATE";
$("keyHint").textContent=STORAGE_KEY;

const DEFAULT={
  version:PAGE_ID,
  updatedAt:nowISO(),
  universals:"",
  ui:{ drawer:false, player:true, playerCollapsed:false, invert:false, blackout:false },
  toys:TOYS,
  idx:0,
  surfaceUrl:""
};

function loadState(){
  try{const raw=localStorage.getItem(STORAGE_KEY); return raw?JSON.parse(raw):null;}catch(e){return null;}
}
function deepFill(s){
  if(!s||typeof s!=="object") return structuredClone(DEFAULT);
  for(const k in DEFAULT){ if(s[k]===undefined) s[k]=structuredClone(DEFAULT[k]); }
  if(!s.ui||typeof s.ui!=="object") s.ui=structuredClone(DEFAULT.ui);
  for(const k in DEFAULT.ui){ if(s.ui[k]===undefined) s.ui[k]=structuredClone(DEFAULT.ui[k]); }

  // always prefer latest toy list (so you can update this file without importing state)
  s.toys = structuredClone(TOYS);

  s.idx = Math.max(0, Math.min(Number(s.idx||0), s.toys.length-1));
  s.surfaceUrl = String(s.surfaceUrl||"").trim();
  s.universals = String(s.universals||"");
  return s;
}
let STATE=deepFill(loadState());
let _BOOTING=true;

function persist(silent=false){
  if(_BOOTING) return;
  STATE.updatedAt=nowISO();
  try{localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE));}catch(e){}
  if(!silent) render();
}
(function(){
  const flush=()=>{ try{ persist(true); }catch(e){} };
  window.addEventListener("pagehide", flush, {capture:true});
  window.addEventListener("beforeunload", flush, {capture:true});
  document.addEventListener("visibilitychange", ()=>{ if(document.visibilityState==="hidden") flush(); }, {capture:true});
})();

/* ===== surface ===== */
const root=$("root");
const surface=$("surface");

function cur(){ return STATE.toys[STATE.idx] || null; }
function setIdx(i){
  STATE.idx=Math.max(0, Math.min(Number(i||0), STATE.toys.length-1));
}
function loadToSurface(){
  const c=cur(); if(!c) return;
  const u=normalizeUrl(c.url);
  STATE.surfaceUrl=u;
  surface.src=u;
  $("status").textContent = "SURFACE: " + canon(c.name);
}
function playToggle(){
  // PLAY here = ensure surface is loaded (no pause semantics for iframe)
  loadToSurface();
}
function goFull(){
  const c=cur(); if(!c) return;
  window.location.href = normalizeUrl(c.url);
}

/* ===== render ===== */
function render(){
  root.classList.toggle("invert", !!STATE.ui.invert);
  root.classList.toggle("blackout", !!STATE.ui.blackout);

  $("drawer").classList.toggle("open", !!STATE.ui.drawer && !STATE.ui.blackout);
  $("player").classList.toggle("hidden", !STATE.ui.player || STATE.ui.blackout);
  $("player").classList.toggle("collapsed", !!STATE.ui.playerCollapsed);

  $("universals").value = STATE.universals;

  const c=cur();
  $("nowLabel").textContent = c ? canon(c.name) : "—";

  // surface persistence
  if(STATE.surfaceUrl){
    surface.src = STATE.surfaceUrl;
  }else{
    // do not blank by default; we want immediate toys—load current if blank
    // but avoid forcing reload while user navigates
  }

  // presets
  const grid=$("presetGrid");
  grid.innerHTML="";
  STATE.toys.forEach((t,idx)=>{
    const b=document.createElement("button");
    b.className="btn presetBtn" + (idx===STATE.idx ? " sel" : "");
    b.textContent = canon(t.name);
    b.addEventListener("click", ()=>{
      setIdx(idx);
      persist(true);
      render();
    });
    grid.appendChild(b);
  });
}

/* ===== controls ===== */
function toggleDrawer(){
  if(STATE.ui.blackout) return;
  STATE.ui.drawer=!STATE.ui.drawer;
  persist(true);
}
function togglePlayer(){
  if(STATE.ui.blackout) return;
  STATE.ui.player=!STATE.ui.player;
  if(!STATE.ui.player) STATE.ui.drawer=false;
  persist(true);
}
function toggleInvert(){
  STATE.ui.invert=!STATE.ui.invert;
  persist(true);
}
function toggleBlackout(){
  STATE.ui.blackout=!STATE.ui.blackout;
  if(STATE.ui.blackout){
    STATE.ui.drawer=false;
    STATE.ui.player=false;
    $("status").textContent="NULL";
  }else{
    STATE.ui.player=true;
    $("status").textContent="READY";
  }
  persist(true);
}

/* ===== mobile "hotkeys as buttons" =====
   - NULL: square bottom-right (always)
   - INVERT: long touch on brand (top-left) + also in system drawer
*/
function bindLongPress(el, onLong){
  let t=null, fired=false;
  const LONG_MS=520;

  const clear=()=>{
    if(t){ clearTimeout(t); t=null; }
    fired=false;
  };

  el.addEventListener("pointerdown",(ev)=>{
    if(ev.pointerType!=="touch") return;
    fired=false;
    t=setTimeout(()=>{
      fired=true;
      onLong();
    }, LONG_MS);
  }, {passive:true});

  el.addEventListener("pointerup",()=>{ clear(); }, {passive:true});
  el.addEventListener("pointercancel",()=>{ clear(); }, {passive:true});
  el.addEventListener("pointermove",()=>{ /* keep */ }, {passive:true});
}

/* ===== import/export ===== */
function doExport(){
  const payload=JSON.stringify({ STORAGE_KEY, STATE }, null, 2);
  const stamp=new Date().toISOString().replace(/[:.]/g,"-");
  downloadJson(`KETADATA_MOB_TOYS_${stamp}.json`, payload);
}
function doImport(){
  $("file").click();
}

/* ===== bind ===== */
function bind(){
  $("btnSystem").addEventListener("click", toggleDrawer);
  $("btnCloseDrawer").addEventListener("click", ()=>{ STATE.ui.drawer=false; persist(true); });

  $("btnPlayer").addEventListener("click", togglePlayer);

  $("btnPrev").addEventListener("click", ()=>{
    setIdx(STATE.idx-1);
    persist(true);
    render();
  });
  $("btnNext").addEventListener("click", ()=>{
    setIdx(STATE.idx+1);
    persist(true);
    render();
  });

  $("btnPlay").addEventListener("click", ()=>{
    playToggle();
    persist(true);
  });

  $("btnGo").addEventListener("click", goFull);

  $("btnCollapse").addEventListener("click", ()=>{
    if(STATE.ui.blackout) return;
    STATE.ui.playerCollapsed=!STATE.ui.playerCollapsed;
    persist(true);
  });

  $("btnInvert").addEventListener("click", toggleInvert);

  $("nullSquare").addEventListener("click", toggleBlackout);

  bindLongPress($("invertHold"), toggleInvert);

  $("universals").addEventListener("input", ()=>{
    STATE.universals = $("universals").value;
    persist(true);
  });
  $("btnClearUniversals").addEventListener("click", ()=>{
    STATE.universals="";
    $("universals").value="";
    persist(true);
  });

  $("btnExport").addEventListener("click", doExport);
  $("btnImport").addEventListener("click", doImport);
  $("file").addEventListener("change",(e)=>{
    const f=e.target.files && e.target.files[0];
    if(!f) return;
    const r=new FileReader();
    r.onload=()=>{
      try{
        const parsed=JSON.parse(String(r.result||""));
        const incoming=(parsed && parsed.STATE)?parsed.STATE:parsed;
        STATE=deepFill(incoming);
        // hard safety: keep latest toy list
        STATE.toys = structuredClone(TOYS);
        persist(true);
        render();
      }catch(err){}
    };
    r.readAsText(f);
    e.target.value="";
  });

  // initial load into surface if empty
  if(!STATE.surfaceUrl){
    const c=cur();
    if(c){ STATE.surfaceUrl = normalizeUrl(c.url); surface.src = STATE.surfaceUrl; }
  }
}

/* ===== boot ===== */
(function init(){
  _BOOTING=false;
  bind();
  render();
})();
</script>

<!--
AE:
- MOBILE TOYS PLAYER: PRESETS ONLY (CURATED).
- PLAYER COLLAPSIBLE (—).
- NULL = SQUARE (BOTTOM RIGHT).
- INVERT = LONG TOUCH TOP-LEFT BRAND (PLUS BUTTON IN SYSTEM).

EE:
- TAP PRESET = SELECT.
- PLAY = LOAD INTO SURFACE (IFRAME).
- GO = NAVIGATE FULL TAB TO CURRENT TOY.
- SYSTEM DRAWER HOLDS UNIVERSALS + STATE IO.

WB:
FILE_ID: mob_toys_player_v1.html
ROOM_ID: MOB_BASE
VERSION: v1
UPDATED_AT: 2026-01-15
CHANGELOG:
- Curated toy presets focused on Tennis & Catball.
- Mobile hotkeys implemented as controls: NULL square + long-press invert.
-->
</body>
</html>
