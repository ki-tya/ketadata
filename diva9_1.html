<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KETADATA_BASE_SYSTEM</title>
<style>
:root{--bg:#000; --fg:#fff; --muted:#8a8a8a; --line:#222; --line2:#333; --top:44px; --bot:34px; --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; --sans: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; --ctl-radius:0px; --ctl-alpha:0.82; --ctl-bg: rgba(0,0,0,var(--ctl-alpha)); --note-border: rgba(255,255,255,0.78); --drawer-h: 0.42}
*{box-sizing:border-box}
html,body{height:100%; margin:0}
body{background:var(--bg); color:var(--fg); font-family:var(--sans); overflow:hidden; user-select:none}
#root{position:fixed; inset:0; background:#000}
#root.invert{filter:invert(1)}
#root.fs .topbar,#root.fs .bottombar,#root.fs .drawer,#root.fs #pinnedPanel,#root.fs #armedBar,#root.fs .toast,#root.fs #activeStrip{display:none !important}
#root.blackout .topbar,#root.blackout .bottombar,#root.blackout .drawer,#root.blackout #pinnedPanel,#root.blackout #armedBar,#root.blackout .toast,#root.blackout .ketaNote,#root.blackout #activeStrip{display:none !important}
#root.blackout #stage{background:#000 !important; filter:none !important}
#root.blackout #motion{display:none !important}
#stage{position:absolute; inset:0; background:#000; pointer-events:none}
#motion{position:absolute; inset:0; pointer-events:none; opacity:0; background:repeating-linear-gradient(135deg, rgba(255,255,255,0.06) 0px, rgba(255,255,255,0.06) 1px, rgba(0,0,0,0) 12px, rgba(0,0,0,0) 22px); mix-blend-mode:screen; transform:translate3d(0,0,0)}
#motion.run{opacity:0.12; animation:scanflow 2.2s linear infinite}
@keyframes scanflow{0%{transform:translate3d(-80px,60px,0)}100%{transform:translate3d(80px,-60px,0)}}
.topbar{position:absolute; top:0; left:0; right:0; height:var(--top); display:flex; align-items:center; justify-content:space-between; padding:0 10px; border-bottom:1px solid var(--line); background:linear-gradient(180deg,#070707,#000); z-index:10}
.brand{display:flex; align-items:center; gap:10px; font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase}
.brand .sq{width:10px; height:10px; border:1px solid var(--fg); background:#000}
.roomBadge{display:flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted); border:1px solid var(--line2); padding:4px 8px}
.actions{display:flex; align-items:center; gap:8px; font-family:var(--mono); font-size:12px}
.btn{background:transparent; color:var(--fg); border:1px solid var(--line2); padding:6px 10px; font-family:var(--mono); font-size:12px; letter-spacing:.08em; text-transform:uppercase; cursor:pointer}
.btn:hover{border-color:var(--fg)}
.btn:active{transform:translateY(1px)}
.kbd{border:1px solid var(--line2); padding:2px 6px; color:var(--muted); font-size:11px}
.ketaIcon{width:16px; height:16px; border:2px solid var(--fg); background:var(--fg); cursor:pointer}
.ketaIcon.open{background:#000}
.bottombar{position:absolute; left:0; right:0; bottom:0; height:var(--bot); display:flex; align-items:center; justify-content:space-between; padding:0 10px; border-top:1px solid var(--line); background:linear-gradient(0deg,#070707,#000); z-index:10; font-family:var(--mono); font-size:11px; color:var(--muted)}
.toggle{border:1px solid var(--line2); background:transparent; color:var(--fg); padding:4px 8px; font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase; cursor:pointer}
.toggle:hover{border-color:var(--fg)}
.drawer{position:absolute; left:0; right:0; bottom:var(--bot); height:calc((100vh - var(--top) - var(--bot)) * var(--drawer-h)); min-height:200px; border-top:1px solid var(--line); background:linear-gradient(180deg,#060606,#000); display:none; z-index:20}
.drawer.open{display:flex; flex-direction:column}
.drawerSizer{height:10px; cursor:ns-resize; border-bottom:1px solid var(--line); background:linear-gradient(180deg,#0a0a0a,#050505)}
.drawerHead{padding:8px 10px; border-bottom:1px solid var(--line); font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; display:flex; justify-content:space-between; align-items:center}
.drawerBody{padding:10px; min-height:0; flex:1; overflow:auto}
textarea{width:100%; border:1px solid var(--line2); background:#050505; color:var(--fg); font-family:var(--mono); font-size:12px; padding:10px; line-height:1.35; outline:none; resize:vertical; min-height:140px}
input{outline:none}
.ketaNote{position:absolute; top:76px; right:16px; left:auto; width:340px; height:220px; display:none; z-index:30; resize:both; overflow:hidden; border-radius:var(--ctl-radius); background:var(--ctl-bg); border:1px solid var(--note-border); backdrop-filter:blur(6px)}
.ketaNote.open{display:flex; flex-direction:column}
.ketaHead{padding:8px 10px; border-bottom:1px solid rgba(255,255,255,0.14); font-family:var(--mono); font-size:11px; letter-spacing:.14em; text-transform:uppercase; display:flex; justify-content:space-between; align-items:center; cursor:move}
.ketaBody{padding:10px; min-height:0; flex:1}
.ketaNote textarea{background:#000; color:#fff; border:1px solid rgba(255,255,255,0.22); width:100%; height:100%; resize:none; padding:10px; outline:none}
.headBtn{background:transparent; color:var(--fg); border:1px solid rgba(255,255,255,0.18); padding:2px 8px; font-family:var(--mono); font-size:12px; letter-spacing:.08em; text-transform:uppercase; cursor:pointer}
.headBtn:hover{border-color:rgba(255,255,255,0.6)}
#armedBar{position:absolute; left:10px; top:calc(var(--top) + 10px); z-index:27; display:none; gap:8px; align-items:center; flex-wrap:wrap; padding:8px 10px; border:1px solid var(--line2); background:rgba(0,0,0,0.86); font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase}
#armedBar .label{color:var(--muted)}
#armedBar .val{color:var(--fg)}
#armedBar input{background:#000; color:#fff; border:1px solid var(--line2); padding:6px 8px; font-family:var(--mono); font-size:11px; letter-spacing:.08em; width:340px; max-width:calc(100vw - 40px)}
#pinnedPanel{position:absolute; left:10px; top:calc(var(--top) + 64px); z-index:26; display:none; gap:8px; flex-wrap:wrap; align-items:flex-start; padding:8px 10px; border:1px solid var(--line2); background:rgba(0,0,0,0.86); font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase}
#activeStrip{position:absolute; left:10px; top:calc(var(--top) + 122px); z-index:25; display:none; gap:8px; flex-wrap:wrap; align-items:center; padding:8px 10px; border:1px solid var(--line2); background:rgba(0,0,0,0.86); font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase}
#activeStrip .label{color:var(--muted)}
#padPanel{position:absolute; left:14px; top:calc(var(--top) + 170px); width:360px; height:360px; display:none; z-index:31; border:1px solid rgba(255,255,255,0.22); border-radius:var(--ctl-radius); background:rgba(0,0,0,0.86); backdrop-filter:blur(6px); overflow:hidden; resize:both; min-width:340px; min-height:260px}
#padPanel.open{display:flex; flex-direction:column}
#padHead{padding:8px 10px; border-bottom:1px solid rgba(255,255,255,0.14); font-family:var(--mono); font-size:11px; letter-spacing:.14em; text-transform:uppercase; display:flex; justify-content:space-between; align-items:center; cursor:move}
#padBody{padding:10px; min-height:0; flex:1; display:flex; flex-direction:column; gap:10px}
#padGrid{flex:1; display:grid; grid-template-columns:repeat(4, 1fr); grid-template-rows:repeat(4, 1fr); gap:8px; min-height:0}
.padCell{border:1px solid rgba(255,255,255,0.18); background:rgba(0,0,0,0.35); padding:8px; overflow:hidden; display:flex; flex-direction:column; gap:6px; min-width:0}
.padCell .nm{font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.padCell a{color:var(--fg); font-family:var(--mono); font-size:11px; letter-spacing:.02em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-decoration:none; border-bottom:1px solid rgba(255,255,255,0.18); padding-bottom:2px}
.padCell a:hover{border-bottom-color:rgba(255,255,255,0.55)}
.padCell input{width:100%; background:#000; color:#fff; border:1px solid rgba(255,255,255,0.22); padding:6px 8px; font-family:var(--mono); font-size:11px; letter-spacing:.06em; outline:none; min-width:0}
.toast{position:absolute; left:12px; top:calc(var(--top) + 12px); padding:8px 10px; border:1px solid var(--line2); background:rgba(8,8,8,0.82); font-family:var(--mono); font-size:11px; letter-spacing:.06em; color:var(--fg); display:none; z-index:40}
</style>
</head>

<body>
<div id="root">
  <div id="stage"></div>
  <div id="motion" aria-hidden="true"></div>
  <div id="armedBar"><span class="label">ARMED</span><span class="val" id="armedName">—</span><button class="btn" id="armedGo" style="padding:4px 8px; font-size:11px">GO</button><button class="btn" id="armedNewTab" style="padding:4px 8px; font-size:11px">NEW TAB</button><button class="btn" id="armedCopy" style="padding:4px 8px; font-size:11px">COPY URL</button><input id="armedUrl" readonly value="—" /></div>
  <div id="pinnedPanel"></div>
  <div id="activeStrip"></div>
  <div id="padPanel"><div id="padHead"><span id="padTitle">PAD</span><div style="display:flex; gap:8px; align-items:center"><button class="headBtn" id="padEditBtn">EDIT</button><button class="headBtn" id="padCloseBtn">X</button></div></div><div id="padBody"><div id="padGrid"></div><div style="display:flex; gap:8px; align-items:center; justify-content:space-between; font-family:var(--mono); font-size:11px; color:var(--muted); letter-spacing:.08em; text-transform:uppercase"><span id="padHint">CLICK = ARM</span><span id="padSetId" style="opacity:.7">—</span></div></div></div>
  <div class="toast" id="toast"></div>
  <div class="topbar"><div style="display:flex; gap:10px; align-items:center"><div class="brand"><span class="sq"></span><span>KETADATA // BASE // DIVA9</span><span style="color:var(--muted); letter-spacing:.02em; text-transform:none">v5</span></div><div class="roomBadge"><span>ROOM</span><span id="roomName">BASE</span></div></div><div class="actions"><button class="btn" id="btnImport">IMPORT</button><button class="btn" id="btnExport">EXPORT</button><button class="btn" id="btnCopy">COPY</button><span class="kbd" title="Run">Space</span><span class="kbd" title="Invert">Shift+I</span><span class="kbd" title="Blackout">Shift+N</span><span class="kbd" title="Fullscreen">Shift+F</span><span class="kbd" title="Landing">Shift+K</span><div id="ketaIcon" class="ketaIcon" title="KETA_NOTE"></div></div></div>
  <div class="drawer" id="drawer"><div class="drawerSizer" id="drawerSizer" title="DRAG"></div><div class="drawerHead"><div>SYSTEM</div><div style="display:flex; gap:8px; align-items:center"><span id="sig" style="color:var(--muted); font-family:var(--mono); font-size:11px">∅</span><button class="btn" id="btnToggleMotion">MOTION</button><button class="btn" id="btnCopyUniversals">COPY</button><button class="btn" id="btnCloseDrawer">CLOSE</button></div></div><div class="drawerBody"><div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px"><div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted)">SYSTEM UNIVERSALS</div><button class="btn" id="btnToggleUniversals" style="padding:4px 8px; font-size:11px">TOGGLE</button></div><textarea id="universals" spellcheck="false" autocomplete="off" placeholder="LAWS / REFERENCES"></textarea><div style="margin-top:12px; border-top:1px solid var(--line); padding-top:10px"><div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px"><div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted)">ROOM REGISTRY</div><button class="btn" id="btnToggleRegistry" style="padding:4px 8px; font-size:11px">TOGGLE</button></div><div id="registryBody"><div style="margin-top:8px; display:flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted)"><span>ROOM</span><input id="roomInput" spellcheck="false" autocomplete="off" style="flex:1; background:#000; color:#fff; border:1px solid var(--line2); padding:6px 8px; font-family:var(--mono);" placeholder="NAME" /></div><div style="margin-top:8px; display:flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted)"><span>URL</span><input id="roomUrlInput" spellcheck="false" autocomplete="off" style="flex:1; background:#000; color:#fff; border:1px solid var(--line2); padding:6px 8px; font-family:var(--mono);" placeholder="ANY LINK / PATH" /></div><div style="margin-top:8px; display:flex; gap:8px; align-items:center"><button class="btn" id="btnSaveRoom">SAVE</button><button class="btn" id="btnSetActiveRoom">SET ACTIVE</button><button class="btn" id="btnDeleteRoom">DELETE</button><button class="btn" id="btnTogglePins">PINS</button></div></div><div style="margin-top:10px; border-top:1px solid var(--line); padding-top:10px"><div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px"><div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted)">ACTIVE</div><button class="btn" id="btnToggleActive" style="padding:4px 8px; font-size:11px">TOGGLE</button></div><div id="activeBody"><div style="display:flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted)"><span style="min-width:44px">ROOM</span><input id="activeRoomBox" readonly style="flex:1; background:#000; color:#fff; border:1px solid var(--line2); padding:6px 8px; font-family:var(--mono);" placeholder="—" /></div><div style="margin-top:8px; display:flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted)"><span style="min-width:44px">URL</span><input id="activeUrlBox" readonly style="flex:1; background:#000; color:#fff; border:1px solid var(--line2); padding:6px 8px; font-family:var(--mono);" placeholder="—" /></div><div style="margin-top:8px; display:flex; gap:8px; align-items:center"><button class="btn" id="btnGoActive">GO</button><button class="btn" id="btnNewTabActive">NEW TAB</button><button class="btn" id="btnCopyActiveUrl">COPY URL</button></div><div style="margin-top:8px; color:var(--muted); font-family:var(--mono); font-size:11px">CLICK = ARM. GO = COMMIT.</div></div></div><div id="setsBox" style="margin-top:10px; border-top:1px solid var(--line); padding-top:10px"><div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px"><div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted)">SETS</div><button class="btn" id="btnToggleSets" style="padding:4px 8px; font-size:11px">TOGGLE</button></div><div id="setsBody"><div style="margin-top:8px; display:flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted)"><span>SET</span><input id="setNameInput" spellcheck="false" autocomplete="off" style="flex:1; background:#000; color:#fff; border:1px solid var(--line2); padding:6px 8px; font-family:var(--mono);" placeholder="NAME" /></div><div style="margin-top:8px; display:flex; gap:8px; align-items:center"><button class="btn" id="btnCreateSet">CREATE</button><button class="btn" id="btnRenameSet">RENAME</button><button class="btn" id="btnDeleteSet">DELETE</button><button class="btn" id="btnPinSet">PIN/UNPIN</button></div><div style="margin-top:8px; color:var(--muted); font-family:var(--mono); font-size:11px">SET EDITOR (BULK): ONE PER LINE: NAME | URL  OR URL</div><textarea id="setItemsInput" spellcheck="false" autocomplete="off" style="min-height:120px; margin-top:8px" placeholder="ITEMS:
NAME | URL
OR URL"></textarea><div style="margin-top:8px; display:flex; gap:8px; align-items:center"><button class="btn" id="btnSaveSetItems">SAVE ITEMS</button><button class="btn" id="btnClearSetItems">CLEAR</button></div><div style="margin-top:10px; border-top:1px solid var(--line); padding-top:10px"><div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted); margin-bottom:8px">SET LIST</div><div id="setList" style="display:flex; flex-direction:column; gap:6px"></div><div style="margin-top:8px; color:var(--muted); font-family:var(--mono); font-size:11px">CLICK SET = LOAD EDITOR. CLICK ITEM = ARM.</div></div></div></div><div style="margin-top:10px; border-top:1px solid var(--line); padding-top:10px"><div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px"><div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted)">BULK INPUT</div><button class="btn" id="btnToggleBulk" style="padding:4px 8px; font-size:11px">TOGGLE</button></div><div id="bulkBody"><textarea id="bulkRoomInput" spellcheck="false" autocomplete="off" style="min-height:110px" placeholder="ONE PER LINE:
NAME | URL
OR URL

# lines starting with # are ignored"></textarea><div style="margin-top:8px; display:flex; gap:8px; align-items:center"><button class="btn" id="btnBulkAdd">BULK ADD</button><button class="btn" id="btnBulkClear">CLEAR</button></div><div style="margin-top:8px; color:var(--muted); font-family:var(--mono); font-size:11px">NO AUTOFILL. OVERWRITE FAST.</div></div></div><div style="margin-top:10px; border-top:1px solid var(--line); padding-top:10px"><div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px"><div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted)">PRESETS</div><button class="btn" id="btnTogglePresets" style="padding:4px 8px; font-size:11px">TOGGLE</button></div><div id="presetsBody"><div id="roomList" style="display:flex; flex-direction:column; gap:6px"></div><div style="margin-top:8px; color:var(--muted); font-family:var(--mono); font-size:11px">CLICK = ARM. PIN = BASE.</div></div></div></div></div></div>
  <div class="bottombar"><div style="display:flex; gap:10px; align-items:center"><button class="toggle" id="toggleDrawer">SYSTEM</button><button class="toggle" id="toggleRun">RUN</button><span>STATE: <span id="sig2">∅</span></span><span style="margin-left:8px">FS: <span id="fsLabel">OFF</span></span><span style="margin-left:8px">BLK: <span id="blkLabel">OFF</span></span></div><div style="display:flex; gap:12px; align-items:center"><span>LIGHT: <span id="lightLabel">1</span></span><span>RUN: <span id="runLabel">OFF</span></span><span>MOTION: <span id="motionLabel">OFF</span></span></div></div>
  <div class="ketaNote" id="ketaNote"><div class="ketaHead" id="ketaHead"><div>KETA_NOTE</div><button class="headBtn" id="btnHideNote">-</button></div><div class="ketaBody"><textarea id="ketaText" spellcheck="false" autocomplete="off" placeholder="GLOBAL NOTE"></textarea></div></div>
  <input id="file" type="file" accept="application/json" style="display:none" />
</div>

<script>
// EXACT SYSTEM6 PATTERN
const LS="ketadata_base_diva9_final";
const $=id=>document.getElementById(id);
const root=$("root"),stage=$("stage"),motion=$("motion");

const URLS={LANDING:"index11.html",PHOTOBOOTH:"crunch1.html",KDTV:"kdtv1.html",POD:"room.html",WORLD:"map.html",INFINITY:"infinity.html",CALENDAR:"calendar1.html",STUDIO:"tester3.html",LAB:"labyrinth.html"};
const CORE=[{room:"CALENDAR",roomUrl:URLS.CALENDAR},{room:"POD",roomUrl:URLS.POD},{room:"WORLD",roomUrl:URLS.WORLD},{room:"KDTV",roomUrl:URLS.KDTV},{room:"PHOTOBOOTH",roomUrl:URLS.PHOTOBOOTH},{room:"STUDIO",roomUrl:URLS.STUDIO},{room:"LAB",roomUrl:URLS.LAB}];

function uid(){return Math.random().toString(16).slice(2)+Date.now().toString(16)}
function canon(n){return String(n||"").trim().toUpperCase()}

function seed(){
  const rooms=[];
  CORE.forEach(c=>rooms.push({room:c.room,roomUrl:c.roomUrl,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}));
  return {version:1,ketaNote:"",universals:"",room:"BASE",roomUrl:"",ui:{invert:false,blackout:false,fullscreen:false,lightPreset:1,lightRunning:false,motionOn:false,pinnedRooms:[],pinnedSets:[],activeSets:[],activeSetId:"",padOpen:false,padEdit:false,padRect:{x:null,y:null,w:360,h:360},drawerOpen:false,noteOpen:false,universalsCollapsed:false,registryCollapsed:false,activeCollapsed:false,setsCollapsed:false,bulkCollapsed:false,presetsCollapsed:false,noteRect:{x:null,y:76,w:340,h:220},drawerH:0.42},payload:{roomPresets:rooms,sets:[]}}
}

function load(){
  try{const raw=localStorage.getItem(LS);return raw?JSON.parse(raw):null}catch(e){return null}
}

function save(){
  try{localStorage.setItem(LS,JSON.stringify(state))}catch(e){}
  render();
}

const state=load()||seed();

function getSet(id){return(state.payload.sets||[]).find(s=>String(s.id)===String(id||""))||null}
function getPreset(room){return(state.payload.roomPresets||[]).find(r=>canon(r.room)===canon(room))||null}
function isPinned(room){return(state.ui.pinnedRooms||[]).includes(canon(room))}
function isSetPinned(id){return(state.ui.pinnedSets||[]).includes(String(id||""))}

let toastTimer=null;
function toast(msg){if(state.ui.blackout||state.ui.fullscreen)return;const t=$("toast");t.textContent=msg;t.style.display="block";if(toastTimer)clearTimeout(toastTimer);toastTimer=setTimeout(()=>{t.style.display="none"},900)}
async function copy(text){try{await navigator.clipboard.writeText(text);toast("COPIED")}catch(e){toast("COPY FAILED")}}

function deriveNameFromUrl(url){try{const u=new URL(url,location.href);const path=(u.pathname||"").split("/").filter(Boolean);const last=path.length?path[path.length-1]:(u.hostname||"LINK");return String(last).replace(/\.(html?|php|aspx|jsp)$/i,"").replace(/[-_]+/g," ").trim().toUpperCase()||"LINK"}catch(e){return String(url||"LINK").trim().slice(0,28).toUpperCase()||"LINK"}}

let lightInterval=null,lightCount=0,lightAuxA=0,lightAuxB=0;
function resetStage(){stage.style.backgroundColor="#000";stage.style.filter="none";lightCount=0;lightAuxA=0;lightAuxB=0}
function stopLight(){if(lightInterval){clearInterval(lightInterval);lightInterval=null}state.ui.lightRunning=false;resetStage();save()}
function startLight(preset){if(lightInterval){clearInterval(lightInterval);lightInterval=null}resetStage();state.ui.lightPreset=preset;state.ui.lightRunning=true;if(preset===1){lightInterval=setInterval(()=>{const curr=stage.style.backgroundColor||"black";stage.style.backgroundColor=(curr==="black"||curr==="rgb(0, 0, 0)")?"white":"black"},50)}else if(preset===2){lightInterval=setInterval(()=>{lightAuxA=(lightAuxA+30)%360;lightAuxB+=0.5;const l=50+Math.sin(lightAuxB)*40;stage.style.backgroundColor=`hsl(${lightAuxA},100%,${l}%)`},10)}else if(preset===3){lightInterval=setInterval(()=>{lightCount++;const beat=lightCount%16;if(beat===0||beat===1){stage.style.backgroundColor="#fff";stage.style.filter="invert(1) contrast(3) brightness(2)"}else if(beat===2){stage.style.backgroundColor="#000";stage.style.filter="invert(1) contrast(2)"}else if(beat===3){stage.style.backgroundColor="#0f0";stage.style.filter="contrast(2) saturate(3)"}else if(beat===4){stage.style.backgroundColor="#f0f";stage.style.filter="invert(1) hue-rotate(90deg)"}else if(beat===5||beat===6){stage.style.backgroundColor="#0ff";stage.style.filter="invert(0.7) contrast(2)"}else if(beat===7){stage.style.backgroundColor="#fff";stage.style.filter="invert(1) brightness(3)"}else if(beat===8){stage.style.backgroundColor="#000";stage.style.filter="invert(1) contrast(3)"}else if(beat===9||beat===10){stage.style.backgroundColor="#0f0";stage.style.filter="saturate(5) contrast(2)"}else if(beat===11){stage.style.backgroundColor="#f0f";stage.style.filter="invert(1) saturate(3)"}else{stage.style.backgroundColor="#08f";stage.style.filter="contrast(1.5) brightness(1.2)"}},30)}else if(preset===4){lightInterval=setInterval(()=>{lightAuxA+=0.08;lightCount++;const red=Math.abs(Math.sin(lightAuxA))*255;const pulse=Math.abs(Math.sin(lightAuxA*0.5));const contrast=2+pulse*2;const saturation=4+pulse*2;if(lightCount%8===0){stage.style.backgroundColor="#000";stage.style.filter="brightness(3) contrast(3)"}else{stage.style.backgroundColor=`rgb(${red},0,0)`;stage.style.filter=`contrast(${contrast}) saturate(${saturation}) brightness(${1.2+pulse*0.5})`}},20)}else if(preset===5){lightInterval=setInterval(()=>{lightAuxA+=15;lightAuxB=(lightAuxB+2)%100;const hue=260+Math.sin(lightAuxA*0.1)*40;const saturation=80+Math.cos(lightAuxA*0.05)*20;const lightness=30+Math.sin(lightAuxB*0.1)*30;const spiralBrightness=1+Math.abs(Math.sin(lightAuxA*0.05))*0.8;const spiralContrast=1.5+Math.abs(Math.cos(lightAuxA*0.08))*1;stage.style.backgroundColor=`hsl(${hue},${saturation}%,${lightness}%)`;stage.style.filter=`contrast(${spiralContrast}) saturate(2) brightness(${spiralBrightness}) hue-rotate(${lightAuxA*0.5}deg)`},25)}else if(preset===6){lightInterval=setInterval(()=>{lightCount++;if(lightCount%50===0||lightCount%50===2){stage.style.backgroundColor="#fff";stage.style.filter="brightness(5) contrast(5)"}else{stage.style.backgroundColor="#000";stage.style.filter="none"}},30)}save()}

function render(){
  root.classList.toggle("invert",!!state.ui.invert);
  root.classList.toggle("blackout",!!state.ui.blackout);
  root.classList.toggle("fs",!!state.ui.fullscreen);
  motion.classList.toggle("run",!!state.ui.motionOn);
  $("drawer").classList.toggle("open",!!state.ui.drawerOpen&&!state.ui.blackout&&!state.ui.fullscreen);
  $("ketaNote").classList.toggle("open",!!state.ui.noteOpen&&!state.ui.blackout);
  $("ketaIcon").classList.toggle("open",!!state.ui.noteOpen&&!state.ui.blackout);
  $("ketaText").value=state.ketaNote||"";
  $("universals").value=state.universals||"";
  $("roomName").textContent=canon(state.room)||"BASE";
  $("universals").style.display=state.ui.universalsCollapsed?"none":"block";
  $("registryBody").style.display=state.ui.registryCollapsed?"none":"block";
  $("activeBody").style.display=state.ui.activeCollapsed?"none":"block";
  $("setsBody").style.display=state.ui.setsCollapsed?"none":"block";
  $("bulkBody").style.display=state.ui.bulkCollapsed?"none":"block";
  $("presetsBody").style.display=state.ui.presetsCollapsed?"none":"block";
  if($("activeRoomBox"))$("activeRoomBox").value=canon(state.room)||"BASE";
  if($("activeUrlBox"))$("activeUrlBox").value=String(state.roomUrl||"");
  $("fsLabel").textContent=state.ui.fullscreen?"ON":"OFF";
  $("blkLabel").textContent=state.ui.blackout?"ON":"OFF";
  $("lightLabel").textContent=String(state.ui.lightPreset||1);
  $("runLabel").textContent=state.ui.lightRunning?"ON":"OFF";
  $("motionLabel").textContent=state.ui.motionOn?"ON":"OFF";
  renderRoomList();
  renderSetList();
  renderArmedBar();
  renderPinnedPanel();
  renderActiveStrip();
  renderPad();
}

function renderRoomList(){const el=$("roomList");el.innerHTML="";const order=["CALENDAR","POD","WORLD","KDTV","PHOTOBOOTH","STUDIO","LAB"];const by=new Map((state.payload.roomPresets||[]).map(p=>[canon(p.room),p]));const coreOrdered=order.map(k=>by.get(k)).filter(Boolean);const others=(state.payload.roomPresets||[]).filter(p=>!order.includes(canon(p.room)));const presets=[...coreOrdered,...others];presets.forEach(p=>{const row=document.createElement("div");row.style.display="flex";row.style.gap="8px";row.style.alignItems="center";row.style.border="1px solid var(--line2)";row.style.padding="8px 10px";row.style.fontFamily="var(--mono)";row.style.fontSize="11px";row.style.cursor="pointer";const left=document.createElement("div");left.style.flex="1";left.textContent=p.room||"—";const pin=document.createElement("button");pin.className="btn";pin.style.padding="4px 8px";pin.style.fontSize="11px";pin.textContent=isPinned(p.room)?"UNPIN":"PIN";pin.addEventListener("click",ev=>{ev.stopPropagation();const i=state.ui.pinnedRooms.indexOf(canon(p.room));if(i>=0)state.ui.pinnedRooms.splice(i,1);else state.ui.pinnedRooms.push(canon(p.room));save()});row.addEventListener("click",()=>{state.room=canon(p.room);state.roomUrl=p.roomUrl||"";$("roomInput").value=p.room||"";$("roomUrlInput").value=p.roomUrl||"";save()});if(canon(state.room)===canon(p.room))row.style.borderColor="var(--fg)";row.appendChild(left);row.appendChild(pin);el.appendChild(row)})}

function renderSetList(){const el=$("setList");if(!el)return;el.innerHTML="";(state.payload.sets||[]).forEach(s=>{const row=document.createElement("div");row.style.display="flex";row.style.gap="8px";row.style.alignItems="center";row.style.border="1px solid var(--line2)";row.style.padding="8px 10px";row.style.cursor="pointer";const left=document.createElement("div");left.style.flex="1";left.textContent=canon(s.label||"SET");const pin=document.createElement("button");pin.className="btn";pin.style.padding="4px 8px";pin.style.fontSize="11px";pin.textContent=isSetPinned(s.id)?"UNPIN":"PIN";pin.addEventListener("click",ev=>{ev.stopPropagation();const sid=String(s.id||"");const i=state.ui.pinnedSets.indexOf(sid);if(i>=0)state.ui.pinnedSets.splice(i,1);else state.ui.pinnedSets.push(sid);save()});row.addEventListener("click",()=>{$("setNameInput").value=canon(s.label||"SET");const lines=(s.items||[]).map(it=>`${canon(it.label||"")||deriveNameFromUrl(it.url)} | ${it.url}`);$("setItemsInput").value=lines.join("\n");save()});row.appendChild(left);row.appendChild(pin);el.appendChild(row)})}

function renderArmedBar(){const bar=$("armedBar");if(state.ui.blackout||state.ui.fullscreen){bar.style.display="none";return}bar.style.display="flex";$("armedName").textContent=canon(state.room)||"—";$("armedUrl").value=String(state.roomUrl||"")||"—"}

function renderPinnedPanel(){
  const el=$("pinnedPanel");
  if(state.ui.blackout||state.ui.fullscreen){el.style.display="none";el.innerHTML="";return}
  const hasPins=(state.ui.pinnedRooms.length>0)||(state.ui.pinnedSets.length>0);
  if(!hasPins){el.style.display="none";el.innerHTML="";return}
  el.style.display="flex";
  el.innerHTML="";
  const by=new Map((state.payload.roomPresets||[]).map(p=>[canon(p.room),p]));
  state.ui.pinnedRooms.forEach(name=>{
    const p=by.get(name);
    if(!p)return;
    const chip=document.createElement("button");
    chip.className="btn";
    chip.textContent=name;
    chip.addEventListener("click",()=>{state.room=canon(p.room);state.roomUrl=p.roomUrl||"";toast("ARMED");save()});
    if(canon(state.room)===name)chip.style.borderColor="var(--fg)";
    el.appendChild(chip)
  });
  state.ui.pinnedSets.forEach(setId=>{
    const s=getSet(setId);
    if(!s)return;
    const chip=document.createElement("button");
    chip.className="btn";
    chip.textContent=canon(s.label||"SET");
    chip.addEventListener("click",()=>{state.ui.activeSetId=String(s.id);state.ui.padOpen=true;toast("PAD OPEN");save()});
    if(String(state.ui.activeSetId)===String(s.id))chip.style.borderColor="var(--fg)";
    el.appendChild(chip)
  })
}

function renderActiveStrip(){
  const el=$("activeStrip");
  if(state.ui.blackout||state.ui.fullscreen){el.style.display="none";el.innerHTML="";return}
  const activeSets=state.ui.activeSets.filter(id=>getSet(id));
  if(!activeSets.length){el.style.display="none";el.innerHTML="";return}
  el.style.display="flex";
  el.innerHTML="";
  const lab=document.createElement("span");
  lab.className="label";
  lab.textContent="ACTIVE";
  el.appendChild(lab);
  activeSets.forEach(id=>{
    const s=getSet(id);
    if(!s)return;
    const chip=document.createElement("button");
    chip.className="btn";
    chip.textContent=canon(s.label||"SET");
    chip.style.padding="4px 8px";
    chip.style.fontSize="11px";
    if(String(state.ui.activeSetId)===String(id))chip.style.borderColor="var(--fg)";
    chip.addEventListener("click",()=>{state.ui.activeSetId=String(id);state.ui.padOpen=true;toast("PAD OPEN");save()});
    el.appendChild(chip)
  });
  const padBtn=document.createElement("button");
  padBtn.className="btn";
  padBtn.textContent=state.ui.padOpen?"PAD ON":"PAD";
  padBtn.style.padding="4px 8px";
  padBtn.style.fontSize="11px";
  padBtn.addEventListener("click",()=>{state.ui.padOpen=!state.ui.padOpen;toast(state.ui.padOpen?"PAD OPEN":"PAD CLOSED");save()});
  el.appendChild(padBtn)
}

function renderPad(){const panel=$("padPanel");if(state.ui.blackout||!state.ui.padOpen){panel.classList.remove("open");panel.style.display="none";return}const s=getSet(state.ui.activeSetId);if(!s){panel.classList.remove("open");panel.style.display="none";return}if(!Array.isArray(s.items))s.items=[];for(let i=s.items.length;i<16;i++)s.items.push({label:"",url:""});panel.classList.add("open");panel.style.display="";$("padTitle").textContent=canon(s.label||"PAD");$("padHint").textContent=state.ui.padEdit?"EDIT MODE":"CLICK = ARM";const grid=$("padGrid");grid.innerHTML="";for(let i=0;i<16;i++){const it=s.items[i]||{label:"",url:""};const cell=document.createElement("div");cell.className="padCell";if(state.ui.padEdit){const nm=document.createElement("input");nm.value=it.label||"";nm.placeholder="NAME";nm.addEventListener("input",()=>{s.items[i].label=nm.value;try{localStorage.setItem(LS,JSON.stringify(state))}catch(e){}});const ur=document.createElement("input");ur.value=it.url||"";ur.placeholder="URL";ur.addEventListener("input",()=>{s.items[i].url=ur.value;try{localStorage.setItem(LS,JSON.stringify(state))}catch(e){}});cell.appendChild(nm);cell.appendChild(ur)}else{const nm=document.createElement("div");nm.className="nm";nm.textContent=canon(it.label||"")||(it.url?deriveNameFromUrl(it.url):"—");const a=document.createElement("a");a.href=it.url||"#";a.textContent=it.url||"—";a.addEventListener("click",ev=>{ev.preventDefault();if(!it.url)return;state.room=nm.textContent;state.roomUrl=it.url;toast("ARMED");save()});cell.appendChild(nm);cell.appendChild(a)}grid.appendChild(cell)}}

$("universals").addEventListener("input",()=>{state.universals=$("universals").value||"";try{localStorage.setItem(LS,JSON.stringify(state))}catch(e){}});
$("ketaText").addEventListener("input",()=>{state.ketaNote=$("ketaText").value||"";try{localStorage.setItem(LS,JSON.stringify(state))}catch(e){}});
$("ketaIcon").addEventListener("click",()=>{if(state.ui.blackout)return;state.ui.noteOpen=!state.ui.noteOpen;save()});
$("btnHideNote").addEventListener("click",()=>{state.ui.noteOpen=false;save()});
$("toggleDrawer").addEventListener("click",()=>{if(state.ui.blackout||state.ui.fullscreen)return;state.ui.drawerOpen=!state.ui.drawerOpen;save()});
$("toggleRun").addEventListener("click",()=>{if(state.ui.blackout)return;if(state.ui.lightRunning)stopLight();else startLight(state.ui.lightPreset||1)});
$("btnToggleMotion").addEventListener("click",()=>{state.ui.motionOn=!state.ui.motionOn;save()});
$("padCloseBtn").addEventListener("click",()=>{state.ui.padOpen=false;save()});
$("padEditBtn").addEventListener("click",()=>{state.ui.padEdit=!state.ui.padEdit;save()});
$("btnToggleUniversals").addEventListener("click",()=>{state.ui.universalsCollapsed=!state.ui.universalsCollapsed;save()});
$("btnToggleRegistry").addEventListener("click",()=>{state.ui.registryCollapsed=!state.ui.registryCollapsed;save()});
$("btnToggleActive").addEventListener("click",()=>{state.ui.activeCollapsed=!state.ui.activeCollapsed;save()});
$("btnToggleSets").addEventListener("click",()=>{state.ui.setsCollapsed=!state.ui.setsCollapsed;save()});
$("btnToggleBulk").addEventListener("click",()=>{state.ui.bulkCollapsed=!state.ui.bulkCollapsed;save()});
$("btnTogglePresets").addEventListener("click",()=>{state.ui.presetsCollapsed=!state.ui.presetsCollapsed;save()});
$("btnSaveRoom").addEventListener("click",()=>{const room=canon($("roomInput").value||"LINK");const url=String($("roomUrlInput").value||"").trim();const idx=state.payload.roomPresets.findIndex(r=>canon(r.room)===room);if(idx>=0)state.payload.roomPresets[idx].roomUrl=url;else state.payload.roomPresets.push({room,roomUrl:url,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()});toast("SAVED");save()});
$("btnSetActiveRoom").addEventListener("click",()=>{const room=canon($("roomInput").value||"BASE");const url=$("roomUrlInput").value||"";const idx=state.payload.roomPresets.findIndex(r=>canon(r.room)===room);if(idx>=0)state.payload.roomPresets[idx].roomUrl=url;else state.payload.roomPresets.push({room,roomUrl:url,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()});state.room=room;state.roomUrl=url;toast("ACTIVE SET");save()});
$("btnCreateSet").addEventListener("click",()=>{const label=canon($("setNameInput").value||"SET")||"SET";const id=`SET_${uid()}`;state.payload.sets.unshift({id,label,items:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()});toast("SET CREATED");save()});
$("btnGoActive").addEventListener("click",()=>{if(state.roomUrl){try{localStorage.setItem(LS,JSON.stringify(state))}catch(e){}window.location.href=state.roomUrl}else toast("NO URL")});
$("armedGo").addEventListener("click",()=>{if(state.roomUrl){try{localStorage.setItem(LS,JSON.stringify(state))}catch(e){}window.location.href=state.roomUrl}else toast("NO URL")});

window.addEventListener("keydown",ev=>{if(ev.repeat)return;const typing=document.activeElement&&(document.activeElement.tagName==="TEXTAREA"||document.activeElement.tagName==="INPUT");if(ev.code==="Space"&&!typing){ev.preventDefault();if(state.ui.blackout)return;if(state.ui.lightRunning)stopLight();else startLight(state.ui.lightPreset||1)}if(ev.shiftKey&&(ev.key==="I"||ev.key==="i")&&!typing){ev.preventDefault();state.ui.invert=!state.ui.invert;save()}if(ev.shiftKey&&(ev.key==="N"||ev.key==="n")&&!typing){ev.preventDefault();state.ui.blackout=!state.ui.blackout;save()}if(ev.shiftKey&&(ev.key==="F"||ev.key==="f")&&!typing){ev.preventDefault();state.ui.fullscreen=!state.ui.fullscreen;save()}if(ev.shiftKey&&(ev.key==="K"||ev.key==="k")&&!typing){ev.preventDefault();try{localStorage.setItem(LS,JSON.stringify(state))}catch(e){}window.location.href=URLS.LANDING}},{passive:false});

root.style.setProperty("--drawer-h",String(state.ui.drawerH));
render();
if(state.ui.lightRunning&&!state.ui.blackout)startLight(state.ui.lightPreset||1);
console.log("SYSTEM6 PATTERN: PINNED PANEL + ACTIVE STRIP COMPLETE");
</script>

<!--
SYSTEM6/SYSTEM8 PATTERN + COMPLETE PINNED PANEL
- renderPinnedPanel() shows pinned rooms + pinned sets
- renderActiveStrip() shows active sets + PAD button
- Both hide on blackout/fullscreen
- All mutations call save()
-->
</body>
</html>
