<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KETADATA // MANIFESTO</title>
<style>
  :root{
    --bg:#000; --fg:#fff; --muted:rgba(255,255,255,0.62);
    --line:rgba(255,255,255,0.14);
    --line2:rgba(255,255,255,0.26);
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    --sans: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    --top:44px; --bot:34px;
    --radius:0px;
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0}
  body{background:var(--bg); color:var(--fg); font-family:var(--sans); overflow:hidden}

  #root{position:fixed; inset:0; background:#000}
  #root.invert{filter:invert(1)}
  #root.null .topbar,
  #root.null .bottombar,
  #root.null .drawer,
  #root.null .ketaNote,
  #root.null .toast{display:none!important}

  /* STAGE */
  #stage{position:absolute; inset:0; background:#000}
  #scan{
    position:absolute; inset:-20%;
    background:
      repeating-linear-gradient(
        135deg,
        rgba(255,255,255,0.08) 0px,
        rgba(255,255,255,0.08) 1px,
        rgba(0,0,0,0) 14px,
        rgba(0,0,0,0) 28px
      );
    opacity:0.00;
    pointer-events:none;
    mix-blend-mode:screen;
    transform:translate3d(0,0,0);
  }
  #scan.run{opacity:0.12; animation: drift 2.2s linear infinite}
  @keyframes drift{0%{transform:translate3d(-80px,70px,0)}100%{transform:translate3d(80px,-70px,0)}}

  /* BARS */
  .topbar{
    position:absolute; top:0; left:0; right:0; height:var(--top);
    display:flex; align-items:center; justify-content:space-between;
    padding:0 10px;
    border-bottom:1px solid var(--line);
    background:linear-gradient(180deg,#080808,#000);
    z-index:10;
  }
  .brand{display:flex; align-items:center; gap:10px; font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase}
  .sq{width:10px; height:10px; border:1px solid var(--fg); background:#000}
  .actions{display:flex; align-items:center; gap:8px; font-family:var(--mono); font-size:12px}
  .btn{
    background:transparent; color:var(--fg);
    border:1px solid var(--line2);
    padding:6px 10px;
    font-family:var(--mono);
    font-size:12px;
    letter-spacing:.08em;
    text-transform:uppercase;
    cursor:pointer;
    border-radius:var(--radius);
  }
  .btn:hover{border-color:rgba(255,255,255,0.65)}
  .btn:active{transform:translateY(1px)}
  .kbd{border:1px solid var(--line2); padding:2px 6px; color:rgba(255,255,255,0.55); font-size:11px}

  .bottombar{
    position:absolute; left:0; right:0; bottom:0; height:var(--bot);
    display:flex; align-items:center; justify-content:space-between;
    padding:0 10px;
    border-top:1px solid var(--line);
    background:linear-gradient(0deg,#080808,#000);
    z-index:10;
    font-family:var(--mono); font-size:11px; color:rgba(255,255,255,0.62);
  }
  .toggle{
    border:1px solid var(--line2);
    background:transparent; color:var(--fg);
    padding:4px 8px;
    font-family:var(--mono);
    font-size:11px;
    letter-spacing:.08em;
    text-transform:uppercase;
    cursor:pointer;
    border-radius:var(--radius);
  }
  .toggle:hover{border-color:rgba(255,255,255,0.65)}

  /* DRAWER */
  .drawer{
    position:absolute; left:0; right:0; bottom:var(--bot);
    height:72%; min-height:420px;
    border-top:1px solid var(--line);
    background:linear-gradient(180deg,#070707,#000);
    display:none;
    z-index:20;
  }
  .drawer.open{display:flex; flex-direction:column}
  .drawerHead{
    padding:8px 10px;
    border-bottom:1px solid var(--line);
    font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase;
    display:flex; justify-content:space-between; align-items:center;
  }
  .drawerBody{
    padding:10px;
    min-height:0; flex:1; overflow:auto;
  }

  /* CONTENT */
  .layout{
    display:grid;
    grid-template-columns: 1fr 420px;
    gap:10px;
    align-items:start;
  }
  @media (max-width: 980px){
    .layout{grid-template-columns: 1fr}
  }
  .panel{
    border:1px solid var(--line2);
    background:rgba(0,0,0,0.55);
    border-radius:var(--radius);
    overflow:hidden;
  }
  .panelHead{
    padding:10px;
    border-bottom:1px solid var(--line);
    display:flex; justify-content:space-between; align-items:center; gap:10px;
    font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase;
  }
  .panelBody{padding:10px}

  .section{border-top:1px solid var(--line); padding-top:10px; margin-top:10px}
  .h1{
    font-family:var(--mono);
    font-size:12px;
    letter-spacing:.12em;
    text-transform:uppercase;
    color:rgba(255,255,255,0.85);
    margin:0 0 8px 0;
  }
  .p{
    font-family:var(--mono);
    font-size:12px;
    line-height:1.55;
    letter-spacing:.02em;
    color:rgba(255,255,255,0.78);
    margin:0 0 8px 0;
  }
  .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
  @media (max-width: 980px){ .grid2{grid-template-columns:1fr} }

  .list{display:flex; flex-direction:column; gap:6px}
  .li{
    border:1px solid rgba(255,255,255,0.18);
    background:rgba(0,0,0,0.65);
    padding:10px;
    border-radius:var(--radius);
    font-family:var(--mono);
    font-size:12px;
    letter-spacing:.06em;
    text-transform:uppercase;
  }
  .li .sub{
    margin-top:6px;
    font-size:11px;
    text-transform:none;
    letter-spacing:.02em;
    color:rgba(255,255,255,0.62);
  }

  .ref{
    border:1px solid rgba(255,255,255,0.18);
    background:rgba(0,0,0,0.65);
    padding:10px;
    border-radius:var(--radius);
    font-family:var(--mono);
    font-size:12px;
    letter-spacing:.06em;
  }
  .ref .meta{
    margin-top:6px;
    font-size:11px;
    letter-spacing:.02em;
    color:rgba(255,255,255,0.62);
    text-transform:none;
  }

  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  label{
    font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase;
    color:rgba(255,255,255,0.62);
  }
  input, select{
    background:#000; color:#fff;
    border:1px solid var(--line2);
    padding:8px 10px;
    font-family:var(--mono);
    font-size:12px;
    outline:none;
    border-radius:var(--radius);
  }
  input::placeholder{color:rgba(255,255,255,0.35)}
  .grow{flex:1}
  .mini2{width:160px}

  /* NOTE ICON + NOTE */
  .ketaIcon{
    width:16px; height:16px;
    border:2px solid #fff;
    background:#fff;
    cursor:pointer;
  }
  .ketaIcon.open{background:#000}

  .ketaNote{
    position:absolute;
    top:60px; right:16px;
    width:360px; height:240px;
    display:none;
    z-index:30;
    resize:both; overflow:hidden;
    border:1px solid rgba(255,255,255,0.78);
    background:rgba(0,0,0,0.78);
    backdrop-filter: blur(6px);
    border-radius:var(--radius);
  }
  .ketaNote.open{display:flex; flex-direction:column}
  .ketaHead{
    padding:8px 10px;
    border-bottom:1px solid rgba(255,255,255,0.14);
    font-family:var(--mono); font-size:11px;
    letter-spacing:.14em; text-transform:uppercase;
    display:flex; justify-content:space-between; align-items:center;
    cursor:move;
    gap:10px;
  }
  .ketaHead .sink{
    display:flex; gap:6px; align-items:center; flex-wrap:wrap;
    color:rgba(255,255,255,0.7);
    font-size:10px;
    letter-spacing:.12em;
  }
  .ketaBody{padding:10px; min-height:0; flex:1}
  .ketaNote textarea{
    width:100%; height:100%;
    background:#000; color:#fff;
    border:1px solid rgba(255,255,255,0.22);
    padding:10px;
    font-family:var(--mono);
    font-size:12px;
    outline:none;
    resize:none;
    border-radius:var(--radius);
  }
  .headBtn{
    background:transparent; color:#fff;
    border:1px solid rgba(255,255,255,0.18);
    padding:2px 8px;
    font-family:var(--mono);
    font-size:12px;
    letter-spacing:.08em;
    text-transform:uppercase;
    cursor:pointer;
    border-radius:var(--radius);
  }
  .headBtn:hover{border-color:rgba(255,255,255,0.6)}

  /* TOAST */
  .toast{
    position:absolute; left:12px; top:calc(var(--top) + 12px);
    padding:8px 10px;
    border:1px solid var(--line2);
    background:rgba(8,8,8,0.82);
    font-family:var(--mono); font-size:11px; letter-spacing:.06em;
    color:#fff;
    display:none; z-index:40;
    border-radius:var(--radius);
  }

  /* NULL hint (visible only in NULL) */
  .nullHint{
    position:absolute; inset:0;
    display:none;
    align-items:center; justify-content:center;
    font-family:var(--mono);
    font-size:12px;
    letter-spacing:.12em;
    text-transform:uppercase;
    color:rgba(255,255,255,0.72);
    pointer-events:none;
    z-index:6;
  }
  #root.null .nullHint{display:flex}
</style>
</head>

<body>
<div id="root">
  <div id="stage"></div>
  <div id="scan" aria-hidden="true"></div>
  <div class="nullHint" id="nullHint">NULL MODE • SHIFT+0 TO EXIT</div>
  <div class="toast" id="toast"></div>

  <div class="topbar">
    <div class="brand">
      <span class="sq"></span>
      <span>KETADATA // MANIFESTO</span>
      <span style="color:rgba(255,255,255,0.55); letter-spacing:.02em; text-transform:none" id="sig">∅</span>
    </div>

    <div class="actions">
      <button class="btn" id="btnExport">EXPORT</button>
      <button class="btn" id="btnCopy">COPY</button>
      <button class="btn" id="btnImport">IMPORT</button>

      <span class="kbd" title="Invert">Shift+I</span>
      <span class="kbd" title="Null">Shift+0</span>

      <button class="btn" id="btnNull" title="NULL (SHIFT+0)">NULL</button>
      <div class="ketaIcon" id="ketaIcon" title="KETA_NOTE"></div>
    </div>
  </div>

  <div class="drawer" id="drawer">
    <div class="drawerHead">
      <div>MANIFESTO / OPERATOR</div>
      <div style="display:flex; gap:8px; align-items:center">
        <button class="btn" id="btnCloseDrawer">CLOSE</button>
      </div>
    </div>

    <div class="drawerBody">
      <div class="layout">
        <!-- MAIN -->
        <div class="panel">
          <div class="panelHead">
            <div>THESIS</div>
            <div class="row">
              <label>MODE</label>
              <select id="mode" class="mini2">
                <option value="technical">TECHNICAL</option>
                <option value="compact">COMPACT</option>
              </select>
              <label>FILTER</label>
              <input id="filter" class="grow" placeholder="TEXT MATCH" />
            </div>
          </div>

          <div class="panelBody">
            <div class="section" style="border-top:none; padding-top:0; margin-top:0">
              <div class="h1">DEFINITION</div>
              <div class="p" data-k="definition">
                KETADATA IS A WEB-NATIVE OPERATING PROTOCOL COMPOSED OF SOVEREIGN, SINGLE-FILE INTERFACE MODULES.
                IT TREATS STATE AS THE PRIMARY ARTIFACT AND ENFORCES PORTABILITY VIA IMPORT/EXPORT.
              </div>
            </div>

            <div class="section">
              <div class="h1">NON-NEGOTIABLES</div>
              <div class="list" id="nonneg"></div>
            </div>

            <div class="section">
              <div class="h1">OPERATION</div>
              <div class="list" id="ops"></div>
            </div>

            <div class="section">
              <div class="h1">PHILOSOPHICAL / TECHNICAL PRECEDENT</div>
              <div class="grid2" id="precedent"></div>
            </div>

            <div class="section">
              <div class="h1">REFERENCES (LIST)</div>
              <div class="list" id="refs"></div>
            </div>
          </div>
        </div>

        <!-- SIDE -->
        <div class="panel">
          <div class="panelHead">
            <div>CONTROL</div>
            <div class="row">
              <label>MOTION</label>
              <button class="btn" id="btnMotion">TOGGLE</button>
            </div>
          </div>

          <div class="panelBody">
            <div class="section" style="border-top:none; padding-top:0; margin-top:0">
              <div class="h1">UNIVERSALS</div>
              <div class="p">
                SHIFT+I INVERT • SHIFT+0 NULL • ESC CLOSE • EXPORT/COPY/IMPORT JSON
              </div>
            </div>

            <div class="section">
              <div class="h1">KETA_NOTE (DIRECTED)</div>
              <div class="p">
                NOTES ARE NOT CENTRALIZED. WRITE TARGETS ARE DIRECTED AND CONTINGENT.
              </div>

              <div class="row" style="margin-top:8px">
                <label>WRITE TO</label>
                <select id="noteSink" class="mini2">
                  <option value="STATE">STATE</option>
                  <option value="ROOM">ROOM</option>
                  <option value="OBJECT">OBJECT</option>
                </select>
                <input id="noteObj" class="grow" placeholder="OBJECT_ID (ONLY IF OBJECT)" />
                <button class="btn" id="btnApplySink">APPLY</button>
              </div>

              <div class="p" style="margin-top:10px; color:rgba(255,255,255,0.62)">
                THIS DOCUMENT IS A SURFACE. ITS EXPORT IS A PORTABLE COMPOUND. ITS NOTE IS A TRACE.
              </div>
            </div>

            <div class="section">
              <div class="h1">EXPORT NAME</div>
              <div class="row">
                <input id="exportName" class="grow" placeholder="KETADATA_manifesto_state.json" />
              </div>
            </div>

            <div class="section">
              <div class="h1">CLAIM</div>
              <div class="p">
                THIS SURFACE IS A PRECEDENT: TECHNICAL PHILOSOPHICAL DECLARATIONS AS OPERABLE STATE.
                NOT BRAND COPY. NOT CONTENT. A MACHINE-READABLE POSITION.
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="bottombar">
    <div style="display:flex; gap:10px; align-items:center">
      <button class="toggle" id="toggleDrawer">SYSTEM</button>
      <span>NULL: <span id="nullLabel">OFF</span></span>
      <span>MOTION: <span id="motionLabel">OFF</span></span>
      <span>MODE: <span id="modeLabel">TECHNICAL</span></span>
    </div>
    <div style="display:flex; gap:10px; align-items:center">
      <span>ROOM: MANIFESTO</span>
      <span>v1</span>
    </div>
  </div>

  <div class="ketaNote" id="ketaNote">
    <div class="ketaHead" id="ketaHead">
      <div style="display:flex; gap:10px; align-items:center; min-width:0">
        <div style="white-space:nowrap">KETA_NOTE</div>
        <div class="sink" id="sinkLabel">WRITE→STATE</div>
      </div>
      <button class="headBtn" id="btnHideNote">-</button>
    </div>
    <div class="ketaBody">
      <textarea id="ketaText" placeholder="DIRECTED NOTE (NO GLOBAL)"></textarea>
    </div>
  </div>

  <input id="file" type="file" accept="application/json" style="display:none" />
</div>

<script>
/* =========================================================
KETADATA // MANIFESTO (DISPLAY-SAFE BOOT)
- FIX: VISIBLE ON FIRST LOAD (NULL OFF, DRAWER OPEN)
- FIX: SHIFT+0 WORKS ON ALL KEYBOARDS (Digit0 / ) fallback)
- FIX: NO DUPLICATE FUNCTION COLLISIONS
========================================================= */

const FILE_ID = "KETADATA_MANIFESTO";
const ROOM_ID = "MANIFESTO";
const VERSION_ID = "manifesto.v1";
const STORAGE_KEY = `KDT::STATE::${FILE_ID}::${ROOM_ID}::${VERSION_ID}`;

const DEFAULT = {
  version: "KETADATA_SHELL_KERNEL_v1",
  updatedAt: new Date().toISOString(),
  room: ROOM_ID,

  ui: {
    invert: false,
    nullMode: false,      // DISPLAY-SAFE
    drawerOpen: true,     // DISPLAY-SAFE
    motionOn: false,
    mode: "technical"
  },

  noteRouting: {
    sink: "STATE",
    objectId: null
  },

  ketaNote: "",
  ketaNoteMeta: {
    version: "KETA_NOTE_META_v1",
    noteId: "DIRECTED",
    roomId: ROOM_ID,
    stateId: null,
    sink: "STATE",
    sinkKey: null,
    objectId: null,
    categoryIds: [],
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  },

  payload: { manifesto: { nonneg: [], ops: [], precedent: [], refs: [] } }
};

const $ = (id)=>document.getElementById(id);
function nowISO(){ return new Date().toISOString(); }

/* ---------------------------
State merge/load/persist
---------------------------- */
function mergeDefault(obj){
  const out = structuredClone(DEFAULT);
  Object.assign(out, obj||{});
  out.ui = Object.assign(structuredClone(DEFAULT.ui), (obj&&obj.ui)||{});
  out.noteRouting = Object.assign(structuredClone(DEFAULT.noteRouting), (obj&&obj.noteRouting)||{});
  out.payload = Objec
