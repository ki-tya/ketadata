<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KETADATA // PROMPT GRID // LAW DOC</title>

<!-- =========================================================
AE ▸ AESTHETIC ▸ STARK DOC MODE (BLACK / SHARP / FOCUS)
========================================================= -->
<style>
:root{
  --bg:#000; --fg:#fff; --muted:#8a8a8a; --line:#222; --line2:#333;
  --paper:#050505;
  --invert:0;
  --top:44px;
  --bot:34px;
  --mincol:240px;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  --sans: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
}
*{box-sizing:border-box}
html,body{height:100%; margin:0}
body{
  background:var(--bg);
  color:var(--fg);
  font-family:var(--sans);
  overflow:hidden;
  filter: invert(var(--invert));
}
button,input,textarea,select{
  font-family:var(--mono);
  background:var(--paper);
  color:var(--fg);
  border:1px solid var(--line2);
  padding:8px 10px;
  outline:none;
}
button:hover{border-color:var(--fg); cursor:pointer}
button:active{transform:translateY(1px)}
textarea{resize:vertical; min-height:80px; line-height:1.35; font-size:12px}
input{height:34px; font-size:12px}
small, .muted{color:var(--muted); font-family:var(--mono); font-size:11px}

.topbar{
  height:var(--top);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 10px;
  border-bottom:1px solid var(--line);
  background:linear-gradient(180deg,#070707,#000);
  user-select:none;
}
.brand{
  display:flex; align-items:center; gap:10px;
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.08em;
  text-transform:uppercase;
}
.brand .sq{
  width:10px; height:10px;
  border:1px solid var(--fg);
  background:var(--bg);
}
.actions{display:flex; gap:8px; align-items:center}
.btn{
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:.06em;
}
.keta-icon{
  width:14px; height:14px;
  border:2px solid var(--fg);
  background:var(--fg); /* filled when collapsed */
  cursor:pointer;
}
.keta-icon.open{background:var(--bg)} /* black inside when open */

.shell{
  height:calc(100% - var(--top) - var(--bot));
  display:flex;
  width:100%;
}
.col{
  height:100%;
  min-width:var(--mincol);
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
.col.left{width:26%}
.col.center{flex:1; min-width:520px; border-left:1px solid var(--line); border-right:1px solid var(--line)}
.col.right{width:26%}
.resizer{
  width:6px; cursor:col-resize;
  background:linear-gradient(90deg,transparent,#0d0d0d,transparent);
}

.panel{
  border-bottom:1px solid var(--line);
  min-height:0;
  display:flex;
  flex-direction:column;
}
.panel-head{
  padding:8px 10px;
  border-bottom:1px solid var(--line);
  background:linear-gradient(180deg,#060606,#000);
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.06em;
  text-transform:uppercase;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.panel-body{
  padding:10px;
  overflow:auto;
  min-height:0;
}

.centerWrap{
  padding:12px;
  overflow:auto;
  min-height:0;
  background:
    radial-gradient(900px 420px at 50% 0%, rgba(255,255,255,.06), transparent 65%),
    #000;
}
.grid{
  display:grid;
  grid-template-columns: repeat(2, minmax(260px, 1fr));
  gap:12px;
  align-items:start;
}
@media(max-width:1100px){ .grid{grid-template-columns:1fr} }

.card{
  border:1px solid var(--line2);
  background:linear-gradient(180deg,#060606,#000);
  min-height:220px;
  display:flex;
  flex-direction:column;
}
.card-head{
  padding:8px 10px;
  border-bottom:1px solid var(--line);
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.06em;
  text-transform:uppercase;
  display:flex;
  justify-content:space-between;
  align-items:center;
  user-select:none;
  cursor:move;
}
.card-head .meta{color:var(--muted); text-transform:none; letter-spacing:.02em; font-size:11px}
.card-body{padding:10px; min-height:0; flex:1; overflow:auto}
.card.collapsed .card-body{display:none}
.iconbtn{
  width:28px; height:24px;
  border:1px solid var(--line2);
  background:transparent;
  color:var(--fg);
  cursor:pointer;
  font-family:var(--mono);
}
.iconbtn:hover{border-color:var(--fg)}
.row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
.hr{height:1px; background:var(--line); margin:10px 0}

.list{display:flex; flex-direction:column; gap:10px}
.item{
  border:1px solid var(--line);
  background:#030303;
  padding:8px 10px;
}
.item:hover{border-color:var(--line2)}
.itemTop{
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:flex-start;
}
.itemName{
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.02em;
  word-break:break-word;
}
.itemNote{margin-top:8px; display:none}
.item.open .itemNote{display:block}

.pill{
  border:1px solid var(--line2);
  padding:3px 6px;
  font-family:var(--mono);
  font-size:11px;
  color:var(--muted);
  background:#050505;
  white-space:nowrap;
}

.bottombar{
  height:var(--bot);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 10px;
  border-top:1px solid var(--line);
  background:linear-gradient(0deg,#070707,#000);
  font-family:var(--mono);
  font-size:11px;
  color:var(--muted);
  user-select:none;
}
.toggle{
  border:1px solid var(--line2);
  background:transparent;
  color:var(--fg);
  padding:4px 8px;
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.06em;
  text-transform:uppercase;
  cursor:pointer;
}
.toggle:hover{border-color:var(--fg)}

.drawer{
  position:fixed;
  left:0; right:0;
  bottom:var(--bot);
  height:38%;
  min-height:220px;
  border-top:1px solid var(--line);
  background:linear-gradient(180deg,#060606,#000);
  display:none;
  z-index:20;
}
.drawer.open{display:flex; flex-direction:column}
.drawer .panel-body{padding:10px}

.ketaNote{
  position:fixed;
  top:60px; left:16px;
  width:360px; height:240px;
  border:1px solid var(--line2);
  background:linear-gradient(180deg,#070707,#000);
  display:none;
  z-index:30;
  resize:both;
  overflow:hidden;
}
.ketaNote.open{display:flex; flex-direction:column}
.ketaNote .nh{
  padding:8px 10px;
  border-bottom:1px solid var(--line);
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.06em;
  text-transform:uppercase;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:move;
}
.ketaNote .nb{padding:10px; min-height:0; flex:1}
.ketaNote textarea{
  background:#fff; color:#000; border:1px solid #000;
  width:100%; height:100%;
  resize:none;
}

.codebox{
  white-space:pre-wrap;
  border:1px solid var(--line2);
  background:#050505;
  padding:10px;
  font-family:var(--mono);
  font-size:12px;
  min-height:140px;
  line-height:1.35;
}

</style>
</head>

<body>
  <!-- =========================================================
  WB ▸ TOP BAR ▸ STATE IO + KETA NOTE ICON
  ========================================================= -->
  <div class="topbar">
    <div class="brand">
      <span class="sq"></span>
      <span>KETADATA // PROMPT GRID</span>
      <span class="muted">LAW DOC MODE</span>
    </div>
    <div class="actions">
      <div id="ketaIcon" class="keta-icon" title="KETA NOTE"></div>
      <button class="btn" id="btnImport">IMPORT</button>
      <button class="btn" id="btnExport">EXPORT</button>
      <button class="btn" id="btnCopy">COPY</button>
      <button class="btn" id="btnNew">NEW CARD</button>
      <button class="btn" id="btnReset">RESET</button>
      <small class="muted">Shift+I invert</small>
    </div>
  </div>

  <div class="shell">
    <!-- LEFT: PROCESS INPUTS / LINK LIST -->
    <div class="col left">
      <div class="panel" style="flex:1.1">
        <div class="panel-head">
          <div>PROCESS</div>
          <div class="muted">quick footing</div>
        </div>
        <div class="panel-body">
          <small>
            This page is for: complex task → painless execution.
            <br><br>
            Card = “thing” in the process.
            Each card has its own note module + prompt generator.
          </small>
          <div class="hr"></div>
          <div class="row">
            <button class="btn" id="btnSeed">SEED TEMPLATE</button>
            <button class="btn" id="btnCollapseAll">COLLAPSE ALL</button>
            <button class="btn" id="btnOpenAll">OPEN ALL</button>
          </div>
          <div class="hr"></div>
          <small class="muted">Optional: paste links / artifacts (one per line). Used as raw inputs for prompts.</small>
          <textarea id="rawInputs" placeholder="PASTE LINKS / FILE PATHS / NOTES HERE"></textarea>
        </div>
      </div>

      <div class="panel" style="flex:.9">
        <div class="panel-head">
          <div>INDEX</div>
          <div class="muted"><span id="countCards">0</span> cards</div>
        </div>
        <div class="panel-body" id="indexList"></div>
      </div>
    </div>

    <div class="resizer" id="resizerL"></div>

    <!-- CENTER: PROMPT GRID -->
    <div class="col center">
      <div class="centerWrap">
        <div class="grid" id="grid"></div>
      </div>
    </div>

    <div class="resizer" id="resizerR"></div>

    <!-- RIGHT: PROMPT OUTPUT / FINAL COMPILE -->
    <div class="col right">
      <div class="panel" style="flex:1.1">
        <div class="panel-head">
          <div>COMPILE</div>
          <div class="muted">prompt bundle</div>
        </div>
        <div class="panel-body">
          <small>Generated bundle of prompts (all cards), ready to copy.</small>
          <div class="hr"></div>
          <div class="row">
            <button class="btn" id="btnRefreshCompile">REFRESH</button>
            <button class="btn" id="btnCopyCompile">COPY BUNDLE</button>
          </div>
          <div class="hr"></div>
          <div class="codebox" id="compileBox"></div>
        </div>
      </div>

      <div class="panel" style="flex:.9">
        <div class="panel-head">
          <div>SELECTED</div>
          <div class="muted">edit</div>
        </div>
        <div class="panel-body">
          <small>Click a card or index item to select it here.</small>
          <div class="hr"></div>
          <div class="row">
            <span class="pill" id="selId">∅</span>
            <button class="btn" id="selDelete">DELETE</button>
            <button class="btn" id="selToTop">PIN TOP</button>
          </div>
          <div class="hr"></div>
          <small class="muted">Title</small>
          <input id="selTitle" type="text" placeholder="CARD TITLE"/>
          <div class="hr"></div>
          <small class="muted">Note (per card)</small>
          <textarea id="selNote" placeholder="CARD NOTE"></textarea>
          <div class="hr"></div>
          <small class="muted">Prompt template (per card)</small>
          <textarea id="selPrompt" placeholder="PROMPT TEMPLATE"></textarea>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="selSave">SAVE</button>
            <button class="btn" id="selCopyPrompt">COPY CARD PROMPT</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SYSTEM UNIVERSALS DRAWER -->
  <div class="drawer" id="drawer">
    <div class="panel-head">
      <div>SYSTEM UNIVERSALS</div>
      <div class="muted">laws / constraints / refs</div>
    </div>
    <div class="panel-body">
      <textarea id="universals" placeholder="SYSTEM LAWS / CONSTRAINTS / REFERENCES"></textarea>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btnCopyUniversals">COPY</button>
      </div>
    </div>
  </div>

  <div class="bottombar">
    <div class="row">
      <button class="toggle" id="toggleDrawer">SYSTEM</button>
      <span>STATE: <span id="sig">∅</span></span>
    </div>
    <div class="row">
      <span>Shift+I invert</span>
      <span class="muted">drag headers reorder cards</span>
    </div>
  </div>

  <!-- KETA NOTE -->
  <div class="ketaNote" id="ketaNote">
    <div class="nh" id="ketaHead">
      <span>KETA NOTE</span>
      <button class="iconbtn" id="ketaClose">×</button>
    </div>
    <div class="nb">
      <textarea id="ketaText" placeholder="WHITE NOTE. GLOBAL PAGE NOTE."></textarea>
    </div>
  </div>

  <input id="file" type="file" accept="application/json" style="display:none"/>

<script>
/* =========================================================
EE ▸ ENGINE ▸ STATE + PROMPT GENERATION (no UI styling here)
========================================================= */

const DEFAULT = {
  version: "ketadata-prompt-grid-v1",
  updatedAt: new Date().toISOString(),
  ui: { invert:false, split:{left:26,right:26}, collapsed:{} },
  universals: "",
  ketaNote: "",
  rawInputs: "",
  cards: [
    // {id, title, note, promptTemplate}
  ]
};

let STATE = loadLocal() || structuredClone(DEFAULT);
let selectedId = null;

const $ = (id)=>document.getElementById(id);

function nowISO(){ return new Date().toISOString(); }
function clamp(n,a,b){ n=+n; return Math.max(a, Math.min(b, isFinite(n)?n:a)); }

function sig(){
  const core = JSON.stringify({
    c:STATE.cards.length,
    u:(STATE.universals||"").length,
    k:(STATE.ketaNote||"").length,
    r:(STATE.rawInputs||"").length
  });
  let h=2166136261;
  for(let i=0;i<core.length;i++){ h^=core.charCodeAt(i); h=Math.imul(h,16777619); }
  return (h>>>0).toString(16).slice(0,8);
}

function persist(){
  STATE.updatedAt = nowISO();
  try{ localStorage.setItem("ketadata.promptgrid.v1", JSON.stringify(STATE)); }catch(e){}
  render();
}

function loadLocal(){
  try{
    const raw = localStorage.getItem("ketadata.promptgrid.v1");
    if(!raw) return null;
    const parsed = JSON.parse(raw);
    return mergeDefault(parsed);
  }catch(e){ return null; }
}

function mergeDefault(obj){
  const out = structuredClone(DEFAULT);
  Object.assign(out, obj||{});
  out.ui = Object.assign(structuredClone(DEFAULT.ui), (obj&&obj.ui)||{});
  out.ui.split = Object.assign(structuredClone(DEFAULT.ui.split), (obj&&obj.ui&&obj.ui.split)||{});
  out.ui.collapsed = Object.assign({}, (obj&&obj.ui&&obj.ui.collapsed)||{});
  out.cards = Array.isArray(out.cards)?out.cards:[];
  return out;
}

function exportState(){
  return JSON.stringify(STATE, null, 2);
}

function importState(text){
  const parsed = JSON.parse(text);
  STATE = mergeDefault(parsed);
  selectedId = null;
  persist();
}

function newId(){
  return "C" + Math.random().toString(16).slice(2,8).toUpperCase();
}

function addCard(seed){
  const card = seed || {
    id:newId(),
    title:"UNTITLED",
    note:"",
    promptTemplate:
`SYSTEM UNIVERSALS:
{{UNIVERSALS}}

RAW INPUTS:
{{RAW_INPUTS}}

TASK OBJECT (TITLE):
{{TITLE}}

TASK NOTE:
{{NOTE}}

OUTPUT REQUIRED:
- give me the simplest path
- give me the steps
- produce a clean artifact if needed
- do not add options unless necessary`
  };
  STATE.cards.unshift(card);
  persist();
}

function deleteCard(id){
  STATE.cards = STATE.cards.filter(c=>c.id!==id);
  if(selectedId===id) selectedId=null;
  persist();
}

function updateCard(id, patch){
  const c = STATE.cards.find(x=>x.id===id);
  if(!c) return;
  Object.assign(c, patch);
  persist();
}

function cardPrompt(c){
  const tpl = c.promptTemplate || "";
  return tpl
    .replaceAll("{{UNIVERSALS}}", STATE.universals || "")
    .replaceAll("{{RAW_INPUTS}}", STATE.rawInputs || "")
    .replaceAll("{{TITLE}}", c.title || "")
    .replaceAll("{{NOTE}}", c.note || "");
}

function compileAll(){
  const parts = [];
  parts.push("KETADATA // PROMPT BUNDLE");
  parts.push("UPDATED: " + (STATE.updatedAt||""));
  parts.push("");
  if(STATE.universals){
    parts.push("SYSTEM UNIVERSALS:");
    parts.push(STATE.universals);
    parts.push("");
  }
  STATE.cards.forEach((c, i)=>{
    parts.push("—".repeat(48));
    parts.push(`# ${i+1} :: ${c.id} :: ${c.title || "UNTITLED"}`);
    parts.push(cardPrompt(c));
    parts.push("");
  });
  return parts.join("\n");
}

/* =========================================================
WB ▸ WIRING BRIDGE ▸ RENDER + INTERACTIONS
========================================================= */

function applySplit(){
  document.querySelector(".col.left").style.width = clamp(STATE.ui.split.left, 16, 45) + "%";
  document.querySelector(".col.right").style.width = clamp(STATE.ui.split.right, 16, 45) + "%";
}

function renderIndex(){
  const wrap = $("indexList");
  wrap.innerHTML = "";
  const list = document.createElement("div");
  list.className = "list";
  STATE.cards.forEach(c=>{
    const it = document.createElement("div");
    it.className = "item";
    it.innerHTML = `
      <div class="itemTop">
        <div class="itemName">${escapeHtml(c.id)} :: ${escapeHtml(c.title||"UNTITLED")}</div>
        <div class="pill">${STATE.ui.collapsed[c.id] ? "COLLAPSED" : "OPEN"}</div>
      </div>
    `;
    it.addEventListener("click", ()=>selectCard(c.id));
    list.appendChild(it);
  });
  wrap.appendChild(list);
  $("countCards").textContent = String(STATE.cards.length);
}

function renderGrid(){
  const grid = $("grid");
  grid.innerHTML = "";
  STATE.cards.forEach(c=>{
    const card = document.createElement("div");
    card.className = "card" + (STATE.ui.collapsed[c.id] ? " collapsed" : "");
    card.dataset.id = c.id;

    card.innerHTML = `
      <div class="card-head" draggable="true">
        <div>
          ${escapeHtml(c.id)} :: ${escapeHtml(c.title||"UNTITLED")}
          <span class="meta">(${(c.note||"").length}n / ${(c.promptTemplate||"").length}p)</span>
        </div>
        <div class="row">
          <button class="iconbtn" data-act="collapse" title="collapse">–</button>
          <button class="iconbtn" data-act="copy" title="copy prompt">C</button>
          <button class="iconbtn" data-act="select" title="select">S</button>
        </div>
      </div>
      <div class="card-body">
        <small class="muted">NOTE (per thing)</small>
        <textarea data-field="note" placeholder="note">${escapeText(c.note||"")}</textarea>
        <div class="hr"></div>
        <small class="muted">PROMPT TEMPLATE (per thing)</small>
        <textarea data-field="prompt" placeholder="prompt template">${escapeText(c.promptTemplate||"")}</textarea>
        <div class="hr"></div>
        <small class="muted">GENERATED PROMPT</small>
        <div class="codebox">${escapeHtml(cardPrompt(c))}</div>
      </div>
    `;

    // card interactions
    card.addEventListener("click", (e)=>{
      const act = e.target && e.target.dataset && e.target.dataset.act;
      if(act==="collapse"){
        STATE.ui.collapsed[c.id] = !STATE.ui.collapsed[c.id];
        persist(); return;
      }
      if(act==="copy"){
        navigator.clipboard.writeText(cardPrompt(c)); return;
      }
      if(act==="select"){
        selectCard(c.id); return;
      }
    });

    // live edits inside card
    card.querySelectorAll("textarea").forEach(ta=>{
      ta.addEventListener("input", ()=>{
        const field = ta.dataset.field;
        if(field==="note") updateCard(c.id, { note: ta.value });
        if(field==="prompt") updateCard(c.id, { promptTemplate: ta.value });
      });
    });

    // drag reorder
    card.querySelector(".card-head").addEventListener("dragstart", (e)=>{
      e.dataTransfer.setData("text/plain", c.id);
      e.dataTransfer.effectAllowed = "move";
    });
    card.addEventListener("dragover", (e)=>e.preventDefault());
    card.addEventListener("drop", (e)=>{
      e.preventDefault();
      const dragged = e.dataTransfer.getData("text/plain");
      if(!dragged || dragged===c.id) return;
      const order = STATE.cards.map(x=>x.id);
      const a = order.indexOf(dragged);
      const b = order.indexOf(c.id);
      if(a<0||b<0) return;
      const cardObj = STATE.cards.splice(a,1)[0];
      STATE.cards.splice(b,0,cardObj);
      persist();
    });

    card.addEventListener("dblclick", ()=>selectCard(c.id));
    grid.appendChild(card);
  });
}

function renderSelected(){
  $("selId").textContent = selectedId || "∅";
  const c = STATE.cards.find(x=>x.id===selectedId);
  $("selTitle").value = c ? (c.title||"") : "";
  $("selNote").value = c ? (c.note||"") : "";
  $("selPrompt").value = c ? (c.promptTemplate||"") : "";
}

function renderCompile(){
  $("compileBox").textContent = compileAll();
}

function render(){
  document.body.style.setProperty("--invert", STATE.ui.invert ? 1 : 0);
  applySplit();
  $("sig").textContent = sig();

  $("universals").value = STATE.universals || "";
  $("ketaText").value = STATE.ketaNote || "";
  $("rawInputs").value = STATE.rawInputs || "";

  renderIndex();
  renderGrid();
  renderSelected();
  renderCompile();
}

function selectCard(id){
  selectedId = id;
  renderSelected();
}

function collapseAll(flag){
  STATE.cards.forEach(c=> STATE.ui.collapsed[c.id] = !!flag);
  persist();
}

function seedTemplate(){
  // minimal set of cards for your “simple answers to complex tasks” process
  const seeds = [
    { title:"GOAL (1 sentence)", note:"What is the outcome? No narrative.", promptTemplate:
`SYSTEM UNIVERSALS:
{{UNIVERSALS}}

DEFINE THE GOAL:
- One sentence.
- No adjectives.
- Include the deliverable.

RAW INPUTS:
{{RAW_INPUTS}}

OUTPUT:
- Rewrite goal as a crisp spec.
- List the smallest next action.`
    },
    { title:"INPUTS (what exists)", note:"Links, files, constraints, references.", promptTemplate:
`SYSTEM UNIVERSALS:
{{UNIVERSALS}}

GOAL:
{{TITLE}}

INPUTS:
{{NOTE}}

RAW INPUTS:
{{RAW_INPUTS}}

OUTPUT:
- Extract inputs into a checklist.
- Identify missing inputs (max 3).
- Provide workaround if missing.`
    },
    { title:"FAST PATH (lowest friction)", note:"The best path. One fallback.", promptTemplate:
`SYSTEM UNIVERSALS:
{{UNIVERSALS}}

TASK:
{{TITLE}}

CONTEXT:
{{NOTE}}

OUTPUT:
- Give me the shortest reliable path.
- Give one fallback path only.
- Include verification step.`
    },
    { title:"INSTRUMENT (single-file)", note:"If a tool is needed, define it as an instrument.", promptTemplate:
`SYSTEM UNIVERSALS:
{{UNIVERSALS}}

TASK:
{{TITLE}}

REQUIREMENT:
{{NOTE}}

OUTPUT:
- Design a single-file local-first HTML instrument.
- Must include: state import/export + KETA_NOTE.
- Label code: AE / EE / WB.
- Minimal UI, focus-first.`
    }
  ];

  // add only if empty
  if(STATE.cards.length) return;
  seeds.forEach(s=>{
    addCard({
      id:newId(),
      title:s.title,
      note:s.note,
      promptTemplate:s.promptTemplate
    });
  });
}

function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}
function escapeText(s){ return (s||"").replaceAll("</textarea>","</tex"+"tarea>"); }

/* =========================================================
WB ▸ EVENTS ▸ TOP BAR / DRAWER / NOTE / STATE IO
========================================================= */

$("btnNew").addEventListener("click", ()=> addCard());
$("btnSeed").addEventListener("click", ()=> { seedTemplate(); persist(); });

$("btnCollapseAll").addEventListener("click", ()=> collapseAll(true));
$("btnOpenAll").addEventListener("click", ()=> collapseAll(false));

$("rawInputs").addEventListener("input", ()=>{ STATE.rawInputs = $("rawInputs").value; persist(); });
$("universals").addEventListener("input", ()=>{ STATE.universals = $("universals").value; persist(); });

$("btnCopyUniversals").addEventListener("click", ()=> navigator.clipboard.writeText(STATE.universals||""));

$("btnRefreshCompile").addEventListener("click", renderCompile);
$("btnCopyCompile").addEventListener("click", ()=> navigator.clipboard.writeText($("compileBox").textContent || ""));

$("selSave").addEventListener("click", ()=>{
  if(!selectedId) return;
  updateCard(selectedId, {
    title: $("selTitle").value.trim() || "UNTITLED",
    note: $("selNote").value,
    promptTemplate: $("selPrompt").value
  });
});
["selTitle","selNote","selPrompt"].forEach(id=>{
  $(id).addEventListener("input", ()=>{
    if(!selectedId) return;
    const c = STATE.cards.find(x=>x.id===selectedId);
    if(!c) return;
    c.title = $("selTitle").value;
    c.note = $("selNote").value;
    c.promptTemplate = $("selPrompt").value;
    persist();
  });
});
$("selCopyPrompt").addEventListener("click", ()=>{
  if(!selectedId) return;
  const c = STATE.cards.find(x=>x.id===selectedId);
  if(c) navigator.clipboard.writeText(cardPrompt(c));
});
$("selDelete").addEventListener("click", ()=>{
  if(!selectedId) return;
  deleteCard(selectedId);
});
$("selToTop").addEventListener("click", ()=>{
  if(!selectedId) return;
  const idx = STATE.cards.findIndex(x=>x.id===selectedId);
  if(idx<0) return;
  const obj = STATE.cards.splice(idx,1)[0];
  STATE.cards.unshift(obj);
  persist();
});

$("btnExport").addEventListener("click", ()=>{
  const blob = new Blob([exportState()], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "ketadata_prompt_grid_state.json";
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 800);
});
$("btnCopy").addEventListener("click", ()=> navigator.clipboard.writeText(exportState()));

$("btnImport").addEventListener("click", ()=> $("file").click());
$("file").addEventListener("change", async (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const txt = await f.text();
  importState(txt);
  e.target.value = "";
});

$("btnReset").addEventListener("click", ()=>{
  if(!confirm("RESET STATE (local) ?")) return;
  STATE = structuredClone(DEFAULT);
  selectedId = null;
  persist();
});

$("toggleDrawer").addEventListener("click", ()=> $("drawer").classList.toggle("open"));

// KETA NOTE icon behavior: filled when collapsed; black inside when open
function setNote(open){
  $("ketaNote").classList.toggle("open", open);
  $("ketaIcon").classList.toggle("open", open);
}
$("ketaIcon").addEventListener("click", ()=> setNote(!$("ketaNote").classList.contains("open")));
$("ketaClose").addEventListener("click", ()=> setNote(false));
$("ketaText").addEventListener("input", ()=>{ STATE.ketaNote = $("ketaText").value; persist(); });

// Shift+I invert (typing-safe)
document.addEventListener("keydown", (e)=>{
  if(e.shiftKey && e.key.toLowerCase()==="i"){
    e.preventDefault();
    STATE.ui.invert = !STATE.ui.invert;
    persist();
  }
});

// Resizers
function makeResizer(el, side){
  let startX=0, startLeft=0, startRight=0;
  const move = (ev)=>{
    const dx = ev.clientX - startX;
    const w = window.innerWidth;
    const pct = (dx / w) * 100;
    if(side==="left"){
      STATE.ui.split.left = clamp(startLeft + pct, 16, 45);
    }else{
      STATE.ui.split.right = clamp(startRight - pct, 16, 45);
    }
    applySplit();
  };
  const up = ()=>{
    window.removeEventListener("mousemove", move);
    window.removeEventListener("mouseup", up);
    persist();
  };
  el.addEventListener("mousedown", (ev)=>{
    startX = ev.clientX;
    startLeft = STATE.ui.split.left;
    startRight = STATE.ui.split.right;
    window.addEventListener("mousemove", move);
    window.addEventListener("mouseup", up);
  });
}
makeResizer($("resizerL"), "left");
makeResizer($("resizerR"), "right");

// Drag KETA NOTE
(function dragNote(){
  const box = $("ketaNote");
  const head = $("ketaHead");
  let dragging=false, ox=0, oy=0;
  head.addEventListener("mousedown", (e)=>{
    if(e.target.closest("button")) return;
    dragging=true;
    const r = box.getBoundingClientRect();
    ox = e.clientX - r.left;
    oy = e.clientY - r.top;
    box.style.left = r.left + "px";
    box.style.top = r.top + "px";
  });
  window.addEventListener("mousemove", (e)=>{
    if(!dragging) return;
    box.style.left = (e.clientX - ox) + "px";
    box.style.top  = (e.clientY - oy) + "px";
  });
  window.addEventListener("mouseup", ()=> dragging=false);
})();

/* BOOT */
render();
</script>

<!--
AE ▸ AESTHETIC: stark doc UI, black sharp, focus, invert
EE ▸ ENGINE: state, cards, prompt templates, compile, autosave, import/export
WB ▸ WIRING: events, drag, resizers, drawer, keta_note, clipboard
-->
</body>
</html>
