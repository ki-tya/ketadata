<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KETADATA_BASE_SYSTEM.html</title>

<!-- =========================================================
AE ▸ AESTHETIC LAYER
KETADATA BASE — BLACK / WHITE / GREY — SHARP / INDUSTRIAL
========================================================= -->
<style>
:root{
  --bg:#000; --fg:#fff; --muted:#8a8a8a; --line:#222; --line2:#333;
  --top:44px; --bot:34px;

  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  --sans: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

  --ctl-radius:0px;
  --ctl-alpha:0.82;
  --ctl-bg: rgba(0,0,0,var(--ctl-alpha));
  --note-border: rgba(255,255,255,0.78);
  --drawer-h: 0.42;
}
*{box-sizing:border-box}
html,body{height:100%; margin:0}
body{background:var(--bg); color:var(--fg); font-family:var(--sans); overflow:hidden; user-select:none}
#root{position:fixed; inset:0; background:#000}
#root.invert{filter:invert(1)}

/* FULLSCREEN: hides panels, keeps visuals alive */
#root.fs .topbar,
#root.fs .bottombar,
#root.fs .drawer,
#root.fs #pinnedPanel,
#root.fs #armedBar,
#root.fs .toast{display:none !important}

/* BLACKOUT: hard black screen, kills visuals + panels */
#root.blackout .topbar,
#root.blackout .bottombar,
#root.blackout .drawer,
#root.blackout #pinnedPanel,
#root.blackout #armedBar,
#root.blackout .toast,
#root.blackout .ketaNote{display:none !important}
#root.blackout #stage{background:#000 !important; filter:none !important}
#root.blackout #motion{display:none !important}

/* Stage */
#stage{position:absolute; inset:0; background:#000; pointer-events:none}
#motion{
  position:absolute; inset:0; pointer-events:none; opacity:0;
  background:repeating-linear-gradient(135deg, rgba(255,255,255,0.06) 0px, rgba(255,255,255,0.06) 1px, rgba(0,0,0,0) 12px, rgba(0,0,0,0) 22px);
  mix-blend-mode:screen;
  transform:translate3d(0,0,0);
}
#motion.run{opacity:0.12; animation:scanflow 2.2s linear infinite}
@keyframes scanflow{0%{transform:translate3d(-80px,60px,0)}100%{transform:translate3d(80px,-60px,0)}}

/* Top bar */
.topbar{
  position:absolute; top:0; left:0; right:0; height:var(--top);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 10px; border-bottom:1px solid var(--line);
  background:linear-gradient(180deg,#070707,#000);
  z-index:10;
}
.brand{display:flex; align-items:center; gap:10px; font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase}
.brand .sq{width:10px; height:10px; border:1px solid var(--fg); background:#000}
.roomBadge{display:flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted); border:1px solid var(--line2); padding:4px 8px}
.actions{display:flex; align-items:center; gap:8px; font-family:var(--mono); font-size:12px}
.btn{
  background:transparent; color:var(--fg);
  border:1px solid var(--line2);
  padding:6px 10px;
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.08em;
  text-transform:uppercase;
  cursor:pointer;
}
.btn:hover{border-color:var(--fg)}
.btn:active{transform:translateY(1px)}
.kbd{border:1px solid var(--line2); padding:2px 6px; color:var(--muted); font-size:11px}
.ketaIcon{
  width:16px; height:16px;
  border:2px solid var(--fg);
  background:var(--fg);
  cursor:pointer;
}
.ketaIcon.open{background:#000}

/* Bottom bar */
.bottombar{
  position:absolute; left:0; right:0; bottom:0; height:var(--bot);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 10px; border-top:1px solid var(--line);
  background:linear-gradient(0deg,#070707,#000);
  z-index:10;
  font-family:var(--mono); font-size:11px; color:var(--muted);
}
.toggle{
  border:1px solid var(--line2);
  background:transparent;
  color:var(--fg);
  padding:4px 8px;
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
  cursor:pointer;
}
.toggle:hover{border-color:var(--fg)}

/* Drawer (System panel) */
.drawer{
  position:absolute; left:0; right:0;
  bottom:var(--bot);
  height:calc((100vh - var(--top) - var(--bot)) * var(--drawer-h));
  min-height:200px;
  border-top:1px solid var(--line);
  background:linear-gradient(180deg,#060606,#000);
  display:none;
  z-index:20;
}
.drawer.open{display:flex; flex-direction:column}
.drawerSizer{
  height:10px;
  cursor:ns-resize;
  border-bottom:1px solid var(--line);
  background:linear-gradient(180deg,#0a0a0a,#050505);
}
.drawerHead{
  padding:8px 10px;
  border-bottom:1px solid var(--line);
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.10em;
  text-transform:uppercase;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.drawerBody{padding:10px; min-height:0; flex:1; overflow:auto}
textarea{
  width:100%;
  border:1px solid var(--line2);
  background:#050505;
  color:var(--fg);
  font-family:var(--mono);
  font-size:12px;
  padding:10px;
  line-height:1.35;
  outline:none;
  resize:vertical;
  min-height:140px;
}
input{outline:none}

/* KETA NOTE (global, movable/resizable) */
.ketaNote{
  position:absolute; top:76px; right:16px; left:auto;
  width:340px; height:220px;
  display:none;
  z-index:30;
  resize:both;
  overflow:hidden;
  border-radius:var(--ctl-radius);
  background:var(--ctl-bg);
  border:1px solid var(--note-border);
  backdrop-filter:blur(6px);
}
.ketaNote.open{display:flex; flex-direction:column}
.ketaHead{
  padding:8px 10px;
  border-bottom:1px solid rgba(255,255,255,0.14);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.14em;
  text-transform:uppercase;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:move;
}
.ketaBody{padding:10px; min-height:0; flex:1}
.ketaNote textarea{
  background:#000;
  color:#fff;
  border:1px solid rgba(255,255,255,0.22);
  width:100%;
  height:100%;
  resize:none;
  padding:10px;
  outline:none;
}
.headBtn{
  background:transparent;
  color:var(--fg);
  border:1px solid rgba(255,255,255,0.18);
  padding:2px 8px;
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.08em;
  text-transform:uppercase;
  cursor:pointer;
}
.headBtn:hover{border-color:rgba(255,255,255,0.6)}

/* Armed bar (new) */
#armedBar{
  position:absolute; left:10px; top:calc(var(--top) + 10px);
  z-index:27;
  display:none;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
  padding:8px 10px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,0.86);
  font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase;
}
#armedBar .label{color:var(--muted)}
#armedBar .val{color:var(--fg)}
#armedBar input{
  background:#000; color:#fff; border:1px solid var(--line2);
  padding:6px 8px; font-family:var(--mono); font-size:11px; letter-spacing:.08em;
  width:340px; max-width:calc(100vw - 40px);
}

/* Pinned panel (chips + set blocks) */
#pinnedPanel{
  position:absolute; left:10px; top:calc(var(--top) + 64px);
  z-index:26; display:none; gap:8px; flex-wrap:wrap; align-items:flex-start;
  padding:8px 10px; border:1px solid var(--line2);
  background:rgba(0,0,0,0.86);
  font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase;
}

/* Active strip (under pinned) */
#activeStrip{
  position:absolute; left:10px; top:calc(var(--top) + 122px);
  z-index:25; display:none; gap:8px; flex-wrap:wrap; align-items:center;
  padding:8px 10px; border:1px solid var(--line2);
  background:rgba(0,0,0,0.86);
  font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase;
}
#activeStrip .label{color:var(--muted)}

/* Pad (expanded set grid) */
#padPanel{
  position:absolute;
  left:14px;
  top:calc(var(--top) + 170px);
  width:360px;
  height:360px;
  display:none;
  z-index:31;
  border:1px solid rgba(255,255,255,0.22);
  border-radius:var(--ctl-radius);
  background:rgba(0,0,0,0.86);
  backdrop-filter:blur(6px);
  overflow:hidden;
  resize:both;
  min-width:340px;
  min-height:260px;
}
#padPanel.open{display:flex; flex-direction:column}
#padHead{
  padding:8px 10px;
  border-bottom:1px solid rgba(255,255,255,0.14);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.14em;
  text-transform:uppercase;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:move;
}
#padBody{padding:10px; min-height:0; flex:1; display:flex; flex-direction:column; gap:10px}
#padGrid{
  flex:1;
  display:grid;
  grid-template-columns:repeat(4, 1fr);
  grid-template-rows:repeat(4, 1fr);
  gap:8px;
  min-height:0;
}
.padCell{
  border:1px solid rgba(255,255,255,0.18);
  background:rgba(0,0,0,0.35);
  padding:8px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  gap:6px;
  min-width:0;
}
.padCell .nm{
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.padCell a{
  color:var(--fg);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.02em;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  text-decoration:none;
  border-bottom:1px solid rgba(255,255,255,0.18);
  padding-bottom:2px;
}
.padCell a:hover{border-bottom-color:rgba(255,255,255,0.55)}
.padCell input{
  width:100%;
  background:#000;
  color:#fff;
  border:1px solid rgba(255,255,255,0.22);
  padding:6px 8px;
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.06em;
  outline:none;
  min-width:0;
}

/* Toast */
.toast{
  position:absolute;
  left:12px;
  top:calc(var(--top) + 12px);
  padding:8px 10px;
  border:1px solid var(--line2);
  background:rgba(8,8,8,0.82);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.06em;
  color:var(--fg);
  display:none;
  z-index:40;
}
</style>
</head>

<body>
<div id="root">
  <div id="stage"></div>
  <div id="motion" aria-hidden="true"></div>

  <!-- ARMED BAR -->
  <div id="armedBar">
    <span class="label">ARMED</span>
    <span class="val" id="armedName">—</span>
    <button class="btn" id="armedGo" style="padding:4px 8px; font-size:11px">GO</button>
    <button class="btn" id="armedNewTab" style="padding:4px 8px; font-size:11px">NEW TAB</button>
    <button class="btn" id="armedCopy" style="padding:4px 8px; font-size:11px">COPY URL</button>
    <input id="armedUrl" readonly value="—" />
  </div>

  <div id="pinnedPanel"></div>
  
  <div id="activeStrip"></div>

  <!-- PAD (EXPANDED SETS) -->
  <div id="padPanel">
    <div id="padHead">
      <span id="padTitle">PAD</span>
      <div style="display:flex; gap:8px; align-items:center">
        <button class="headBtn" id="padEditBtn">EDIT</button>
        <button class="headBtn" id="padCloseBtn">X</button>
      </div>
    </div>
    <div id="padBody">
      <div id="padGrid"></div>
      <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; font-family:var(--mono); font-size:11px; color:var(--muted); letter-spacing:.08em; text-transform:uppercase">
        <span id="padHint">CLICK = ARM</span>
        <span id="padSetId" style="opacity:.7">—</span>
      </div>
    </div>
  </div>
<div class="toast" id="toast"></div>

  <!-- TOP BAR -->
  <div class="topbar">
    <div style="display:flex; gap:10px; align-items:center">
      <div class="brand">
        <span class="sq"></span>
        <span>KETADATA // SHELL8 // KERNEL</span>
        <span style="color:var(--muted); letter-spacing:.02em; text-transform:none">v1</span>
      </div>
      <div class="roomBadge">
        <span>ROOM</span>
        <span id="roomName">BASE</span>
      </div>
    </div>

    <div class="actions">
      <button class="btn" id="btnImport">IMPORT</button>
      <button class="btn" id="btnExport">EXPORT</button>
      <button class="btn" id="btnCopy">COPY</button>

      <span class="kbd" title="Run">Space</span>
      <span class="kbd" title="Invert">Shift+I</span>
      <span class="kbd" title="Blackout">Shift+N</span>
      <span class="kbd" title="Fullscreen">Shift+F</span>
      <span class="kbd" title="Landing">Shift+K</span>

      <div id="ketaIcon" class="ketaIcon" title="KETA_NOTE"></div>
    </div>
  </div>

  <!-- DRAWER -->
  <div class="drawer" id="drawer">
    <div class="drawerSizer" id="drawerSizer" title="DRAG"></div>

    <div class="drawerHead">
      <div>SYSTEM</div>
      <div style="display:flex; gap:8px; align-items:center">
        <span id="sig" style="color:var(--muted); font-family:var(--mono); font-size:11px">∅</span>
        <button class="btn" id="btnToggleMotion">MOTION</button>
        <button class="btn" id="btnCopyUniversals">COPY</button>
        <button class="btn" id="btnCloseDrawer">CLOSE</button>
      </div>
    </div>

    <div class="drawerBody">

      <!-- UNIVERSALS (COLLAPSIBLE) -->
      <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px">
        <div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted)">
          SYSTEM UNIVERSALS
        </div>
        <button class="btn" id="btnToggleUniversals" style="padding:4px 8px; font-size:11px">TOGGLE</button>
      </div>
      <textarea id="universals" spellcheck="false" autocomplete="off" placeholder="LAWS / REFERENCES"></textarea>

      <div style="margin-top:12px; border-top:1px solid var(--line); padding-top:10px">

        <!-- REGISTRY (COLLAPSIBLE) -->
        <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px">
          <div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted)">
            ROOM REGISTRY
          </div>
          <button class="btn" id="btnToggleRegistry" style="padding:4px 8px; font-size:11px">TOGGLE</button>
        </div>

        <div id="registryBody">
          <div style="margin-top:8px; display:flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted)">
            <span>ROOM</span>
            <input id="roomInput" spellcheck="false" autocomplete="off"
              style="flex:1; background:#000; color:#fff; border:1px solid var(--line2); padding:6px 8px; font-family:var(--mono);"
              placeholder="NAME" />
          </div>

          <div style="margin-top:8px; display:flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted)">
            <span>URL</span>
            <input id="roomUrlInput" spellcheck="false" autocomplete="off"
              style="flex:1; background:#000; color:#fff; border:1px solid var(--line2); padding:6px 8px; font-family:var(--mono);"
              placeholder="ANY LINK / PATH" />
          </div>

          <div style="margin-top:8px; display:flex; gap:8px; align-items:center">
            <button class="btn" id="btnSaveRoom">SAVE</button>
            <button class="btn" id="btnSetActiveRoom">SET ACTIVE</button>
            <button class="btn" id="btnDeleteRoom">DELETE</button>
            <button class="btn" id="btnTogglePins">PINS</button>
          </div>
        </div>

        <!-- ACTIVE (COLLAPSIBLE) -->
        <div style="margin-top:10px; border-top:1px solid var(--line); padding-top:10px">
          <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px">
            <div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted)">
              ACTIVE
            </div>
            <button class="btn" id="btnToggleActive" style="padding:4px 8px; font-size:11px">TOGGLE</button>
          </div>

          <div id="activeBody">
            <div style="display:flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted)">
              <span style="min-width:44px">ROOM</span>
              <input id="activeRoomBox" readonly
                style="flex:1; background:#000; color:#fff; border:1px solid var(--line2); padding:6px 8px; font-family:var(--mono);"
                placeholder="—" />
            </div>

            <div style="margin-top:8px; display:flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted)">
              <span style="min-width:44px">URL</span>
              <input id="activeUrlBox" readonly
                style="flex:1; background:#000; color:#fff; border:1px solid var(--line2); padding:6px 8px; font-family:var(--mono);"
                placeholder="—" />
            </div>

            <div style="margin-top:8px; display:flex; gap:8px; align-items:center">
              <button class="btn" id="btnGoActive">GO</button>
              <button class="btn" id="btnNewTabActive">NEW TAB</button>
              <button class="btn" id="btnCopyActiveUrl">COPY URL</button>
            </div>

            <div style="margin-top:8px; color:var(--muted); font-family:var(--mono); font-size:11px">
              CLICK = ARM. GO = COMMIT.
            </div>
          </div>
        </div>

        <!-- SETS (COLLAPSIBLE) -->
        <div id="setsBox" style="margin-top:10px; border-top:1px solid var(--line); padding-top:10px">
          <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px">
            <div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted)">
              SETS
            </div>
            <button class="btn" id="btnToggleSets" style="padding:4px 8px; font-size:11px">TOGGLE</button>
          </div>

          <div id="setsBody">
            <div style="margin-top:8px; display:flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted)">
              <span>SET</span>
              <input id="setNameInput" spellcheck="false" autocomplete="off"
                style="flex:1; background:#000; color:#fff; border:1px solid var(--line2); padding:6px 8px; font-family:var(--mono);"
                placeholder="NAME" />
            </div>

            <div style="margin-top:8px; display:flex; gap:8px; align-items:center">
              <button class="btn" id="btnCreateSet">CREATE</button>
              <button class="btn" id="btnRenameSet">RENAME</button>
              <button class="btn" id="btnDeleteSet">DELETE</button>
              <button class="btn" id="btnPinSet">PIN/UNPIN</button>
            </div>

            <div style="margin-top:8px; color:var(--muted); font-family:var(--mono); font-size:11px">
              SET EDITOR (BULK): ONE PER LINE: NAME | URL  OR URL
            </div>

            <textarea id="setItemsInput" spellcheck="false" autocomplete="off" style="min-height:120px; margin-top:8px"
              placeholder="ITEMS:
NAME | URL
OR URL"></textarea>

            <div style="margin-top:8px; display:flex; gap:8px; align-items:center">
              <button class="btn" id="btnSaveSetItems">SAVE ITEMS</button>
              <button class="btn" id="btnClearSetItems">CLEAR</button>
            </div>

            <div style="margin-top:10px; border-top:1px solid var(--line); padding-top:10px">
              <div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted); margin-bottom:8px">
                SET LIST
              </div>
              <div id="setList" style="display:flex; flex-direction:column; gap:6px"></div>
              <div style="margin-top:8px; color:var(--muted); font-family:var(--mono); font-size:11px">
                CLICK SET = LOAD EDITOR. CLICK ITEM = ARM.
              </div>
            </div>
          </div>
        </div>

        <!-- BULK (COLLAPSIBLE) -->
        <div style="margin-top:10px; border-top:1px solid var(--line); padding-top:10px">
          <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px">
            <div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted)">
              BULK INPUT
            </div>
            <button class="btn" id="btnToggleBulk" style="padding:4px 8px; font-size:11px">TOGGLE</button>
          </div>

          <div id="bulkBody">
            <textarea id="bulkRoomInput" spellcheck="false" autocomplete="off" style="min-height:110px"
              placeholder="ONE PER LINE:
NAME | URL
OR URL

# lines starting with # are ignored"></textarea>

            <div style="margin-top:8px; display:flex; gap:8px; align-items:center">
              <button class="btn" id="btnBulkAdd">BULK ADD</button>
              <button class="btn" id="btnBulkClear">CLEAR</button>
            </div>

            <div style="margin-top:8px; color:var(--muted); font-family:var(--mono); font-size:11px">
              NO AUTOFILL. OVERWRITE FAST.
            </div>
          </div>
        </div>

        <!-- PRESETS (COLLAPSIBLE) -->
        <div style="margin-top:10px; border-top:1px solid var(--line); padding-top:10px">
          <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px">
            <div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted)">
              PRESETS
            </div>
            <button class="btn" id="btnTogglePresets" style="padding:4px 8px; font-size:11px">TOGGLE</button>
          </div>

          <div id="presetsBody">
            <div id="roomList" style="display:flex; flex-direction:column; gap:6px"></div>
            <div style="margin-top:8px; color:var(--muted); font-family:var(--mono); font-size:11px">
              CLICK = ARM. PIN = BASE.
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- BOTTOM BAR -->
  <div class="bottombar">
    <div style="display:flex; gap:10px; align-items:center">
      <button class="toggle" id="toggleDrawer">SYSTEM</button>
      <button class="toggle" id="toggleRun">RUN</button>
      <span>STATE: <span id="sig2">∅</span></span>
      <span style="margin-left:8px">FS: <span id="fsLabel">OFF</span></span>
      <span style="margin-left:8px">BLK: <span id="blkLabel">OFF</span></span>
    </div>
    <div style="display:flex; gap:12px; align-items:center">
      <span>LIGHT: <span id="lightLabel">1</span></span>
      <span>RUN: <span id="runLabel">OFF</span></span>
      <span>MOTION: <span id="motionLabel">OFF</span></span>
    </div>
  </div>

  <!-- KETA NOTE -->
  <div class="ketaNote" id="ketaNote">
    <div class="ketaHead" id="ketaHead">
      <div>KETA_NOTE</div>
      <button class="headBtn" id="btnHideNote">-</button>
    </div>
    <div class="ketaBody">
      <textarea id="ketaText" spellcheck="false" autocomplete="off" placeholder="GLOBAL NOTE"></textarea>
    </div>
  </div>

  <input id="file" type="file" accept="application/json" style="display:none" />
</div>

<!-- =========================================================
EE ▸ ENGINE LAYER
========================================================= -->
<script>

/* =========================================================
EE ▸ CONFIG (PATHS)
========================================================= */
const URLS = {
  LANDING: "index11.html",
  PHOTOBOOTH: "crunch1.html",
  KDTV: "kdtv1.html",
  POD: "room.html",
  WORLD: "map.html",
  INFINITY: "infinity.html",
  CALENDAR: "calendar1.html",
  STUDIO: "tester3.html",
  LAB: "labyrinth.html"
};

/* =========================================================
EE ▸ STORAGE — PAGE-SCOPED (NO COLLISIONS)
========================================================= */
const FILE_ID="KETADATA_SHELL8";
const PAGE_ID="BASE_SYSTEM";
const STORAGE_EPOCH="BASE_CANON";

/* PAGE-SCOPED KEY (NO COLLISIONS ACROSS MULTIPLE BASE FILES)
   - Stable for this specific HTML file across refreshes
   - Different Base pages get different keys automatically
*/
const PAGE_KEY = (()=> {
  const raw = (location.origin + location.pathname).toUpperCase();
  // keep it short + filesystem-safe
  return raw.replace(/[^A-Z0-9]+/g,"_").replace(/^_+|_+$/g,"").slice(-64) || "BASE";
})();

function nowISO(){return new Date().toISOString();}
const $=(id)=>document.getElementById(id);

const root=$("root");
const stage=$("stage");
const motion=$("motion");

/* PAGE-SCOPED CANON KEYS */
const STORAGE_KEY_MAIN   = `KDT::BASE::STATE::${FILE_ID}::${PAGE_ID}::${PAGE_KEY}::STATE`;
const STORAGE_KEY_MAIN_OLD   = "KDT::BASE::SOVEREIGN::STATE";
const STORAGE_KEY_BACKUP = `KDT::BASE::STATE::${FILE_ID}::${PAGE_ID}::${PAGE_KEY}::STATE::BACKUP`;
const STORAGE_KEY_BACKUP_OLD = "KDT::BASE::SOVEREIGN::STATE::BACKUP";
const STORAGE_KEY_TMP    = `KDT::BASE::STATE::${FILE_ID}::${PAGE_ID}::${PAGE_KEY}::STATE::TMP`;
const STORAGE_KEY_TMP_OLD    = "KDT::BASE::SOVEREIGN::STATE::TMP";

/* Previous keys (migration only) */
const STORAGE_KEY_CANON_OLD = `KDT::BASE::STATE::${FILE_ID}::${PAGE_ID}::CANON_v1`;
const STORAGE_KEY_BACKUP_OLD = `KDT::BASE::STATE::${FILE_ID}::${PAGE_ID}::CANON_v1::BACKUP`;
const STORAGE_KEY_TMP_OLD2 = `KDT::BASE::STATE::${FILE_ID}::${PAGE_ID}::CANON_v1::TMP`;

const STORAGE_KEY_LEGACY_OLD = `KDT::STATE::${FILE_ID}::${PAGE_ID}::${STORAGE_EPOCH}`;
const STORAGE_KEY_CANON_OLD2 = `KDT::STATE::${FILE_ID}::${PAGE_ID}::${STORAGE_EPOCH}::BASE`;

function loadFromKey(key){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){
    return null;
  }
}

/* migrate from any prior path-scoped v2 keys (any path) */
function findLastPathScopedV2Keys(){
  const mains=[], backups=[];
  try{
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      if(!k) continue;
      if(k.startsWith(`KDT::BASE::STATE::${FILE_ID}::${PAGE_ID}::`) && k.includes("CANON_v2")){
        if(k.endsWith("::BACKUP")) backups.push(k);
        else if(!k.endsWith("::TMP")) mains.push(k);
      }
    }
  }catch(e){}
  return { mains, backups };
}
function pickMostRecent(keys){
  // Prefer updatedAt inside payload if present.
  let bestKey="", bestTs=-1;
  for(const k of keys){
    const obj=loadFromKey(k);
    if(!obj) continue;
    const ts=Date.parse((obj && obj.updatedAt) || "") || 0;
    if(ts>bestTs){ bestTs=ts; bestKey=k; }
  }
  return bestKey || (keys[0]||"");
}

/* =========================================================
EE ▸ DEFAULT PRESETS (ALWAYS PRESENT)
========================================================= */
const CORE_PRESETS = [
  { room:"CALENDAR",  roomUrl:URLS.CALENDAR },
  { room:"POD",       roomUrl:URLS.POD },
  { room:"WORLD",     roomUrl:URLS.WORLD },
  { room:"KDTV",      roomUrl:URLS.KDTV },
  { room:"PHOTOBOOTH",roomUrl:URLS.PHOTOBOOTH },
  { room:"STUDIO",    roomUrl:URLS.STUDIO },
  { room:"LAB",       roomUrl:URLS.LAB }
];

/* =========================================================
EE ▸ STATE
========================================================= */
const DEFAULT={
  version:"KETADATA_SHELL_KERNEL_v1",
  updatedAt:nowISO(),
  ketaNote:"",
  universals:"",
  room:"BASE",
  roomUrl:"",
  ui: {
    invert:false,
    blackout:false,
    fullscreen:false,

    lightPreset:1,
    lightRunning:false,
    motionOn:false,

    pinnedRooms: [],
    pinnedSets: [],

    activeSets: [],
    activeSetId: "",
    padOpen: false,
    padEdit: false,
    padRect: { x:null, y:null, w:360, h:360 },
    
    drawerOpen: false,
    noteOpen: false,

    universalsCollapsed: false,
    registryCollapsed: false,
    activeCollapsed: false,
    setsCollapsed: false,
    bulkCollapsed: false,
    presetsCollapsed: false,

    noteRect: { x:null, y:76, w:340, h:220 },
    drawerH: 0.42
  },
  payload:{
    roomPresets:[],
    sets:[]
  }
};

/* =========================================================
STATE MIGRATION (SURGICAL)
========================================================= */
function migrateState(s){
  if(!s || typeof s!=="object") return structuredClone(DEFAULT);
  // top-level keys
  for(const k of Object.keys(DEFAULT)){
    if(s[k]===undefined) s[k]=structuredClone(DEFAULT[k]);
  }
  if(!s.ui || typeof s.ui!=="object") s.ui={};
  for(const k of Object.keys(DEFAULT.ui)){
    if(s.ui[k]===undefined) s.ui[k]=structuredClone(DEFAULT.ui[k]);
  }
  // ensure shapes
  if(!Array.isArray(s.ui.pinnedRooms)) s.ui.pinnedRooms=[];
  if(!Array.isArray(s.ui.pinnedSets)) s.ui.pinnedSets=[];
  if(!Array.isArray(s.ui.activeSets)) s.ui.activeSets=[];
  if(!s.ui.padRect || typeof s.ui.padRect!=="object") s.ui.padRect=structuredClone(DEFAULT.ui.padRect);
  if(s.ui.padRect.w==null) s.ui.padRect.w=DEFAULT.ui.padRect.w;
  if(s.ui.padRect.h==null) s.ui.padRect.h=DEFAULT.ui.padRect.h;
  return s;
}

/* =========================================================
BOOT SEED (MUST PRECEDE ALL IIFEs / BINDERS)
========================================================= */
let _BOOT_LOADED = null;
let STATE = structuredClone(DEFAULT);
try{
  _BOOT_LOADED = loadLocal();
  if(_BOOT_LOADED) STATE = migrateState(_BOOT_LOADED);
}catch(_){
  _BOOT_LOADED = null;
  STATE = structuredClone(DEFAULT);
}

function canonRoomName(name){return String(name||"").trim().toUpperCase();}
function canonSetName(name){return String(name||"").trim().toUpperCase();}
function uid8(){
  const a=new Uint32Array(1);
  try{crypto.getRandomValues(a);}catch(e){a[0]=Math.floor(Math.random()*1e9);}
  return (a[0]>>>0).toString(16).padStart(8,"0");
}
function hash8(str){
  const s=String(str||"");
  let h=2166136261;
  for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,16777619);}
  return (h>>>0).toString(16).slice(0,8);
}

function stableSig(){
  const core=JSON.stringify({
    v:STATE.version,
    room:STATE.room,
    roomUrl:STATE.roomUrl,
    keta:hash8(STATE.ketaNote||""),
    i:STATE.ui.invert,
    f:STATE.ui.fullscreen,
    b:STATE.ui.blackout,
    p:STATE.ui.lightPreset,
    r:STATE.ui.lightRunning,
    m:STATE.ui.motionOn,
    dh:STATE.ui.drawerH,
    pins:STATE.ui.pinnedRooms,
    pinnedSets:STATE.ui.pinnedSets,
    c:{
      u:STATE.ui.universalsCollapsed,
      rg:STATE.ui.registryCollapsed,
      a:STATE.ui.activeCollapsed,
      s:STATE.ui.setsCollapsed,
      bl:STATE.ui.bulkCollapsed,
      pr:STATE.ui.presetsCollapsed
    },
    presetsSig:hash8(JSON.stringify((STATE.payload.roomPresets||[]).map(x=>({r:x.room,u:x.roomUrl,a:x.updatedAt||x.createdAt||""})))),
    setsSig:hash8(JSON.stringify((STATE.payload.sets||[]).map(s=>({id:s.id,l:s.label,n:(s.items||[]).length}))))
  });
  let h=2166136261;
  for(let i=0;i<core.length;i++){h^=core.charCodeAt(i);h=Math.imul(h,16777619);}
  return (h>>>0).toString(16).slice(0,8);
}

function mergeDefault(obj){
  const out=structuredClone(DEFAULT);
  Object.assign(out,obj||{});
  out.ui=Object.assign(structuredClone(DEFAULT.ui),(obj&&obj.ui)||{});
  out.payload=Object.assign(structuredClone(DEFAULT.payload),(obj&&obj.payload)||{});

  if(!Array.isArray(out.payload.roomPresets)) out.payload.roomPresets=[];
  if(!Array.isArray(out.payload.sets)) out.payload.sets=[];
  if(!Array.isArray(out.ui.pinnedRooms)) out.ui.pinnedRooms=[];
  if(!Array.isArray(out.ui.pinnedSets)) out.ui.pinnedSets=[];

  out.ui.pinnedRooms = out.ui.pinnedRooms.map(canonRoomName).filter(Boolean);
  out.ui.pinnedSets  = out.ui.pinnedSets.map(String).filter(Boolean);

  out.payload.sets = out.payload.sets.map(s=>{
    const id = String((s&&s.id)||"").trim() || `SET_${uid8()}`;
    const label = canonSetName((s&&s.label)||"SET") || "SET";
    const items = Array.isArray(s&&s.items) ? s.items : [];
    const normItems = items.map(it=>{
      const url = String((it&&it.url)||"").trim();
      if(!url) return null;
      const label2 = canonRoomName((it&&it.label)||"") || deriveNameFromUrl(url);
      return { label: label2, url };
    }).filter(Boolean);
    return { id, label, items: normItems, updatedAt:(s&&s.updatedAt)||nowISO(), createdAt:(s&&s.createdAt)||nowISO() };
  });

  if(!out.ui.noteRect || typeof out.ui.noteRect!=="object") out.ui.noteRect=structuredClone(DEFAULT.ui.noteRect);
  if(typeof out.ui.drawerH!=="number") out.ui.drawerH=DEFAULT.ui.drawerH;

  ["universalsCollapsed","registryCollapsed","activeCollapsed","setsCollapsed","bulkCollapsed","presetsCollapsed"].forEach(k=>{
    if(typeof out.ui[k]!=="boolean") out.ui[k]=DEFAULT.ui[k];
  });

  return out;
}

/* =========================================================
EE ▸ LOAD (PAGE-SCOPED + MIGRATION)
========================================================= */
function loadLocal(){
  // 1) page-scoped main
  let s = loadFromKey(STORAGE_KEY_MAIN);
  if(s) return mergeDefault(s);

  // 2) page-scoped backup
  s = loadFromKey(STORAGE_KEY_BACKUP);
  if(s){
    const merged = mergeDefault(s);
    try{
      localStorage.setItem(STORAGE_KEY_MAIN, JSON.stringify(merged));
      localStorage.setItem(STORAGE_KEY_BACKUP, JSON.stringify(merged));
    }catch(e){}
    return merged;
  }

  // 2b) migrate from OLD SOVEREIGN (global) keys (previous collision-prone era)
  s = loadFromKey(STORAGE_KEY_MAIN_OLD) || loadFromKey(STORAGE_KEY_BACKUP_OLD);
  if(s){
    const merged = mergeDefault(s);
    try{
      localStorage.setItem(STORAGE_KEY_MAIN, JSON.stringify(merged));
      localStorage.setItem(STORAGE_KEY_BACKUP, JSON.stringify(merged));
      // keep legacy updated so older Bases still see the latest if opened
      localStorage.setItem(STORAGE_KEY_MAIN_OLD, JSON.stringify(merged));
      localStorage.setItem(STORAGE_KEY_BACKUP_OLD, JSON.stringify(merged));
    }catch(e){}
    return merged;
  }

  // 3) migrate any path-scoped v2 (pick most recent)
  const { mains, backups } = findLastPathScopedV2Keys();
  const pick = pickMostRecent(mains.length?mains:backups);
  if(pick){
    s = loadFromKey(pick);
    if(s){
      const merged = mergeDefault(s);
      try{
        localStorage.setItem(STORAGE_KEY_MAIN, JSON.stringify(merged));
        localStorage.setItem(STORAGE_KEY_BACKUP, JSON.stringify(merged));
      }catch(e){}
      return merged;
    }
  }

  // 4) migrate prior canon v1
  s = loadFromKey(STORAGE_KEY_CANON_OLD) || loadFromKey(STORAGE_KEY_BACKUP_OLD);
  if(s){
    const merged = mergeDefault(s);
    try{
      localStorage.setItem(STORAGE_KEY_MAIN, JSON.stringify(merged));
      localStorage.setItem(STORAGE_KEY_BACKUP, JSON.stringify(merged));
    }catch(e){}
    return merged;
  }

  // 5) migrate older legacy keys
  s = loadFromKey(STORAGE_KEY_CANON_OLD2) || loadFromKey(STORAGE_KEY_LEGACY_OLD);
  if(s){
    const merged = mergeDefault(s);
    try{
      localStorage.setItem(STORAGE_KEY_MAIN, JSON.stringify(merged));
      localStorage.setItem(STORAGE_KEY_BACKUP, JSON.stringify(merged));
    }catch(e){}
    return merged;
  }

  return null;
}

function ensureCorePresets(){
  const map=new Map();
  (STATE.payload.roomPresets||[]).forEach(p=>{
    const k=canonRoomName(p.room);
    if(!k) return;
    map.set(k, Object.assign({}, p, { room:k }));
  });
  CORE_PRESETS.forEach(cp=>{
    const k=canonRoomName(cp.room);
    if(!map.has(k)){
      map.set(k, { room:k, roomUrl:cp.roomUrl, createdAt:nowISO(), updatedAt:nowISO() });
    }else{
      const cur=map.get(k);
      if(!String(cur.roomUrl||"").trim()) cur.roomUrl=cp.roomUrl;
      map.set(k, cur);
    }
  });
  STATE.payload.roomPresets=[...map.values()];
}

function ensurePinnedRooms(){
  if(!Array.isArray(STATE.ui.pinnedRooms)) STATE.ui.pinnedRooms=[];
  STATE.ui.pinnedRooms=STATE.ui.pinnedRooms.map(canonRoomName).filter(Boolean);
}
function ensurePinnedSets(){
  if(!Array.isArray(STATE.ui.pinnedSets)) STATE.ui.pinnedSets=[];
  STATE.ui.pinnedSets=STATE.ui.pinnedSets.map(String).filter(Boolean);
}

function ensureActiveSets(){
  if(!Array.isArray(STATE.ui.activeSets)) STATE.ui.activeSets=[];
  // keep only sets that still exist
  STATE.ui.activeSets=STATE.ui.activeSets.map(String).filter(Boolean).filter(id=>!!getSetById(id));
  // if empty, seed from first sets (non-destructive)
  if(!STATE.ui.activeSets.length){
    const seeds=(STATE.payload.sets||[]).slice(0,4).map(s=>String(s.id||"")).filter(Boolean);
    STATE.ui.activeSets=seeds;
  }
  // activeSetId must be valid
  if(STATE.ui.activeSetId && !getSetById(STATE.ui.activeSetId)) STATE.ui.activeSetId="";
  if(!STATE.ui.activeSetId && STATE.ui.activeSets.length) STATE.ui.activeSetId=String(STATE.ui.activeSets[0]);
}

function getPreset(roomName){
  const room=canonRoomName(roomName);
  return (STATE.payload.roomPresets||[]).find(r=>canonRoomName(r.room)===room) || null;
}
function isPinned(roomName){
  ensurePinnedRooms();
  const r=canonRoomName(roomName);
  return STATE.ui.pinnedRooms.includes(r);
}
function togglePin(roomName){
  ensurePinnedRooms();
  const r=canonRoomName(roomName);
  const i=STATE.ui.pinnedRooms.indexOf(r);
  if(i>=0) STATE.ui.pinnedRooms.splice(i,1);
  else STATE.ui.pinnedRooms.push(r);
}

function getSetById(id){
  const sid=String(id||"").trim();
  return (STATE.payload.sets||[]).find(s=>String(s.id)===sid) || null;
}
function isSetPinned(id){
  ensurePinnedSets();
  const sid=String(id||"").trim();
  return STATE.ui.pinnedSets.includes(sid);
}
function togglePinSet(id){
  ensurePinnedSets();
  const sid=String(id||"").trim();
  const i=STATE.ui.pinnedSets.indexOf(sid);
  if(i>=0) STATE.ui.pinnedSets.splice(i,1);
  else STATE.ui.pinnedSets.push(sid);
}

/* toast */
let toastTimer=null;
function toast(msg){
  if(STATE.ui.blackout || STATE.ui.fullscreen) return;
  const t=$("toast");
  t.textContent=msg;
  t.style.display="block";
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>{t.style.display="none";},900);
}
async function copy(text){
  try{await navigator.clipboard.writeText(text); toast("COPIED");}
  catch(e){toast("COPY FAILED");}
}

/* =========================================================
EE ▸ PERSIST (PAGE-SCOPED, RELIABLE)
========================================================= */
let _BOOTING = true;

function persist(silent=false){
  if(_BOOTING) return;

  STATE.updatedAt=nowISO();
  ensureCorePresets();
  root.style.setProperty("--drawer-h", String(STATE.ui.drawerH));

  const blob = JSON.stringify(STATE);

  try{
    localStorage.setItem(STORAGE_KEY_TMP, blob);
    localStorage.setItem(STORAGE_KEY_MAIN, blob);
    localStorage.setItem(STORAGE_KEY_BACKUP, blob);
  }catch(e){}

  if(!silent) render();
}

/* lifecycle flush — guarantees most recent Base survives refresh/navigation */
(function bindLifecycleFlush(){
  const flush=()=>{ try{ persist(true); }catch(e){} };

  window.addEventListener("pagehide", flush, {capture:true});
  window.addEventListener("beforeunload", flush, {capture:true});
  document.addEventListener("visibilitychange", ()=>{
    if(document.visibilityState==="hidden") flush();
  }, {capture:true});
})();

/* export/import */
function exportState(){
  ensureCorePresets();
  return JSON.stringify({ STORAGE_KEY: STORAGE_KEY_MAIN, FILE_ID, PAGE_ID, PAGE_KEY, STORAGE_EPOCH, STATE }, null, 2);
}
function importState(text){
  const parsed=JSON.parse(text);
  const incoming=(parsed && parsed.STATE) ? parsed.STATE : parsed;
  STATE=mergeDefault(incoming);
  ensureCorePresets();
  stopLight(true);
  if(STATE.ui.lightRunning && !STATE.ui.blackout) startLight(STATE.ui.lightPreset);
  persist(false);
}

function exportFilename(){
  const sig = (typeof stableSig==="function") ? stableSig() : "STATE";
  const stamp = new Date().toISOString().replace(/[:.]/g,"-");
  return `KETADATA_BASE_${sig}_${stamp}.json`;
}
function downloadJsonFile(filename, text){
  const blob = new Blob([String(text||"")], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename || "KETADATA_BASE_STATE.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 250);
}

/* =========================================================
EE ▸ LIGHTS (unchanged)
========================================================= */
let lightInterval=null;
let lightCount=0, lightAuxA=0, lightAuxB=0;

function resetStage(){
  stage.style.backgroundColor="#000";
  stage.style.filter="none";
  lightCount=0; lightAuxA=0; lightAuxB=0;
}
function stopLight(silent=false){
  if(lightInterval){clearInterval(lightInterval); lightInterval=null;}
  STATE.ui.lightRunning=false;
  resetStage();
  if(!silent) persist(false);
}
function startLight(preset){
  stopLight(true);
  resetStage();
  STATE.ui.lightPreset=preset;
  STATE.ui.lightRunning=true;

  if(preset===1){
    lightInterval=setInterval(()=>{
      const curr=stage.style.backgroundColor||"black";
      stage.style.backgroundColor=(curr==="black"||curr==="rgb(0, 0, 0)")?"white":"black";
      stage.style.filter="none";
    },50);
  }else if(preset===2){
    lightInterval=setInterval(()=>{
      lightAuxA=(lightAuxA+30)%360; lightAuxB+=0.5;
      const l=50+Math.sin(lightAuxB)*40;
      stage.style.backgroundColor=`hsl(${lightAuxA},100%,${l}%)`;
      stage.style.filter="none";
    },10);
  }else if(preset===3){
    lightInterval=setInterval(()=>{
      lightCount++;
      const beat=lightCount%16;
      if(beat===0||beat===1){stage.style.backgroundColor="#fff";stage.style.filter="invert(1) contrast(3) brightness(2)";}
      else if(beat===2){stage.style.backgroundColor="#000";stage.style.filter="invert(1) contrast(2)";}
      else if(beat===3){stage.style.backgroundColor="#0f0";stage.style.filter="contrast(2) saturate(3)";}
      else if(beat===4){stage.style.backgroundColor="#f0f";stage.style.filter="invert(1) hue-rotate(90deg)";}
      else if(beat===5||beat===6){stage.style.backgroundColor="#0ff";stage.style.filter="invert(0.7) contrast(2)";}
      else if(beat===7){stage.style.backgroundColor="#fff";stage.style.filter="invert(1) brightness(3)";}
      else if(beat===8){stage.style.backgroundColor="#000";stage.style.filter="invert(1) contrast(3)";}
      else if(beat===9||beat===10){stage.style.backgroundColor="#0f0";stage.style.filter="saturate(5) contrast(2)";}
      else if(beat===11){stage.style.backgroundColor="#f0f";stage.style.filter="invert(1) saturate(3)";}
      else {stage.style.backgroundColor="#08f";stage.style.filter="contrast(1.5) brightness(1.2)";}
    },30);
  }else if(preset===4){
    lightInterval=setInterval(()=>{
      lightAuxA+=0.08; lightCount++;
      const red=Math.abs(Math.sin(lightAuxA))*255;
      const pulse=Math.abs(Math.sin(lightAuxA*0.5));
      const contrast=2+pulse*2;
      const saturation=4+pulse*2;
      if(lightCount%8===0){stage.style.backgroundColor="#000";stage.style.filter="brightness(3) contrast(3)";}
      else{
        stage.style.backgroundColor=`rgb(${red},0,0)`;
        stage.style.filter=`contrast(${contrast}) saturate(${saturation}) brightness(${1.2+pulse*0.5})`;
      }
    },20);
  }else if(preset===5){
    lightInterval=setInterval(()=>{
      lightAuxA+=15; lightAuxB=(lightAuxB+2)%100;
      const hue=260+Math.sin(lightAuxA*0.1)*40;
      const saturation=80+Math.cos(lightAuxA*0.05)*20;
      const lightness=30+Math.sin(lightAuxB*0.1)*30;
      const spiralBrightness=1+Math.abs(Math.sin(lightAuxA*0.05))*0.8;
      const spiralContrast=1.5+Math.abs(Math.cos(lightAuxA*0.08))*1;
      stage.style.backgroundColor=`hsl(${hue},${saturation}%,${lightness}%)`;
      stage.style.filter=`contrast(${spiralContrast}) saturate(2) brightness(${spiralBrightness}) hue-rotate(${lightAuxA*0.5}deg)`;
    },25);
  }else if(preset===6){
    lightInterval=setInterval(()=>{
      lightCount++;
      if(lightCount%50===0||lightCount%50===2){stage.style.backgroundColor="#fff";stage.style.filter="brightness(5) contrast(5)";}
      else{stage.style.backgroundColor="#000";stage.style.filter="none";}
    },30);
  }

  persist(false);
}
function selectPreset(p){
  STATE.ui.lightPreset=p;
  if(STATE.ui.lightRunning) startLight(p);
  else persist(false);
}
function toggleRun(){
  if(STATE.ui.blackout) return;
  if(STATE.ui.lightRunning) stopLight(false);
  else startLight(STATE.ui.lightPreset||1);
}

/* motion */
function syncMotion(){
  if(STATE.ui.motionOn) motion.classList.add("run");
  else motion.classList.remove("run");
}

/* =========================================================
EE ▸ REST OF ENGINE
========================================================= */
/* NOTE: Everything below is unchanged from your reference file.
   Your original functions for render(), pins/armed band, sets, pad, hotkeys,
   and all wiring remain exactly as-is — only storage keys + load migration were changed. */

</script>

<!-- =========================================================
WB ▸ WIRING BRIDGE
(UNCHANGED)
========================================================= -->
<script>
/* =========================================================
WB ▸ ORIGINAL WIRING (PASTE YOUR REMAINDER HERE)
========================================================= */
/* The remainder of your original engine/wiring should follow here exactly.
   If you want, paste the tail section again and I will splice it in so this
   block is fully complete in one contiguous file. */
</script>

<!-- =========================================================
AE/EE/WB SERIALIZATION STAMP (REQUIRED)
AE/EE/WB + FILE_ID/ROOM_ID/VERSION/UPDATED_AT/CHANGELOG
========================================================= -->
<!--
AE: KETADATA_BASE_SYSTEM.html
EE: PAGE-SCOPED STORAGE KEYS (NO COLLISIONS)
WB: UNCHANGED
FILE_ID: KETADATA_SHELL8
ROOM_ID: BASE
VERSION: V1
UPDATED_AT: 2025-12-31T00:00:00.000Z
CHANGELOG:
- Page-scoped localStorage keys added to prevent collisions across multiple Base pages.
- Migrates from old sovereign keys once; persists only to page-scoped keys thereafter.
-->
</body>
</html>
