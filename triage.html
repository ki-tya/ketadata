<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>KETADATA // LINK TRIAGE (CHRONO / ALPHA)</title>
<style>
:root{
  --bg:#000;
  --ink:rgba(255,255,255,.88);
  --muted:rgba(255,255,255,.56);
  --line:rgba(255,255,255,.14);
  --line2:rgba(255,255,255,.26);
  --panel:rgba(0,0,0,.72);

  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  --sans: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

  --top:44px;
  --bot:34px;
  --pad:10px;
  --gap:10px;
  --radius:0px;

  --btnH:30px;
  --ctlH:30px;

  --accent: rgba(255,255,255,.92);
}
*{box-sizing:border-box}
html,body{height:100%; margin:0}
body{background:var(--bg); color:var(--ink); font-family:var(--sans); overflow:hidden}
a{color:inherit; text-decoration:none}
button,input,select,textarea{font:inherit; color:inherit}
::selection{background:rgba(255,255,255,.14)}

#root{
  position:fixed; inset:0;
  display:grid;
  grid-template-rows: var(--top) 1fr var(--bot);
}

/* ===== top bar ===== */
#topbar{
  display:flex; align-items:center; gap:10px;
  padding:0 10px;
  border-bottom:1px solid var(--line);
  background:linear-gradient(to bottom, rgba(255,255,255,.06), rgba(255,255,255,.02));
}
#brand{
  display:flex; align-items:baseline; gap:10px; min-width:360px;
  font-family:var(--mono);
  letter-spacing:.3px;
}
#brand .t1{opacity:.92}
#brand .t2{opacity:.62}
#sig{
  margin-left:auto;
  font-family:var(--mono);
  font-size:12px;
  opacity:.62;
  white-space:nowrap;
}
#topActions{display:flex; gap:8px; align-items:center; margin-left:10px;}
.btn{
  height:var(--btnH);
  padding:0 10px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,.45);
  border-radius:var(--radius);
  cursor:pointer;
  opacity:.92;
}
.btn:hover{border-color:rgba(255,255,255,.38)}
.btn:active{transform:translateY(1px)}
.btn.ghost{border-color:var(--line); opacity:.72}
.btn.danger{border-color:rgba(255,255,255,.30)}
.pill{
  height:var(--btnH);
  display:flex; align-items:center; gap:6px;
  padding:0 10px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.35);
  border-radius:999px;
  font-family:var(--mono);
  font-size:12px;
  opacity:.8;
}

/* ===== main ===== */
#main{
  display:grid;
  grid-template-columns: 380px 1fr 360px;
  gap:0;
  min-height:0;
}
.col{
  min-height:0;
  border-right:1px solid var(--line);
}
.col:last-child{border-right:none}

/* left controls */
#controls{
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:10px;
  min-height:0;
}
.panel{
  border:1px solid var(--line);
  background:rgba(0,0,0,.35);
  border-radius:var(--radius);
}
.panel .hd{
  display:flex; align-items:center; justify-content:space-between;
  padding:8px 10px;
  border-bottom:1px solid var(--line);
  font-family:var(--mono);
  opacity:.9;
}
.panel .bd{
  padding:10px;
}
.grid2{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:8px;
}
.field{display:flex; flex-direction:column; gap:6px}
.field label{
  font-family:var(--mono);
  font-size:12px;
  opacity:.62;
}
.input, .select{
  height:var(--ctlH);
  padding:0 8px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,.5);
  outline:none;
  border-radius:var(--radius);
}
.input:focus,.select:focus{border-color:rgba(255,255,255,.44)}
.textarea{
  width:100%;
  min-height:120px;
  resize:vertical;
  padding:8px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,.5);
  outline:none;
  border-radius:var(--radius);
  font-family:var(--mono);
  font-size:12px;
  line-height:1.35;
}
.row{display:flex; gap:8px; flex-wrap:wrap}
.row .btn{flex:1}
.small{
  font-family:var(--mono);
  font-size:12px;
  opacity:.62;
  line-height:1.35;
}

/* center list */
#listWrap{
  min-height:0;
  display:flex;
  flex-direction:column;
}
#listHeader{
  padding:10px;
  border-bottom:1px solid var(--line);
  display:flex;
  gap:8px;
  align-items:center;
}
#search{
  flex:1;
  height:var(--ctlH);
  padding:0 10px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,.5);
  outline:none;
  border-radius:var(--radius);
}
#search:focus{border-color:rgba(255,255,255,.44)}
#counts{
  font-family:var(--mono);
  font-size:12px;
  opacity:.62;
  white-space:nowrap;
}
#list{
  min-height:0;
  overflow:auto;
}
.item{
  display:grid;
  grid-template-columns: 14px 1fr;
  gap:10px;
  padding:10px;
  border-bottom:1px solid var(--line);
  align-items:start;
}
.dot{
  width:10px; height:10px;
  border:1px solid rgba(255,255,255,.44);
  margin-top:4px;
  background:rgba(255,255,255,.06);
}
.item:hover{background:rgba(255,255,255,.03)}
.item.deprecated{opacity:.42}
.meta{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:baseline;
}
.url{
  font-family:var(--mono);
  font-size:12px;
  opacity:.92;
  word-break:break-all;
}
.title{
  font-family:var(--mono);
  font-size:12px;
  opacity:.72;
}
.tags{
  display:flex; gap:6px; flex-wrap:wrap;
}
.tag{
  font-family:var(--mono);
  font-size:11px;
  opacity:.7;
  border:1px solid var(--line);
  padding:2px 6px;
}
.note{
  margin-top:6px;
  font-size:12px;
  opacity:.7;
  white-space:pre-wrap;
}
.actions{
  margin-top:8px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.actions .btn{height:28px; padding:0 8px; flex:0 0 auto}
.kv{
  font-family:var(--mono);
  font-size:11px;
  opacity:.62;
}

/* right editor */
#editor{
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:10px;
  min-height:0;
}
#editor .panel{min-height:0}
#editor .bd{display:flex; flex-direction:column; gap:8px}
#editorFooter{
  margin-top:auto;
  display:flex;
  gap:8px;
}
#editorFooter .btn{flex:1}

/* bottom bar */
#botbar{
  display:flex; align-items:center; gap:10px;
  padding:0 10px;
  border-top:1px solid var(--line);
  background:linear-gradient(to top, rgba(255,255,255,.06), rgba(255,255,255,.02));
}
#toast{
  font-family:var(--mono);
  font-size:12px;
  opacity:.62;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
#spacer{flex:1}
#fileOps{display:flex; gap:8px; align-items:center}
kbd{
  font-family:var(--mono);
  font-size:11px;
  opacity:.72;
  border:1px solid var(--line);
  padding:2px 6px;
}

/* color chips */
.chips{display:flex; gap:8px; flex-wrap:wrap}
.chip{
  width:18px; height:18px;
  border:1px solid rgba(255,255,255,.44);
  background:rgba(255,255,255,.06);
  cursor:pointer;
}
.chip.sel{outline:1px solid rgba(255,255,255,.66); outline-offset:2px}

/* modal-ish output pane */
#out{
  display:none;
  position:fixed;
  inset:60px 60px 60px 60px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,.94);
  z-index:50;
}
#out.open{display:flex; flex-direction:column}
#outTop{
  display:flex; align-items:center; gap:8px;
  padding:10px;
  border-bottom:1px solid var(--line);
  font-family:var(--mono);
  opacity:.9;
}
#outTop .btn{flex:0 0 auto}
#outBody{
  padding:10px;
  min-height:0;
  overflow:auto;
}
#outArea{
  width:100%;
  min-height:100%;
  border:1px solid var(--line2);
  background:rgba(0,0,0,.65);
  border-radius:var(--radius);
  padding:10px;
  font-family:var(--mono);
  font-size:12px;
  line-height:1.35;
  outline:none;
  white-space:pre;
}

</style>
</head>
<body>
<div id="root">

  <div id="topbar">
    <div id="brand">
      <span class="t1">KETADATA</span>
      <span class="t2">LINK TRIAGE</span>
      <span class="t2">CHRONO / ALPHA</span>
    </div>

    <div id="topActions">
      <button class="btn ghost" id="btnSortChrono" title="Sort by created time">CHRONO</button>
      <button class="btn ghost" id="btnSortAlpha" title="Sort by title/url">ALPHA</button>
      <button class="btn ghost" id="btnToggleDeprecated" title="Show/hide deprecated">DEPR</button>
      <button class="btn ghost" id="btnInvert" title="Invert">INVERT</button>
      <button class="btn ghost" id="btnNull" title="NULL blackout">NULL</button>
    </div>

    <div id="sig"></div>
  </div>

  <div id="main">
    <!-- LEFT -->
    <div class="col" id="controls">
      <div class="panel">
        <div class="hd"><span>ADD / IMPORT</span><span class="kv">LOCAL-FIRST</span></div>
        <div class="bd">
          <div class="field">
            <label>PASTE LINKS (one per line). Optional: "title | url" or just url</label>
            <textarea class="textarea" id="bulkIn" placeholder="Example:
KETA NOTE | https://example.com
https://ketadata.com/map.html"></textarea>
          </div>
          <div class="row">
            <button class="btn" id="btnAddBulk">ADD LINES</button>
            <button class="btn ghost" id="btnClearBulk">CLEAR</button>
          </div>
          <div class="small">Tip: you can paste mixed content; it will extract URLs. Duplicates can be merged.</div>
        </div>
      </div>

      <div class="panel">
        <div class="hd"><span>FILTERS</span><span class="kv"><span id="fltMode">ALL</span></span></div>
        <div class="bd">
          <div class="field">
            <label>SEARCH (URL / TITLE / NOTE / TAG)</label>
            <input class="input" id="filterText" placeholder="type to filter"/>
          </div>
          <div class="grid2">
            <div class="field">
              <label>COLOR</label>
              <select class="select" id="filterColor">
                <option value="">ANY</option>
              </select>
            </div>
            <div class="field">
              <label>TAG CONTAINS</label>
              <input class="input" id="filterTag" placeholder="tag fragment"/>
            </div>
          </div>
          <div class="grid2">
            <div class="field">
              <label>VIEW</label>
              <select class="select" id="filterView">
                <option value="all">ALL</option>
                <option value="active">ACTIVE ONLY</option>
                <option value="deprecated">DEPRECATED ONLY</option>
              </select>
            </div>
            <div class="field">
              <label>DUPLICATES</label>
              <select class="select" id="filterDup">
                <option value="any">ANY</option>
                <option value="only">ONLY DUPS</option>
                <option value="hide">HIDE DUPS</option>
              </select>
            </div>
          </div>
          <div class="row">
            <button class="btn ghost" id="btnResetFilters">RESET</button>
            <button class="btn" id="btnDedup">MERGE DUPS</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="hd"><span>EXPORT</span><span class="kv">LIST / JSON / CSV</span></div>
        <div class="bd">
          <div class="grid2">
            <div class="field">
              <label>EXPORT SCOPE</label>
              <select class="select" id="exportScope">
                <option value="view">CURRENT VIEW</option>
                <option value="all">ALL RECORDS</option>
                <option value="active">ACTIVE ONLY</option>
                <option value="deprecated">DEPRECATED ONLY</option>
              </select>
            </div>
            <div class="field">
              <label>EXPORT FORMAT</label>
              <select class="select" id="exportFormat">
                <option value="list">PLAIN LIST (URL)</option>
                <option value="md">MARKDOWN</option>
                <option value="json">JSON</option>
                <option value="csv">CSV</option>
              </select>
            </div>
          </div>
          <div class="row">
            <button class="btn" id="btnExport">EXPORT</button>
            <button class="btn ghost" id="btnCopyExport">COPY LAST</button>
          </div>
          <div class="row">
            <button class="btn ghost" id="btnDownloadJSON">DOWNLOAD .JSON</button>
            <button class="btn ghost" id="btnDownloadTXT">DOWNLOAD .TXT</button>
          </div>
          <div class="small">“All our usual export methods” here = copy-to-clipboard + file download + view-modal output.</div>
        </div>
      </div>

      <div class="panel">
        <div class="hd"><span>STATE</span><span class="kv" id="stateKeyLabel"></span></div>
        <div class="bd">
          <div class="row">
            <button class="btn ghost" id="btnStateExport">STATE → FILE</button>
            <button class="btn ghost" id="btnStateImport">FILE → STATE</button>
          </div>
          <input type="file" id="fileIn" accept=".json,application/json,text/plain" style="display:none"/>
          <div class="small">State export/import is full fidelity (records + preferences). It does not rely on network.</div>
        </div>
      </div>
    </div>

    <!-- CENTER -->
    <div class="col" id="listWrap">
      <div id="listHeader">
        <input id="search" placeholder="search…" />
        <div id="counts">0</div>
      </div>
      <div id="list"></div>
    </div>

    <!-- RIGHT -->
    <div class="col" id="editor">
      <div class="panel">
        <div class="hd"><span>EDITOR</span><span class="kv" id="editId">—</span></div>
        <div class="bd">
          <div class="field">
            <label>URL</label>
            <input class="input" id="eUrl" placeholder="https://…"/>
          </div>
          <div class="field">
            <label>TITLE</label>
            <input class="input" id="eTitle" placeholder="short label"/>
          </div>
          <div class="field">
            <label>NOTE</label>
            <textarea class="textarea" id="eNote" style="min-height:96px" placeholder="why this matters / routing / context"></textarea>
          </div>
          <div class="field">
            <label>TAGS (comma separated)</label>
            <input class="input" id="eTags" placeholder="archive, tool, pdf, base"/>
          </div>

          <div class="field">
            <label>COLOR CODE</label>
            <div class="chips" id="chips"></div>
          </div>

          <div class="grid2">
            <div class="field">
              <label>CREATED</label>
              <input class="input" id="eCreated" disabled/>
            </div>
            <div class="field">
              <label>UPDATED</label>
              <input class="input" id="eUpdated" disabled/>
            </div>
          </div>

          <div class="row">
            <button class="btn" id="btnSave">SAVE</button>
            <button class="btn ghost" id="btnNew">NEW</button>
          </div>
          <div class="row">
            <button class="btn ghost" id="btnDeprecate">TOGGLE DEPRECATE</button>
            <button class="btn danger" id="btnDelete">DELETE</button>
          </div>
        </div>
      </div>

      <div class="panel" style="min-height:0">
        <div class="hd"><span>SHORTCUTS</span><span class="kv">FAST</span></div>
        <div class="bd small">
          <div><kbd>↑</kbd>/<kbd>↓</kbd> move selection</div>
          <div><kbd>Enter</kbd> open selected url</div>
          <div><kbd>D</kbd> toggle deprecate</div>
          <div><kbd>C</kbd> cycle color</div>
          <div><kbd>Ctrl/Cmd</kbd>+<kbd>S</kbd> save</div>
          <div><kbd>Ctrl/Cmd</kbd>+<kbd>K</kbd> focus search</div>
        </div>
      </div>

      <div id="editorFooter">
        <button class="btn ghost" id="btnOpen">OPEN</button>
        <button class="btn ghost" id="btnCopyUrl">COPY URL</button>
        <button class="btn ghost" id="btnCopyLine">COPY “TITLE | URL”</button>
      </div>
    </div>
  </div>

  <div id="botbar">
    <div id="toast">READY</div>
    <div id="spacer"></div>
    <div class="pill" id="pillSort">SORT: CHRONO</div>
    <div class="pill" id="pillView">VIEW: ALL</div>
  </div>

</div>

<!-- output modal -->
<div id="out">
  <div id="outTop">
    <div style="flex:1">EXPORT OUTPUT</div>
    <button class="btn ghost" id="btnOutCopy">COPY</button>
    <button class="btn ghost" id="btnOutDownload">DOWNLOAD</button>
    <button class="btn" id="btnOutClose">CLOSE</button>
  </div>
  <div id="outBody">
    <textarea id="outArea" spellcheck="false"></textarea>
  </div>
</div>

<script>
/* ===========================
   KETADATA LINK TRIAGE
   local-first, single-file
=========================== */

const $ = (id)=>document.getElementById(id);
const nowISO = ()=> new Date().toISOString();
const uid = ()=> Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));

function safeURL(u){
  try{
    const x = new URL(u);
    return x.href;
  }catch(e){
    return null;
  }
}

function extractUrls(text){
  // Pull URLs even from messy paste
  const urls = [];
  const re = /\bhttps?:\/\/[^\s<>"')\]]+/gi;
  let m;
  while((m=re.exec(text))!==null){
    urls.push(m[0].replace(/[.,;:]+$/,""));
  }
  return urls;
}

function normalizeTags(s){
  return (s||"")
    .split(",")
    .map(t=>t.trim())
    .filter(Boolean)
    .slice(0,32);
}

/* ===== fixed palette (monochrome-friendly) ===== */
const PALETTE = [
  {id:"none",  label:"NONE",  css:"rgba(255,255,255,.06)"},
  {id:"w1",    label:"W1",    css:"rgba(255,255,255,.18)"},
  {id:"w2",    label:"W2",    css:"rgba(255,255,255,.32)"},
  {id:"w3",    label:"W3",    css:"rgba(255,255,255,.50)"},
  {id:"w4",    label:"W4",    css:"rgba(255,255,255,.70)"},
  {id:"blk",   label:"BLK",   css:"rgba(0,0,0,.0)"} // special (keeps dot empty)
];

/* ===== storage isolation ===== */
const FILE_ID = (() => {
  const k = "KETADATA_LINK_TRIAGE__FILE_ID";
  let v = localStorage.getItem(k);
  if(!v){ v = "KLT-" + uid(); localStorage.setItem(k,v); }
  return v;
})();
const STORE_KEY = "KETADATA_LINK_TRIAGE__STATE__" + FILE_ID;

/* ===== state ===== */
const DEFAULTS = {
  fileId: FILE_ID,
  createdAt: nowISO(),
  updatedAt: nowISO(),
  ui: {
    invert:false,
    blackout:false,
    sortMode:"chrono", // chrono|alpha
    showDeprecated:true,
    filterView:"all",
    filterDup:"any",
    filterText:"",
    filterTag:"",
    filterColor:"",
    search:"",
    selectedId:null
  },
  records: [] // {id,url,title,note,tags[],color,deprecated,createdAt,updatedAt,hash}
};

let STATE = loadState();

function loadState(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return structuredClone(DEFAULTS);
    const st = JSON.parse(raw);

    // migrate / deep-fill
    const out = structuredClone(DEFAULTS);
    out.fileId = st.fileId || FILE_ID;
    out.createdAt = st.createdAt || out.createdAt;
    out.updatedAt = st.updatedAt || out.updatedAt;

    out.ui = Object.assign(out.ui, st.ui||{});
    out.records = Array.isArray(st.records) ? st.records : [];

    // ensure fields
    out.records = out.records.map(r=>{
      const rr = Object.assign({
        id: uid(),
        url:"",
        title:"",
        note:"",
        tags:[],
        color:"none",
        deprecated:false,
        createdAt: nowISO(),
        updatedAt: nowISO(),
        hash:""
      }, r||{});
      rr.tags = Array.isArray(rr.tags) ? rr.tags : normalizeTags(rr.tags);
      rr.url = (rr.url||"").trim();
      rr.title = (rr.title||"").trim();
      rr.note = (rr.note||"").trim();
      rr.color = rr.color || "none";
      rr.deprecated = !!rr.deprecated;
      rr.hash = rr.hash || hashKey(rr.url);
      return rr;
    });

    return out;
  }catch(e){
    return structuredClone(DEFAULTS);
  }
}

function saveState(){
  STATE.updatedAt = nowISO();
  localStorage.setItem(STORE_KEY, JSON.stringify(STATE));
  updateSig();
}

function hashKey(url){
  // tiny stable hash for dedup
  let s = (url||"").trim().toLowerCase();
  let h = 2166136261;
  for(let i=0;i<s.length;i++){
    h ^= s.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return ("h"+(h>>>0).toString(16));
}

/* ===== UI state ===== */
let LAST_EXPORT = {text:"", ext:"txt", mime:"text/plain", filename:"export.txt"};

function toast(msg){
  $("toast").textContent = msg;
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>{$("toast").textContent="READY";}, 1200);
}

/* ===== render list ===== */
function getColorCss(id){
  const p = PALETTE.find(x=>x.id===id) || PALETTE[0];
  return p.css;
}

function getViewRecords(){
  const ui = STATE.ui;
  let rs = STATE.records.slice();

  // view filter
  if(ui.filterView==="active") rs = rs.filter(r=>!r.deprecated);
  if(ui.filterView==="deprecated") rs = rs.filter(r=>!!r.deprecated);

  // deprecated toggle button (quick show/hide)
  if(!ui.showDeprecated) rs = rs.filter(r=>!r.deprecated);

  // dup filter
  const counts = new Map();
  rs.forEach(r=>{
    const k=r.hash||hashKey(r.url);
    counts.set(k,(counts.get(k)||0)+1);
  });
  if(ui.filterDup==="only") rs = rs.filter(r=> (counts.get(r.hash)||0) > 1 );
  if(ui.filterDup==="hide") rs = rs.filter(r=> (counts.get(r.hash)||0) <= 1 );

  // text filter (left panel)
  const ftxt = (ui.filterText||"").trim().toLowerCase();
  const ftag = (ui.filterTag||"").trim().toLowerCase();
  const fcol = (ui.filterColor||"").trim();

  if(ftxt){
    rs = rs.filter(r=>{
      const blob = [
        r.url, r.title, r.note, (r.tags||[]).join(" ")
      ].join(" ").toLowerCase();
      return blob.includes(ftxt);
    });
  }
  if(ftag){
    rs = rs.filter(r=>{
      return (r.tags||[]).join(",").toLowerCase().includes(ftag);
    });
  }
  if(fcol){
    rs = rs.filter(r => (r.color||"none") === fcol);
  }

  // top search (center)
  const q = (ui.search||"").trim().toLowerCase();
  if(q){
    rs = rs.filter(r=>{
      const blob = [
        r.url, r.title, r.note, (r.tags||[]).join(" ")
      ].join(" ").toLowerCase();
      return blob.includes(q);
    });
  }

  // sort
  if(ui.sortMode==="chrono"){
    rs.sort((a,b)=>{
      const ta = Date.parse(a.createdAt||"") || 0;
      const tb = Date.parse(b.createdAt||"") || 0;
      return tb - ta; // newest first
    });
  }else{
    rs.sort((a,b)=>{
      const ka = (a.title||a.url||"").toLowerCase();
      const kb = (b.title||b.url||"").toLowerCase();
      return ka.localeCompare(kb);
    });
  }

  return rs;
}

function render(){
  // root classes
  document.body.classList.toggle("invert", !!STATE.ui.invert);
  document.body.classList.toggle("blackout", !!STATE.ui.blackout);

  // invert effect minimal + reversible
  document.documentElement.style.filter = STATE.ui.invert ? "invert(1)" : "none";

  // blackout for NULL
  document.documentElement.style.background = "#000";
  if(STATE.ui.blackout){
    document.documentElement.style.filter = (STATE.ui.invert ? "invert(1) " : "") + "brightness(0.65)";
  }

  $("pillSort").textContent = "SORT: " + (STATE.ui.sortMode==="chrono" ? "CHRONO" : "ALPHA");
  $("pillView").textContent = "VIEW: " + $("filterView").selectedOptions[0].textContent;

  // list
  const rs = getViewRecords();
  $("counts").textContent = `${rs.length} / ${STATE.records.length}`;

  const sel = STATE.ui.selectedId;
  const list = $("list");
  list.innerHTML = "";
  rs.forEach((r,idx)=>{
    const row = document.createElement("div");
    row.className = "item" + (r.deprecated ? " deprecated":"");
    row.dataset.id = r.id;

    const dot = document.createElement("div");
    dot.className = "dot";
    const ccss = getColorCss(r.color||"none");
    if(r.color && r.color!=="blk") dot.style.background = ccss;
    if(r.color==="blk") dot.style.background = "rgba(255,255,255,.02)";

    const main = document.createElement("div");

    const meta = document.createElement("div");
    meta.className = "meta";

    const url = document.createElement("div");
    url.className = "url";
    url.textContent = r.url || "(no url)";

    const title = document.createElement("div");
    title.className = "title";
    title.textContent = r.title ? "— " + r.title : "";

    const tags = document.createElement("div");
    tags.className = "tags";
    (r.tags||[]).slice(0,6).forEach(t=>{
      const s=document.createElement("span");
      s.className="tag";
      s.textContent=t;
      tags.appendChild(s);
    });

    meta.appendChild(url);
    if(r.title) meta.appendChild(title);
    meta.appendChild(tags);

    const note = document.createElement("div");
    note.className = "note";
    if(r.note) note.textContent = r.note;

    const kv = document.createElement("div");
    kv.className = "kv";
    kv.textContent = `created ${shortTime(r.createdAt)}  ·  ${r.deprecated ? "DEPRECATED" : "ACTIVE"}  ·  ${r.color||"none"}`;

    const actions = document.createElement("div");
    actions.className = "actions";
    const b1 = mkBtn("OPEN", ()=>openUrl(r.url));
    const b2 = mkBtn("EDIT", ()=>selectRecord(r.id,true));
    const b3 = mkBtn("DEPR", ()=>{toggleDeprecate(r.id);});
    const b4 = mkBtn("COPY", ()=>copyText(r.url||""));
    b1.classList.add("ghost"); b2.classList.add("ghost"); b3.classList.add("ghost"); b4.classList.add("ghost");
    actions.appendChild(b1); actions.appendChild(b2); actions.appendChild(b3); actions.appendChild(b4);

    main.appendChild(meta);
    if(r.note) main.appendChild(note);
    main.appendChild(kv);
    main.appendChild(actions);

    row.appendChild(dot);
    row.appendChild(main);

    if(sel===r.id){
      row.style.background="rgba(255,255,255,.05)";
      row.style.outline="1px solid rgba(255,255,255,.26)";
      row.style.outlineOffset="-1px";
    }

    row.addEventListener("click",(ev)=>{
      if(ev.target.tagName==="BUTTON") return;
      selectRecord(r.id,true);
    });

    list.appendChild(row);
  });

  // ensure selection exists
  if(rs.length && !rs.some(r=>r.id===STATE.ui.selectedId)){
    STATE.ui.selectedId = rs[0].id;
    fillEditorById(STATE.ui.selectedId);
    saveState();
    // no recursion explosion; render is called after save anyway via caller
  }

  // update editor if nothing selected
  if(!STATE.ui.selectedId){
    clearEditor();
  }else{
    fillEditorById(STATE.ui.selectedId);
  }

  rebuildFilterColorOptions();
}

function mkBtn(txt, fn){
  const b=document.createElement("button");
  b.className="btn";
  b.textContent=txt;
  b.addEventListener("click",(e)=>{e.stopPropagation(); fn();});
  return b;
}

function shortTime(iso){
  if(!iso) return "—";
  const d = new Date(iso);
  if(isNaN(d.getTime())) return "—";
  const yyyy=d.getFullYear();
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const dd=String(d.getDate()).padStart(2,"0");
  const hh=String(d.getHours()).padStart(2,"0");
  const mi=String(d.getMinutes()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
}

/* ===== selection/editor ===== */
function clearEditor(){
  $("editId").textContent="—";
  $("eUrl").value="";
  $("eTitle").value="";
  $("eNote").value="";
  $("eTags").value="";
  $("eCreated").value="";
  $("eUpdated").value="";
  setChipSel("none");
}

function selectRecord(id, scroll){
  STATE.ui.selectedId = id;
  saveState();
  fillEditorById(id);
  render();
  if(scroll){
    const el = document.querySelector(`.item[data-id="${CSS.escape(id)}"]`);
    if(el) el.scrollIntoView({block:"nearest"});
  }
}

function fillEditorById(id){
  const r = STATE.records.find(x=>x.id===id);
  if(!r){ clearEditor(); return; }
  $("editId").textContent = r.id;
  $("eUrl").value = r.url||"";
  $("eTitle").value = r.title||"";
  $("eNote").value = r.note||"";
  $("eTags").value = (r.tags||[]).join(", ");
  $("eCreated").value = shortTime(r.createdAt);
  $("eUpdated").value = shortTime(r.updatedAt);
  setChipSel(r.color||"none");
}

function upsertFromEditor(){
  const id = STATE.ui.selectedId;
  let r = STATE.records.find(x=>x.id===id);
  if(!r){
    r = {
      id: uid(),
      url:"",
      title:"",
      note:"",
      tags:[],
      color:"none",
      deprecated:false,
      createdAt: nowISO(),
      updatedAt: nowISO(),
      hash:""
    };
    STATE.records.unshift(r);
    STATE.ui.selectedId = r.id;
  }

  const u = $("eUrl").value.trim();
  const u2 = safeURL(u) || (extractUrls(u)[0] ? safeURL(extractUrls(u)[0]) : null);
  if(u && !u2){
    toast("INVALID URL");
    return false;
  }

  r.url = u2 || "";
  r.title = $("eTitle").value.trim();
  r.note = $("eNote").value.trim();
  r.tags = normalizeTags($("eTags").value);
  r.color = chipSelId || "none";
  r.hash = hashKey(r.url||"");
  r.updatedAt = nowISO();

  saveState();
  toast("SAVED");
  return true;
}

function toggleDeprecate(id){
  const r = STATE.records.find(x=>x.id===id);
  if(!r) return;
  r.deprecated = !r.deprecated;
  r.updatedAt = nowISO();
  saveState();
  toast(r.deprecated ? "DEPRECATED" : "ACTIVE");
  render();
}

function deleteRecord(id){
  const idx = STATE.records.findIndex(x=>x.id===id);
  if(idx<0) return;
  const wasSel = (STATE.ui.selectedId===id);
  STATE.records.splice(idx,1);
  if(wasSel){
    STATE.ui.selectedId = STATE.records[0]?.id || null;
  }
  saveState();
  toast("DELETED");
  render();
}

/* ===== bulk add/import ===== */
function parseLine(line){
  // "title | url" OR url-only; also extracts url if mixed
  const raw = (line||"").trim();
  if(!raw) return null;
  const parts = raw.split("|").map(s=>s.trim()).filter(Boolean);
  if(parts.length>=2){
    const title = parts.slice(0, parts.length-1).join(" | ");
    const url = safeURL(parts[parts.length-1]) || (extractUrls(parts[parts.length-1])[0] ? safeURL(extractUrls(parts[parts.length-1])[0]) : null);
    if(!url) return null;
    return {title, url};
  }else{
    const url = safeURL(raw) || (extractUrls(raw)[0] ? safeURL(extractUrls(raw)[0]) : null);
    if(!url) return null;
    return {title:"", url};
  }
}

function addBulk(text){
  const lines = (text||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  let added=0;
  for(const line of lines){
    const p = parseLine(line);
    if(!p){
      // attempt url extraction from messy line
      const u = extractUrls(line)[0];
      const url = u ? safeURL(u) : null;
      if(!url) continue;
      addOne({url, title:""});
      added++;
      continue;
    }
    addOne(p);
    added++;
  }
  if(added){
    saveState();
    toast("ADDED " + added);
    render();
  }else{
    toast("NOTHING ADDED");
  }
}

function addOne({url,title}){
  const r = {
    id: uid(),
    url: url||"",
    title: (title||"").trim(),
    note:"",
    tags:[],
    color:"none",
    deprecated:false,
    createdAt: nowISO(),
    updatedAt: nowISO(),
    hash: hashKey(url||"")
  };
  STATE.records.unshift(r);
  STATE.ui.selectedId = r.id;
}

function mergeDups(){
  // Merge by hash (normalized url). Keep newest as primary.
  const by = new Map();
  for(const r of STATE.records){
    const k = r.hash || hashKey(r.url);
    if(!by.has(k)) by.set(k, []);
    by.get(k).push(r);
  }
  let merged=0;
  const out=[];
  for(const [k,arr] of by.entries()){
    if(arr.length===1){ out.push(arr[0]); continue; }

    // sort newest createdAt first
    arr.sort((a,b)=>(Date.parse(b.createdAt)||0)-(Date.parse(a.createdAt)||0));
    const keep = arr[0];

    // merge titles/notes/tags/colors/deprecation conservatively
    for(let i=1;i<arr.length;i++){
      const r=arr[i];
      if(!keep.title && r.title) keep.title = r.title;
      if(!keep.note && r.note) keep.note = r.note;
      const tags = new Set([...(keep.tags||[]), ...(r.tags||[])]);
      keep.tags = Array.from(tags).slice(0,32);

      if((keep.color==="none" || !keep.color) && r.color && r.color!=="none") keep.color = r.color;
      if(r.deprecated) keep.deprecated = true;

      merged++;
    }
    keep.updatedAt = nowISO();
    out.push(keep);
  }
  // keep ordering (by current sort not needed; render will sort)
  STATE.records = out;
  saveState();
  toast(merged ? ("MERGED " + merged) : "NO DUPS");
  render();
}

/* ===== filters ===== */
function rebuildFilterColorOptions(){
  const sel = $("filterColor");
  const cur = sel.value;
  sel.innerHTML = `<option value="">ANY</option>` + PALETTE.map(p=>{
    return `<option value="${p.id}">${p.label}</option>`;
  }).join("");
  sel.value = cur || "";
}

/* ===== export ===== */
function scopeRecords(scope){
  if(scope==="all") return STATE.records.slice();
  if(scope==="active") return STATE.records.filter(r=>!r.deprecated);
  if(scope==="deprecated") return STATE.records.filter(r=>!!r.deprecated);
  // view
  return getViewRecords();
}

function exportText(){
  const scope = $("exportScope").value;
  const fmt = $("exportFormat").value;
  const rs = scopeRecords(scope);

  const rows = rs.slice(); // already sorted by view sort if view
  let text="", ext="txt", mime="text/plain";

  if(fmt==="list"){
    text = rows.map(r=>r.url).filter(Boolean).join("\n");
    ext="txt"; mime="text/plain";
  }else if(fmt==="md"){
    text = rows.map(r=>{
      const t = (r.title||r.url||"").replace(/\n/g," ").trim();
      const u = r.url||"";
      const tags = (r.tags||[]).length ? ` \`[${r.tags.join(", ")}]\`` : "";
      const dep = r.deprecated ? " (DEPRECATED)" : "";
      return `- [${escapeMd(t)}](${u})${tags}${dep}`;
    }).join("\n");
    ext="md"; mime="text/markdown";
  }else if(fmt==="csv"){
    const header = ["createdAt","updatedAt","deprecated","color","title","url","tags","note"].join(",");
    const lines = rows.map(r=>{
      return [
        r.createdAt||"",
        r.updatedAt||"",
        r.deprecated ? "1":"0",
        r.color||"",
        csvCell(r.title||""),
        csvCell(r.url||""),
        csvCell((r.tags||[]).join("|")),
        csvCell(r.note||"")
      ].join(",");
    });
    text = header + "\n" + lines.join("\n");
    ext="csv"; mime="text/csv";
  }else{ // json
    const payload = {
      fileId: STATE.fileId,
      exportedAt: nowISO(),
      sortMode: STATE.ui.sortMode,
      scope,
      count: rows.length,
      records: rows
    };
    text = JSON.stringify(payload, null, 2);
    ext="json"; mime="application/json";
  }

  const fnBase = `KETADATA_LINK_TRIAGE_${STATE.fileId}_${scope}_${fmt}_${stamp()}.${ext}`;
  LAST_EXPORT = {text, ext, mime, filename: fnBase};
  return LAST_EXPORT;
}

function escapeMd(s){
  return (s||"").replace(/([\[\]\(\)\\])/g,"\\$1");
}
function csvCell(s){
  const x = (s||"").replace(/\r?\n/g," ").trim();
  if(/[",]/.test(x)) return `"${x.replace(/"/g,'""')}"`;
  return x;
}
function stamp(){
  const d=new Date();
  const yyyy=d.getFullYear();
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const dd=String(d.getDate()).padStart(2,"0");
  const hh=String(d.getHours()).padStart(2,"0");
  const mi=String(d.getMinutes()).padStart(2,"0");
  return `${yyyy}${mm}${dd}_${hh}${mi}`;
}

function openOutput(text){
  $("outArea").value = text || "";
  $("out").classList.add("open");
  $("outArea").focus();
  $("outArea").select();
}
function closeOutput(){
  $("out").classList.remove("open");
}
async function copyText(t){
  try{
    await navigator.clipboard.writeText(t||"");
    toast("COPIED");
    return true;
  }catch(e){
    // fallback
    try{
      const ta=document.createElement("textarea");
      ta.value=t||"";
      ta.style.position="fixed"; ta.style.left="-9999px";
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      document.execCommand("copy");
      ta.remove();
      toast("COPIED");
      return true;
    }catch(e2){
      toast("COPY FAILED");
      return false;
    }
  }
}
function downloadTextFile(filename, mime, text){
  const blob = new Blob([text||""], {type:mime||"text/plain"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename || "export.txt";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 800);
  toast("DOWNLOADED");
}

/* ===== state import/export (file download behavior) ===== */
function exportStateToFile(){
  const payload = {
    ...STATE,
    exportedAt: nowISO(),
    storeKey: STORE_KEY
  };
  const text = JSON.stringify(payload, null, 2);
  const filename = `KETADATA_LINK_TRIAGE_STATE_${STATE.fileId}_${stamp()}.json`;
  downloadTextFile(filename, "application/json", text);
}

function importStateFromFile(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(String(reader.result||""));
      if(!obj || !obj.records || !obj.ui){
        toast("INVALID STATE");
        return;
      }
      // accept but rebind to this file's STORE_KEY for isolation
      const merged = structuredClone(DEFAULTS);
      merged.fileId = FILE_ID;
      merged.createdAt = obj.createdAt || nowISO();
      merged.updatedAt = nowISO();
      merged.ui = Object.assign(merged.ui, obj.ui||{});
      merged.records = Array.isArray(obj.records) ? obj.records : [];
      merged.records = merged.records.map(r=>{
        const rr = Object.assign({
          id: uid(),
          url:"",
          title:"",
          note:"",
          tags:[],
          color:"none",
          deprecated:false,
          createdAt: nowISO(),
          updatedAt: nowISO(),
          hash:""
        }, r||{});
        rr.tags = Array.isArray(rr.tags) ? rr.tags : normalizeTags(rr.tags);
        rr.url = (rr.url||"").trim();
        rr.title = (rr.title||"").trim();
        rr.note = (rr.note||"").trim();
        rr.color = rr.color || "none";
        rr.deprecated = !!rr.deprecated;
        rr.hash = rr.hash || hashKey(rr.url);
        return rr;
      });

      STATE = merged;
      saveState();
      toast("STATE IMPORTED");
      render();
    }catch(e){
      toast("IMPORT FAILED");
    }
  };
  reader.readAsText(file);
}

/* ===== open ===== */
function openUrl(url){
  const u = safeURL(url||"");
  if(!u){ toast("NO URL"); return; }
  window.open(u, "_blank", "noopener,noreferrer");
}

/* ===== chips ===== */
let chipSelId = "none";
function buildChips(){
  const wrap = $("chips");
  wrap.innerHTML = "";
  PALETTE.forEach(p=>{
    const d=document.createElement("div");
    d.className="chip";
    d.title=p.label;
    d.dataset.id=p.id;
    d.style.background = (p.id==="blk") ? "rgba(255,255,255,.02)" : p.css;
    d.addEventListener("click", ()=>{
      setChipSel(p.id);
    });
    wrap.appendChild(d);
  });
}
function setChipSel(id){
  chipSelId = id || "none";
  document.querySelectorAll(".chip").forEach(el=>{
    el.classList.toggle("sel", el.dataset.id===chipSelId);
  });
}

/* ===== signature ===== */
function updateSig(){
  $("sig").textContent = `FILE_ID ${STATE.fileId}  ·  REC ${STATE.records.length}  ·  UPDATED ${shortTime(STATE.updatedAt)}`;
  $("stateKeyLabel").textContent = "KEY: " + STORE_KEY;
}

/* ===== bindings ===== */
function bind(){
  // sort buttons
  $("btnSortChrono").onclick = ()=>{
    STATE.ui.sortMode="chrono";
    saveState();
    toast("SORT CHRONO");
    render();
  };
  $("btnSortAlpha").onclick = ()=>{
    STATE.ui.sortMode="alpha";
    saveState();
    toast("SORT ALPHA");
    render();
  };
  $("btnToggleDeprecated").onclick = ()=>{
    STATE.ui.showDeprecated = !STATE.ui.showDeprecated;
    saveState();
    toast(STATE.ui.showDeprecated ? "SHOW DEPRECATED" : "HIDE DEPRECATED");
    render();
  };

  $("btnInvert").onclick = ()=>{
    STATE.ui.invert = !STATE.ui.invert;
    saveState();
    toast(STATE.ui.invert ? "INVERT ON" : "INVERT OFF");
    render();
  };

  $("btnNull").onclick = ()=>{
    STATE.ui.blackout = !STATE.ui.blackout;
    saveState();
    toast(STATE.ui.blackout ? "NULL ON" : "NULL OFF");
    render();
  };

  // bulk
  $("btnAddBulk").onclick = ()=>{
    addBulk($("bulkIn").value);
  };
  $("btnClearBulk").onclick = ()=>{
    $("bulkIn").value="";
    toast("CLEARED");
  };

  // filters
  $("filterText").addEventListener("input",(e)=>{
    STATE.ui.filterText = e.target.value;
    saveState();
    render();
  });
  $("filterTag").addEventListener("input",(e)=>{
    STATE.ui.filterTag = e.target.value;
    saveState();
    render();
  });
  $("filterColor").addEventListener("change",(e)=>{
    STATE.ui.filterColor = e.target.value;
    saveState();
    render();
  });
  $("filterView").addEventListener("change",(e)=>{
    STATE.ui.filterView = e.target.value;
    saveState();
    render();
  });
  $("filterDup").addEventListener("change",(e)=>{
    STATE.ui.filterDup = e.target.value;
    saveState();
    render();
  });
  $("btnResetFilters").onclick = ()=>{
    STATE.ui.filterText="";
    STATE.ui.filterTag="";
    STATE.ui.filterColor="";
    STATE.ui.filterView="all";
    STATE.ui.filterDup="any";
    $("filterText").value="";
    $("filterTag").value="";
    $("filterColor").value="";
    $("filterView").value="all";
    $("filterDup").value="any";
    saveState();
    toast("FILTERS RESET");
    render();
  };
  $("btnDedup").onclick = ()=> mergeDups();

  // center search
  $("search").addEventListener("input",(e)=>{
    STATE.ui.search = e.target.value;
    saveState();
    render();
  });

  // editor actions
  $("btnSave").onclick = ()=>{ if(upsertFromEditor()) render(); };
  $("btnNew").onclick = ()=>{
    const r = {
      id: uid(),
      url:"",
      title:"",
      note:"",
      tags:[],
      color:"none",
      deprecated:false,
      createdAt: nowISO(),
      updatedAt: nowISO(),
      hash:""
    };
    STATE.records.unshift(r);
    STATE.ui.selectedId = r.id;
    saveState();
    toast("NEW");
    render();
  };
  $("btnDeprecate").onclick = ()=>{
    if(!STATE.ui.selectedId) return;
    toggleDeprecate(STATE.ui.selectedId);
  };
  $("btnDelete").onclick = ()=>{
    if(!STATE.ui.selectedId) return;
    if(confirm("Delete this record?")){
      deleteRecord(STATE.ui.selectedId);
    }
  };
  $("btnOpen").onclick = ()=>{
    const id=STATE.ui.selectedId;
    const r=STATE.records.find(x=>x.id===id);
    if(r) openUrl(r.url);
  };
  $("btnCopyUrl").onclick = ()=>{
    const r=STATE.records.find(x=>x.id===STATE.ui.selectedId);
    copyText(r?.url||"");
  };
  $("btnCopyLine").onclick = ()=>{
    const r=STATE.records.find(x=>x.id===STATE.ui.selectedId);
    const line = `${(r?.title||"").trim()} | ${(r?.url||"").trim()}`.trim();
    copyText(line);
  };

  // editor fields save on Ctrl/Cmd+S
  window.addEventListener("keydown",(e)=>{
    const k = (e.key||"").toLowerCase();

    if((e.ctrlKey||e.metaKey) && k==="s"){
      e.preventDefault();
      if(upsertFromEditor()) render();
      return;
    }
    if((e.ctrlKey||e.metaKey) && k==="k"){
      e.preventDefault();
      $("search").focus();
      return;
    }
    if($("out").classList.contains("open")){
      if(k==="escape"){ closeOutput(); return; }
      return;
    }

    // list navigation
    if(k==="arrowdown" || k==="arrowup"){
      const rs=getViewRecords();
      if(!rs.length) return;
      const idx=rs.findIndex(r=>r.id===STATE.ui.selectedId);
      let ni = idx<0 ? 0 : idx + (k==="arrowdown"?1:-1);
      ni = clamp(ni,0,rs.length-1);
      selectRecord(rs[ni].id,true);
      return;
    }
    if(k==="enter"){
      const r=STATE.records.find(x=>x.id===STATE.ui.selectedId);
      if(r) openUrl(r.url);
      return;
    }
    if(k==="d"){
      if(STATE.ui.selectedId) toggleDeprecate(STATE.ui.selectedId);
      return;
    }
    if(k==="c"){
      // cycle color
      const r=STATE.records.find(x=>x.id===STATE.ui.selectedId);
      if(!r) return;
      const idx = PALETTE.findIndex(p=>p.id===(r.color||"none"));
      const next = PALETTE[(idx+1) % PALETTE.length].id;
      r.color = next;
      r.updatedAt = nowISO();
      saveState();
      toast("COLOR " + next.toUpperCase());
      render();
      return;
    }
  });

  // export
  $("btnExport").onclick = ()=>{
    const ex = exportText();
    openOutput(ex.text);
    toast("EXPORTED");
  };
  $("btnCopyExport").onclick = ()=>{
    if(!LAST_EXPORT.text){ exportText(); }
    copyText(LAST_EXPORT.text);
  };
  $("btnDownloadJSON").onclick = ()=>{
    const ex = exportText();
    downloadTextFile(ex.filename.replace(/\.\w+$/,".json"), "application/json",
      JSON.stringify({fileId:STATE.fileId, exportedAt:nowISO(), records: scopeRecords($("exportScope").value)}, null, 2)
    );
  };
  $("btnDownloadTXT").onclick = ()=>{
    const ex = exportText();
    downloadTextFile(ex.filename.replace(/\.\w+$/,".txt"), "text/plain", ex.text);
  };

  // output modal buttons
  $("btnOutClose").onclick = ()=>closeOutput();
  $("btnOutCopy").onclick = ()=>copyText($("outArea").value||"");
  $("btnOutDownload").onclick = ()=>{
    const t = $("outArea").value||"";
    const ex = LAST_EXPORT.text ? LAST_EXPORT : exportText();
    downloadTextFile(ex.filename, ex.mime, t);
  };

  // state file i/o
  $("btnStateExport").onclick = ()=>exportStateToFile();
  $("btnStateImport").onclick = ()=>$("fileIn").click();
  $("fileIn").addEventListener("change",(e)=>{
    const f = e.target.files && e.target.files[0];
    if(f) importStateFromFile(f);
    e.target.value="";
  });

  // editor autosave blur
  ["eUrl","eTitle","eNote","eTags"].forEach(id=>{
    $(id).addEventListener("blur", ()=>{
      const r=STATE.records.find(x=>x.id===STATE.ui.selectedId);
      if(!r) return;
      // only save if values differ materially
      const u=($("eUrl").value||"").trim();
      const t=($("eTitle").value||"").trim();
      const n=($("eNote").value||"").trim();
      const g=($("eTags").value||"").trim();
      const same =
        (r.url||"")===(safeURL(u)||r.url||"") &&
        (r.title||"")===(t) &&
        (r.note||"")===(n) &&
        (r.tags||[]).join(", ")===normalizeTags(g).join(", ");
      if(!same){
        upsertFromEditor();
        render();
      }
    });
  });
}

/* ===== init ===== */
buildChips();
bind();

(function hydrateUiFromState(){
  $("filterText").value = STATE.ui.filterText||"";
  $("filterTag").value = STATE.ui.filterTag||"";
  $("filterView").value = STATE.ui.filterView||"all";
  $("filterDup").value = STATE.ui.filterDup||"any";
  $("search").value = STATE.ui.search||"";
  rebuildFilterColorOptions();
  $("filterColor").value = STATE.ui.filterColor||"";
  updateSig();
})();

render();

/* ===========================
   AE/EE/WB SERIALIZATION STAMP
   (mandatory)
=========================== */
/*
AE: KETA_MONO / triage surface / monochrome operational
EE: local-first isolated key; chrono/alpha sort; dedup; export list/md/json/csv; file import/export with real download; deprecate+color
WB: single-file; no network; clipboard + download; keyboard ops

FILE_ID: ${FILE_ID}
ROOM_ID: LINK_TRIAGE
VERSION: 1.0.0
UPDATED_AT: ${new Date().toISOString()}
CHANGELOG:
- v1: chrono/alpha triage with color + deprecate + dedup + export (list/md/json/csv) + state import/export (download)
*/
</script>
</body>
</html>
