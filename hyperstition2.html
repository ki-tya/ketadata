<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KETADATA_SHELL8_OS — HYPERSTITION SURFACE</title>

<style>
:root{
  --bg:#000; --fg:#fff; --muted:#8a8a8a; --line:#222; --line2:#333;
  --top:44px; --bot:34px;

  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  --sans: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

  --ctl-radius:0px;
  --ctl-alpha:0.82;
  --ctl-bg: rgba(0,0,0,var(--ctl-alpha));
  --note-border: rgba(255,255,255,0.72);
}

*{box-sizing:border-box}
html,body{height:100%; margin:0}
body{background:var(--bg); color:var(--fg); font-family:var(--sans); overflow:hidden; user-select:none}

#root{position:fixed; inset:0; background:#000;}
#root.invert{filter:invert(1)}
#stage{position:absolute; inset:0; background:#000}

/* EE: motion layer */
#motion{
  position:absolute; inset:0; pointer-events:none; opacity:0;
  background:repeating-linear-gradient(
    135deg,
    rgba(255,255,255,0.06) 0px,
    rgba(255,255,255,0.06) 1px,
    rgba(0,0,0,0) 12px,
    rgba(0,0,0,0) 22px
  );
  mix-blend-mode:screen;
  transform:translate3d(0,0,0);
}
#motion.run{opacity:0.12; animation:scanflow 2.2s linear infinite}
@keyframes scanflow{0%{transform:translate3d(-80px,60px,0)}100%{transform:translate3d(80px,-60px,0)}}

/* TOP BAR (OS) */
.topbar{
  position:absolute; top:0; left:0; right:0; height:var(--top);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 10px; border-bottom:1px solid var(--line);
  background:linear-gradient(180deg,#070707,#000);
  z-index:50;
}
.brand{
  display:flex; align-items:center; gap:10px;
  font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase;
}
.brand .sq{width:10px;height:10px;border:1px solid var(--fg);background:#000}
.actions{display:flex; align-items:center; gap:8px; font-family:var(--mono); font-size:12px}
.btn{
  background:transparent; color:var(--fg);
  border:1px solid var(--line2);
  padding:6px 10px; font-family:var(--mono); font-size:12px;
  letter-spacing:.08em; text-transform:uppercase; cursor:pointer;
}
.btn:hover{border-color:var(--fg)}
.btn:active{transform:translateY(1px)}
.kbd{border:1px solid var(--line2); padding:2px 6px; color:var(--muted); font-size:11px}
.pill{
  border:1px solid var(--line2);
  padding:2px 6px;
  font-family:var(--mono);
  font-size:10px;
  letter-spacing:.06em;
  text-transform:uppercase;
  color:var(--muted);
}

/* BOTTOM BAR (OS) */
.bottombar{
  position:absolute; left:0; right:0; bottom:0; height:var(--bot);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 10px; border-top:1px solid var(--line);
  background:linear-gradient(0deg,#070707,#000);
  z-index:50; font-family:var(--mono); font-size:11px; color:var(--muted);
}
.toggle{
  border:1px solid var(--line2); background:transparent; color:var(--fg);
  padding:4px 8px; font-family:var(--mono); font-size:11px;
  letter-spacing:.08em; text-transform:uppercase; cursor:pointer;
}
.toggle:hover{border-color:var(--fg)}

/* DRAWER */
.drawer{
  position:absolute; left:0; right:0; bottom:var(--bot);
  height:40%; min-height:240px;
  border-top:1px solid var(--line);
  background:linear-gradient(180deg,#060606,#000);
  display:none; z-index:60;
}
.drawer.open{display:flex; flex-direction:column}
.drawerHead{
  padding:8px 10px; border-bottom:1px solid var(--line);
  font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase;
  display:flex; justify-content:space-between; align-items:center;
}
.drawerBody{padding:10px; min-height:0; flex:1; overflow:auto}
textarea, input, select{
  border:1px solid var(--line2);
  background:#050505;
  color:var(--fg);
  font-family:var(--mono);
  font-size:12px;
  padding:10px;
  line-height:1.35;
  outline:none;
}
textarea{width:100%; resize:vertical; min-height:140px}

/* KETA NOTE */
.ketaIcon{width:16px;height:16px;border:2px solid var(--fg);background:var(--fg);cursor:pointer;}
.ketaIcon.open{background:#000}
.ketaNote{
  position:absolute; top:60px; right:16px;
  width:340px; height:220px;
  display:none; z-index:80; resize:both; overflow:hidden;
  border-radius:var(--ctl-radius);
  background:var(--ctl-bg);
  border:1px solid var(--note-border);
  backdrop-filter: blur(6px);
}
.ketaNote.open{display:flex; flex-direction:column}
.ketaHead{
  padding:8px 10px; border-bottom:1px solid rgba(255,255,255,0.14);
  font-family:var(--mono); font-size:11px; letter-spacing:.14em; text-transform:uppercase;
  display:flex; justify-content:space-between; align-items:center; cursor:move;
}
.ketaBody{padding:10px; min-height:0; flex:1}
.ketaNote textarea{background:#000; color:#fff; border:1px solid rgba(255,255,255,0.22); width:100%; height:100%; resize:none; padding:10px;}
.headBtn{
  background:transparent; color:var(--fg);
  border:1px solid rgba(255,255,255,0.18);
  padding:2px 8px;
  font-family:var(--mono); font-size:12px; letter-spacing:.08em; text-transform:uppercase;
  cursor:pointer;
}
.headBtn:hover{border-color:rgba(255,255,255,0.6)}

/* Toast */
.toast{
  position:absolute; left:12px; top:calc(var(--top) + 12px);
  padding:8px 10px; border:1px solid var(--line2);
  background:rgba(8,8,8,0.82);
  font-family:var(--mono); font-size:11px; letter-spacing:.06em;
  color:var(--fg); display:none; z-index:90;
}

/* OS MAIN */
#os{
  position:absolute;
  top:var(--top);
  bottom:var(--bot);
  left:0; right:0;
  display:flex;
  z-index:10;
}

/* OS SIDEBAR (rooms) */
#sidebar{
  width:260px;
  border-right:1px solid var(--line);
  background:linear-gradient(180deg,#040404,#000);
  display:flex;
  flex-direction:column;
  min-width:0;
}
#sidebarHead{
  height:40px;
  display:flex; align-items:center; justify-content:space-between;
  padding:0 10px;
  border-bottom:1px solid var(--line);
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.10em;
  text-transform:uppercase;
}
#sidebarBody{padding:10px; overflow:auto; min-height:0; flex:1}
.roomItem{
  border:1px solid var(--line2);
  padding:8px 10px;
  cursor:pointer;
  background:rgba(0,0,0,0.35);
  margin-bottom:8px;
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
  display:flex;
  justify-content:space-between;
  gap:10px;
}
.roomItem:hover{border-color:var(--fg)}
.roomItem.sel{border-color:var(--fg)}
.roomItem .meta{color:var(--muted); font-size:10px; letter-spacing:.06em}

/* OS WORKSPACE */
#workspace{
  flex:1;
  display:flex;
  min-width:0;
  background:linear-gradient(180deg,#020202,#000);
}

/* HYPERSTITION SURFACE (same visual as before) */
#hyperSurface{
  position:relative;
  flex:1;
  display:grid;
  grid-template-columns: 360px 1fr;
  min-width:0;
}
.panel{
  min-width:0;
  display:flex;
  flex-direction:column;
}
.panel.left{border-right:1px solid var(--line); background:linear-gradient(180deg,#040404,#000);}
.panel.right{border-left:1px solid var(--line); background:linear-gradient(180deg,#020202,#000);}
.pHead{
  height:40px;
  display:flex; align-items:center; justify-content:space-between;
  padding:0 10px;
  border-bottom:1px solid var(--line);
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.10em;
  text-transform:uppercase;
}
.pBody{flex:1; overflow:auto; padding:10px; min-height:0}
.sep{height:1px; background:var(--line); margin:10px 0}
.small{font-size:11px; color:var(--muted); font-family:var(--mono); letter-spacing:.06em}
.tag{
  display:inline-flex; align-items:center; gap:8px;
  border:1px solid var(--line2);
  padding:4px 8px;
  font-family:var(--mono); font-size:11px;
  letter-spacing:.08em; text-transform:uppercase;
  color:var(--muted);
}
.dot{width:10px; height:10px; border:1px solid var(--fg); background:#000}
.dot.fill{background:var(--fg)}

.item{
  border:1px solid var(--line2);
  padding:8px 10px;
  cursor:pointer;
  background:rgba(0,0,0,0.4);
  margin-bottom:8px;
}
.item:hover{border-color:var(--fg)}
.item.sel{border-color:var(--fg)}
.itemTitle{
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.08em;
  text-transform:uppercase;
  display:flex; justify-content:space-between; gap:10px;
}
.itemMeta{margin-top:6px; display:flex; gap:8px; flex-wrap:wrap}
.table{
  width:100%;
  border-collapse:collapse;
  font-family:var(--mono);
  font-size:11px;
  color:var(--fg);
}
.table th,.table td{
  border:1px solid var(--line2);
  padding:6px 8px;
  vertical-align:top;
}
.table th{
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:.08em;
  font-weight:600;
}
.rightAlign{text-align:right}
.grid2{display:grid; grid-template-columns: 1fr 1fr; gap:8px}
.grid1{display:grid; grid-template-columns: 1fr; gap:8px}
.label{
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.10em;
  text-transform:uppercase;
  color:var(--muted);
  margin-bottom:6px;
}
.field textarea{min-height:70px; resize:vertical}
.field input{width:100%; padding:8px 10px}
.field textarea{width:100%}

/* Collapsible blocks */
.block{border:1px solid var(--line2); margin-bottom:10px;}
.blockHead{
  display:flex; justify-content:space-between; align-items:center;
  padding:8px 10px;
  border-bottom:1px solid var(--line);
  cursor:pointer;
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.10em;
  text-transform:uppercase;
}
.blockHead:hover{border-bottom-color:var(--fg)}
.blockBody{padding:10px; display:block}
.block.collapsed .blockBody{display:none}
.block.collapsed .blockHead{border-bottom:none}

/* Fullscreen (collapse all controls) */
#root.fullscreenUi .topbar,
#root.fullscreenUi .bottombar,
#root.fullscreenUi #sidebar{
  display:none !important;
}
#root.fullscreenUi #os{top:0; bottom:0;}
#root.fullscreenUi .drawer{display:none !important;}
#root.fullscreenUi .ketaNote{display:none !important;}
#root.fullscreenUi #hyperSurface{grid-template-columns: 0px 1fr;}
#root.fullscreenUi .panel.left{display:none !important;}
#root.fullscreenUi .panel.right{border-left:none;}
#root.fullscreenUi .pHead{display:none !important;}
#root.fullscreenUi .pBody{padding:14px;}
</style>
</head>

<body>
<div id="root">
  <div id="stage" aria-hidden="true"></div>
  <div id="motion" aria-hidden="true"></div>
  <div class="toast" id="toast"></div>

  <!-- TOPBAR -->
  <div class="topbar" id="topbar">
    <div style="display:flex; gap:10px; align-items:center">
      <div class="brand">
        <span class="sq"></span>
        <span>SHELL8 // OS</span>
        <span style="color:var(--muted); letter-spacing:.02em; text-transform:none">hyperstition surface</span>
      </div>
      <div class="pill" title="Active room / surface">ROOM <span id="roomName">OS</span></div>
      <div class="pill" title="Surface">SURFACE <span id="surfaceName">HYPERSTITION</span></div>
    </div>

    <div class="actions">
      <button class="btn" id="btnImport">IMPORT</button>
      <button class="btn" id="btnExport">EXPORT</button>
      <button class="btn" id="btnCopy">COPY</button>
      <button class="btn" id="btnFull">FULL</button>
      <span class="kbd" title="Invert all colors">Shift+I</span>
      <span class="kbd" title="Select light preset">1–6</span>
      <span class="kbd" title="Transport (light+motion)">Space</span>
      <span class="kbd" title="Fullscreen UI toggle">F</span>
      <div id="ketaIcon" class="ketaIcon" title="KETA_NOTE"></div>
    </div>
  </div>

  <!-- DRAWER -->
  <div class="drawer" id="drawer">
    <div class="drawerHead">
      <div>OS SYSTEM</div>
      <div style="display:flex; gap:8px; align-items:center">
        <span id="sig" style="color:var(--muted); font-family:var(--mono); font-size:11px">∅</span>
        <button class="btn" id="btnCopyDrawer">COPY</button>
        <button class="btn" id="btnCloseDrawer">CLOSE</button>
      </div>
    </div>
    <div class="drawerBody">
      <textarea id="universals" placeholder="LAWS / CONSTRAINTS / REFERENCES"></textarea>

      <div style="margin-top:10px; border-top:1px solid var(--line); padding-top:10px">
        <div class="tag"><span class="dot fill"></span><span>CONTROLS COLLAPSIBLE</span></div>
        <div class="sep"></div>

        <div class="grid2">
          <div class="field">
            <div class="label">ACTIVE ROOM</div>
            <input id="roomInput" placeholder="e.g. VAULT / LAB / BASEMENT" />
          </div>
          <div class="field">
            <div class="label">ROOM URL</div>
            <input id="roomUrlInput" placeholder="optional: ketadata.com/vault/index.html" />
          </div>
        </div>

        <div style="margin-top:8px; display:flex; gap:8px; align-items:center">
          <button class="btn" id="btnSavePreset">SAVE PRESET</button>
          <button class="btn" id="btnSetActive">SET ACTIVE</button>
          <button class="btn" id="btnDeletePreset">DELETE</button>
        </div>

        <div style="margin-top:10px; border-top:1px solid var(--line); padding-top:10px">
          <div class="label">ROOM PRESETS</div>
          <div id="roomList"></div>
          <div class="small">CLICK = LOAD. DOUBLE CLICK = SET ACTIVE.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- OS MAIN -->
  <div id="os">
    <!-- Sidebar (rooms) -->
    <div id="sidebar">
      <div id="sidebarHead">
        <div>ROOMS</div>
        <div style="display:flex; gap:8px; align-items:center">
          <button class="btn" id="btnDrawer">SYSTEM</button>
          <button class="btn" id="btnCollapsePanels" title="Collapse/expand all panels">PANELS</button>
        </div>
      </div>
      <div id="sidebarBody">
        <div class="roomItem sel" data-room="OS">
          <div>OS</div><div class="meta">ACTIVE</div>
        </div>
        <div class="roomItem" data-room="VAULT"><div>VAULT</div><div class="meta">PRESET</div></div>
        <div class="roomItem" data-room="LAB"><div>LAB</div><div class="meta">PRESET</div></div>
        <div class="roomItem" data-room="BASEMENT"><div>BASEMENT</div><div class="meta">PRESET</div></div>
        <div class="roomItem" data-room="OBSERVATORY"><div>OBSERVATORY</div><div class="meta">PRESET</div></div>
        <div class="sep"></div>
        <div class="small">
          THIS SIDEBAR IS OS NAV. ROOM PRESETS ARE STORED IN STATE AND CONTROLLED IN SYSTEM DRAWER.
        </div>
      </div>
    </div>

    <!-- Workspace -->
    <div id="workspace">
      <!-- Hyperstition surface -->
      <div id="hyperSurface">
        <div class="panel left" id="leftPanel">
          <div class="pHead">
            <div>HYPERSTITIONS</div>
            <div style="display:flex; gap:8px; align-items:center">
              <button class="btn" id="btnNew">NEW</button>
              <button class="btn" id="btnLeft" title="Collapse left panel">LEFT</button>
            </div>
          </div>
          <div class="pBody">
            <div style="display:flex; justify-content:space-between; gap:8px; align-items:center">
              <div class="tag"><span class="dot fill"></span><span>STATE-DRIVEN</span></div>
              <div class="tag"><span>TRACES</span><span id="traceCount">0</span></div>
            </div>

            <div class="sep"></div>

            <input id="search" placeholder="FILTER (ID / TITLE / TAG)" style="width:100%; padding:8px 10px" />

            <div class="sep"></div>

            <div id="list"></div>
          </div>
        </div>

        <div class="panel right" id="rightPanel">
          <div class="pHead">
            <div id="editorTitle">SELECT</div>
            <div style="display:flex; gap:8px; align-items:center">
              <button class="btn" id="btnTrace">TRACE</button>
              <button class="btn" id="btnDecay">DECAY</button>
              <button class="btn" id="btnDelete">DELETE</button>
              <button class="btn" id="btnRight" title="Collapse editor header">RIGHT</button>
            </div>
          </div>
          <div class="pBody" id="editor">
            <div class="small">NO SELECTION. NEW CREATES A SPEC. TRACE IS THE ONLY RELIGION HERE.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- BOTTOMBAR -->
  <div class="bottombar" id="bottombar">
    <div style="display:flex; gap:10px; align-items:center">
      <button class="toggle" id="toggleDrawer">SYSTEM</button>
      <button class="toggle" id="toggleNote">NOTE</button>
      <span>STATE: <span id="sig2">∅</span></span>
    </div>
    <div style="display:flex; gap:12px; align-items:center">
      <span>LIGHT: <span id="lightLabel">1</span></span>
      <span>RUN: <span id="runLabel">OFF</span></span>
      <span>MOTION: <span id="motionLabel">OFF</span></span>
      <span>UI: <span id="uiLabel">ON</span></span>
    </div>
  </div>

  <!-- KETA NOTE -->
  <div class="ketaNote" id="ketaNote">
    <div class="ketaHead" id="ketaHead">
      <div>KETA_NOTE</div>
      <button class="headBtn" id="btnHideNote">-</button>
    </div>
    <div class="ketaBody">
      <textarea id="ketaText" placeholder="GLOBAL NOTE"></textarea>
    </div>
  </div>

  <input id="file" type="file" accept="application/json" style="display:none" />
</div>

<script>
/* =========================================================
SHELL8 OS — SAME DATA OBJECT + INTENSITY CONTROLS
- Hyperstition payload preserved (spec + trace + decay).
- Controls collapsible (FULL mode or per-panel collapse).
========================================================= */

const FILE_ID = "SHELL8_OS_HYPERSTITION_SURFACE_V1";
const ROOM_ID = "OS";
const VERSION_ID = "shell8.os.hyperstition.v1";
const STORAGE_KEY = `KDT::STATE::${FILE_ID}::${ROOM_ID}::${VERSION_ID}`;

const GLOBAL_KETA_NOTE_KEY = "KDT_GLOBAL_KETA_NOTE_V1";

const DEFAULT = {
  version: "KETADATA_SHELL_KERNEL_v1",
  updatedAt: new Date().toISOString(),

  // OS layer
  os: {
    activeRoom: "OS",
    activeRoomUrl: "",
    fullscreenUi: false,
    panelsCollapsed: false,
    leftCollapsed: false,
    rightHeaderCollapsed: false,
  },

  // universals
  universals: [
"SHELL8 OS — HYPERSTITION SURFACE",
"",
"HYPERSTITION (SHELL-NORMALIZED)",
"- SELF-REINFORCING STATE TRAJECTORY INCREASED BY ITS OWN EXECUTION TRACES.",
"- NO BELIEF SURFACE. ONLY STATE + TRACE + FEEDBACK.",
"- VALID IFF: EXECUTES → MODIFIES STATE → INCREASES LIKELIHOOD OF FURTHER EXECUTION → PERSISTS.",
"",
"CONTROLS:",
"- ALL CONTROLS COLLAPSIBLE (FULL = TRUE FULLSCREEN EXPERIENCE).",
"- INTENSITY: 1–6 LIGHT PRESETS, Shift+I INVERT, Space TRANSPORT, MOTION TOGGLE VIA TRANSPORT.",
"",
"ROOM PRESETS:",
"- STORED IN payload.roomPresets[]",
"- ACTIVE ROOM IS os.activeRoom/os.activeRoomUrl"
  ].join("\n"),

  ketaNote: "",

  ketaNoteMeta: {
    version: "KETA_NOTE_META_v1",
    noteId: "GLOBAL",
    roomId: "OS",
    stateId: null,
    categoryIds: ["HYPERSTITION","OS"],
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  },

  ui: {
    invert:false,
    lightPreset: 1,
    lightRunning: false,
    motionOn: false,
    selectedId: null,
    filter: ""
  },

  payload: {
    roomPresets: [
      { room:"VAULT", roomUrl:"", createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() },
      { room:"LAB", roomUrl:"", createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() },
      { room:"BASEMENT", roomUrl:"", createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() },
      { room:"OBSERVATORY", roomUrl:"", createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() }
    ],
    hyperstitions: [],
    traces: []
  }
};

let STATE = loadLocal() || structuredClone(DEFAULT);
{ const g = loadGlobalKetaNote(); if(g !== "") STATE.ketaNote = g; }

const $ = (id)=>document.getElementById(id);
const root = $("root");
const stage = $("stage");
const motion = $("motion");

function nowISO(){ return new Date().toISOString(); }
function uid(prefix="HYP"){ return `${prefix}_${Math.random().toString(16).slice(2,10).toUpperCase()}`; }

function loadGlobalKetaNote(){ try{ return localStorage.getItem(GLOBAL_KETA_NOTE_KEY) ?? ""; }catch(e){ return ""; } }
function saveGlobalKetaNote(text){ try{ localStorage.setItem(GLOBAL_KETA_NOTE_KEY, String(text ?? "")); }catch(e){} }

function stableSig(){
  const core = JSON.stringify({
    v:STATE.version,
    room:STATE.os?.activeRoom,
    i:STATE.ui.invert,
    p:STATE.ui.lightPreset,
    r:STATE.ui.lightRunning,
    m:STATE.ui.motionOn,
    fs:STATE.os?.fullscreenUi,
    l:(STATE.payload?.hyperstitions||[]).length,
    t:(STATE.payload?.traces||[]).length
  });
  let h=2166136261;
  for(let i=0;i<core.length;i++){ h^=core.charCodeAt(i); h=Math.imul(h,16777619); }
  return (h>>>0).toString(16).slice(0,8);
}

function ensureKetaNoteMeta(){
  if(!STATE.ketaNoteMeta || typeof STATE.ketaNoteMeta !== "object"){
    STATE.ketaNoteMeta = structuredClone(DEFAULT.ketaNoteMeta);
  }else{
    STATE.ketaNoteMeta = Object.assign(structuredClone(DEFAULT.ketaNoteMeta), STATE.ketaNoteMeta);
  }
}
function syncKetaNoteMeta(reason){
  ensureKetaNoteMeta();
  const room = (STATE.os?.activeRoom || "OS").trim().toUpperCase();
  const stateId = stableSig();
  STATE.ketaNoteMeta.roomId = room;
  STATE.ketaNoteMeta.stateId = stateId;
  STATE.ketaNoteMeta.updatedAt = nowISO();
  if(reason) STATE.ketaNoteMeta._last = { reason, at: STATE.ketaNoteMeta.updatedAt };
}

/* WB ▸ STATE IO */
function mergeDefault(obj){
  const out = structuredClone(DEFAULT);
  Object.assign(out, obj||{});

  out.os = Object.assign(structuredClone(DEFAULT.os), (obj&&obj.os)||{});
  out.ui = Object.assign(structuredClone(DEFAULT.ui), (obj&&obj.ui)||{});
  out.payload = Object.assign(structuredClone(DEFAULT.payload), (obj&&obj.payload)||{});

  if(!Array.isArray(out.payload.roomPresets)) out.payload.roomPresets = [];
  if(!Array.isArray(out.payload.hyperstitions)) out.payload.hyperstitions = [];
  if(!Array.isArray(out.payload.traces)) out.payload.traces = [];

  if(obj && obj.ketaNoteMeta){
    out.ketaNoteMeta = Object.assign(structuredClone(DEFAULT.ketaNoteMeta), obj.ketaNoteMeta);
  }

  return out;
}
function loadLocal(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    return mergeDefault(JSON.parse(raw));
  }catch(e){ return null; }
}
function persist(){
  STATE.updatedAt = nowISO();
  syncKetaNoteMeta("persist");
  saveGlobalKetaNote(STATE.ketaNote || "");
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE)); }catch(e){}
  render();
}
function exportState(){
  syncKetaNoteMeta("export");
  return JSON.stringify({ STORAGE_KEY, FILE_ID, ROOM_ID, VERSION_ID, STATE }, null, 2);
}
function importState(text){
  const parsed = JSON.parse(text);
  const incoming = parsed && parsed.STATE ? parsed.STATE : parsed;
  STATE = mergeDefault(incoming);

  saveGlobalKetaNote(STATE.ketaNote || "");

  stopLight(true);
  if(STATE.ui.lightRunning) startLight(STATE.ui.lightPreset);

  syncKetaNoteMeta("import");
  persist();
}

/* Toast */
let toastTimer=null;
function toast(msg){
  const t=$("toast");
  t.textContent=msg;
  t.style.display="block";
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>{ t.style.display="none"; }, 900);
}

/* =========================================================
EE ▸ INTENSITY CONTROLS (INVERT / LIGHTS / TRANSPORT)
========================================================= */
function setInvert(on){ STATE.ui.invert = !!on; persist(); }

let lightInterval=null;
let lightCount=0, lightAuxA=0, lightAuxB=0;

function resetStage(){
  stage.style.backgroundColor="#000000";
  stage.style.filter="none";
  lightCount=0; lightAuxA=0; lightAuxB=0;
}
function startLight(preset){
  stopLight(true);
  resetStage();
  STATE.ui.lightPreset=preset;
  STATE.ui.lightRunning=true;

  if(preset===1){
    lightInterval=setInterval(()=>{
      const curr=stage.style.backgroundColor||"black";
      stage.style.backgroundColor=(curr==="black"||curr==="rgb(0, 0, 0)") ? "white" : "black";
      stage.style.filter="none";
    },50);
  }
  if(preset===2){
    lightInterval=setInterval(()=>{
      lightAuxA=(lightAuxA+30)%360;
      lightAuxB+=0.5;
      const lightness=50+Math.sin(lightAuxB)*40;
      stage.style.backgroundColor=`hsl(${lightAuxA}, 100%, ${lightness}%)`;
      stage.style.filter="none";
    },10);
  }
  if(preset===3){
    lightInterval=setInterval(()=>{
      lightCount++;
      const beat=lightCount%16;
      if(beat===0||beat===1){ stage.style.backgroundColor="#ffffff"; stage.style.filter="invert(1) contrast(3) brightness(2)"; }
      else if(beat===2){ stage.style.backgroundColor="#000000"; stage.style.filter="invert(1) contrast(2)"; }
      else if(beat===3){ stage.style.backgroundColor="#00ff00"; stage.style.filter="contrast(2) saturate(3)"; }
      else if(beat===4){ stage.style.backgroundColor="#ff00ff"; stage.style.filter="invert(1) hue-rotate(90deg)"; }
      else if(beat===5||beat===6){ stage.style.backgroundColor="#00ffff"; stage.style.filter="invert(0.7) contrast(2)"; }
      else if(beat===7){ stage.style.backgroundColor="#ffffff"; stage.style.filter="invert(1) brightness(3)"; }
      else if(beat===8){ stage.style.backgroundColor="#000000"; stage.style.filter="invert(1) contrast(3)"; }
      else if(beat===9||beat===10){ stage.style.backgroundColor="#00ff00"; stage.style.filter="saturate(5) contrast(2)"; }
      else if(beat===11){ stage.style.backgroundColor="#ff00ff"; stage.style.filter="invert(1) saturate(3)"; }
      else { stage.style.backgroundColor="#0088ff"; stage.style.filter="contrast(1.5) brightness(1.2)"; }
    },30);
  }
  if(preset===4){
    lightInterval=setInterval(()=>{
      lightAuxA+=0.08; lightCount++;
      const red=Math.abs(Math.sin(lightAuxA))*255;
      const pulse=Math.abs(Math.sin(lightAuxA*0.5));
      const contrast=2+pulse*2;
      const saturation=4+pulse*2;
      if(lightCount%8===0){ stage.style.backgroundColor="#000000"; stage.style.filter="brightness(3) contrast(3)"; }
      else if(lightCount%8===1){
        stage.style.backgroundColor=`rgb(${red},0,0)`;
        stage.style.filter=`contrast(${contrast+1}) saturate(${saturation+2}) brightness(${1.5+pulse*0.5})`;
      } else {
        stage.style.backgroundColor=`rgb(${red},0,0)`;
        stage.style.filter=`contrast(${contrast}) saturate(${saturation}) brightness(${1.2+pulse*0.5})`;
      }
    },20);
  }
  if(preset===5){
    lightInterval=setInterval(()=>{
      lightAuxA+=15; lightAuxB=(lightAuxB+2)%100;
      const hue=260+Math.sin(lightAuxA*0.1)*40;
      const saturation=80+Math.cos(lightAuxA*0.05)*20;
      const lightness=30+Math.sin(lightAuxB*0.1)*30;
      const spiralBrightness=1+Math.abs(Math.sin(lightAuxA*0.05))*0.8;
      const spiralContrast=1.5+Math.abs(Math.cos(lightAuxA*0.08))*1;
      stage.style.backgroundColor=`hsl(${hue}, ${saturation}%, ${lightness}%)`;
      stage.style.filter=`contrast(${spiralContrast}) saturate(2) brightness(${spiralBrightness}) hue-rotate(${lightAuxA*0.5}deg)`;
    },25);
  }
  if(preset===6){
    lightInterval=setInterval(()=>{
      lightCount++;
      if(lightCount%50===0){ stage.style.backgroundColor="#ffffff"; stage.style.filter="brightness(5) contrast(5)"; }
      else if(lightCount%50===1){ stage.style.backgroundColor="#000000"; stage.style.filter="none"; }
      else if(lightCount%50===2){ stage.style.backgroundColor="#ffffff"; stage.style.filter="brightness(5) contrast(5)"; }
      else { stage.style.backgroundColor="#000000"; stage.style.filter="none"; }
    },30);
  }

  persist();
}
function stopLight(silent=false){
  if(lightInterval){ clearInterval(lightInterval); lightInterval=null; }
  STATE.ui.lightRunning=false;
  resetStage();
  if(!silent) persist();
}
function selectPreset(preset){
  STATE.ui.lightPreset=preset;
  if(STATE.ui.lightRunning) startLight(preset);
  else persist();
}
function toggleTransport(){
  if(STATE.ui.lightRunning) stopLight(true);
  else startLight(STATE.ui.lightPreset);

  STATE.ui.motionOn = !STATE.ui.motionOn;
  toast(`TRANSPORT ${STATE.ui.lightRunning ? "ON" : "OFF"} / MOTION ${STATE.ui.motionOn ? "ON" : "OFF"}`);
  persist();
}

/* =========================================================
WB ▸ ROOM PRESETS (OS INTEGRATED)
========================================================= */
function ensureRoomPresets(){
  if(!STATE.payload) STATE.payload = {};
  if(!Array.isArray(STATE.payload.roomPresets)) STATE.payload.roomPresets = [];
}
function canonRoomName(name){ return String(name||"").trim().toUpperCase(); }
function upsertRoomPreset(roomName, url){
  ensureRoomPresets();
  const room = canonRoomName(roomName) || "OS";
  const roomUrl = String(url||"").trim();
  const idx = STATE.payload.roomPresets.findIndex(r => canonRoomName(r.room)===room);
  const preset = { room, roomUrl, updatedAt: nowISO() };
  if(idx>=0) STATE.payload.roomPresets[idx] = Object.assign({}, STATE.payload.roomPresets[idx], preset);
  else STATE.payload.roomPresets.unshift(Object.assign({ createdAt: nowISO() }, preset));
}
function deleteRoomPreset(roomName){
  ensureRoomPresets();
  const room = canonRoomName(roomName);
  if(!room) return;
  STATE.payload.roomPresets = STATE.payload.roomPresets.filter(r => canonRoomName(r.room)!==room);
}
function loadPresetToFields(roomName){
  ensureRoomPresets();
  const room = canonRoomName(roomName);
  const preset = STATE.payload.roomPresets.find(r => canonRoomName(r.room)===room);
  if(!preset) return;
  $("roomInput").value = preset.room || "";
  $("roomUrlInput").value = preset.roomUrl || "";
}
function setActiveRoom(roomName, url){
  STATE.os.activeRoom = canonRoomName(roomName) || "OS";
  STATE.os.activeRoomUrl = String(url||"").trim();
}
function renderRoomList(){
  const el = $("roomList");
  if(!el) return;
  ensureRoomPresets();

  const presets = STATE.payload.roomPresets.slice().sort((a,b)=>{
    const ta = Date.parse(a.updatedAt || a.createdAt || 0);
    const tb = Date.parse(b.updatedAt || b.createdAt || 0);
    return tb - ta;
  });

  el.innerHTML = "";
  if(!presets.length){
    const empty = document.createElement("div");
    empty.className="roomItem";
    empty.style.cursor="default";
    empty.textContent="NO PRESETS";
    el.appendChild(empty);
    return;
  }

  presets.forEach(p=>{
    const row = document.createElement("div");
    row.className = "roomItem" + (canonRoomName(STATE.os.activeRoom)===canonRoomName(p.room) ? " sel" : "");
    row.innerHTML = `<div>${escapeHtml(p.room || "ROOM")}</div><div class="meta">${(p.roomUrl && p.roomUrl.trim()) ? "URL" : "NO URL"}</div>`;
    row.addEventListener("click", ()=>{ loadPresetToFields(p.room); toast("PRESET LOADED"); });
    row.addEventListener("dblclick", ()=>{ setActiveRoom(p.room, p.roomUrl); toast("ACTIVE ROOM SET"); persist(); });
    el.appendChild(row);
  });
}

/* =========================================================
EE ▸ HYPERSTITION DATA OBJECT (SAME)
========================================================= */
function computeScore(m){
  const exec = Math.max(0, m.executions|0);
  const rein = Math.max(0, Math.round((+m.reinforcement||0)*100)/100);
  const s = exec + rein * 2.5;
  return Math.round(s * 100) / 100;
}
function normalizeHyper(h){
  const base = {
    id: h.id || uid("HYP"),
    title: (h.title || "UNTITLED").toUpperCase(),
    tags: Array.isArray(h.tags) ? h.tags.slice(0,12).map(x=>String(x||"").toUpperCase()).filter(Boolean) : [],
    thesis: String(h.thesis||""),
    executionSurface: String(h.executionSurface||"SHELL"),
    reinforcementVector: String(h.reinforcementVector||"TRACE → PROBABILITY SHIFT"),
    signals: String(h.signals||""),
    decayCondition: String(h.decayCondition||"NO TRACES IN 7D ⇒ DECAY"),
    status: String(h.status||"ACTIVE").toUpperCase(),
    collapsed: !!h.collapsed,
    metrics: Object.assign({
      createdAt: h.metrics?.createdAt || nowISO(),
      updatedAt: nowISO(),
      executions: Number.isFinite(h.metrics?.executions) ? h.metrics.executions : 0,
      reinforcement: Number.isFinite(h.metrics?.reinforcement) ? h.metrics.reinforcement : 0,
      lastTraceAt: h.metrics?.lastTraceAt || null
    }, h.metrics||{})
  };
  base.metrics.score = computeScore(base.metrics);
  return base;
}
function ensurePayload(){
  if(!STATE.payload) STATE.payload = structuredClone(DEFAULT.payload);
  if(!Array.isArray(STATE.payload.hyperstitions)) STATE.payload.hyperstitions = [];
  if(!Array.isArray(STATE.payload.traces)) STATE.payload.traces = [];
  ensureRoomPresets();
  STATE.payload.hyperstitions = STATE.payload.hyperstitions.map(normalizeHyper);
}
function getSelected(){
  const id = STATE.ui.selectedId;
  if(!id) return null;
  return STATE.payload.hyperstitions.find(h=>h.id===id) || null;
}
function select(id){ STATE.ui.selectedId = id || null; persist(); }
function addHyper(){
  ensurePayload();
  const h = normalizeHyper({
    id: uid("HYP"),
    title: "NEW TRAJECTORY",
    tags: ["STATE","TRACE"],
    thesis: "A SPECULATIVE STATE THAT GAINS PROBABILITY THROUGH ITS OWN EXECUTION TRACES.",
    executionSurface: "OS / SHELL / ROUTINE",
    reinforcementVector: "TRACE LOGGING + UI AFFORDANCE + NAMING LOCK",
    signals: "METRICS: EXECUTIONS ↑, REINFORCEMENT ↑, REPEAT RATE ↑",
    decayCondition: "NO TRACE EVENTS ⇒ DECAY TICKS DRIVE SCORE DOWN",
    status: "ACTIVE"
  });
  STATE.payload.hyperstitions.unshift(h);
  STATE.ui.selectedId = h.id;
  toast("NEW HYPERSTITION");
  persist();
}
function deleteSelected(){
  const h = getSelected();
  if(!h) return;
  STATE.payload.hyperstitions = STATE.payload.hyperstitions.filter(x=>x.id!==h.id);
  STATE.payload.traces.push({ at: nowISO(), type:"DELETE", hyperId:h.id, delta:0, note:`DELETED ${h.title}` });
  STATE.ui.selectedId = STATE.payload.hyperstitions[0]?.id || null;
  toast("DELETED");
  persist();
}
function updateSelected(patch){
  const h = getSelected();
  if(!h) return;
  Object.assign(h, patch||{});
  h.metrics.updatedAt = nowISO();
  h.metrics.score = computeScore(h.metrics);
  persist();
}
function addTrace(delta=1, note=""){
  const h = getSelected();
  if(!h) return;
  const d = Number(delta);
  const dd = Number.isFinite(d) ? d : 1;

  h.metrics.executions += 1;
  h.metrics.reinforcement = Math.max(0, (+h.metrics.reinforcement||0) + dd);
  h.metrics.lastTraceAt = nowISO();
  h.metrics.updatedAt = nowISO();
  h.metrics.score = computeScore(h.metrics);

  STATE.payload.traces.push({ at:h.metrics.lastTraceAt, type:"TRACE", hyperId:h.id, delta:dd, note:String(note||"").slice(0,240) });
  toast("TRACE LOGGED");
  persist();
}
function decayTickAll(){
  ensurePayload();
  for(const h of STATE.payload.hyperstitions){
    if(h.status === "ARCHIVED") continue;
    const last = h.metrics.lastTraceAt ? Date.parse(h.metrics.lastTraceAt) : 0;
    const ageHrs = last ? (Date.now() - last) / (1000*60*60) : 999999;
    const k = Math.min(1.5, Math.max(0.2, ageHrs / 72));
    const dec = 0.15 * k;

    h.metrics.reinforcement = Math.max(0, (+h.metrics.reinforcement||0) - dec);
    h.metrics.updatedAt = nowISO();
    h.metrics.score = computeScore(h.metrics);

    STATE.payload.traces.push({ at:h.metrics.updatedAt, type:"DECAY", hyperId:h.id, delta:-Math.round(dec*100)/100, note:`DECAY TICK k=${Math.round(k*100)/100}` });
  }
  toast("DECAY APPLIED");
  persist();
}

/* =========================================================
RENDER
========================================================= */
function escapeHtml(s){
  return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}
function escapeAttr(s){ return escapeHtml(s).replaceAll('"',"&quot;"); }

function renderList(){
  ensurePayload();
  const q = String(STATE.ui.filter||"").trim().toUpperCase();
  const list = $("list");
  list.innerHTML = "";

  let items = STATE.payload.hyperstitions.slice();
  items.sort((a,b)=>{
    const sa = +a.metrics.score||0, sb = +b.metrics.score||0;
    if(sb !== sa) return sb - sa;
    return Date.parse(b.metrics.updatedAt||0) - Date.parse(a.metrics.updatedAt||0);
  });

  if(q){
    items = items.filter(h=>{
      const hay = [h.id,h.title,(h.tags||[]).join(" "),h.status,h.executionSurface,h.reinforcementVector].join(" ").toUpperCase();
      return hay.includes(q);
    });
  }

  for(const h of items){
    const div = document.createElement("div");
    div.className = "item" + (STATE.ui.selectedId===h.id ? " sel" : "");
    div.addEventListener("click", ()=>select(h.id));

    const last = h.metrics.lastTraceAt ? new Date(h.metrics.lastTraceAt).toLocaleString() : "∅";
    div.innerHTML = `
      <div class="itemTitle">
        <span>${escapeHtml(h.title)}</span>
        <span class="pill">SCORE ${escapeHtml(String(h.metrics.score))}</span>
      </div>
      <div class="itemMeta">
        <span class="pill">${escapeHtml(h.id)}</span>
        <span class="pill">EXEC ${escapeHtml(String(h.metrics.executions|0))}</span>
        <span class="pill">REINF ${escapeHtml(String(Math.round((+h.metrics.reinforcement||0)*100)/100))}</span>
        <span class="pill">LAST ${escapeHtml(last)}</span>
        <span class="pill">${escapeHtml(h.status)}</span>
      </div>
    `;
    list.appendChild(div);
  }
}

function renderTraceTable(hyperId){
  const traces = (STATE.payload.traces||[]).filter(t=>t.hyperId===hyperId).slice(-200).reverse();
  if(!traces.length) return `<div class="small">NO TRACES.</div>`;

  const rows = traces.map(t=>{
    const dt = new Date(t.at).toLocaleString();
    const delta = (t.delta>=0?"+":"") + String(t.delta);
    return `<tr>
      <td>${escapeHtml(dt)}</td>
      <td>${escapeHtml(String(t.type||""))}</td>
      <td class="rightAlign">${escapeHtml(delta)}</td>
      <td>${escapeHtml(String(t.note||""))}</td>
    </tr>`;
  }).join("");

  return `
    <table class="table">
      <tr><th>AT</th><th>TYPE</th><th class="rightAlign">DELTA</th><th>NOTE</th></tr>
      ${rows}
    </table>
  `;
}

function renderEditor(){
  const ed = $("editor");
  const h = getSelected();
  $("editorTitle").textContent = h ? h.title : "SELECT";

  if(!h){
    ed.innerHTML = `<div class="small">NO SELECTION. NEW CREATES A SPEC. TRACE IS THE ONLY RELIGION HERE.</div>`;
    return;
  }

  const blocksCollapsed = !!STATE.os.panelsCollapsed;

  ed.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px">
      <div class="tag"><span class="dot fill"></span><span>ID</span><span>${escapeHtml(h.id)}</span></div>
      <div class="tag"><span>STATUS</span>
        <select id="statusSel" style="background:#000; color:#fff; border:1px solid var(--line2); font-family:var(--mono); padding:4px 8px">
          ${["ACTIVE","DORMANT","ARCHIVED"].map(s=>`<option ${h.status===s?"selected":""}>${s}</option>`).join("")}
        </select>
      </div>
    </div>

    <div class="block ${(h.collapsed || blocksCollapsed) ? "collapsed" : ""}" data-block="SPEC">
      <div class="blockHead" data-toggle="SPEC">
        <span>SPEC</span>
        <span class="small">CLICK TO TOGGLE</span>
      </div>
      <div class="blockBody">
        <div class="grid2">
          <div class="field">
            <div class="label">TITLE</div>
            <input id="title" value="${escapeAttr(h.title)}" />
          </div>
          <div class="field">
            <div class="label">TAGS (CSV)</div>
            <input id="tags" value="${escapeAttr((h.tags||[]).join(","))}" />
          </div>
        </div>

        <div class="sep"></div>

        <div class="grid1">
          <div class="field">
            <div class="label">THESIS</div>
            <textarea id="thesis">${escapeHtml(h.thesis)}</textarea>
          </div>
          <div class="field">
            <div class="label">EXECUTION SURFACE</div>
            <input id="surface" value="${escapeAttr(h.executionSurface)}" />
          </div>
          <div class="field">
            <div class="label">REINFORCEMENT VECTOR</div>
            <textarea id="vector">${escapeHtml(h.reinforcementVector)}</textarea>
          </div>
          <div class="field">
            <div class="label">SIGNALS</div>
            <textarea id="signals">${escapeHtml(h.signals)}</textarea>
          </div>
          <div class="field">
            <div class="label">DECAY CONDITION</div>
            <textarea id="decay">${escapeHtml(h.decayCondition)}</textarea>
          </div>
        </div>
      </div>
    </div>

    <div class="block ${blocksCollapsed ? "collapsed" : ""}" data-block="METRICS">
      <div class="blockHead" data-toggle="METRICS">
        <span>METRICS</span>
        <span class="small">TRACE → SCORE</span>
      </div>
      <div class="blockBody">
        <table class="table">
          <tr><th>CREATED</th><td>${escapeHtml(new Date(h.metrics.createdAt).toLocaleString())}</td></tr>
          <tr><th>UPDATED</th><td>${escapeHtml(new Date(h.metrics.updatedAt).toLocaleString())}</td></tr>
          <tr><th>LAST TRACE</th><td>${escapeHtml(h.metrics.lastTraceAt ? new Date(h.metrics.lastTraceAt).toLocaleString() : "∅")}</td></tr>
          <tr><th>EXECUTIONS</th><td class="rightAlign">${escapeHtml(String(h.metrics.executions|0))}</td></tr>
          <tr><th>REINFORCEMENT</th><td class="rightAlign">${escapeHtml(String(Math.round((+h.metrics.reinforcement||0)*100)/100))}</td></tr>
          <tr><th>SCORE</th><td class="rightAlign">${escapeHtml(String(h.metrics.score))}</td></tr>
        </table>

        <div class="sep"></div>

        <div class="grid2">
          <div class="field">
            <div class="label">TRACE DELTA</div>
            <input id="traceDelta" value="1" />
          </div>
          <div class="field">
            <div class="label">TRACE NOTE</div>
            <input id="traceNote" placeholder="OPTIONAL (240c)" />
          </div>
        </div>

        <div style="margin-top:8px; display:flex; justify-content:flex-end">
          <button class="btn" id="btnTraceInline">TRACE</button>
        </div>
      </div>
    </div>

    <div class="block ${blocksCollapsed ? "collapsed" : ""}" data-block="TRACES">
      <div class="blockHead" data-toggle="TRACES">
        <span>TRACE LOG</span>
        <span class="small">FORENSICS</span>
      </div>
      <div class="blockBody">${renderTraceTable(h.id)}</div>
    </div>
  `;

  $("statusSel").addEventListener("change", (e)=>updateSelected({ status: String(e.target.value||"ACTIVE").toUpperCase() }));
  $("title").addEventListener("input", (e)=>updateSelected({ title: String(e.target.value||"").toUpperCase() }));
  $("tags").addEventListener("input", (e)=>{
    const tags = String(e.target.value||"").split(",").map(x=>x.trim().toUpperCase()).filter(Boolean).slice(0,12);
    updateSelected({ tags });
  });
  $("thesis").addEventListener("input", (e)=>updateSelected({ thesis: String(e.target.value||"") }));
  $("surface").addEventListener("input", (e)=>updateSelected({ executionSurface: String(e.target.value||"") }));
  $("vector").addEventListener("input", (e)=>updateSelected({ reinforcementVector: String(e.target.value||"") }));
  $("signals").addEventListener("input", (e)=>updateSelected({ signals: String(e.target.value||"") }));
  $("decay").addEventListener("input", (e)=>updateSelected({ decayCondition: String(e.target.value||"") }));

  $("btnTraceInline").addEventListener("click", ()=>{
    const delta = parseFloat(($("traceDelta").value||"1"));
    const note  = ($("traceNote").value||"");
    addTrace(Number.isFinite(delta)?delta:1, note);
    $("traceNote").value = "";
  });

  const toggles = ed.querySelectorAll("[data-toggle]");
  toggles.forEach(t=>{
    t.addEventListener("click", ()=>{
      const which = t.getAttribute("data-toggle");
      if(which === "SPEC"){
        updateSelected({ collapsed: !getSelected().collapsed });
      }
    });
  });
}

function render(){
  ensurePayload();

  root.classList.toggle("invert", !!STATE.ui.invert);
  motion.classList.toggle("run", !!STATE.ui.motionOn);

  root.classList.toggle("fullscreenUi", !!STATE.os.fullscreenUi);

  $("universals").value = STATE.universals || "";
  $("ketaText").value = STATE.ketaNote || "";

  $("roomName").textContent = (STATE.os.activeRoom || "OS").toUpperCase();

  const s = stableSig();
  $("sig").textContent = s;
  $("sig2").textContent = s;

  $("lightLabel").textContent = String(STATE.ui.lightPreset);
  $("runLabel").textContent = STATE.ui.lightRunning ? "ON" : "OFF";
  $("motionLabel").textContent = STATE.ui.motionOn ? "ON" : "OFF";
  $("uiLabel").textContent = STATE.os.fullscreenUi ? "OFF" : "ON";

  $("traceCount").textContent = String((STATE.payload.traces||[]).length);

  $("search").value = STATE.ui.filter || "";

  $("roomInput").value = STATE.os.activeRoom || "OS";
  $("roomUrlInput").value = STATE.os.activeRoomUrl || "";

  // panel collapse states
  const leftPanel = $("leftPanel");
  if(STATE.os.leftCollapsed || STATE.os.fullscreenUi){
    leftPanel.style.display = "none";
  }else{
    leftPanel.style.display = "";
  }

  const hyperSurface = $("hyperSurface");
  hyperSurface.style.gridTemplateColumns = (STATE.os.leftCollapsed || STATE.os.fullscreenUi) ? "0px 1fr" : "360px 1fr";

  const rightHead = $("rightPanel").querySelector(".pHead");
  rightHead.style.display = (STATE.os.rightHeaderCollapsed || STATE.os.fullscreenUi) ? "none" : "";

  renderRoomList();
  renderList();
  renderEditor();
}

/* =========================================================
UI: Drawer / Note / Fullscreen / Panel collapses
========================================================= */
function setDrawer(open){ $("drawer").classList.toggle("open", !!open); }
function setKetaNote(open){
  $("ketaNote").classList.toggle("open", !!open);
  $("ketaIcon").classList.toggle("open", !!open);
}
function setFullscreenUi(on){
  STATE.os.fullscreenUi = !!on;
  if(STATE.os.fullscreenUi){
    setDrawer(false);
    setKetaNote(false);
  }
  persist();
}

/* =========================================================
WIRING
========================================================= */
$("btnDrawer").addEventListener("click", ()=> setDrawer(true));
$("toggleDrawer").addEventListener("click", ()=> setDrawer(!$("drawer").classList.contains("open")));
$("btnCloseDrawer").addEventListener("click", ()=> setDrawer(false));
$("btnCopyDrawer").addEventListener("click", ()=> copyText(STATE.universals || ""));

$("toggleNote").addEventListener("click", ()=> setKetaNote(!$("ketaNote").classList.contains("open")));
$("ketaIcon").addEventListener("click", ()=> setKetaNote(!$("ketaNote").classList.contains("open")));
$("btnHideNote").addEventListener("click", ()=> setKetaNote(false));

$("universals").addEventListener("input", ()=>{ STATE.universals = $("universals").value; persist(); });
$("ketaText").addEventListener("input", ()=>{ STATE.ketaNote = $("ketaText").value; saveGlobalKetaNote(STATE.ketaNote); persist(); });

$("btnFull").addEventListener("click", ()=> setFullscreenUi(!STATE.os.fullscreenUi));

$("btnCollapsePanels").addEventListener("click", ()=>{
  STATE.os.panelsCollapsed = !STATE.os.panelsCollapsed;
  toast(STATE.os.panelsCollapsed ? "PANELS COLLAPSED" : "PANELS EXPANDED");
  persist();
});

$("btnLeft").addEventListener("click", ()=>{
  STATE.os.leftCollapsed = !STATE.os.leftCollapsed;
  toast(STATE.os.leftCollapsed ? "LEFT COLLAPSED" : "LEFT OPEN");
  persist();
});

$("btnRight").addEventListener("click", ()=>{
  STATE.os.rightHeaderCollapsed = !STATE.os.rightHeaderCollapsed;
  toast(STATE.os.rightHeaderCollapsed ? "RIGHT HEADER COLLAPSED" : "RIGHT HEADER OPEN");
  persist();
});

/* Hyperstition actions */
$("btnNew").addEventListener("click", addHyper);
$("btnDelete").addEventListener("click", deleteSelected);
$("btnTrace").addEventListener("click", ()=> addTrace(1,"TRACE"));
$("btnDecay").addEventListener("click", decayTickAll);

$("search").addEventListener("input", (e)=>{ STATE.ui.filter = String(e.target.value||""); persist(); });

/* Room preset buttons */
$("btnSavePreset").addEventListener("click", ()=>{
  const roomName = $("roomInput").value || "OS";
  const url = $("roomUrlInput").value || "";
  upsertRoomPreset(roomName, url);
  toast("PRESET SAVED");
  persist();
});
$("btnSetActive").addEventListener("click", ()=>{
  const roomName = $("roomInput").value || "OS";
  const url = $("roomUrlInput").value || "";
  upsertRoomPreset(roomName, url);
  setActiveRoom(roomName, url);
  toast("ACTIVE ROOM SET");
  persist();
});
$("btnDeletePreset").addEventListener("click", ()=>{
  const roomName = $("roomInput").value || "";
  if(!roomName.trim()){ toast("NO ROOM"); return; }
  deleteRoomPreset(roomName);
  toast("PRESET DELETED");
  persist();
});

/* Import / Export */
$("btnImport").addEventListener("click", ()=> $("file").click());
$("file").addEventListener("change", async (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const txt = await f.text();
  importState(txt);
  e.target.value = "";
  toast("STATE IMPORTED");
});
$("btnExport").addEventListener("click", ()=>{ download("SHELL8_OS_HYPERSTITION_state.json", exportState()); toast("STATE EXPORTED"); });
$("btnCopy").addEventListener("click", ()=> copyText(exportState()));

function download(filename, text){
  const blob = new Blob([text], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 800);
}
async function copyText(text){
  try{ await navigator.clipboard.writeText(text); toast("COPIED"); }
  catch(e){ toast("COPY FAILED"); }
}

/* Hotkeys */
document.addEventListener("keydown", (e)=>{
  const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
  const typing = (tag==="textarea" || tag==="input" || tag==="select");

  if(e.shiftKey && e.key.toLowerCase()==="i"){
    e.preventDefault();
    setInvert(!STATE.ui.invert);
    toast(STATE.ui.invert ? "INVERT ON" : "INVERT OFF");
    return;
  }

  if(!typing && /^[1-6]$/.test(e.key)){
    e.preventDefault();
    selectPreset(parseInt(e.key,10));
    toast(`LIGHT ${STATE.ui.lightPreset} SELECTED`);
    return;
  }

  if(!typing && (e.code==="Space" || e.key===" ")){
    e.preventDefault();
    toggleTransport();
    return;
  }

  if(!typing && e.key.toLowerCase()==="f"){
    e.preventDefault();
    setFullscreenUi(!STATE.os.fullscreenUi);
    toast(STATE.os.fullscreenUi ? "FULL UI OFF" : "FULL UI ON");
    return;
  }

  if(!typing && e.key.toLowerCase()==="n"){
    e.preventDefault(); addHyper(); return;
  }
  if(!typing && e.key.toLowerCase()==="t"){
    e.preventDefault(); addTrace(1,"TRACE"); return;
  }
  if(!typing && e.key.toLowerCase()==="d"){
    e.preventDefault(); decayTickAll(); return;
  }
  if(!typing && e.key.toLowerCase()==="x"){
    e.preventDefault(); deleteSelected(); return;
  }

  if(e.key==="Escape"){
    setDrawer(false);
    setKetaNote(false);
    if(STATE.os.fullscreenUi){ setFullscreenUi(false); }
    stopLight(true);
    STATE.ui.motionOn = false;
    toast("CLOSED");
    persist();
    return;
  }
});

/* Drag KETA NOTE */
(function dragNote(){
  const box = $("ketaNote");
  const head = $("ketaHead");
  let dragging=false, ox=0, oy=0;

  head.addEventListener("mousedown", (e)=>{
    if(e.target.closest("button")) return;
    dragging=true;
    const r = box.getBoundingClientRect();
    ox = e.clientX - r.left;
    oy = e.clientY - r.top;
    box.style.left = r.left + "px";
    box.style.top  = r.top + "px";
    box.style.right = "auto";
  });
  window.addEventListener("mousemove", (e)=>{
    if(!dragging) return;
    box.style.left = (e.clientX - ox) + "px";
    box.style.top  = (e.clientY - oy) + "px";
  });
  window.addEventListener("mouseup", ()=> dragging=false);
})();

/* Sidebar demo wiring: click room name loads preset fields (if exists) */
document.querySelectorAll(".roomItem[data-room]").forEach(el=>{
  el.addEventListener("click", ()=>{
    const r = el.getAttribute("data-room");
    loadPresetToFields(r);
    toast("ROOM LOADED");
  });
  el.addEventListener("dblclick", ()=>{
    const r = el.getAttribute("data-room");
    ensureRoomPresets();
    const p = STATE.payload.roomPresets.find(x=>canonRoomName(x.room)===canonRoomName(r));
    setActiveRoom(r, p?.roomUrl || "");
    toast("ACTIVE ROOM SET");
    persist();
  });
});

/* Boot */
ensurePayload();
ensureKetaNoteMeta();
syncKetaNoteMeta("boot");
render();

/* Minimal API */
window.SHELL8_OS = {
  getState: ()=>structuredClone(STATE),
  setFullscreenUi: (on)=>setFullscreenUi(on),
  hyper: {
    add: addHyper,
    trace: (delta=1, note="")=>addTrace(delta, note),
    decay: decayTickAll
  }
};
</script>
</body>
</html>

<!--
============================================================
KETADATA HTML SERIALIZATION STAMP
FILE_ID: SHELL8_OS_HYPERSTITION_SURFACE_V1
ROOM_ID: OS
VERSION: shell8.os.hyperstition.v1
UPDATED_AT: 2025-12-24T00:00:00-05:00
CHANGELOG:
- OS-EMBED: HYPERSTITION SURFACE INTEGRATED INTO SHELL8 OS LAYOUT
- CONTROLS: ALL COLLAPSIBLE (FULL MODE, LEFT PANEL COLLAPSE, RIGHT HEADER COLLAPSE, PANELS COLLAPSE)
- INTENSITY: INVERT + LIGHTS 1–6 + TRANSPORT + MOTION
- DATA OBJECT: SAME SPEC + TRACE + DECAY ENGINE, EXPORTABLE STATE ENVELOPE
============================================================
-->
