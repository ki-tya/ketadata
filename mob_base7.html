<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="theme-color" content="#000000" />
<title>KETADATA // MOB_PLAYER</title>

<style>
:root{
  --bg:#000;
  --fg:#fff;
  --muted:#8a8a8a;
  --line:#222;
  --line2:#333;

  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;

  --nav-h: 60px;
  --corner-btn: 44px;
  --pad:12px;
}

*{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
html,body{height:100%; margin:0; overflow:hidden}
body{
  background:var(--bg);
  color:var(--fg);
  font-family:var(--mono);
  font-size:13px;
  letter-spacing:.04em;
  touch-action:pan-y;
  overscroll-behavior:none;
}

/* ROOT */
#root{
  position:fixed;
  inset:0;
  display:flex;
  flex-direction:column;
  background:#000;
}
#root.invert{filter:invert(1)}

/* STAGE (LIGHTS) */
#stage{
  position:fixed;
  inset:0;
  background:#000;
  pointer-events:none;
  z-index:999;
  display:none;
}
#stage.active{display:block}

/* SURFACE PLAYER */
#surfaceFrame{
  position:fixed;
  inset:0;
  width:100%;
  height:100%;
  border:0;
  background:#000;
  display:none;
  z-index:1;
}
#surfaceFrame.active{display:block}

/* MAIN */
.main{
  flex:1;
  overflow:hidden;
  position:relative;
}

/* CONTENT PAGES */
.content{
  position:absolute;
  inset:0;
  overflow-y:auto;
  overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
  display:none;
  padding:var(--pad);
  padding-top:calc(var(--corner-btn) + 16px + env(safe-area-inset-top));
  padding-bottom:calc(var(--nav-h) + var(--pad) + env(safe-area-inset-bottom));
}
.content.active{display:block}

/* CORNER CONTROLS */
.corner-btn{
  position:fixed;
  width:var(--corner-btn);
  height:var(--corner-btn);
  border:1px solid var(--line2);
  background:rgba(0,0,0,.92);
  backdrop-filter:blur(6px);
  color:var(--fg);
  font-size:9px;
  font-family:var(--mono);
  letter-spacing:.06em;
  text-transform:uppercase;
  line-height:1.2;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  cursor:pointer;
  z-index:100;
  transition:all .15s;
  user-select:none;
  -webkit-user-select:none;
}
.corner-btn:active{transform:scale(.95); border-color:var(--fg)}
.corner-btn.active{background:rgba(255,255,255,.10); border-color:var(--fg)}

#btnMine{top:calc(10px + env(safe-area-inset-top)); left:10px}
#btnNote{top:calc(10px + env(safe-area-inset-top)); right:10px}
#btnInvert{bottom:calc(var(--nav-h) + 10px + env(safe-area-inset-bottom)); left:10px}
#btnNull{bottom:calc(var(--nav-h) + 10px + env(safe-area-inset-bottom)); right:10px}

/* BOTTOM NAV */
.nav{
  height:calc(var(--nav-h) + env(safe-area-inset-bottom));
  padding-bottom:env(safe-area-inset-bottom);
  border-top:1px solid var(--line);
  background:linear-gradient(0deg,#0a0a0a,#000);
  display:flex;
  align-items:stretch;
  flex-shrink:0;
  z-index:90;
}
.nav-btn{
  flex:1;
  border:0;
  border-right:1px solid var(--line);
  background:transparent;
  color:var(--muted);
  font-family:var(--mono);
  font-size:10px;
  letter-spacing:.10em;
  text-transform:uppercase;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;
  cursor:pointer;
  transition:color .15s;
  user-select:none;
  -webkit-user-select:none;
}
.nav-btn:last-child{border-right:0}
.nav-btn.active{color:var(--fg); background:rgba(255,255,255,.05)}
.nav-btn:active{background:rgba(255,255,255,.10)}
.nav-icon{font-size:18px; line-height:1}

/* NOTE (FULL PAGE APPLE-NOTE FEEL) */
.note-full{
  position:fixed;
  inset:0;
  background:#000;
  z-index:200;
  display:none;
  flex-direction:column;
}
.note-full.active{display:flex}
.note-top{
  height:calc(var(--corner-btn) + 16px + env(safe-area-inset-top));
  padding-top:env(safe-area-inset-top);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding-left:10px;
  padding-right:10px;
  border-bottom:1px solid var(--line);
}
.note-top .note-title{
  font-size:11px;
  letter-spacing:.10em;
  text-transform:uppercase;
  color:var(--muted);
}
.note-top .mini-row{display:flex; gap:8px}
.mini-btn{
  width:32px;
  height:32px;
  border:1px solid var(--line2);
  background:#000;
  color:var(--fg);
  font-size:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  font-family:var(--mono);
  user-select:none;
  -webkit-user-select:none;
}
.mini-btn:active{border-color:var(--fg); transform:scale(.95)}
.note-fields{
  flex:1;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
.note-fields input,
.note-fields textarea{
  width:100%;
  border:0;
  outline:none;
  background:#000;
  color:#fff;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  font-size:15px;
  letter-spacing:0;
  padding:14px 12px;
}
.note-fields input{
  border-bottom:1px solid var(--line);
  font-weight:600;
}
.note-fields textarea{
  flex:1;
  resize:none;
}
.note-hint{
  padding:10px 12px;
  border-top:1px solid var(--line);
  color:var(--muted);
  font-size:11px;
  letter-spacing:.10em;
  text-transform:uppercase;
}

/* SEARCH */
.search-box{
  margin-bottom:12px;
  position:sticky;
  top:0;
  background:#000;
  z-index:10;
  padding-bottom:8px;
}
.search-input{
  width:100%;
  min-height:var(--corner-btn);
  background:#000;
  border:1px solid var(--line2);
  color:var(--fg);
  font-family:var(--mono);
  font-size:13px;
  padding:0 12px;
  letter-spacing:.06em;
  text-transform:uppercase;
}
.search-input:focus{outline:none; border-color:var(--fg)}

/* CATEGORIES */
.category{
  border:1px solid var(--line2);
  margin-bottom:12px;
  background:rgba(255,255,255,.02);
}
.cat-header{
  padding:12px;
  border-bottom:1px solid var(--line);
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:11px;
  letter-spacing:.10em;
  text-transform:uppercase;
  cursor:pointer;
  min-height:var(--corner-btn);
  user-select:none;
  -webkit-user-select:none;
}
.cat-header:active{background:rgba(255,255,255,.05)}
.cat-count{color:var(--muted); font-size:10px}
.cat-body{
  display:none;
  padding:8px;
  max-height:420px;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
}
.cat-body.open{display:block}

/* PLAYER ITEMS (NOT LINKS) */
.item{
  min-height:var(--corner-btn);
  border:1px solid var(--line2);
  padding:10px 12px;
  margin-bottom:6px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  cursor:pointer;
  user-select:none;
  -webkit-user-select:none;
}
.item:active{border-color:var(--fg); background:rgba(255,255,255,.08)}
.item-name{
  flex:1;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  font-size:12px;
  letter-spacing:.06em;
  text-transform:uppercase;
}
.item-tag{color:var(--muted); font-size:10px; letter-spacing:.10em}

/* LIGHTS PANEL */
.panel{
  padding:12px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,.92);
  margin-bottom:12px;
}
.panel-title{
  margin-bottom:12px;
  font-size:11px;
  letter-spacing:.10em;
  text-transform:uppercase;
  color:var(--muted);
}
.lights-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
  margin-bottom:8px;
}
.light-btn{
  min-height:var(--corner-btn);
  border:1px solid var(--line2);
  background:#000;
  color:var(--fg);
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.08em;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  user-select:none;
  -webkit-user-select:none;
}
.light-btn.active{border-color:var(--fg); background:rgba(255,255,255,.10)}
.light-btn:active{transform:scale(.95)}
.btn{
  width:100%;
  min-height:var(--corner-btn);
  padding:0 16px;
  border:1px solid var(--line2);
  background:#000;
  color:var(--fg);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
  cursor:pointer;
  margin-bottom:8px;
  user-select:none;
  -webkit-user-select:none;
}
.btn:active{border-color:var(--fg); transform:scale(.98)}

/* TOAST */
.toast{
  position:fixed;
  top:calc(var(--corner-btn) + 16px + env(safe-area-inset-top));
  left:50%;
  transform:translateX(-50%);
  padding:10px 16px;
  background:rgba(0,0,0,.95);
  border:1px solid var(--fg);
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
  z-index:300;
  display:none;
  white-space:nowrap;
}

/* NULL */
#root.null .nav,
#root.null .content,
#root.null .corner-btn:not(#btnNull),
#root.null .note-full,
#root.null .toast{display:none !important}
#root.null #surfaceFrame{display:block !important}

/* helpers */
.hidden{display:none !important}
</style>
</head>

<body>
<div id="root">

  <!-- STAGE -->
  <div id="stage"></div>

  <!-- SURFACE PLAYER -->
  <iframe id="surfaceFrame" title="SURFACE"></iframe>

  <!-- CORNER CONTROLS -->
  <button class="corner-btn" id="btnMine">KETA<br/>MINE</button>
  <button class="corner-btn" id="btnNote">KETA<br/>NOTE</button>
  <button class="corner-btn" id="btnInvert">INVERT</button>
  <button class="corner-btn" id="btnNull">NULL</button>

  <!-- NOTE FULL -->
  <div class="note-full" id="noteFull">
    <div class="note-top">
      <div class="note-title">KETA_NOTE</div>
      <div class="mini-row">
        <button class="mini-btn" id="btnNoteExport" title="EXPORT">⇩</button>
        <button class="mini-btn" id="btnNoteClose" title="CLOSE">X</button>
      </div>
    </div>
    <div class="note-fields">
      <input id="noteTitle" placeholder="Title" spellcheck="false" />
      <textarea id="noteBody" placeholder="Note" spellcheck="false"></textarea>
    </div>
    <div class="note-hint">AUTO-SAVE · LOCAL-FIRST</div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <!-- PLAYER -->
    <div class="content active" id="contentPlayer">
      <div class="search-box">
        <input type="text" class="search-input" id="searchInput" placeholder="SEARCH PRESETS..." />
      </div>
      <div id="categoriesContainer"></div>
    </div>

    <!-- LIGHTS -->
    <div class="content" id="contentLights">
      <div class="panel">
        <div class="panel-title">LIGHT PRESETS</div>
        <div class="lights-grid">
          <button class="light-btn" data-light="1">L1</button>
          <button class="light-btn" data-light="2">L2</button>
          <button class="light-btn" data-light="3">L3</button>
          <button class="light-btn" data-light="4">L4</button>
          <button class="light-btn" data-light="5">L5</button>
          <button class="light-btn" data-light="6">L6</button>
        </div>
        <button class="btn" id="btnRun">RUN</button>
        <button class="btn" id="btnStop">STOP</button>
      </div>

      <div class="panel">
        <div class="panel-title">MOBILE HOTKEYS</div>
        <div style="color:var(--muted); font-size:11px; letter-spacing:.10em; text-transform:uppercase; line-height:1.4">
          DOUBLE TAP = TOGGLE RUN<br/>
          INVERT = BUTTON OR LONG PRESS TOP-LEFT<br/>
          NULL = CORNER BUTTON
        </div>
      </div>
    </div>

    <!-- SYSTEM -->
    <div class="content" id="contentSystem">
      <div class="panel">
        <div class="panel-title">SYSTEM</div>
        <button class="btn" id="btnExport">EXPORT STATE</button>
        <button class="btn" id="btnImport">IMPORT STATE</button>
        <button class="btn" id="btnClear">CLEAR STATE</button>
        <button class="btn" id="btnStopSurface">STOP SURFACE</button>
        <div style="margin-top:10px; color:var(--muted); font-size:11px; letter-spacing:.10em; text-transform:uppercase; line-height:1.35" id="storageInfo">
          STORAGE: —
        </div>
      </div>
    </div>
  </div>

  <!-- NAV -->
  <div class="nav">
    <button class="nav-btn active" data-tab="player">
      <span class="nav-icon">⚡</span>
      <span>PLAYER</span>
    </button>
    <button class="nav-btn" data-tab="lights">
      <span class="nav-icon">◉</span>
      <span>LIGHTS</span>
    </button>
    <button class="nav-btn" data-tab="system">
      <span class="nav-icon">⚙</span>
      <span>SYSTEM</span>
    </button>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast"></div>

  <input type="file" id="fileInput" accept="application/json" style="display:none" />
</div>

<script>
/* ===== UTIL ===== */
const $=(id)=>document.getElementById(id);
function toast(msg,dur=1100){
  const t=$("toast");
  t.textContent=String(msg||"");
  t.style.display="block";
  clearTimeout(t._t);
  t._t=setTimeout(()=>{t.style.display="none";},dur);
}
function hash8(str){
  const s=String(str||"");
  let h=2166136261;
  for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,16777619);}
  return (h>>>0).toString(16).slice(0,8);
}
function bytesOf(str){ return new Blob([String(str||"")]).size; }

/* ===== DATA (PLAYER PRESETS) ===== */
const CATEGORIES=[
  { name:"LATEST (TENNIS & CATBALL)", tag:"TOY", links:[
    "catball.html","catball1.html","ktball.html","ktball1.html",
    "serve.html","serve1.html","serve2.html",
    "tball.html","tball1.html","tball2.html","tball3.html","tball4.html","tball5.html","tball6.html","tball7.html",
    "tennisball.html","tennisball0.html","tennisball2.html","tennisball3.html","tennisball4.html","tennisball5.html",
    "tennisball6.html","tennisball7.html","tennisball8.html","tennisball9.html","tennisball10.html","tennisball11.html",
    "tennisball12.html","tennisball13.html","tennisball14.html","tennisball15.html","tennisball16.html","tennisball91.html",
    "tennisball666.html","tenniscourt.html"
  ]},
  { name:"KETA_MONO", tag:"MONO", links:[
    "butterfly.html","butterfly1.html","butterfly2.html","butterfly3.html",
    "catface.html","catface1.html","catface2.html",
    "kitty.html","kittycat.html","kittycat1.html","kittycat2.html",
    "octopus.html","fishtank.html","lizard.html","serpentine.html","serp1.html","underwater.html","underwater1.html","widefield.html",
    "eye.html","eyes.html","matrix.html","molecule.html","mandala.html","mandala1.html","mandala2.html","mandala3.html",
    "ripple.html","ripple1.html","ripple2.html","ripple3.html",
    "substrate.html","substrate1.html","substrate3.html",
    "sovereignty.html","sublime.html","substance.html","teleo.html","teleo1.html","trace.html","turbulence.html"
  ]},
  { name:"KETA_CHROMA / KETA_SLOP", tag:"CHROMA", links:[
    "infinity.html",
    "pool.html","pool3.html","pool4.html",
    "slopstream2.html","slopstream3.html",
    "mandalagpt.html","mandalagpt2.html","mandalagpt3.html",
    "mdma.html","mdma2.html","mdmagpt.html","mdmagpt2.html",
    "temple.html","temple1.html"
  ]}
];

/* ===== STATE ===== */
const FILE_ID="mob_player_styleA_v1.html";
const ROOM_ID="MOB_PLAYER";
const STATE_KEY="KDT::MOB_PLAYER::"+hash8(location.pathname+"|"+FILE_ID)+"::STATE";

let STATE={
  invert:false,
  null:false,

  lightPreset:1,
  lightRunning:false,

  surfaceActive:false,
  surfaceUrl:"",
  surfaceName:"",

  noteOpen:false,
  note:{ title:"", body:"" },

  // UI
  tab:"player"
};

function loadState(){
  try{
    const raw=localStorage.getItem(STATE_KEY);
    if(raw){
      const j=JSON.parse(raw);
      STATE={...STATE,...j};
      if(!STATE.note) STATE.note={title:"",body:""};
    }
  }catch(e){}
}
function saveState(){
  try{ localStorage.setItem(STATE_KEY, JSON.stringify(STATE)); }catch(e){}
}
function updateStorageInfo(){
  const raw=localStorage.getItem(STATE_KEY)||"";
  $("storageInfo").textContent = `STORAGE: ${bytesOf(raw)}B · ${STATE_KEY.slice(0,26)}…`;
}

/* ===== MODES ===== */
function applyModes(){
  $("root").classList.toggle("invert", !!STATE.invert);
  $("root").classList.toggle("null", !!STATE.null);

  $("btnInvert").classList.toggle("active", !!STATE.invert);
  $("btnNull").classList.toggle("active", !!STATE.null);

  $("surfaceFrame").classList.toggle("active", !!STATE.surfaceActive);
}
function toggleInvert(){
  STATE.invert=!STATE.invert;
  saveState(); applyModes();
  toast(STATE.invert?"INVERT":"NORMAL");
}
function toggleNull(){
  // NULL = fullscreen/quiet/no chrome; keep surface if active, otherwise blank screen
  STATE.null=!STATE.null;
  if(STATE.null){
    // in null: stop lights (stage should not cover surface)
    stopLight();
  }
  saveState(); applyModes();
  toast(STATE.null?"NULL":"RETURN");
}

/* ===== NOTE ===== */
function openNote(){
  STATE.noteOpen=true;
  $("noteFull").classList.add("active");
  $("noteTitle").value = STATE.note.title || "";
  $("noteBody").value  = STATE.note.body  || "";
  saveState();
}
function closeNote(){
  STATE.noteOpen=false;
  $("noteFull").classList.remove("active");
  saveState();
}
function noteAutosave(){
  STATE.note.title = $("noteTitle").value || "";
  STATE.note.body  = $("noteBody").value  || "";
  saveState();
}
function exportNote(){
  noteAutosave();
  const payload={note:STATE.note, exported_at:new Date().toISOString(), source:"KETA_NOTE"};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=`keta_note_${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast("NOTE EXPORTED");
}

/* ===== SURFACE ===== */
function playSurface(url, label){
  const u=String(url||"").trim();
  if(!u) return;

  STATE.surfaceActive=true;
  STATE.surfaceUrl=u;
  STATE.surfaceName=String(label||u).toUpperCase();

  const f=$("surfaceFrame");
  f.src=u;
  f.classList.add("active");

  // when playing a surface, keep tab UI available unless in NULL
  saveState(); applyModes();
  toast(STATE.surfaceName);
}
function stopSurface(){
  STATE.surfaceActive=false;
  STATE.surfaceUrl="";
  STATE.surfaceName="";

  const f=$("surfaceFrame");
  f.classList.remove("active");
  f.src="about:blank";

  saveState(); applyModes();
  toast("STOP SURFACE");
}

/* ===== PLAYER UI ===== */
function renderCategories(){
  const wrap=$("categoriesContainer");
  wrap.innerHTML="";

  const q=String($("searchInput").value||"").trim().toUpperCase();

  let any=false;

  CATEGORIES.forEach((cat)=>{
    const list = q ? cat.links.filter(l=>l.toUpperCase().includes(q)) : cat.links;
    if(q && list.length===0) return;

    any=true;

    const box=document.createElement("div");
    box.className="category";

    const header=document.createElement("div");
    header.className="cat-header";
    header.innerHTML=`<span>${cat.name}</span><span class="cat-count">${list.length}</span>`;

    const body=document.createElement("div");
    body.className="cat-body";
    if(q) body.classList.add("open");

    list.forEach((link)=>{
      const label = link.replace(".html","").toUpperCase();
      const row=document.createElement("div");
      row.className="item";
      row.innerHTML=`<div class="item-name">${label}</div><div class="item-tag">${cat.tag}</div>`;
      row.addEventListener("click", ()=>playSurface(link,label));
      body.appendChild(row);
    });

    header.addEventListener("click", ()=>body.classList.toggle("open"));

    box.appendChild(header);
    box.appendChild(body);
    wrap.appendChild(box);
  });

  if(!any){
    const d=document.createElement("div");
    d.style.border="1px solid var(--line2)";
    d.style.padding="18px";
    d.style.color="var(--muted)";
    d.style.letterSpacing=".10em";
    d.style.textTransform="uppercase";
    d.style.textAlign="center";
    d.textContent="NO MATCHES";
    wrap.appendChild(d);
  }
}

/* ===== NAV ===== */
function switchTab(tab){
  STATE.tab=tab;
  saveState();

  document.querySelectorAll(".nav-btn").forEach(b=>b.classList.toggle("active", b.dataset.tab===tab));
  $("contentPlayer").classList.toggle("active", tab==="player");
  $("contentLights").classList.toggle("active", tab==="lights");
  $("contentSystem").classList.toggle("active", tab==="system");
}

/* ===== LIGHTS (1–6) ===== */
let lightInterval=null;
let lightCount=0;

function updateLightUI(){
  document.querySelectorAll(".light-btn").forEach(btn=>{
    btn.classList.toggle("active", Number(btn.dataset.light)===Number(STATE.lightPreset));
  });
  $("btnRun").textContent = STATE.lightRunning ? "RUNNING (TAP=STOP)" : "RUN";
}

function stopLight(){
  if(lightInterval){ clearInterval(lightInterval); lightInterval=null; }
  STATE.lightRunning=false;
  const stage=$("stage");
  stage.classList.remove("active");
  stage.style.backgroundColor="#000";
  stage.style.filter="none";
  saveState();
  updateLightUI();
}

function startLight(preset){
  stopLight();
  STATE.lightPreset = Number(preset)||1;
  STATE.lightRunning = true;

  const stage=$("stage");
  stage.classList.add("active");
  lightCount=0;

  const p=STATE.lightPreset;

  if(p===1){
    lightInterval=setInterval(()=>{
      const curr=stage.style.backgroundColor||"black";
      stage.style.backgroundColor=(curr==="black"||curr==="rgb(0, 0, 0)")?"white":"black";
      stage.style.filter="none";
    },50);
  }else if(p===2){
    let hue=0,w=0;
    lightInterval=setInterval(()=>{
      hue=(hue+18)%360; w+=0.22;
      const l=34+Math.sin(w)*22;
      stage.style.backgroundColor=`hsl(${hue},100%,${l}%)`;
      stage.style.filter="contrast(1.35) saturate(1.6)";
    },16);
  }else if(p===3){
    lightInterval=setInterval(()=>{
      lightCount++;
      const beat=lightCount%16;
      if(beat===0||beat===1){
        stage.style.backgroundColor="#fff"; stage.style.filter="invert(1) contrast(3)";
      }else if(beat===2){
        stage.style.backgroundColor="#000"; stage.style.filter="invert(1) contrast(2)";
      }else if(beat===3){
        stage.style.backgroundColor="#111"; stage.style.filter="contrast(3)";
      }else if(beat<8){
        stage.style.backgroundColor="#fff"; stage.style.filter="contrast(1.8) invert(.15)";
      }else{
        stage.style.backgroundColor="#000"; stage.style.filter="contrast(2.2) invert(.08)";
      }
    },30);
  }else if(p===4){
    let phase=0;
    lightInterval=setInterval(()=>{
      phase+=0.08; lightCount++;
      const red=Math.abs(Math.sin(phase))*255;
      const pulse=Math.abs(Math.sin(phase*0.5));
      if(lightCount%10===0){
        stage.style.backgroundColor="#000"; stage.style.filter="brightness(3)";
      }else{
        stage.style.backgroundColor=`rgb(${red|0},0,0)`;
        stage.style.filter=`contrast(${1.8+pulse*1.6}) saturate(${2.2+pulse*1.6})`;
      }
    },20);
  }else if(p===5){
    let a=0,c=0;
    lightInterval=setInterval(()=>{
      a+=13; c=(c+2)%100;
      const hue=260+Math.sin(a*0.1)*40;
      const sat=80+Math.cos(a*0.05)*20;
      const light=28+Math.sin(c*0.1)*26;
      stage.style.backgroundColor=`hsl(${hue},${sat}%,${light}%)`;
      stage.style.filter=`contrast(${1.4+Math.abs(Math.cos(a*0.07))}) hue-rotate(${a*0.45}deg)`;
    },25);
  }else if(p===6){
    lightInterval=setInterval(()=>{
      lightCount++;
      if(lightCount%50===0 || lightCount%50===2 || lightCount%50===4){
        stage.style.backgroundColor="#fff"; stage.style.filter="brightness(5) contrast(2)";
      }else{
        stage.style.backgroundColor="#000"; stage.style.filter="none";
      }
    },30);
  }

  saveState();
  updateLightUI();
  toast(`LIGHT ${p} RUN`);
}

function toggleLight(){
  if(STATE.lightRunning) stopLight();
  else startLight(STATE.lightPreset||1);
}

/* double tap anywhere = toggle lights run */
let lastTapAt=0;
const DBL_MS=280;
document.addEventListener("pointerdown",(ev)=>{
  if(ev.pointerType!=="touch") return;
  const now=performance.now();
  if(now-lastTapAt < DBL_MS){
    ev.preventDefault();
    toggleLight();
    lastTapAt=0;
  }else lastTapAt=now;
},{passive:false});

/* ===== SYSTEM EXPORT/IMPORT ===== */
function exportState(){
  noteAutosave();
  const payload={
    STATE,
    exported_at:new Date().toISOString(),
    FILE_ID, ROOM_ID
  };
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=`mob_player_state_${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast("EXPORTED");
}

function importState(){
  $("fileInput").value="";
  $("fileInput").click();
}

function clearState(){
  if(!confirm("CLEAR STATE?")) return;
  stopLight();
  localStorage.removeItem(STATE_KEY);
  location.reload();
}

/* ===== HOTKEY BUTTON SEMANTICS =====
   INVERT: button + long press top-left
   NULL: button (corner)
*/
(function bindLongPressInvert(){
  const el=$("btnMine");
  let t=null;
  const LONG=520;
  const clear=()=>{ if(t){clearTimeout(t); t=null;} };
  el.addEventListener("pointerdown",(ev)=>{
    if(ev.pointerType!=="touch") return;
    clear();
    t=setTimeout(()=>{ toggleInvert(); }, LONG);
  },{passive:true});
  el.addEventListener("pointerup", clear, {passive:true});
  el.addEventListener("pointercancel", clear, {passive:true});
})();

/* ===== BINDINGS ===== */
$("btnMine").onclick=()=>{ toast("MINE"); /* placeholder: route if you want */ };
$("btnNote").onclick=()=>openNote();
$("btnInvert").onclick=()=>toggleInvert();
$("btnNull").onclick=()=>toggleNull();

$("btnNoteClose").onclick=()=>{ noteAutosave(); closeNote(); toast("NOTE SAVED"); };
$("btnNoteExport").onclick=()=>exportNote();
$("noteTitle").addEventListener("input", noteAutosave);
$("noteBody").addEventListener("input", noteAutosave);

document.querySelectorAll(".nav-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>switchTab(btn.dataset.tab));
});

$("searchInput").addEventListener("input", renderCategories);

document.querySelectorAll(".light-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    STATE.lightPreset = Number(btn.dataset.light)||1;
    saveState(); updateLightUI();
    toast(`LIGHT ${STATE.lightPreset}`);
  });
});

$("btnRun").onclick=()=>toggleLight();
$("btnStop").onclick=()=>stopLight();

$("btnExport").onclick=()=>exportState();
$("btnImport").onclick=()=>importState();
$("btnClear").onclick=()=>clearState();
$("btnStopSurface").onclick=()=>stopSurface();

$("fileInput").addEventListener("change",(e)=>{
  const file=e.target.files && e.target.files[0];
  if(!file) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const data=JSON.parse(String(r.result||"{}"));
      const incoming = data.STATE ? data.STATE : data;
      STATE = {...STATE, ...incoming};
      if(!STATE.note) STATE.note={title:"",body:""};
      saveState();

      applyModes();
      switchTab(STATE.tab || "player");
      updateLightUI();
      renderCategories();
      updateStorageInfo();

      if(STATE.noteOpen) openNote(); else closeNote();
      if(STATE.surfaceActive && STATE.surfaceUrl){
        $("surfaceFrame").src=STATE.surfaceUrl;
        $("surfaceFrame").classList.add("active");
      }else{
        $("surfaceFrame").src="about:blank";
        $("surfaceFrame").classList.remove("active");
      }

      toast("IMPORTED");
    }catch(err){
      toast("IMPORT FAILED");
    }
  };
  r.readAsText(file);
});

/* prevent pull-to-refresh */
let lastY=0;
document.body.addEventListener("touchstart",(e)=>{ lastY=e.touches[0].clientY; },{passive:true});
document.body.addEventListener("touchmove",(e)=>{
  const y=e.touches[0].clientY;
  if(y>lastY && window.scrollY<=0) e.preventDefault();
},{passive:false});

/* ===== INIT ===== */
(function init(){
  loadState();
  applyModes();

  // restore note
  if(STATE.noteOpen) openNote(); else closeNote();

  // restore tab
  switchTab(STATE.tab || "player");

  // build player list
  renderCategories();

  // restore surface
  if(STATE.surfaceActive && STATE.surfaceUrl){
    $("surfaceFrame").src = STATE.surfaceUrl;
    $("surfaceFrame").classList.add("active");
  }else{
    $("surfaceFrame").src="about:blank";
    $("surfaceFrame").classList.remove("active");
  }

  // lights default stable off
  stopLight();
  updateLightUI();
  updateStorageInfo();
})();
</script>

<!--
AE:
- MOBILE COMBINED STYLE: CORNER BUTTONS + BOTTOM NAV, MONO, HARD LINES.
- PLAYER IS A PLAYER (ITEMS LOAD INTO FULLSCREEN IFRAME).
- NOTE IS FULL PAGE (APPLE NOTES VIBE) WITH AUTO-SAVE.
EE:
- LIGHTS 1–6 + DOUBLE TAP TOGGLE RUN.
- INVERT + NULL AS MOBILE HOTKEY BUTTONS (INVERT ALSO LONG PRESS TOP-LEFT).
- SYSTEM EXPORT/IMPORT/CLEAR + STORAGE READOUT.
WB:
FILE_ID: mob_player_styleA_v1.html
ROOM_ID: MOB_PLAYER
VERSION: v1.2.0
UPDATED_AT: 2026-01-15
CHANGELOG:
- Refactored into COMBINED STYLE layout (corner buttons + bottom nav).
- Presets: TOYS + KETA_MONO + KETA_CHROMA.
- KETA_NOTE now full-page.
-->
</body>
</html>
