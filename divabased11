<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KETADATA_BASE_SYSTEM</title>
<style>
:root{
  --bg:#000; --fg:#fff; --muted:#8a8a8a; --line:#222; --line2:#333;
  --top:44px; --bot:34px;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  --sans: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  --ctl-radius:0px;
  --ctl-alpha:0.82;
  --ctl-bg: rgba(0,0,0,var(--ctl-alpha));
  --note-border: rgba(255,255,255,0.78);
  --drawer-h: 0.42;
}
*{box-sizing:border-box}
html,body{height:100%; margin:0}
body{background:var(--bg); color:var(--fg); font-family:var(--sans); overflow:hidden; user-select:none}
#root{position:fixed; inset:0; background:#000}
#root.invert{filter:invert(1)}
#root.fs .topbar,#root.fs .bottombar,#root.fs .drawer,#root.fs #pinnedPanel,#root.fs #armedBar,#root.fs .toast,#root.fs #activeStrip{display:none !important}
#root.blackout .topbar,#root.blackout .bottombar,#root.blackout .drawer,#root.blackout #pinnedPanel,#root.blackout #armedBar,#root.blackout .toast,#root.blackout .ketaNote,#root.blackout #activeStrip{display:none !important}
#root.blackout #stage{background:#000 !important; filter:none !important}
#root.blackout #motion{display:none !important}
#stage{position:absolute; inset:0; background:#000; pointer-events:none}
#motion{position:absolute; inset:0; pointer-events:none; opacity:0; background:repeating-linear-gradient(135deg, rgba(255,255,255,0.06) 0px, rgba(255,255,255,0.06) 1px, rgba(0,0,0,0) 12px, rgba(0,0,0,0) 22px); mix-blend-mode:screen; transform:translate3d(0,0,0)}
#motion.run{opacity:0.12; animation:scanflow 2.2s linear infinite}
@keyframes scanflow{0%{transform:translate3d(-80px,60px,0)}100%{transform:translate3d(80px,-60px,0)}}
.topbar{position:absolute; top:0; left:0; right:0; height:var(--top); display:flex; align-items:center; justify-content:space-between; padding:0 10px; border-bottom:1px solid var(--line); background:linear-gradient(180deg,#070707,#000); z-index:10}
.brand{display:flex; align-items:center; gap:10px; font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase}
.brand .sq{width:10px; height:10px; border:1px solid var(--fg); background:#000}
.roomBadge{display:flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted); border:1px solid var(--line2); padding:4px 8px}
.actions{display:flex; align-items:center; gap:8px; font-family:var(--mono); font-size:12px}
.btn{background:transparent; color:var(--fg); border:1px solid var(--line2); padding:6px 10px; font-family:var(--mono); font-size:12px; letter-spacing:.08em; text-transform:uppercase; cursor:pointer}
.btn:hover{border-color:var(--fg)}
.btn:active{transform:translateY(1px)}
.kbd{border:1px solid var(--line2); padding:2px 6px; color:var(--muted); font-size:11px}
.ketaIcon{width:16px; height:16px; border:2px solid var(--fg); background:var(--fg); cursor:pointer}
.ketaIcon.open{background:#000}
.bottombar{position:absolute; left:0; right:0; bottom:0; height:var(--bot); display:flex; align-items:center; justify-content:space-between; padding:0 10px; border-top:1px solid var(--line); background:linear-gradient(0deg,#070707,#000); z-index:10; font-family:var(--mono); font-size:11px; color:var(--muted)}
.toggle{border:1px solid var(--line2); background:transparent; color:var(--fg); padding:4px 8px; font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase; cursor:pointer}
.toggle:hover{border-color:var(--fg)}
.drawer{position:absolute; left:0; right:0; bottom:var(--bot); height:calc((100vh - var(--top) - var(--bot)) * var(--drawer-h)); min-height:200px; border-top:1px solid var(--line); background:linear-gradient(180deg,#060606,#000); display:none; z-index:20}
.drawer.open{display:flex; flex-direction:column}
.drawerSizer{height:10px; cursor:ns-resize; border-bottom:1px solid var(--line); background:linear-gradient(180deg,#0a0a0a,#050505)}
.drawerHead{padding:8px 10px; border-bottom:1px solid var(--line); font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; display:flex; justify-content:space-between; align-items:center}
.drawerBody{padding:10px; min-height:0; flex:1; overflow:auto}
textarea{width:100%; border:1px solid var(--line2); background:#050505; color:var(--fg); font-family:var(--mono); font-size:12px; padding:10px; line-height:1.35; outline:none; resize:vertical; min-height:140px}
input{outline:none}
.ketaNote{position:absolute; top:76px; right:16px; left:auto; width:340px; height:220px; display:none; z-index:30; resize:both; overflow:hidden; border-radius:var(--ctl-radius); background:var(--ctl-bg); border:1px solid var(--note-border); backdrop-filter:blur(6px)}
.ketaNote.open{display:flex; flex-direction:column}
.ketaHead{padding:8px 10px; border-bottom:1px solid rgba(255,255,255,0.14); font-family:var(--mono); font-size:11px; letter-spacing:.14em; text-transform:uppercase; display:flex; justify-content:space-between; align-items:center; cursor:move}
.ketaBody{padding:10px; min-height:0; flex:1}
.ketaNote textarea{background:#000; color:#fff; border:1px solid rgba(255,255,255,0.22); width:100%; height:100%; resize:none; padding:10px; outline:none}
.headBtn{background:transparent; color:var(--fg); border:1px solid rgba(255,255,255,0.18); padding:2px 8px; font-family:var(--mono); font-size:12px; letter-spacing:.08em; text-transform:uppercase; cursor:pointer}
.headBtn:hover{border-color:rgba(255,255,255,0.6)}
#armedBar{position:absolute; left:10px; top:calc(var(--top) + 10px); z-index:27; display:none; gap:8px; align-items:center; flex-wrap:wrap; padding:8px 10px; border:1px solid var(--line2); background:rgba(0,0,0,0.86); font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase}
#armedBar .label{color:var(--muted)}
#armedBar .val{color:var(--fg)}
#armedBar input{background:#000; color:#fff; border:1px solid var(--line2); padding:6px 8px; font-family:var(--mono); font-size:11px; letter-spacing:.08em; width:340px; max-width:calc(100vw - 40px)}
#pinnedPanel{position:absolute; left:10px; top:calc(var(--top) + 64px); z-index:26; display:none; gap:8px; flex-wrap:wrap; align-items:flex-start; padding:8px 10px; border:1px solid var(--line2); background:rgba(0,0,0,0.86); font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase}
.toast{position:absolute; left:12px; top:calc(var(--top) + 12px); padding:8px 10px; border:1px solid var(--line2); background:rgba(8,8,8,0.82); font-family:var(--mono); font-size:11px; letter-spacing:.06em; color:var(--fg); display:none; z-index:40}
</style>
</head>

<body>
<div id="root">
  <div id="stage"></div>
  <div id="motion" aria-hidden="true"></div>

  <div id="armedBar">
    <span class="label">ARMED</span>
    <span class="val" id="armedName">—</span>
    <button class="btn" id="armedGo" style="padding:4px 8px; font-size:11px">GO</button>
    <button class="btn" id="armedNewTab" style="padding:4px 8px; font-size:11px">NEW TAB</button>
    <input id="armedUrl" readonly value="—" />
  </div>

  <div id="pinnedPanel"></div>
  <div class="toast" id="toast"></div>

  <div class="topbar">
    <div style="display:flex; gap:10px; align-items:center">
      <div class="brand">
        <span class="sq"></span>
        <span>KETADATA // BASE</span>
      </div>
      <div class="roomBadge">
        <span>ROOM</span>
        <span id="roomName">BASE</span>
      </div>
    </div>

    <div class="actions">
      <span class="kbd">Space</span>
      <span class="kbd">Shift+I</span>
      <span class="kbd">Shift+N</span>
      <span class="kbd">Shift+F</span>
      <div id="ketaIcon" class="ketaIcon"></div>
    </div>
  </div>

  <div class="drawer" id="drawer">
    <div class="drawerSizer" id="drawerSizer"></div>
    <div class="drawerHead">
      <div>SYSTEM</div>
      <button class="btn" id="btnCloseDrawer">CLOSE</button>
    </div>
    <div class="drawerBody">
      <textarea id="universals" spellcheck="false" autocomplete="off" placeholder="SYSTEM UNIVERSALS"></textarea>
    </div>
  </div>

  <div class="bottombar">
    <div style="display:flex; gap:10px; align-items:center">
      <button class="toggle" id="toggleDrawer">SYSTEM</button>
      <button class="toggle" id="toggleRun">RUN</button>
      <span>FS: <span id="fsLabel">OFF</span></span>
      <span>BLK: <span id="blkLabel">OFF</span></span>
    </div>
    <div style="display:flex; gap:12px; align-items:center">
      <span>MOTION: <span id="motionLabel">OFF</span></span>
    </div>
  </div>

  <div class="ketaNote" id="ketaNote">
    <div class="ketaHead" id="ketaHead">
      <div>KETA_NOTE</div>
      <button class="headBtn" id="btnHideNote">-</button>
    </div>
    <div class="ketaBody">
      <textarea id="ketaText" spellcheck="false" autocomplete="off" placeholder="NOTES"></textarea>
    </div>
  </div>
</div>

<script>
const KEY="KDT_BASE";
const $=id=>document.getElementById(id);
const root=$("root"),stage=$("stage"),motion=$("motion");

let S;
try{
  S=localStorage.getItem(KEY);
  if(S)S=JSON.parse(S);
  else S=null;
}catch(e){S=null}

if(!S){
  S={
    note:"",
    sys:"",
    room:"BASE",
    url:"",
    drawerOpen:false,
    noteOpen:false,
    drawerH:0.42,
    noteX:null,
    noteY:76,
    noteW:340,
    noteH:220,
    invert:false,
    blackout:false,
    fs:false,
    motion:false,
    pins:["CALENDAR","POD","WORLD"]
  };
}

function save(){
  try{
    localStorage.setItem(KEY,JSON.stringify(S));
  }catch(e){}
  render();
}

function render(){
  root.classList.toggle("invert",!!S.invert);
  root.classList.toggle("blackout",!!S.blackout);
  root.classList.toggle("fs",!!S.fs);
  motion.classList.toggle("run",!!S.motion);
  
  const drawer=$("drawer");
  if(S.drawerOpen&&!S.blackout&&!S.fs)drawer.classList.add("open");
  else drawer.classList.remove("open");
  
  const note=$("ketaNote");
  if(S.noteOpen&&!S.blackout)note.classList.add("open");
  else note.classList.remove("open");
  
  const icon=$("ketaIcon");
  if(S.noteOpen&&!S.blackout)icon.classList.add("open");
  else icon.classList.remove("open");
  
  $("ketaText").value=S.note||"";
  $("universals").value=S.sys||"";
  $("roomName").textContent=S.room||"BASE";
  $("fsLabel").textContent=S.fs?"ON":"OFF";
  $("blkLabel").textContent=S.blackout?"ON":"OFF";
  $("motionLabel").textContent=S.motion?"ON":"OFF";
  
  root.style.setProperty("--drawer-h",S.drawerH);
  
  if(S.noteX===null){
    note.style.left="auto";
    note.style.right="16px";
  }else{
    note.style.left=S.noteX+"px";
    note.style.right="auto";
  }
  note.style.top=S.noteY+"px";
  note.style.width=S.noteW+"px";
  note.style.height=S.noteH+"px";
  
  renderArmed();
  renderPins();
}

function renderArmed(){
  const bar=$("armedBar");
  if(S.blackout||S.fs){
    bar.style.display="none";
    return;
  }
  bar.style.display="flex";
  $("armedName").textContent=S.room||"—";
  $("armedUrl").value=S.url||"—";
}

function renderPins(){
  const el=$("pinnedPanel");
  if(S.blackout||S.fs||!S.pins||!S.pins.length){
    el.style.display="none";
    el.innerHTML="";
    return;
  }
  el.style.display="flex";
  el.innerHTML="";
  
  S.pins.forEach(name=>{
    const chip=document.createElement("button");
    chip.className="btn";
    chip.textContent=name;
    chip.addEventListener("click",()=>{
      S.room=name;
      save();
    });
    if(S.room===name)chip.style.borderColor="var(--fg)";
    el.appendChild(chip);
  });
}

$("ketaText").addEventListener("input",()=>{S.note=$("ketaText").value;save()});
$("universals").addEventListener("input",()=>{S.sys=$("universals").value;save()});

$("ketaIcon").addEventListener("click",()=>{
  if(S.blackout)return;
  S.noteOpen=!S.noteOpen;
  if(S.noteOpen)S.noteX=null;
  save();
});

$("btnHideNote").addEventListener("click",()=>{S.noteOpen=false;save()});

$("toggleDrawer").addEventListener("click",()=>{
  if(S.blackout||S.fs)return;
  S.drawerOpen=!S.drawerOpen;
  save();
});

$("btnCloseDrawer").addEventListener("click",()=>{S.drawerOpen=false;save()});

$("toggleRun").addEventListener("click",()=>{
  if(S.blackout)return;
  const c=stage.style.backgroundColor||"#000";
  stage.style.backgroundColor=(c==="#000"||c==="rgb(0, 0, 0)")?"#fff":"#000";
});

$("armedGo").addEventListener("click",()=>{
  if(S.url){
    save();
    window.location.href=S.url;
  }
});

$("armedNewTab").addEventListener("click",()=>{
  if(S.url){
    save();
    window.open(S.url,"_blank");
  }
});

window.addEventListener("keydown",ev=>{
  if(ev.repeat)return;
  const typing=document.activeElement&&(document.activeElement.tagName==="TEXTAREA"||document.activeElement.tagName==="INPUT");
  if(ev.code==="Space"&&!typing){ev.preventDefault();if(!S.blackout)$("toggleRun").click()}
  if(ev.shiftKey&&ev.key.toUpperCase()==="I"&&!typing){ev.preventDefault();S.invert=!S.invert;save()}
  if(ev.shiftKey&&ev.key.toUpperCase()==="N"&&!typing){ev.preventDefault();S.blackout=!S.blackout;save()}
  if(ev.shiftKey&&ev.key.toUpperCase()==="F"&&!typing){ev.preventDefault();S.fs=!S.fs;save()}
},{passive:false});

(function(){
  const box=$("ketaNote"),head=$("ketaHead");
  let drag=false,ox=0,oy=0;
  head.addEventListener("mousedown",ev=>{
    if(ev.target.closest("button")||S.blackout)return;
    drag=true;
    const r=box.getBoundingClientRect();
    ox=ev.clientX-r.left;
    oy=ev.clientY-r.top;
    box.style.left=r.left+"px";
    box.style.top=r.top+"px";
    box.style.right="auto";
  });
  window.addEventListener("mousemove",ev=>{
    if(!drag)return;
    box.style.left=Math.max(0,Math.min(ev.clientX-ox,window.innerWidth-40))+"px";
    box.style.top=Math.max(44,Math.min(ev.clientY-oy,window.innerHeight-40))+"px";
  });
  window.addEventListener("mouseup",()=>{
    if(!drag)return;
    drag=false;
    const r=box.getBoundingClientRect();
    S.noteX=Math.round(r.left);
    S.noteY=Math.round(r.top);
    S.noteW=Math.round(r.width);
    S.noteH=Math.round(r.height);
    save();
  });
  try{
    new ResizeObserver(()=>{
      if(drag||S.blackout)return;
      const r=box.getBoundingClientRect();
      S.noteX=Math.round(r.left);
      S.noteY=Math.round(r.top);
      S.noteW=Math.round(r.width);
      S.noteH=Math.round(r.height);
      save();
    }).observe(box);
  }catch(_){}
})();

(function(){
  const sizer=$("drawerSizer");
  let drag=false;
  sizer.addEventListener("mousedown",ev=>{
    if(!S.drawerOpen)return;
    drag=true;
    ev.preventDefault();
  });
  window.addEventListener("mousemove",ev=>{
    if(!drag)return;
    const usable=window.innerHeight-44-34;
    const h=Math.max(usable*0.15,Math.min(window.innerHeight-34-ev.clientY,usable*0.95));
    S.drawerH=h/usable;
    root.style.setProperty("--drawer-h",S.drawerH);
  });
  window.addEventListener("mouseup",()=>{
    if(!drag)return;
    drag=false;
    save();
  });
})();

window.addEventListener("beforeunload",()=>save());
window.addEventListener("pagehide",()=>save());

render();
</script>
</body>
</html>
