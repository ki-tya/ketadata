<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KETADATA // SENSORY LINKS</title>

<style>
  :root{
    --bg:#000;
    --fg:#fff;
    --hair:rgba(255,255,255,.14);
    --hair2:rgba(255,255,255,.08);
    --panel:rgba(0,0,0,.50);
    --panel2:rgba(0,0,0,.35);
    --glow:rgba(255,255,255,.75);

    --pad:12px;
    --topH:36px;
    --botH:28px;

    --strobeHz:0;
    --strobeOn:0;

    --bgSpeed:1.0;
    --bgOpacity:0.55;
    --bgDensity:1.0;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--fg);
    font-family:Arial, Helvetica, sans-serif;
    overflow:hidden;
  }

  /* ====== BACKGROUND (hypnotic wireframe + concentric) ====== */
  #bg{
    position:fixed; inset:0;
    z-index:0;
  }
  #bg canvas{width:100%; height:100%; display:block}

  /* ====== LIGHTS (behind content, above background) ====== */
  #lights{
    position:fixed; inset:0;
    z-index:1;
    pointer-events:none;
    opacity:0;
    background:
      radial-gradient(circle at 50% 50%, rgba(255,255,255,.20), rgba(0,0,0,0) 60%),
      repeating-linear-gradient(90deg, rgba(255,255,255,.10), rgba(255,255,255,.10) 2px, rgba(0,0,0,0) 18px, rgba(0,0,0,0) 26px),
      repeating-linear-gradient(0deg, rgba(255,255,255,.06), rgba(255,255,255,.06) 2px, rgba(0,0,0,0) 18px, rgba(0,0,0,0) 26px);
    mix-blend-mode:screen;
  }
  .strobing #lights{
    opacity:var(--strobeOn);
    animation: strobe calc(1s/var(--strobeHz)) steps(2,end) infinite;
  }
  @keyframes strobe{
    0%{opacity:0}
    49%{opacity:0}
    50%{opacity:var(--strobeOn)}
    100%{opacity:var(--strobeOn)}
  }

  /* ====== TOP BAR ====== */
  #top{
    position:fixed; left:0; right:0; top:0;
    height:var(--topH);
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 var(--pad);
    background:rgba(0,0,0,.55);
    border-bottom:1px solid var(--hair);
    z-index:10;
    user-select:none;
  }
  .brand{
    display:flex;
    align-items:center;
    gap:10px;
    font-size:11px;
    letter-spacing:.18em;
    text-transform:uppercase;
    opacity:.95;
  }
  .btnrow{
    display:flex;
    align-items:center;
    gap:8px;
  }
  .kbtn{
    height:24px;
    padding:0 10px;
    border:1px solid var(--hair);
    background:rgba(0,0,0,.25);
    color:#fff;
    font-size:10px;
    letter-spacing:.18em;
    text-transform:uppercase;
    cursor:pointer;
  }
  .kbtn:hover{border-color:rgba(255,255,255,.30)}
  .ketaIcon{
    width:14px; height:14px;
    border:1px solid #fff;
    background:#fff; /* filled when collapsed */
    cursor:pointer;
  }

  /* ====== PANELS ====== */
  .panel{
    position:fixed;
    top:calc(var(--topH) + 10px);
    right:12px;
    width:340px;
    background:var(--panel);
    border:1px solid var(--hair);
    z-index:20;
    display:none;
  }
  .panel.open{display:block}
  .panel header{
    height:32px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 10px;
    border-bottom:1px solid var(--hair);
    font-size:10px;
    letter-spacing:.18em;
    text-transform:uppercase;
    user-select:none;
  }
  .panel .content{padding:10px}
  .row{display:flex; gap:8px; margin:8px 0}
  .row > *{flex:1}
  .tiny{
    font-size:10px;
    letter-spacing:.12em;
    text-transform:uppercase;
    opacity:.75;
    line-height:1.4;
  }
  .in{
    width:100%;
    height:28px;
    border:1px solid var(--hair2);
    background:rgba(0,0,0,.15);
    color:#fff;
    padding:0 8px;
    font-size:11px;
    letter-spacing:.08em;
    outline:none;
  }
  textarea.in{
    height:96px;
    padding:8px;
    resize:none;
  }
  .miniBtn{
    height:28px;
    border:1px solid var(--hair);
    background:rgba(0,0,0,.25);
    color:#fff;
    font-size:10px;
    letter-spacing:.18em;
    text-transform:uppercase;
    cursor:pointer;
  }
  .miniBtn:hover{border-color:rgba(255,255,255,.30)}
  .slider{
    width:100%;
    accent-color:#fff;
  }

  /* ====== DIRECTORY SURFACE ====== */
  #surface{
    position:fixed;
    inset:var(--topH) 0 var(--botH) 0;
    z-index:5;
    padding:14px 14px;
    overflow:auto; /* internal scroll only */
  }
  /* hard snap feel: clamp wheel deltas into threshold jumps */
  #surface::-webkit-scrollbar{width:10px}
  #surface::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12)}
  #surface::-webkit-scrollbar-track{background:rgba(0,0,0,.2)}

  #modules{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    align-items:flex-start;
  }

  .mod{
    width:320px;
    border:1px solid var(--hair);
    background:rgba(0,0,0,.35);
    backdrop-filter: blur(2px);
    position:relative;
  }

  /* unlabeled header (no text) */
  .modHead{
    height:28px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    border-bottom:1px solid var(--hair2);
    padding:0 8px;
    user-select:none;
  }
  .dragHandle{
    display:flex;
    align-items:center;
    gap:8px;
    cursor:grab;
  }
  .handleSquare{
    width:10px; height:10px;
    border:1px solid rgba(255,255,255,.85);
    background:transparent;
  }
  .modBtns{display:flex; gap:6px}
  .iconBtn{
    width:22px; height:20px;
    border:1px solid var(--hair);
    background:rgba(0,0,0,.15);
    color:#fff;
    cursor:pointer;
    font-size:12px;
    line-height:18px;
    padding:0;
  }
  .iconBtn:hover{border-color:rgba(255,255,255,.30)}
  .modBody{
    padding:10px;
  }
  .mod.collapsed .modBody{display:none}

  /* Links styled like {BLANK} */
  .links{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
  }
  .klink{
    display:inline-block;
    padding:6px 8px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.10);
    color:#fff;
    text-decoration:none;
    font-size:11px;
    letter-spacing:.14em;
    text-transform:uppercase;
    opacity:.92;
    white-space:nowrap;
  }
  .klink:hover{
    border-color:rgba(255,255,255,.35);
    box-shadow:0 0 18px rgba(255,255,255,.10);
  }
  .klink span{opacity:.85}
  .klink .br{opacity:.55}

  /* ====== BOTTOM BAR ====== */
  #bottom{
    position:fixed; left:0; right:0; bottom:0;
    height:var(--botH);
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 var(--pad);
    border-top:1px solid var(--hair);
    background:rgba(0,0,0,.55);
    z-index:10;
    font-size:10px;
    letter-spacing:.18em;
    text-transform:uppercase;
    user-select:none;
  }
  .muted{opacity:.75}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

  /* ====== GLOBAL NOTE ====== */
  #keta_note{
    position:fixed;
    top:calc(var(--topH) + 10px);
    left:12px;
    width:380px;
    height:240px;
    background:var(--panel);
    border:1px solid var(--hair);
    z-index:25;
    display:none;
  }
  #keta_note.open{display:block}
  #keta_note header{
    height:32px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 10px;
    border-bottom:1px solid var(--hair);
    cursor:move;
    user-select:none;
    font-size:10px;
    letter-spacing:.18em;
    text-transform:uppercase;
  }
  #keta_note textarea{
    width:100%;
    height:calc(100% - 32px);
    background:transparent;
    border:0;
    outline:none;
    color:#fff;
    padding:10px;
    resize:none;
    font-size:12px;
    letter-spacing:.06em;
    line-height:1.45;
  }

  /* ====== NULL LAW ====== */
  body.null #top,
  body.null #bottom,
  body.null .panel,
  body.null #keta_note{
    display:none !important;
  }

  body.invert{filter:invert(1)}
</style>
</head>

<body>
  <div id="bg"><canvas id="bgc"></canvas></div>
  <div id="lights"></div>

  <div id="top">
    <div class="brand">
      <div class="mono">KETADATA // SENSORY LINKS</div>
    </div>
    <div class="btnrow">
      <button class="kbtn" id="btnState">STATE</button>
      <button class="kbtn" id="btnInt">INTENSIFIERS</button>
      <button class="kbtn" id="btnHome" title="Shift+B">HOME</button>
      <button class="kbtn" id="btnLand" title="Shift+K">LAND</button>
      <div class="ketaIcon" id="noteIcon" title="GLOBAL KETA_NOTE"></div>
    </div>
  </div>

  <!-- STATE PANEL -->
  <div class="panel" id="statePanel">
    <header>
      <span>STATE</span>
      <button class="iconBtn" id="closeState" title="close">×</button>
    </header>
    <div class="content">
      <div class="tiny">EXPORT / IMPORT / SAVE / LOAD. PORTABLE ENVELOPE.</div>
      <div class="row">
        <button class="miniBtn" id="btnExport">EXPORT</button>
        <button class="miniBtn" id="btnCopy">COPY</button>
      </div>
      <textarea class="in mono" id="stateBox" placeholder="STATE ENVELOPE JSON"></textarea>
      <div class="row">
        <button class="miniBtn" id="btnImport">IMPORT</button>
        <button class="miniBtn" id="btnSave">SAVE</button>
      </div>
      <div class="row">
        <button class="miniBtn" id="btnLoad">LOAD</button>
        <button class="miniBtn" id="btnReset">RESET</button>
      </div>
      <div class="tiny muted mono" id="stateKeyLine"></div>
    </div>
  </div>

  <!-- INTENSIFIERS PANEL -->
  <div class="panel" id="intPanel">
    <header>
      <span>INTENSIFIERS</span>
      <button class="iconBtn" id="closeInt" title="close">×</button>
    </header>
    <div class="content">
      <div class="tiny">BACKGROUND MOTION (CONCENTRIC + WIREFRAME)</div>

      <div class="row">
        <div>
          <div class="tiny">SPEED</div>
          <input class="slider" id="bgSpeed" type="range" min="0" max="3" step="0.01" value="1.0">
        </div>
        <div>
          <div class="tiny">OPACITY</div>
          <input class="slider" id="bgOpacity" type="range" min="0" max="1" step="0.01" value="0.55">
        </div>
      </div>

      <div class="row">
        <div>
          <div class="tiny">DENSITY</div>
          <input class="slider" id="bgDensity" type="range" min="0.3" max="2.0" step="0.01" value="1.0">
        </div>
        <div>
          <div class="tiny">STROBE (1–6)</div>
          <input class="in mono" id="strobeRead" value="0" readonly>
        </div>
      </div>

      <div class="tiny muted">UNIVERSALS: 1–6 LIGHTS · SHIFT+I INVERT · N NULL · ESC UN-NULL</div>
    </div>
  </div>

  <!-- GLOBAL NOTE -->
  <div id="keta_note">
    <header>
      <span>KETA_NOTE (GLOBAL)</span>
      <button class="iconBtn" id="noteClose" title="collapse">–</button>
    </header>
    <textarea id="noteText" class="mono" placeholder=""></textarea>
  </div>

  <div id="surface">
    <div id="modules"></div>
  </div>

  <div id="bottom">
    <div class="muted">NULL: <span id="nullRead">OFF</span> · INVERT: <span id="invRead">OFF</span> · LIGHT: <span id="lightRead">0</span></div>
    <div class="muted mono" id="modeRead">MODULES: 0</div>
  </div>

<script>
/* =========================================================
   KETADATA COMPLIANCE CONSTANTS
========================================================= */
const FILE_ID   = "KETADATA_DIRECTORY_SENSORY";
const ROOM_ID   = "DIRECTORY";
const VERSION   = "v1";

const SHELL_HOME_URL = "system.html";     // (your continuity base)
const LANDING_URL    = "index11.html";    // shift+k

const NOTE_KEY  = "KETADATA_NOTE::GLOBAL::v1";
const STATE_KEY = `KETADATA_STATE::${FILE_ID}::${ROOM_ID}::${VERSION}`;

/* =========================================================
   DATA (YOUR ORDER, GROUPED BY SAME TITLE PREFIX)
   - No labels in module headers.
   - Links rendered as {NAME}.
========================================================= */
const GROUPS = [
  { id:"slopstream", links:[
    "https://ki-tya.github.io/ketadata/slopstream.html",
    "https://ki-tya.github.io/ketadata/slopstream2.html",
    "https://ki-tya.github.io/ketadata/slopstream3.html",
    "https://ki-tya.github.io/ketadata/slopstream4.html",
    "https://ki-tya.github.io/ketadata/slopstream5.html",
    "https://ki-tya.github.io/ketadata/slopstream6.html",
  ]},
  { id:"artaud", links:["https://ki-tya.github.io/ketadata/artaud.html"] },

  { id:"theory", links:[
    "https://ki-tya.github.io/ketadata/bataille1.html",
    "https://ki-tya.github.io/ketadata/borges.html",
    "https://ki-tya.github.io/ketadata/burroughs.html",
    "https://ki-tya.github.io/ketadata/debord.html",
    "https://ki-tya.github.io/ketadata/deleuze.html",
    "https://ki-tya.github.io/ketadata/foucault.html",
    "https://ki-tya.github.io/ketadata/goffman.html",
    "https://ki-tya.github.io/ketadata/holzer.html",
    "https://ki-tya.github.io/ketadata/jung.html",
    "https://ki-tya.github.io/ketadata/land.html",
    "https://ki-tya.github.io/ketadata/etal.html",
    "https://ki-tya.github.io/ketadata/mcluhan.html",
  ]},

  { id:"ritual", links:[
    "https://ki-tya.github.io/ketadata/ball.html",
    "https://ki-tya.github.io/ketadata/chakra.html",
    "https://ki-tya.github.io/ketadata/blacklotus.html",
  ]},

  { id:"mandala", links:[
    "https://ki-tya.github.io/ketadata/mandala.html",
    "https://ki-tya.github.io/ketadata/mandala2.html",
    "https://ki-tya.github.io/ketadata/mandala3.html",
  ]},
  { id:"mandalagpt", links:[
    "https://ki-tya.github.io/ketadata/mandalagpt.html",
    "https://ki-tya.github.io/ketadata/mandalagpt2.html",
    "https://ki-tya.github.io/ketadata/mandalagpt3.html",
    "https://ki-tya.github.io/ketadata/mandalagpt4.html",
  ]},

  { id:"bleak", links:["https://ki-tya.github.io/ketadata/bleak.html"] },
  { id:"beatball", links:["https://ki-tya.github.io/ketadata/beatball.html"] },

  { id:"subgpt", links:[
    "https://ki-tya.github.io/ketadata/subgpt2.html",
    "https://ki-tya.github.io/ketadata/subgpt3.html",
    "https://ki-tya.github.io/ketadata/subgpt4.html",
    "https://ki-tya.github.io/ketadata/subgpt5.html",
  ]},
  { id:"gptsubject", links:["https://ki-tya.github.io/ketadata/gptsubject.html"] },

  { id:"capture", links:["https://ki-tya.github.io/ketadata/capture.html"] },
  { id:"capturegpt", links:[
    "https://ki-tya.github.io/ketadata/capturegpt.html",
    "https://ki-tya.github.io/ketadata/capturegpt2.html",
    "https://ki-tya.github.io/ketadata/capturegpt3.html",
    "https://ki-tya.github.io/ketadata/capturegpt4.html",
    "https://ki-tya.github.io/ketadata/capturegpt5.html",
    "https://ki-tya.github.io/ketadata/capturegpt6.html",
    "https://ki-tya.github.io/ketadata/capturegpt7.html",
    "https://ki-tya.github.io/ketadata/capturegpt8.html",
  ]},

  { id:"dmt", links:[
    "https://ki-tya.github.io/ketadata/dmt.html",
    "https://ki-tya.github.io/ketadata/dmt2.html",
    "https://ki-tya.github.io/ketadata/dmt3.html",
    "https://ki-tya.github.io/ketadata/dmt4.html",
    "https://ki-tya.github.io/ketadata/dmtzoom.html",
  ]},

  { id:"mdmagpt", links:[
    "https://ki-tya.github.io/ketadata/mdmagpt.html",
    "https://ki-tya.github.io/ketadata/mdmagpt2.html",
  ]},

  { id:"funnel", links:[
    "https://ki-tya.github.io/ketadata/funnel.html",
    "https://ki-tya.github.io/ketadata/funnel1.html",
    "https://ki-tya.github.io/ketadata/funnel2.html",
    "https://ki-tya.github.io/ketadata/funnel3.html",
    "https://ki-tya.github.io/ketadata/funnel4.html",
  ]},

  { id:"hyperstition", links:["https://ki-tya.github.io/ketadata/hyperstition.html"] },
  { id:"map", links:["https://ki-tya.github.io/ketadata/map.html"] },

  { id:"misc", links:[
    "https://ki-tya.github.io/ketadata/misc.html",
    "https://ki-tya.github.io/ketadata/misc2.html",
    "https://ki-tya.github.io/ketadata/misc3.html",
    "https://ki-tya.github.io/ketadata/misc4.html",
    "https://ki-tya.github.io/ketadata/misc5.html",
    "https://ki-tya.github.io/ketadata/misc6.html",
    "https://ki-tya.github.io/ketadata/misc7.html",
    "https://ki-tya.github.io/ketadata/misc8.html",
  ]},

  { id:"newtrap", links:[
    "https://ki-tya.github.io/ketadata/newtrap.html",
    "https://ki-tya.github.io/ketadata/newtrap2.html",
    "https://ki-tya.github.io/ketadata/newtrap3.html",
  ]},

  { id:"pool", links:[
    "https://ki-tya.github.io/ketadata/pool.html",
    "https://ki-tya.github.io/ketadata/pool2.html",
    "https://ki-tya.github.io/ketadata/pool3.html",
    "https://ki-tya.github.io/ketadata/pool4.html",
    "https://ki-tya.github.io/ketadata/pool5.html",
    "https://ki-tya.github.io/ketadata/pool6.html",
  ]},

  { id:"release", links:[
    "https://ki-tya.github.io/ketadata/release.html",
    "https://ki-tya.github.io/ketadata/release2.html",
    "https://ki-tya.github.io/ketadata/release3.html",
    "https://ki-tya.github.io/ketadata/release4.html",
  ]},

  { id:"ripple", links:[
    "https://ki-tya.github.io/ketadata/ripple.html",
    "https://ki-tya.github.io/ketadata/ripple2.html",
    "https://ki-tya.github.io/ketadata/ripple3.html",
    "https://ki-tya.github.io/ketadata/ripplefull.html",
    "https://ki-tya.github.io/ketadata/ripplegpt.html",
    "https://ki-tya.github.io/ketadata/rippleinfra.html",
    "https://ki-tya.github.io/ketadata/rippleuv.html",
  ]},

  { id:"room", links:[
    "https://ki-tya.github.io/ketadata/room.html",
    "https://ki-tya.github.io/ketadata/room2.html",
  ]},

  { id:"sg", links:[
    "https://ki-tya.github.io/ketadata/sg.html",
    "https://ki-tya.github.io/ketadata/sg1.html",
  ]},

  { id:"coa", links:[
    "https://ki-tya.github.io/ketadata/coa3.html",
    "https://ki-tya.github.io/ketadata/coa4.html",
    "https://ki-tya.github.io/ketadata/coatofarms.html",
    "https://ki-tya.github.io/ketadata/coatofarms2.html",
  ]},
];

/* =========================================================
   HELPERS
========================================================= */
const $ = (q)=>document.querySelector(q);
const el = (tag, cls)=>{ const n=document.createElement(tag); if(cls) n.className=cls; return n; };

function basename(url){
  try{
    const u = new URL(url);
    const f = u.pathname.split("/").pop() || url;
    return f.replace(".html","").toUpperCase();
  }catch{
    return url.split("/").pop().replace(".html","").toUpperCase();
  }
}
function braceName(name){
  // visual style: {BLANK}. keep content minimal but not empty.
  return `{${name}}`;
}

/* =========================================================
   MODULE RENDER
========================================================= */
const modulesRoot = $("#modules");

function renderModules(order, collapsedMap){
  modulesRoot.innerHTML = "";
  const groupsById = new Map(GROUPS.map(g=>[g.id,g]));

  order.forEach(id=>{
    const g = groupsById.get(id);
    if(!g) return;

    const mod = el("div","mod");
    mod.dataset.id = id;
    mod.draggable = true;

    if(collapsedMap && collapsedMap[id]) mod.classList.add("collapsed");

    const head = el("div","modHead");

    const left = el("div","dragHandle");
    left.title = "DRAG MODULE";
    const sq = el("div","handleSquare");
    left.appendChild(sq);

    const btns = el("div","modBtns");
    const bCollapse = el("button","iconBtn");
    bCollapse.textContent = mod.classList.contains("collapsed") ? "+" : "–";
    bCollapse.title = "COLLAPSE";
    bCollapse.onclick = (e)=>{
      e.stopPropagation();
      mod.classList.toggle("collapsed");
      bCollapse.textContent = mod.classList.contains("collapsed") ? "+" : "–";
      persistState();
    };

    btns.appendChild(bCollapse);
    head.appendChild(left);
    head.appendChild(btns);

    const body = el("div","modBody");
    const links = el("div","links");

    g.links.forEach((u, idx)=>{
      const nm = basename(u);
      // If multiple in a group, append index to preserve differentiation without labels.
      const display = (g.links.length > 1) ? `${nm}_${String(idx+1).padStart(2,"0")}` : nm;

      const a = el("a","klink");
      a.href = u;
      a.target = "_blank";
      a.rel = "noopener";
      a.innerHTML = `<span class="br">{</span><span>${display}</span><span class="br">}</span>`;
      links.appendChild(a);
    });

    body.appendChild(links);
    mod.appendChild(head);
    mod.appendChild(body);
    modulesRoot.appendChild(mod);
  });

  $("#modeRead").textContent = `MODULES: ${order.length}`;
}

/* =========================================================
   DRAG REORDER (HTML5)
========================================================= */
let dragId = null;

modulesRoot.addEventListener("dragstart",(e)=>{
  const mod = e.target.closest(".mod");
  if(!mod) return;
  dragId = mod.dataset.id;
  e.dataTransfer.effectAllowed = "move";
  e.dataTransfer.setData("text/plain", dragId);
});

modulesRoot.addEventListener("dragover",(e)=>{
  e.preventDefault();
  e.dataTransfer.dropEffect = "move";
});

modulesRoot.addEventListener("drop",(e)=>{
  e.preventDefault();
  const dropMod = e.target.closest(".mod");
  if(!dropMod) return;

  const from = dragId;
  const to = dropMod.dataset.id;
  if(!from || !to || from === to) return;

  const st = getState();
  const ord = st.moduleOrder.slice();
  const fromIdx = ord.indexOf(from);
  const toIdx = ord.indexOf(to);
  ord.splice(fromIdx,1);
  ord.splice(toIdx,0,from);

  st.moduleOrder = ord;
  setState(st);
  dragId = null;
});

/* =========================================================
   HARD SNAP FEEL (surface scroll)
   - converts small wheel to resistance; large wheel "breaks through"
========================================================= */
(function(){
  const surf = $("#surface");
  let acc = 0;
  surf.addEventListener("wheel",(e)=>{
    // if user is using trackpad: keep it tight.
    const dy = e.deltaY;
    acc += dy;
    const threshold = 110; // "hard boundary"
    if(Math.abs(acc) < threshold){
      e.preventDefault();
      return;
    }
    // break-through jump
    const jump = Math.sign(acc) * 280;
    surf.scrollTop += jump;
    acc = 0;
    e.preventDefault();
  }, {passive:false});
})();

/* =========================================================
   GLOBAL NOTE (white square icon law)
========================================================= */
const note = $("#keta_note");
const noteText = $("#noteText");
const noteIcon = $("#noteIcon");

noteText.value = localStorage.getItem(NOTE_KEY) || "";
noteText.addEventListener("input", ()=> localStorage.setItem(NOTE_KEY, noteText.value));

function setNoteIcon(){
  const open = note.classList.contains("open");
  // open => outline (no fill); collapsed => filled
  noteIcon.style.background = open ? "transparent" : "#fff";
}
function toggleNote(){
  note.classList.toggle("open");
  setNoteIcon();
}
noteIcon.onclick = toggleNote;
$("#noteClose").onclick = toggleNote;

// drag note
(function(){
  let down=false, sx=0, sy=0, ox=0, oy=0;
  const head = note.querySelector("header");
  head.addEventListener("mousedown",(e)=>{
    down=true;
    sx=e.clientX; sy=e.clientY;
    const r = note.getBoundingClientRect();
    ox=r.left; oy=r.top;
  });
  window.addEventListener("mousemove",(e)=>{
    if(!down) return;
    note.style.left = (ox + (e.clientX - sx)) + "px";
    note.style.top  = (oy + (e.clientY - sy)) + "px";
  });
  window.addEventListener("mouseup",()=> down=false);
})();
setNoteIcon();

/* =========================================================
   STATE IO (portable envelope)
========================================================= */
$("#stateKeyLine").textContent = STATE_KEY;

function getState(){
  // derive collapsed map from DOM
  const collapsed = {};
  [...modulesRoot.querySelectorAll(".mod")].forEach(m=>{
    collapsed[m.dataset.id] = m.classList.contains("collapsed");
  });

  return {
    _ketadata:true,
    file_id: FILE_ID,
    room_id: ROOM_ID,
    version: VERSION,
    exported_at: new Date().toISOString(),
    state:{
      moduleOrder: currentOrder(),
      collapsed,
      bg:{
        speed: parseFloat($("#bgSpeed").value),
        opacity: parseFloat($("#bgOpacity").value),
        density: parseFloat($("#bgDensity").value),
      },
      strobe:{
        hz: window.__strobeHz || 0,
        on: window.__strobeOn || 0,
      }
    }
  };
}
function setState(env){
  if(!env || !env._ketadata || !env.state) return;

  const s = env.state;

  const order = Array.isArray(s.moduleOrder) ? s.moduleOrder : GROUPS.map(g=>g.id);
  const collapsed = s.collapsed || {};

  // background sliders
  if(s.bg){
    $("#bgSpeed").value = clamp(s.bg.speed,0,3,1.0);
    $("#bgOpacity").value = clamp(s.bg.opacity,0,1,0.55);
    $("#bgDensity").value = clamp(s.bg.density,0.3,2.0,1.0);
    applyBgVars();
  }

  // strobe
  if(s.strobe){
    applyStrobe(s.strobe.hz || 0);
    // on intensity
    window.__strobeOn = clamp(s.strobe.on,0,1,0);
    document.documentElement.style.setProperty("--strobeOn", window.__strobeOn);
  }

  renderModules(order.filter(id=>GROUPS.some(g=>g.id===id)), collapsed);
  persistState(false);
}
function clamp(v,min,max,def){
  v = Number.isFinite(+v) ? +v : def;
  return Math.max(min, Math.min(max, v));
}
function currentOrder(){
  return [...modulesRoot.querySelectorAll(".mod")].map(m=>m.dataset.id);
}

function persistState(write=true){
  const env = getState();
  if(write) localStorage.setItem(STATE_KEY, JSON.stringify(env));
  $("#stateBox").value = JSON.stringify(env, null, 2);
}

function loadState(){
  const raw = localStorage.getItem(STATE_KEY);
  if(!raw) return;
  try{ setState(JSON.parse(raw)); }
  catch(e){ console.warn(e); }
}

/* state panel controls */
function togglePanel(p){
  p.classList.toggle("open");
}
$("#btnState").onclick = ()=> togglePanel($("#statePanel"));
$("#closeState").onclick = ()=> $("#statePanel").classList.remove("open");

$("#btnInt").onclick = ()=> togglePanel($("#intPanel"));
$("#closeInt").onclick = ()=> $("#intPanel").classList.remove("open");

$("#btnExport").onclick = ()=> { persistState(false); };
$("#btnCopy").onclick = async ()=>{
  const t = $("#stateBox").value.trim();
  if(!t) return;
  try{ await navigator.clipboard.writeText(t); }
  catch{ /* ignore */ }
};
$("#btnImport").onclick = ()=>{
  const t = $("#stateBox").value.trim();
  if(!t) return;
  try{ setState(JSON.parse(t)); }
  catch(e){ alert("INVALID JSON"); }
};
$("#btnSave").onclick = ()=> persistState(true);
$("#btnLoad").onclick = ()=> loadState();
$("#btnReset").onclick = ()=>{
  localStorage.removeItem(STATE_KEY);
  const ord = GROUPS.map(g=>g.id);
  renderModules(ord, {});
  applyStrobe(0);
  $("#bgSpeed").value = 1.0;
  $("#bgOpacity").value = 0.55;
  $("#bgDensity").value = 1.0;
  applyBgVars();
  persistState(false);
};

/* =========================================================
   NAV BUTTONS
========================================================= */
$("#btnHome").onclick = ()=> location.href = SHELL_HOME_URL;
$("#btnLand").onclick = ()=> location.href = LANDING_URL;

/* =========================================================
   SYSTEM UNIVERSALS
========================================================= */
let nullMode=false;
let invert=false;

function setReadouts(){
  $("#nullRead").textContent = nullMode ? "ON" : "OFF";
  $("#invRead").textContent  = invert ? "ON" : "OFF";
  $("#lightRead").textContent = String(window.__lightLevel || 0);
  $("#strobeRead").value = String(window.__lightLevel || 0);
}

function applyStrobe(level){
  // map 0..6 to Hz + opacity
  window.__lightLevel = level;
  const map = {
    0:{hz:0, on:0},
    1:{hz:2, on:0.18},
    2:{hz:4, on:0.22},
    3:{hz:7, on:0.28},
    4:{hz:12,on:0.35},
    5:{hz:18,on:0.42},
    6:{hz:28,on:0.55},
  };
  const cfg = map[level] || map[0];
  window.__strobeHz = cfg.hz;
  window.__strobeOn = cfg.on;
  document.documentElement.style.setProperty("--strobeHz", cfg.hz);
  document.documentElement.style.setProperty("--strobeOn", cfg.on);
  document.body.classList.toggle("strobing", cfg.hz > 0);
  setReadouts();
  persistState(true);
}

window.addEventListener("keydown",(e)=>{
  // Null
  if(e.key === "n" || e.key === "N"){
    nullMode = !nullMode;
    document.body.classList.toggle("null", nullMode);
    setReadouts();
    return;
  }
  // Escape always un-null
  if(e.key === "Escape"){
    nullMode = false;
    document.body.classList.remove("null");
    setReadouts();
    return;
  }
  // Invert: Shift+I
  if(e.shiftKey && e.key.toLowerCase() === "i"){
    invert = !invert;
    document.body.classList.toggle("invert", invert);
    setReadouts();
    return;
  }
  // Lights 1-6
  if(!e.shiftKey && /^[0-6]$/.test(e.key)){
    applyStrobe(parseInt(e.key,10));
    return;
  }
  // Navigation: Shift+B and Shift+K
  if(e.shiftKey && e.key.toLowerCase() === "b"){
    location.href = SHELL_HOME_URL;
    return;
  }
  if(e.shiftKey && e.key.toLowerCase() === "k"){
    location.href = LANDING_URL;
    return;
  }
});

/* =========================================================
   BACKGROUND ANIMATION: concentric circles + wireframe grid
========================================================= */
const bgc = $("#bgc");
const bctx = bgc.getContext("2d", {alpha:true});
let W=0,H=0, t=0;

function resize(){
  W = bgc.width = Math.floor(innerWidth * devicePixelRatio);
  H = bgc.height = Math.floor(innerHeight * devicePixelRatio);
  bctx.setTransform(1,0,0,1,0,0);
}
window.addEventListener("resize", resize);
resize();

function applyBgVars(){
  document.documentElement.style.setProperty("--bgSpeed", $("#bgSpeed").value);
  document.documentElement.style.setProperty("--bgOpacity", $("#bgOpacity").value);
  document.documentElement.style.setProperty("--bgDensity", $("#bgDensity").value);
}
["bgSpeed","bgOpacity","bgDensity"].forEach(id=>{
  $("#"+id).addEventListener("input", ()=>{
    applyBgVars();
    persistState(true);
  });
});
applyBgVars();

function draw(){
  const sp = parseFloat($("#bgSpeed").value);
  const op = parseFloat($("#bgOpacity").value);
  const dn = parseFloat($("#bgDensity").value);

  t += 0.012 * sp;

  bctx.clearRect(0,0,W,H);
  bctx.save();
  bctx.globalAlpha = op;

  const cx = W*0.5, cy = H*0.52;
  bctx.translate(cx, cy);

  // subtle rotation to hypnotize
  bctx.rotate(Math.sin(t*0.25)*0.15);

  // wireframe grid (perspective-ish)
  const grid = Math.floor(28 * dn);
  const size = Math.min(W,H) * 0.58;
  bctx.strokeStyle = "rgba(255,255,255,.09)";
  bctx.lineWidth = 1 * devicePixelRatio;

  for(let i=-grid;i<=grid;i++){
    const a = i/grid;
    const y = a * size;
    const x = a * size;

    // horizontals (slightly warped)
    bctx.beginPath();
    for(let j=-grid;j<=grid;j++){
      const b = j/grid;
      const xx = b * size;
      const warp = Math.sin((b*3 + t)*0.8) * 6 * devicePixelRatio;
      if(j===-grid) bctx.moveTo(xx, y+warp);
      else bctx.lineTo(xx, y+warp);
    }
    bctx.stroke();

    // verticals
    bctx.beginPath();
    for(let j=-grid;j<=grid;j++){
      const b = j/grid;
      const yy = b * size;
      const warp = Math.cos((b*3 + t)*0.75) * 6 * devicePixelRatio;
      if(j===-grid) bctx.moveTo(x+warp, yy);
      else bctx.lineTo(x+warp, yy);
    }
    bctx.stroke();
  }

  // concentric circles (wireframe rings)
  const rings = Math.floor(22 * dn);
  for(let i=1;i<=rings;i++){
    const r = (i/rings) * (Math.min(W,H)*0.62);
    const pulse = 1 + Math.sin(t*1.2 + i*0.25)*0.02;
    bctx.strokeStyle = `rgba(255,255,255,${0.14 - (i/rings)*0.11})`;
    bctx.beginPath();
    bctx.arc(0,0,r*pulse,0,Math.PI*2);
    bctx.stroke();
  }

  // spokes
  const spokes = Math.floor(24 * dn);
  bctx.strokeStyle = "rgba(255,255,255,.07)";
  for(let i=0;i<spokes;i++){
    const ang = (i/spokes)*Math.PI*2 + t*0.15;
    const len = Math.min(W,H)*0.62;
    bctx.beginPath();
    bctx.moveTo(0,0);
    bctx.lineTo(Math.cos(ang)*len, Math.sin(ang)*len);
    bctx.stroke();
  }

  // center aperture glow (subtle)
  const g = bctx.createRadialGradient(0,0,0, 0,0,Math.min(W,H)*0.18);
  g.addColorStop(0, "rgba(255,255,255,.12)");
  g.addColorStop(1, "rgba(0,0,0,0)");
  bctx.fillStyle = g;
  bctx.beginPath();
  bctx.arc(0,0,Math.min(W,H)*0.18,0,Math.PI*2);
  bctx.fill();

  bctx.restore();
  requestAnimationFrame(draw);
}
draw();

/* =========================================================
   INIT
========================================================= */
(function init(){
  const ord = GROUPS.map(g=>g.id);
  renderModules(ord, {});
  loadState();
  persistState(false);
  setReadouts();
})();
</script>

<!--
============================================================
KETADATA SERIALIZATION STAMP
AE/EE/WB: WB
FILE_ID: KETADATA_DIRECTORY_SENSORY
ROOM_ID: DIRECTORY
VERSION: v1
UPDATED_AT: 2025-12-25
CHANGELOG:
- Movable modules (drag reorder) grouped by title-prefix
- Links styled as {NAME}
- Hypnotic concentric + wireframe moving background
- GLOBAL KETA_NOTE v1 (white square icon law)
- Portable state export/import/save/load
- System universals: 1–6 lights, Shift+I invert, N null, Esc un-null, Shift+B home, Shift+K land
============================================================
-->
</body>
</html>
