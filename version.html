<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KETADATA // LINK TRIAGE // FINAL vs DEPRECATED</title>
  <style>
    /* AE: AESTHETIC — KETADATA CORE (black, sharp, grid, no rounding) */
    :root{
      --bg:#000;
      --fg:#fff;
      --muted:#9a9a9a;
      --dim:#1a1a1a;
      --dim2:#111;
      --line:#2a2a2a;
      --line2:#3a3a3a;
      --accent:#fff;
      --warn:#ff3b30;
      --ok:#34c759;
      --shadow: 0 10px 30px rgba(0,0,0,.55);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --topbar-h: 44px;
      --bottombar-h: 32px;
      --panel-min: 240px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font-family:var(--sans);
      overflow:hidden;
    }
    .topbar{
      height:var(--topbar-h);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, #090909, #000);
      user-select:none;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
      font-family:var(--mono);
      letter-spacing:.08em;
      font-size:12px;
      text-transform:uppercase;
      color:var(--fg);
    }
    .brand .dot{
      width:8px;height:8px;border:1px solid var(--fg);background:var(--bg);
      display:inline-block;
    }
    .top-actions{
      display:flex; gap:8px; align-items:center;
      font-family:var(--mono);
      font-size:12px;
    }
    .btn{
      border:1px solid var(--line2);
      background:transparent;
      color:var(--fg);
      padding:6px 10px;
      font-family:var(--mono);
      font-size:12px;
      cursor:pointer;
      text-transform:uppercase;
      letter-spacing:.06em;
    }
    .btn:hover{border-color:var(--fg)}
    .btn:active{transform:translateY(1px)}
    .btn.danger{border-color:#5a1a1a;color:#ffd7d7}
    .btn.danger:hover{border-color:var(--warn);color:#fff}
    .btn.ok{border-color:#1e5a2c;color:#d9ffe3}
    .btn.ok:hover{border-color:var(--ok);color:#fff}
    .kbd{
      border:1px solid var(--line2);
      padding:2px 6px;
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
    }

    /* Layout: left / center / right with resizers */
    .shell{
      height:calc(100% - var(--topbar-h) - var(--bottombar-h));
      display:flex;
      width:100%;
    }
    .col{
      height:100%;
      min-width:var(--panel-min);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      background:var(--bg);
    }
    .col.left{width:28%}
    .col.center{flex:1;min-width:420px;border-left:1px solid var(--line);border-right:1px solid var(--line)}
    .col.right{width:26%}
    .resizer{
      width:6px; cursor:col-resize;
      background:linear-gradient(90deg, transparent, #0e0e0e, transparent);
      border-left:1px solid #000;
      border-right:1px solid #000;
    }
    .panel{
      border-bottom:1px solid var(--line);
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .panel-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px 10px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, #070707, #000);
      font-family:var(--mono);
      font-size:12px;
      letter-spacing:.06em;
      text-transform:uppercase;
      user-select:none;
    }
    .panel-head .meta{color:var(--muted); font-size:11px; letter-spacing:.02em; text-transform:none}
    .panel-body{
      padding:10px;
      overflow:auto;
      min-height:0;
    }
    textarea, input[type="text"]{
      width:100%;
      border:1px solid var(--line2);
      background:#050505;
      color:var(--fg);
      font-family:var(--mono);
      font-size:12px;
      padding:10px;
      outline:none;
    }
    textarea{min-height:160px;resize:vertical}
    input[type="text"]{height:34px}

    .small{font-size:11px;color:var(--muted);font-family:var(--mono);line-height:1.45}
    .hr{height:1px;background:var(--line);margin:10px 0}

    /* Center: modules grid */
    .center-wrap{
      position:relative;
      flex:1;
      min-height:0;
      overflow:auto;
      padding:12px;
      background:
        radial-gradient(1200px 600px at 50% 10%, rgba(255,255,255,.06), transparent 60%),
        linear-gradient(0deg, #000, #000);
    }
    .modules{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:start;
    }
    @media(max-width:1000px){
      .modules{grid-template-columns:1fr}
    }
    .module{
      border:1px solid var(--line2);
      background:linear-gradient(180deg, #060606, #000);
      box-shadow:var(--shadow);
      min-height:220px;
      display:flex;
      flex-direction:column;
    }
    .module-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px 10px;
      border-bottom:1px solid var(--line);
      font-family:var(--mono);
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.06em;
      cursor:move;
      user-select:none;
    }
    .module-head .count{
      color:var(--muted);
      font-size:11px;
      text-transform:none;
      letter-spacing:.02em;
      margin-left:8px;
    }
    .module-body{
      padding:10px;
      overflow:auto;
      min-height:0;
      flex:1;
    }
    .module.collapsed .module-body{display:none}
    .module-tools{display:flex; gap:6px; align-items:center}
    .iconbtn{
      width:28px;height:24px;
      border:1px solid var(--line2);
      background:transparent;color:var(--fg);
      cursor:pointer;font-family:var(--mono);font-size:12px;
    }
    .iconbtn:hover{border-color:var(--fg)}
    .list{display:flex;flex-direction:column;gap:8px}
    .item{
      border:1px solid var(--line);
      background:#030303;
      padding:8px 8px 8px 10px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:start;
    }
    .item:hover{border-color:var(--line2)}
    .item .url{
      font-family:var(--mono);
      font-size:12px;
      word-break:break-all;
      line-height:1.35;
    }
    .item .tags{
      margin-top:6px;
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
    }
    .item .actions{
      display:flex;
      gap:6px;
      align-items:center;
      justify-content:flex-end;
    }
    .pill{
      border:1px solid var(--line2);
      padding:3px 6px;
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      background:#050505;
      white-space:nowrap;
    }
    .pill.ok{border-color:#1e5a2c;color:#d9ffe3}
    .pill.warn{border-color:#5a1a1a;color:#ffd7d7}
    .notearea{
      margin-top:8px;
      display:none;
    }
    .item.openNote .notearea{display:block}
    .notearea textarea{min-height:70px}
    .link{
      color:var(--fg);
      text-decoration:none;
      border-bottom:1px solid rgba(255,255,255,.25);
    }
    .link:hover{border-bottom-color:rgba(255,255,255,.8)}

    /* Bottom bar = system universals panel trigger */
    .bottombar{
      height:var(--bottombar-h);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      border-top:1px solid var(--line);
      background:linear-gradient(0deg, #090909, #000);
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      user-select:none;
    }
    .bottombar .leftx{display:flex;gap:10px;align-items:center}
    .bottombar .rightx{display:flex;gap:10px;align-items:center}
    .toggle{
      cursor:pointer;
      padding:4px 8px;
      border:1px solid var(--line2);
      color:var(--fg);
      background:transparent;
      font-family:var(--mono);
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.06em;
    }
    .toggle:hover{border-color:var(--fg)}
    .system-drawer{
      position:absolute;
      left:0;right:0;
      bottom:var(--bottombar-h);
      height:40%;
      min-height:220px;
      background:linear-gradient(180deg, #060606, #000);
      border-top:1px solid var(--line);
      display:none;
      z-index:10;
    }
    .system-drawer.open{display:flex;flex-direction:column}
    .system-drawer .panel-body{padding:10px}
    .system-drawer textarea{min-height:150px}

    /* KETA NOTE floating */
    .keta-icon{
      width:18px;height:18px;
      border:1px solid var(--fg);
      background:var(--fg); /* filled when collapsed */
      cursor:pointer;
      margin-right:8px;
    }
    .keta-icon.open{background:var(--bg)} /* black inside when open */
    .keta-wrap{
      display:flex;align-items:center;gap:6px;
      font-family:var(--mono);
      font-size:12px;
      letter-spacing:.06em;
      text-transform:uppercase;
    }
    .floating-note{
      position:fixed;
      top:64px; left:16px;
      width:360px; height:260px;
      border:1px solid var(--line2);
      background:linear-gradient(180deg, #070707, #000);
      box-shadow:var(--shadow);
      z-index:50;
      display:none;
      resize:both;
      overflow:hidden;
    }
    .floating-note.open{display:flex;flex-direction:column}
    .floating-note .nh{
      padding:8px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-family:var(--mono);
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.06em;
      cursor:move;
      user-select:none;
    }
    .floating-note .nb{padding:10px;min-height:0;flex:1;overflow:auto}
    .floating-note textarea{
      background:#fff; color:#000; border:1px solid #000;
      min-height:100%; height:100%;
      resize:none;
      font-family:var(--mono);
      font-size:12px;
    }

    /* Right panel: final edits/prompt preview */
    .kv{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:8px 10px;
      align-items:center;
      font-family:var(--mono);
      font-size:12px;
    }
    .kv .k{color:var(--muted)}
    .preview{
      white-space:pre-wrap;
      font-family:var(--mono);
      font-size:12px;
      color:var(--fg);
      border:1px solid var(--line2);
      background:#050505;
      padding:10px;
      min-height:120px;
    }

    /* Invert mode */
    body.invert{
      background:#fff;
      color:#000;
    }
    body.invert .topbar,
    body.invert .bottombar,
    body.invert .panel-head,
    body.invert .module,
    body.invert .module-head,
    body.invert .system-drawer,
    body.invert .floating-note{
      background:#fff !important;
      color:#000 !important;
      border-color:#000 !important;
    }
    body.invert .btn,
    body.invert .toggle,
    body.invert .iconbtn,
    body.invert textarea,
    body.invert input[type="text"],
    body.invert .preview{
      background:#fff !important;
      color:#000 !important;
      border-color:#000 !important;
    }
    body.invert .item{background:#fff;border-color:#000}
    body.invert .muted, body.invert .small, body.invert .panel-head .meta, body.invert .module-head .count{color:#333 !important}
    body.invert .link{color:#000;border-bottom-color:rgba(0,0,0,.35)}
    body.invert .link:hover{border-bottom-color:rgba(0,0,0,.85)}
    body.invert .keta-icon{border-color:#000}
    body.invert .keta-icon.open{background:#fff}
    body.invert .keta-icon{background:#000}
    body.invert .pill{background:#fff;border-color:#000;color:#333}
    body.invert .pill.ok{border-color:#0a7a1f;color:#0a7a1f}
    body.invert .pill.warn{border-color:#a10000;color:#a10000}
  </style>
</head>

<body>
  <!-- WB: WIRING BRIDGE — TOP BAR (global actions + keta_note icon) -->
  <div class="topbar">
    <div class="brand">
      <span class="dot"></span>
      <span>KETADATA // LINK TRIAGE</span>
      <span style="color:var(--muted);letter-spacing:.02em;text-transform:none">FINAL vs DEPRECATED</span>
    </div>

    <div class="top-actions">
      <div class="keta-wrap" title="KETA NOTE (toggle)">
        <div id="ketaIcon" class="keta-icon" aria-label="Toggle Keta Note"></div>
        <span style="color:var(--muted)">KETA_NOTE</span>
      </div>
      <button class="btn" id="btnImportState">IMPORT STATE</button>
      <button class="btn" id="btnExportState">EXPORT STATE</button>
      <button class="btn" id="btnCopyState">COPY STATE</button>
      <button class="btn" id="btnCopyFinalLinks">COPY FINAL LINKS</button>
      <button class="btn" id="btnCopyDeprecatedLinks">COPY DEPRECATED LINKS</button>
      <button class="btn danger" id="btnReset">RESET</button>
      <span class="kbd" title="Invert">SHIFT+I</span>
    </div>
  </div>

  <div class="shell">
    <!-- LEFT COLUMN: INPUT + BULK CONTROLS -->
    <div class="col left">
      <div class="panel" style="flex: 1.1;">
        <div class="panel-head">
          <div>LINK INPUT</div>
          <div class="meta">paste urls or paths</div>
        </div>
        <div class="panel-body">
          <div class="small">
            Paste any of:
            <br>• full URLs (https://ketadata.com/x.html)
            <br>• repo paths (x.html, folder/x.html)
            <br><br>Engine will normalize + dedupe + sort.
          </div>
          <div class="hr"></div>
          <textarea id="linkInput" placeholder="PASTE LINKS HERE (one per line)"></textarea>
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <button class="btn ok" id="btnIngest">INGEST → POOL</button>
            <button class="btn" id="btnClearInput">CLEAR</button>
            <button class="btn" id="btnAddFromState">RELOAD FROM STATE</button>
          </div>
          <div class="hr"></div>
          <div class="kv">
            <div class="k">BASE URL</div>
            <div><input type="text" id="baseUrl" value="https://ketadata.com/" /></div>
            <div class="k">FILTER</div>
            <div><input type="text" id="filterText" placeholder="type to filter pool list" /></div>
          </div>
          <div class="small" style="margin-top:10px">
            Bulk actions apply to currently filtered Pool results.
          </div>
          <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <button class="btn ok" id="btnBulkToFinal">BULK → FINAL</button>
            <button class="btn danger" id="btnBulkToDeprecated">BULK → DEPRECATED</button>
            <button class="btn" id="btnBulkRemove">BULK REMOVE</button>
          </div>
        </div>
      </div>

      <div class="panel" style="flex: .9;">
        <div class="panel-head">
          <div>POOL</div>
          <div class="meta"><span id="poolCount">0</span> items</div>
        </div>
        <div class="panel-body" id="poolList"></div>
      </div>
    </div>

    <div class="resizer" id="resizerL" title="Drag to resize"></div>

    <!-- CENTER COLUMN: FINAL + DEPRECATED MODULES -->
    <div class="col center">
      <div class="center-wrap">
        <div class="modules" id="modules">
          <div class="module" data-module="final">
            <div class="module-head" data-drag="module">
              <div>
                FINAL
                <span class="count">(<span id="finalCount">0</span>)</span>
              </div>
              <div class="module-tools">
                <button class="iconbtn" data-action="collapse" title="Collapse">–</button>
                <button class="iconbtn" data-action="sort" title="Sort A→Z">A</button>
              </div>
            </div>
            <div class="module-body" id="finalList"></div>
          </div>

          <div class="module" data-module="deprecated">
            <div class="module-head" data-drag="module">
              <div>
                DEPRECATED
                <span class="count">(<span id="deprecatedCount">0</span>)</span>
              </div>
              <div class="module-tools">
                <button class="iconbtn" data-action="collapse" title="Collapse">–</button>
                <button class="iconbtn" data-action="sort" title="Sort A→Z">A</button>
              </div>
            </div>
            <div class="module-body" id="deprecatedList"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="resizer" id="resizerR" title="Drag to resize"></div>

    <!-- RIGHT COLUMN: FINAL EDITS / CORRECTIONS / PROMPT PREVIEW -->
    <div class="col right">
      <div class="panel" style="flex: .9;">
        <div class="panel-head">
          <div>SELECTION</div>
          <div class="meta">edit + correct</div>
        </div>
        <div class="panel-body">
          <div class="small">Click any item (Pool / Final / Deprecated) to select it here.</div>
          <div class="hr"></div>
          <div class="kv">
            <div class="k">STATUS</div>
            <div><span id="selStatus" class="pill">none</span></div>

            <div class="k">URL</div>
            <div><div id="selUrl" class="small">—</div></div>

            <div class="k">TITLE</div>
            <div><input id="selTitle" type="text" placeholder="optional label/title"/></div>

            <div class="k">TAG</div>
            <div><input id="selTag" type="text" placeholder="optional tag"/></div>
          </div>

          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <button class="btn ok" id="selToFinal">→ FINAL</button>
            <button class="btn danger" id="selToDeprecated">→ DEPRECATED</button>
            <button class="btn" id="selToPool">→ POOL</button>
            <button class="btn" id="selOpen">OPEN</button>
          </div>

          <div class="hr"></div>
          <div class="small">Notes (per-item). Stored in state.</div>
          <textarea id="selNote" placeholder="note for this item"></textarea>

          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <button class="btn ok" id="selSave">SAVE</button>
            <button class="btn" id="selClear">CLEAR</button>
          </div>
        </div>
      </div>

      <div class="panel" style="flex: 1.1;">
        <div class="panel-head">
          <div>PROMPT / EXPORT PREVIEW</div>
          <div class="meta">copy/paste</div>
        </div>
        <div class="panel-body">
          <div class="small">Auto-generated summary you can paste into notes, prompts, or room sorter modules.</div>
          <div class="hr"></div>
          <div class="preview" id="exportPreview"></div>
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <button class="btn" id="btnCopyPreview">COPY PREVIEW</button>
            <button class="btn" id="btnRefreshPreview">REFRESH</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SYSTEM DRAWER (universals/constraints/references) -->
  <div class="system-drawer" id="systemDrawer">
    <div class="panel-head">
      <div>SYSTEM UNIVERSALS</div>
      <div class="meta">laws / constraints / refs</div>
    </div>
    <div class="panel-body">
      <textarea id="systemUniversals" placeholder="SYSTEM LAWS / CONSTRAINTS / REFERENCES"></textarea>
      <div class="small" style="margin-top:8px">
        Stored in state. This drawer is meant to be the contract floor.
      </div>
    </div>
  </div>

  <div class="bottombar">
    <div class="leftx">
      <button class="toggle" id="toggleSystem">SYSTEM</button>
      <span>STATE: <span id="stateSig">∅</span></span>
    </div>
    <div class="rightx">
      <span>SHIFT+I = invert</span>
      <span>drag module headers to reorder</span>
    </div>
  </div>

  <!-- KETA NOTE floating (white note, movable) -->
  <div class="floating-note" id="ketaNote">
    <div class="nh" id="ketaNoteHead">
      <div>KETA NOTE</div>
      <div style="display:flex;gap:6px;align-items:center">
        <button class="iconbtn" id="ketaNoteMin" title="Hide">×</button>
      </div>
    </div>
    <div class="nb">
      <textarea id="ketaNoteText" placeholder="WHITE NOTE. GLOBAL PAGE NOTE."></textarea>
    </div>
  </div>

  <input type="file" id="stateFile" accept="application/json" style="display:none"/>

  <script>
    /* EE: ENGINE — DATA MODEL + OPERATIONS (no aesthetics here) */

    const DEFAULTS = {
      baseUrl: "https://ketadata.com/",
      pool: [],
      final: [],
      deprecated: [],
      items: {}, // keyed by url -> {title, tag, note}
      ketaNote: "",
      systemUniversals: "",
      ui: {
        invert:false,
        modulesOrder:["final","deprecated"],
        modulesCollapsed:{ final:false, deprecated:false },
        split:{ left:28, right:26 } // percent widths
      }
    };

    let STATE = structuredClone(DEFAULTS);
    let selectedUrl = null;
    let selectedFrom = null; // "pool" | "final" | "deprecated"

    const $ = (id)=>document.getElementById(id);

    function stableHash(str){
      // EE: tiny signature for quick sanity
      let h=2166136261;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h>>>0).toString(16).slice(0,8);
    }

    function normalizeLineToUrl(line){
      const base = (STATE.baseUrl || DEFAULTS.baseUrl).trim();
      let s = (line||"").trim();
      if(!s) return null;

      // Strip JSON quotes/commas if pasted from tree:
      s = s.replace(/^"+|"+$/g,"").replace(/,$/,"").trim();

      // If pasted as JSON path field like: "path": "x.html"
      const m = s.match(/"path"\s*:\s*"([^"]+)"/i);
      if(m) s = m[1].trim();

      // If it's already a URL:
      if(/^https?:\/\//i.test(s)){
        // keep as is
        return s;
      }

      // If it starts with a slash, treat as path:
      if(s.startsWith("/")) s = s.slice(1);

      // If it contains spaces, likely not a path; ignore:
      // (but allow content like "folder/file.html")
      // If no .html, still allow (maybe index route) — but you asked links, so keep only html-ish.
      // We'll accept anything; filtering is your job.
      return base + s;
    }

    function dedupeSorted(arr){
      return Array.from(new Set(arr)).sort((a,b)=>a.localeCompare(b));
    }

    function getMeta(url){
      return STATE.items[url] || { title:"", tag:"", note:"" };
    }

    function setMeta(url, patch){
      STATE.items[url] = { ...getMeta(url), ...patch };
      touch();
    }

    function moveUrl(url, from, to){
      if(!url) return;
      const removeFrom = (listName)=>{
        const idx = STATE[listName].indexOf(url);
        if(idx>=0) STATE[listName].splice(idx,1);
      };
      removeFrom("pool");
      removeFrom("final");
      removeFrom("deprecated");
      if(to) STATE[to].push(url);
      STATE.pool = dedupeSorted(STATE.pool);
      STATE.final = dedupeSorted(STATE.final);
      STATE.deprecated = dedupeSorted(STATE.deprecated);
      touch();
    }

    function removeUrl(url){
      if(!url) return;
      STATE.pool = STATE.pool.filter(x=>x!==url);
      STATE.final = STATE.final.filter(x=>x!==url);
      STATE.deprecated = STATE.deprecated.filter(x=>x!==url);
      if(selectedUrl===url){ clearSelection(); }
      touch();
    }

    function touch(){
      // EE: persist to localStorage each mutation (local-first)
      try{
        localStorage.setItem("ketadata_link_triage_state_v1", JSON.stringify(STATE));
      }catch(e){}
      renderAll();
    }

    function loadLocal(){
      try{
        const raw = localStorage.getItem("ketadata_link_triage_state_v1");
        if(!raw) return false;
        const parsed = JSON.parse(raw);
        STATE = mergeDefaults(parsed);
        return true;
      }catch(e){ return false; }
    }

    function mergeDefaults(obj){
      const out = structuredClone(DEFAULTS);
      // shallow+deep enough for our needs
      Object.assign(out, obj || {});
      out.ui = Object.assign(structuredClone(DEFAULTS.ui), (obj && obj.ui) || {});
      out.ui.modulesCollapsed = Object.assign(structuredClone(DEFAULTS.ui.modulesCollapsed), (obj && obj.ui && obj.ui.modulesCollapsed) || {});
      out.items = Object.assign({}, (obj && obj.items) || {});
      out.pool = Array.isArray(out.pool)?out.pool:[];
      out.final = Array.isArray(out.final)?out.final:[];
      out.deprecated = Array.isArray(out.deprecated)?out.deprecated:[];
      // normalize + sort
      out.pool = dedupeSorted(out.pool);
      out.final = dedupeSorted(out.final);
      out.deprecated = dedupeSorted(out.deprecated);
      if(!out.baseUrl) out.baseUrl = DEFAULTS.baseUrl;
      return out;
    }

    function exportState(){
      return JSON.stringify(STATE, null, 2);
    }

    function importStateFromText(text){
      const parsed = JSON.parse(text);
      STATE = mergeDefaults(parsed);
      touch();
    }

    /* WB: WIRING BRIDGE — UI RENDERING + EVENTS */

    function applySplit(){
      const leftPct = clamp(STATE.ui.split.left, 16, 45);
      const rightPct = clamp(STATE.ui.split.right, 16, 45);
      document.querySelector(".col.left").style.width = leftPct + "%";
      document.querySelector(".col.right").style.width = rightPct + "%";
    }

    function clamp(n,a,b){ return Math.max(a, Math.min(b, Number(n)||0)); }

    function renderPool(){
      const wrap = $("poolList");
      const filter = ($("filterText").value || "").trim().toLowerCase();
      const items = STATE.pool.filter(u => !filter || u.toLowerCase().includes(filter));
      $("poolCount").textContent = String(items.length);

      wrap.innerHTML = "";
      const list = document.createElement("div");
      list.className = "list";
      items.forEach(url=>{
        list.appendChild(renderItem(url, "pool"));
      });
      wrap.appendChild(list);
    }

    function renderList(targetId, arr, listName){
      const wrap = $(targetId);
      wrap.innerHTML = "";
      const list = document.createElement("div");
      list.className = "list";
      arr.forEach(url=>{
        list.appendChild(renderItem(url, listName));
      });
      wrap.appendChild(list);
    }

    function renderItem(url, listName){
      const meta = getMeta(url);
      const item = document.createElement("div");
      item.className = "item";
      item.dataset.url = url;
      item.dataset.from = listName;

      const left = document.createElement("div");
      const top = document.createElement("div");
      top.className = "url";

      const a = document.createElement("a");
      a.href = url;
      a.target = "_blank";
      a.rel = "noopener";
      a.className = "link";
      a.textContent = url;
      top.appendChild(a);

      const tags = document.createElement("div");
      tags.className = "tags";
      const bits = [];
      if(meta.title) bits.push(`title: ${meta.title}`);
      if(meta.tag) bits.push(`tag: ${meta.tag}`);
      tags.textContent = bits.length ? bits.join("  |  ") : "—";
      left.appendChild(top);
      left.appendChild(tags);

      const right = document.createElement("div");
      right.className = "actions";

      const statusPill = document.createElement("div");
      statusPill.className = "pill " + (listName==="final" ? "ok" : (listName==="deprecated" ? "warn" : ""));
      statusPill.textContent = listName.toUpperCase();
      right.appendChild(statusPill);

      const btnNote = document.createElement("button");
      btnNote.className = "iconbtn";
      btnNote.textContent = "N";
      btnNote.title = "Toggle note";
      btnNote.addEventListener("click",(e)=>{
        e.stopPropagation();
        item.classList.toggle("openNote");
      });
      right.appendChild(btnNote);

      const btnToFinal = document.createElement("button");
      btnToFinal.className = "iconbtn";
      btnToFinal.textContent = "F";
      btnToFinal.title = "Move to FINAL";
      btnToFinal.addEventListener("click",(e)=>{
        e.stopPropagation();
        moveUrl(url, listName, "final");
      });
      right.appendChild(btnToFinal);

      const btnToDep = document.createElement("button");
      btnToDep.className = "iconbtn";
      btnToDep.textContent = "D";
      btnToDep.title = "Move to DEPRECATED";
      btnToDep.addEventListener("click",(e)=>{
        e.stopPropagation();
        moveUrl(url, listName, "deprecated");
      });
      right.appendChild(btnToDep);

      const btnDel = document.createElement("button");
      btnDel.className = "iconbtn";
      btnDel.textContent = "×";
      btnDel.title = "Remove";
      btnDel.addEventListener("click",(e)=>{
        e.stopPropagation();
        removeUrl(url);
      });
      right.appendChild(btnDel);

      const noteArea = document.createElement("div");
      noteArea.className = "notearea";
      const t = document.createElement("textarea");
      t.placeholder = "note on this version";
      t.value = meta.note || "";
      t.addEventListener("input", ()=> setMeta(url, { note: t.value }));
      noteArea.appendChild(t);

      item.appendChild(left);
      item.appendChild(right);
      item.appendChild(noteArea);

      item.addEventListener("click", ()=>{
        select(url, listName);
      });

      return item;
    }

    function renderModules(){
      $("finalCount").textContent = String(STATE.final.length);
      $("deprecatedCount").textContent = String(STATE.deprecated.length);

      renderList("finalList", STATE.final, "final");
      renderList("deprecatedList", STATE.deprecated, "deprecated");

      // order modules per state
      const modules = $("modules");
      const mFinal = document.querySelector('.module[data-module="final"]');
      const mDep = document.querySelector('.module[data-module="deprecated"]');
      modules.innerHTML = "";
      STATE.ui.modulesOrder.forEach(k=>{
        modules.appendChild(k==="final"?mFinal:mDep);
      });

      // collapsed flags
      document.querySelectorAll(".module").forEach(mod=>{
        const key = mod.dataset.module;
        const collapsed = !!STATE.ui.modulesCollapsed[key];
        mod.classList.toggle("collapsed", collapsed);
      });
    }

    function renderPreview(){
      const base = (STATE.baseUrl||"").trim();
      const lines = [];

      lines.push("KETADATA // LINK TRIAGE");
      lines.push(`BASE: ${base}`);
      lines.push("");
      lines.push("FINAL:");
      STATE.final.forEach(u=>{
        const m = getMeta(u);
        const label = m.title ? ` — ${m.title}` : "";
        const tag = m.tag ? ` [${m.tag}]` : "";
        lines.push(`- ${u}${tag}${label}`);
        if(m.note) lines.push(`  note: ${m.note.replace(/\n/g," / ")}`);
      });
      lines.push("");
      lines.push("DEPRECATED:");
      STATE.deprecated.forEach(u=>{
        const m = getMeta(u);
        const label = m.title ? ` — ${m.title}` : "";
        const tag = m.tag ? ` [${m.tag}]` : "";
        lines.push(`- ${u}${tag}${label}`);
        if(m.note) lines.push(`  note: ${m.note.replace(/\n/g," / ")}`);
      });

      $("exportPreview").textContent = lines.join("\n");
    }

    function renderTop(){
      $("baseUrl").value = STATE.baseUrl || DEFAULTS.baseUrl;
      $("ketaNoteText").value = STATE.ketaNote || "";
      $("systemUniversals").value = STATE.systemUniversals || "";
      document.body.classList.toggle("invert", !!STATE.ui.invert);

      // keta icon fill logic: filled when collapsed; black inside when on screen
      const icon = $("ketaIcon");
      const noteOpen = $("ketaNote").classList.contains("open");
      icon.classList.toggle("open", noteOpen);

      const sig = stableHash(JSON.stringify({
        p:STATE.pool.length,
        f:STATE.final.length,
        d:STATE.deprecated.length,
        i:Object.keys(STATE.items).length
      }));
      $("stateSig").textContent = sig;
      applySplit();
    }

    function renderAll(){
      renderTop();
      renderPool();
      renderModules();
      renderPreview();
      renderSelectionPanel();
    }

    function select(url, from){
      selectedUrl = url;
      selectedFrom = from;
      const meta = getMeta(url);
      $("selUrl").textContent = url;
      $("selTitle").value = meta.title || "";
      $("selTag").value = meta.tag || "";
      $("selNote").value = meta.note || "";

      const pill = $("selStatus");
      pill.className = "pill " + (from==="final"?"ok":(from==="deprecated"?"warn":""));
      pill.textContent = from || "none";
      renderSelectionPanel(); // for consistency
    }

    function clearSelection(){
      selectedUrl = null;
      selectedFrom = null;
      $("selUrl").textContent = "—";
      $("selTitle").value = "";
      $("selTag").value = "";
      $("selNote").value = "";
      const pill = $("selStatus");
      pill.className = "pill";
      pill.textContent = "none";
    }

    function renderSelectionPanel(){
      // keep selection status synced if moved
      if(!selectedUrl) return;
      let from = "pool";
      if(STATE.final.includes(selectedUrl)) from = "final";
      else if(STATE.deprecated.includes(selectedUrl)) from = "deprecated";
      selectedFrom = from;
      const pill = $("selStatus");
      pill.className = "pill " + (from==="final"?"ok":(from==="deprecated"?"warn":""));
      pill.textContent = from;
    }

    function ingest(){
      const raw = $("linkInput").value || "";
      const lines = raw.split(/\r?\n/);
      const urls = [];
      lines.forEach(line=>{
        const u = normalizeLineToUrl(line);
        if(u) urls.push(u);
      });
      if(!urls.length) return;

      // Put into pool by default
      urls.forEach(u=>{
        if(!STATE.pool.includes(u) && !STATE.final.includes(u) && !STATE.deprecated.includes(u)){
          STATE.pool.push(u);
        }
      });
      STATE.pool = dedupeSorted(STATE.pool);
      touch();
    }

    function bulkMove(filteredTo){
      const filter = ($("filterText").value || "").trim().toLowerCase();
      const items = STATE.pool.filter(u => !filter || u.toLowerCase().includes(filter));
      items.forEach(u=> moveUrl(u, "pool", filteredTo));
    }

    function bulkRemove(){
      const filter = ($("filterText").value || "").trim().toLowerCase();
      const items = STATE.pool.filter(u => !filter || u.toLowerCase().includes(filter));
      items.forEach(u=> removeUrl(u));
    }

    function copyToClipboard(text){
      return navigator.clipboard.writeText(text);
    }

    function download(filename, text){
      const blob = new Blob([text], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 2500);
    }

    /* WB: EVENTS */

    // local load
    loadLocal();
    // ensure baseUrl from UI input
    $("baseUrl").addEventListener("input", ()=>{
      STATE.baseUrl = $("baseUrl").value;
      touch();
    });

    $("btnIngest").addEventListener("click", ingest);
    $("btnClearInput").addEventListener("click", ()=>{ $("linkInput").value=""; });
    $("btnAddFromState").addEventListener("click", ()=>{ renderAll(); });

    $("filterText").addEventListener("input", renderAll);

    $("btnBulkToFinal").addEventListener("click", ()=> bulkMove("final"));
    $("btnBulkToDeprecated").addEventListener("click", ()=> bulkMove("deprecated"));
    $("btnBulkRemove").addEventListener("click", bulkRemove);

    $("btnExportState").addEventListener("click", ()=>{
      const json = exportState();
      download("ketadata_link_triage_state.json", json);
    });
    $("btnCopyState").addEventListener("click", async ()=>{
      await copyToClipboard(exportState());
    });

    $("btnImportState").addEventListener("click", ()=> $("stateFile").click());
    $("stateFile").addEventListener("change", async (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      const text = await f.text();
      importStateFromText(text);
      e.target.value = "";
    });

    $("btnCopyFinalLinks").addEventListener("click", async ()=>{
      await copyToClipboard(STATE.final.slice().sort().join("\n"));
    });
    $("btnCopyDeprecatedLinks").addEventListener("click", async ()=>{
      await copyToClipboard(STATE.deprecated.slice().sort().join("\n"));
    });

    $("btnReset").addEventListener("click", ()=>{
      if(!confirm("RESET STATE? (local only)")) return;
      STATE = structuredClone(DEFAULTS);
      selectedUrl = null;
      selectedFrom = null;
      touch();
    });

    // Selection actions
    $("selSave").addEventListener("click", ()=>{
      if(!selectedUrl) return;
      setMeta(selectedUrl, {
        title: $("selTitle").value.trim(),
        tag: $("selTag").value.trim(),
        note: $("selNote").value
      });
    });
    $("selClear").addEventListener("click", ()=>{
      clearSelection();
    });
    $("selOpen").addEventListener("click", ()=>{
      if(!selectedUrl) return;
      window.open(selectedUrl, "_blank", "noopener");
    });
    $("selToFinal").addEventListener("click", ()=>{
      if(!selectedUrl) return;
      moveUrl(selectedUrl, selectedFrom, "final");
      select(selectedUrl, "final");
    });
    $("selToDeprecated").addEventListener("click", ()=>{
      if(!selectedUrl) return;
      moveUrl(selectedUrl, selectedFrom, "deprecated");
      select(selectedUrl, "deprecated");
    });
    $("selToPool").addEventListener("click", ()=>{
      if(!selectedUrl) return;
      moveUrl(selectedUrl, selectedFrom, "pool");
      select(selectedUrl, "pool");
    });

    // Per-item note sync (selection panel live)
    ["selTitle","selTag","selNote"].forEach(id=>{
      $(id).addEventListener("input", ()=>{
        if(!selectedUrl) return;
        setMeta(selectedUrl, {
          title: $("selTitle").value.trim(),
          tag: $("selTag").value.trim(),
          note: $("selNote").value
        });
      });
    });

    $("btnCopyPreview").addEventListener("click", async ()=> {
      await copyToClipboard($("exportPreview").textContent || "");
    });
    $("btnRefreshPreview").addEventListener("click", renderPreview);

    // System drawer
    $("toggleSystem").addEventListener("click", ()=>{
      $("systemDrawer").classList.toggle("open");
    });
    $("systemUniversals").addEventListener("input", ()=>{
      STATE.systemUniversals = $("systemUniversals").value;
      touch();
    });

    // Keta note toggle
    function setKetaOpen(open){
      const note = $("ketaNote");
      note.classList.toggle("open", open);
      $("ketaIcon").classList.toggle("open", open);
    }
    $("ketaIcon").addEventListener("click", ()=>{
      const open = !$("ketaNote").classList.contains("open");
      setKetaOpen(open);
    });
    $("ketaNoteMin").addEventListener("click", ()=> setKetaOpen(false));
    $("ketaNoteText").addEventListener("input", ()=>{
      STATE.ketaNote = $("ketaNoteText").value;
      touch();
    });

    // Shift+I invert (avoid collisions while typing)
    document.addEventListener("keydown", (e)=>{
      if(e.shiftKey && (e.key==="I" || e.key==="i")){
        e.preventDefault();
        STATE.ui.invert = !STATE.ui.invert;
        touch();
      }
    });

    // Module collapse/sort
    document.querySelectorAll(".module").forEach(mod=>{
      mod.addEventListener("click", (e)=>{
        const btn = e.target.closest("[data-action]");
        if(!btn) return;
        const action = btn.dataset.action;
        const key = mod.dataset.module;
        if(action==="collapse"){
          STATE.ui.modulesCollapsed[key] = !STATE.ui.modulesCollapsed[key];
          touch();
        }
        if(action==="sort"){
          STATE[key] = dedupeSorted(STATE[key]);
          touch();
        }
      });
    });

    // Resizers
    function makeResizer(resizerEl, side){
      let startX=0, startLeft=0, startRight=0;
      const onMove = (ev)=>{
        const dx = ev.clientX - startX;
        const w = window.innerWidth;
        const pct = (dx / w) * 100;
        if(side==="left"){
          STATE.ui.split.left = clamp(startLeft + pct, 16, 45);
        }else{
          STATE.ui.split.right = clamp(startRight - pct, 16, 45);
        }
        applySplit();
      };
      const onUp = ()=>{
        window.removeEventListener("mousemove", onMove);
        window.removeEventListener("mouseup", onUp);
        touch();
      };
      resizerEl.addEventListener("mousedown",(ev)=>{
        startX = ev.clientX;
        startLeft = STATE.ui.split.left;
        startRight = STATE.ui.split.right;
        window.addEventListener("mousemove", onMove);
        window.addEventListener("mouseup", onUp);
      });
    }
    makeResizer($("resizerL"), "left");
    makeResizer($("resizerR"), "right");

    // Dragging: modules reorder + keta note move
    function enableDrag(el, handle, onDrop){
      let dragging=false, sx=0, sy=0, ox=0, oy=0;
      handle.addEventListener("mousedown",(e)=>{
        // do not start drag on button clicks
        if(e.target.closest("button")) return;
        dragging=true;
        sx=e.clientX; sy=e.clientY;
        const r = el.getBoundingClientRect();
        ox=r.left; oy=r.top;
        el.style.position = (el=== $("ketaNote")) ? "fixed" : el.style.position;
        el.style.zIndex = (el=== $("ketaNote")) ? "60" : el.style.zIndex;
        window.addEventListener("mousemove", move);
        window.addEventListener("mouseup", up);
      });
      function move(e){
        if(!dragging) return;
        const dx = e.clientX - sx;
        const dy = e.clientY - sy;
        if(el=== $("ketaNote")){
          el.style.left = (ox + dx) + "px";
          el.style.top  = (oy + dy) + "px";
        }
      }
      function up(e){
        if(!dragging) return;
        dragging=false;
        window.removeEventListener("mousemove", move);
        window.removeEventListener("mouseup", up);
        if(onDrop) onDrop(e);
      }
    }

    // Module reorder via drag+drop on headers
    (function moduleDnD(){
      const modulesEl = $("modules");
      let dragKey=null;

      modulesEl.addEventListener("dragstart", (e)=>{
        const head = e.target.closest(".module-head");
        if(!head) return;
        const mod = head.closest(".module");
        dragKey = mod.dataset.module;
        e.dataTransfer.setData("text/plain", dragKey);
        e.dataTransfer.effectAllowed = "move";
      });

      modulesEl.addEventListener("dragover", (e)=>{
        if(dragKey) e.preventDefault();
      });

      modulesEl.addEventListener("drop", (e)=>{
        e.preventDefault();
        const head = e.target.closest(".module-head");
        if(!head) return;
        const mod = head.closest(".module");
        const targetKey = mod.dataset.module;
        if(!dragKey || dragKey===targetKey) return;
        const order = STATE.ui.modulesOrder.slice();
        const a = order.indexOf(dragKey);
        const b = order.indexOf(targetKey);
        order.splice(a,1);
        order.splice(b,0,dragKey);
        STATE.ui.modulesOrder = order;
        dragKey=null;
        touch();
      });

      // make headers draggable
      document.querySelectorAll(".module-head").forEach(h=>{
        h.setAttribute("draggable","true");
      });
    })();

    // Keta note drag
    enableDrag($("ketaNote"), $("ketaNoteHead"));

    // Initial render
    renderAll();
  </script>

  <!--
    AE: AESTHETIC — visual system (black, sharp, minimal; invert support)
    EE: ENGINE — state model, normalize/dedupe/sort, local persistence, export/import
    WB: WIRING BRIDGE — event listeners, rendering, interactions (drag, resize, selection)
  -->
</body>
</html>
