<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KETADATA — COLOR VAULT</title>

  <style>
    :root{
      --void:#000000;
      --mind:#ffffff;

      --laser:#ffffff;
      --steel:#666666;
      --hair:rgba(255,255,255,.12);
      --hair2:rgba(255,255,255,.08);

      --record:#ff1a1a;
      --darkroom:#4a0000;
      --danger:#ff0000;

      --uv:#7a00ff;
      --violet:#b000ff;
      --ultraviolet:#5b2cff;

      --med-green:#00ff66;
      --xray-cyan:#00ffff;
      --shock-magenta:#ff00ff;
      --med-blue:#0088ff;

      --sans: Arial, Helvetica, sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;

      --tile: 128px;
      --gap: 14px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: var(--void);
      color: var(--mind);
      font-family: var(--sans);
      letter-spacing:.02em;
      overflow-x:hidden;
    }

    .top{
      position: sticky;
      top: 0;
      z-index: 50;
      border-bottom: 1px solid var(--hair);
      background: rgba(0,0,0,.72);
      backdrop-filter: blur(10px);
    }
    .topInner{
      width: min(1320px, 96vw);
      margin: 0 auto;
      padding: 12px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }

    .brand{
      display:flex;
      align-items:baseline;
      gap: 10px;
      white-space:nowrap;
      user-select:none;
    }
    .brand b{
      font-weight: 800;
      letter-spacing: .12em;
      text-transform: uppercase;
      font-size: 12px;
    }
    .slashes{
      font-family: var(--mono);
      letter-spacing: .28em;
      font-weight: 800;
      opacity:.95;
    }
    .meta{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .12em;
      color: rgba(255,255,255,.66);
      text-transform: uppercase;
    }

    .controls{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }

    .btn{
      appearance:none;
      border: 1px solid var(--hair);
      background: rgba(255,255,255,.02);
      color: rgba(255,255,255,.82);
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .14em;
      text-transform: uppercase;
      padding: 8px 10px;
      cursor:pointer;
      transition: border-color .15s ease, background .15s ease, color .15s ease;
    }
    .btn:hover{
      border-color: rgba(255,255,255,.32);
      background: rgba(255,255,255,.04);
      color: var(--laser);
    }
    .btn.red:hover{ border-color: rgba(255,26,26,.45); background: rgba(255,26,26,.08); color: var(--record); }
    .btn.uv:hover{ border-color: rgba(122,0,255,.5); background: rgba(122,0,255,.10); color: #d8b8ff; }

    .hint{
      width: min(1320px, 96vw);
      margin: 0 auto;
      padding: 12px 10px 0;
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .12em;
      color: rgba(255,255,255,.58);
      text-transform: uppercase;
      line-height: 1.6;
    }
    .kbd{
      border: 1px solid rgba(255,255,255,.22);
      padding: 2px 6px;
      border-radius: 0px;
      background: rgba(255,255,255,.02);
      color: rgba(255,255,255,.86);
    }

    .links{
      width: min(1320px, 96vw);
      margin: 0 auto;
      padding: 0 10px 10px;
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .links a{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .14em;
      text-transform: uppercase;
      text-decoration:none;
      color: var(--steel);
      padding: 6px 0;
    }
    .links a:hover{ color: var(--laser); }

    /* Search bar */
    .searchRow{
      width: min(1320px, 96vw);
      margin: 0 auto;
      padding: 0 10px 12px;
      display:flex;
      gap: 10px;
      align-items:center;
      border-bottom: 1px solid var(--hair2);
    }
    .searchRow .tag{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .16em;
      text-transform: uppercase;
      color: rgba(255,255,255,.62);
      white-space:nowrap;
    }
    .searchRow input{
      flex:1;
      border: 1px solid var(--hair);
      background: rgba(255,255,255,.02);
      color: rgba(255,255,255,.88);
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .12em;
      text-transform: uppercase;
      padding: 10px 10px;
      outline: none;
    }
    .searchRow input:focus{
      border-color: rgba(255,255,255,.30);
      background: rgba(255,255,255,.03);
    }
    .searchRow .miniHint{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .12em;
      color: rgba(255,255,255,.50);
      text-transform: uppercase;
      white-space:nowrap;
    }

    .wrap{
      width: min(1320px, 96vw);
      margin: 0 auto;
      padding: 14px 10px 40px;
      display:grid;
      grid-template-columns: 1fr 520px;
      gap: 16px;
    }
    @media (max-width: 1120px){
      .wrap{ grid-template-columns: 1fr; }
      .paletteBay{ height:auto; position:relative; top:auto; }
    }

    .panel{
      border: 1px solid var(--hair);
      background: rgba(255,255,255,.02);
    }
    .panelHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 10px 10px;
      border-bottom: 1px solid var(--hair2);
      background: rgba(0,0,0,.35);
    }
    .panelHead b{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .16em;
      text-transform: uppercase;
    }
    .panelHead .sub{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .12em;
      color: rgba(255,255,255,.62);
      text-transform: uppercase;
      white-space:nowrap;
    }

    .vault{
      padding: 10px;
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(var(--tile), 1fr));
      gap: var(--gap);
      min-height: 520px;
    }

    .swatch{
      border: 1px solid var(--hair);
      background: rgba(0,0,0,.35);
      cursor: grab;
      user-select:none;
      display:flex;
      flex-direction:column;
      min-height: 120px;
      overflow:hidden; /* critical: prevents label spill */
    }
    .swatch:active{ cursor: grabbing; }

    .chip{
      height: 74px;
      background: #111;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }

    .label{
      padding: 8px 8px 10px;
      display:flex;
      flex-direction:column;
      gap: 6px;
      min-height: 46px;
      overflow:hidden; /* ensure nothing escapes */
    }

    .label .name{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: rgba(255,255,255,.86);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 100%;
      display:block;
    }

    /* FIX: hex row now wraps safely and never overlaps UI */
    .label .hex{
      font-family: var(--mono);
      font-size: 10px;               /* slightly smaller to fit rgba strings */
      letter-spacing: .10em;
      color: rgba(255,255,255,.60);
      display:flex;
      gap: 8px;
      align-items:center;
      justify-content:space-between;
      min-width:0;                   /* allows truncation */
    }
    .label .hex span{
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;        /* truncates rgba(...) */
      white-space:nowrap;
      display:block;
      max-width: 100%;
    }

    .copy{
      border: 1px solid var(--hair);
      background: transparent;
      color: rgba(255,255,255,.72);
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing:.12em;
      padding: 3px 6px;
      cursor:pointer;
      flex: 0 0 auto;
    }
    .copy:hover{ color: var(--laser); border-color: rgba(255,255,255,.30); }

    .empty{
      border: 1px dashed rgba(255,255,255,.22);
      background: rgba(255,255,255,.01);
      min-height: 120px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .16em;
      text-transform: uppercase;
      color: rgba(255,255,255,.40);
      padding: 10px;
      text-align:center;
    }

    .paletteBay{
      display:flex;
      flex-direction:column;
      height: calc(100vh - 170px);
      position: sticky;
      top: 130px;
    }

    .paletteBody{
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap: 12px;
      overflow:auto;
      min-height: 340px;
    }

    .palette{
      border: 1px solid var(--hair);
      background: rgba(0,0,0,.28);
    }

    .paletteTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px;
      border-bottom: 1px solid var(--hair2);
      background: rgba(0,0,0,.35);
    }
    .paletteTop input{
      width: 100%;
      border: none;
      outline: none;
      background: transparent;
      color: rgba(255,255,255,.90);
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .12em;
      text-transform: uppercase;
    }
    .paletteTop .count{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .12em;
      color: rgba(255,255,255,.55);
      white-space:nowrap;
    }

    .dropzone{
      padding: 10px;
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
      min-height: 110px;
    }
    @media (max-width: 1120px){
      .dropzone{ grid-template-columns: repeat(8, 1fr); }
    }

    .slot{
      border: 1px dashed rgba(255,255,255,.22);
      background: rgba(255,255,255,.01);
      height: 56px;
      position:relative;
      overflow:hidden;
    }
    .slot .mini{
      position:absolute;
      inset: 0;
      border: 1px solid rgba(255,255,255,.10);
      background: #111;
      cursor: grab;
      overflow:hidden;
    }
    .slot .mini:active{ cursor: grabbing; }
    .slot .mini span{
      position:absolute;
      left: 6px;
      bottom: 6px;
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing:.10em;
      color: rgba(255,255,255,.75);
      text-transform: uppercase;
      max-width: calc(100% - 12px);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      border: 1px solid var(--hair);
      background: rgba(0,0,0,.72);
      color: rgba(255,255,255,.86);
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .12em;
      text-transform: uppercase;
      padding: 10px 12px;
      opacity: 0;
      pointer-events:none;
      transition: opacity .15s ease;
    }
    .toast.on{ opacity: 1; }

    .dragGhost{
      outline: 1px solid rgba(255,255,255,.35);
      outline-offset: -1px;
    }
    .over{
      border-color: rgba(255,255,255,.40) !important;
      background: rgba(255,255,255,.03) !important;
    }
  </style>
</head>

<body>
  <header class="top">
    <div class="topInner">
      <div class="brand">
        <b>KETA</b><span class="slashes">///</span><b>DATA</b>
        <span class="meta">COLOR VAULT — DRAG TO BUILD PALETTES</span>
      </div>

      <div class="controls">
        <button class="btn" id="addPalette">ADD PALETTE</button>
        <button class="btn red" id="reset">RESET</button>
        <button class="btn uv" id="export">EXPORT JSON</button>
      </div>
    </div>

    <div class="hint">
      DRAG SWATCHES INTO PALETTE SLOTS. REORDER PALETTES BY DRAGGING THEIR HEADER.<br/>
      <span class="kbd">CLICK</span> COPY HEX — <span class="kbd">SHIFT</span> CLICK COPY NAME+HEX
    </div>

    <nav class="links" aria-label="links">
      <a href="#">[TOP]</a>
      <a href="#">[DIRECTORY]</a>
      <a href="#">[K-WORLD]</a>
      <a href="#">[K-ROOM]</a>
      <a href="#">[LIBRARY]</a>
      <a href="#">[FUND]</a>
      <a href="#">[SHOP]</a>
    </nav>

    <div class="searchRow">
      <div class="tag">[SEARCH COLORS]</div>
      <input id="search" placeholder="TYPE: NAME (E.G. UV) OR HEX (E.G. #FF1A1A) OR CSS (E.G. RGBA) OR 'RED' — DRAG RESULTS" />
      <div class="miniHint">MATCHES: <span id="matchCount">0</span></div>
    </div>
  </header>

  <div class="wrap">
    <section class="panel">
      <div class="panelHead">
        <b>[KETADATA COLORS]</b>
        <div class="sub">CORE / RED / UV / MED / SIGNAL + SEARCH</div>
      </div>
      <div class="vault" id="vault"></div>
    </section>

    <aside class="panel paletteBay">
      <div class="panelHead">
        <b>[PALETTES]</b>
        <div class="sub">DROP ZONES — OPEN PLAN</div>
      </div>
      <div class="paletteBody" id="paletteBody"></div>
    </aside>
  </div>

  <div class="toast" id="toast">COPIED</div>

  <script>
    // -----------------------------
    // Seed colors
    // -----------------------------
    const BASE_COLORS = [
      { name:"VOID", value:"#000000" },
      { name:"MIND", value:"#ffffff" },
      { name:"STEEL", value:"#666666" },
      { name:"HAIR", value:"rgba(255,255,255,.12)" },
      { name:"HAIR2", value:"rgba(255,255,255,.08)" },

      { name:"RECORD", value:"#ff1a1a" },
      { name:"DANGER", value:"#ff0000" },
      { name:"DARKROOM", value:"#4a0000" },

      { name:"UV", value:"#7a00ff" },
      { name:"VIOLET", value:"#b000ff" },
      { name:"ULTRAVIOLET", value:"#5b2cff" },

      { name:"MED-GREEN", value:"#00ff66" },
      { name:"XRAY-CYAN", value:"#00ffff" },
      { name:"SHOCK-MAGENTA", value:"#ff00ff" },
      { name:"MED-BLUE", value:"#0088ff" },
    ];

    // Generate CSS-named colors as searchable items (not stored; on-demand view)
    // NOTE: This is the full CSS Color Module Level 4 named list (common subset + full set).
    // Keeping it inline avoids external deps.
    const CSS_NAMED_COLORS = {
      aliceblue:"#f0f8ff", antiquewhite:"#faebd7", aqua:"#00ffff", aquamarine:"#7fffd4", azure:"#f0ffff",
      beige:"#f5f5dc", bisque:"#ffe4c4", black:"#000000", blanchedalmond:"#ffebcd", blue:"#0000ff",
      blueviolet:"#8a2be2", brown:"#a52a2a", burlywood:"#deb887", cadetblue:"#5f9ea0", chartreuse:"#7fff00",
      chocolate:"#d2691e", coral:"#ff7f50", cornflowerblue:"#6495ed", cornsilk:"#fff8dc", crimson:"#dc143c",
      cyan:"#00ffff", darkblue:"#00008b", darkcyan:"#008b8b", darkgoldenrod:"#b8860b", darkgray:"#a9a9a9",
      darkgreen:"#006400", darkgrey:"#a9a9a9", darkkhaki:"#bdb76b", darkmagenta:"#8b008b", darkolivegreen:"#556b2f",
      darkorange:"#ff8c00", darkorchid:"#9932cc", darkred:"#8b0000", darksalmon:"#e9967a", darkseagreen:"#8fbc8f",
      darkslateblue:"#483d8b", darkslategray:"#2f4f4f", darkslategrey:"#2f4f4f", darkturquoise:"#00ced1",
      darkviolet:"#9400d3", deeppink:"#ff1493", deepskyblue:"#00bfff", dimgray:"#696969", dimgrey:"#696969",
      dodgerblue:"#1e90ff", firebrick:"#b22222", floralwhite:"#fffaf0", forestgreen:"#228b22", fuchsia:"#ff00ff",
      gainsboro:"#dcdcdc", ghostwhite:"#f8f8ff", gold:"#ffd700", goldenrod:"#daa520", gray:"#808080",
      green:"#008000", greenyellow:"#adff2f", grey:"#808080", honeydew:"#f0fff0", hotpink:"#ff69b4",
      indianred:"#cd5c5c", indigo:"#4b0082", ivory:"#fffff0", khaki:"#f0e68c", lavender:"#e6e6fa",
      lavenderblush:"#fff0f5", lawngreen:"#7cfc00", lemonchiffon:"#fffacd", lightblue:"#add8e6", lightcoral:"#f08080",
      lightcyan:"#e0ffff", lightgoldenrodyellow:"#fafad2", lightgray:"#d3d3d3", lightgreen:"#90ee90",
      lightgrey:"#d3d3d3", lightpink:"#ffb6c1", lightsalmon:"#ffa07a", lightseagreen:"#20b2aa",
      lightskyblue:"#87cefa", lightslategray:"#778899", lightslategrey:"#778899", lightsteelblue:"#b0c4de",
      lightyellow:"#ffffe0", lime:"#00ff00", limegreen:"#32cd32", linen:"#faf0e6", magenta:"#ff00ff",
      maroon:"#800000", mediumaquamarine:"#66cdaa", mediumblue:"#0000cd", mediumorchid:"#ba55d3",
      mediumpurple:"#9370db", mediumseagreen:"#3cb371", mediumslateblue:"#7b68ee", mediumspringgreen:"#00fa9a",
      mediumturquoise:"#48d1cc", mediumvioletred:"#c71585", midnightblue:"#191970", mintcream:"#f5fffa",
      mistyrose:"#ffe4e1", moccasin:"#ffe4b5", navajowhite:"#ffdead", navy:"#000080", oldlace:"#fdf5e6",
      olive:"#808000", olivedrab:"#6b8e23", orange:"#ffa500", orangered:"#ff4500", orchid:"#da70d6",
      palegoldenrod:"#eee8aa", palegreen:"#98fb98", paleturquoise:"#afeeee", palevioletred:"#db7093",
      papayawhip:"#ffefd5", peachpuff:"#ffdab9", peru:"#cd853f", pink:"#ffc0cb", plum:"#dda0dd",
      powderblue:"#b0e0e6", purple:"#800080", rebeccapurple:"#663399", red:"#ff0000", rosybrown:"#bc8f8f",
      royalblue:"#4169e1", saddlebrown:"#8b4513", salmon:"#fa8072", sandybrown:"#f4a460", seagreen:"#2e8b57",
      seashell:"#fff5ee", sienna:"#a0522d", silver:"#c0c0c0", skyblue:"#87ceeb", slateblue:"#6a5acd",
      slategray:"#708090", slategrey:"#708090", snow:"#fffafa", springgreen:"#00ff7f", steelblue:"#4682b4",
      tan:"#d2b48c", teal:"#008080", thistle:"#d8bfd8", tomato:"#ff6347", turquoise:"#40e0d0",
      violet:"#ee82ee", wheat:"#f5deb3", white:"#ffffff", whitesmoke:"#f5f5f5", yellow:"#ffff00", yellowgreen:"#9acd32"
    };

    // build all searchable items (base + css named)
    function buildAllItems(){
      const cssItems = Object.entries(CSS_NAMED_COLORS).map(([k,v])=>({ name: k.toUpperCase(), value: v }));
      // If any CSS name duplicates BASE, BASE will appear first (fine).
      return [...BASE_COLORS, ...cssItems];
    }

    const ALL_ITEMS = buildAllItems();

    // -----------------------------
    // State (palettes only)
    // -----------------------------
    const vault = document.getElementById("vault");
    const paletteBody = document.getElementById("paletteBody");
    const toast = document.getElementById("toast");
    const searchInput = document.getElementById("search");
    const matchCount = document.getElementById("matchCount");

    let state = {
      palettes: [
        { id: uid(), name: "PALETTE A", slots: Array(12).fill(null) },
        { id: uid(), name: "PALETTE B", slots: Array(12).fill(null) },
      ]
    };

    function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

    function showToast(msg="COPIED"){
      toast.textContent = msg;
      toast.classList.add("on");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.classList.remove("on"), 700);
    }

    function copyText(t){
      navigator.clipboard?.writeText(t).then(()=> showToast("COPIED"))
        .catch(()=> showToast("COPY FAILED"));
    }

    function valueToCss(v){ return v; }

    // -----------------------------
    // Vault render (filtered)
    // -----------------------------
    function renderVault(filterText=""){
      const q = (filterText || "").trim().toUpperCase();
      const items = filterItems(q);

      matchCount.textContent = items.length;

      vault.innerHTML = "";
      items.forEach((item, idx)=>{
        vault.appendChild(makeSwatch(item, "item:"+idx));
      });

      // Always keep empty frames at bottom (for future inputs)
      for(let i=0;i<12;i++){
        const el = document.createElement("div");
        el.className = "empty";
        el.textContent = "[EMPTY FRAME]\nDROP OR DEFINE";
        el.dataset.kind = "empty";
        el.addEventListener("dragover", (e)=>{ e.preventDefault(); el.classList.add("over"); });
        el.addEventListener("dragleave", ()=> el.classList.remove("over"));
        el.addEventListener("drop", (e)=>{
          e.preventDefault();
          el.classList.remove("over");
          // No persistence required; treat as a visual placeholder only.
          showToast("EMPTY FRAME");
        });
        vault.appendChild(el);
      }
    }

    function filterItems(q){
      if(!q) return ALL_ITEMS;

      const isHexLike = q.startsWith("#");
      const isRGBA = q.includes("RGBA");
      const terms = q.split(/\s+/).filter(Boolean);

      return ALL_ITEMS.filter(it=>{
        const n = it.name.toUpperCase();
        const v = String(it.value).toUpperCase();

        // Direct matches
        if(isHexLike && v.includes(q)) return true;
        if(isRGBA && v.includes("RGBA") && v.includes(q.replace(/\s+/g,""))) return true;

        // Term-based matching across name + value
        const hay = (n + " " + v);
        return terms.every(t => hay.includes(t));
      });
    }

    function makeSwatch(item, dragId){
      const sw = document.createElement("div");
      sw.className = "swatch";
      sw.draggable = true;
      sw.dataset.dragId = dragId;

      const chip = document.createElement("div");
      chip.className = "chip";
      chip.style.background = valueToCss(item.value);

      const label = document.createElement("div");
      label.className = "label";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = item.name;

      const hexRow = document.createElement("div");
      hexRow.className = "hex";

      const code = document.createElement("span");
      code.textContent = item.value;

      const btn = document.createElement("button");
      btn.className = "copy";
      btn.textContent = "COPY";
      btn.addEventListener("click", (e)=>{
        e.stopPropagation();
        copyText(item.value);
      });

      sw.addEventListener("click", (e)=>{
        if(e.shiftKey) copyText(`${item.name} ${item.value}`);
      });

      hexRow.appendChild(code);
      hexRow.appendChild(btn);

      label.appendChild(name);
      label.appendChild(hexRow);

      sw.appendChild(chip);
      sw.appendChild(label);

      sw.addEventListener("dragstart", (e)=>{
        sw.classList.add("dragGhost");
        e.dataTransfer.setData("application/json", JSON.stringify({ type:"color", color: { name: item.name, value: item.value } }));
        e.dataTransfer.effectAllowed = "copyMove";
      });
      sw.addEventListener("dragend", ()=> sw.classList.remove("dragGhost"));

      return sw;
    }

    // -----------------------------
    // Palettes render
    // -----------------------------
    function renderPalettes(){
      paletteBody.innerHTML = "";
      state.palettes.forEach((p, pIndex)=>{
        paletteBody.appendChild(makePalette(p, pIndex));
      });
    }

    function makePalette(p, pIndex){
      const box = document.createElement("section");
      box.className = "palette";
      box.dataset.paletteId = p.id;

      const top = document.createElement("div");
      top.className = "paletteTop";
      top.draggable = true;

      const input = document.createElement("input");
      input.value = p.name;
      input.setAttribute("maxlength", "40");
      input.addEventListener("input", ()=>{
        p.name = input.value.toUpperCase();
        input.value = p.name;
      });

      const count = document.createElement("div");
      count.className = "count";
      count.textContent = `${p.slots.filter(Boolean).length}/${p.slots.length}`;

      top.appendChild(input);
      top.appendChild(count);

      // reorder palettes by dragging header
      top.addEventListener("dragstart", (e)=>{
        top.classList.add("dragGhost");
        e.dataTransfer.setData("text/palette", p.id);
        e.dataTransfer.effectAllowed = "move";
      });
      top.addEventListener("dragend", ()=> top.classList.remove("dragGhost"));

      box.addEventListener("dragover", (e)=>{
        if(e.dataTransfer.types.includes("text/palette")) e.preventDefault();
      });
      box.addEventListener("drop", (e)=>{
        const fromId = e.dataTransfer.getData("text/palette");
        if(!fromId) return;
        const toId = p.id;
        if(fromId === toId) return;
        const fromIndex = state.palettes.findIndex(x=>x.id===fromId);
        const toIndex = state.palettes.findIndex(x=>x.id===toId);
        if(fromIndex<0 || toIndex<0) return;
        const [moved] = state.palettes.splice(fromIndex, 1);
        state.palettes.splice(toIndex, 0, moved);
        renderPalettes();
      });

      const dz = document.createElement("div");
      dz.className = "dropzone";

      p.slots.forEach((slotColor, slotIndex)=>{
        const slot = document.createElement("div");
        slot.className = "slot";
        slot.dataset.slot = slotIndex;

        slot.addEventListener("dragover", (e)=>{
          e.preventDefault();
          slot.classList.add("over");
        });
        slot.addEventListener("dragleave", ()=> slot.classList.remove("over"));

        slot.addEventListener("drop", (e)=>{
          e.preventDefault();
          slot.classList.remove("over");
          const payload = e.dataTransfer.getData("application/json");
          if(!payload) return;
          const data = JSON.parse(payload);
          if(!data || !data.color) return;

          // Place (no need to store searched items separately; palettes store value+name)
          p.slots[slotIndex] = data.color;
          renderPalettes();
        });

        if(slotColor){
          const mini = document.createElement("div");
          mini.className = "mini";
          mini.style.background = valueToCss(slotColor.value);
          mini.draggable = true;

          const tag = document.createElement("span");
          tag.textContent = slotColor.name;

          mini.appendChild(tag);

          mini.addEventListener("dragstart", (e)=>{
            mini.classList.add("dragGhost");
            e.dataTransfer.setData("application/json", JSON.stringify({ type:"color", color: slotColor }));
            e.dataTransfer.effectAllowed = "move";
          });
          mini.addEventListener("dragend", ()=> mini.classList.remove("dragGhost"));

          mini.addEventListener("dblclick", ()=>{
            p.slots[slotIndex] = null;
            renderPalettes();
          });

          slot.appendChild(mini);
        }

        dz.appendChild(slot);
      });

      box.appendChild(top);
      box.appendChild(dz);
      return box;
    }

    // -----------------------------
    // Buttons + search
    // -----------------------------
    document.getElementById("addPalette").addEventListener("click", ()=>{
      state.palettes.push({ id: uid(), name: `PALETTE ${String.fromCharCode(65+state.palettes.length)}`, slots: Array(12).fill(null) });
      renderPalettes();
    });

    document.getElementById("reset").addEventListener("click", ()=>{
      state.palettes = [
        { id: uid(), name: "PALETTE A", slots: Array(12).fill(null) },
        { id: uid(), name: "PALETTE B", slots: Array(12).fill(null) },
      ];
      renderPalettes();
      showToast("RESET");
    });

    document.getElementById("export").addEventListener("click", ()=>{
      const payload = {
        palettes: state.palettes.map(p=>({
          name: p.name,
          slots: p.slots.map(c => c ? { name:c.name, value:c.value } : null)
        })),
        timestamp: new Date().toISOString()
      };
      copyText(JSON.stringify(payload, null, 2));
      showToast("EXPORTED JSON");
    });

    // Search is view-only (does not change saved state)
    searchInput.addEventListener("input", ()=>{
      renderVault(searchInput.value);
    });

    // -----------------------------
    // Init
    // -----------------------------
    renderVault("");
    renderPalettes();
  </script>
</body>
</html>
