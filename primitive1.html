<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KETADATA // PRIMITIVES (GRID + NOTES + PROMPT)</title>
  <style>
    :root{
      --bg:#000;
      --fg:#fff;
      --stroke:rgba(255,255,255,0.16);
      --stroke2:rgba(255,255,255,0.10);
      --glass:rgba(255,255,255,0.06);
      --panel:rgba(0,0,0,0.92);
      --muted:rgba(255,255,255,0.55);
      --muted2:rgba(255,255,255,0.38);
      --shadow:rgba(0,0,0,0.82);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:Arial, Helvetica, sans-serif;}
    body{overflow:hidden;}
    button,input,select,textarea{font-family:inherit}
    ::selection{background:rgba(255,255,255,0.18);}

    /* TOPBAR */
    #topbar{
      position:fixed; left:0; right:0; top:0;
      height:48px;
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid var(--stroke2);
      background:#000;
      user-select:none;
      z-index:60;
    }
    #brand{
      display:flex; align-items:center; gap:10px;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.80);
      min-width:240px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .whiteBox{width:10px;height:10px;background:#fff;display:inline-block;}
    .btn{
      border:1px solid var(--stroke);
      background:transparent;
      color:rgba(255,255,255,0.86);
      padding:7px 10px;
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{background:var(--glass);border-color:rgba(255,255,255,0.34);}
    .btnPrimary{background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.30);}
    .btnPrimary:hover{background:rgba(255,255,255,0.09);border-color:rgba(255,255,255,0.44);}

    /* MAIN 3-COL LAYOUT */
    #main{
      position:fixed; inset:48px 0 0 0;
      display:grid;
      grid-template-columns: 360px 1fr 420px;
      min-height:0;
    }

    /* LEFT */
    #left{
      border-right:1px solid var(--stroke2);
      background:rgba(0,0,0,0.90);
      display:flex; flex-direction:column;
      min-height:0;
    }
    #leftHeader{
      padding:12px;
      border-bottom:1px solid var(--stroke2);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      user-select:none;
    }
    #leftHeader .title{
      margin:0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.78);
      display:flex;align-items:center;gap:10px;
    }
    #leftBody{
      padding:12px;
      overflow:auto;
      min-height:0;
    }

    .field{display:grid;gap:6px;margin-bottom:12px;}
    label{
      font-size:11px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.60);
    }
    input[type="text"], textarea, select{
      width:100%;
      border:1px solid rgba(255,255,255,0.16);
      background:rgba(255,255,255,0.04);
      color:rgba(255,255,255,0.90);
      padding:9px 10px;
      font-size:12px;
      outline:none;
    }
    textarea{min-height:90px;resize:vertical;}
    input[type="text"]:focus, textarea:focus, select:focus{
      border-color:rgba(255,255,255,0.36);
      background:rgba(255,255,255,0.06);
    }
    .hint{
      font-size:11px;
      line-height:1.35;
      color:rgba(255,255,255,0.48);
      letter-spacing:0.04em;
    }

    /* GRID / LIST TOGGLE */
    #viewRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .chip{
      border:1px solid rgba(255,255,255,0.16);
      background:transparent;
      color:rgba(255,255,255,0.72);
      padding:7px 10px;
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{background:var(--glass);border-color:rgba(255,255,255,0.34);}
    .chip.on{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.40);color:rgba(255,255,255,0.88);}

    /* PRIMITIVE GRID */
    #grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:8px;
    }
    #list{display:grid;gap:8px;}
    .card{
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.03);
      padding:10px;
      cursor:pointer;
      display:grid;
      gap:6px;
      user-select:none;
    }
    .card:hover{background:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.22);}
    .card.active{background:rgba(255,255,255,0.07);border-color:rgba(255,255,255,0.32);}
    .cardTop{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .name{
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.86);
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .pill{
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.55);
      border:1px solid rgba(255,255,255,0.14);
      padding:3px 6px;
      background:rgba(0,0,0,0.40);
      white-space:nowrap;
    }
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}

    /* CENTER EDITOR (MAIN SCREEN) */
    #center{
      position:relative;
      min-height:0;
      overflow:hidden;
      background:#000;
      display:flex;
      flex-direction:column;
    }
    #centerHeader{
      padding:12px 14px;
      border-bottom:1px solid var(--stroke2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    #centerHeader .title{
      margin:0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.78);
      display:flex;align-items:center;gap:10px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    /* CC: density toggle only (editor stays interactive) */
    #ccBtn{
      width:28px;height:28px;
      border:1px solid rgba(255,255,255,0.24);
      background:rgba(0,0,0,0.45);
      cursor:pointer;
      display:grid;place-items:center;
      padding:0;
    }
    #ccBtn:hover{background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.38);}
    #ccGlyph{width:10px;height:10px;border:1px solid rgba(255,255,255,0.55);opacity:0.85;}

    #editor{
      flex:1;
      min-height:0;
      overflow:auto;
      padding:14px;
      display:grid;
      gap:12px;
    }
    .module{
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.03);
      padding:12px;
      display:grid;
      gap:10px;
    }
    .moduleTitle{
      margin:0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.78);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      user-select:none;
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .muted{color:rgba(255,255,255,0.46);font-size:11px;letter-spacing:0.04em;line-height:1.35;}
    .dense .muted{display:none;}
    .dense textarea{min-height:70px;}

    /* RIGHT PROMPT PREVIEW */
    #right{
      border-left:1px solid var(--stroke2);
      background:rgba(0,0,0,0.92);
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    #rightHeader{
      padding:12px;
      border-bottom:1px solid var(--stroke2);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      user-select:none;
    }
    #rightHeader .title{
      margin:0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.78);
      display:flex;align-items:center;gap:10px;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    #promptWrap{
      padding:12px;
      overflow:auto;
      min-height:0;
      display:grid;
      gap:10px;
    }
    pre{
      margin:0;
      padding:12px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.03);
      color:rgba(255,255,255,0.82);
      font-size:11px;
      line-height:1.35;
      letter-spacing:0.04em;
      white-space:pre-wrap;
      word-break:break-word;
    }

    /* NOTES OVERLAY (NON-INTERFERING) */
    #noteLayer{
      position:absolute; inset:0;
      pointer-events:none; /* critical: doesn't block main interactions */
      z-index:40;
    }
    .noteWin{
      position:absolute;
      width:320px;
      max-width:calc(100% - 24px);
      border:1px solid rgba(255,255,255,0.22);
      background:rgba(0,0,0,0.90);
      box-shadow:0 28px 110px rgba(0,0,0,0.82);
      pointer-events:auto; /* only the note itself can be interacted with */
      user-select:none;
    }
    .noteHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 10px 8px 10px;
      border-bottom:1px solid rgba(255,255,255,0.10);
      cursor:grab; /* drag handle */
    }
    .noteHead:active{cursor:grabbing;}
    .noteTitle{
      margin:0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.82);
      display:flex;align-items:center;gap:10px;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .noteBody{
      padding:10px;
      display:grid;
      gap:10px;
      user-select:text;
    }
    .noteBody input[type="text"], .noteBody textarea{
      pointer-events:auto;
      user-select:text;
    }
    .noteBody textarea{min-height:96px;}
    .noteActions{display:flex;gap:8px;flex-wrap:wrap;}
    .noteMini{padding:6px 8px;font-size:10px;letter-spacing:0.16em;}
    .ghost{
      opacity:0.88;
      border:1px dashed rgba(255,255,255,0.28);
    }

    /* LOAD STATE MODAL */
    #modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.72);
      display:none;
      z-index:100;
    }
    #modal{
      position:absolute; left:50%; top:84px;
      transform:translateX(-50%);
      width:min(680px, calc(100% - 32px));
      border:1px solid rgba(255,255,255,0.22);
      background:rgba(0,0,0,0.92);
      box-shadow:0 28px 110px rgba(0,0,0,0.82);
      padding:12px;
    }
    #modalTitle{
      margin:0 0 10px 0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.82);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      user-select:none;
    }

    /* Toast */
    #toast{
      position:fixed;
      left:50%;
      top:68px;
      transform:translateX(-50%);
      padding:8px 10px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.72);
      color:rgba(255,255,255,0.65);
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      display:none;
      z-index:120;
    }
  </style>
</head>

<body>
  <div id="topbar">
    <div id="brand">
      <span class="whiteBox" aria-hidden="true"></span>
      <span>KETADATA // PRIMITIVES</span>
    </div>
    <div class="row">
      <!-- top: export state / load state / export prompt -->
      <button id="exportState" class="btn btnPrimary" type="button">Export State</button>
      <button id="loadState" class="btn" type="button">Load State</button>
      <button id="exportPromptTop" class="btn" type="button">Export Prompt</button>
    </div>
  </div>

  <div id="main">
    <!-- LEFT -->
    <div id="left">
      <div id="leftHeader">
        <p class="title"><span class="whiteBox" aria-hidden="true"></span> Primitives</p>
        <button id="newPrim" class="btn btnPrimary" type="button">New</button>
      </div>

      <div id="leftBody">
        <div class="field">
          <label for="project">Project</label>
          <input id="project" type="text" value="KETADATA" />
        </div>

        <div class="field">
          <label for="scope">Scope Filter</label>
          <select id="scope">
            <option value="">ALL</option>
            <option>SYSTEM</option>
            <option>ROOM</option>
            <option>INTERFACE</option>
            <option>MODULE</option>
            <option>CONTROL</option>
            <option>NOTE</option>
            <option>STATE</option>
            <option>PROMPT</option>
            <option>ACCESS</option>
            <option>MODE</option>
          </select>
          <div class="hint">Filter what propagates where.</div>
        </div>

        <div class="field">
          <label>Display</label>
          <div id="viewRow">
            <button id="viewGrid" class="chip on" type="button">Grid</button>
            <button id="viewList" class="chip" type="button">List</button>
          </div>
          <div class="hint">Default = grid. Every primitive is a boxed unit.</div>
        </div>

        <div class="field">
          <label for="search">Search</label>
          <input id="search" type="text" placeholder="name / tags / scope" />
        </div>

        <div class="field">
          <label>Quick Notes</label>
          <div class="row">
            <button id="addNoteLeft" class="btn btnPrimary" type="button">Add Note</button>
            <span class="pill" id="noteCountPill">0 NOTES</span>
          </div>
          <div class="hint">Notes added here appear as draggable windows on the main screen.</div>
        </div>

        <div class="field">
          <label>Registry</label>
          <div id="grid"></div>
          <div id="list" style="display:none;"></div>
        </div>
      </div>
    </div>

    <!-- CENTER -->
    <div id="center">
      <div id="centerHeader">
        <p class="title">
          <span class="whiteBox" aria-hidden="true"></span>
          <span>Editor</span>
          <span id="activeName" style="color:rgba(255,255,255,0.40);margin-left:6px;"></span>
        </p>
        <button id="ccBtn" type="button" aria-label="Density"><span id="ccGlyph" aria-hidden="true"></span></button>
      </div>

      <div id="editor">
        <div class="module">
          <p class="moduleTitle">Identity <span class="pill" id="activeScopePill">—</span></p>
          <div class="grid2">
            <div class="field" style="margin:0;">
              <label for="primName">Name</label>
              <input id="primName" type="text" placeholder="e.g. NOTE_WHITE_SQUARE" />
            </div>
            <div class="field" style="margin:0;">
              <label for="primScope">Scope</label>
              <select id="primScope">
                <option>SYSTEM</option><option>ROOM</option><option>INTERFACE</option>
                <option>MODULE</option><option>CONTROL</option><option>NOTE</option>
                <option>STATE</option><option>PROMPT</option><option>ACCESS</option><option>MODE</option>
              </select>
            </div>
          </div>
          <div class="field" style="margin:0;">
            <label for="primTags">Tags (comma separated)</label>
            <input id="primTags" type="text" placeholder="angular, mind, export, UI" />
          </div>
          <div class="muted">Primitive = smallest unit that must remain stable across pages and tools.</div>
        </div>

        <div class="module">
          <p class="moduleTitle">Definition</p>
          <div class="field" style="margin:0;">
            <label for="primDef">One-line definition</label>
            <input id="primDef" type="text" placeholder="What it is, in one sentence." />
          </div>
          <div class="field" style="margin:0;">
            <label for="primWhy">Why it exists</label>
            <textarea id="primWhy" placeholder="Constraint, principle, system need."></textarea>
          </div>
          <div class="muted">If you can’t justify it, it’s not a primitive. It’s an implementation detail.</div>
        </div>

        <div class="module">
          <p class="moduleTitle">Implementation</p>
          <div class="field" style="margin:0;">
            <label for="primUI">UI Manifestation</label>
            <textarea id="primUI" placeholder="How it appears (e.g. white square upper right, CC node, collapsible module)."></textarea>
          </div>
          <div class="field" style="margin:0;">
            <label for="primRules">Rules (invariants)</label>
            <textarea id="primRules" placeholder="Hard rules. What must always be true."></textarea>
          </div>
          <div class="grid2">
            <div class="field" style="margin:0;">
              <label for="primAPI">State / Metadata keys</label>
              <input id="primAPI" type="text" placeholder="note:{...}; exportState(); exportPrompt()" />
            </div>
            <div class="field" style="margin:0;">
              <label for="primVersion">Version</label>
              <input id="primVersion" type="text" placeholder="v1" />
            </div>
          </div>
        </div>

        <div class="module">
          <p class="moduleTitle">Semantics</p>
          <div class="field" style="margin:0;">
            <label for="primSem">Semantics note</label>
            <textarea id="primSem" placeholder="mind=angular; senses=circular; note=white square; etc."></textarea>
          </div>
          <div class="muted">Visual language rule (system): mind = angular; senses = circular; note = white/black square.</div>
        </div>

        <div class="module">
          <p class="moduleTitle">Actions</p>
          <div class="row">
            <button id="save" class="btn btnPrimary" type="button">Save</button>
            <button id="dup" class="btn" type="button">Duplicate</button>
            <button id="del" class="btn" type="button">Delete</button>
          </div>
        </div>
      </div>

      <!-- Non-interfering overlay: notes float here -->
      <div id="noteLayer" aria-hidden="false"></div>
    </div>

    <!-- RIGHT: prompt preview -->
    <div id="right">
      <div id="rightHeader">
        <p class="title"><span class="whiteBox" aria-hidden="true"></span> Prompt Preview</p>
        <button id="copyPromptRight" class="btn btnPrimary" type="button">Copy Prompt</button>
      </div>
      <div id="promptWrap">
        <pre id="promptPre">—</pre>
        <div class="hint">Prompt updates live from the active primitive + current notes.</div>
      </div>
    </div>
  </div>

  <!-- LOAD STATE MODAL -->
  <div id="modalBack" aria-hidden="true">
    <div id="modal" role="dialog" aria-label="Load State">
      <div id="modalTitle">
        <span><span class="whiteBox" style="width:9px;height:9px;"></span> LOAD STATE</span>
        <button id="closeModal" class="btn" type="button">Close</button>
      </div>
      <div class="field">
        <label for="stateInput">Paste state URL or base64</label>
        <textarea id="stateInput" placeholder="Paste the exported URL (#state=...) or the raw base64 payload."></textarea>
        <div class="hint">This replaces current state immediately.</div>
      </div>
      <div class="row">
        <button id="applyState" class="btn btnPrimary" type="button">Apply</button>
        <button id="clearStateInput" class="btn" type="button">Clear</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    // ==========================================
    // KETADATA // PRIMITIVES
    // Changes requested:
    // - Notes do NOT interfere with main screen interactions:
    //   noteLayer pointer-events:none; notes pointer-events:auto; draggable.
    // - Right column: prompt preview + copy prompt button.
    // - Top: export state / load state / export prompt.
    // - Add notes from left column; they appear on main overlay.
    // - Primitive registry default grid; grid/list toggle.
    // ==========================================

    const el = (id)=>document.getElementById(id);
    const uid = ()=>Math.random().toString(36).slice(2, 9)+"-"+Date.now().toString(36);
    const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));

    const projectEl = el('project');
    const scopeFilterEl = el('scope');
    const searchEl = el('search');

    const viewGridBtn = el('viewGrid');
    const viewListBtn = el('viewList');
    const gridEl = el('grid');
    const listEl = el('list');

    const newPrimBtn = el('newPrim');
    const addNoteLeftBtn = el('addNoteLeft');
    const noteCountPill = el('noteCountPill');

    const activeNameEl = el('activeName');
    const activeScopePill = el('activeScopePill');

    const primNameEl = el('primName');
    const primScopeEl = el('primScope');
    const primTagsEl = el('primTags');
    const primDefEl = el('primDef');
    const primWhyEl = el('primWhy');
    const primUIEl = el('primUI');
    const primRulesEl = el('primRules');
    const primAPIEl = el('primAPI');
    const primVersionEl = el('primVersion');
    const primSemEl = el('primSem');

    const saveBtn = el('save');
    const dupBtn = el('dup');
    const delBtn = el('del');

    const ccBtn = el('ccBtn');

    const noteLayer = el('noteLayer');

    const promptPre = el('promptPre');
    const copyPromptRight = el('copyPromptRight');
    const exportPromptTop = el('exportPromptTop');

    const exportStateBtn = el('exportState');
    const loadStateBtn = el('loadState');

    const modalBack = el('modalBack');
    const closeModal = el('closeModal');
    const stateInput = el('stateInput');
    const applyStateBtn = el('applyState');
    const clearStateInputBtn = el('clearStateInput');

    const toastEl = el('toast');

    function toast(msg, ms=650){
      toastEl.textContent = msg;
      toastEl.style.display = 'block';
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>{ toastEl.style.display='none'; }, ms);
    }
    async function copyText(s){
      try{ await navigator.clipboard.writeText(s); toast("COPIED"); }
      catch{ window.prompt("Copy:", s); }
    }
    function encode(obj){ return btoa(unescape(encodeURIComponent(JSON.stringify(obj)))); }
    function decode(b64){ return JSON.parse(decodeURIComponent(escape(atob(b64)))); }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (m)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function makePrim(){
      return {
        id: uid(),
        name: "NEW_PRIMITIVE",
        scope: "SYSTEM",
        tags: [],
        def: "",
        why: "",
        ui: "",
        rules: "",
        api: "",
        version: "v1",
        semantics: ""
      };
    }

    function makeNote(){
      return {
        id: uid(),
        title: "NOTE",
        body: "",
        tags: [],
        // anchor / placement in CENTER space (px)
        x: 60,
        y: 80,
        w: 320,
        h: 0, // auto
        // optional relation
        scope: "SYSTEM",
        primitiveId: null
      };
    }

    let state = {
      v: 2,
      project: "KETADATA",
      view: "grid",          // grid | list
      primitives: [],
      activeId: null,
      notes: []              // floating notes visible on main
    };

    // Load from hash if present
    (function(){
      const m = location.hash.match(/state=([^&]+)/);
      if(!m){
        const p = makePrim();
        p.name = "NOTE_WHITE_SQUARE";
        p.scope = "SYSTEM";
        p.tags = ["angular","mind","export","UI"];
        p.def = "Notes are the universal metadata atom; visible as a white square.";
        p.why = "All pages must be able to produce note metadata; the note icon is the invariant affordance.";
        p.ui = "White square icon (upper right). Notes persist via exportState().";
        p.rules = "Must exist on every page; must export; must not be decorative; must support tags + glossary.";
        p.api = "note:{id,title,tags,glossary,body,anchors[]}; exportState(); exportPrompt()";
        p.version = "v1";
        p.semantics = "mind=angular; senses=circular; note=white square";
        state.primitives = [p];
        state.activeId = p.id;
        // seed 1 floating note
        const n = makeNote();
        n.title = "SYSTEM NOTE";
        n.body = "Notes must not block the main screen. Draggable. Always exportable.";
        n.primitiveId = p.id;
        state.notes = [n];
        return;
      }
      try{
        const s = decode(m[1]);
        if(s && (s.v === 1 || s.v === 2)){
          state = { ...state, ...s };
          state.v = 2;
          if(!state.primitives?.length){
            const p = makePrim();
            state.primitives = [p];
            state.activeId = p.id;
          }
          state.activeId = state.activeId || state.primitives[0].id;
          state.notes = state.notes || [];
          state.view = state.view || "grid";
        }
      }catch{
        const p = makePrim();
        state.primitives = [p];
        state.activeId = p.id;
        state.notes = [];
      }
    })();

    function activePrim(){
      return state.primitives.find(p=>p.id===state.activeId) || state.primitives[0];
    }

    function commitEditorToPrim(){
      const p = activePrim();
      p.name = primNameEl.value.trim() || "UNNAMED_PRIMITIVE";
      p.scope = primScopeEl.value;
      p.tags = primTagsEl.value.split(",").map(s=>s.trim()).filter(Boolean);
      p.def = primDefEl.value.trim();
      p.why = primWhyEl.value;
      p.ui = primUIEl.value;
      p.rules = primRulesEl.value;
      p.api = primAPIEl.value.trim();
      p.version = primVersionEl.value.trim() || "v1";
      p.semantics = primSemEl.value;
    }

    function syncEditor(){
      const p = activePrim();
      activeNameEl.textContent = p.name ? ("// " + p.name) : "";
      activeScopePill.textContent = p.scope || "—";

      primNameEl.value = p.name || "";
      primScopeEl.value = p.scope || "SYSTEM";
      primTagsEl.value = (p.tags || []).join(", ");
      primDefEl.value = p.def || "";
      primWhyEl.value = p.why || "";
      primUIEl.value = p.ui || "";
      primRulesEl.value = p.rules || "";
      primAPIEl.value = p.api || "";
      primVersionEl.value = p.version || "v1";
      primSemEl.value = p.semantics || "";
    }

    function filteredPrimitives(){
      const q = searchEl.value.trim().toLowerCase();
      const scopeF = scopeFilterEl.value;
      return state.primitives.filter(p=>{
        if(scopeF && p.scope !== scopeF) return false;
        if(!q) return true;
        const blob = [
          p.name, p.scope, (p.tags||[]).join(" "),
          p.def, p.why, p.ui, p.rules, p.api, p.version, p.semantics
        ].join(" ").toLowerCase();
        return blob.includes(q);
      });
    }

    function renderRegistry(){
      const items = filteredPrimitives();

      // pills
      noteCountPill.textContent = `${state.notes.length} NOTES`;

      // view toggle
      viewGridBtn.classList.toggle('on', state.view === 'grid');
      viewListBtn.classList.toggle('on', state.view === 'list');
      gridEl.style.display = (state.view === 'grid') ? 'grid' : 'none';
      listEl.style.display = (state.view === 'list') ? 'grid' : 'none';

      // build cards
      const buildCard = (p)=>{
        const d = document.createElement('div');
        d.className = "card" + (p.id===state.activeId ? " active" : "");
        d.innerHTML = `
          <div class="cardTop">
            <div class="name">${escapeHtml(p.name || "UNNAMED")}</div>
            <div class="pill">${escapeHtml(p.scope || "—")}</div>
          </div>
          <div class="row">
            <span class="pill">${escapeHtml(p.version || "v1")}</span>
            <span class="pill">${(p.tags||[]).length} TAGS</span>
          </div>
        `;
        d.addEventListener('click', ()=>{
          commitEditorToPrim();
          state.activeId = p.id;
          syncEditor();
          renderPromptPreview();
        });
        return d;
      };

      gridEl.innerHTML = "";
      listEl.innerHTML = "";

      if(state.view === 'grid'){
        items.forEach(p=>gridEl.appendChild(buildCard(p)));
      }else{
        // list = 1 column full width cards
        items.forEach(p=>{
          const d = buildCard(p);
          d.style.gridTemplateColumns = "1fr";
          listEl.appendChild(d);
        });
      }
    }

    // -----------------------
    // Floating Notes (draggable windows) — do not block main screen
    // -----------------------
    function renderNotes(){
      noteLayer.innerHTML = "";

      const centerRect = el('center').getBoundingClientRect();

      state.notes.forEach(n=>{
        const win = document.createElement('div');
        win.className = "noteWin";
        win.dataset.noteId = n.id;
        win.style.left = (n.x|0) + "px";
        win.style.top = (n.y|0) + "px";
        win.style.width = (n.w || 320) + "px";

        win.innerHTML = `
          <div class="noteHead">
            <p class="noteTitle">
              <span class="whiteBox" style="width:9px;height:9px;"></span>
              <span>${escapeHtml(n.title || "NOTE")}</span>
            </p>
            <div class="row" style="justify-content:flex-end;">
              <span class="pill">${escapeHtml(n.scope || "SYSTEM")}</span>
              <button class="btn noteMini" data-act="min">Min</button>
              <button class="btn noteMini" data-act="x">X</button>
            </div>
          </div>
          <div class="noteBody">
            <div class="field" style="margin:0;">
              <label>Title</label>
              <input type="text" data-k="title" value="${escapeHtml(n.title||"")}" />
            </div>
            <div class="field" style="margin:0;">
              <label>Body</label>
              <textarea data-k="body" placeholder="type.">${escapeHtml(n.body||"")}</textarea>
            </div>
            <div class="field" style="margin:0;">
              <label>Tags (comma)</label>
              <input type="text" data-k="tags" value="${escapeHtml((n.tags||[]).join(", "))}" />
            </div>
            <div class="noteActions">
              <button class="btn btnPrimary noteMini" data-act="save">Save</button>
              <button class="btn noteMini" data-act="link">Link to Active Primitive</button>
            </div>
          </div>
        `;

        noteLayer.appendChild(win);

        // drag: only on header so body typing is stable
        const head = win.querySelector('.noteHead');
        let dragging = false;
        let dx = 0, dy = 0;

        const onDown = (e)=>{
          // don't start drag from buttons
          const t = e.target;
          if(t && t.tagName && t.tagName.toLowerCase() === 'button') return;

          dragging = true;
          head.classList.add('ghost');
          const r = win.getBoundingClientRect();
          dx = e.clientX - r.left;
          dy = e.clientY - r.top;

          // bring front
          win.style.zIndex = String(80 + Math.floor(Math.random()*20));

          document.addEventListener('mousemove', onMove);
          document.addEventListener('mouseup', onUp, { once:true });
        };

        const onMove = (e)=>{
          if(!dragging) return;
          const x = clamp(e.clientX - centerRect.left - dx, 6, centerRect.width - 40);
          const y = clamp(e.clientY - centerRect.top - dy, 6, centerRect.height - 40);
          win.style.left = x + "px";
          win.style.top = y + "px";
        };

        const onUp = ()=>{
          dragging = false;
          head.classList.remove('ghost');
          document.removeEventListener('mousemove', onMove);
          // persist
          n.x = parseFloat(win.style.left) || n.x;
          n.y = parseFloat(win.style.top) || n.y;
        };

        head.addEventListener('mousedown', onDown);

        // input handlers (live update but not forcing rerender)
        win.addEventListener('input', (e)=>{
          const k = e.target && e.target.dataset ? e.target.dataset.k : "";
          if(!k) return;
          if(k === "title"){
            n.title = e.target.value;
            win.querySelector('.noteTitle span:last-child').textContent = n.title || "NOTE";
          } else if(k === "body"){
            n.body = e.target.value;
          } else if(k === "tags"){
            n.tags = e.target.value.split(",").map(s=>s.trim()).filter(Boolean);
          }
          renderPromptPreview(); // live update prompt
        });

        // actions
        win.addEventListener('click', (e)=>{
          const act = e.target && e.target.dataset ? e.target.dataset.act : null;
          if(!act) return;

          if(act === "x"){
            state.notes = state.notes.filter(x=>x.id !== n.id);
            renderRegistry();
            renderNotes();
            renderPromptPreview();
            toast("DELETED");
          }
          if(act === "min"){
            const body = win.querySelector('.noteBody');
            const isHidden = body.style.display === "none";
            body.style.display = isHidden ? "grid" : "none";
          }
          if(act === "save"){
            toast("SAVED");
            renderPromptPreview();
          }
          if(act === "link"){
            n.primitiveId = state.activeId;
            n.scope = activePrim().scope || "SYSTEM";
            toast("LINKED");
            renderPromptPreview();
          }
        });
      });
    }

    // Add note from left
    function addNoteDefault(){
      const n = makeNote();
      const p = activePrim();
      n.title = "NOTE";
      n.scope = p.scope || "SYSTEM";
      n.primitiveId = p.id;

      // place within center viewport
      const centerRect = el('center').getBoundingClientRect();
      n.x = Math.max(12, Math.floor(centerRect.width*0.10));
      n.y = Math.max(12, Math.floor(centerRect.height*0.10));
      state.notes.unshift(n);

      renderRegistry();
      renderNotes();
      renderPromptPreview();
      toast("NOTE");
    }

    // -----------------------
    // Prompt preview + export
    // -----------------------
    function buildPrompt(){
      commitEditorToPrim();
      const p = activePrim();

      const notesForPrompt = state.notes.map(n=>({
        id: n.id,
        title: n.title,
        scope: n.scope,
        primitiveId: n.primitiveId,
        tags: n.tags,
        body: n.body,
        x: n.x, y: n.y, w: n.w
      }));

      const payload = {
        system: "KETADATA",
        page: "primitives-registry",
        project: state.project,
        view: state.view,
        activePrimitive: p,
        notes: notesForPrompt
      };

      return [
        "KETADATA PRIMITIVES / PROMPT",
        "RULES:",
        "- Notes must not block main interactions (overlay pointer-events none; notes pointer-events auto).",
        "- Primitive registry defaults to GRID; list optional.",
        "- Topbar has export state / load state / export prompt.",
        "- Prompt preview exists in right column; copy button lives there.",
        "",
        `PROJECT: ${state.project}`,
        `ACTIVE: ${p.name} (${p.scope})`,
        "",
        "TASK: Apply changes implied by notes; preserve black minimalism; no friendly rounding; no kitsch.",
        "",
        "STATE(JSON):",
        JSON.stringify(payload, null, 2)
      ].join("\n");
    }

    function renderPromptPreview(){
      promptPre.textContent = buildPrompt();
    }

    // -----------------------
    // Export / Load State
    // -----------------------
    function exportState(){
      commitEditorToPrim();
      const safe = JSON.parse(JSON.stringify(state));
      const b64 = encode(safe);
      const url = location.origin + location.pathname + "#state=" + b64;
      return { safe, url };
    }

    function showLoadModal(){
      modalBack.style.display = 'block';
      modalBack.setAttribute('aria-hidden','false');
      stateInput.value = "";
      setTimeout(()=>stateInput.focus(), 0);
    }
    function hideLoadModal(){
      modalBack.style.display = 'none';
      modalBack.setAttribute('aria-hidden','true');
    }

    function applyStateFromText(txt){
      const t = (txt||"").trim();
      if(!t){ toast("EMPTY"); return; }

      let b64 = t;

      // accept full URL with #state=
      const m = t.match(/#state=([^&\s]+)/);
      if(m) b64 = m[1];

      try{
        const s = decode(b64);
        if(!s || (s.v !== 1 && s.v !== 2)) throw new Error("bad");
        state = { ...state, ...s, v: 2 };
        state.primitives = state.primitives || [];
        if(!state.primitives.length) state.primitives = [makePrim()];
        state.activeId = state.activeId || state.primitives[0].id;
        state.notes = state.notes || [];
        state.view = state.view || "grid";
        toast("LOADED");
        location.hash = "state=" + b64;
        renderAll();
        hideLoadModal();
      }catch{
        toast("INVALID");
      }
    }

    // -----------------------
    // Render All
    // -----------------------
    function renderAll(){
      projectEl.value = state.project || "KETADATA";
      viewGridBtn.classList.toggle('on', state.view === 'grid');
      viewListBtn.classList.toggle('on', state.view === 'list');

      syncEditor();
      renderRegistry();
      renderNotes();
      renderPromptPreview();
    }

    // -----------------------
    // Events
    // -----------------------
    projectEl.addEventListener('input', ()=>{
      state.project = projectEl.value;
      renderPromptPreview();
    });
    scopeFilterEl.addEventListener('change', renderRegistry);
    searchEl.addEventListener('input', renderRegistry);

    viewGridBtn.addEventListener('click', ()=>{
      state.view = "grid";
      renderRegistry();
      renderPromptPreview();
    });
    viewListBtn.addEventListener('click', ()=>{
      state.view = "list";
      renderRegistry();
      renderPromptPreview();
    });

    ccBtn.addEventListener('click', ()=>{
      document.body.classList.toggle('dense');
      toast(document.body.classList.contains('dense') ? "DENSE" : "OPEN");
    });

    newPrimBtn.addEventListener('click', ()=>{
      commitEditorToPrim();
      const p = makePrim();
      state.primitives.unshift(p);
      state.activeId = p.id;
      syncEditor();
      renderRegistry();
      renderPromptPreview();
      toast("NEW");
    });

    saveBtn.addEventListener('click', ()=>{
      commitEditorToPrim();
      renderRegistry();
      renderPromptPreview();
      toast("SAVED");
    });

    dupBtn.addEventListener('click', ()=>{
      commitEditorToPrim();
      const p = activePrim();
      const copy = JSON.parse(JSON.stringify(p));
      copy.id = uid();
      copy.name = (p.name || "PRIMITIVE") + "_COPY";
      state.primitives.unshift(copy);
      state.activeId = copy.id;
      renderAll();
      toast("DUP");
    });

    delBtn.addEventListener('click', ()=>{
      if(state.primitives.length <= 1){ toast("KEEP ONE"); return; }
      const id = state.activeId;
      state.primitives = state.primitives.filter(p=>p.id !== id);
      state.activeId = state.primitives[0].id;
      renderAll();
      toast("DELETED");
    });

    addNoteLeftBtn.addEventListener('click', addNoteDefault);

    // Export / Load / Export Prompt
    exportStateBtn.addEventListener('click', async ()=>{
      const { url } = exportState();
      await copyText(url);
      location.hash = url.split("#")[1];
    });

    loadStateBtn.addEventListener('click', showLoadModal);

    exportPromptTop.addEventListener('click', async ()=>{
      await copyText(buildPrompt());
    });

    copyPromptRight.addEventListener('click', async ()=>{
      await copyText(buildPrompt());
    });

    // Load modal
    closeModal.addEventListener('click', hideLoadModal);
    modalBack.addEventListener('click', (e)=>{ if(e.target===modalBack) hideLoadModal(); });
    applyStateBtn.addEventListener('click', ()=> applyStateFromText(stateInput.value));
    clearStateInputBtn.addEventListener('click', ()=> stateInput.value = "");

    // Escape closes modal
    window.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){
        if(modalBack.style.display === 'block') hideLoadModal();
      }
      // quick add note
      if((e.key === 'n' || e.key === 'N') && !e.ctrlKey && !e.metaKey){
        // don't steal typing in inputs
        const a = document.activeElement;
        const tag = a && a.tagName ? a.tagName.toLowerCase() : '';
        if(tag !== 'input' && tag !== 'textarea' && tag !== 'select'){
          addNoteDefault();
        }
      }
    });

    // Keep notes bounded on resize
    window.addEventListener('resize', ()=>{
      const centerRect = el('center').getBoundingClientRect();
      state.notes.forEach(n=>{
        n.x = clamp(n.x, 6, centerRect.width - 40);
        n.y = clamp(n.y, 6, centerRect.height - 40);
      });
      renderNotes();
    });

    // Seed UI + prompt
    syncEditor();
    renderAll();
  </script>
</body>
</html>
