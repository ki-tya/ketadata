<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>KETADATA // LINK TRIAGE CALENDAR (MONTH)</title>
  <style>
    :root{ color-scheme:dark; }
    html,body{margin:0;height:100%;background:#000;color:#fff;font:12px/1.35 Arial, Helvetica, sans-serif;}
    *{box-sizing:border-box}
    a{color:inherit;text-decoration:none}
    button,input,select,textarea{font:inherit;color:inherit}

    /* top bar */
    .topbar{
      position:fixed; inset:0 0 auto 0;
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      padding:10px 12px;
      background:#000;
      border-bottom:1px solid rgba(255,255,255,.16);
      z-index:50;
    }
    .title{font-weight:700;letter-spacing:.14em;white-space:nowrap}
    .meta{opacity:.65;letter-spacing:.06em}
    .sp{flex:1}
    .btn{
      background:transparent;color:#fff;
      border:1px solid rgba(255,255,255,.22);
      padding:6px 8px;
      letter-spacing:.08em;
      cursor:pointer;
      opacity:.92;
      user-select:none;
    }
    .btn:hover{border-color:rgba(255,255,255,.55);opacity:1}
    .btn.danger{opacity:.85}
    .btn.danger:hover{opacity:1}
    .btn.on{border-color:rgba(255,255,255,.62)}
    .pill{
      border:1px solid rgba(255,255,255,.16);
      padding:2px 8px;
      letter-spacing:.10em;
      opacity:.78;
      white-space:nowrap;
    }
    kbd{
      border:1px solid rgba(255,255,255,.16);
      padding:1px 6px;
      letter-spacing:.08em;
      opacity:.75;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }

    /* layout */
    .main{
      padding-top:56px;
      display:grid;
      grid-template-columns: 392px 1fr;
      min-height:100vh;
    }
    @media (max-width: 980px){
      .main{grid-template-columns:1fr}
      .left{border-right:none;border-bottom:1px solid rgba(255,255,255,.16)}
    }
    .left,.right{padding:12px}
    .left{border-right:1px solid rgba(255,255,255,.16)}
    .sec{
      border:1px solid rgba(255,255,255,.16);
      padding:10px;
      margin-bottom:10px;
    }
    .secHd{
      display:flex; align-items:baseline; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .h{font-weight:700;letter-spacing:.14em}
    .sub{opacity:.65;letter-spacing:.06em}
    .hint{opacity:.65;letter-spacing:.06em}
    .row{display:flex;gap:8px}
    .row>*{flex:1}
    .inp,.sel,.ta{
      background:#000;color:#fff;
      border:1px solid rgba(255,255,255,.22);
      padding:6px 8px;
      outline:none;
      width:100%;
    }
    .inp:focus,.sel:focus,.ta:focus{border-color:rgba(255,255,255,.55)}
    .ta{min-height:74px;resize:vertical}
    .ta.small{min-height:54px}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    /* month header */
    .monthHdr{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
      border:1px solid rgba(255,255,255,.16);
      padding:10px;
      margin-bottom:10px;
    }
    .monthTitle{font-weight:700;letter-spacing:.14em}
    .monthTitle .dim{opacity:.65;font-weight:400;letter-spacing:.08em}
    .monthHdr .sp{flex:1}

    /* calendar */
    .dow{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
      margin-bottom:8px;
    }
    .dow div{
      border:1px solid rgba(255,255,255,.12);
      padding:6px 8px;
      letter-spacing:.14em;
      opacity:.65;
      text-align:left;
      user-select:none;
    }

    .cal{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
    }
    .day{
      border:1px solid rgba(255,255,255,.14);
      background:#000;
      min-height:150px;
      display:flex;
      flex-direction:column;
      padding:10px;
      gap:8px;
      cursor:pointer;
      position:relative;
      overflow:hidden;
    }
    .day:hover{border-color:rgba(255,255,255,.55)}
    .day.mute{opacity:.42}
    .day.sel{outline:1px solid rgba(255,255,255,.55); outline-offset:-1px}
    .day.today{border-color:rgba(255,255,255,.62)}
    .dTop{
      display:flex;
      align-items:baseline;
      gap:8px;
      flex-wrap:wrap;
      border-bottom:1px solid rgba(255,255,255,.12);
      padding-bottom:8px;
      margin-bottom:2px;
    }
    .dNum{
      font-weight:700;
      letter-spacing:.14em;
      min-width:44px;
    }
    .dKey{
      opacity:.65;
      letter-spacing:.08em;
      flex:1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .dCount{
      opacity:.65;
      letter-spacing:.10em;
      border:1px solid rgba(255,255,255,.16);
      padding:2px 6px;
      white-space:nowrap;
    }
    .mini{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height:0;
      overflow:hidden;
    }
    .ln{
      display:flex;
      gap:8px;
      align-items:baseline;
      min-width:0;
    }
    .hash{
      opacity:.6;
      letter-spacing:.14em;
      border:1px solid rgba(255,255,255,.16);
      padding:1px 6px;
      min-width:70px;
      text-align:left;
      flex:0 0 auto;
    }
    .path{
      font-weight:700;
      letter-spacing:.06em;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      flex:1;
      min-width:0;
    }
    .open{
      border-bottom:1px solid rgba(255,255,255,.22);
      letter-spacing:.08em;
      opacity:.9;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .open:hover{border-bottom-color:rgba(255,255,255,.6);opacity:1}
    .ln.depr{opacity:.55}
    .ln.missing{opacity:.55}
    .ln.missing .open{opacity:.75}

    /* lanes */
    .lanes{display:flex;gap:8px;flex-wrap:wrap}
    .laneBtn{
      background:transparent;color:#fff;
      border:1px solid rgba(255,255,255,.16);
      padding:6px 8px;
      letter-spacing:.08em;
      cursor:pointer;
      opacity:.85;
      white-space:nowrap;
    }
    .laneBtn:hover{border-color:rgba(255,255,255,.5);opacity:1}
    .laneBtn.active{border-color:rgba(255,255,255,.55);opacity:1}
    .laneBtn.depr{opacity:.55}

    /* modal */
    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.78);
      display:none;
      align-items:center;
      justify-content:center;
      padding:12px;
      z-index:100;
    }
    .modal.show{display:flex}
    .panel{
      width:min(1040px, 100%);
      background:#000;
      border:1px solid rgba(255,255,255,.18);
      padding:12px;
    }
    .panelHd{
      display:flex; align-items:baseline; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .panelHd .hh{font-weight:700;letter-spacing:.14em}
    .panelHd .ss{opacity:.65;letter-spacing:.06em}
    .panelActions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .hr{border-top:1px solid rgba(255,255,255,.12);margin:10px 0}
    .gridCards{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap:10px;
    }
    .card{
      border:1px solid rgba(255,255,255,.14);
      padding:10px;
      background:#000;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:170px;
    }
    .card.depr{opacity:.55}
    .card.missing{opacity:.55;border-style:dashed}
    .cTop{
      display:flex;
      gap:8px;
      align-items:baseline;
      flex-wrap:wrap;
      border-bottom:1px solid rgba(255,255,255,.12);
      padding-bottom:8px;
      margin-bottom:2px;
    }
    .cGrid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .cGrid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media (max-width: 1200px){.cGrid3{grid-template-columns:1fr 1fr}}
    @media (max-width: 560px){.cGrid3,.cGrid2{grid-template-columns:1fr}}
  </style>
</head>
<body>

  <div class="topbar">
    <div class="title">KETADATA // LINK TRIAGE // CALENDAR</div>
    <div class="meta" id="meta">BOOT</div>
    <div class="sp"></div>

    <button class="btn" id="btnPrev">◀</button>
    <button class="btn" id="btnToday">TODAY</button>
    <button class="btn" id="btnNext">▶</button>

    <button class="btn" id="btnSync">SYNC REPO</button>
    <button class="btn" id="btnExportMonth">EXPORT MONTH</button>
    <button class="btn" id="btnExportState">EXPORT STATE</button>
    <button class="btn" id="btnImportState">IMPORT STATE</button>
    <button class="btn danger" id="btnNew">NEW</button>
  </div>

  <div class="main">
    <div class="left">

      <div class="sec">
        <div class="secHd">
          <div class="h">REPO</div>
          <div class="sub">TREE API / AUTO URLS / HTML PAGES ONLY</div>
        </div>

        <div class="row">
          <input class="inp" id="repoOwner" placeholder="OWNER"/>
          <input class="inp" id="repoName" placeholder="REPO"/>
        </div>
        <div style="height:8px"></div>
        <div class="row">
          <input class="inp" id="repoBranch" placeholder="BRANCH"/>
          <input class="inp" id="pagesBase" placeholder="PAGES BASE URL"/>
        </div>

        <div style="height:8px"></div>
        <div class="hint">
          SYNC uses: <span style="opacity:.85" class="mono">/git/trees/&lt;branch&gt;?recursive=1</span> (single call).<br/>
          INVENTORY = <b>.html pages only</b>. Excludes <span class="mono">content/ images/ img/ assets/ static/ media/ docs/</span> by default.<br/>
          URL always derived: <span style="opacity:.85" class="mono">PAGES_BASE + path</span> (no URL field).
        </div>
      </div>

      <div class="sec">
        <div class="secHd">
          <div class="h">KETA_NOTE</div>
          <div class="sub">OPTIONAL / NON-INTERFERING</div>
        </div>
        <textarea class="ta" id="ketaNote" placeholder="KETA_NOTE (GLOBAL)"></textarea>
      </div>

      <div class="sec">
        <div class="secHd">
          <div class="h">LANES</div>
          <div class="sub" id="counts">0 LINKS</div>
        </div>
        <div class="lanes" id="lanes"></div>
        <div style="height:8px"></div>
        <button class="btn" id="btnAddLane" style="width:100%;">ADD LANE</button>
        <div style="height:8px"></div>
        <div class="hint">Click lane = current lane. Right-click lane = rename.</div>
      </div>

      <div class="sec">
        <div class="secHd">
          <div class="h">FILTER</div>
          <div class="sub">LANE / TAG / STATUS / SEARCH</div>
        </div>

        <div class="row">
          <select class="sel" id="fltLane"></select>
          <select class="sel" id="fltStatus">
            <option value="active">ACTIVE ONLY</option>
            <option value="all">ALL</option>
            <option value="deprecated">DEPRECATED ONLY</option>
          </select>
        </div>
        <div style="height:8px"></div>
        <input class="inp" id="fltTag" placeholder="TAG CONTAINS (comma/space ok)"/>
        <div style="height:8px"></div>
        <input class="inp" id="fltSearch" placeholder="SEARCH (path / note / tags / version)"/>
        <div style="height:8px"></div>
        <button class="btn" id="btnClearFilters" style="width:100%;">CLEAR FILTERS</button>
      </div>

      <div class="sec">
        <div class="secHd">
          <div class="h">ASSIGNMENT</div>
          <div class="sub">BULK ROUTING TO A DAY</div>
        </div>

        <div class="row">
          <input class="inp mono" id="assignDay" type="date"/>
          <button class="btn" id="btnOpenDay">OPEN DAY</button>
        </div>
        <div style="height:8px"></div>
        <button class="btn" id="btnAssignFiltered" style="width:100%;">ASSIGN FILTERED → DAY</button>
        <div style="height:8px"></div>
        <button class="btn danger" id="btnClearDay" style="width:100%;">CLEAR DAY (UNASSIGN ALL)</button>

        <div style="height:10px"></div>
        <div class="hint">
          Bulk assign uses current filters. It sets <span class="mono">triageDay</span> on matching links.<br/>
          Month view always shows what’s assigned, regardless of filters.
        </div>
      </div>

      <div class="sec">
        <div class="secHd">
          <div class="h">STATE</div>
          <div class="sub">REAL FILE DOWNLOAD</div>
        </div>
        <input class="inp" id="exportLabel" placeholder="EXPORT LABEL (HUMAN)"/>
        <div style="height:8px"></div>
        <input class="inp" id="exportTag" placeholder="VERSION TAG (e.g. LINK_CAL_v1)"/>
        <div style="height:10px"></div>
        <div class="hint">
          Tip: <kbd>←</kbd>/<kbd>→</kbd> month, <kbd>T</kbd> today, <kbd>Enter</kbd> open day.
        </div>
      </div>

      <input type="file" id="fileIn" accept=".json,application/json,text/plain" style="display:none"/>
    </div>

    <div class="right">
      <div class="monthHdr">
        <div class="monthTitle" id="monthTitle">MONTH</div>
        <div class="pill" id="monthPill">0 ASSIGNED</div>
        <div class="sp"></div>
        <div class="pill mono" id="sig">FILE</div>
      </div>

      <div class="dow">
        <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
      </div>
      <div class="cal" id="cal"></div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="panel">
      <div class="panelHd">
        <div class="hh" id="modalTitle">DAY</div>
        <div class="ss" id="modalSub">—</div>
        <div style="flex:1"></div>
        <button class="btn" id="modalClose">CLOSE</button>
      </div>

      <div class="hr"></div>

      <div class="row">
        <button class="btn" id="btnDayExport">EXPORT DAY URLS</button>
        <button class="btn" id="btnDayClear">CLEAR DAY (UNASSIGN)</button>
        <button class="btn" id="btnAssignFilteredHere">ASSIGN FILTERED → THIS DAY</button>
      </div>

      <div class="hr"></div>

      <div class="gridCards" id="dayCards"></div>

      <div class="hr"></div>
      <div class="hint" id="modalHint"></div>
    </div>
  </div>

<script>
(() => {
  /* ===========================
     KETADATA LINK TRIAGE CALENDAR (MONTH)
     - GitHub repo sync (TREE API)
     - Full month view (42-cell)
     - Assign links to days (triageDay)
     - Local-first state + real file IO
  ============================ */

  const $ = (id)=>document.getElementById(id);
  const nowISO = ()=> new Date().toISOString();

  // stable 10-hex hash (FNV-1a variant)
  function hash10(str){
    let h = 0x811c9dc5;
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = (h * 0x01000193) >>> 0;
    }
    let x = h.toString(16).padStart(8,"0");
    let h2 = (h ^ (h>>>16)) >>> 0;
    let y = h2.toString(16).padStart(8,"0");
    return (x+y).slice(0,10).toUpperCase();
  }

  function toast(s){ $("meta").textContent = s; }

  function dlText(filename, mime, text){
    const blob = new Blob([text||""], {type:mime||"text/plain"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename || "export.txt";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 900);
  }

  function stamp(){
    const d=new Date();
    const yyyy=d.getFullYear();
    const mm=String(d.getMonth()+1).padStart(2,"0");
    const dd=String(d.getDate()).padStart(2,"0");
    const hh=String(d.getHours()).padStart(2,"0");
    const mi=String(d.getMinutes()).padStart(2,"0");
    return `${yyyy}${mm}${dd}_${hh}${mi}`;
  }

  function toDayKey(d){
    const yyyy=d.getFullYear();
    const mm=String(d.getMonth()+1).padStart(2,"0");
    const dd=String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }
  function parseDayKey(k){
    const m=/^(\d{4})-(\d{2})-(\d{2})$/.exec(k||"");
    if(!m) return null;
    const d=new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));
    return isNaN(d.getTime()) ? null : d;
  }
  function monthLabel(y,m){
    const d=new Date(y,m,1);
    return d.toLocaleString(undefined,{month:"long", year:"numeric"}).toUpperCase();
  }

  function monthCells(y,m){
    const first=new Date(y,m,1);
    const startDow=first.getDay(); // 0 Sun
    const start=new Date(y,m,1 - startDow);
    const cells=[];
    for(let i=0;i<42;i++){
      const d=new Date(start.getFullYear(), start.getMonth(), start.getDate()+i);
      cells.push(d);
    }
    return cells;
  }

  // -------------------------
  // Defaults / state
  // -------------------------
  const DEFAULT_REPO = {
    owner: "ki-tya",
    repo: "ketadata",
    branch: "main",
    pagesBase: "https://ki-tya.github.io/ketadata/"
  };
  const DEFAULT_LANES = () => ([
    { id:"L0", name:"INBOX", deprecated:false },
    { id:"L1", name:"CORE", deprecated:false },
    { id:"L2", name:"EXPERIMENTS", deprecated:false },
    { id:"L3", name:"DEPRECATED", deprecated:true }
  ]);

  const FILE_ID = (() => {
    const k="KETADATA_LINK_CAL__FILE_ID";
    let v=localStorage.getItem(k);
    if(!v){ v="KLCAL-"+Math.random().toString(16).slice(2)+"-"+Date.now().toString(16); localStorage.setItem(k,v); }
    return v;
  })();

  const LS_KEY = "KETADATA_LINK_CAL_STATE__" + FILE_ID;

  const DEFAULT_STATE = () => ({
    version: "KETADATA_LINK_CALENDAR_MONTH_v1_TREE_API",
    fileId: FILE_ID,
    updatedAt: nowISO(),
    exportLabel: "",
    exportTag: "",
    ketaNote: "",
    repo: { ...DEFAULT_REPO },
    ui: {
      monthY: new Date().getFullYear(),
      monthM: new Date().getMonth(),
      laneId: "L0",
      filterStatus: "active",
      filterTag: "",
      filterSearch: "",
      selectedDay: toDayKey(new Date())
    },
    lanes: DEFAULT_LANES(),
    // links keyed by path
    links: {} // path -> {path,url,laneId,tags,version,status,note,missing,triageDay}
  });

  function normLane(l){
    return {
      id: typeof l.id==="string" ? l.id : ("L"+Math.random().toString(16).slice(2,6).toUpperCase()),
      name: typeof l.name==="string" ? l.name : "LANE",
      deprecated: !!l.deprecated
    };
  }

  function normalizePagesBase(s){
    let x=(s||DEFAULT_REPO.pagesBase).trim();
    if(!x.endsWith("/")) x+="/";
    return x;
  }

  function normalizeState(s){
    const base = DEFAULT_STATE();
    if(!s || typeof s!=="object") return base;

    const out = {
      ...base,
      version: typeof s.version==="string" ? s.version : base.version,
      updatedAt: typeof s.updatedAt==="string" ? s.updatedAt : nowISO(),
      exportLabel: typeof s.exportLabel==="string" ? s.exportLabel : "",
      exportTag: typeof s.exportTag==="string" ? s.exportTag : "",
      ketaNote: typeof s.ketaNote==="string" ? s.ketaNote : "",
      repo: { ...base.repo, ...(s.repo && typeof s.repo==="object" ? s.repo : {}) },
      ui: { ...base.ui, ...(s.ui && typeof s.ui==="object" ? s.ui : {}) },
      lanes: Array.isArray(s.lanes) ? s.lanes.map(normLane) : base.lanes,
      links: (s.links && typeof s.links==="object") ? s.links : {}
    };

    out.repo.owner = (out.repo.owner || DEFAULT_REPO.owner).trim();
    out.repo.repo = (out.repo.repo || DEFAULT_REPO.repo).trim();
    out.repo.branch = (out.repo.branch || DEFAULT_REPO.branch).trim();
    out.repo.pagesBase = normalizePagesBase(out.repo.pagesBase || DEFAULT_REPO.pagesBase);

    if(!out.lanes.some(l=>l.id===out.ui.laneId)) out.ui.laneId = out.lanes[0].id;

    // harden selectedDay
    if(!/^\d{4}-\d{2}-\d{2}$/.test(out.ui.selectedDay||"")) out.ui.selectedDay = toDayKey(new Date());

    // normalize links entries
    const fixed={};
    for(const [path,v] of Object.entries(out.links)){
      const p=String(path||"").trim();
      if(!p) continue;
      const obj=(v && typeof v==="object") ? v : {};
      fixed[p]={
        path:p,
        url: obj.url ? String(obj.url) : "",
        laneId: typeof obj.laneId==="string" ? obj.laneId : out.ui.laneId,
        tags: obj.tags ? String(obj.tags) : "",
        version: obj.version ? String(obj.version) : "",
        status: (obj.status==="deprecated") ? "deprecated" : "active",
        note: obj.note ? String(obj.note) : "",
        missing: !!obj.missing,
        triageDay: (obj.triageDay && /^\d{4}-\d{2}-\d{2}$/.test(obj.triageDay)) ? obj.triageDay : ""
      };
      if(!out.lanes.some(l=>l.id===fixed[p].laneId)) fixed[p].laneId = out.ui.laneId;
    }
    out.links=fixed;
    return out;
  }

  function loadLocal(){
    try{
      const raw=localStorage.getItem(LS_KEY);
      if(!raw) return null;
      return normalizeState(JSON.parse(raw));
    }catch{return null;}
  }
  function saveLocal(){
    try{
      state.updatedAt = nowISO();
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }catch{}
  }

  let state = loadLocal() || DEFAULT_STATE();
  let modalDay = state.ui.selectedDay;

  // -------------------------
  // Repo sync (TREE API: 1 call)
  // -------------------------
  async function ghJSON(url){
    const res = await fetch(url, { headers: { "Accept": "application/vnd.github+json" } });
    if(!res.ok){
      const txt = await res.text().catch(()=> "");
      throw new Error(`GITHUB API ${res.status} ${res.statusText}\n${url}\n${txt}`);
    }
    return res.json();
  }
  async function fetchRepoTree(owner, repo, branch){
    const u = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/git/trees/${encodeURIComponent(branch)}?recursive=1`;
    const data = await ghJSON(u);
    if(!data || !Array.isArray(data.tree)) return [];
    return data.tree;
  }
  function derivedUrl(path){
    const base = normalizePagesBase(state.repo.pagesBase);
    return base + path.replace(/^\/+/, "");
  }
  function isPageHtml(path){
    const p=(path||"").toLowerCase();
    if(!p.endsWith(".html")) return false;
    const deny = ["content/","images/","img/","assets/","static/","media/","docs/"];
    return !deny.some(pref => p.startsWith(pref));
  }

  async function syncRepo(){
    // persist inputs
    state.repo.owner = ($("repoOwner").value || DEFAULT_REPO.owner).trim();
    state.repo.repo = ($("repoName").value || DEFAULT_REPO.repo).trim();
    state.repo.branch = ($("repoBranch").value || DEFAULT_REPO.branch).trim();
    state.repo.pagesBase = normalizePagesBase($("pagesBase").value || DEFAULT_REPO.pagesBase);

    toast(`SYNCING ${state.repo.owner}/${state.repo.repo}@${state.repo.branch} ...`);

    // mark all missing initially
    for(const k of Object.keys(state.links)) state.links[k].missing = true;

    const tree = await fetchRepoTree(state.repo.owner, state.repo.repo, state.repo.branch);

    const htmls = tree
      .filter(x => x.type==="blob")
      .map(x => x.path)
      .filter(isPageHtml)
      .sort((a,b)=>a.localeCompare(b));

    let added=0, kept=0;

    for(const p of htmls){
      const hit = state.links[p];
      if(hit){
        hit.missing=false;
        hit.url = derivedUrl(p); // force auto URL
        kept++;
      }else{
        state.links[p]={
          path:p,
          url: derivedUrl(p),
          laneId: state.ui.laneId || state.lanes[0].id,
          tags:"",
          version:"",
          status:"active",
          note:"",
          missing:false,
          triageDay:""
        };
        added++;
      }
    }

    saveLocal();
    render();
    toast(`SYNC DONE // ${htmls.length} HTML PAGES // +${added} NEW // ${kept} KEPT`);
  }

  // -------------------------
  // Filters
  // -------------------------
  function currentFilters(){
    return {
      laneId: $("fltLane").value || state.ui.laneId,
      status: $("fltStatus").value || "active",
      tag: ($("fltTag").value || "").trim().toLowerCase(),
      search: ($("fltSearch").value || "").trim().toLowerCase()
    };
  }
  function tagsMatch(needle, tags){
    if(!needle) return true;
    const need = needle.split(/[, ]+/).filter(Boolean);
    const have = (tags||"").toLowerCase().split(/[, ]+/).filter(Boolean);
    return need.every(n => have.includes(n));
  }
  function searchMatch(needle, fields){
    if(!needle) return true;
    const blob = fields.join(" ").toLowerCase();
    return blob.includes(needle);
  }
  function filteredLinks(){
    const f=currentFilters();
    return Object.values(state.links)
      .filter(it => !f.laneId || it.laneId===f.laneId)
      .filter(it => {
        if(f.status==="active") return it.status!=="deprecated";
        if(f.status==="deprecated") return it.status==="deprecated";
        return true;
      })
      .filter(it => tagsMatch(f.tag, it.tags))
      .filter(it => searchMatch(f.search, [it.path, it.tags, it.note, it.version]))
      .sort((a,b)=>a.path.localeCompare(b.path));
  }

  // -------------------------
  // Assignment ops
  // -------------------------
  function assignListToDay(list, dayKey){
    if(!/^\d{4}-\d{2}-\d{2}$/.test(dayKey||"")) return 0;
    let n=0;
    for(const it of list){
      if(it.triageDay !== dayKey){
        it.triageDay = dayKey;
        n++;
      }
    }
    return n;
  }
  function clearDay(dayKey){
    let n=0;
    for(const it of Object.values(state.links)){
      if(it.triageDay === dayKey){
        it.triageDay = "";
        n++;
      }
    }
    return n;
  }

  // -------------------------
  // Rendering
  // -------------------------
  function refreshLaneSelect(){
    const sel=$("fltLane");
    sel.innerHTML="";
    for(const l of state.lanes){
      const opt=document.createElement("option");
      opt.value=l.id;
      opt.textContent=l.name;
      sel.appendChild(opt);
    }
    sel.value = state.ui.laneId || state.lanes[0].id;
  }

  function renderLanesBar(){
    const wrap=$("lanes");
    wrap.innerHTML="";
    for(const l of state.lanes){
      const b=document.createElement("button");
      b.className="laneBtn" + (l.id===state.ui.laneId ? " active":"") + (l.deprecated ? " depr":"");
      b.textContent=l.name;
      b.title="CLICK = SET CURRENT LANE // RIGHT-CLICK = RENAME";
      b.addEventListener("click", ()=>{
        state.ui.laneId = l.id;
        $("fltLane").value = l.id;
        saveLocal();
        render();
      });
      b.addEventListener("contextmenu",(e)=>{
        e.preventDefault();
        const nn = prompt("RENAME LANE:", l.name);
        if(nn===null) return;
        l.name = (nn||"").trim() || l.name;
        saveLocal();
        render();
      });
      wrap.appendChild(b);
    }
  }

  function monthAssignedCount(y,m){
    const prefix = `${y}-${String(m+1).padStart(2,"0")}-`;
    let c=0;
    for(const it of Object.values(state.links)){
      if(it.triageDay && it.triageDay.startsWith(prefix)) c++;
    }
    return c;
  }

  function dayAssigned(dayKey){
    return Object.values(state.links)
      .filter(it => it.triageDay === dayKey)
      .sort((a,b)=>a.path.localeCompare(b.path));
  }

  function setSig(){
    $("sig").textContent = `FILE_ID ${state.fileId} · LINKS ${Object.keys(state.links).length} · UPDATED ${state.updatedAt.slice(0,16).replace("T"," ")}`;
  }

  function renderCalendar(){
    const y=state.ui.monthY, m=state.ui.monthM;
    $("monthTitle").innerHTML = `<span>${monthLabel(y,m)}</span> <span class="dim">(${y}-${String(m+1).padStart(2,"0")})</span>`;
    $("monthPill").textContent = `${monthAssignedCount(y,m)} ASSIGNED`;

    const cal=$("cal");
    cal.innerHTML="";

    const cells=monthCells(y,m);
    const sel=state.ui.selectedDay;
    const today=toDayKey(new Date());

    for(const d of cells){
      const dayKey=toDayKey(d);
      const arr=dayAssigned(dayKey);

      const el=document.createElement("div");
      el.className="day";
      if(d.getMonth()!==m) el.classList.add("mute");
      if(dayKey===sel) el.classList.add("sel");
      if(dayKey===today) el.classList.add("today");

      const top=document.createElement("div");
      top.className="dTop";

      const n=document.createElement("div");
      n.className="dNum";
      n.textContent=String(d.getDate()).padStart(2,"0");

      const key=document.createElement("div");
      key.className="dKey mono";
      key.textContent=dayKey;

      const cnt=document.createElement("div");
      cnt.className="dCount mono";
      cnt.textContent = `${arr.length}L`;

      top.appendChild(n);
      top.appendChild(key);
      top.appendChild(cnt);

      const mini=document.createElement("div");
      mini.className="mini";

      // show up to 6 lines
      arr.slice(0,6).forEach(it=>{
        const ln=document.createElement("div");
        ln.className="ln" + (it.status==="deprecated" ? " depr":"") + (it.missing ? " missing":"");

        const hs=document.createElement("div");
        hs.className="hash mono";
        hs.textContent=hash10(it.path).slice(0,8);

        const p=document.createElement("div");
        p.className="path";
        p.textContent=it.path;

        const a=document.createElement("a");
        a.className="open";
        a.href=it.url;
        a.target="_blank";
        a.rel="noopener";
        a.textContent = it.missing ? "OPEN (M)" : "OPEN";

        ln.appendChild(hs);
        ln.appendChild(p);
        ln.appendChild(a);

        mini.appendChild(ln);
      });

      if(arr.length>6){
        const more=document.createElement("div");
        more.className="mono";
        more.style.opacity=".65";
        more.style.letterSpacing=".08em";
        more.textContent = `+${arr.length-6} MORE`;
        mini.appendChild(more);
      }

      el.appendChild(top);
      el.appendChild(mini);

      el.addEventListener("click", ()=>{
        state.ui.selectedDay = dayKey;
        $("assignDay").value = dayKey;
        saveLocal();
        render();
        openDayModal(dayKey);
      });

      cal.appendChild(el);
    }
  }

  function renderCounts(){
    const total = Object.keys(state.links).length;
    const f=currentFilters();
    const laneCount = Object.values(state.links).filter(x => x.laneId===f.laneId).length;
    $("counts").textContent = `${total} LINKS // ${laneCount} IN LANE`;
  }

  function render(){
    // hydrate left inputs
    $("repoOwner").value = state.repo.owner;
    $("repoName").value = state.repo.repo;
    $("repoBranch").value = state.repo.branch;
    $("pagesBase").value = state.repo.pagesBase;

    $("ketaNote").value = state.ketaNote || "";
    $("exportLabel").value = state.exportLabel || "";
    $("exportTag").value = state.exportTag || "";

    refreshLaneSelect();
    $("fltLane").value = state.ui.laneId || state.lanes[0].id;
    $("fltStatus").value = state.ui.filterStatus || "active";
    $("fltTag").value = state.ui.filterTag || "";
    $("fltSearch").value = state.ui.filterSearch || "";

    $("assignDay").value = state.ui.selectedDay;

    renderLanesBar();
    renderCounts();
    renderCalendar();
    setSig();
    saveLocal();
  }

  // -------------------------
  // Day modal (cards like your grid)
  // -------------------------
  function openDayModal(dayKey){
    modalDay = dayKey;
    $("modalTitle").textContent = "DAY";
    $("modalSub").textContent = dayKey + " · " + dayAssigned(dayKey).length + " LINKS";
    $("modal").classList.add("show");

    const cards=$("dayCards");
    cards.innerHTML="";

    const list = dayAssigned(dayKey);
    if(!list.length){
      const empty=document.createElement("div");
      empty.className="hint";
      empty.textContent="NO LINKS ASSIGNED. USE BULK ASSIGN (LEFT PANEL) OR ‘ASSIGN FILTERED → THIS DAY’.";
      cards.appendChild(empty);
    }

    for(const it of list){
      const card=document.createElement("div");
      card.className="card" + (it.status==="deprecated" ? " depr":"") + (it.missing ? " missing":"");

      const top=document.createElement("div");
      top.className="cTop";

      const hs=document.createElement("div");
      hs.className="hash mono";
      hs.textContent=hash10(it.path);

      const path=document.createElement("div");
      path.className="path";
      path.textContent=it.path;

      const open=document.createElement("a");
      open.className="open";
      open.href=it.url;
      open.target="_blank";
      open.rel="noopener";
      open.textContent = it.missing ? "OPEN (MISSING)" : "OPEN";

      top.appendChild(hs);
      top.appendChild(path);
      top.appendChild(open);

      const row1=document.createElement("div");
      row1.className="cGrid3";

      const laneSel=document.createElement("select");
      laneSel.className="sel";
      for(const l of state.lanes){
        const opt=document.createElement("option");
        opt.value=l.id;
        opt.textContent=l.name;
        laneSel.appendChild(opt);
      }
      laneSel.value=it.laneId;
      laneSel.addEventListener("change", ()=>{
        it.laneId=laneSel.value;
        saveLocal();
        render();
        $("modalSub").textContent = dayKey + " · " + dayAssigned(dayKey).length + " LINKS";
      });

      const statusSel=document.createElement("select");
      statusSel.className="sel";
      statusSel.innerHTML = `
        <option value="active">ACTIVE</option>
        <option value="deprecated">DEPRECATED</option>
      `;
      statusSel.value=it.status;
      statusSel.addEventListener("change", ()=>{
        it.status=statusSel.value;
        saveLocal();
        render();
      });

      const verInp=document.createElement("input");
      verInp.className="inp";
      verInp.placeholder="VERSION";
      verInp.value=it.version||"";
      verInp.addEventListener("input", ()=>{
        it.version=verInp.value;
        saveLocal();
      });

      row1.appendChild(laneSel);
      row1.appendChild(statusSel);
      row1.appendChild(verInp);

      const row2=document.createElement("div");
      row2.className="cGrid2";

      const tagsInp=document.createElement("input");
      tagsInp.className="inp";
      tagsInp.placeholder="TAGS (comma/space)";
      tagsInp.value=it.tags||"";
      tagsInp.addEventListener("input", ()=>{
        it.tags=tagsInp.value;
        saveLocal();
      });

      const noteTa=document.createElement("textarea");
      noteTa.className="ta small";
      noteTa.placeholder="NOTE";
      noteTa.value=it.note||"";
      noteTa.addEventListener("input", ()=>{
        it.note=noteTa.value;
        saveLocal();
      });

      row2.appendChild(tagsInp);
      row2.appendChild(noteTa);

      const row3=document.createElement("div");
      row3.className="row";

      const un=document.createElement("button");
      un.className="btn danger";
      un.textContent="UNASSIGN";
      un.addEventListener("click", ()=>{
        it.triageDay="";
        saveLocal();
        render();
        openDayModal(dayKey); // re-render modal
      });

      const setToday=document.createElement("button");
      setToday.className="btn";
      setToday.textContent="SET TODAY";
      setToday.addEventListener("click", ()=>{
        it.triageDay=toDayKey(new Date());
        saveLocal();
        render();
        openDayModal(dayKey);
      });

      const move=document.createElement("input");
      move.className="inp mono";
      move.type="date";
      move.value=it.triageDay || dayKey;
      move.addEventListener("change", ()=>{
        const v=(move.value||"").trim();
        if(!/^\d{4}-\d{2}-\d{2}$/.test(v)) return;
        it.triageDay=v;
        saveLocal();
        render();
        if(v!==dayKey) openDayModal(dayKey);
      });

      row3.appendChild(move);
      row3.appendChild(setToday);
      row3.appendChild(un);

      card.appendChild(top);
      card.appendChild(row1);
      card.appendChild(row2);
      card.appendChild(row3);

      cards.appendChild(card);
    }

    $("modalHint").textContent =
      "DAY MODE: edit lane/status/tags/notes/version. Unassign removes it from this day only. " +
      "Missing = file removed from repo but notes preserved.";
  }

  function closeModal(){ $("modal").classList.remove("show"); }

  // -------------------------
  // Export month/day
  // -------------------------
  function exportMonthText(){
    const y=state.ui.monthY, m=state.ui.monthM;
    const prefix = `${y}-${String(m+1).padStart(2,"0")}-`;
    const byDay=new Map();
    for(const it of Object.values(state.links)){
      if(!it.triageDay || !it.triageDay.startsWith(prefix)) continue;
      if(!byDay.has(it.triageDay)) byDay.set(it.triageDay, []);
      byDay.get(it.triageDay).push(it);
    }
    const days=[...byDay.keys()].sort((a,b)=>a.localeCompare(b));
    const lines=[];
    lines.push(`KETADATA LINK TRIAGE CALENDAR // MONTH EXPORT`);
    if(state.exportLabel) lines.push(`EXPORT_LABEL: ${state.exportLabel}`);
    if(state.exportTag) lines.push(`VERSION_TAG: ${state.exportTag}`);
    lines.push(`MONTH: ${monthLabel(y,m)} (${prefix.slice(0,7)})`);
    lines.push(`REPO: ${state.repo.owner}/${state.repo.repo}@${state.repo.branch}`);
    lines.push(`PAGES_BASE: ${state.repo.pagesBase}`);
    lines.push(`UPDATED_AT: ${nowISO()}`);
    lines.push("");

    const gnote=(state.ketaNote||"").trim();
    if(gnote){
      lines.push("GLOBAL_KETA_NOTE:");
      lines.push(gnote);
      lines.push("");
    }

    for(const day of days){
      lines.push(day);
      const arr=byDay.get(day).slice().sort((a,b)=>a.path.localeCompare(b.path));
      for(const it of arr){
        const flags=[];
        if(it.status==="deprecated") flags.push("DEPRECATED");
        if(it.missing) flags.push("MISSING");
        if(it.version) flags.push("VER:"+it.version);
        if(it.tags) flags.push("TAGS:"+it.tags);
        lines.push(`- ${it.url}  (${it.path})${flags.length ? "  ["+flags.join(" | ")+"]" : ""}`);
        if(it.note) lines.push(`  NOTE: ${it.note}`);
      }
      lines.push("");
    }
    return lines.join("\n").trim()+"\n";
  }

  function exportDayUrls(dayKey){
    const arr=dayAssigned(dayKey);
    return arr.map(it => it.url).filter(Boolean).join("\n") + (arr.length? "\n":"");
  }

  // -------------------------
  // State file IO
  // -------------------------
  function exportStateToFile(){
    // sync inputs into state first
    state.exportLabel = ($("exportLabel").value || "").trim();
    state.exportTag = ($("exportTag").value || "").trim();
    state.ketaNote = ($("ketaNote").value || "").trim();
    state.repo.owner = ($("repoOwner").value || DEFAULT_REPO.owner).trim();
    state.repo.repo = ($("repoName").value || DEFAULT_REPO.repo).trim();
    state.repo.branch = ($("repoBranch").value || DEFAULT_REPO.branch).trim();
    state.repo.pagesBase = normalizePagesBase($("pagesBase").value || DEFAULT_REPO.pagesBase);

    saveLocal();

    const payload = normalizeState({
      ...state,
      updatedAt: nowISO(),
      _exportedAt: nowISO(),
      _storeKey: LS_KEY
    });

    const text=JSON.stringify(payload, null, 2);
    const fn=`KETADATA_LINK_CAL_STATE_${state.fileId}_${stamp()}.json`;
    dlText(fn, "application/json", text);
    toast("STATE → FILE");
  }

  function importStateFromFile(file){
    const r=new FileReader();
    r.onload=()=>{
      try{
        const obj=JSON.parse(String(r.result||""));
        state = normalizeState(obj);
        // keep this FILE_ID isolation (never overwrite)
        state.fileId = FILE_ID;
        saveLocal();
        render();
        toast("STATE IMPORTED");
      }catch{
        toast("IMPORT FAILED");
      }
    };
    r.readAsText(file);
  }

  // -------------------------
  // Wiring
  // -------------------------
  $("modalClose").addEventListener("click", closeModal);
  $("modal").addEventListener("click", (e)=>{ if(e.target === $("modal")) closeModal(); });

  $("btnPrev").addEventListener("click", ()=>{
    let y=state.ui.monthY, m=state.ui.monthM;
    m--; if(m<0){m=11;y--;}
    state.ui.monthY=y; state.ui.monthM=m;
    saveLocal(); render();
  });
  $("btnNext").addEventListener("click", ()=>{
    let y=state.ui.monthY, m=state.ui.monthM;
    m++; if(m>11){m=0;y++;}
    state.ui.monthY=y; state.ui.monthM=m;
    saveLocal(); render();
  });
  $("btnToday").addEventListener("click", ()=>{
    const d=new Date();
    state.ui.monthY=d.getFullYear();
    state.ui.monthM=d.getMonth();
    state.ui.selectedDay=toDayKey(d);
    $("assignDay").value=state.ui.selectedDay;
    saveLocal(); render();
    toast("TODAY");
  });

  $("btnSync").addEventListener("click", ()=>{
    syncRepo().catch(e=>{
      toast("SYNC FAILED");
      alert(String(e && e.message ? e.message : e));
    });
  });

  $("btnAddLane").addEventListener("click", ()=>{
    const id="L"+Math.random().toString(16).slice(2,6).toUpperCase();
    state.lanes.push({id, name:"LANE", deprecated:false});
    state.ui.laneId=id;
    saveLocal(); render();
    toast("LANE ADDED");
  });

  $("btnClearFilters").addEventListener("click", ()=>{
    state.ui.filterStatus="active";
    state.ui.filterTag="";
    state.ui.filterSearch="";
    $("fltStatus").value="active";
    $("fltTag").value="";
    $("fltSearch").value="";
    saveLocal(); render();
    toast("FILTERS CLEARED");
  });

  $("fltLane").addEventListener("change", ()=>{ state.ui.laneId=$("fltLane").value; saveLocal(); render(); });
  $("fltStatus").addEventListener("change", ()=>{ state.ui.filterStatus=$("fltStatus").value; saveLocal(); render(); });
  $("fltTag").addEventListener("input", ()=>{ state.ui.filterTag=$("fltTag").value; saveLocal(); render(); });
  $("fltSearch").addEventListener("input", ()=>{ state.ui.filterSearch=$("fltSearch").value; saveLocal(); render(); });

  $("repoOwner").addEventListener("input", ()=>{ state.repo.owner=$("repoOwner").value; saveLocal(); });
  $("repoName").addEventListener("input", ()=>{ state.repo.repo=$("repoName").value; saveLocal(); });
  $("repoBranch").addEventListener("input", ()=>{ state.repo.branch=$("repoBranch").value; saveLocal(); });
  $("pagesBase").addEventListener("input", ()=>{ state.repo.pagesBase=normalizePagesBase($("pagesBase").value); saveLocal(); });

  $("ketaNote").addEventListener("input", ()=>{ state.ketaNote=$("ketaNote").value||""; saveLocal(); });
  $("exportLabel").addEventListener("input", ()=>{ state.exportLabel=$("exportLabel").value||""; saveLocal(); });
  $("exportTag").addEventListener("input", ()=>{ state.exportTag=$("exportTag").value||""; saveLocal(); });

  $("assignDay").addEventListener("change", ()=>{
    const v=($("assignDay").value||"").trim();
    if(/^\d{4}-\d{2}-\d{2}$/.test(v)){
      state.ui.selectedDay=v;
      saveLocal(); render();
      toast("DAY SET");
    }
  });

  $("btnOpenDay").addEventListener("click", ()=>{
    const d=($("assignDay").value||state.ui.selectedDay||"").trim();
    if(!/^\d{4}-\d{2}-\d{2}$/.test(d)) return toast("BAD DAY");
    state.ui.selectedDay=d;
    saveLocal(); render();
    openDayModal(d);
  });

  $("btnAssignFiltered").addEventListener("click", ()=>{
    const d=($("assignDay").value||state.ui.selectedDay||"").trim();
    if(!/^\d{4}-\d{2}-\d{2}$/.test(d)) return toast("BAD DAY");
    const list=filteredLinks();
    const n=assignListToDay(list, d);
    saveLocal(); render();
    toast(`ASSIGNED ${n} → ${d}`);
  });

  $("btnClearDay").addEventListener("click", ()=>{
    const d=($("assignDay").value||state.ui.selectedDay||"").trim();
    if(!/^\d{4}-\d{2}-\d{2}$/.test(d)) return toast("BAD DAY");
    const n=clearDay(d);
    saveLocal(); render();
    toast(`CLEARED ${n} FROM ${d}`);
  });

  $("btnExportMonth").addEventListener("click", ()=>{
    const text=exportMonthText();
    const fn=`KETADATA_LINK_CAL_MONTH_${state.fileId}_${state.ui.monthY}-${String(state.ui.monthM+1).padStart(2,"0")}_${stamp()}.txt`;
    dlText(fn, "text/plain", text);
    toast("MONTH EXPORTED");
  });

  $("btnExportState").addEventListener("click", exportStateToFile);
  $("btnImportState").addEventListener("click", ()=>$("fileIn").click());
  $("fileIn").addEventListener("change", (e)=>{
    const f=e.target.files && e.target.files[0];
    if(f) importStateFromFile(f);
    e.target.value="";
  });

  $("btnNew").addEventListener("click", ()=>{
    if(!confirm("RESET TO NEW? (local state will be replaced)")) return;
    state = DEFAULT_STATE();
    saveLocal(); render();
    toast("NEW");
    setTimeout(()=>syncRepo().catch(()=>{}), 120);
  });

  $("btnDayExport").addEventListener("click", ()=>{
    const txt=exportDayUrls(modalDay);
    const fn=`KETADATA_LINK_CAL_DAY_${state.fileId}_${modalDay}_${stamp()}.txt`;
    dlText(fn, "text/plain", txt);
    toast("DAY EXPORTED");
  });

  $("btnDayClear").addEventListener("click", ()=>{
    const n=clearDay(modalDay);
    saveLocal(); render();
    openDayModal(modalDay);
    toast(`DAY CLEARED (${n})`);
  });

  $("btnAssignFilteredHere").addEventListener("click", ()=>{
    const list=filteredLinks();
    const n=assignListToDay(list, modalDay);
    saveLocal(); render();
    openDayModal(modalDay);
    toast(`ASSIGNED ${n} → ${modalDay}`);
  });

  // keyboard
  window.addEventListener("keydown",(e)=>{
    if($("modal").classList.contains("show")){
      if((e.key||"").toLowerCase()==="escape") closeModal();
      return;
    }
    const k=(e.key||"").toLowerCase();
    if(k==="arrowleft"){ $("btnPrev").click(); }
    if(k==="arrowright"){ $("btnNext").click(); }
    if(k==="t"){ $("btnToday").click(); }
    if(k==="enter"){ openDayModal(state.ui.selectedDay); }
  });

  // -------------------------
  // Init
  // -------------------------
  function init(){
    $("repoOwner").value = state.repo.owner;
    $("repoName").value = state.repo.repo;
    $("repoBranch").value = state.repo.branch;
    $("pagesBase").value = state.repo.pagesBase;

    $("ketaNote").value = state.ketaNote || "";
    $("exportLabel").value = state.exportLabel || "";
    $("exportTag").value = state.exportTag || "";

    refreshLaneSelect();
    $("fltLane").value = state.ui.laneId || state.lanes[0].id;
    $("fltStatus").value = state.ui.filterStatus || "active";
    $("fltTag").value = state.ui.filterTag || "";
    $("fltSearch").value = state.ui.filterSearch || "";

    $("assignDay").value = state.ui.selectedDay;

    render();
    toast("READY");

    // auto-sync once (soft fail)
    setTimeout(()=>syncRepo().catch(()=>toast("READY (NO SYNC)")), 140);
  }

  init();
})();
</script>

<!--
AE/EE/WB SERIALIZATION STAMP (MANDATORY)

AE: monochrome, letter-spaced operational chrome; month grid days as cards; hash badges; no decorative color.
EE: GitHub TREE sync (one call), links keyed by path, derived URL (pagesBase+path), lanes, filters, assign-to-day (triageDay),
    full month view (42 cells), day modal with per-link editing, export month (grouped by day), export day urls.
WB: localStorage isolation via FILE_ID + LS_KEY; real file export/import for state; soft keyboard controls; missing-file preservation.

FILE_ID: (runtime) KLCAL-...
ROOM_ID: LINK_TRIAGE_CALENDAR_MONTH
VERSION: KETADATA_LINK_CALENDAR_MONTH_v1_TREE_API
UPDATED_AT: (runtime) new Date().toISOString()
CHANGELOG:
- v1: full month grid + day modal; GitHub Tree API sync; day assignment; month/day exports; state file IO
-->
</body>
</html>
