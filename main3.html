<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>K // DIRECTORY + NOTES</title>
  <style>
    :root{
      --bg:#060607;
      --panel:#0a0b0c;
      --ink:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.55);
      --edge:rgba(255,255,255,.18);
      --edge2:rgba(255,255,255,.34);
      --hard:rgba(255,255,255,.08);
      --w:1200px;

      --rowH: 92px;   /* uniform collapsed height */
      --pad: 12px;
      --font: Arial, Helvetica, sans-serif;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:var(--font);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x:hidden;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 50;
      background: var(--bg);
      border-bottom:1px solid var(--edge);
    }

    .wrap{
      max-width: var(--w);
      margin: 0 auto;
      padding: 14px 16px;
    }

    .top{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 320px;
    }

    .kicker{
      letter-spacing:.26em;
      text-transform:uppercase;
      font-size:11px;
      color:var(--muted);
    }

    .title{
      letter-spacing:.16em;
      text-transform:uppercase;
      font-size:16px;
      font-weight:700;
      line-height:1.1;
    }

    .sub{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      max-width: 760px;
    }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .search{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border:1px solid var(--edge);
      background: var(--panel);
      min-width: min(560px, 92vw);
    }

    .search input{
      width:100%;
      border:0;
      outline:none;
      background:transparent;
      color:var(--ink);
      font-size:12px;
      letter-spacing:.10em;
      text-transform:uppercase;
    }

    .count{
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:var(--muted);
      white-space:nowrap;
    }

    .btn{
      appearance:none;
      border:1px solid var(--edge);
      background: transparent;
      color:var(--ink);
      padding: 10px 12px;
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{ border-color: var(--edge2); }
    .btn:active{ transform: translateY(1px); }

    main{
      max-width: var(--w);
      margin: 0 auto;
      padding: 16px 16px 28px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }

    /* GLOBAL NOTES BAR */
    .global{
      border:1px solid var(--edge);
      background: transparent;
    }
    .globalHead{
      padding: 10px 12px;
      border-bottom:1px solid var(--edge);
      background: var(--panel);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .globalHeadLeft{
      display:flex; align-items:center; gap:10px;
      min-width: 220px;
    }
    .globalLabel{
      font-size:12px;
      font-weight:700;
      letter-spacing:.22em;
      text-transform:uppercase;
    }
    .globalMeta{
      font-size:11px;
      color:var(--muted);
      letter-spacing:.18em;
      text-transform:uppercase;
      white-space:nowrap;
    }
    .globalBody{
      padding: 10px 12px 12px;
    }
    textarea{
      width:100%;
      min-height: 96px;
      resize: vertical;
      border:1px solid var(--edge);
      background: var(--panel);
      color: var(--ink);
      padding: 10px;
      font-size:12px;
      line-height:1.4;
      outline:none;
    }
    textarea:focus{
      border-color: var(--edge2);
    }

    /* MODULE LIST */
    .module{
      border:1px solid var(--edge);
      background: transparent;
    }

    .moduleBar{
      height: var(--rowH);
      display:flex;
      align-items:stretch;
      border-bottom:1px solid var(--edge);
    }

    /* Drag handle column */
    .dragCol{
      width: 36px;
      border-right:1px solid var(--edge);
      display:flex;
      align-items:center;
      justify-content:center;
      background: var(--panel);
      user-select:none;
      cursor: grab;
    }
    .dragCol:active{ cursor: grabbing; }
    .grip{
      width: 12px; height: 18px;
      background:
        radial-gradient(circle, rgba(255,255,255,.55) 1.2px, transparent 1.3px) 0 0/6px 6px;
      opacity: .7;
    }

    /* Main header area */
    .barMain{
      flex:1;
      padding: 10px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      background: var(--panel);
    }

    .barLeft{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 240px;
      max-width: 52%;
    }

    .roomName{
      font-size:12px;
      font-weight:700;
      letter-spacing:.22em;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .roomStats{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.16em;
      text-transform:uppercase;
    }

    .barRight{
      display:flex;
      align-items:flex-start;
      gap:10px;
      flex: 0 0 auto;
    }

    /* White square icon: notes preset */
    .noteIconBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width: 32px;
      height: 32px;
      border:1px solid var(--edge);
      background: transparent;
      cursor:pointer;
    }
    .noteIconBtn:hover{ border-color: var(--edge2); }
    .noteSquare{
      width: 14px;
      height: 14px;
      background: #ffffff; /* white square icon */
    }

    .collapseBtn{
      width:auto;
      padding: 9px 10px;
      border:1px solid var(--edge);
      background: transparent;
      color:var(--ink);
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
    }
    .collapseBtn:hover{ border-color: var(--edge2); }

    /* Expanded body */
    .moduleBody{
      display:none;
      padding: 10px 12px 12px;
      gap: 10px;
      background: transparent;
    }
    .module.expanded .moduleBody{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 980px){
      .module.expanded .moduleBody{ grid-template-columns: 1fr; }
      .barLeft{ max-width: 100%; }
    }

    .panel{
      border:1px solid var(--edge);
      background: var(--panel);
      padding: 10px;
    }
    .panelTitle{
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color: var(--muted);
      margin-bottom: 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .links{
      list-style:none;
      margin:0;
      padding:0;
      border-top:1px solid var(--hard);
    }
    .links li a{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 9px 8px;
      border-top:1px solid var(--hard);
      color: var(--ink);
      text-decoration:none;
      font-size:12px;
      letter-spacing:.02em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .links li:first-child a{ border-top:0; }
    .links li a:hover{
      background: rgba(255,255,255,.06);
      text-decoration: underline;
      text-underline-offset: 2px;
    }
    .arrow{
      color: rgba(255,255,255,.60);
      flex: 0 0 auto;
      border-left: 1px solid rgba(255,255,255,.10);
      padding-left: 10px;
    }

    .small{
      font-size:11px;
      color: var(--muted);
      letter-spacing:.10em;
      text-transform:uppercase;
    }

    /* NOTES MODAL */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.72);
      display:none;
      z-index: 100;
    }
    .modal.open{ display:flex; }
    .modalCard{
      margin: auto;
      width: min(980px, 94vw);
      border:1px solid var(--edge);
      background: var(--bg);
    }
    .modalHead{
      padding: 10px 12px;
      border-bottom:1px solid var(--edge);
      background: var(--panel);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .modalTitle{
      font-size:12px;
      font-weight:700;
      letter-spacing:.22em;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .modalActions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .modalBody{
      padding: 10px 12px 12px;
    }
    .modalBody textarea{
      min-height: 260px;
    }

    /* EXPORTER */
    .exporter{
      border:1px solid var(--edge);
      background: transparent;
    }
    .exportHead{
      padding: 10px 12px;
      border-bottom:1px solid var(--edge);
      background: var(--panel);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .exportTitle{
      font-size:12px;
      font-weight:700;
      letter-spacing:.22em;
      text-transform:uppercase;
    }
    .exportControls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .select{
      border:1px solid var(--edge);
      background: transparent;
      color: var(--ink);
      padding: 10px 10px;
      font-size:11px;
      letter-spacing:.16em;
      text-transform:uppercase;
      outline:none;
    }
    .exportBody{
      padding: 10px 12px 12px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    pre{
      margin:0;
      border:1px solid var(--edge);
      background: var(--panel);
      color: var(--ink);
      padding: 10px;
      overflow:auto;
      font-size:12px;
      line-height:1.45;
      max-height: 320px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Drag states */
    .module.dragging{
      outline:1px solid rgba(255,255,255,.45);
    }
    .dropHint{
      height: 8px;
      border:1px dashed rgba(255,255,255,.25);
      background: rgba(255,255,255,.03);
    }

    footer{
      max-width: var(--w);
      margin: 0 auto;
      padding: 0 16px 24px;
      color: rgba(255,255,255,.35);
      font-size: 11px;
      letter-spacing:.18em;
      text-transform:uppercase;
    }
    kbd{
      font: inherit;
      border: 1px solid var(--edge);
      background: transparent;
      padding: 2px 6px;
      border-radius: 0;
      color: rgba(255,255,255,.70);
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="top">
        <div class="brand">
          <div class="kicker">KETADATA</div>
          <div class="title">Directory + Notes</div>
          <div class="sub">
            Every module has its own note. Entire page has global notes. Drag modules to reorder. Modules collapse to uniform height. Export prompt from notes + links.
          </div>
        </div>

        <div class="controls">
          <div class="search" role="search">
            <input id="q" type="search" placeholder="FILTER (ROOM / URL / NOTE TEXT)" autocomplete="off" />
            <div class="count" id="count">0 LINKS</div>
          </div>
          <button class="btn" id="toggleAllBtn" type="button">TOGGLE ALL</button>
          <button class="btn" id="clearBtn" type="button">CLEAR</button>
          <button class="btn" id="resetOrderBtn" type="button">RESET ORDER</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <!-- GLOBAL NOTES -->
    <section class="global" id="globalNotesSection">
      <div class="globalHead">
        <div class="globalHeadLeft">
          <div class="globalLabel">PAGE NOTES</div>
          <div class="globalMeta" id="globalMeta">SAVED LOCALLY</div>
        </div>
        <div class="globalMeta">TIP: USE THIS FOR OVERARCHING DIRECTIVES</div>
      </div>
      <div class="globalBody">
        <textarea id="globalNotes" placeholder="PAGE NOTES (GLOBAL)."></textarea>
      </div>
    </section>

    <!-- MODULES -->
    <div id="modules"></div>

    <!-- PROMPT EXPORTER -->
    <section class="exporter" id="exporter">
      <div class="exportHead">
        <div class="exportTitle">PROMPT EXPORTER</div>
        <div class="exportControls">
          <select class="select" id="exportMode">
            <option value="all">EXPORT: ALL ROOMS</option>
            <option value="notesOnly">EXPORT: NOTES ONLY</option>
            <option value="linksOnly">EXPORT: LINKS ONLY</option>
            <option value="filtered">EXPORT: CURRENT FILTER ONLY</option>
          </select>
          <button class="btn" id="buildBtn" type="button">BUILD</button>
          <button class="btn" id="copyBtn" type="button">COPY</button>
          <button class="btn" id="downloadBtn" type="button">DOWNLOAD .TXT</button>
        </div>
      </div>
      <div class="exportBody">
        <pre id="exportOut">[BUILD TO GENERATE OUTPUT]</pre>
        <div class="small">INCLUDES GLOBAL NOTES + ROOM NOTES + LINK LISTS (ORDERED AS CURRENTLY ARRANGED).</div>
      </div>
    </section>
  </main>

  <footer>
    KEYS: <kbd>/</kbd> SEARCH · <kbd>ESC</kbd> CLEAR · <kbd>N</kbd> OPEN NOTES (WHEN A ROOM IS FOCUSED)
  </footer>

  <!-- NOTES MODAL -->
  <div class="modal" id="noteModal" aria-hidden="true">
    <div class="modalCard" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="modalTitle" id="modalTitle">NOTES</div>
        <div class="modalActions">
          <button class="btn" id="modalSaveBtn" type="button">SAVE</button>
          <button class="btn" id="modalCloseBtn" type="button">CLOSE</button>
        </div>
      </div>
      <div class="modalBody">
        <textarea id="modalText" placeholder="NOTES."></textarea>
        <div class="small" style="margin-top:10px;">
          NOTES ARE STORED IN LOCALSTORAGE IN THIS BROWSER.
        </div>
      </div>
    </div>
  </div>

  <script>
    /**********************
     * DATA (rooms + links)
     **********************/
    function norm(url){
      const u = String(url).trim();
      if(!u) return "";
      if(u.startsWith("http://") || u.startsWith("https://")) return u;
      return "https://" + u.replace(/^\/+/, "");
    }

    // Default canonical order (can be rearranged; reset restores this)
    const DEFAULT_DATA = [
      { room:"ENTRY POINT", links:["https://ketadata.com/index.html","https://ketadata.com/page2.html"] },
      { room:"LOBBY", links:["ketadata.com/blacklotus.html"] },
      { room:"ELEVATOR", links:["https://ketadata.com/elevator1.html"] },
      { room:"OBSERVATORY", links:["https://ketadata.com/map.html","https://ketadata.com/funding.html","https://ketadata.com/slopstream3.html","https://ketadata.com/cctv1.html"] },
      { room:"KDTV CINEMA", links:["ketadata.com/kdtv1.html","https://ketadata.com/slopstream2.html","https://ketadata.com/darkroom.html","https://ketadata.com/videomanager.html"] },
      { room:"STUDIO", links:["ketadata.com/font.html","ketadata.com/tester3.html","https://ketadata.com/prompt.html","https://ketadata.com/ref.html","https://ketadata.com/color1.html","https://ketadata.com/color3.html","https://ketadata.com/color5.html","https://ketadata.com/studio.html","https://ketadata.com/studio1.html","https://ketadata.com/board3.html","https://ketadata.com/darkroom.html","ketadata.com/studiov0.html","ketadata.com/studiov1.html","https://ketadata.com/controller.html","https://ketadata.com/controller1.html","https://ketadata.com/controller2.html","https://ketadata.com/controller3.html"] },
      { room:"LAB", links:["ketadata.com/prompt3.html","ketadata.com/circle.html","ketadata.com/system8.html","ketadata.com/prompt.html","ketadata.com/html.html","ketadata.com/ref.html","ketadata.com/system4.html","ketadata.com/system5.html","ketadata.com/system6.html"] },
      { room:"BASEMENT", links:["https://ketadata.com/room2.html","https://ketadata.com/page2.html","https://ketadata.com/1.html","https://ketadata.com/2.html","https://ketadata.com/3.html","https://ketadata.com/4.html","https://ketadata.com/5.html","https://ketadata.com/6.html","https://ketadata.com/bleak.html","https://ketadata.com/beatball.html","https://ketadata.com/ball.html","https://ketadata.com/capture.html","https://ketadata.com/capturegpt.html","https://ketadata.com/capturegpt2.html","https://ketadata.com/capturegpt3.html","https://ketadata.com/capturegpt4.html","https://ketadata.com/capturegpt5.html","https://ketadata.com/capturegpt6.html","https://ketadata.com/capturegpt7.html","https://ketadata.com/capturegpt8.html","https://ketadata.com/ripple.html","https://ketadata.com/ripple2.html","https://ketadata.com/ripple3.html","https://ketadata.com/ripplegpt.html","https://ketadata.com/newtrap.html","https://ketadata.com/newtrap2.html","https://ketadata.com/newtrap3.html","https://ketadata.com/dmt.html","https://ketadata.com/dmt2.html","https://ketadata.com/dmt3.html","https://ketadata.com/dmt4.html","https://ketadata.com/dmtzoom.html","https://ketadata.com/mdma.html","https://ketadata.com/mdma2.html","https://ketadata.com/mdmagpt.html","https://ketadata.com/mdmagpt2.html","https://ketadata.com/release.html","https://ketadata.com/release2.html","https://ketadata.com/release3.html","https://ketadata.com/release4.html","https://ketadata.com/gptsubject.html","https://ketadata.com/subgpt2.html","https://ketadata.com/subgpt3.html","https://ketadata.com/subgpt4.html","https://ketadata.com/subgpt5.html","https://ketadata.com/slopstream2.html"] },
      { room:"ROOM", links:["https://ketadata.com/room.html","https://ketadata.com/submit.html"] },
      { room:"LIBRARY", links:["https://ketadata.com/library.html","https://ketadata.com/cctv.html","ketadata.com/deleuze.html","ketadata.com/burroughs.html","ketadata.com/borges.html","ketadata.com/mcluhan.html","ketadata.com/debord.html","jketadata.com/ung.html","ketadata.com/artaud.html","ketadata.com/etal.html","ketadata.com/bataille.html","ketadata.com/bataille1.html","https://ketadata.com/coa3.html","https://ketadata.com/coa4.html","https://ketadata.com/coatofarms.html","https://ketadata.com/coatofarms2.html"] },
      { room:"TEMPLE", links:["ketadata.com/sg1.html","ketadata.com/temple.html","ketadata.com/temple1.html","https://ketadata.com/chakra.html","https://ketadata.com/mandala.html","https://ketadata.com/mandala2.html","https://ketadata.com/mandala3.html","https://ketadata.com/mandalagpt.html","https://ketadata.com/mandalagpt2.html","https://ketadata.com/mandalagpt3.html","https://ketadata.com/mandalagpt4.html","https://ketadata.com/gptsubject.html","https://ketadata.com/subgpt2.html","https://ketadata.com/subgpt3.html","https://ketadata.com/subgpt4.html","https://ketadata.com/subgpt5.html","https://ketadata.com/slopstream.html","https://ketadata.com/slopstream2.html","https://ketadata.com/slopstream3.html","https://ketadata.com/misc.html","https://ketadata.com/misc2.html","https://ketadata.com/misc3.html","https://ketadata.com/misc4.html","https://ketadata.com/misc5.html","https://ketadata.com/misc6.html","https://ketadata.com/misc7.html","https://ketadata.com/misc8.html","ketadata.com/aura.html","ketadata.com/aura1.html","ketadata.com/aura2.html","ketadata.com/blacklotus.html"] },
      { room:"GIFT SHOP", links:["https://ketadata.com/funnel4.html","https://ketadata.com/shop.html"] },
      { room:"VAULT", links:["https://ketadata.com/vape-drive.html","https://ketadata.com/nav.html","https://ketadata.com/directory.html","https://ketadata.com/directory2.html","https://ketadata.com/directory3.html","https://ketadata.com/directory4.html","https://ketadata.com/directory5.html","https://ketadata.com/fund.html","ketadata.com/kdtv.html","ketadata.com/constellation.html","ketadata.com/system.html","ketadata.com/system1.html","ketadata.com/system2.html","ketadata.com/system3.html","ketadata.com/prompt1.html","ketadata.com/prompt2.html","https://ketadata.com/video.html","https://ketadata.com/video2.html","https://ketadata.com/color.html","https://ketadata.com/color2.html","https://ketadata.com/color4.html","https://ketadata.com/board.html","https://ketadata.com/board1.html","https://ketadata.com/board2.html","https://ketadata.com/rippleinfra.html","https://ketadata.com/rippleuv.html","https://ketadata.com/ripplefull.html"] },
      { room:"SYSTEM WIDE FUNCTIONS", links:["https://ketadata.com/1.html","https://ketadata.com/2.html","https://ketadata.com/3.html","https://ketadata.com/4.html","https://ketadata.com/5.html","https://ketadata.com/6.html","https://ketadata.com/submit.html"] }
    ].map(s => {
      const seen = new Set();
      const links = s.links.map(norm).filter(Boolean).filter(u => (seen.has(u)?false:(seen.add(u),true)));
      return { room: s.room, links };
    });

    /**********************
     * STORAGE KEYS
     **********************/
    const K = {
      ORDER: "kd.dir.order.v1",
      EXPANDED: "kd.dir.expanded.v1",
      GLOBAL_NOTES: "kd.dir.globalNotes.v1",
      ROOM_NOTE_PREFIX: "kd.dir.note.room.v1::"
    };

    /**********************
     * STATE
     **********************/
    let data = structuredClone(DEFAULT_DATA);
    let filterText = "";
    let expandedSet = new Set();     // rooms expanded
    let lastFocusedRoom = null;

    /**********************
     * DOM
     **********************/
    const modulesEl = document.getElementById("modules");
    const qEl = document.getElementById("q");
    const countEl = document.getElementById("count");
    const clearBtn = document.getElementById("clearBtn");
    const toggleAllBtn = document.getElementById("toggleAllBtn");
    const resetOrderBtn = document.getElementById("resetOrderBtn");

    const globalNotesEl = document.getElementById("globalNotes");

    const modal = document.getElementById("noteModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalText = document.getElementById("modalText");
    const modalCloseBtn = document.getElementById("modalCloseBtn");
    const modalSaveBtn = document.getElementById("modalSaveBtn");

    const exportModeEl = document.getElementById("exportMode");
    const exportOut = document.getElementById("exportOut");
    const buildBtn = document.getElementById("buildBtn");
    const copyBtn = document.getElementById("copyBtn");
    const downloadBtn = document.getElementById("downloadBtn");

    /**********************
     * HELPERS
     **********************/
    function escHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function roomNoteKey(room){ return K.ROOM_NOTE_PREFIX + room; }

    function getRoomNote(room){
      return localStorage.getItem(roomNoteKey(room)) || "";
    }

    function setRoomNote(room, text){
      localStorage.setItem(roomNoteKey(room), text || "");
    }

    function saveOrder(){
      const order = data.map(d => d.room);
      localStorage.setItem(K.ORDER, JSON.stringify(order));
    }

    function loadOrder(){
      try{
        const raw = localStorage.getItem(K.ORDER);
        if(!raw) return;
        const order = JSON.parse(raw);
        if(!Array.isArray(order) || order.length === 0) return;

        const map = new Map(DEFAULT_DATA.map(x => [x.room, x]));
        const next = [];
        for(const r of order){
          if(map.has(r)) next.push(map.get(r));
        }
        // append any new rooms missing
        for(const x of DEFAULT_DATA){
          if(!order.includes(x.room)) next.push(x);
        }
        data = structuredClone(next);
      }catch(e){}
    }

    function saveExpanded(){
      localStorage.setItem(K.EXPANDED, JSON.stringify([...expandedSet]));
    }
    function loadExpanded(){
      try{
        const raw = localStorage.getItem(K.EXPANDED);
        if(!raw) return;
        const arr = JSON.parse(raw);
        if(Array.isArray(arr)) expandedSet = new Set(arr);
      }catch(e){}
    }

    function applyFilter(section){
      const f = filterText.trim().toLowerCase();
      if(!f) return true;
      const room = section.room.toLowerCase();
      const note = getRoomNote(section.room).toLowerCase();
      if(room.includes(f) || note.includes(f)) return true;
      return section.links.some(u => u.toLowerCase().includes(f));
    }

    function visibleLinksCount(){
      let n = 0;
      for(const s of data){
        if(!applyFilter(s)) continue;
        // count only links that match filter if filter is applied? keep simple: count all in visible rooms
        n += s.links.length;
      }
      return n;
    }

    /**********************
     * RENDER
     **********************/
    function render(){
      modulesEl.innerHTML = "";
      let anyVisible = false;

      for(const section of data){
        if(!applyFilter(section)) continue;
        anyVisible = true;

        const isExpanded = expandedSet.has(section.room);
        const note = getRoomNote(section.room);

        const mod = document.createElement("section");
        mod.className = "module" + (isExpanded ? " expanded" : "");
        mod.setAttribute("data-room", section.room);
        mod.tabIndex = 0; // focusable for N key
        mod.innerHTML = `
          <div class="moduleBar">
            <div class="dragCol" title="DRAG TO REORDER" draggable="true" aria-label="Drag handle">
              <div class="grip"></div>
            </div>

            <div class="barMain">
              <div class="barLeft">
                <div class="roomName">${escHtml(section.room)}</div>
                <div class="roomStats">
                  <span>${section.links.length} LINK${section.links.length===1?"":"S"}</span>
                  <span>${note.trim() ? "NOTE: YES" : "NOTE: NO"}</span>
                </div>
              </div>

              <div class="barRight">
                <button class="noteIconBtn" type="button" title="NOTES (WHITE SQUARE)" aria-label="Open notes">
                  <div class="noteSquare"></div>
                </button>
                <button class="collapseBtn" type="button" aria-label="Toggle module">
                  ${isExpanded ? "COLLAPSE" : "EXPAND"}
                </button>
              </div>
            </div>
          </div>

          <div class="moduleBody">
            <div class="panel">
              <div class="panelTitle">
                <span>ROOM NOTE</span>
                <span class="small">EDIT HERE OR VIA WHITE SQUARE</span>
              </div>
              <textarea class="roomNote" placeholder="NOTE FOR ${escHtml(section.room)}.">${escHtml(note)}</textarea>
            </div>

            <div class="panel">
              <div class="panelTitle">
                <span>LINKS</span>
                <span class="small">${section.links.length} TOTAL</span>
              </div>
              <ul class="links">
                ${section.links.map(u => `
                  <li><a href="${escHtml(u)}"><span class="u">${escHtml(u)}</span><span class="arrow">→</span></a></li>
                `).join("")}
              </ul>
            </div>
          </div>
        `;

        // Events
        const noteBtn = mod.querySelector(".noteIconBtn");
        const collapseBtn = mod.querySelector(".collapseBtn");
        const dragCol = mod.querySelector(".dragCol");
        const noteTa = mod.querySelector(".roomNote");

        mod.addEventListener("focus", () => { lastFocusedRoom = section.room; });

        noteBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          openNoteModal(section.room);
        });

        collapseBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          toggleExpanded(section.room);
        });

        // inline note autosave
        noteTa.addEventListener("input", () => {
          setRoomNote(section.room, noteTa.value);
          // Update stats line without full re-render if desired; simplest: re-render lightly
          // Keep it direct: update the NOTE YES/NO indicator:
          const stats = mod.querySelector(".roomStats");
          if(stats){
            const parts = stats.querySelectorAll("span");
            if(parts && parts[1]){
              parts[1].textContent = noteTa.value.trim() ? "NOTE: YES" : "NOTE: NO";
            }
          }
        });

        // Drag & drop
        dragCol.addEventListener("dragstart", (ev) => onDragStart(ev, section.room, mod));
        mod.addEventListener("dragover", (ev) => onDragOver(ev, mod));
        mod.addEventListener("drop", (ev) => onDrop(ev, section.room));
        mod.addEventListener("dragend", () => onDragEnd());

        // allow clicking the bar to expand/collapse (hard but practical)
        mod.querySelector(".moduleBar").addEventListener("dblclick", () => toggleExpanded(section.room));

        modulesEl.appendChild(mod);
      }

      const n = visibleLinksCount();
      countEl.textContent = `${n} LINK${n===1?"":"S"}`;

      if(!anyVisible){
        const empty = document.createElement("div");
        empty.className = "module";
        empty.innerHTML = `
          <div class="moduleBar" style="border-bottom:0;">
            <div class="barMain" style="background:var(--panel);">
              <div class="barLeft" style="max-width:100%;">
                <div class="roomName">NO MATCHES</div>
                <div class="roomStats"><span>FILTER REMOVED EVERYTHING</span></div>
              </div>
            </div>
          </div>
        `;
        modulesEl.appendChild(empty);
      }
    }

    function toggleExpanded(room){
      if(expandedSet.has(room)) expandedSet.delete(room);
      else expandedSet.add(room);
      saveExpanded();
      render();
    }

    function toggleAll(){
      // If any collapsed among visible → expand visible; else collapse visible
      const visibleRooms = data.filter(applyFilter).map(s => s.room);
      const anyCollapsed = visibleRooms.some(r => !expandedSet.has(r));
      if(anyCollapsed){
        for(const r of visibleRooms) expandedSet.add(r);
      }else{
        for(const r of visibleRooms) expandedSet.delete(r);
      }
      saveExpanded();
      render();
    }

    /**********************
     * NOTES MODAL
     **********************/
    let modalRoom = null;

    function openNoteModal(room){
      modalRoom = room;
      modalTitle.textContent = `NOTES // ${room}`;
      modalText.value = getRoomNote(room);
      modal.classList.add("open");
      modal.setAttribute("aria-hidden","false");
      setTimeout(() => modalText.focus(), 0);
    }

    function closeNoteModal(){
      modal.classList.remove("open");
      modal.setAttribute("aria-hidden","true");
      modalRoom = null;
    }

    function saveModalNote(){
      if(!modalRoom) return;
      setRoomNote(modalRoom, modalText.value);
      closeNoteModal();
      render();
    }

    modalCloseBtn.addEventListener("click", closeNoteModal);
    modalSaveBtn.addEventListener("click", saveModalNote);
    modal.addEventListener("click", (e) => {
      if(e.target === modal) closeNoteModal();
    });

    /**********************
     * GLOBAL NOTES
     **********************/
    function loadGlobalNotes(){
      globalNotesEl.value = localStorage.getItem(K.GLOBAL_NOTES) || "";
    }
    globalNotesEl.addEventListener("input", () => {
      localStorage.setItem(K.GLOBAL_NOTES, globalNotesEl.value || "");
    });

    /**********************
     * FILTER + HOTKEYS
     **********************/
    function clearFilter(){
      qEl.value = "";
      filterText = "";
      render();
      qEl.focus();
    }

    qEl.addEventListener("input", () => {
      filterText = qEl.value || "";
      render();
    });

    clearBtn.addEventListener("click", clearFilter);
    toggleAllBtn.addEventListener("click", toggleAll);

    window.addEventListener("keydown", (e) => {
      if(e.key === "/" && document.activeElement !== qEl){
        e.preventDefault();
        qEl.focus();
      }
      if(e.key === "Escape"){
        if(modal.classList.contains("open")) closeNoteModal();
        else clearFilter();
      }
      if((e.key === "n" || e.key === "N") && !modal.classList.contains("open")){
        // Open notes for currently focused room module
        if(lastFocusedRoom){
          e.preventDefault();
          openNoteModal(lastFocusedRoom);
        }
      }
      if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s"){
        // prevent browser save dialog: we autosave notes
        e.preventDefault();
      }
    });

    /**********************
     * DRAG + DROP REORDER
     **********************/
    let dragRoom = null;
    let dropHintEl = null;

    function onDragStart(ev, room, modEl){
      dragRoom = room;
      modEl.classList.add("dragging");
      ev.dataTransfer.effectAllowed = "move";
      ev.dataTransfer.setData("text/plain", room);
    }

    function onDragOver(ev, modEl){
      ev.preventDefault();
      ev.dataTransfer.dropEffect = "move";

      // Show hint line before this module (hard, minimal)
      if(!dropHintEl){
        dropHintEl = document.createElement("div");
        dropHintEl.className = "dropHint";
      }
      const room = modEl.getAttribute("data-room");
      if(!room) return;

      // insert hint before hovered module if not already
      if(modEl.previousSibling !== dropHintEl){
        if(dropHintEl.parentNode) dropHintEl.parentNode.removeChild(dropHintEl);
        modulesEl.insertBefore(dropHintEl, modEl);
      }
    }

    function onDrop(ev, targetRoom){
      ev.preventDefault();
      const src = ev.dataTransfer.getData("text/plain") || dragRoom;
      if(!src || !targetRoom || src === targetRoom) return;

      const srcIdx = data.findIndex(d => d.room === src);
      const tgtIdx = data.findIndex(d => d.room === targetRoom);
      if(srcIdx < 0 || tgtIdx < 0) return;

      const [moved] = data.splice(srcIdx, 1);
      data.splice(tgtIdx, 0, moved);

      saveOrder();
      onDragEnd();
      render();
    }

    function onDragEnd(){
      dragRoom = null;
      document.querySelectorAll(".module.dragging").forEach(el => el.classList.remove("dragging"));
      if(dropHintEl && dropHintEl.parentNode) dropHintEl.parentNode.removeChild(dropHintEl);
      dropHintEl = null;
    }

    resetOrderBtn.addEventListener("click", () => {
      localStorage.removeItem(K.ORDER);
      data = structuredClone(DEFAULT_DATA);
      render();
    });

    /**********************
     * PROMPT EXPORTER
     **********************/
    function buildExport(){
      const mode = exportModeEl.value;
      const global = (localStorage.getItem(K.GLOBAL_NOTES) || "").trim();

      const scope = (mode === "filtered")
        ? data.filter(applyFilter)
        : data;

      const blocks = [];

      blocks.push("KETADATA DIRECTORY EXPORT");
      blocks.push("================================");
      blocks.push("");

      if(global){
        blocks.push("[GLOBAL NOTES]");
        blocks.push(global);
        blocks.push("");
      }else{
        blocks.push("[GLOBAL NOTES]");
        blocks.push("(NONE)");
        blocks.push("");
      }

      for(const s of scope){
        const note = (getRoomNote(s.room) || "").trim();
        const links = s.links;

        blocks.push(`[ROOM] ${s.room}`);
        if(mode !== "linksOnly"){
          blocks.push("[NOTE]");
          blocks.push(note ? note : "(NONE)");
        }
        if(mode !== "notesOnly"){
          blocks.push("[LINKS]");
          blocks.push(links.length ? links.map(u => `- ${u}`).join("\n") : "(NONE)");
        }
        blocks.push("");
      }

      // Add a concise “prompt wrapper” at bottom so it’s usable immediately
      blocks.push("PROMPT WRAPPER (PASTE ABOVE INTO A MODEL)");
      blocks.push("----------------------------------------");
      blocks.push("You are operating within the KETADATA site. Use the room order as a navigation hierarchy.");
      blocks.push("1) Respect GLOBAL NOTES as the highest-order constraints.");
      blocks.push("2) Treat each ROOM NOTE as local constraints for that room’s pages.");
      blocks.push("3) When referencing pages, cite their URLs exactly.");
      blocks.push("");

      exportOut.textContent = blocks.join("\n");
    }

    async function copyExport(){
      const text = exportOut.textContent || "";
      try{
        await navigator.clipboard.writeText(text);
      }catch(e){
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
      }
    }

    function downloadExport(){
      const text = exportOut.textContent || "";
      const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "ketadata_directory_export.txt";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    buildBtn.addEventListener("click", buildExport);
    copyBtn.addEventListener("click", copyExport);
    downloadBtn.addEventListener("click", downloadExport);

    /**********************
     * INIT
     **********************/
    loadOrder();
    loadExpanded();
    loadGlobalNotes();

    // Default behavior: collapse everything unless user already has expanded state
    if(expandedSet.size === 0){
      // Keep it strict: default collapsed uniform
      // (do nothing)
    }

    render();
  </script>
</body>
</html>
