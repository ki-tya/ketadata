<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KETADATA // COMPARISON NOTES</title>
  <style>
    :root{
      --bg:#000;
      --fg:#fff;
      --stroke:rgba(255,255,255,0.18);
      --stroke2:rgba(255,255,255,0.12);
      --glass:rgba(255,255,255,0.06);
      --panel:rgba(0,0,0,0.92);
      --muted:rgba(255,255,255,0.62);
      --muted2:rgba(255,255,255,0.40);
      --shadow:rgba(0,0,0,0.78);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:Arial, Helvetica, sans-serif;}
    body{overflow:hidden;}
    button,input,select,textarea{font-family:inherit}

    /* Topbar */
    #topbar{
      position:fixed; inset:0 0 auto 0;
      height:48px;
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid var(--stroke2);
      background:#000;
      user-select:none;
      z-index:20;
    }
    #brand{
      display:flex; align-items:center; gap:10px;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.80);
      min-width:240px;
    }
    .whiteBox{width:10px;height:10px;background:#fff;display:inline-block;}
    #topActions{display:flex;align-items:center;gap:8px;}

    .btn{
      border:1px solid var(--stroke);
      background:transparent;
      color:rgba(255,255,255,0.86);
      padding:7px 10px;
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      cursor:pointer;
    }
    .btn:hover{background:var(--glass);border-color:rgba(255,255,255,0.34);}
    .btnPrimary{background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.30);}
    .btnPrimary:hover{background:rgba(255,255,255,0.09);border-color:rgba(255,255,255,0.44);}

    /* Required: white note icon upper right */
    #noteIcon{
      width:28px;height:28px;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,0.20);
      background:rgba(255,255,255,0.10);
      cursor:pointer;
    }
    #noteIcon:hover{border-color:rgba(255,255,255,0.36);background:rgba(255,255,255,0.14);}

    /* Main */
    #main{
      position:fixed; inset:48px 0 0 0;
      display:grid;
      grid-template-columns: 360px 1fr;
      min-height:0;
    }

    /* Left */
    #left{
      border-right:1px solid var(--stroke2);
      background:rgba(0,0,0,0.90);
      display:flex; flex-direction:column;
      min-height:0;
    }
    #leftHeader{
      padding:12px;
      border-bottom:1px solid var(--stroke2);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      user-select:none;
    }
    #leftHeader .title{
      margin:0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.78);
      display:flex;align-items:center;gap:10px;
    }
    #leftBody{
      padding:12px;
      overflow:auto;
      min-height:0;
    }

    .field{display:grid;gap:6px;margin-bottom:12px;}
    label{
      font-size:11px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.60);
    }
    input[type="text"], textarea, select{
      width:100%;
      border:1px solid rgba(255,255,255,0.16);
      background:rgba(255,255,255,0.04);
      color:rgba(255,255,255,0.90);
      padding:9px 10px;
      font-size:12px;
      outline:none;
    }
    textarea{min-height:76px;resize:vertical;}
    input[type="text"]:focus, textarea:focus, select:focus{
      border-color:rgba(255,255,255,0.36);
      background:rgba(255,255,255,0.06);
    }
    .hint{
      font-size:11px;
      line-height:1.35;
      color:rgba(255,255,255,0.48);
      letter-spacing:0.04em;
    }

    /* Comparison list */
    #compList{display:grid;gap:8px;margin-top:6px;}
    .comp{
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.03);
      padding:10px;
      cursor:pointer;
      display:grid;
      gap:6px;
    }
    .comp:hover{background:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.22);}
    .comp.active{background:rgba(255,255,255,0.07);border-color:rgba(255,255,255,0.32);}
    .rowTop{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .name{
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.86);
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .pill{
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.55);
      border:1px solid rgba(255,255,255,0.14);
      padding:3px 6px;
      background:rgba(0,0,0,0.40);
      white-space:nowrap;
    }

    /* Right: board */
    #right{
      position:relative;
      min-height:0;
      overflow:hidden;
      background:#000;
      display:flex;
      flex-direction:column;
    }

    #boardHeader{
      padding:12px 14px;
      border-bottom:1px solid var(--stroke2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    #boardHeader .title{
      margin:0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.78);
      display:flex;align-items:center;gap:10px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* Command/Control toggle: shows/hides criteria panel */
    #ccBtn{
      width:28px;height:28px;
      border:1px solid rgba(255,255,255,0.24);
      background:rgba(0,0,0,0.45);
      cursor:pointer;
      display:grid;place-items:center;
      padding:0;
    }
    #ccBtn:hover{background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.38);}
    #ccGlyph{width:10px;height:10px;border:1px solid rgba(255,255,255,0.55);opacity:0.85;}

    #board{
      flex:1;
      min-height:0;
      overflow:auto;
      padding:14px;
      display:grid;
      gap:12px;
    }

    /* Criteria panel (collapsible via CC) */
    #criteriaPanel{
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.03);
      padding:12px;
      display:block;
    }
    #criteriaPanel.hidden{display:none;}
    #criteriaGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .chipRow{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;}
    .chip{
      border:1px solid rgba(255,255,255,0.16);
      background:transparent;
      color:rgba(255,255,255,0.78);
      padding:7px 10px;
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      cursor:pointer;
    }
    .chip:hover{background:var(--glass);border-color:rgba(255,255,255,0.34);}
    .chip.on{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.40);}

    /* Comparison columns */
    #cols{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      min-height:0;
    }
    .col{
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.03);
      padding:12px;
      min-height:260px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .colTitle{
      margin:0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.78);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      user-select:none;
    }
    .colTitle .count{
      font-size:10px;
      letter-spacing:0.16em;
      color:rgba(255,255,255,0.50);
      border:1px solid rgba(255,255,255,0.12);
      padding:3px 6px;
      background:rgba(0,0,0,0.35);
      white-space:nowrap;
    }

    /* bullets */
    .list{display:grid;gap:8px;}
    .bullet{
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(0,0,0,0.35);
      padding:10px;
      display:grid;
      gap:6px;
    }
    .bTop{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .bText{
      font-size:12px;
      line-height:1.35;
      color:rgba(255,255,255,0.86);
      letter-spacing:0.02em;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .bMeta{
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.46);
      display:flex;flex-wrap:wrap;gap:8px;
    }
    .tag{
      border:1px solid rgba(255,255,255,0.14);
      padding:3px 6px;
      background:rgba(0,0,0,0.35);
      color:rgba(255,255,255,0.55);
    }
    .del{
      border:1px solid rgba(255,255,255,0.18);
      background:transparent;
      color:rgba(255,255,255,0.70);
      padding:5px 8px;
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
    }
    .del:hover{background:var(--glass);border-color:rgba(255,255,255,0.34);}

    /* Quick capture: single input + enter routes to selected column */
    #capture{
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.03);
      padding:12px;
      display:grid;
      gap:10px;
    }
    #captureRow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:start;
    }
    #line{
      width:100%;
      border:1px solid rgba(255,255,255,0.16);
      background:rgba(255,255,255,0.04);
      color:rgba(255,255,255,0.90);
      padding:10px 10px;
      font-size:12px;
      outline:none;
    }
    #line:focus{
      border-color:rgba(255,255,255,0.36);
      background:rgba(255,255,255,0.06);
    }
    #addBtn{white-space:nowrap;}

    #routeRow{
      display:flex; flex-wrap:wrap; gap:8px;
      align-items:center;
      user-select:none;
    }
    .route{
      border:1px solid rgba(255,255,255,0.16);
      background:transparent;
      color:rgba(255,255,255,0.74);
      padding:7px 10px;
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      cursor:pointer;
    }
    .route:hover{background:var(--glass);border-color:rgba(255,255,255,0.34);}
    .route.on{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.40);color:rgba(255,255,255,0.86);}

    /* Subtle glossary strip */
    #glossaryStrip{
      font-size:10px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.40);
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      user-select:none;
      border-top:1px solid rgba(255,255,255,0.10);
      padding-top:10px;
      margin-top:10px;
    }

    /* Global modal from note icon */
    #modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.72);
      display:none;
      z-index:50;
    }
    #modal{
      position:absolute; right:16px; top:58px;
      width:min(520px, calc(100% - 32px));
      border:1px solid rgba(255,255,255,0.22);
      background:rgba(0,0,0,0.92);
      box-shadow:0 28px 110px rgba(0,0,0,0.82);
      padding:12px;
    }
    #modalTitle{
      margin:0 0 10px 0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.82);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      user-select:none;
    }

    /* Toast */
    #toast{
      position:fixed;
      left:50%;
      top:68px;
      transform:translateX(-50%);
      padding:8px 10px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.72);
      color:rgba(255,255,255,0.65);
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      display:none;
      z-index:80;
    }
  </style>
</head>

<body>
  <!-- TOPBAR -->
  <div id="topbar">
    <div id="brand">
      <span class="whiteBox" aria-hidden="true"></span>
      <span>KETADATA // COMPARISON NOTES</span>
    </div>

    <div id="topActions">
      <!-- REQUIRED white note icon upper right -->
      <button id="noteIcon" type="button" aria-label="Global Note">
        <span class="whiteBox" aria-hidden="true"></span>
      </button>
      <button id="exportState" class="btn btnPrimary" type="button">Export State</button>
      <button id="copyPrompt" class="btn" type="button">Copy Prompt</button>
    </div>
  </div>

  <div id="main">
    <!-- LEFT: manage comparisons + interfaces under comparison -->
    <div id="left">
      <div id="leftHeader">
        <p class="title"><span class="whiteBox" aria-hidden="true"></span> Comparisons</p>
        <button id="newComp" class="btn btnPrimary" type="button">New</button>
      </div>

      <div id="leftBody">
        <div class="field">
          <label for="project">Project</label>
          <input id="project" type="text" value="KETADATA" />
        </div>

        <div class="field">
          <label for="room">Room Context</label>
          <select id="room">
            <option>ENTRY</option><option>LOBBY</option><option>TEMPLE</option>
            <option selected>STUDIO</option><option>LAB</option><option>VAULT</option>
            <option>BASEMENT</option><option>WHITE ROOM</option>
          </select>
        </div>

        <div class="field">
          <label for="compName">Comparison Name</label>
          <input id="compName" type="text" placeholder="e.g. photobooth v2 vs v3" />
          <div class="hint">Each comparison holds multiple interfaces + pros/cons/decisions.</div>
        </div>

        <div class="field">
          <label for="interfaces">Interfaces (comma separated)</label>
          <input id="interfaces" type="text" placeholder="v2-crunch, v3-clean, v3-node-min" />
          <div class="hint">Names only. Use notes to specify what each is.</div>
        </div>

        <div class="field">
          <label>Saved Comparisons</label>
          <div id="compList"></div>
        </div>

        <div class="hint">
          KETADATA principles applied: black-only, minimal controls, collapse-as-primitive, notes exportable, white-square note affordances.
        </div>
      </div>
    </div>

    <!-- RIGHT: pros/cons/decision board -->
    <div id="right">
      <div id="boardHeader">
        <p class="title"><span class="whiteBox" aria-hidden="true"></span> BOARD <span id="boardName" style="color:rgba(255,255,255,0.40);margin-left:6px;"></span></p>
        <button id="ccBtn" type="button" aria-label="Command/Control"><span id="ccGlyph" aria-hidden="true"></span></button>
      </div>

      <div id="board">
        <!-- Criteria panel -->
        <div id="criteriaPanel">
          <div class="field" style="margin-bottom:10px;">
            <label>Criteria (toggle chips)</label>
            <div class="chipRow" id="criteriaChips"></div>
            <div class="hint">This is your evaluation spine. Chips become tags on bullets.</div>
          </div>

          <div id="criteriaGrid">
            <div class="field">
              <label for="glossaryTag">Glossary Tag</label>
              <select id="glossaryTag">
                <option value="">—</option>
                <option>ROOM</option><option>INTERFACE</option><option>MODULE</option><option>CONTROL</option>
                <option>NOTE</option><option>STATE</option><option>PROMPT</option><option>COLLAPSE</option>
                <option>MODE</option><option>ACCESS</option><option>TRANSITION</option><option>LIGHT</option>
              </select>
            </div>
            <div class="field">
              <label for="targetIface">Target Interface</label>
              <select id="targetIface"></select>
              <div class="hint">Route each bullet to a specific interface or “ALL”.</div>
            </div>
          </div>
        </div>

        <!-- Quick capture -->
        <div id="capture">
          <div class="field" style="margin:0;">
            <label>Quick Capture</label>
            <div class="hint">Type one line. Select route. Hit Add (or Enter).</div>
          </div>

          <div id="routeRow">
            <button class="route on" data-route="PRO">PRO</button>
            <button class="route" data-route="CON">CON</button>
            <button class="route" data-route="DECISION">DECISION</button>
            <button class="route" data-route="QUESTION">QUESTION</button>
          </div>

          <div id="captureRow">
            <input id="line" type="text" placeholder="one-line bullet" />
            <button id="addBtn" class="btn btnPrimary" type="button">Add</button>
          </div>

          <div class="hint">
            Tags are auto-attached from selected criteria chips + glossary tag + target interface.
          </div>

          <div id="glossaryStrip" aria-hidden="true">
            <span>PRO=keep</span>
            <span>CON=cut</span>
            <span>DECISION=commit</span>
            <span>QUESTION=unknown</span>
            <span>STATE=snapshot</span>
            <span>PROMPT=intent</span>
          </div>
        </div>

        <!-- Columns -->
        <div id="cols">
          <div class="col">
            <p class="colTitle">PROS <span class="count" id="proCount">0</span></p>
            <div class="list" id="proList"></div>
          </div>

          <div class="col">
            <p class="colTitle">CONS <span class="count" id="conCount">0</span></p>
            <div class="list" id="conList"></div>
          </div>

          <div class="col">
            <p class="colTitle">DECISIONS <span class="count" id="decCount">0</span></p>
            <div class="list" id="decList"></div>
          </div>
        </div>

        <!-- Questions (full-width) -->
        <div class="col" style="min-height:0;">
          <p class="colTitle">QUESTIONS <span class="count" id="qCount">0</span></p>
          <div class="list" id="qList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- GLOBAL NOTE MODAL -->
  <div id="modalBack" aria-hidden="true">
    <div id="modal" role="dialog" aria-label="Global Note">
      <div id="modalTitle">
        <span><span class="whiteBox" style="width:9px;height:9px;"></span> GLOBAL NOTE</span>
        <button id="closeModal" class="btn" type="button">Close</button>
      </div>
      <div class="field">
        <label for="globalNote">Text</label>
        <textarea id="globalNote" placeholder="system laws / constraints / reminders"></textarea>
        <div class="hint">Saved into state. Applies to this whole comparison workspace.</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button id="saveGlobal" class="btn btnPrimary" type="button">Save</button>
        <button id="clearGlobal" class="btn" type="button">Clear</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    // =========================
    // KETADATA Comparison Notes
    // - multiple interfaces per comparison
    // - pros / cons / decisions / questions
    // - criteria chips + glossary tagging
    // - exportable state + prompt
    // - black-only, minimal, collapsible via CC
    // =========================

    const el = (id)=>document.getElementById(id);
    const uid = ()=>Math.random().toString(36).slice(2, 9)+"-"+Date.now().toString(36);
    const projectEl = el('project');
    const roomEl = el('room');

    const compNameEl = el('compName');
    const interfacesEl = el('interfaces');
    const compListEl = el('compList');

    const boardNameEl = el('boardName');

    const criteriaPanel = el('criteriaPanel');
    const ccBtn = el('ccBtn');

    const criteriaChipsEl = el('criteriaChips');
    const glossaryTagEl = el('glossaryTag');
    const targetIfaceEl = el('targetIface');

    const routeBtns = [...document.querySelectorAll('.route')];
    const lineEl = el('line');
    const addBtn = el('addBtn');

    const proList = el('proList');
    const conList = el('conList');
    const decList = el('decList');
    const qList = el('qList');

    const proCount = el('proCount');
    const conCount = el('conCount');
    const decCount = el('decCount');
    const qCount = el('qCount');

    const noteIcon = el('noteIcon');
    const modalBack = el('modalBack');
    const closeModal = el('closeModal');
    const globalNote = el('globalNote');
    const saveGlobal = el('saveGlobal');
    const clearGlobal = el('clearGlobal');

    const exportStateBtn = el('exportState');
    const copyPromptBtn = el('copyPrompt');
    const toastEl = el('toast');

    function toast(msg, ms=650){
      toastEl.textContent = msg;
      toastEl.style.display = 'block';
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>{ toastEl.style.display='none'; }, ms);
    }
    async function copyText(s){
      try{ await navigator.clipboard.writeText(s); toast("COPIED"); }
      catch{ window.prompt("Copy:", s); }
    }
    function encode(obj){ return btoa(unescape(encodeURIComponent(JSON.stringify(obj)))); }
    function decode(b64){ return JSON.parse(decodeURIComponent(escape(atob(b64)))); }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (m)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    // ---- Criteria defaults (KETADATA flavored) ----
    const DEFAULT_CRITERIA = [
      "CLEANNESS",
      "DENSITY",
      "CONTROL HYGIENE",
      "COLLAPSE",
      "HOTKEY SUBTLETY",
      "NOTES PRIMITIVE",
      "STATE EXPORT",
      "PROMPT EXPORT",
      "VI/DI CLARITY",
      "SPACE FEEL",
      "NO KITSCH"
    ];

    // ---- State model ----
    // comparisons: [
    //  {id, name, interfaces:[...], criteria:[...], globalNote, bullets:[{id, kind, text, criteriaTags[], glossaryTag, target, ts}]}
    // ]
    let state = {
      v: 1,
      project: "KETADATA",
      room: "STUDIO",
      comparisons: [],
      activeCompId: null
    };

    function makeComparison(){
      return {
        id: uid(),
        name: "NEW COMPARISON",
        interfaces: ["ALL"],
        criteria: [...DEFAULT_CRITERIA],
        globalNote: "",
        bullets: []
      };
    }

    // load from hash if present
    (function(){
      const m = location.hash.match(/state=([^&]+)/);
      if(!m){
        const c = makeComparison();
        state.comparisons = [c];
        state.activeCompId = c.id;
        return;
      }
      try{
        const s = decode(m[1]);
        if(s && s.v === 1){
          state = s;
          if(!state.comparisons?.length){
            const c = makeComparison();
            state.comparisons = [c];
            state.activeCompId = c.id;
          }
          state.activeCompId = state.activeCompId || state.comparisons[0].id;
        } else {
          const c = makeComparison();
          state.comparisons = [c];
          state.activeCompId = c.id;
        }
      }catch{
        const c = makeComparison();
        state.comparisons = [c];
        state.activeCompId = c.id;
      }
    })();

    function activeComp(){
      return state.comparisons.find(c=>c.id===state.activeCompId) || state.comparisons[0];
    }

    // ---- UI ----
    function renderLeft(){
      projectEl.value = state.project || "KETADATA";
      roomEl.value = state.room || "STUDIO";

      const c = activeComp();
      compNameEl.value = c.name || "";
      interfacesEl.value = (c.interfaces || ["ALL"]).filter(Boolean).join(", ");

      // list
      compListEl.innerHTML = "";
      state.comparisons.forEach(x=>{
        const d = document.createElement('div');
        d.className = "comp" + (x.id===state.activeCompId ? " active" : "");
        d.innerHTML = `
          <div class="rowTop">
            <div class="name">${escapeHtml(x.name || "UNNAMED")}</div>
            <div class="pill">${(x.interfaces?.length||0)} IFACES</div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <span class="pill">${(x.bullets?.length||0)} NOTES</span>
            <span class="pill">${(x.criteria?.length||0)} CRITERIA</span>
          </div>
        `;
        d.addEventListener('click', ()=>{
          state.activeCompId = x.id;
          renderAll();
        });
        compListEl.appendChild(d);
      });
    }

    function renderCriteria(){
      const c = activeComp();
      criteriaChipsEl.innerHTML = "";
      c._criteriaOn = c._criteriaOn || new Set(); // UI-only set

      c.criteria.forEach(label=>{
        const b = document.createElement('button');
        b.className = "chip" + (c._criteriaOn.has(label) ? " on" : "");
        b.type = "button";
        b.textContent = label;
        b.addEventListener('click', ()=>{
          if(c._criteriaOn.has(label)) c._criteriaOn.delete(label);
          else c._criteriaOn.add(label);
          renderCriteria();
        });
        criteriaChipsEl.appendChild(b);
      });
    }

    function renderTargetInterfaces(){
      const c = activeComp();
      const ifaces = (c.interfaces && c.interfaces.length) ? c.interfaces : ["ALL"];
      const cleaned = ["ALL", ...ifaces.filter(x=>String(x).trim().toUpperCase()!=="ALL").map(x=>String(x).trim()).filter(Boolean)];
      const uniq = [...new Set(cleaned)];
      targetIfaceEl.innerHTML = "";
      uniq.forEach(x=>{
        const o = document.createElement('option');
        o.textContent = x;
        o.value = x;
        targetIfaceEl.appendChild(o);
      });
    }

    function renderBoard(){
      const c = activeComp();
      boardNameEl.textContent = c.name ? ("// " + c.name) : "";

      globalNote.value = c.globalNote || "";

      // counts & lists
      const pros = c.bullets.filter(b=>b.kind==="PRO");
      const cons = c.bullets.filter(b=>b.kind==="CON");
      const decs = c.bullets.filter(b=>b.kind==="DECISION");
      const qs   = c.bullets.filter(b=>b.kind==="QUESTION");

      proCount.textContent = String(pros.length);
      conCount.textContent = String(cons.length);
      decCount.textContent = String(decs.length);
      qCount.textContent = String(qs.length);

      renderList(proList, pros, c);
      renderList(conList, cons, c);
      renderList(decList, decs, c);
      renderList(qList, qs, c);
    }

    function renderList(container, items, comp){
      container.innerHTML = "";
      items.slice().reverse().forEach(b=>{
        const div = document.createElement('div');
        div.className = "bullet";
        div.innerHTML = `
          <div class="bTop">
            <div class="bMeta">
              ${b.target ? `<span class="tag">${escapeHtml(b.target)}</span>` : ""}
              ${b.glossaryTag ? `<span class="tag">${escapeHtml(b.glossaryTag)}</span>` : ""}
              ${(b.criteriaTags||[]).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join("")}
            </div>
            <button class="del" type="button">DEL</button>
          </div>
          <div class="bText">${escapeHtml(b.text || "")}</div>
        `;
        div.querySelector('.del').addEventListener('click', ()=>{
          comp.bullets = comp.bullets.filter(x=>x.id!==b.id);
          renderBoard();
          toast("DELETED");
        });
        container.appendChild(div);
      });
    }

    function renderAll(){
      renderLeft();
      renderCriteria();
      renderTargetInterfaces();
      renderBoard();
    }

    // ---- events ----
    projectEl.addEventListener('input', ()=>{ state.project = projectEl.value; });
    roomEl.addEventListener('change', ()=>{ state.room = roomEl.value; });

    compNameEl.addEventListener('input', ()=>{
      const c = activeComp();
      c.name = compNameEl.value;
      renderLeft();
      renderBoard();
    });

    interfacesEl.addEventListener('input', ()=>{
      const c = activeComp();
      const parts = interfacesEl.value.split(",").map(s=>s.trim()).filter(Boolean);
      c.interfaces = parts.length ? parts : ["ALL"];
      renderLeft();
      renderTargetInterfaces();
    });

    el('newComp').addEventListener('click', ()=>{
      const c = makeComparison();
      state.comparisons.unshift(c);
      state.activeCompId = c.id;
      renderAll();
      toast("NEW");
    });

    // route selection
    let route = "PRO";
    routeBtns.forEach(b=>{
      b.addEventListener('click', ()=>{
        route = b.dataset.route;
        routeBtns.forEach(x=>x.classList.toggle('on', x.dataset.route===route));
      });
    });

    function addBullet(){
      const text = lineEl.value.trim();
      if(!text){ toast("EMPTY"); return; }
      const c = activeComp();
      const criteriaTags = c._criteriaOn ? [...c._criteriaOn] : [];
      const glossary = glossaryTagEl.value || "";
      const target = targetIfaceEl.value || "ALL";

      c.bullets.push({
        id: uid(),
        kind: route,
        text,
        criteriaTags,
        glossaryTag: glossary,
        target,
        ts: Date.now()
      });

      lineEl.value = "";
      renderBoard();
      renderLeft();
      toast("ADDED");
      lineEl.focus();
    }

    addBtn.addEventListener('click', addBullet);
    lineEl.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        addBullet();
      }
    });

    // CC toggles criteria panel (collapse primitive)
    ccBtn.addEventListener('click', ()=>{
      criteriaPanel.classList.toggle('hidden');
      toast(criteriaPanel.classList.contains('hidden') ? "COLLAPSE" : "OPEN");
    });

    // global note modal (per comparison)
    function showModal(){
      modalBack.style.display = 'block';
      modalBack.setAttribute('aria-hidden','false');
      globalNote.value = activeComp().globalNote || "";
      setTimeout(()=>globalNote.focus(), 0);
    }
    function hideModal(){
      modalBack.style.display = 'none';
      modalBack.setAttribute('aria-hidden','true');
    }
    noteIcon.addEventListener('click', showModal);
    closeModal.addEventListener('click', hideModal);
    modalBack.addEventListener('click', (e)=>{ if(e.target===modalBack) hideModal(); });

    saveGlobal.addEventListener('click', ()=>{
      const c = activeComp();
      c.globalNote = globalNote.value;
      toast("SAVED");
      hideModal();
    });
    clearGlobal.addEventListener('click', ()=>{
      const c = activeComp();
      c.globalNote = "";
      globalNote.value = "";
      toast("CLEARED");
    });

    // exports
    function exportState(){
      const safe = JSON.parse(JSON.stringify(state, (k,v)=>{
        // remove UI-only criteria set if present
        if(k === "_criteriaOn") return undefined;
        return v;
      }));
      const b64 = encode(safe);
      const url = location.origin + location.pathname + "#state=" + b64;
      return { safe, url };
    }

    function buildPrompt(){
      const c = activeComp();
      const pack = {
        system: "KETADATA",
        tool: "Comparison Notes",
        project: state.project,
        room: state.room,
        comparison: {
          name: c.name,
          interfaces: c.interfaces,
          criteria: c.criteria,
          globalNote: c.globalNote || ""
        },
        bullets: c.bullets
      };

      return [
        "KETADATA COMPARISON PROMPT",
        `PROJECT: ${pack.project}`,
        `ROOM CONTEXT: ${pack.room}`,
        `COMPARISON: ${pack.comparison.name}`,
        `INTERFACES: ${(pack.comparison.interfaces||[]).join(", ")}`,
        `CRITERIA: ${(pack.comparison.criteria||[]).join(" | ")}`,
        pack.comparison.globalNote ? `GLOBAL NOTE: ${pack.comparison.globalNote}` : "GLOBAL NOTE: (none)",
        "TASK: Choose a direction and produce a tight implementation plan. Decisions must obey KETADATA standards: black-only, no gradients, minimal controls, collapse as primitive, subtle hotkeys, white-square notes, exportable state/prompt.",
        "BULLETS (JSON):",
        JSON.stringify(pack.bullets, null, 2)
      ].join("\n");
    }

    exportStateBtn.addEventListener('click', async ()=>{
      const { url } = exportState();
      await copyText(url);
      location.hash = url.split("#")[1];
    });

    copyPromptBtn.addEventListener('click', async ()=>{
      await copyText(buildPrompt());
    });

    // init
    renderAll();
  </script>
</body>
</html>
