<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>KETADATA_SHELL_KERNEL_v1.1 — SERIAL 0001</title>

  <style>
    /* =========================================================
       AE-00 :: GLOBAL AESTHETIC (BLACK CORE / SHARP / INDUSTRIAL)
       ========================================================= */
    :root{
      --bg:#000;
      --fg:#fff;
      --muted:rgba(255,255,255,.72);
      --dim:rgba(255,255,255,.22);
      --hair:rgba(255,255,255,.12);
      --hair2:rgba(255,255,255,.08);
      --panel:#050505;
      --panel2:#070707;
      --focus:rgba(255,255,255,.18);
      --danger:rgba(255,80,80,.75);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --topH: 44px;
      --bottomH: 140px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font-family:var(--mono);
      overflow:hidden;
    }
    .invertAll{ filter: invert(1) hue-rotate(180deg); }

    /* Top bar */
    .topbar{
      position:fixed; inset:0 0 auto 0;
      height:var(--topH);
      display:flex; align-items:center; gap:10px;
      padding:0 10px;
      border-bottom:1px solid var(--hair);
      background:linear-gradient(to bottom, rgba(255,255,255,.03), rgba(255,255,255,.01));
      z-index:50;
      user-select:none;
    }
    .brand{
      display:flex; align-items:baseline; gap:10px;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-weight:700;
      font-family:var(--sans);
      font-size:13px;
    }
    .brand .sub{
      font-weight:500;
      opacity:.65;
      letter-spacing:.14em;
      font-size:11px;
    }
    .spacer{ flex:1; }
    .btn{
      height:28px; padding:0 10px;
      border:1px solid var(--hair);
      background:transparent;
      color:var(--fg);
      font-family:var(--mono);
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      cursor:pointer;
    }
    .btn:hover{ border-color:var(--focus); background:rgba(255,255,255,.03); }
    .btn:active{ transform:translateY(1px); }
    .btn.danger{ border-color:rgba(255,80,80,.35); }
    .btn.danger:hover{ border-color:var(--danger); background:rgba(255,80,80,.06); }
    .pill{
      height:28px;
      display:flex; align-items:center;
      padding:0 10px;
      border:1px solid var(--hair);
      background:rgba(255,255,255,.02);
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.9;
    }
    .kbd{
      border:1px solid var(--hair);
      padding:1px 6px;
      font-size:10px;
      opacity:.85;
      margin-left:6px;
    }
    #ketaIcon{
      width:14px; height:14px;
      border:1px solid var(--fg);
      background:var(--fg); /* filled when collapsed */
      cursor:pointer;
      display:inline-block;
      margin-right:6px;
    }
    #ketaIcon.open{
      background:transparent; /* hollow when open */
    }

    /* Workspace */
    .workspace{
      position:fixed;
      inset:var(--topH) 0 var(--bottomH) 0;
      display:flex;
      background:radial-gradient(1200px 600px at 50% 30%, rgba(255,255,255,.03), transparent 55%);
    }
    .stage{
      flex:1;
      position:relative;
      overflow:hidden;
      border-left:1px solid var(--hair2);
      border-right:1px solid var(--hair2);
    }
    .hudNote{
      position:absolute; left:16px; top:16px;
      font-size:11px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color:var(--muted);
      opacity:.9;
      user-select:none;
      pointer-events:none;
    }
    .hint{
      position:absolute; left:16px; top:36px;
      font-size:11px;
      color:var(--dim);
      letter-spacing:.04em;
      user-select:none;
      pointer-events:none;
    }

    /* Bottom universals panel */
    .bottom{
      position:fixed; inset:auto 0 0 0;
      height:var(--bottomH);
      border-top:1px solid var(--hair);
      background:linear-gradient(to top, rgba(255,255,255,.02), rgba(255,255,255,.01));
      z-index:40;
      display:flex;
      flex-direction:column;
    }
    .bottomHead{
      height:34px;
      display:flex; align-items:center; gap:10px;
      padding:0 10px;
      border-bottom:1px solid var(--hair2);
      user-select:none;
    }
    .bottomHead .title{
      font-family:var(--sans);
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      opacity:.85;
    }
    .bottomBody{
      flex:1;
      padding:8px 10px;
    }
    textarea{
      width:100%;
      height:100%;
      resize:none;
      background:rgba(0,0,0,.45);
      color:var(--fg);
      border:1px solid var(--hair2);
      outline:none;
      padding:10px;
      font-family:var(--mono);
      font-size:12px;
      line-height:1.35;
    }
    textarea:focus{ border-color:var(--focus); }

    /* =========================================================
       AE-01 :: FLOATING WINDOWS (NOTE + KDTV) — THIN / CLEAN
       ========================================================= */
    .win{
      position:absolute;
      background:rgba(0,0,0,.72);
      border:1px solid rgba(255,255,255,.16);
      box-shadow:0 0 0 1px rgba(255,255,255,.05) inset;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      overflow:hidden;
      z-index:60;
      min-width:240px;
      min-height:160px;
    }
    .winHeader{
      height:28px;
      display:flex; align-items:center; gap:8px;
      padding:0 8px;
      border-bottom:1px solid rgba(255,255,255,.10);
      cursor:grab;
      user-select:none;
    }
    .winHeader:active{ cursor:grabbing; }
    .winTitle{
      font-family:var(--sans);
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      opacity:.9;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .winHeader .right{ margin-left:auto; display:flex; gap:6px; align-items:center; }
    .winBtn{
      width:26px; height:20px;
      border:1px solid rgba(255,255,255,.14);
      background:transparent;
      color:var(--fg);
      font-family:var(--mono);
      font-size:12px;
      cursor:pointer;
      padding:0;
    }
    .winBtn:hover{ border-color:rgba(255,255,255,.24); background:rgba(255,255,255,.03); }
    .winBody{
      height:calc(100% - 28px);
      display:flex;
    }
    .winBody .pad{
      flex:1;
      padding:10px;
    }
    .resizeGrip{
      position:absolute; right:0; bottom:0;
      width:14px; height:14px;
      cursor:nwse-resize;
      background:
        linear-gradient(135deg, transparent 50%, rgba(255,255,255,.20) 50%),
        linear-gradient(135deg, transparent 70%, rgba(255,255,255,.12) 70%);
      opacity:.55;
    }
    .hidden{ display:none !important; }

    /* KETA_NOTE text */
    #ketaText{
      width:100%;
      height:100%;
      border:0;
      background:transparent;
      outline:none;
      color:var(--fg);
      font-family:var(--mono);
      font-size:12px;
      line-height:1.35;
      padding:0;
    }

    /* KDTV */
    .kdtvBody{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:10px;
    }
    .kdtvRow{
      display:flex; gap:8px; align-items:center;
    }
    .kdtvRow .mini{
      height:24px; padding:0 8px;
      border:1px solid rgba(255,255,255,.14);
      background:transparent;
      color:var(--fg);
      font-family:var(--mono);
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      cursor:pointer;
      white-space:nowrap;
    }
    .kdtvRow .mini:hover{ border-color:rgba(255,255,255,.24); background:rgba(255,255,255,.03); }
    .kdtvRow label{
      display:flex; gap:8px; align-items:center;
      font-size:11px; color:var(--muted);
      letter-spacing:.06em;
      text-transform:uppercase;
      user-select:none;
    }
    .kdtvRow input[type="checkbox"]{ width:14px; height:14px; }
    .kdtvViewport{
      flex:1;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.02);
      position:relative;
      overflow:hidden;
    }
    video{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:contain;
      background:#000;
      transform:translateZ(0);
      will-change:transform, filter;
    }
    .kdtvEmpty{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      color:var(--dim);
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      user-select:none;
      pointer-events:none;
    }

    /* Strobe overlay */
    #strobe{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:20;
      opacity:0;
      background:#000;
      mix-blend-mode:normal;
    }

    /* Toast */
    #toast{
      position:fixed;
      left:10px;
      top:calc(var(--topH) + 10px);
      font-size:11px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color:var(--fg);
      background:rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.14);
      padding:8px 10px;
      opacity:0;
      transform:translateY(-6px);
      transition:opacity .18s ease, transform .18s ease;
      z-index:80;
      pointer-events:none;
    }
    #toast.show{ opacity:1; transform:translateY(0); }

    /* Subtle “motion” layer */
    #motion{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:10;
      opacity:.22;
      background:
        radial-gradient(800px 500px at 25% 35%, rgba(255,255,255,.06), transparent 60%),
        radial-gradient(900px 520px at 75% 55%, rgba(255,255,255,.05), transparent 62%);
      transform:translate3d(0,0,0);
      filter:blur(0px);
      will-change:transform;
      display:none;
    }
    #motion.run{ display:block; animation: drift 8s linear infinite; }
    @keyframes drift{
      0%{ transform:translate3d(0,0,0) scale(1); }
      50%{ transform:translate3d(-12px,8px,0) scale(1.02); }
      100%{ transform:translate3d(0,0,0) scale(1); }
    }
  </style>
</head>

<body>
  <!-- AE-02 :: LIGHT/MOTION LAYERS -->
  <div id="motion"></div>
  <div id="strobe"></div>
  <div id="toast"></div>

  <!-- AE-03 :: TOP BAR -->
  <div class="topbar">
    <div class="brand">
      <span>KETADATA</span>
      <span class="sub">SHELL KERNEL V1.1 // SERIAL 0001</span>
    </div>

    <div class="pill" title="GLOBAL NOTE">
      <span id="ketaIcon" class="" aria-label="KETA NOTE ICON"></span>
      <span>KETA NOTE</span>
      <span class="kbd">N</span>
    </div>

    <button class="btn" id="btnStateLoad" title="LOAD STATE JSON">LOAD STATE</button>
    <button class="btn" id="btnStateExport" title="EXPORT STATE JSON">EXPORT STATE</button>
    <button class="btn" id="btnStateCopy" title="COPY STATE JSON">COPY STATE</button>

    <div class="pill" title="INVERT ALL COLORS (SHIFT+I)">
      INVERT <span class="kbd">SHIFT+I</span>
    </div>

    <div class="pill" title="STROBE PRESET 1–6">
      LIGHTS <span class="kbd">1–6</span>
    </div>

    <div class="pill" title="MOTION TOGGLE (SPACE)">
      MOTION <span class="kbd">SPACE</span>
    </div>

    <button class="btn" id="btnKDTV" title="OPEN KDTV SCREEN">KDTV</button>

    <div class="spacer"></div>

    <button class="btn danger" id="btnClear" title="CLEAR LOCAL STATE">CLEAR</button>

    <input id="fileState" type="file" accept="application/json" class="hidden" />
    <input id="fileVideo" type="file" accept="video/*" class="hidden" />
  </div>

  <!-- AE-04 :: WORKSPACE -->
  <div class="workspace" id="root">
    <div class="stage" id="stage">
      <div class="hudNote">KETADATA // CORE</div>
      <div class="hint">N: NOTE • SHIFT+I: INVERT • 1–6: LIGHTS • SPACE: MOTION • KDTV: VIDEO SCREEN</div>
    </div>
  </div>

  <!-- AE-05 :: UNIVERSALS (BOTTOM) -->
  <div class="bottom" id="bottom">
    <div class="bottomHead">
      <div class="title">SYSTEM WIDE RULES // REFERENCES // CONSTRAINTS</div>
      <div class="spacer"></div>
      <div class="pill" id="status">READY</div>
    </div>
    <div class="bottomBody">
      <textarea id="universals" spellcheck="false" placeholder="SYSTEM RULES:\n- KETA_NOTE + STATE ALWAYS\n- LOCAL-FIRST\n- SHARP GEOMETRY\n- SINGLE FILE HTML TOOL ATOM\n\nREFERENCES:\n- ..."></textarea>
    </div>
  </div>

  <!-- =========================================================
       AE-06 :: KETA NOTE WINDOW
       ========================================================= -->
  <div class="win hidden" id="ketaNote" style="right:10px; top:56px; width:360px; height:240px;">
    <div class="winHeader" id="ketaHead">
      <div class="winTitle">KETA_NOTE</div>
      <div class="right">
        <button class="winBtn" id="btnKetaMin" title="HIDE">-</button>
      </div>
    </div>
    <div class="winBody">
      <div class="pad">
        <textarea id="ketaText" spellcheck="false" placeholder="GLOBAL NOTE // decisions, deviations, next actions"></textarea>
      </div>
    </div>
    <div class="resizeGrip" data-grip="1"></div>
  </div>

  <!-- =========================================================
       AE-07 :: KDTV WINDOW (VIDEO — ALWAYS INVERTED BY DEFAULT)
       ========================================================= -->
  <div class="win hidden" id="kdtvWin" style="left:12px; top:56px; width:520px; height:320px;">
    <div class="winHeader" id="kdtvHead">
      <div class="winTitle">KDTV1</div>
      <div class="right">
        <button class="winBtn" id="btnKDTVMin" title="HIDE">-</button>
      </div>
    </div>

    <div class="winBody">
      <div class="kdtvBody">
        <div class="kdtvRow">
          <button class="mini" id="btnLoadVideo">LOAD VIDEO</button>
          <label title="VIDEOS LOAD INVERTED BY DEFAULT; TOGGLE OFF IF NEEDED">
            <input type="checkbox" id="chkVideoInvert" />
            VIDEO INVERT
          </label>
          <div class="spacer"></div>
          <button class="mini" id="btnKDTVGoto" title="NAVIGATE TO ketadata.com/kdtv1.html (OPTIONAL)">GO KDTV1</button>
        </div>

        <div class="kdtvViewport" id="kdtvViewport">
          <video id="kdtvVideo" playsinline controls preload="metadata"></video>
          <div class="kdtvEmpty" id="kdtvEmpty">NO VIDEO</div>
        </div>
      </div>
    </div>

    <div class="resizeGrip" data-grip="1"></div>
  </div>

  <script>
    /* =========================================================
       EE-00 :: ENGINE — STATE / SERIAL / STORAGE / UTIL
       ========================================================= */

    const FILE_SERIAL = "KETADATA_SHELL_KERNEL_v1.1__SERIAL_0001";
    const LS_KEY = FILE_SERIAL + "::STATE";

    const DEFAULT_STATE = {
      version: "KETADATA_SHELL_KERNEL_v1.1",
      serial: FILE_SERIAL,
      updatedAt: new Date().toISOString(),
      room: "LOBBY",
      roomUrl: "",
      ketaNote: "",
      universals: "",
      ui: {
        invert: false,
        lightPreset: 1,
        lightRunning: false,
        strobeEnabled: true,
        motionOn: false
      },
      payload: {
        serialRegistry: [FILE_SERIAL],
        // GLOBAL WINDOW GEOMETRY
        ketaWin: { x:null, y:null, w:360, h:240, open:false },
        kdtvWin: { x:12, y:56, w:520, h:320, open:false },
        // KDTV prefs
        kdtv: { videoInvert: true }
      }
    };

    let STATE = loadState();

    const $ = (id)=>document.getElementById(id);
    const clamp = (v,min,max)=>Math.min(max,Math.max(min,v));
    const nowISO = ()=>new Date().toISOString();

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>t.classList.remove("show"), 900);
    }

    function safeParseJSON(txt){
      try{ return JSON.parse(txt); } catch(e){ return null; }
    }

    function loadState(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return structuredClone(DEFAULT_STATE);
      const parsed = safeParseJSON(raw);
      if(!parsed) return structuredClone(DEFAULT_STATE);
      // Soft-merge to keep new defaults
      return deepMerge(structuredClone(DEFAULT_STATE), parsed);
    }

    function persist(){
      STATE.updatedAt = nowISO();
      localStorage.setItem(LS_KEY, JSON.stringify(STATE, null, 2));
      $("status").textContent = "SAVED";
      clearTimeout(persist._t);
      persist._t = setTimeout(()=>$("status").textContent="READY", 450);
    }

    function deepMerge(base, patch){
      if(patch === null || patch === undefined) return base;
      if(typeof base !== "object" || typeof patch !== "object") return patch;
      if(Array.isArray(base) || Array.isArray(patch)) return patch;
      for(const k of Object.keys(patch)){
        base[k] = deepMerge(base[k], patch[k]);
      }
      return base;
    }

    function download(filename, content){
      const blob = new Blob([content], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    }

    async function copyText(txt){
      try{ await navigator.clipboard.writeText(txt); toast("COPIED"); }
      catch(e){
        // fallback
        const ta = document.createElement("textarea");
        ta.value = txt; document.body.appendChild(ta);
        ta.select(); document.execCommand("copy");
        ta.remove(); toast("COPIED");
      }
    }

    /* =========================================================
       WB-00 :: WIRING BRIDGE — INPUT SAFETY (HOTKEYS DON'T FIGHT TYPING)
       ========================================================= */

    function isTypingContext(e){
      const el = e.target;
      if(!el) return false;
      const tag = (el.tagName||"").toLowerCase();
      return tag === "textarea" || tag === "input" || el.isContentEditable;
    }

    /* =========================================================
       EE-01 :: ENGINE — LIGHTS (1–6) + STROBE
       ========================================================= */

    const LIGHTS = {
      1: { mode:"solid", bg:"#000" },
      2: { mode:"solid", bg:"#0a0a0a" },
      3: { mode:"solid", bg:"#050505" },
      4: { mode:"pulse", a:"#000", b:"#0b0b0b", ms:900 },
      5: { mode:"pulse", a:"#000", b:"#111", ms:650 },
      6: { mode:"strobe", ms:90 }
    };

    let pulseTimer = null;
    let strobeTimer = null;

    function clearLightsTimers(){
      if(pulseTimer){ clearInterval(pulseTimer); pulseTimer=null; }
      if(strobeTimer){ clearInterval(strobeTimer); strobeTimer=null; }
      $("strobe").style.opacity = 0;
    }

    function applyLightPreset(n){
      n = clamp(n,1,6);
      STATE.ui.lightPreset = n;
      clearLightsTimers();

      const p = LIGHTS[n];
      if(p.mode === "solid"){
        document.body.style.background = p.bg;
        toast("LIGHT " + n);
      } else if(p.mode === "pulse"){
        let flip = false;
        document.body.style.background = p.a;
        pulseTimer = setInterval(()=>{
          flip = !flip;
          document.body.style.background = flip ? p.b : p.a;
        }, p.ms);
        toast("PULSE " + n);
      } else if(p.mode === "strobe"){
        // strobe overlay toggles white/black quickly; background stays black
        document.body.style.background = "#000";
        let on = false;
        $("strobe").style.opacity = 1;
        strobeTimer = setInterval(()=>{
          on = !on;
          $("strobe").style.background = on ? "#fff" : "#000";
        }, p.ms);
        toast("STROBE " + n);
      }

      persist();
    }

    /* =========================================================
       EE-02 :: ENGINE — MOTION (SPACE)
       ========================================================= */
    function setMotion(on){
      STATE.ui.motionOn = !!on;
      $("motion").classList.toggle("run", STATE.ui.motionOn);
      toast(STATE.ui.motionOn ? "MOTION ON" : "MOTION OFF");
      persist();
    }

    /* =========================================================
       EE-03 :: ENGINE — INVERT (SHIFT+I) — INVERTS EVERYTHING
       ========================================================= */
    function setInvert(on){
      STATE.ui.invert = !!on;
      document.documentElement.classList.toggle("invertAll", STATE.ui.invert);
      toast(STATE.ui.invert ? "INVERT ON" : "INVERT OFF");
      persist();
    }

    /* =========================================================
       EE-04 :: ENGINE — DRAG + RESIZE (SMOOTH / BULLETPROOF)
       ========================================================= */

    function makeDraggableResizable(winEl, model, opts={}){
      const head = winEl.querySelector(opts.headSelector || ".winHeader") || winEl;
      const grip = winEl.querySelector(".resizeGrip");
      let dragging = false;
      let resizing = false;
      let sx=0, sy=0, ox=0, oy=0, ow=0, oh=0;

      // Ensure absolute anchoring
      winEl.style.right = "auto";

      // RAF-throttle for smoothness
      let rafId = null;
      let nextX=null, nextY=null, nextW=null, nextH=null;

      const applyFrame = ()=>{
        rafId = null;
        if(nextX !== null){ winEl.style.left = nextX + "px"; model.x = nextX; nextX=null; }
        if(nextY !== null){ winEl.style.top  = nextY + "px"; model.y = nextY; nextY=null; }
        if(nextW !== null){ winEl.style.width  = nextW + "px"; model.w = nextW; nextW=null; }
        if(nextH !== null){ winEl.style.height = nextH + "px"; model.h = nextH; nextH=null; }
      };

      const schedule = ()=>{
        if(rafId) return;
        rafId = requestAnimationFrame(applyFrame);
      };

      const down = (e)=>{
        if(e.button !== 0) return;
        if(e.target.closest("button")) return; // don't start drag from buttons
        dragging = true;
        const r = winEl.getBoundingClientRect();
        sx = e.clientX; sy = e.clientY;
        ox = r.left; oy = r.top;

        // Convert first time to explicit left/top if needed
        winEl.style.left = ox + "px";
        winEl.style.top  = oy + "px";
        winEl.style.right = "auto";

        winEl.style.zIndex = String(getTopZ());
        e.preventDefault();
      };

      const move = (e)=>{
        if(dragging){
          const x = Math.max(0, ox + (e.clientX - sx));
          const y = Math.max(0, oy + (e.clientY - sy));
          nextX = Math.round(x);
          nextY = Math.round(y);
          schedule();
        }
        if(resizing){
          const minW = 240, minH = 160;
          const w = Math.max(minW, ow + (e.clientX - sx));
          const h = Math.max(minH, oh + (e.clientY - sy));
          nextW = Math.round(w);
          nextH = Math.round(h);
          schedule();
        }
      };

      const up = ()=>{
        if(dragging || resizing){
          dragging = false; resizing = false;
          persist();
        }
      };

      head.addEventListener("mousedown", down);

      if(grip){
        grip.addEventListener("mousedown", (e)=>{
          if(e.button !== 0) return;
          resizing = true;
          const r = winEl.getBoundingClientRect();
          sx = e.clientX; sy = e.clientY;
          ow = r.width; oh = r.height;
          winEl.style.zIndex = String(getTopZ());
          e.preventDefault();
          e.stopPropagation();
        });
      }

      window.addEventListener("mousemove", move, {passive:true});
      window.addEventListener("mouseup", up, {passive:true});
    }

    function getTopZ(){
      // Simple z-stacking: bump to 90+ range
      const wins = document.querySelectorAll(".win");
      let max = 60;
      wins.forEach(w=>{
        const z = parseInt(getComputedStyle(w).zIndex || "0", 10);
        if(z > max) max = z;
      });
      return max + 1;
    }

    /* =========================================================
       WB-01 :: WIRING — KETA_NOTE WINDOW (ICON LOGIC + PERSIST)
       ========================================================= */

    function setKetaOpen(open){
      const isOpen = !!open;
      $("ketaNote").classList.toggle("hidden", !isOpen);
      $("ketaIcon").classList.toggle("open", isOpen); // hollow when open
      STATE.payload.ketaWin.open = isOpen;
      persist();
    }

    function bindKetaWin(){
      const w = $("ketaNote");
      const m = STATE.payload.ketaWin;

      if(Number.isFinite(m.x)) w.style.left = m.x + "px";
      if(Number.isFinite(m.y)) w.style.top  = m.y + "px";
      w.style.width  = (m.w || 360) + "px";
      w.style.height = (m.h || 240) + "px";
      if(Number.isFinite(m.x) || Number.isFinite(m.y)) w.style.right="auto";

      makeDraggableResizable(w, m, { headSelector:"#ketaHead" });

      // content wiring
      $("ketaText").value = STATE.ketaNote || "";
      $("ketaText").addEventListener("input", ()=>{
        STATE.ketaNote = $("ketaText").value;
        persist();
      });

      // header control
      $("btnKetaMin").addEventListener("click", ()=> setKetaOpen(false));
      $("ketaIcon").addEventListener("click", ()=>{
        const willOpen = $("ketaNote").classList.contains("hidden");
        setKetaOpen(willOpen);
        toast(willOpen ? "KETA NOTE OPEN" : "KETA NOTE CLOSED");
      });

      // initial state
      w.classList.remove("hidden"); // allow geometry init
      setKetaOpen(!!m.open);
    }

    /* =========================================================
       WB-02 :: WIRING — KDTV WINDOW (VIDEO DEFAULT INVERT)
       ========================================================= */

    function setKDTVOpen(open){
      const isOpen = !!open;
      $("kdtvWin").classList.toggle("hidden", !isOpen);
      STATE.payload.kdtvWin.open = isOpen;
      persist();
    }

    function applyVideoInvert(){
      // VIDEO ONLY: invert default ON, toggleable OFF
      const on = !!STATE.payload.kdtv.videoInvert;
      $("chkVideoInvert").checked = on;
      $("kdtvVideo").style.filter = on ? "invert(1) hue-rotate(180deg)" : "none";
    }

    function bindKDTVWin(){
      const w = $("kdtvWin");
      const m = STATE.payload.kdtvWin;

      if(Number.isFinite(m.x)) w.style.left = m.x + "px";
      if(Number.isFinite(m.y)) w.style.top  = m.y + "px";
      w.style.width  = (m.w || 520) + "px";
      w.style.height = (m.h || 320) + "px";

      makeDraggableResizable(w, m, { headSelector:"#kdtvHead" });

      $("btnKDTVMin").addEventListener("click", ()=> setKDTVOpen(false));
      $("btnKDTV").addEventListener("click", ()=>{
        const willOpen = $("kdtvWin").classList.contains("hidden");
        setKDTVOpen(willOpen);
        toast(willOpen ? "KDTV OPEN" : "KDTV CLOSED");
      });

      $("btnLoadVideo").addEventListener("click", ()=> $("fileVideo").click());
      $("fileVideo").addEventListener("change", (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        loadVideoFile(f);
        e.target.value = "";
      });

      $("chkVideoInvert").addEventListener("change", ()=>{
        STATE.payload.kdtv.videoInvert = $("chkVideoInvert").checked;
        applyVideoInvert();
        persist();
      });

      $("btnKDTVGoto").addEventListener("click", ()=>{
        // optional navigation
        window.location.href = "https://ketadata.com/kdtv1.html";
      });

      // smooth “empty” indicator
      $("kdtvVideo").addEventListener("loadeddata", ()=> $("kdtvEmpty").style.display="none");
      $("kdtvVideo").addEventListener("emptied", ()=> $("kdtvEmpty").style.display="flex");
      $("kdtvVideo").addEventListener("error", ()=> { $("kdtvEmpty").style.display="flex"; toast("VIDEO ERROR"); });

      // initial
      w.classList.remove("hidden");
      applyVideoInvert();
      setKDTVOpen(!!m.open);
    }

    function loadVideoFile(file){
      const v = $("kdtvVideo");

      // Release prior objectURL (prevents memory balloon)
      if(loadVideoFile._url){
        URL.revokeObjectURL(loadVideoFile._url);
        loadVideoFile._url = null;
      }

      const url = URL.createObjectURL(file);
      loadVideoFile._url = url;

      // Smooth load: set src, wait a tick, then play if possible
      v.pause();
      v.removeAttribute("src");
      v.load();

      requestAnimationFrame(()=>{
        v.src = url;
        v.load();
        // no effects, just invert filter (handled by applyVideoInvert)
        applyVideoInvert();
        $("kdtvEmpty").style.display="none";
        toast("VIDEO LOADED");
      });
    }

    /* =========================================================
       WB-03 :: WIRING — UNIVERSALS PANEL
       ========================================================= */
    function bindUniversals(){
      $("universals").value = STATE.universals || "";
      $("universals").addEventListener("input", ()=>{
        STATE.universals = $("universals").value;
        persist();
      });
    }

    /* =========================================================
       WB-04 :: WIRING — STATE IO (LOAD/EXPORT/COPY/CLEAR)
       ========================================================= */
    function exportState(){
      return JSON.stringify(STATE, null, 2);
    }

    function importStateText(txt){
      const obj = safeParseJSON(txt);
      if(!obj){ toast("BAD JSON"); return; }
      STATE = deepMerge(structuredClone(DEFAULT_STATE), obj);
      localStorage.setItem(LS_KEY, JSON.stringify(STATE, null, 2));
      toast("STATE IMPORTED");
      hardRender();
    }

    function bindStateIO(){
      $("btnStateLoad").addEventListener("click", ()=> $("fileState").click());
      $("fileState").addEventListener("change", async (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        const txt = await f.text();
        importStateText(txt);
        e.target.value = "";
      });

      $("btnStateExport").addEventListener("click", ()=>{
        download(FILE_SERIAL + ".state.json", exportState());
        toast("STATE EXPORTED");
      });

      $("btnStateCopy").addEventListener("click", ()=>{
        copyText(exportState());
      });

      $("btnClear").addEventListener("click", ()=>{
        localStorage.removeItem(LS_KEY);
        STATE = structuredClone(DEFAULT_STATE);
        toast("CLEARED");
        hardRender();
      });
    }

    /* =========================================================
       WB-05 :: HOTKEYS
       ========================================================= */
    document.addEventListener("keydown", (e)=>{
      // Shift+I invert (typing-safe per your rule)
      if(e.shiftKey && (e.key === "I" || e.key === "i")){
        e.preventDefault();
        setInvert(!STATE.ui.invert);
        return;
      }

      // N toggles note (typing-safe: ignore if typing)
      if(!isTypingContext(e) && (e.key === "n" || e.key === "N")){
        e.preventDefault();
        const willOpen = $("ketaNote").classList.contains("hidden");
        setKetaOpen(willOpen);
        return;
      }

      // Space motion toggle (typing-safe)
      if(!isTypingContext(e) && (e.code === "Space")){
        e.preventDefault();
        setMotion(!STATE.ui.motionOn);
        return;
      }

      // 1–6 lights (typing-safe)
      if(!isTypingContext(e) && /^[1-6]$/.test(e.key)){
        e.preventDefault();
        applyLightPreset(parseInt(e.key,10));
        return;
      }
    });

    /* =========================================================
       EE-99 / WB-99 :: RENDER (SMALL, STABLE, FAST)
       ========================================================= */
    function hardRender(){
      // Global UI flags
      document.documentElement.classList.toggle("invertAll", !!STATE.ui.invert);
      $("motion").classList.toggle("run", !!STATE.ui.motionOn);

      // Text
      $("universals").value = STATE.universals || "";
      $("ketaText").value = STATE.ketaNote || "";

      // Lights
      applyLightPreset(STATE.ui.lightPreset || 1);

      // Windows: ensure bindings exist (idempotent enough for this scope)
      // (We do a one-time setup via boot; on import we rebind by reloading page primitives)
      // Simplest reliable approach: full reload of bindings:
      // clear old listeners by forcing location reload? no — instead just re-init once.
      // We'll do a "soft re-init" by rebuilding DOM positions + reapplying open flags.

      // keta win geometry
      const kw = $("ketaNote");
      const km = STATE.payload.ketaWin;
      kw.style.width  = (km.w || 360) + "px";
      kw.style.height = (km.h || 240) + "px";
      if(Number.isFinite(km.x)) kw.style.left = km.x + "px";
      if(Number.isFinite(km.y)) kw.style.top  = km.y + "px";
      if(Number.isFinite(km.x) || Number.isFinite(km.y)) kw.style.right="auto";
      setKetaOpen(!!km.open);

      // kdtv geometry
      const vw = $("kdtvWin");
      const vm = STATE.payload.kdtvWin;
      vw.style.width  = (vm.w || 520) + "px";
      vw.style.height = (vm.h || 320) + "px";
      if(Number.isFinite(vm.x)) vw.style.left = vm.x + "px";
      if(Number.isFinite(vm.y)) vw.style.top  = vm.y + "px";
      applyVideoInvert();
      setKDTVOpen(!!vm.open);

      persist();
    }

    /* =========================================================
       WB-BOOT :: ONE TIME BIND (NO DRAG REGRESSIONS)
       ========================================================= */
    (function boot(){
      // Bind IO + universals first
      bindStateIO();
      bindUniversals();

      // Bind windows (drag/resize) — must be first-class
      bindKetaWin();
      bindKDTVWin();

      // Apply UI flags
      setInvert(!!STATE.ui.invert);
      setMotion(!!STATE.ui.motionOn);
      applyLightPreset(STATE.ui.lightPreset || 1);

      // KDTV invert default ON
      if(typeof STATE.payload?.kdtv?.videoInvert !== "boolean"){
        STATE.payload.kdtv.videoInvert = true;
      }
      applyVideoInvert();

      // Minimal “smoothness”: keep video sizing stable on window resize
      // (Video is absolute + contain; no forced layout loops.)
      toast("READY");
      persist();
    })();
  </script>
</body>
</html>
