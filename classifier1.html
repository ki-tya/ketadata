<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KETADATA // INTAKE CLASSIFIER // BLACK</title>

  <!-- =========================================================
       AESTHETIC (SAFE TO EDIT)
       - Black-first, sharp edges, no rounding.
       - Do NOT rename IDs used in JS.
  ========================================================== -->
  <style>
    :root{
      --bg:#000;
      --panel:#000;
      --ink:#fff;
      --muted:#a8a8a8;
      --hair:#1b1b1b;
      --hair2:#2a2a2a;
      --accent:#fff;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, sans-serif;

      --topH:52px;
      --bottomH:170px;
      --leftW:360px;
      --rightW:380px;
      --splitter:8px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:var(--sans);
      overflow:hidden;
    }

    /* Sharp baseline */
    .hairB{ border-bottom:1px solid var(--hair); }
    .hairR{ border-right:1px solid var(--hair); }
    .hairL{ border-left:1px solid var(--hair); }
    .hairT{ border-top:1px solid var(--hair); }

    /* Top bar */
    header{
      height:var(--topH);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 12px;
      border-bottom:1px solid var(--hair);
      background:#000;
    }
    .brand{
      display:flex; flex-direction:column; line-height:1.05;
      user-select:none;
    }
    .brand .top{
      font-weight:700;
      letter-spacing:.14em;
      font-size:12px;
    }
    .brand .sub{
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
      letter-spacing:.08em;
      margin-top:2px;
    }

    .topActions{
      display:flex; align-items:center; gap:10px;
    }
    .btn{
      border:1px solid var(--hair2);
      background:#000;
      color:var(--ink);
      padding:7px 10px;
      font-size:11px;
      font-family:var(--mono);
      letter-spacing:.06em;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{ border-color:#3b3b3b; }
    .btn:active{ transform: translateY(1px); }

    /* KETA NOTE icon button (square) */
    .noteIconBtn{
      width:30px; height:30px;
      border:1px solid var(--hair2);
      background:#000;
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
    }
    .noteIconBtn:hover{ border-color:#3b3b3b; }
    .sqIcon{
      width:12px; height:12px;
      border:1px solid #fff;
      background:#000; /* default "on screen" indicator: black inside */
    }
    .sqIcon.filled{
      background:#fff; /* collapsed indicator: filled white */
    }

    /* Main viewport: left | center | right */
    #viewport{
      height:calc(100% - var(--topH));
      display:grid;
      grid-template-columns: var(--leftW) var(--splitter) 1fr var(--splitter) var(--rightW);
      grid-template-rows: 1fr var(--splitter) var(--bottomH);
    }

    /* Panels */
    .panel{
      background:#000;
      border:1px solid var(--hair);
      overflow:hidden;
      min-width:220px;
      min-height:140px;
    }
    .panelHeader{
      height:42px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      border-bottom:1px solid var(--hair);
      background:#000;
      user-select:none;
    }
    .panelHeader .title{
      font-family:var(--mono);
      font-size:11px;
      letter-spacing:.14em;
      color:#fff;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .panelHeader .meta{
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
      letter-spacing:.08em;
    }
    .panelBody{
      height:calc(100% - 42px);
      overflow:auto;
      padding:10px;
    }

    /* Splitters */
    .splitV, .splitH{
      background:#000;
      border-left:1px solid var(--hair);
      border-right:1px solid var(--hair);
      position:relative;
      cursor:col-resize;
    }
    .splitH{
      border-left:none;
      border-right:none;
      border-top:1px solid var(--hair);
      border-bottom:1px solid var(--hair);
      cursor:row-resize;
    }
    .splitV::after{
      content:"";
      position:absolute;
      left:50%; top:8px; bottom:8px;
      width:2px;
      transform:translateX(-50%);
      background:var(--hair2);
    }
    .splitH::after{
      content:"";
      position:absolute;
      top:50%; left:8px; right:8px;
      height:2px;
      transform:translateY(-50%);
      background:var(--hair2);
    }

    /* Left: categories */
    .hint{
      font-family:var(--mono);
      font-size:10px;
      line-height:1.35;
      color:var(--muted);
      margin-bottom:10px;
    }
    .cat{
      border:1px solid var(--hair);
      margin-bottom:10px;
    }
    .catHead{
      height:38px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      border-bottom:1px solid var(--hair);
      cursor:pointer;
      user-select:none;
    }
    .catHead .left{
      display:flex; align-items:center; gap:10px;
      font-family:var(--mono);
      font-size:11px;
      letter-spacing:.08em;
    }
    .pill{
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
      border:1px solid var(--hair2);
      padding:2px 7px;
    }
    .catBody{
      display:none;
      padding:10px;
      gap:10px;
    }
    .catBody.open{ display:grid; }
    .drop{
      border:1px dashed var(--hair2);
      min-height:84px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
      letter-spacing:.08em;
    }
    .drop.dragover{
      border-style:solid;
      color:#fff;
    }
    .catNote{
      width:100%;
      min-height:120px;
      border:1px solid var(--hair2);
      background:#000;
      color:#fff;
      font-family:var(--mono);
      font-size:11px;
      padding:10px;
      outline:none;
      resize:vertical;
    }
    .list{ display:flex; flex-direction:column; gap:6px; }
    .item{
      border:1px solid var(--hair);
      padding:8px 8px;
      display:grid;
      grid-template-columns: 12px 1fr auto;
      gap:10px;
      align-items:center;
      cursor:pointer;
      user-select:none;
    }
    .item:hover{ border-color:#3b3b3b; }
    .item .label{
      font-family:var(--mono);
      font-size:11px;
      color:#fff;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .type{
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
      border:1px solid var(--hair2);
      padding:2px 6px;
    }
    .miniSq{
      width:10px; height:10px;
      border:1px solid #fff;
      background:#000;
    }

    /* Center: stage */
    .stageTop{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:10px;
      border-bottom:1px solid var(--hair);
    }
    .stageTop .left{
      min-width:0;
      display:flex; flex-direction:column; gap:2px;
    }
    .stageTop .left .t{
      font-family:var(--mono);
      font-size:11px;
      letter-spacing:.14em;
    }
    .stageTop .left .s{
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
      letter-spacing:.08em;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .stageTop .right{
      display:flex; align-items:center; gap:8px;
      flex:0 0 auto;
    }
    .seg{
      font-family:var(--mono);
      font-size:10px;
      border:1px solid var(--hair2);
      padding:4px 8px;
      color:var(--muted);
      letter-spacing:.06em;
      max-width:260px;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .frame{
      height:calc(100% - 52px);
      padding:14px;
      overflow:auto;
    }
    .viewer{
      border:1px solid var(--hair);
      height:100%;
      min-height:520px;
      display:grid;
      place-items:center;
      position:relative;
      background:#000;
    }
    .viewer.empty::before{
      content:"DROP SCREENSHOT OR PASTE HTML";
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      letter-spacing:.14em;
    }
    #imgView{
      max-width:100%;
      max-height:100%;
      object-fit:contain;
      display:none;
    }
    #htmlView{
      width:100%;
      height:100%;
      border:0;
      display:none;
      background:#000;
    }

    /* Right: final edits + prompt preview */
    .fieldLabel{
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
      letter-spacing:.14em;
      margin:0 0 6px;
    }
    textarea, input[type="text"]{
      width:100%;
      border:1px solid var(--hair2);
      background:#000;
      color:#fff;
      font-family:var(--mono);
      font-size:11px;
      padding:10px;
      outline:none;
    }
    textarea{ min-height:160px; resize:vertical; }
    .box{
      border:1px solid var(--hair);
      padding:10px;
      margin-bottom:10px;
    }
    .small{
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
      line-height:1.35;
    }

    /* Bottom: system-wide rules / constraints / references */
    .bottomGrid{
      height:100%;
      display:grid;
      grid-template-columns: 1fr var(--splitter) 1fr;
    }

    /* Footer strip inside bottom */
    .bottomHint{
      padding:10px;
      border-top:1px solid var(--hair);
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
      letter-spacing:.06em;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .kbd{
      border:1px solid var(--hair2);
      padding:2px 6px;
      font-family:var(--mono);
      color:#fff;
    }

    /* Floating Keta Note (movable + resizable) */
    #floatNote{
      position:fixed;
      top:76px;
      left:calc(var(--leftW) + 22px);
      width:360px;
      height:240px;
      border:1px solid #fff;
      background:#000;
      z-index:50;
      display:flex;
      flex-direction:column;
    }
    #floatNote.hidden{ display:none; }
    #floatNoteHead{
      height:38px;
      border-bottom:1px solid var(--hair);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      cursor:move;
      user-select:none;
      font-family:var(--mono);
      font-size:11px;
      letter-spacing:.12em;
    }
    #floatNoteHead .left{
      display:flex; align-items:center; gap:10px;
    }
    #floatNoteHead .right{
      display:flex; gap:8px;
    }
    .iconBtn{
      width:26px; height:26px;
      border:1px solid var(--hair2);
      display:grid;
      place-items:center;
      font-family:var(--mono);
      font-size:12px;
      cursor:pointer;
      user-select:none;
      background:#000;
      color:#fff;
    }
    .iconBtn:hover{ border-color:#3b3b3b; }
    #floatNoteBody{
      padding:10px;
      height:100%;
    }
    #floatNoteText{
      height:100%;
      min-height:0;
      resize:none;
    }
    #floatResizer{
      position:absolute;
      right:2px; bottom:2px;
      width:14px; height:14px;
      border:1px solid var(--hair2);
      cursor:nwse-resize;
    }

    /* Utility */
    .hidden{ display:none !important; }

    /* Scrollbars (dark) */
    ::-webkit-scrollbar{ width:10px; height:10px; }
    ::-webkit-scrollbar-thumb{ background:#222; border:2px solid #000; }
    ::-webkit-scrollbar-track{ background:#000; }
  </style>
</head>

<body>
  <!-- =========================================================
       WIRING (DO NOT RENAME IDs)
       TOP BAR: includes the KETA NOTE icon
  ========================================================== -->
  <header>
    <div class="brand">
      <div class="top">KETADATA</div>
      <div class="sub">SCREENSHOT + HTML INTAKE // CLASSIFIER + NOTES // BLACK-LAW BUILD</div>
    </div>

    <div class="topActions">
      <!-- KETA NOTE ICON: filled when collapsed; black inside when on-screen -->
      <div class="noteIconBtn" id="noteIconBtn" title="Toggle KETA NOTE (N)">
        <div class="sqIcon" id="noteIconSq"></div>
      </div>

      <button class="btn" id="exportBtn">EXPORT JSON</button>
      <button class="btn" id="clearBtn">CLEAR</button>
    </div>
  </header>

  <!-- =========================================================
       WIRING: main adjustable layout with splitters
  ========================================================== -->
  <div id="viewport">
    <!-- LEFT PANEL -->
    <section class="panel" id="leftPanel" style="grid-column:1;grid-row:1;">
      <div class="panelHeader">
        <div class="title">CATEGORIES</div>
        <div class="meta">DROP + CLASSIFY</div>
      </div>
      <div class="panelBody">
        <div class="hint">
          Drop screenshots / HTML into categories. Each category has a note.
          Selection renders in Center Stage.
        </div>
        <div id="cats"></div>
      </div>
    </section>

    <!-- SPLITTER V1 -->
    <div class="splitV" id="splitV1" style="grid-column:2;grid-row:1;"></div>

    <!-- CENTER PANEL -->
    <section class="panel" id="centerPanel" style="grid-column:3;grid-row:1;">
      <div class="stageTop">
        <div class="left">
          <div class="t" id="stageTitle">CENTER STAGE</div>
          <div class="s" id="stageSub">drop screenshot or paste html</div>
        </div>
        <div class="right">
          <div class="seg" id="selMeta">— no selection</div>
          <button class="btn" id="pasteHtmlBtn">PASTE HTML</button>
          <label class="btn" style="cursor:pointer;">
            <input id="fileInput" type="file" accept="image/*,.html,.htm,text/html" style="display:none;">
            IMPORT
          </label>
        </div>
      </div>
      <div class="frame">
        <div class="viewer empty" id="viewer">
          <img id="imgView" alt="screenshot preview" />
          <iframe id="htmlView" sandbox="allow-same-origin allow-forms allow-scripts"></iframe>
        </div>
      </div>
    </section>

    <!-- SPLITTER V2 -->
    <div class="splitV" id="splitV2" style="grid-column:4;grid-row:1;"></div>

    <!-- RIGHT PANEL: Final edits / corrections / prompt preview -->
    <aside class="panel" id="rightPanel" style="grid-column:5;grid-row:1;">
      <div class="panelHeader">
        <div class="title">FINAL EDITS</div>
        <div class="meta">CORRECTIONS + PROMPT</div>
      </div>
      <div class="panelBody">
        <div class="box">
          <div class="fieldLabel">PROMPT PREVIEW</div>
          <textarea id="promptPreview" placeholder="Auto-generated prompt from selection + notes."></textarea>
          <div class="small" style="margin-top:8px;">
            This is where you finalize what you will send to another model/tool.
          </div>
        </div>

        <div class="box">
          <div class="fieldLabel">CORRECTIONS / EDIT NOTES</div>
          <textarea id="finalEdits" placeholder="Final corrections, decisions, and constraints for this item/page."></textarea>
        </div>

        <div class="box">
          <div class="fieldLabel">DIAGNOSTICS</div>
          <div class="small" id="diag">READY.</div>
        </div>
      </div>
    </aside>

    <!-- SPLITTER H -->
    <div class="splitH" id="splitH" style="grid-column:1 / span 5; grid-row:2;"></div>

    <!-- BOTTOM PANEL: System-wide rules / constraints / references -->
    <section class="panel" id="bottomPanel" style="grid-column:1 / span 5; grid-row:3;">
      <div class="panelHeader">
        <div class="title">SYSTEM RULES</div>
        <div class="meta">CONSTRAINTS + REFERENCES</div>
      </div>

      <div class="panelBody" style="padding:0;">
        <div class="bottomGrid" style="height:calc(100% - 42px);">
          <div class="panelBody" style="grid-column:1; padding:10px;">
            <div class="fieldLabel">SYSTEM-WIDE LAWS / CONSTRAINTS</div>
            <textarea id="systemRules" placeholder="Global laws (aesthetic + functional). Example: NO ROUNDED CORNERS. BLACK BASE. WHITE HAIRLINES. NOTES: SQUARE ICONS."></textarea>
          </div>

          <div class="splitV" id="splitV3" style="grid-column:2; border-left:1px solid var(--hair); border-right:1px solid var(--hair);"></div>

          <div class="panelBody" style="grid-column:3; padding:10px;">
            <div class="fieldLabel">REFERENCES / LINKS / SNIPPETS</div>
            <textarea id="references" placeholder="Reference URLs, snippets, precedents, prior pages, known good patterns."></textarea>
          </div>
        </div>

        <div class="bottomHint">
          <div>
            Keys: <span class="kbd">1–8</span> open categories · <span class="kbd">N</span> toggle KETA NOTE · <span class="kbd">Esc</span> clear selection
          </div>
          <div id="status">READY.</div>
        </div>
      </div>
    </section>
  </div>

  <!-- =========================================================
       WIRING: FLOATING KETA NOTE (movable/resizable)
       Icon behavior:
       - Note ON screen => square icon is black inside (bg black, border white)
       - Note COLLAPSED (hidden) => square icon is filled white
  ========================================================== -->
  <div id="floatNote" class="">
    <div id="floatNoteHead">
      <div class="left">
        <div class="miniSq" aria-hidden="true"></div>
        <div>KETA NOTE</div>
      </div>
      <div class="right">
        <div class="iconBtn" id="noteMinBtn" title="collapse">–</div>
        <div class="iconBtn" id="noteCloseBtn" title="hide">×</div>
      </div>
    </div>
    <div id="floatNoteBody">
      <textarea id="floatNoteText" placeholder="SYSTEM NOTE // decisions, constraints, next actions"></textarea>
    </div>
    <div id="floatResizer" title="resize"></div>
  </div>

  <!-- =========================================================
       ENGINE (FUNCTIONAL LOGIC)
       - Adjustable panels (splitters)
       - Intake (import/drop/paste)
       - Category notes + item list
       - Selection + preview
       - Keta note icon state + floating note move/resize
       - Right panel prompt preview composition
       - Bottom system rules + references
       - Export JSON
  ========================================================== -->
  <script>
    /* =========================
       WIRING: required IDs
    ========================== */
    const $ = (id) => document.getElementById(id);

    const els = {
      cats: $("cats"),
      fileInput: $("fileInput"),
      pasteHtmlBtn: $("pasteHtmlBtn"),
      exportBtn: $("exportBtn"),
      clearBtn: $("clearBtn"),

      stageTitle: $("stageTitle"),
      stageSub: $("stageSub"),
      selMeta: $("selMeta"),
      viewer: $("viewer"),
      imgView: $("imgView"),
      htmlView: $("htmlView"),

      diag: $("diag"),
      status: $("status"),

      // Right panel
      promptPreview: $("promptPreview"),
      finalEdits: $("finalEdits"),

      // Bottom
      systemRules: $("systemRules"),
      references: $("references"),

      // Note icon + floating note
      noteIconBtn: $("noteIconBtn"),
      noteIconSq: $("noteIconSq"),
      floatNote: $("floatNote"),
      floatNoteHead: $("floatNoteHead"),
      floatNoteText: $("floatNoteText"),
      noteMinBtn: $("noteMinBtn"),
      noteCloseBtn: $("noteCloseBtn"),
      floatResizer: $("floatResizer"),

      // Splitters
      splitV1: $("splitV1"),
      splitV2: $("splitV2"),
      splitV3: $("splitV3"),
      splitH: $("splitH"),
    };

    function assertWiring(){
      const missing = Object.entries(els).filter(([k,v]) => !v).map(([k])=>k);
      if(missing.length){
        document.body.innerHTML =
          "<pre style='padding:16px;font-family:monospace;color:#fff;background:#000'>WIRING ERROR: Missing IDs:\\n" +
          missing.join("\\n") + "</pre>";
        throw new Error("Missing IDs: " + missing.join(", "));
      }
    }
    assertWiring();

    function diag(msg){ els.diag.textContent = msg || "—"; }
    function status(msg){ els.status.textContent = msg || "—"; }

    /* =========================
       ENGINE: state
    ========================== */
    const uid = () => Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);

    const STATE = {
      version: "ketadata-intake-black-v1",
      createdAt: new Date().toISOString(),
      systemRules: "",
      references: "",
      finalEdits: "",
      ketaNote: "",
      categories: [
        { id:"source", title:"SOURCE INBOX", note:"", items:[] },
        { id:"interface", title:"INTERFACE / UI", note:"", items:[] },
        { id:"layout", title:"LAYOUT / GRID", note:"", items:[] },
        { id:"typography", title:"TYPOGRAPHY", note:"", items:[] },
        { id:"motion", title:"MOTION / FEEL", note:"", items:[] },
        { id:"controls", title:"CONTROLS / INPUTS", note:"", items:[] },
        { id:"engine", title:"ENGINE / LOGIC", note:"", items:[] },
        { id:"bugs", title:"BUGS / RISKS", note:"", items:[] }
      ],
      selection: { catId:null, itemId:null }
    };

    /* =========================
       ENGINE: render categories
    ========================== */
    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function renderCategories(){
      els.cats.innerHTML = "";
      STATE.categories.forEach((cat) => {
        const wrap = document.createElement("div");
        wrap.className = "cat";
        wrap.dataset.cat = cat.id;

        const head = document.createElement("div");
        head.className = "catHead";
        head.innerHTML = `
          <div class="left">
            <div class="miniSq" aria-hidden="true"></div>
            <div>${escapeHtml(cat.title)}</div>
          </div>
          <div class="pill">${cat.items.length} items</div>
        `;

        const body = document.createElement("div");
        body.className = "catBody";
        body.innerHTML = `
          <div class="drop" data-drop="${cat.id}">DROP HERE // image | html</div>
          <textarea class="catNote" data-note="${cat.id}" placeholder="NOTE // ${escapeHtml(cat.title)}"></textarea>
          <div class="list" data-list="${cat.id}"></div>
        `;

        // open inbox by default
        if(cat.id === "source") body.classList.add("open");

        head.addEventListener("click", ()=> body.classList.toggle("open"));

        wrap.appendChild(head);
        wrap.appendChild(body);
        els.cats.appendChild(wrap);

        // note binding
        const ta = body.querySelector(`textarea[data-note="${cat.id}"]`);
        ta.value = cat.note || "";
        ta.addEventListener("input", () => {
          cat.note = ta.value || "";
          refreshPromptPreview();
        });

        renderList(cat.id);
      });

      wireDropzones();
    }

    function renderList(catId){
      const cat = STATE.categories.find(c=>c.id===catId);
      const listEl = document.querySelector(`[data-list="${catId}"]`);
      if(!cat || !listEl) return;

      listEl.innerHTML = "";
      cat.items.forEach(item => {
        const row = document.createElement("div");
        row.className = "item";
        row.draggable = true;
        row.dataset.item = item.id;
        row.dataset.cat = catId;

        row.innerHTML = `
          <div class="miniSq" aria-hidden="true"></div>
          <div class="label" title="${escapeHtml(item.label)}">${escapeHtml(item.label)}</div>
          <div class="type">${item.kind}</div>
        `;

        row.addEventListener("click", ()=> selectItem(catId, item.id));

        row.addEventListener("dragstart", (e)=>{
          e.dataTransfer.setData("text/plain", JSON.stringify({ catId, itemId:item.id }));
          e.dataTransfer.effectAllowed = "move";
        });

        listEl.appendChild(row);
      });

      const pill = document.querySelector(`.cat[data-cat="${catId}"] .pill`);
      if(pill) pill.textContent = `${cat.items.length} items`;
    }

    /* =========================
       ENGINE: selection + preview
    ========================== */
    function clearStage(){
      STATE.selection = { catId:null, itemId:null };
      els.viewer.classList.add("empty");
      els.imgView.style.display = "none";
      els.htmlView.style.display = "none";
      els.imgView.src = "";
      els.htmlView.srcdoc = "";
      els.stageTitle.textContent = "CENTER STAGE";
      els.stageSub.textContent = "drop screenshot or paste html";
      els.selMeta.textContent = "— no selection";
      refreshPromptPreview();
      status("READY.");
    }

    function selectItem(catId, itemId){
      const cat = STATE.categories.find(c=>c.id===catId);
      const item = cat?.items.find(i=>i.id===itemId);
      if(!item) return;

      STATE.selection = { catId, itemId };

      els.stageTitle.textContent = cat.title;
      els.stageSub.textContent = item.label;
      els.selMeta.textContent = `${item.kind.toUpperCase()} // ${itemId.slice(0,8)}`;

      els.viewer.classList.remove("empty");

      if(item.kind === "image"){
        els.htmlView.style.display = "none";
        els.imgView.style.display = "block";
        els.imgView.src = item.dataUrl;
      } else {
        els.imgView.style.display = "none";
        els.htmlView.style.display = "block";
        els.htmlView.srcdoc = item.html;
      }

      refreshPromptPreview();
      status(`SELECTED: ${item.kind.toUpperCase()}`);
    }

    /* =========================
       ENGINE: intake (import/paste/drop)
    ========================== */
    function fileToDataURL(file){
      return new Promise((resolve, reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(r.result);
        r.onerror = ()=> reject(r.error || new Error("FileReader failed"));
        r.readAsDataURL(file);
      });
    }

    async function addItemTo(catId, item){
      const cat = STATE.categories.find(c=>c.id===catId);
      if(!cat) return;
      cat.items.unshift(item);
      renderList(catId);
      selectItem(catId, item.id);
    }

    async function handleFile(file, targetCatId="source"){
      const name = file.name || "untitled";
      const ext = name.split(".").pop().toLowerCase();

      if(file.type.startsWith("image/")){
        const dataUrl = await fileToDataURL(file);
        return addItemTo(targetCatId, {
          id: uid(),
          kind:"image",
          label: name,
          dataUrl,
          createdAt: new Date().toISOString()
        });
      }

      if(file.type === "text/html" || ext === "html" || ext === "htm"){
        const html = await file.text();
        return addItemTo(targetCatId, {
          id: uid(),
          kind:"html",
          label: name,
          html,
          createdAt: new Date().toISOString()
        });
      }

      throw new Error(`Unsupported file: ${name}`);
    }

    els.fileInput.addEventListener("change", async ()=>{
      diag("—");
      const f = els.fileInput.files?.[0];
      if(!f) return;
      try{
        status("IMPORTING…");
        await handleFile(f, "source");
        status("IMPORTED.");
      }catch(e){
        diag(String(e));
        status("IMPORT FAILED.");
      }finally{
        els.fileInput.value = "";
      }
    });

    els.pasteHtmlBtn.addEventListener("click", async ()=>{
      const html = prompt("PASTE HTML (raw). Will render in sandboxed iframe.");
      if(!html) return;
      await addItemTo("source", {
        id: uid(),
        kind:"html",
        label: "PASTED_HTML_" + new Date().toISOString().slice(0,19),
        html,
        createdAt: new Date().toISOString()
      });
      status("PASTED HTML ADDED.");
    });

    /* Center viewer drop: import to inbox */
    (function wireViewerDrop(){
      const target = els.viewer;

      ["dragenter","dragover"].forEach(ev => target.addEventListener(ev, (e)=>{
        e.preventDefault();
        e.dataTransfer.dropEffect = "copy";
      }));

      target.addEventListener("drop", async (e)=>{
        e.preventDefault();
        diag("—");

        // If dragging an existing item, interpret as selection
        const payload = e.dataTransfer.getData("text/plain");
        if(payload){
          try{
            const obj = JSON.parse(payload);
            if(obj?.catId && obj?.itemId){
              selectItem(obj.catId, obj.itemId);
              return;
            }
          }catch(_){}
        }

        const files = Array.from(e.dataTransfer.files || []);
        if(!files.length) return;

        try{
          status(`IMPORTING ${files.length}…`);
          for(const f of files) await handleFile(f, "source");
          status("DROP IMPORT COMPLETE.");
        }catch(err){
          diag(String(err));
          status("DROP IMPORT FAILED.");
        }
      });
    })();

    function wireDropzones(){
      document.querySelectorAll("[data-drop]").forEach(zone=>{
        const toCatId = zone.getAttribute("data-drop");

        zone.addEventListener("dragover", (e)=>{
          e.preventDefault();
          zone.classList.add("dragover");
          e.dataTransfer.dropEffect = "move";
        });
        zone.addEventListener("dragleave", ()=> zone.classList.remove("dragover"));

        zone.addEventListener("drop", async (e)=>{
          e.preventDefault();
          zone.classList.remove("dragover");
          diag("—");

          const payload = e.dataTransfer.getData("text/plain");
          if(payload){
            try{
              const obj = JSON.parse(payload);
              if(obj?.catId && obj?.itemId){
                moveItem(obj.catId, obj.itemId, toCatId);
                status(`MOVED → ${toCatId.toUpperCase()}`);
                return;
              }
            }catch(_){}
          }

          const files = Array.from(e.dataTransfer.files || []);
          if(files.length){
            try{
              status(`IMPORTING ${files.length}…`);
              for(const f of files) await handleFile(f, toCatId);
              status("IMPORT COMPLETE.");
            }catch(err){
              diag(String(err));
              status("IMPORT FAILED.");
            }
          }
        });
      });
    }

    function moveItem(fromCatId, itemId, toCatId){
      if(fromCatId === toCatId) return;
      const from = STATE.categories.find(c=>c.id===fromCatId);
      const to = STATE.categories.find(c=>c.id===toCatId);
      if(!from || !to) return;

      const idx = from.items.findIndex(i=>i.id===itemId);
      if(idx < 0) return;

      const [item] = from.items.splice(idx, 1);
      to.items.unshift(item);

      renderList(fromCatId);
      renderList(toCatId);
      selectItem(toCatId, item.id);
    }

    /* =========================
       ENGINE: prompt preview composition (right panel)
    ========================== */
    function refreshPromptPreview(){
      const sel = STATE.selection;
      const cat = sel.catId ? STATE.categories.find(c=>c.id===sel.catId) : null;
      const item = (cat && sel.itemId) ? cat.items.find(i=>i.id===sel.itemId) : null;

      // keep synced text areas into state
      STATE.systemRules = els.systemRules.value || "";
      STATE.references = els.references.value || "";
      STATE.finalEdits = els.finalEdits.value || "";
      STATE.ketaNote = els.floatNoteText.value || "";

      const lines = [];

      lines.push("KETADATA — INTAKE CLASSIFIER PROMPT");
      lines.push("GOAL: analyze the attached item (screenshot or HTML) and produce structured notes.");
      lines.push("");

      if(item){
        lines.push("SELECTION:");
        lines.push(`- category: ${cat.title}`);
        lines.push(`- type: ${item.kind}`);
        lines.push(`- label: ${item.label}`);
        lines.push(`- id: ${item.id}`);
        lines.push("");
      } else {
        lines.push("SELECTION: none");
        lines.push("");
      }

      lines.push("GLOBAL KETA NOTE (SYSTEM NOTE):");
      lines.push(STATE.ketaNote ? STATE.ketaNote : "—");
      lines.push("");

      if(cat){
        lines.push("CATEGORY NOTE:");
        lines.push(cat.note ? cat.note : "—");
        lines.push("");
      }

      lines.push("SYSTEM-WIDE RULES / CONSTRAINTS:");
      lines.push(STATE.systemRules ? STATE.systemRules : "—");
      lines.push("");

      lines.push("REFERENCES / PRECEDENTS:");
      lines.push(STATE.references ? STATE.references : "—");
      lines.push("");

      lines.push("FINAL EDITS / CORRECTIONS:");
      lines.push(STATE.finalEdits ? STATE.finalEdits : "—");

      els.promptPreview.value = lines.join("\n");
    }

    els.systemRules.addEventListener("input", refreshPromptPreview);
    els.references.addEventListener("input", refreshPromptPreview);
    els.finalEdits.addEventListener("input", refreshPromptPreview);
    els.floatNoteText.addEventListener("input", refreshPromptPreview);

    /* =========================
       ENGINE: KETA NOTE icon behavior + floating note controls
       - On screen => icon square background black (default)
       - Collapsed/hidden => icon square filled white
    ========================== */
    let noteVisible = true;

    function setNoteIconState(){
      // visible => black inside; hidden => filled white
      els.noteIconSq.classList.toggle("filled", !noteVisible);
    }

    function showNote(){
      noteVisible = true;
      els.floatNote.classList.remove("hidden");
      setNoteIconState();
      status("KETA NOTE ON.");
    }
    function hideNote(){
      noteVisible = false;
      els.floatNote.classList.add("hidden");
      setNoteIconState();
      status("KETA NOTE COLLAPSED.");
    }
    function toggleNote(){
      noteVisible ? hideNote() : showNote();
    }

    els.noteIconBtn.addEventListener("click", toggleNote);
    els.noteCloseBtn.addEventListener("click", hideNote);
    els.noteMinBtn.addEventListener("click", hideNote);

    /* Drag move note */
    (function(){
      let dragging=false, startX=0, startY=0, startLeft=0, startTop=0;

      els.floatNoteHead.addEventListener("mousedown", (e)=>{
        if(e.target === els.noteCloseBtn || e.target === els.noteMinBtn) return;
        dragging = true;
        const r = els.floatNote.getBoundingClientRect();
        startLeft = r.left;
        startTop = r.top;
        startX = e.clientX;
        startY = e.clientY;
        document.addEventListener("mousemove", onMove);
        document.addEventListener("mouseup", onUp);
      });

      function onMove(e){
        if(!dragging) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        els.floatNote.style.left = (startLeft + dx) + "px";
        els.floatNote.style.top  = (startTop + dy) + "px";
      }
      function onUp(){
        dragging=false;
        document.removeEventListener("mousemove", onMove);
        document.removeEventListener("mouseup", onUp);
      }
    })();

    /* Resize note */
    (function(){
      let resizing=false, startX=0, startY=0, startW=0, startH=0;

      els.floatResizer.addEventListener("mousedown", (e)=>{
        e.preventDefault();
        resizing = true;
        const r = els.floatNote.getBoundingClientRect();
        startW = r.width;
        startH = r.height;
        startX = e.clientX;
        startY = e.clientY;
        document.addEventListener("mousemove", onResize);
        document.addEventListener("mouseup", onUp);
      });

      function onResize(e){
        if(!resizing) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        els.floatNote.style.width = Math.max(240, startW + dx) + "px";
        els.floatNote.style.height = Math.max(160, startH + dy) + "px";
      }
      function onUp(){
        resizing=false;
        document.removeEventListener("mousemove", onResize);
        document.removeEventListener("mouseup", onUp);
      }
    })();

    /* =========================
       ENGINE: adjustable panels (splitters)
       - V1 adjusts left width
       - V2 adjusts right width
       - V3 adjusts bottom grid split
       - H adjusts bottom height
    ========================== */
    function setCSSVar(name, px){
      document.documentElement.style.setProperty(name, px + "px");
    }
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    (function wireSplitters(){
      // V1 left width
      wireV(els.splitV1, (dx, start)=>{
        const next = clamp(start + dx, 240, 520);
        setCSSVar("--leftW", next);
      }, () => parseInt(getComputedStyle(document.documentElement).getPropertyValue("--leftW")));

      // V2 right width (dragging left increases center, so invert dx)
      wireV(els.splitV2, (dx, start)=>{
        const next = clamp(start - dx, 260, 560);
        setCSSVar("--rightW", next);
      }, () => parseInt(getComputedStyle(document.documentElement).getPropertyValue("--rightW")));

      // H bottom height (drag up reduces bottom, so invert dy)
      wireH(els.splitH, (dy, start)=>{
        const next = clamp(start - dy, 120, 360);
        setCSSVar("--bottomH", next);
      }, () => parseInt(getComputedStyle(document.documentElement).getPropertyValue("--bottomH")));

      // V3 bottom internal split: emulate by setting CSS grid columns with --leftW? no.
      // We'll store in a CSS variable by directly editing bottomGrid template via JS.
      const bottomGrid = document.querySelector(".bottomGrid");
      let bottomLeftW = 1; // ratio
      let bottomRightW = 1;

      wireV(els.splitV3, (dx, start)=>{
        // start is pixel left pane width within bottom panel
        const total = bottomGrid.getBoundingClientRect().width - parseInt(getComputedStyle(document.documentElement).getPropertyValue("--splitter"));
        const nextLeftPx = clamp(start + dx, 240, total - 240);
        bottomGrid.style.gridTemplateColumns = `${nextLeftPx}px var(--splitter) 1fr`;
      }, ()=> {
        // current computed left pane width:
        const leftPane = bottomGrid.children[0];
        return leftPane.getBoundingClientRect().width;
      });

      function wireV(el, onDelta, getStart){
        let dragging=false, startX=0, startVal=0;
        el.addEventListener("mousedown", (e)=>{
          dragging=true;
          startX = e.clientX;
          startVal = getStart();
          document.addEventListener("mousemove", onMove);
          document.addEventListener("mouseup", onUp);
          e.preventDefault();
        });
        function onMove(e){
          if(!dragging) return;
          const dx = e.clientX - startX;
          onDelta(dx, startVal);
        }
        function onUp(){
          dragging=false;
          document.removeEventListener("mousemove", onMove);
          document.removeEventListener("mouseup", onUp);
        }
      }

      function wireH(el, onDelta, getStart){
        let dragging=false, startY=0, startVal=0;
        el.addEventListener("mousedown", (e)=>{
          dragging=true;
          startY = e.clientY;
          startVal = getStart();
          document.addEventListener("mousemove", onMove);
          document.addEventListener("mouseup", onUp);
          e.preventDefault();
        });
        function onMove(e){
          if(!dragging) return;
          const dy = e.clientY - startY;
          onDelta(dy, startVal);
        }
        function onUp(){
          dragging=false;
          document.removeEventListener("mousemove", onMove);
          document.removeEventListener("mouseup", onUp);
        }
      }
    })();

    /* =========================
       ENGINE: export / clear
    ========================== */
    function exportJSON(){
      // sync to state before export
      refreshPromptPreview();

      const snapshot = JSON.parse(JSON.stringify(STATE));
      snapshot.systemRules = els.systemRules.value || "";
      snapshot.references = els.references.value || "";
      snapshot.finalEdits = els.finalEdits.value || "";
      snapshot.ketaNote = els.floatNoteText.value || "";
      snapshot.exportedAt = new Date().toISOString();

      const blob = new Blob([JSON.stringify(snapshot, null, 2)], { type:"application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `ketadata_intake_black_${new Date().toISOString().replace(/[:.]/g,"-")}.json`;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
      status("EXPORTED JSON.");
    }

    function clearAll(){
      STATE.categories.forEach(c => { c.items=[]; c.note=""; });
      els.floatNoteText.value = "";
      els.systemRules.value = "";
      els.references.value = "";
      els.finalEdits.value = "";
      diag("READY.");
      renderCategories();
      clearStage();
      refreshPromptPreview();
      status("CLEARED.");
    }

    els.exportBtn.addEventListener("click", exportJSON);
    els.clearBtn.addEventListener("click", clearAll);

    /* =========================
       ENGINE: keyboard shortcuts
    ========================== */
    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape") clearStage();
      if(e.key.toLowerCase() === "n") toggleNote();

      const n = parseInt(e.key, 10);
      if(n >= 1 && n <= 8){
        const cat = STATE.categories[n-1];
        const body = document.querySelector(`.cat[data-cat="${cat.id}"] .catBody`);
        if(body){
          body.classList.add("open");
          body.scrollIntoView({ behavior:"smooth", block:"center" });
          status(`FOCUS: ${cat.title}`);
        }
      }
    });

    /* =========================
       BOOT
    ========================== */
    (function boot(){
      renderCategories();
      clearStage();
      setNoteIconState(); // noteVisible true => black inside
      diag("READY. Drop a screenshot or import HTML.");
      status("READY.");
      refreshPromptPreview();
    })();

  </script>
</body>
</html>
