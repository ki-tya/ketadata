<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KETADATA_PAD_ISOLATION_v1</title>
<style>
:root{
  --bg:#000; --fg:#fff; --muted:#8a8a8a; --line:#222; --line2:#333;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  --sans: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
}
*{box-sizing:border-box}
html,body{height:100%; margin:0}
body{background:var(--bg); color:var(--fg); font-family:var(--sans); overflow:hidden; user-select:none}
.btn{
  background:transparent; color:var(--fg);
  border:1px solid var(--line2);
  padding:6px 10px;
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
  cursor:pointer;
}
.btn:hover{border-color:var(--fg)}
.btn:active{transform:translateY(1px)}
input,textarea{outline:none}
textarea{
  width:100%;
  border:1px solid var(--line2);
  background:#050505;
  color:var(--fg);
  font-family:var(--mono);
  font-size:11px;
  padding:10px;
  line-height:1.35;
  resize:vertical;
  min-height:120px;
}

/* Top */
.topbar{
  position:absolute; top:0; left:0; right:0; height:44px;
  display:flex; align-items:center; justify-content:space-between;
  padding:0 10px; border-bottom:1px solid var(--line);
  background:linear-gradient(180deg,#070707,#000);
  z-index:10;
}
.brand{display:flex; align-items:center; gap:10px; font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase}
.brand .sq{width:10px; height:10px; border:1px solid var(--fg); background:#000}
.kbd{border:1px solid var(--line2); padding:2px 6px; color:var(--muted); font-size:11px; font-family:var(--mono)}

/* Armed bar */
#armedBar{
  position:absolute; left:10px; top:54px;
  z-index:20;
  display:none;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
  padding:8px 10px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,0.86);
  font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase;
}
#armedBar .label{color:var(--muted)}
#armedBar input{
  background:#000; color:#fff; border:1px solid var(--line2);
  padding:6px 8px; font-family:var(--mono); font-size:11px; letter-spacing:.08em;
  width:420px; max-width:calc(100vw - 40px);
}

/* Active strip */
#activeStrip{
  position:absolute; left:10px; top:112px;
  z-index:19; display:flex; gap:8px; flex-wrap:wrap; align-items:center;
  padding:8px 10px; border:1px solid var(--line2);
  background:rgba(0,0,0,0.86);
  font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase;
}
#activeStrip .label{color:var(--muted)}

/* Pad */
#padPanel{
  position:absolute;
  left:14px;
  top:170px;
  width:360px;
  height:360px;
  z-index:30;
  border:1px solid rgba(255,255,255,0.22);
  background:rgba(0,0,0,0.86);
  backdrop-filter:blur(6px);
  overflow:hidden;
  resize:both;
  min-width:340px;
  min-height:260px;
  display:flex;
  flex-direction:column;
}
#padHead{
  padding:8px 10px;
  border-bottom:1px solid rgba(255,255,255,0.14);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.14em;
  text-transform:uppercase;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:move;
}
#padBody{padding:10px; min-height:0; flex:1; display:flex; flex-direction:column; gap:10px}
#padGrid{
  flex:1;
  display:grid;
  grid-template-columns:repeat(4, 1fr);
  grid-template-rows:repeat(4, 1fr);
  gap:8px;
  min-height:0;
}
.padCell{
  border:1px solid rgba(255,255,255,0.18);
  background:rgba(0,0,0,0.35);
  padding:8px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  gap:6px;
  min-width:0;
}
.padCell .nm{
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  opacity:.95;
}
.padCell .ln{
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.02em;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  border-bottom:1px solid rgba(255,255,255,0.18);
  padding-bottom:2px;
  opacity:.88;
}
.padCell input{
  width:100%;
  background:#000;
  color:#fff;
  border:1px solid rgba(255,255,255,0.22);
  padding:6px 8px;
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.06em;
  min-width:0;
}
.hint{
  display:flex; justify-content:space-between; align-items:center;
  font-family:var(--mono); font-size:11px; color:var(--muted);
  letter-spacing:.08em; text-transform:uppercase;
}

/* Set editor (minimal) */
#editor{
  position:absolute;
  right:14px;
  top:54px;
  width:440px;
  height:calc(100vh - 68px);
  z-index:18;
  border:1px solid var(--line2);
  background:rgba(0,0,0,0.86);
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
#editorHead{
  padding:8px 10px;
  border-bottom:1px solid var(--line);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.14em;
  text-transform:uppercase;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
#editorBody{padding:10px; overflow:auto; min-height:0; flex:1}
.rowLine{
  display:flex; gap:8px; align-items:center;
  font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted);
  margin-bottom:8px;
}
.rowLine input{
  flex:1;
  background:#000; color:#fff; border:1px solid var(--line2);
  padding:6px 8px; font-family:var(--mono); font-size:11px; letter-spacing:.06em;
}
.small{font-family:var(--mono); font-size:11px; color:var(--muted); letter-spacing:.06em; text-transform:uppercase}
#setList{display:flex; flex-direction:column; gap:6px; margin-top:10px}
.setRow{
  border:1px solid var(--line2);
  padding:8px 10px;
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.06em;
  text-transform:uppercase;
  display:flex;
  gap:8px;
  align-items:center;
  cursor:pointer;
}
.setRow .nm{flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.setRow .ct{color:var(--muted)}
.setRow.active{border-color:var(--fg)}
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <span class="sq"></span>
      <span>KETADATA // PAD</span>
      <span style="color:var(--muted); letter-spacing:.02em; text-transform:none">isolation v1</span>
    </div>
    <div style="display:flex; gap:10px; align-items:center">
      <button class="btn" id="btnExport">EXPORT</button>
      <button class="btn" id="btnImport">IMPORT</button>
      <span class="kbd" title="Pad edit toggle">E</span>
      <span class="kbd" title="Escape clears armed">Esc</span>
    </div>
  </div>

  <div id="armedBar">
    <span class="label">ARMED</span>
    <span id="armedName">—</span>
    <button class="btn" id="armedGo" style="padding:4px 8px">GO</button>
    <button class="btn" id="armedNewTab" style="padding:4px 8px">NEW TAB</button>
    <button class="btn" id="armedCopy" style="padding:4px 8px">COPY</button>
    <input id="armedUrl" readonly value="—" />
  </div>

  <div id="activeStrip">
    <span class="label">ACTIVE</span>
    <span id="activeHint" style="color:var(--muted)">SLOTS 1–16</span>
  </div>

  <!-- PAD -->
  <div id="padPanel">
    <div id="padHead">
      <span id="padTitle">PAD</span>
      <div style="display:flex; gap:8px; align-items:center">
        <button class="btn" id="padEditBtn" style="padding:4px 8px">EDIT</button>
      </div>
    </div>
    <div id="padBody">
      <div id="padGrid"></div>
      <div class="hint">
        <span id="padHint">CLICK = SELECT SET (ARMS FIRST ITEM)</span>
        <span id="padSetId" style="opacity:.7">—</span>
      </div>
    </div>
  </div>

  <!-- Minimal set registry/editor -->
  <div id="editor">
    <div id="editorHead">
      <span>SETS</span>
      <span id="sig" style="color:var(--muted)">∅</span>
    </div>
    <div id="editorBody">
      <div class="rowLine">
        <span style="min-width:52px">SET</span>
        <input id="setName" placeholder="NAME" spellcheck="false" autocomplete="off" />
      </div>

      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px">
        <button class="btn" id="btnCreate">CREATE</button>
        <button class="btn" id="btnRename">RENAME</button>
        <button class="btn" id="btnDelete">DELETE</button>
        <button class="btn" id="btnToActive">ADD→ACTIVE</button>
      </div>

      <div class="small">BULK ITEMS: NAME | URL  OR URL</div>
      <textarea id="setItems" placeholder="ITEMS:
NAME | URL
OR URL" spellcheck="false"></textarea>

      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px">
        <button class="btn" id="btnSaveItems">SAVE ITEMS</button>
        <button class="btn" id="btnClearItems">CLEAR</button>
      </div>

      <div style="margin-top:14px; border-top:1px solid var(--line); padding-top:10px" class="small">
        SET LIST (CLICK = LOAD EDITOR)
      </div>
      <div id="setList"></div>
    </div>
  </div>

  <input id="file" type="file" accept="application/json" style="display:none" />

<script>
/* =========
LOCAL-FIRST (PER-FILE)
========= */
function uid8(){
  const a=new Uint32Array(1);
  try{crypto.getRandomValues(a);}catch(e){a[0]=Math.floor(Math.random()*1e9);}
  return (a[0]>>>0).toString(16).padStart(8,"0");
}
function hash8(str){
  const s=String(str||"");
  let h=2166136261;
  for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,16777619);}
  return (h>>>0).toString(16).slice(0,8);
}
function nowISO(){return new Date().toISOString();}
const $=(id)=>document.getElementById(id);

const PAGE_ID="KDT_PAD_ISO_V1";
const KEY_PREFIX="KDT::PAD::"+hash8(location.pathname+"|"+PAGE_ID);
const STORAGE_KEY=KEY_PREFIX+"::STATE";

function load(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}
function save(s){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }catch(e){}
}

/* =========
STATE
========= */
const DEFAULT={
  version:PAGE_ID,
  updatedAt:nowISO(),
  ui:{
    padEdit:false,
    padRect:{x:14,y:170,w:360,h:360},
    activeSets:Array.from({length:16},()=>""), // 16 set IDs (or "")
    activeSetId:"",
  },
  payload:{ sets:[] }
};

function canonName(x){return String(x||"").trim().toUpperCase();}
function deriveNameFromUrl(url){
  try{
    const u=new URL(url, location.href);
    const path=(u.pathname||"").split("/").filter(Boolean);
    const last=path.length?path[path.length-1]:(u.hostname||"LINK");
    return String(last).replace(/\.(html?|php|aspx|jsp)$/i,"").replace(/[-_]+/g," ").trim().toUpperCase()||"LINK";
  }catch(e){
    return String(url||"LINK").trim().slice(0,28).toUpperCase()||"LINK";
  }
}
function parseBulkLines(text){
  return String(text||"").split(/\r?\n/).map(l=>l.trim()).filter(l=>l && !l.startsWith("#")).map(l=>{
    let name="", url="";
    if(l.includes("|")){
      const parts=l.split("|");
      name=(parts[0]||"").trim();
      url=(parts.slice(1).join("|")||"").trim();
    }else url=l.trim();
    if(!url && name){ url=name; name=""; }
    if(!name) name=deriveNameFromUrl(url);
    return {name,url};
  }).filter(x=>x.url);
}
function deepFill(s){
  if(!s || typeof s!=="object") return structuredClone(DEFAULT);
  for(const k of Object.keys(DEFAULT)){ if(s[k]===undefined) s[k]=structuredClone(DEFAULT[k]); }
  if(!s.ui || typeof s.ui!=="object") s.ui={};
  for(const k of Object.keys(DEFAULT.ui)){ if(s.ui[k]===undefined) s.ui[k]=structuredClone(DEFAULT.ui[k]); }
  if(!s.payload || typeof s.payload!=="object") s.payload={};
  for(const k of Object.keys(DEFAULT.payload)){ if(s.payload[k]===undefined) s.payload[k]=structuredClone(DEFAULT.payload[k]); }

  if(!Array.isArray(s.ui.activeSets)) s.ui.activeSets=structuredClone(DEFAULT.ui.activeSets);
  if(!s.ui.padRect || typeof s.ui.padRect!=="object") s.ui.padRect=structuredClone(DEFAULT.ui.padRect);
  if(!Array.isArray(s.payload.sets)) s.payload.sets=[];
  s.payload.sets = s.payload.sets.map(set=>{
    const id=String((set&&set.id)||"").trim() || `SET_${uid8()}`;
    const label=canonName((set&&set.label)||"SET")||"SET";
    const items=Array.isArray(set&&set.items)?set.items:[];
    const norm=items.map(it=>{
      const url=String((it&&it.url)||"").trim(); if(!url) return null;
      const label2=canonName((it&&it.label)||"") || deriveNameFromUrl(url);
      return {label:label2,url};
    }).filter(Boolean);
    return {id,label,items:norm,createdAt:(set&&set.createdAt)||nowISO(),updatedAt:(set&&set.updatedAt)||nowISO()};
  });
  return s;
}

let STATE=deepFill(load());
let ACTIVE_SET_ID="";

/* =========
SETS
========= */
function getSetById(id){
  const sid=String(id||"").trim();
  return (STATE.payload.sets||[]).find(s=>String(s.id)===sid)||null;
}
function upsertSetByLabel(label){
  const L=canonName(label||"SET")||"SET";
  let s=(STATE.payload.sets||[]).find(x=>canonName(x.label)===L);
  if(!s){
    s={id:`SET_${uid8()}`,label:L,items:[],createdAt:nowISO(),updatedAt:nowISO()};
    STATE.payload.sets.unshift(s);
  }
  return s;
}
function createSet(label){
  const l=canonName(label||"SET")||"SET";
  const s={id:`SET_${uid8()}`,label:l,items:[],createdAt:nowISO(),updatedAt:nowISO()};
  STATE.payload.sets.unshift(s);
  return s;
}
function renameSet(id,newLabel){
  const s=getSetById(id); if(!s) return;
  s.label=canonName(newLabel||s.label||"SET")||"SET";
  s.updatedAt=nowISO();
}
function deleteSet(id){
  const sid=String(id||"").trim(); if(!sid) return;
  STATE.payload.sets=(STATE.payload.sets||[]).filter(s=>String(s.id)!==sid);
  // clear from active slots
  STATE.ui.activeSets = (STATE.ui.activeSets||[]).map(x=>String(x||"").trim()===sid ? "" : x);
  if(STATE.ui.activeSetId===sid) STATE.ui.activeSetId="";
  if(ACTIVE_SET_ID===sid) ACTIVE_SET_ID="";
}
function saveSetItems(id, bulkText){
  const s=getSetById(id); if(!s) return;
  const parsed=parseBulkLines(bulkText||"");
  s.items=parsed.map(x=>({label:canonName(x.name||"")||deriveNameFromUrl(x.url),url:String(x.url||"").trim()}));
  s.updatedAt=nowISO();
}
function setEditorFromSet(s){
  if(!s) return;
  ACTIVE_SET_ID=String(s.id);
  $("setName").value=canonName(s.label||"SET");
  $("setItems").value=(s.items||[]).map(it=>{
    const n=canonName(it.label||"")||deriveNameFromUrl(it.url);
    return `${n} | ${String(it.url||"").trim()}`;
  }).join("\n");
}

/* =========
ARMING (CLICK ARMS, GO COMMITS)
========= */
let ARMED={name:"", url:""};
function arm(name,url){
  ARMED.name=canonName(name||"LINK")||"LINK";
  ARMED.url=String(url||"").trim();
  $("armedName").textContent=ARMED.name||"—";
  $("armedUrl").value=ARMED.url||"—";
  $("armedBar").style.display = ARMED.url ? "flex" : "none";
}
function go(url){
  const u=String(url||"").trim(); if(!u) return;
  save(STATE);
  window.location.href=u;
}
function openNewTab(url){
  const u=String(url||"").trim(); if(!u) return;
  save(STATE);
  window.open(u,"_blank","noopener,noreferrer");
}
async function copy(text){
  try{ await navigator.clipboard.writeText(String(text||"")); }catch(e){}
}

/* =========
PERSIST + SIG
========= */
function stableSig(){
  const core=JSON.stringify({
    v:STATE.version,
    a:STATE.ui.activeSets,
    e:STATE.ui.padEdit,
    s:(STATE.payload.sets||[]).map(x=>({id:x.id,l:x.label,n:(x.items||[]).length,u:x.updatedAt||""}))
  });
  let h=2166136261;
  for(let i=0;i<core.length;i++){h^=core.charCodeAt(i);h=Math.imul(h,16777619);}
  return (h>>>0).toString(16).slice(0,8);
}
function persist(renderAlso=true){
  STATE.updatedAt=nowISO();
  save(STATE);
  if(renderAlso) render();
}

/* =========
RENDER
========= */
function renderActiveStrip(){
  const strip=$("activeStrip");
  // remove old buttons (keep label + hint)
  Array.from(strip.querySelectorAll("button")).forEach(b=>b.remove());
  (STATE.ui.activeSets||[]).slice(0,16).forEach((sid, idx)=>{
    const s=getSetById(sid);
    const b=document.createElement("button");
    b.className="btn";
    b.style.padding="4px 8px";
    b.textContent = s ? canonName(s.label) : "—";
    if(s && String(STATE.ui.activeSetId||"")===String(s.id)) b.style.borderColor="var(--fg)";
    b.addEventListener("click",()=>{
      if(!s) return;
      STATE.ui.activeSetId=String(s.id);
      // arm first item
      const first=(s.items||[])[0];
      if(first && first.url) arm(first.label, first.url);
      persist(true);
    });
    b.title = `SLOT ${idx+1}`;
    strip.appendChild(b);
  });
}

function renderPad(){
  const grid=$("padGrid");
  grid.innerHTML="";

  const slots=(STATE.ui.activeSets||[]).slice(0,16);
  for(let i=0;i<16;i++){
    const sid=String(slots[i]||"").trim();
    const setObj=sid?getSetById(sid):null;

    const cell=document.createElement("div");
    cell.className="padCell";

    if(!STATE.ui.padEdit){
      const nm=document.createElement("div");
      nm.className="nm";
      nm.textContent=setObj ? canonName(setObj.label) : "—";

      const first=(setObj && (setObj.items||[])[0]) ? (setObj.items||[])[0] : null;
      const ln=document.createElement("div");
      ln.className="ln";
      ln.textContent = first && first.url ? String(first.url).trim() : "—";

      cell.appendChild(nm);
      cell.appendChild(ln);

      cell.addEventListener("click",()=>{
        if(!setObj) return;
        STATE.ui.activeSetId=String(setObj.id);
        $("padSetId").textContent = setObj.id;
        if(first && first.url) arm(first.label, first.url);
        persist(true);
      });
    }else{
      const nmIn=document.createElement("input");
      nmIn.value=setObj ? String(setObj.label||"") : "";
      nmIn.placeholder="SET NAME";
      cell.appendChild(nmIn);

      const commit=()=>{
        const label=canonName(nmIn.value||"");
        if(!label){
          STATE.ui.activeSets[i]="";
          persist(true);
          return;
        }
        const s=upsertSetByLabel(label);
        STATE.ui.activeSets[i]=String(s.id);
        if(!STATE.ui.activeSetId) STATE.ui.activeSetId=String(s.id);
        persist(true);
      };
      nmIn.addEventListener("keydown",(ev)=>{ if(ev.key==="Enter"){ ev.preventDefault(); nmIn.blur(); }});
      nmIn.addEventListener("blur", commit);

      // dblclick clears slot quickly
      cell.addEventListener("dblclick",(ev)=>{ ev.preventDefault(); nmIn.value=""; nmIn.focus(); });
    }

    grid.appendChild(cell);
  }

  $("padEditBtn").textContent = STATE.ui.padEdit ? "DONE" : "EDIT";
  $("padSetId").textContent = STATE.ui.activeSetId ? String(STATE.ui.activeSetId) : "—";
}

function renderSetList(){
  const el=$("setList");
  el.innerHTML="";
  const sets=(STATE.payload.sets||[]).slice().sort((a,b)=>{
    const ta=Date.parse(a.updatedAt||a.createdAt||0);
    const tb=Date.parse(b.updatedAt||b.createdAt||0);
    return tb-ta;
  });

  sets.forEach(s=>{
    const row=document.createElement("div");
    row.className="setRow"+(String(ACTIVE_SET_ID||"")===String(s.id) ? " active":"");
    const nm=document.createElement("div");
    nm.className="nm";
    nm.textContent=canonName(s.label);
    const ct=document.createElement("div");
    ct.className="ct";
    ct.textContent=`${(s.items||[]).length} ITEMS`;
    row.appendChild(nm); row.appendChild(ct);

    row.addEventListener("click",()=>{ setEditorFromSet(s); persist(true); });
    el.appendChild(row);
  });
}

function applyPadRect(){
  const p=$("padPanel");
  const r=STATE.ui.padRect||{};
  if(r.x!=null) p.style.left=Math.round(r.x)+"px";
  if(r.y!=null) p.style.top=Math.round(r.y)+"px";
  if(r.w!=null) p.style.width=Math.round(r.w)+"px";
  if(r.h!=null) p.style.height=Math.round(r.h)+"px";
}

function render(){
  $("sig").textContent = stableSig();
  renderActiveStrip();
  renderPad();
  renderSetList();
  $("armedBar").style.display = ARMED.url ? "flex" : "none";
}

/* =========
EXPORT / IMPORT (REAL DOWNLOAD)
========= */
function exportFilename(){
  const sig=stableSig();
  const stamp=new Date().toISOString().replace(/[:.]/g,"-");
  return `KDT_PAD_${sig}_${stamp}.json`;
}
function downloadJsonFile(filename, text){
  const blob=new Blob([String(text||"")], {type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=filename||"KDT_PAD_STATE.json";
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 250);
}
function exportState(){
  return JSON.stringify({ STORAGE_KEY, STATE }, null, 2);
}
function importState(text){
  const parsed=JSON.parse(text);
  const incoming=(parsed && parsed.STATE) ? parsed.STATE : parsed;
  STATE=deepFill(incoming);
  ACTIVE_SET_ID="";
  ARMED={name:"",url:""};
  persist(true);
}

/* =========
WIRING
========= */
function bindUI(){
  $("armedGo").addEventListener("click",()=>go(ARMED.url));
  $("armedNewTab").addEventListener("click",()=>openNewTab(ARMED.url));
  $("armedCopy").addEventListener("click",()=>copy(ARMED.url||""));

  $("padEditBtn").addEventListener("click",()=>{ STATE.ui.padEdit=!STATE.ui.padEdit; persist(true); });

  $("btnCreate").addEventListener("click",()=>{
    const s=createSet($("setName").value||"SET");
    setEditorFromSet(s);
    persist(true);
  });
  $("btnRename").addEventListener("click",()=>{
    if(!ACTIVE_SET_ID) return;
    renameSet(ACTIVE_SET_ID, $("setName").value||"SET");
    persist(true);
  });
  $("btnDelete").addEventListener("click",()=>{
    if(!ACTIVE_SET_ID) return;
    deleteSet(ACTIVE_SET_ID);
    $("setName").value=""; $("setItems").value="";
    persist(true);
  });
  $("btnSaveItems").addEventListener("click",()=>{
    if(!ACTIVE_SET_ID) return;
    saveSetItems(ACTIVE_SET_ID, $("setItems").value||"");
    // keep activeSetId stable
    persist(true);
  });
  $("btnClearItems").addEventListener("click",()=>{ $("setItems").value=""; persist(true); });

  $("btnToActive").addEventListener("click",()=>{
    if(!ACTIVE_SET_ID) return;
    // first empty slot wins
    const slots=STATE.ui.activeSets||[];
    let placed=false;
    for(let i=0;i<16;i++){
      if(!String(slots[i]||"").trim()){
        slots[i]=String(ACTIVE_SET_ID);
        placed=true;
        break;
      }
    }
    if(!placed) slots[15]=String(ACTIVE_SET_ID);
    STATE.ui.activeSetId=String(ACTIVE_SET_ID);
    persist(true);
  });

  $("btnExport").addEventListener("click",()=>downloadJsonFile(exportFilename(), exportState()));
  $("btnImport").addEventListener("click",()=>$("file").click());
  $("file").addEventListener("change",(ev)=>{
    const f=ev.target.files && ev.target.files[0];
    if(!f) return;
    const r=new FileReader();
    r.onload=()=>{ try{ importState(String(r.result||"")); }catch(e){} };
    r.readAsText(f);
    ev.target.value="";
  });

  // Hotkeys: E toggles pad edit; Esc clears armed.
  window.addEventListener("keydown",(ev)=>{
    const ae=document.activeElement;
    const typing = ae && (ae.tagName==="TEXTAREA" || ae.tagName==="INPUT");
    if(typing) return;

    if(ev.key==="e" || ev.key==="E"){
      ev.preventDefault();
      STATE.ui.padEdit=!STATE.ui.padEdit;
      persist(true);
      return;
    }
    if(ev.key==="Escape"){
      ev.preventDefault();
      ARMED={name:"",url:""};
      $("armedBar").style.display="none";
      persist(true);
    }
  }, {passive:false});
}

/* draggable pad */
function bindPadDrag(){
  const head=$("padHead");
  const panel=$("padPanel");
  let dragging=false, sx=0, sy=0, ox=0, oy=0;

  function applyPos(x,y){
    panel.style.left=x+"px";
    panel.style.top=y+"px";
    STATE.ui.padRect.x=x;
    STATE.ui.padRect.y=y;
  }

  head.addEventListener("mousedown",(ev)=>{
    dragging=true;
    sx=ev.clientX; sy=ev.clientY;
    const r=panel.getBoundingClientRect();
    ox=r.left; oy=r.top;
    ev.preventDefault();
  });
  window.addEventListener("mousemove",(ev)=>{
    if(!dragging) return;
    const nx=Math.max(6, Math.min(window.innerWidth-60, ox+(ev.clientX-sx)));
    const ny=Math.max(50, Math.min(window.innerHeight-60, oy+(ev.clientY-sy)));
    applyPos(Math.round(nx), Math.round(ny));
  });
  window.addEventListener("mouseup",()=>{
    if(!dragging) return;
    dragging=false;
    const r=panel.getBoundingClientRect();
    STATE.ui.padRect.w=Math.round(r.width);
    STATE.ui.padRect.h=Math.round(r.height);
    persist(true);
  });
}

/* boot */
(function boot(){
  STATE=deepFill(STATE);
  applyPadRect();
  bindUI();
  bindPadDrag();
  render();
})();
</script>
</body>
</html>
