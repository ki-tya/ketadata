<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>KETADATA LINK SET ARRANGER · 6 VARIANT MOCKUPS</title>
  <style>
    :root{
      --bg:#0a0a0a;
      --fg:#f2f2f2;
      --mut:#bdbdbd;
      --dim:#7a7a7a;
      --line:rgba(255,255,255,0.22);
      --line2:rgba(255,255,255,0.12);
      --panel:rgba(0,0,0,0.55);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --ui: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --fs:12px; /* SAME SIZE LAW */
      --lh:1.25;
      --r:0px;
      --gap:10px;
      --pad:10px;
      --shadow: 0 10px 35px rgba(0,0,0,0.45);
    }
    html,body{height:100%;}
    body{
      margin:0; overflow:hidden;
      background:var(--bg);
      color:var(--fg);
      font-family:var(--ui);
      font-size:var(--fs);
      line-height:var(--lh);
      letter-spacing:0.02em;
    }
    *{box-sizing:border-box;}
    button,input,textarea,select{
      font:inherit; font-size:var(--fs); line-height:var(--lh);
      letter-spacing:0.02em;
      color:var(--fg);
      background:#000;
      border:1px solid var(--line2);
      border-radius:var(--r);
      padding:6px 8px;
      outline:none;
    }
    button{cursor:pointer;background:rgba(0,0,0,0.35);}
    button:hover{border-color:var(--line);}
    button:active{transform:translateY(1px);}
    input[type="range"]{padding:0;height:20px;}
    a{color:var(--fg);text-decoration:none;border-bottom:1px solid transparent;}
    a:hover{border-bottom:1px solid var(--line);}
    .mono{font-family:var(--mono);}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:3px 6px;
      border:1px solid var(--line2);
      background:rgba(0,0,0,0.25);
      color:var(--mut);
      font-family:var(--mono);
      text-transform:uppercase;
      letter-spacing:0.08em;
      user-select:none;
      cursor:pointer;
    }
    .pill:hover{border-color:var(--line); color:var(--fg);}
    .pill.on{border-color:var(--line); color:var(--fg); background:rgba(255,255,255,0.06);}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 8px;
      border:1px solid var(--line2);
      background:rgba(0,0,0,0.25);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03);
    }
    .badge .k{color:var(--mut);}
    .badge .v{color:var(--fg); font-family:var(--mono);}

    .topbar{
      position:fixed; left:0; right:0; top:0; height:44px;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 12px;
      border-bottom:1px solid var(--line2);
      background:linear-gradient(to bottom, rgba(0,0,0,0.70), rgba(0,0,0,0.35));
      backdrop-filter: blur(10px);
      z-index:50;
    }
    .topbar .left,.topbar .right{display:flex;align-items:center;gap:8px;min-width:180px;}
    .topbar .center{flex:1;display:flex;justify-content:center;gap:10px;pointer-events:none;user-select:none;}
    .main{
      position:fixed; left:0; right:0; top:44px; bottom:0;
      display:grid;
      grid-template-columns: 420px 1fr 420px;
      overflow:hidden;
    }
    .panel{
      overflow:hidden;
      display:flex;
      flex-direction:column;
      background:rgba(0,0,0,0.25);
      border-right:1px solid var(--line2);
      min-width:340px;
    }
    .panel.right{border-right:none;border-left:1px solid var(--line2);}
    .panelHead{
      padding:10px;
      border-bottom:1px solid var(--line2);
      background:rgba(0,0,0,0.35);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    .panelHead .title{
      font-weight:900;
      letter-spacing:0.14em;
      text-transform:uppercase;
    }
    .panelBody{padding:10px; overflow:auto; height:100%;}
    .sep{height:1px;background:var(--line2);margin:10px 0;}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    textarea{width:100%;min-height:220px;resize:vertical;background:#000;}
    .hint{color:var(--dim);font-family:var(--mono);letter-spacing:0.06em;text-transform:uppercase;}
    .k{color:var(--mut);}
    .stage{overflow:hidden; display:flex; flex-direction:column;}
    .stageBar{
      padding:10px;
      border-bottom:1px solid var(--line2);
      background:rgba(0,0,0,0.25);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .stageBar .left, .stageBar .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}

    /* shared card */
    .card{
      border:1px solid var(--line2);
      background:rgba(0,0,0,0.35);
      padding:8px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .card .lbl{
      font-weight:800;
      letter-spacing:0.08em;
      text-transform:uppercase;
      word-break:break-word;
    }
    .card .path{
      color:var(--dim);
      font-family:var(--mono);
      word-break:break-all;
      margin-top:2px;
    }
    .card .note{color:var(--mut);font-family:var(--mono);word-break:break-word;}

    /* VARIANT STAGE LAYOUTS */
    .variantWrap{height:100%; overflow:auto; padding:10px;}
    .v1_cols{
      display:grid;
      grid-auto-flow:column;
      grid-auto-columns:minmax(320px,1fr);
      gap:10px;
      align-items:start;
    }
    .lane{
      border:1px solid var(--line2);
      background:rgba(0,0,0,0.25);
      display:flex;
      flex-direction:column;
      min-height:220px;
    }
    .laneHead{
      padding:10px;
      border-bottom:1px solid var(--line2);
      background:rgba(0,0,0,0.35);
      display:flex;
      justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    .laneHead .name{font-weight:900;letter-spacing:0.14em;text-transform:uppercase;}
    .laneHead .meta{color:var(--dim);font-family:var(--mono);}
    .laneBody{padding:10px;display:flex;flex-direction:column;gap:8px;min-height:220px;}

    /* V2: PACKS (horizontal sticker packs) */
    .v2_packs{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .pack{
      border:1px solid var(--line2);
      background:rgba(0,0,0,0.25);
    }
    .packHead{
      padding:10px;
      border-bottom:1px solid var(--line2);
      background:rgba(0,0,0,0.35);
      display:flex;justify-content:space-between;gap:10px;
      user-select:none;
    }
    .packGrid{
      padding:10px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:8px;
    }
    @media (max-width: 1200px){
      .packGrid{grid-template-columns: repeat(3, minmax(0,1fr));}
    }
    @media (max-width: 980px){
      .packGrid{grid-template-columns: repeat(2, minmax(0,1fr));}
    }

    /* V3: PAD MAP */
    .v3_padwrap{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:10px;
      align-items:start;
    }
    .pad{
      border:1px solid var(--line2);
      background:rgba(0,0,0,0.25);
      padding:10px;
    }
    .padGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:8px;
      margin-top:10px;
    }
    .key{
      border:1px solid var(--line2);
      background:rgba(0,0,0,0.35);
      padding:12px 8px;
      text-align:center;
      font-family:var(--mono);
      letter-spacing:0.12em;
      user-select:none;
      cursor:pointer;
    }
    .key:hover{border-color:var(--line);}
    .key.on{border-color:var(--line); background:rgba(255,255,255,0.06);}

    .slotBoard{
      border:1px solid var(--line2);
      background:rgba(0,0,0,0.25);
      padding:10px;
      min-height:260px;
    }
    .slots{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:8px;
      margin-top:10px;
    }
    .slot{
      border:1px solid var(--line2);
      background:rgba(0,0,0,0.35);
      padding:8px;
      min-height:70px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .slot .slotId{color:var(--dim);font-family:var(--mono);}
    .slot .slotLbl{font-weight:800;letter-spacing:0.08em;text-transform:uppercase;word-break:break-word;}
    .slot .slotPath{color:var(--dim);font-family:var(--mono);word-break:break-all;}

    /* V4: STACK (vertical stack lanes, minimal scroll) */
    .v4_stack{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* V5: CINEMA (full-width set focus + filmstrip) */
    .v5_cinema{
      display:grid;
      grid-template-rows: auto 1fr auto;
      gap:10px;
      min-height: calc(100vh - 44px - 20px - 64px);
    }
    .focus{
      border:1px solid var(--line2);
      background:rgba(0,0,0,0.25);
      padding:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .filmstrip{
      border:1px solid var(--line2);
      background:rgba(0,0,0,0.25);
      padding:10px;
      overflow:auto;
      display:flex;
      gap:8px;
      align-items:stretch;
    }
    .filmstrip .card{min-width: 260px;}

    /* V6: TERMINAL GRID (dense matrix) */
    .v6_matrix{
      border:1px solid var(--line2);
      background:rgba(0,0,0,0.25);
      padding:10px;
    }
    .matrixGrid{
      display:grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap:8px;
    }
    @media (max-width: 1200px){ .matrixGrid{grid-template-columns: repeat(4, minmax(0,1fr));} }
    @media (max-width: 980px){ .matrixGrid{grid-template-columns: repeat(3, minmax(0,1fr));} }

    .ghost{opacity:0.75;}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="left">
      <div class="badge">
        <span class="k">APP</span>
        <span class="v">KETADATA_LINK_SET_ARRANGER_MOCKUPS</span>
      </div>
    </div>
    <div class="center">
      <div class="badge">
        <span class="k">VARIANT</span>
        <span class="v" id="variantName">V1 COLUMNS</span>
      </div>
      <div class="badge">
        <span class="k">SETS</span>
        <span class="v" id="setCount">0</span>
      </div>
      <div class="badge">
        <span class="k">LINKS</span>
        <span class="v" id="linkCount">0</span>
      </div>
    </div>
    <div class="right">
      <button id="btnExport">EXPORT</button>
      <button id="btnImport">IMPORT</button>
      <input id="filePick" type="file" accept="application/json" style="display:none"/>
    </div>
  </div>

  <div class="main">
    <div class="panel">
      <div class="panelHead">
        <div class="title">INPUT</div>
        <div class="row">
          <button id="btnParse">PARSE</button>
          <button id="btnClean">CLEAN</button>
        </div>
      </div>
      <div class="panelBody">
        <div class="hint">
          PASTE YOUR LINK TRIAGE EXPORT JSON → PARSE.
          <br/>USE VARIANTS AS MOCKUPS; DATA MODEL STAYS THE SAME.
        </div>
        <div class="sep"></div>
        <textarea id="inputArea" class="mono" spellcheck="false" placeholder="PASTE JSON HERE"></textarea>
        <div class="sep"></div>
        <div class="row">
          <span class="pill on" id="v1">V1 COLUMNS</span>
          <span class="pill" id="v2">V2 PACKS</span>
          <span class="pill" id="v3">V3 PAD MAP</span>
          <span class="pill" id="v4">V4 STACK</span>
          <span class="pill" id="v5">V5 CINEMA</span>
          <span class="pill" id="v6">V6 MATRIX</span>
        </div>
        <div class="sep"></div>
        <div class="row">
          <input id="search" class="mono" placeholder="SEARCH" style="flex:1; min-width: 180px;"/>
          <span class="pill" id="filterPill">FILTER: ACTIVE</span>
          <span class="pill" id="toggleFilter">TOGGLE</span>
        </div>
        <div class="sep"></div>
        <div class="row">
          <button id="btnSaveLocal">SAVE</button>
          <button id="btnLoadLocal">LOAD</button>
          <button id="btnReset">RESET</button>
        </div>
      </div>
    </div>

    <div class="stage">
      <div class="stageBar">
        <div class="left">
          <div class="badge">
            <span class="k">FOCUS SET</span>
            <span class="v" id="focusSetName">—</span>
          </div>
          <span class="pill" id="prevSet">PREV</span>
          <span class="pill" id="nextSet">NEXT</span>
        </div>
        <div class="right">
          <div class="badge">
            <span class="k">VISIBLE</span>
            <span class="v" id="visibleCount">0</span>
          </div>
        </div>
      </div>
      <div class="variantWrap" id="variantWrap"></div>
    </div>

    <div class="panel right">
      <div class="panelHead">
        <div class="title">NOTES</div>
        <div class="row">
          <button id="btnOpenSelected" disabled>OPEN</button>
          <button id="btnCopyUrl" disabled>COPY URL</button>
        </div>
      </div>
      <div class="panelBody">
        <div class="hint">
          THIS IS A MOCKUP APPARATUS: 6 VIEW MODES SHARE ONE DATA MODEL.
          <br/>EXPORT IS A REAL DOWNLOAD. IMPORT IS FILE PICKER.
          <br/>EDITING/DRAGGING NOT IMPLEMENTED HERE (USE THE ARRANGER FILE FOR THAT).
        </div>
        <div class="sep"></div>
        <div class="badge">
          <span class="k">SELECTED</span>
          <span class="v" id="selId">—</span>
        </div>
        <div class="sep"></div>
        <div class="row">
          <div class="hint">SCOPE</div>
        </div>
        <div class="row">
          <div class="badge"><span class="k">LANE</span><span class="v" id="selLane">—</span></div>
          <div class="badge"><span class="k">STATUS</span><span class="v" id="selStatus">—</span></div>
        </div>
        <div class="sep"></div>
        <div class="row"><div class="hint">NOTE</div></div>
        <div class="row"><input id="selNote" class="mono" disabled style="width:100%"/></div>
        <div class="row"><div class="hint">PATH</div></div>
        <div class="row"><input id="selPath" class="mono" disabled style="width:100%"/></div>
        <div class="row"><div class="hint">URL</div></div>
        <div class="row"><input id="selUrl" class="mono" disabled style="width:100%"/></div>
      </div>
    </div>
  </div>

  <script>
    const FILE_ID="KETADATA_LINK_SET_ARRANGER_MOCKUPS";
    const ROOM_ID="BASE_TOOL";
    const VERSION_ID="v1_6_variants_mockups";
    const STORAGE_KEY=`KDT::STATE::${FILE_ID}::${ROOM_ID}::${VERSION_ID}`;

    const $=(id)=>document.getElementById(id);

    const UI={
      inputArea:$("inputArea"),
      variantWrap:$("variantWrap"),
      variantName:$("variantName"),
      setCount:$("setCount"),
      linkCount:$("linkCount"),
      visibleCount:$("visibleCount"),
      focusSetName:$("focusSetName"),
      search:$("search"),
      filterPill:$("filterPill"),
      sel:{
        id:$("selId"), lane:$("selLane"), status:$("selStatus"),
        note:$("selNote"), path:$("selPath"), url:$("selUrl")
      },
      btn:{
        parse:$("btnParse"),
        clean:$("btnClean"),
        export:$("btnExport"),
        import:$("btnImport"),
        filePick:$("filePick"),
        saveLocal:$("btnSaveLocal"),
        loadLocal:$("btnLoadLocal"),
        reset:$("btnReset"),
        toggleFilter:$("toggleFilter"),
        prevSet:$("prevSet"),
        nextSet:$("nextSet"),
        openSelected:$("btnOpenSelected"),
        copyUrl:$("btnCopyUrl"),
      },
      vbtn:{ v1:$("v1"), v2:$("v2"), v3:$("v3"), v4:$("v4"), v5:$("v5"), v6:$("v6") }
    };

    const DEFAULT=()=>({
      version:"KETADATA_LINK_SET_MOCKUPS_v1",
      updatedAt:new Date().toISOString(),
      ui:{ variant:"v1", filter:"active", search:"", focusLaneIndex:0 },
      lanes:[
        {id:"L0",name:"INBOX",deprecated:false},
        {id:"L1",name:"CORE",deprecated:false},
        {id:"L2",name:"EXPERIMENTS",deprecated:false},
        {id:"L3",name:"DEPRECATED",deprecated:true}
      ],
      order:{},
      links:{}
    });

    let STATE=DEFAULT();
    let SELECTED_ID=null;

    function safeStr(x){return (x===null||x===undefined)?"":String(x);}
    function nowISO(){return new Date().toISOString();}
    function escapeHtml(s){
      return safeStr(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function inferLabel(path){
      const p=safeStr(path).trim();
      if(!p) return "[UNLABELED]";
      const base=p.split("/").pop();
      return `[${base.toUpperCase()}]`;
    }

    function normalizeLink(id, obj){
      const path=safeStr(obj.path||id).trim();
      const url=safeStr(obj.url).trim();
      const laneId=safeStr(obj.laneId||"L0").trim()||"L0";
      let status=safeStr(obj.status||"active").toLowerCase();
      if(status!=="active" && status!=="deprecated") status="active";
      const note=safeStr(obj.note).trim();
      return { id, path, url, laneId, status, note, display: note?note:inferLabel(path) };
    }

    function ensureOrder(){
      if(!STATE.order) STATE.order={};
      for(const ln of STATE.lanes){
        if(!Array.isArray(STATE.order[ln.id])) STATE.order[ln.id]=[];
      }
      const seen=new Set();
      for(const ln of STATE.lanes){
        const arr=STATE.order[ln.id];
        for(let i=arr.length-1;i>=0;i--){
          const id=arr[i];
          if(!STATE.links[id] || seen.has(id)) arr.splice(i,1);
          else seen.add(id);
        }
      }
      for(const id of Object.keys(STATE.links)){
        if(seen.has(id)) continue;
        const laneId=STATE.links[id].laneId||"L0";
        if(!Array.isArray(STATE.order[laneId])) STATE.order[laneId]=[];
        STATE.order[laneId].push(id);
        seen.add(id);
      }
    }

    function passes(link){
      const f=STATE.ui.filter;
      if(f==="active" && link.status!=="active") return false;
      if(f==="deprecated" && link.status!=="deprecated") return false;

      const q=safeStr(STATE.ui.search).trim().toLowerCase();
      if(q){
        const hay=[link.id,link.path,link.url,link.note,link.laneId,link.status].join(" ").toLowerCase();
        if(!hay.includes(q)) return false;
      }
      return true;
    }

    function lanesVisible(){
      // focus order is lane order; treat lanes as sets
      return STATE.lanes;
    }

    function focusLane(){
      const ls=lanesVisible();
      if(!ls.length) return null;
      const i=((STATE.ui.focusLaneIndex%ls.length)+ls.length)%ls.length;
      return ls[i];
    }

    function setVariant(v){
      STATE.ui.variant=v;
      for(const k of Object.keys(UI.vbtn)) UI.vbtn[k].classList.remove("on");
      UI.vbtn[v].classList.add("on");
      const name={
        v1:"V1 COLUMNS",
        v2:"V2 PACKS",
        v3:"V3 PAD MAP",
        v4:"V4 STACK",
        v5:"V5 CINEMA",
        v6:"V6 MATRIX"
      }[v] || "V1 COLUMNS";
      UI.variantName.textContent=name;
      render();
    }

    function setFilterPill(){
      UI.filterPill.textContent=`FILTER: ${STATE.ui.filter.toUpperCase()}`;
    }

    function select(id){
      SELECTED_ID=id;
      const L=STATE.links[id];
      UI.sel.id.textContent = id || "—";
      UI.sel.lane.textContent = L ? (STATE.lanes.find(x=>x.id===L.laneId)?.name || L.laneId) : "—";
      UI.sel.status.textContent = L ? L.status : "—";
      UI.sel.note.value = L ? safeStr(L.note) : "";
      UI.sel.path.value = L ? safeStr(L.path) : "";
      UI.sel.url.value = L ? safeStr(L.url) : "";
      const has = !!(L && L.url);
      UI.btn.openSelected.disabled = !has;
      UI.btn.copyUrl.disabled = !has;
    }

    function renderCard(link){
      return `
        <div class="card" data-id="${escapeHtml(link.id)}" style="${SELECTED_ID===link.id?'outline:1px solid rgba(255,255,255,0.35);':''}">
          <div class="lbl">${escapeHtml(link.display)}</div>
          <div class="path">${escapeHtml(link.path)}</div>
          <div class="note">${link.note ? escapeHtml(link.note) : `<span class="ghost mono">NO NOTE</span>`}</div>
        </div>
      `;
    }

    function bindCardClicks(){
      UI.variantWrap.querySelectorAll(".card").forEach(el=>{
        el.addEventListener("click", ()=>{
          const id = el.getAttribute("data-id");
          if(id && STATE.links[id]) select(id);
          render(); // re-outline selected
        });
      });
      UI.variantWrap.querySelectorAll(".key").forEach(el=>{
        el.addEventListener("click", ()=>{
          const laneIndex = Number(el.getAttribute("data-idx"));
          if(!Number.isNaN(laneIndex)){
            STATE.ui.focusLaneIndex = laneIndex;
            render();
          }
        });
      });
    }

    function renderV1(){
      const lanes = lanesVisible();
      let html = `<div class="v1_cols">`;
      for(const ln of lanes){
        const ids = (STATE.order[ln.id]||[]).filter(id=>STATE.links[id] && passes(STATE.links[id]));
        html += `
          <div class="lane">
            <div class="laneHead">
              <div class="name">${escapeHtml(ln.name)}</div>
              <div class="meta mono">${ln.id} · ${ln.deprecated?'deprecated':'active'}</div>
            </div>
            <div class="laneBody">
              ${ids.length ? ids.map(id=>renderCard(STATE.links[id])).join("") : `<div class="card"><div class="note mono ghost">EMPTY</div></div>`}
            </div>
          </div>
        `;
      }
      html += `</div>`;
      return html;
    }

    function renderV2(){
      const lanes = lanesVisible();
      let html = `<div class="v2_packs">`;
      for(const ln of lanes){
        const ids = (STATE.order[ln.id]||[]).filter(id=>STATE.links[id] && passes(STATE.links[id]));
        html += `
          <div class="pack">
            <div class="packHead">
              <div class="badge"><span class="k">PACK</span><span class="v">${escapeHtml(ln.name)}</span></div>
              <div class="badge"><span class="k">COUNT</span><span class="v">${ids.length}</span></div>
            </div>
            <div class="packGrid">
              ${ids.length ? ids.map(id=>renderCard(STATE.links[id])).join("") : `<div class="card"><div class="note mono ghost">EMPTY</div></div>`}
            </div>
          </div>
        `;
      }
      html += `</div>`;
      return html;
    }

    function renderV3(){
      const lanes = lanesVisible();
      const f = focusLane();
      const focusIds = f ? (STATE.order[f.id]||[]).filter(id=>STATE.links[id] && passes(STATE.links[id])) : [];
      let keys="";
      for(let i=0;i<Math.min(9, lanes.length); i++){
        keys += `<div class="key ${i===STATE.ui.focusLaneIndex?'on':''}" data-idx="${i}">${escapeHtml(lanes[i].name)}</div>`;
      }
      return `
        <div class="v3_padwrap">
          <div class="pad">
            <div class="badge"><span class="k">SETS</span><span class="v">SELECT</span></div>
            <div class="padGrid">${keys || `<div class="note mono ghost">NO SETS</div>`}</div>
            <div class="sep"></div>
            <div class="hint">CLICK SET NAME KEYS TO FOCUS</div>
          </div>
          <div class="slotBoard">
            <div class="badge"><span class="k">FOCUS</span><span class="v">${f?escapeHtml(f.name):"—"}</span></div>
            <div class="slots">
              ${Array.from({length:12}).map((_,i)=>{
                const link = focusIds[i] ? STATE.links[focusIds[i]] : null;
                return `
                  <div class="slot">
                    <div class="slotId">SLOT ${i+1}</div>
                    ${link ? `<div class="slotLbl">${escapeHtml(link.display)}</div><div class="slotPath">${escapeHtml(link.path)}</div>` : `<div class="slotPath ghost">EMPTY</div>`}
                  </div>
                `;
              }).join("")}
            </div>
          </div>
        </div>
      `;
    }

    function renderV4(){
      const lanes = lanesVisible();
      let html = `<div class="v4_stack">`;
      for(const ln of lanes){
        const ids = (STATE.order[ln.id]||[]).filter(id=>STATE.links[id] && passes(STATE.links[id]));
        html += `
          <div class="lane">
            <div class="laneHead">
              <div class="name">${escapeHtml(ln.name)}</div>
              <div class="meta mono">${ids.length} ITEMS</div>
            </div>
            <div class="laneBody">
              ${ids.length ? ids.map(id=>renderCard(STATE.links[id])).join("") : `<div class="card"><div class="note mono ghost">EMPTY</div></div>`}
            </div>
          </div>
        `;
      }
      html += `</div>`;
      return html;
    }

    function renderV5(){
      const lanes = lanesVisible();
      const f = focusLane();
      const focusIds = f ? (STATE.order[f.id]||[]).filter(id=>STATE.links[id] && passes(STATE.links[id])) : [];
      const strip = focusIds.slice(0, 40);
      const focusCard = focusIds[0] ? STATE.links[focusIds[0]] : null;

      return `
        <div class="v5_cinema">
          <div class="focus">
            <div class="badge"><span class="k">FOCUS SET</span><span class="v">${f?escapeHtml(f.name):"—"}</span></div>
            <div class="badge"><span class="k">FOCUS CARD</span><span class="v">${focusCard?escapeHtml(focusCard.display):"—"}</span></div>
          </div>
          <div class="lane" style="min-height:260px;">
            <div class="laneHead">
              <div class="name">FOCUS STACK</div>
              <div class="meta mono">${focusIds.length} ITEMS</div>
            </div>
            <div class="laneBody">
              ${(focusIds.slice(0, 10)).map(id=>renderCard(STATE.links[id])).join("") || `<div class="card"><div class="note mono ghost">EMPTY</div></div>`}
            </div>
          </div>
          <div class="filmstrip">
            ${strip.map(id=>renderCard(STATE.links[id])).join("") || `<div class="card"><div class="note mono ghost">EMPTY</div></div>`}
          </div>
        </div>
      `;
    }

    function renderV6(){
      // Dense matrix: all visible cards, grouped by lane in a single grid with lane headers
      const lanes = lanesVisible();
      let html = `<div class="v6_matrix">`;
      for(const ln of lanes){
        const ids = (STATE.order[ln.id]||[]).filter(id=>STATE.links[id] && passes(STATE.links[id]));
        html += `
          <div class="lane" style="margin-bottom:10px;">
            <div class="laneHead">
              <div class="name">${escapeHtml(ln.name)}</div>
              <div class="meta mono">${ids.length} ITEMS</div>
            </div>
            <div class="laneBody" style="padding:10px;">
              <div class="matrixGrid">
                ${ids.length ? ids.map(id=>renderCard(STATE.links[id])).join("") : `<div class="card"><div class="note mono ghost">EMPTY</div></div>`}
              </div>
            </div>
          </div>
        `;
      }
      html += `</div>`;
      return html;
    }

    function render(){
      ensureOrder();

      const lanes = lanesVisible();
      UI.setCount.textContent = String(lanes.length);
      UI.linkCount.textContent = String(Object.keys(STATE.links).length);

      const f = focusLane();
      UI.focusSetName.textContent = f ? `${f.name} (${f.id})` : "—";

      let visible=0;
      for(const id of Object.keys(STATE.links)){
        if(STATE.links[id] && passes(STATE.links[id])) visible++;
      }
      UI.visibleCount.textContent = String(visible);

      const v = STATE.ui.variant || "v1";
      const html = (v==="v1")?renderV1()
        :(v==="v2")?renderV2()
        :(v==="v3")?renderV3()
        :(v==="v4")?renderV4()
        :(v==="v5")?renderV5()
        :renderV6();

      UI.variantWrap.innerHTML = html;
      bindCardClicks();

      setFilterPill();

      // selection UI refresh
      if(SELECTED_ID && STATE.links[SELECTED_ID]) select(SELECTED_ID);
      else select(null);
    }

    function parseInputJson(){
      const raw = UI.inputArea.value.trim();
      if(!raw) throw new Error("EMPTY INPUT");
      return JSON.parse(raw);
    }

    function ingestTriage(obj){
      const next = DEFAULT();
      next.updatedAt = nowISO();
      // lanes
      if(Array.isArray(obj.lanes) && obj.lanes.length){
        next.lanes = obj.lanes.map(l=>({
          id: safeStr(l.id||"").trim() || crypto.randomUUID().slice(0,6).toUpperCase(),
          name: safeStr(l.name||"LANE").trim() || "LANE",
          deprecated: !!l.deprecated
        }));
      }
      // links
      const pagesBase = safeStr(obj?.repo?.pagesBase || "");
      const links = obj.links || {};
      for(const key of Object.keys(links)){
        const id = safeStr(key);
        const raw = links[key] || {};
        const draft = { ...raw };
        if(!draft.url && pagesBase && draft.path) draft.url = pagesBase + draft.path;
        next.links[id] = normalizeLink(id, draft);
      }
      // order
      next.order = {};
      for(const ln of next.lanes) next.order[ln.id]=[];
      const ids = Object.keys(next.links);
      ids.sort((a,b)=>{
        const A=next.links[a], B=next.links[b];
        if(A.laneId!==B.laneId) return (A.laneId||"").localeCompare(B.laneId||"");
        return (A.path||"").localeCompare(B.path||"");
      });
      for(const id of ids){
        const laneId = next.links[id].laneId || "L0";
        if(!Array.isArray(next.order[laneId])) next.order[laneId]=[];
        next.order[laneId].push(id);
      }
      return next;
    }

    function ingestArranger(obj){
      const next = DEFAULT();
      next.version = safeStr(obj.version||next.version);
      next.updatedAt = nowISO();
      if(obj.ui && typeof obj.ui==="object"){
        next.ui = { ...next.ui, ...obj.ui };
      }
      if(Array.isArray(obj.lanes) && obj.lanes.length){
        next.lanes = obj.lanes.map(l=>({
          id: safeStr(l.id||"").trim() || crypto.randomUUID().slice(0,6).toUpperCase(),
          name: safeStr(l.name||"LANE").trim() || "LANE",
          deprecated: !!l.deprecated
        }));
      }
      const links = obj.links || {};
      for(const key of Object.keys(links)){
        const id = safeStr(key);
        next.links[id] = normalizeLink(id, links[key] || {});
      }
      next.order = (obj.order && typeof obj.order==="object") ? obj.order : {};
      return next;
    }

    function clean(){
      // minimal: ensure labels exist
      for(const id of Object.keys(STATE.links)){
        const L=STATE.links[id];
        L.path = safeStr(L.path||id).trim();
        L.url = safeStr(L.url).trim();
        L.note = safeStr(L.note).trim();
        L.display = L.note ? L.note : inferLabel(L.path);
        // lane deprecated => deprecated status
        const ln = STATE.lanes.find(x=>x.id===L.laneId);
        if(ln && ln.deprecated) L.status="deprecated";
        if(L.status!=="active" && L.status!=="deprecated") L.status="active";
      }
      STATE.updatedAt = nowISO();
      render();
    }

    function exportState(){
      // export in the arranger-compatible shape
      const out={
        version:"KETADATA_LINK_SET_MOCKUPS_EXPORT_v1",
        updatedAt: nowISO(),
        ui:{...STATE.ui},
        lanes: STATE.lanes.map(l=>({id:l.id,name:l.name,deprecated:!!l.deprecated})),
        order: JSON.parse(JSON.stringify(STATE.order||{})),
        links:{}
      };
      for(const id of Object.keys(STATE.links)){
        const L=STATE.links[id];
        out.links[id]={ path:L.path, url:L.url, laneId:L.laneId, status:L.status, note:L.note };
      }
      return out;
    }

    function downloadJson(name,data){
      const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url; a.download=name;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 250);
    }

    function saveLocal(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(exportState()));
    }

    function loadLocal(){
      const raw=localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const obj=JSON.parse(raw);
      STATE = ingestArranger(obj);
      render();
    }

    function copyText(t){
      try{ navigator.clipboard.writeText(t); }
      catch(e){
        const ta=document.createElement("textarea");
        ta.value=t; document.body.appendChild(ta);
        ta.select(); document.execCommand("copy"); ta.remove();
      }
    }

    function wire(){
      UI.btn.parse.addEventListener("click", ()=>{
        try{
          const obj=parseInputJson();
          if(safeStr(obj.version).includes("KETADATA_LINK_TRIAGE")){
            STATE = ingestTriage(obj);
          }else{
            STATE = ingestArranger(obj);
          }
          // preserve current variant selection
          STATE.ui.variant = STATE.ui.variant || "v1";
          render();
        }catch(e){ alert("PARSE FAILED: "+e.message); }
      });

      UI.btn.clean.addEventListener("click", ()=>clean());

      UI.btn.export.addEventListener("click", ()=>{
        const out=exportState();
        const fname=`KETADATA_LINK_SET_MOCKUPS_${new Date().toISOString().slice(0,19).replaceAll(":","-")}.json`;
        downloadJson(fname,out);
      });

      UI.btn.import.addEventListener("click", ()=>{
        UI.btn.filePick.value="";
        UI.btn.filePick.click();
      });
      UI.btn.filePick.addEventListener("change", async ()=>{
        const f=UI.btn.filePick.files && UI.btn.filePick.files[0];
        if(!f) return;
        const text=await f.text();
        UI.inputArea.value=text;
        UI.btn.parse.click();
      });

      UI.btn.saveLocal.addEventListener("click", ()=>saveLocal());
      UI.btn.loadLocal.addEventListener("click", ()=>loadLocal());
      UI.btn.reset.addEventListener("click", ()=>{
        if(!confirm("RESET?")) return;
        STATE=DEFAULT(); SELECTED_ID=null;
        UI.inputArea.value=""; UI.search.value="";
        setVariant("v1");
      });

      UI.btn.toggleFilter.addEventListener("click", ()=>{
        const f=STATE.ui.filter;
        STATE.ui.filter = (f==="active")?"deprecated":(f==="deprecated")?"all":"active";
        render();
      });

      UI.search.addEventListener("input", ()=>{
        STATE.ui.search = UI.search.value;
        render();
      });

      UI.btn.prevSet.addEventListener("click", ()=>{
        const n=STATE.lanes.length || 1;
        STATE.ui.focusLaneIndex = (STATE.ui.focusLaneIndex - 1 + n) % n;
        render();
      });
      UI.btn.nextSet.addEventListener("click", ()=>{
        const n=STATE.lanes.length || 1;
        STATE.ui.focusLaneIndex = (STATE.ui.focusLaneIndex + 1) % n;
        render();
      });

      UI.btn.openSelected.addEventListener("click", ()=>{
        if(!SELECTED_ID || !STATE.links[SELECTED_ID] || !STATE.links[SELECTED_ID].url) return;
        window.open(STATE.links[SELECTED_ID].url, "_blank", "noopener,noreferrer");
      });

      UI.btn.copyUrl.addEventListener("click", ()=>{
        if(!SELECTED_ID || !STATE.links[SELECTED_ID] || !STATE.links[SELECTED_ID].url) return;
        copyText(STATE.links[SELECTED_ID].url);
      });

      UI.vbtn.v1.addEventListener("click", ()=>setVariant("v1"));
      UI.vbtn.v2.addEventListener("click", ()=>setVariant("v2"));
      UI.vbtn.v3.addEventListener("click", ()=>setVariant("v3"));
      UI.vbtn.v4.addEventListener("click", ()=>setVariant("v4"));
      UI.vbtn.v5.addEventListener("click", ()=>setVariant("v5"));
      UI.vbtn.v6.addEventListener("click", ()=>setVariant("v6"));

      window.addEventListener("keydown", (e)=>{
        const mod=e.ctrlKey||e.metaKey;
        if(mod && e.key.toLowerCase()==="s"){ e.preventDefault(); saveLocal(); }
        if(mod && e.key.toLowerCase()==="e"){ e.preventDefault(); UI.btn.export.click(); }
      });
    }

    function init(){
      // set variant buttons
      for(const k of Object.keys(UI.vbtn)) UI.vbtn[k].classList.remove("on");
      UI.vbtn.v1.classList.add("on");
      UI.variantName.textContent="V1 COLUMNS";
      setFilterPill();
      render();
      wire();
      try{ loadLocal(); }catch(_){}
    }
    init();
  </script>

  <!-- ============================================================
    KETADATA HTML SERIALIZATION STAMP
    AE/EE/WB: WB
    FILE_ID: KETADATA_LINK_SET_ARRANGER_MOCKUPS
    ROOM_ID: BASE_TOOL
    VERSION: v1_6_variants_mockups
    UPDATED_AT: 2025-12-29T00:00:00-05:00
    CHANGELOG:
    - 6 VIEW VARIANTS (MOCKUPS) SHARING ONE DATA MODEL
    - INPUT: TRIAGE JSON OR ARRANGER EXPORT JSON
    - FILTER: ACTIVE / DEPRECATED / ALL + SEARCH
    - FOCUS SET NAV: PREV / NEXT
    - STATE IO: EXPORT/IMPORT (REAL FILE) + SAVE/LOAD (localStorage)
    ============================================================ -->
</body>
</html>
