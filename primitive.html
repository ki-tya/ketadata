<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KETADATA // PRIMITIVES</title>
  <style>
    :root{
      --bg:#000;
      --fg:#fff;
      --stroke:rgba(255,255,255,0.18);
      --stroke2:rgba(255,255,255,0.12);
      --glass:rgba(255,255,255,0.06);
      --panel:rgba(0,0,0,0.92);
      --muted:rgba(255,255,255,0.62);
      --muted2:rgba(255,255,255,0.40);
      --shadow:rgba(0,0,0,0.78);
      --ok:rgba(255,255,255,0.78);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:Arial, Helvetica, sans-serif;}
    body{overflow:hidden;}
    button,input,select,textarea{font-family:inherit}

    /* Topbar */
    #topbar{
      position:fixed; left:0; right:0; top:0;
      height:48px;
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid var(--stroke2);
      background:#000;
      user-select:none;
      z-index:30;
    }
    #brand{
      display:flex; align-items:center; gap:10px;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.80);
      min-width:240px;
    }
    .whiteBox{width:10px;height:10px;background:#fff;display:inline-block;}
    #topActions{display:flex;align-items:center;gap:8px;}
    .btn{
      border:1px solid var(--stroke);
      background:transparent;
      color:rgba(255,255,255,0.86);
      padding:7px 10px;
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{background:var(--glass);border-color:rgba(255,255,255,0.34);}
    .btnPrimary{background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.30);}
    .btnPrimary:hover{background:rgba(255,255,255,0.09);border-color:rgba(255,255,255,0.44);}

    /* Required: white note icon upper right */
    #noteIcon{
      width:28px;height:28px;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,0.20);
      background:rgba(255,255,255,0.10);
      cursor:pointer;
    }
    #noteIcon:hover{border-color:rgba(255,255,255,0.36);background:rgba(255,255,255,0.14);}

    /* Layout */
    #main{
      position:fixed; inset:48px 0 0 0;
      display:grid;
      grid-template-columns: 360px 1fr;
      min-height:0;
    }

    /* Left panel */
    #left{
      border-right:1px solid var(--stroke2);
      background:rgba(0,0,0,0.90);
      display:flex; flex-direction:column;
      min-height:0;
    }
    #leftHeader{
      padding:12px;
      border-bottom:1px solid var(--stroke2);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      user-select:none;
    }
    #leftHeader .title{
      margin:0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.78);
      display:flex;align-items:center;gap:10px;
    }
    #leftBody{
      padding:12px;
      overflow:auto;
      min-height:0;
    }

    .field{display:grid;gap:6px;margin-bottom:12px;}
    label{
      font-size:11px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.60);
    }
    input[type="text"], textarea, select{
      width:100%;
      border:1px solid rgba(255,255,255,0.16);
      background:rgba(255,255,255,0.04);
      color:rgba(255,255,255,0.90);
      padding:9px 10px;
      font-size:12px;
      outline:none;
    }
    textarea{min-height:100px;resize:vertical;}
    input[type="text"]:focus, textarea:focus, select:focus{
      border-color:rgba(255,255,255,0.36);
      background:rgba(255,255,255,0.06);
    }
    .hint{
      font-size:11px;
      line-height:1.35;
      color:rgba(255,255,255,0.48);
      letter-spacing:0.04em;
    }

    /* Primitive list */
    #list{display:grid;gap:8px;margin-top:6px;}
    .item{
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.03);
      padding:10px;
      cursor:pointer;
      display:grid;
      gap:6px;
    }
    .item:hover{background:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.22);}
    .item.active{background:rgba(255,255,255,0.07);border-color:rgba(255,255,255,0.32);}
    .itemTop{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .name{
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.86);
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .pill{
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.55);
      border:1px solid rgba(255,255,255,0.14);
      padding:3px 6px;
      background:rgba(0,0,0,0.40);
      white-space:nowrap;
    }
    .row{display:flex;gap:8px;flex-wrap:wrap;}

    /* Right: editor */
    #right{
      position:relative;
      min-height:0;
      overflow:hidden;
      background:#000;
      display:flex;
      flex-direction:column;
    }
    #rightHeader{
      padding:12px 14px;
      border-bottom:1px solid var(--stroke2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    #rightHeader .title{
      margin:0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.78);
      display:flex;align-items:center;gap:10px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* CC toggles editor density (collapse primitive) */
    #ccBtn{
      width:28px;height:28px;
      border:1px solid rgba(255,255,255,0.24);
      background:rgba(0,0,0,0.45);
      cursor:pointer;
      display:grid;place-items:center;
      padding:0;
    }
    #ccBtn:hover{background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.38);}
    #ccGlyph{width:10px;height:10px;border:1px solid rgba(255,255,255,0.55);opacity:0.85;}

    #editor{
      flex:1;
      min-height:0;
      overflow:auto;
      padding:14px;
      display:grid;
      gap:12px;
    }

    .card{
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.03);
      padding:12px;
      display:grid;
      gap:10px;
    }
    .cardTitle{
      margin:0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.78);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      user-select:none;
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .chipRow{display:flex;flex-wrap:wrap;gap:8px;}
    .chip{
      border:1px solid rgba(255,255,255,0.16);
      background:transparent;
      color:rgba(255,255,255,0.78);
      padding:7px 10px;
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{background:var(--glass);border-color:rgba(255,255,255,0.34);}
    .chip.on{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.40);}

    .muted{color:rgba(255,255,255,0.46);font-size:11px;letter-spacing:0.04em;line-height:1.35;}

    /* Glossary strip */
    #glossaryStrip{
      border-top:1px solid rgba(255,255,255,0.10);
      padding-top:10px;
      margin-top:10px;
      font-size:10px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.40);
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      user-select:none;
    }

    /* Modal (global note) */
    #modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.72);
      display:none;
      z-index:50;
    }
    #modal{
      position:absolute; right:16px; top:58px;
      width:min(520px, calc(100% - 32px));
      border:1px solid rgba(255,255,255,0.22);
      background:rgba(0,0,0,0.92);
      box-shadow:0 28px 110px rgba(0,0,0,0.82);
      padding:12px;
    }
    #modalTitle{
      margin:0 0 10px 0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.82);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      user-select:none;
    }

    /* Toast */
    #toast{
      position:fixed;
      left:50%;
      top:68px;
      transform:translateX(-50%);
      padding:8px 10px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.72);
      color:rgba(255,255,255,0.65);
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      display:none;
      z-index:80;
    }

    /* Density toggle behavior */
    .dense .muted{display:none;}
    .dense #glossaryStrip{display:none;}
    .dense textarea{min-height:70px;}
  </style>
</head>

<body>
  <div id="topbar">
    <div id="brand">
      <span class="whiteBox" aria-hidden="true"></span>
      <span>KETADATA // PRIMITIVES</span>
    </div>
    <div id="topActions">
      <button id="noteIcon" type="button" aria-label="Global Note">
        <span class="whiteBox" aria-hidden="true"></span>
      </button>
      <button id="exportState" class="btn btnPrimary" type="button">Export State</button>
      <button id="copySpec" class="btn" type="button">Copy Spec</button>
    </div>
  </div>

  <div id="main">
    <!-- LEFT -->
    <div id="left">
      <div id="leftHeader">
        <p class="title"><span class="whiteBox" aria-hidden="true"></span> Primitives</p>
        <button id="newPrim" class="btn btnPrimary" type="button">New</button>
      </div>

      <div id="leftBody">
        <div class="field">
          <label for="project">Project</label>
          <input id="project" type="text" value="KETADATA" />
        </div>

        <div class="field">
          <label for="scope">Scope</label>
          <select id="scope">
            <option>SYSTEM</option>
            <option>ROOM</option>
            <option>INTERFACE</option>
            <option>MODULE</option>
            <option>CONTROL</option>
            <option>NOTE</option>
            <option>STATE</option>
            <option>PROMPT</option>
            <option>ACCESS</option>
            <option>MODE</option>
          </select>
          <div class="hint">Scope is how the primitive propagates: global, room-level, interface-level.</div>
        </div>

        <div class="field">
          <label for="search">Search</label>
          <input id="search" type="text" placeholder="filter by name / tags / scope" />
        </div>

        <div class="field">
          <label>List</label>
          <div id="list"></div>
          <div class="hint">Primitives are stable units: must be reusable, nameable, exportable.</div>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div id="right">
      <div id="rightHeader">
        <p class="title"><span class="whiteBox" aria-hidden="true"></span> Editor <span id="activeName" style="color:rgba(255,255,255,0.40);margin-left:6px;"></span></p>
        <button id="ccBtn" type="button" aria-label="Command/Control"><span id="ccGlyph" aria-hidden="true"></span></button>
      </div>

      <div id="editor">
        <div class="card">
          <p class="cardTitle">Identity <span class="pill" id="activeScopePill">—</span></p>
          <div class="grid2">
            <div class="field" style="margin:0;">
              <label for="primName">Name</label>
              <input id="primName" type="text" placeholder="e.g. NOTE_WHITE_SQUARE" />
            </div>
            <div class="field" style="margin:0;">
              <label for="primScope">Scope</label>
              <select id="primScope">
                <option>SYSTEM</option><option>ROOM</option><option>INTERFACE</option>
                <option>MODULE</option><option>CONTROL</option><option>NOTE</option>
                <option>STATE</option><option>PROMPT</option><option>ACCESS</option><option>MODE</option>
              </select>
            </div>
          </div>

          <div class="field" style="margin:0;">
            <label for="primTags">Tags (comma separated)</label>
            <input id="primTags" type="text" placeholder="angular, mind, export, UI" />
          </div>

          <div class="muted">
            Definition rule: a primitive is the smallest unit that stays the same across pages and tools.
          </div>
        </div>

        <div class="card">
          <p class="cardTitle">Definition</p>
          <div class="field" style="margin:0;">
            <label for="primDef">One-line definition</label>
            <input id="primDef" type="text" placeholder="What it is, in one sentence." />
          </div>
          <div class="field" style="margin:0;">
            <label for="primWhy">Why it exists</label>
            <textarea id="primWhy" placeholder="Constraint, principle, or system need."></textarea>
          </div>
          <div class="muted">If you can't justify it, it’s not a primitive. It’s an implementation detail.</div>
        </div>

        <div class="card">
          <p class="cardTitle">Implementation</p>
          <div class="field" style="margin:0;">
            <label for="primUI">UI Manifestation</label>
            <textarea id="primUI" placeholder="How it appears (e.g. white square icon upper right, CC button node, collapsible module)."></textarea>
          </div>
          <div class="field" style="margin:0;">
            <label for="primRules">Rules</label>
            <textarea id="primRules" placeholder="Hard rules. What must always be true."></textarea>
          </div>
          <div class="grid2">
            <div class="field" style="margin:0;">
              <label for="primAPI">State / Metadata keys</label>
              <input id="primAPI" type="text" placeholder='e.g. note:{id,x,y,title,tags}, exportState(), copyPrompt()' />
            </div>
            <div class="field" style="margin:0;">
              <label for="primVersion">Version</label>
              <input id="primVersion" type="text" placeholder="v1" />
            </div>
          </div>
        </div>

        <div class="card">
          <p class="cardTitle">Polarity & Semantics</p>
          <div class="chipRow" id="semChips"></div>
          <div class="field" style="margin:0;">
            <label for="primSem">Semantics note</label>
            <textarea id="primSem" placeholder="Mind=angular vs senses=circular, etc."></textarea>
          </div>
          <div class="muted">
            KETADATA visual language: mind = angular; senses = circular; note = white/black square.
          </div>
        </div>

        <div class="card">
          <p class="cardTitle">Actions</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button id="save" class="btn btnPrimary" type="button">Save</button>
            <button id="dup" class="btn" type="button">Duplicate</button>
            <button id="del" class="btn" type="button">Delete</button>
          </div>

          <div id="glossaryStrip" aria-hidden="true">
            <span>PRIMITIVE=unit</span>
            <span>RULE=invariant</span>
            <span>SCOPE=propagation</span>
            <span>STATE=export</span>
            <span>PROMPT=intent</span>
            <span>ACCESS=control</span>
            <span>MODE=atmosphere</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- GLOBAL NOTE MODAL -->
  <div id="modalBack" aria-hidden="true">
    <div id="modal" role="dialog" aria-label="Global Note">
      <div id="modalTitle">
        <span><span class="whiteBox" style="width:9px;height:9px;"></span> GLOBAL NOTE</span>
        <button id="closeModal" class="btn" type="button">Close</button>
      </div>
      <div class="field">
        <label for="globalNote">Text</label>
        <textarea id="globalNote" placeholder="system laws / constraints / reminders"></textarea>
        <div class="hint">Saved into state. Applies to the primitives registry.</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button id="saveGlobal" class="btn btnPrimary" type="button">Save</button>
        <button id="clearGlobal" class="btn" type="button">Clear</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    // =========================
    // KETADATA // PRIMITIVES REGISTRY
    // - track primitives as exportable units
    // - scope + rules + UI manifestation + state keys
    // - copy a one-page spec
    // =========================

    const el = (id)=>document.getElementById(id);
    const uid = ()=>Math.random().toString(36).slice(2, 9)+"-"+Date.now().toString(36);

    const projectEl = el('project');
    const scopeFilterEl = el('scope');
    const searchEl = el('search');
    const listEl = el('list');

    const activeNameEl = el('activeName');
    const activeScopePill = el('activeScopePill');

    const primNameEl = el('primName');
    const primScopeEl = el('primScope');
    const primTagsEl = el('primTags');
    const primDefEl = el('primDef');
    const primWhyEl = el('primWhy');
    const primUIEl = el('primUI');
    const primRulesEl = el('primRules');
    const primAPIEl = el('primAPI');
    const primVersionEl = el('primVersion');
    const primSemEl = el('primSem');

    const semChipsEl = el('semChips');

    const saveBtn = el('save');
    const dupBtn = el('dup');
    const delBtn = el('del');

    const newPrimBtn = el('newPrim');
    const ccBtn = el('ccBtn');

    const noteIcon = el('noteIcon');
    const modalBack = el('modalBack');
    const closeModal = el('closeModal');
    const globalNoteEl = el('globalNote');
    const saveGlobal = el('saveGlobal');
    const clearGlobal = el('clearGlobal');

    const exportStateBtn = el('exportState');
    const copySpecBtn = el('copySpec');
    const toastEl = el('toast');

    function toast(msg, ms=650){
      toastEl.textContent = msg;
      toastEl.style.display = 'block';
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>{ toastEl.style.display='none'; }, ms);
    }
    async function copyText(s){
      try{ await navigator.clipboard.writeText(s); toast("COPIED"); }
      catch{ window.prompt("Copy:", s); }
    }
    function encode(obj){ return btoa(unescape(encodeURIComponent(JSON.stringify(obj)))); }
    function decode(b64){ return JSON.parse(decodeURIComponent(escape(atob(b64)))); }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (m)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    const SEM_DEFAULT = [
      "MIND=ANGULAR",
      "SENSES=CIRCULAR",
      "NOTE=WHITE_SQUARE",
      "COLLAPSE=PRIMITIVE",
      "CONTROL=OFF-STAGE",
      "HOTKEYS=SUBTLE"
    ];

    function makePrim(){
      return {
        id: uid(),
        name: "NEW_PRIMITIVE",
        scope: "SYSTEM",
        tags: [],
        def: "",
        why: "",
        ui: "",
        rules: "",
        api: "",
        version: "v1",
        semantics: "",
        semFlags: []
      };
    }

    let state = {
      v: 1,
      project: "KETADATA",
      globalNote: "",
      primitives: [],
      activeId: null
    };

    // load from hash
    (function(){
      const m = location.hash.match(/state=([^&]+)/);
      if(!m){
        const p = makePrim();
        // seed your core primitives immediately
        p.name = "NOTE_WHITE_SQUARE";
        p.scope = "SYSTEM";
        p.def = "Notes are the universal metadata atom; visible as a white square.";
        p.why = "All pages must be able to produce note metadata; the note icon is the invariant affordance.";
        p.ui = "White square icon (upper right). Note cards/atoms persist via exportState().";
        p.rules = "Must exist on every page; must export; must not be decorative; must support tags + glossary.";
        p.api = "note:{id,title,tags,glossary,body,anchors[]}; exportState(); copyPrompt()";
        p.semFlags = ["NOTE=WHITE_SQUARE"];

        state.primitives = [p];
        state.activeId = p.id;
        return;
      }
      try{
        const s = decode(m[1]);
        if(s && s.v === 1){
          state = s;
          if(!state.primitives?.length){
            const p = makePrim();
            state.primitives = [p];
            state.activeId = p.id;
          }
          state.activeId = state.activeId || state.primitives[0].id;
        }
      }catch{
        const p = makePrim();
        state.primitives = [p];
        state.activeId = p.id;
      }
    })();

    function activePrim(){
      return state.primitives.find(p=>p.id===state.activeId) || state.primitives[0];
    }

    function renderSemChips(){
      const p = activePrim();
      semChipsEl.innerHTML = "";
      const all = [...SEM_DEFAULT];
      // keep custom semFlags too
      const extras = (p.semFlags||[]).filter(x=>!all.includes(x));
      const uniq = [...new Set([...all, ...extras])];

      uniq.forEach(label=>{
        const b = document.createElement('button');
        b.className = "chip" + ((p.semFlags||[]).includes(label) ? " on" : "");
        b.type = "button";
        b.textContent = label;
        b.addEventListener('click', ()=>{
          p.semFlags = p.semFlags || [];
          if(p.semFlags.includes(label)) p.semFlags = p.semFlags.filter(x=>x!==label);
          else p.semFlags.push(label);
          renderSemChips();
        });
        semChipsEl.appendChild(b);
      });
    }

    function renderList(){
      const q = searchEl.value.trim().toLowerCase();
      const scopeF = scopeFilterEl.value;

      const items = state.primitives.filter(p=>{
        const scopeOk = !scopeF || p.scope === scopeF;
        if(!scopeOk) return false;
        if(!q) return true;
        const blob = [
          p.name, p.scope, (p.tags||[]).join(" "),
          p.def, p.why, p.ui, p.rules, p.api, p.version,
          (p.semFlags||[]).join(" "), p.semantics
        ].join(" ").toLowerCase();
        return blob.includes(q);
      });

      listEl.innerHTML = "";
      items.forEach(p=>{
        const d = document.createElement('div');
        d.className = "item" + (p.id===state.activeId ? " active" : "");
        d.innerHTML = `
          <div class="itemTop">
            <div class="name">${escapeHtml(p.name || "UNNAMED")}</div>
            <div class="pill">${escapeHtml(p.scope || "—")}</div>
          </div>
          <div class="row">
            <span class="pill">${escapeHtml(p.version || "v1")}</span>
            <span class="pill">${(p.tags||[]).length} TAGS</span>
            <span class="pill">${(p.semFlags||[]).length} SEM</span>
          </div>
        `;
        d.addEventListener('click', ()=>{
          state.activeId = p.id;
          renderAll();
        });
        listEl.appendChild(d);
      });
    }

    function syncEditor(){
      const p = activePrim();
      activeNameEl.textContent = p.name ? ("// " + p.name) : "";
      activeScopePill.textContent = p.scope || "—";

      primNameEl.value = p.name || "";
      primScopeEl.value = p.scope || "SYSTEM";
      primTagsEl.value = (p.tags || []).join(", ");
      primDefEl.value = p.def || "";
      primWhyEl.value = p.why || "";
      primUIEl.value = p.ui || "";
      primRulesEl.value = p.rules || "";
      primAPIEl.value = p.api || "";
      primVersionEl.value = p.version || "v1";
      primSemEl.value = p.semantics || "";

      renderSemChips();
      globalNoteEl.value = state.globalNote || "";
    }

    function renderAll(){
      projectEl.value = state.project || "KETADATA";
      renderList();
      syncEditor();
    }

    function commitEditorToPrim(){
      const p = activePrim();
      p.name = primNameEl.value.trim() || "UNNAMED_PRIMITIVE";
      p.scope = primScopeEl.value;
      p.tags = primTagsEl.value.split(",").map(s=>s.trim()).filter(Boolean);
      p.def = primDefEl.value.trim();
      p.why = primWhyEl.value;
      p.ui = primUIEl.value;
      p.rules = primRulesEl.value;
      p.api = primAPIEl.value.trim();
      p.version = primVersionEl.value.trim() || "v1";
      p.semantics = primSemEl.value;
    }

    // --- events ---
    projectEl.addEventListener('input', ()=>{ state.project = projectEl.value; });
    scopeFilterEl.addEventListener('change', renderList);
    searchEl.addEventListener('input', renderList);

    // editor inputs mark state (save is explicit)
    [primNameEl, primScopeEl, primTagsEl, primDefEl, primWhyEl, primUIEl, primRulesEl, primAPIEl, primVersionEl, primSemEl]
      .forEach(x=>x.addEventListener('input', ()=>{}));

    saveBtn.addEventListener('click', ()=>{
      commitEditorToPrim();
      renderAll();
      toast("SAVED");
    });

    dupBtn.addEventListener('click', ()=>{
      commitEditorToPrim();
      const p = activePrim();
      const copy = JSON.parse(JSON.stringify(p));
      copy.id = uid();
      copy.name = (p.name || "PRIMITIVE") + "_COPY";
      state.primitives.unshift(copy);
      state.activeId = copy.id;
      renderAll();
      toast("DUP");
    });

    delBtn.addEventListener('click', ()=>{
      if(state.primitives.length <= 1){ toast("KEEP ONE"); return; }
      const id = state.activeId;
      state.primitives = state.primitives.filter(p=>p.id!==id);
      state.activeId = state.primitives[0].id;
      renderAll();
      toast("DELETED");
    });

    newPrimBtn.addEventListener('click', ()=>{
      const p = makePrim();
      state.primitives.unshift(p);
      state.activeId = p.id;
      renderAll();
      toast("NEW");
    });

    // CC toggles density
    ccBtn.addEventListener('click', ()=>{
      document.body.classList.toggle('dense');
      toast(document.body.classList.contains('dense') ? "DENSE" : "OPEN");
    });

    // global modal
    function showModal(){
      modalBack.style.display = 'block';
      modalBack.setAttribute('aria-hidden','false');
      globalNoteEl.value = state.globalNote || "";
      setTimeout(()=>globalNoteEl.focus(), 0);
    }
    function hideModal(){
      modalBack.style.display = 'none';
      modalBack.setAttribute('aria-hidden','true');
    }
    noteIcon.addEventListener('click', showModal);
    closeModal.addEventListener('click', hideModal);
    modalBack.addEventListener('click', (e)=>{ if(e.target===modalBack) hideModal(); });

    saveGlobal.addEventListener('click', ()=>{
      state.globalNote = globalNoteEl.value;
      toast("SAVED");
      hideModal();
    });
    clearGlobal.addEventListener('click', ()=>{
      state.globalNote = "";
      globalNoteEl.value = "";
      toast("CLEARED");
    });

    // export
    function exportState(){
      commitEditorToPrim();
      const safe = JSON.parse(JSON.stringify(state));
      const b64 = encode(safe);
      const url = location.origin + location.pathname + "#state=" + b64;
      return { safe, url };
    }

    function buildOnePageSpec(){
      commitEditorToPrim();
      const p = activePrim();
      const head = [
        "KETADATA PRIMITIVE SPEC",
        `PROJECT: ${state.project}`,
        state.globalNote ? `GLOBAL NOTE: ${state.globalNote}` : "GLOBAL NOTE: (none)",
        "",
        "ACTIVE PRIMITIVE",
        `NAME: ${p.name}`,
        `SCOPE: ${p.scope}`,
        `VERSION: ${p.version}`,
        `TAGS: ${(p.tags||[]).join(", ") || "(none)"}`,
        `SEM FLAGS: ${(p.semFlags||[]).join(" | ") || "(none)"}`,
        "",
        `DEFINITION: ${p.def || "(none)"}`,
        "",
        "WHY",
        (p.why || "(none)"),
        "",
        "UI MANIFESTATION",
        (p.ui || "(none)"),
        "",
        "RULES (INVARIANTS)",
        (p.rules || "(none)"),
        "",
        "STATE / METADATA KEYS",
        (p.api || "(none)"),
        "",
        "SEMANTICS NOTE",
        (p.semantics || "(none)")
      ].join("\n");
      return head;
    }

    exportStateBtn.addEventListener('click', async ()=>{
      const { url } = exportState();
      await copyText(url);
      location.hash = url.split("#")[1];
    });

    copySpecBtn.addEventListener('click', async ()=>{
      await copyText(buildOnePageSpec());
    });

    // escape closes modal
    window.addEventListener('keydown', (e)=>{
      if(e.key !== 'Escape') return;
      if(modalBack.style.display === 'block') hideModal();
    });

    // init
    renderAll();
  </script>
</body>
</html>
