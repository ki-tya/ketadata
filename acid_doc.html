<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>KETADATA // DOC</title>
<style>
  :root{
    /* =========================
       THEME (user-adjustable)
    ========================== */
    --appBg: #000000;   /* outside area */
    --docBg: #070707;   /* page background */
    --text:  #ffffff;   /* page text */

    --muted: rgba(255,255,255,.60);
    --hair:  rgba(255,255,255,.16);
    --hair2: rgba(255,255,255,.09);

    /* =========================
       VISCOUS / ACIDIC (thicker, slower, searing)
    ========================== */
    --acid: rgba(255,255,255,.22);          /* white acid haze */
    --acid2: rgba(255,255,255,.10);         /* secondary haze */
    --searA: 16px;                           /* near glow */
    --searB: 64px;                           /* far glow */
    --visc: 1;                               /* 0/1 toggle */
    --drip: 1;                               /* 0/1 toggle */
    --dripSpeed: 9.5s;                       /* slower = heavier */
    --gooBlur: 10px;                         /* goo blur */
    --inkThick: 2px;                         /* border thickness feel */

    /* =========================
       PAGE
    ========================== */
    --pageW: min(940px, 92vw);
    --pagePad: 60px;
    --fontSize: 18px;
    --lineHeight: 1.58;

    /* =========================
       UI
    ========================== */
    --topH: 46px;
    --btnBg: rgba(0,0,0,.22);
    --btnBg2: rgba(0,0,0,.40);
    --shadow: rgba(0,0,0,.72);
  }

  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    background: var(--appBg);
    color: var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    overflow:hidden;
  }

  /* =========================================================
     AMBIENT ACID FIELD (slow, thick, cohesive)
  ========================================================= */
  #acidField{
    position:fixed; inset:0;
    z-index:0;
    pointer-events:none;
    background:
      radial-gradient(900px 700px at 18% 18%, rgba(255,255,255,.07), transparent 70%),
      radial-gradient(900px 700px at 82% 22%, rgba(255,255,255,.05), transparent 74%),
      radial-gradient(1000px 800px at 50% 88%, rgba(255,255,255,.06), transparent 70%),
      linear-gradient(180deg, rgba(255,255,255,.02), transparent 45%, rgba(255,255,255,.02));
    opacity: .9;
    filter: blur(16px);
    transform: translateZ(0);
  }
  #acidField::after{
    content:"";
    position:absolute; inset:-18%;
    background:
      conic-gradient(from 190deg,
        rgba(255,255,255,.06),
        transparent,
        rgba(255,255,255,.05),
        transparent,
        rgba(255,255,255,.04));
    opacity: .7;
    filter: blur(26px);
    animation: slowDrift 12s linear infinite;
    mix-blend-mode: screen;
  }
  @keyframes slowDrift{
    from{ transform: translate(-2%,-1%) rotate(0deg); }
    to  { transform: translate( 2%, 1%) rotate(360deg); }
  }

  /* =========================================================
     TOP BAR (bold, thicker, searing edges)
  ========================================================= */
  #top{
    position:fixed; left:0; right:0; top:0; height:var(--topH);
    z-index:50;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 12px;
    border-bottom: 1px solid var(--hair);
    background: rgba(0,0,0,.38);
    backdrop-filter: blur(12px);
    user-select:none;
  }
  #top::before{
    content:"";
    position:absolute; left:0; right:0; bottom:-1px; height:2px;
    background: rgba(255,255,255,.08);
    filter: blur(1px);
    opacity: .9;
  }

  #brand{
    display:flex; align-items:center; gap:10px;
    min-width:0;
  }
  #brand .sq{
    width:12px; height:12px;
    border:1px solid #fff;
    background:#fff;
    flex:0 0 auto;
    filter: drop-shadow(0 0 14px rgba(255,255,255,.16));
  }
  #brand .t{
    font-size:11px;
    letter-spacing:.24em;
    text-transform:uppercase;
    color: rgba(255,255,255,.90);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width: 54vw;
    font-weight: 900;
  }

  #actions{
    display:flex;
    align-items:center;
    gap:8px;
  }

  .btn{
    height:30px;
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 0 11px;
    border: 1px solid var(--hair);
    background: var(--btnBg);
    color: rgba(255,255,255,.84);
    font-size:11px;
    letter-spacing:.18em;
    text-transform:uppercase;
    cursor:pointer;
    line-height:1;
    user-select:none;
    box-shadow:
      0 0 0 1px rgba(0,0,0,.40) inset,
      0 10px 40px rgba(0,0,0,.25);
  }
  .btn:hover{
    color:#fff;
    border-color: rgba(255,255,255,.34);
    background: var(--btnBg2);
  }
  .btn:active{ transform: translateY(1px); }

  .pill{
    height:30px;
    border:1px solid var(--hair);
    background: rgba(0,0,0,.22);
    color: rgba(255,255,255,.74);
    display:flex;
    align-items:center;
    padding: 0 10px;
    font-size:11px;
    letter-spacing:.16em;
    text-transform:uppercase;
    gap:10px;
    user-select:none;
    box-shadow: 0 0 22px rgba(255,255,255,.05);
  }
  .pill b{ color:#fff; font-weight:900; }

  /* =========================================================
     LAYOUT
  ========================================================= */
  #wrap{
    position:fixed; inset:0;
    z-index:1;
    padding-top: var(--topH);
    display:grid;
    grid-template-columns: 330px 1fr;
  }

  /* LEFT PANEL */
  #panel{
    border-right: 1px solid var(--hair2);
    background: rgba(0,0,0,.24);
    backdrop-filter: blur(12px);
    overflow:auto;
  }
  #panelInner{
    padding: 14px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .card{
    position:relative;
    border:1px solid var(--hair);
    background: rgba(0,0,0,.16);
    padding: 12px;
    box-shadow:
      0 0 0 1px rgba(0,0,0,.40) inset,
      0 18px 60px rgba(0,0,0,.30);
  }
  .card::after{
    content:"";
    position:absolute; inset:-1px;
    border:1px solid rgba(255,255,255,.06);
    pointer-events:none;
    opacity:.9;
  }
  .card .h{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:10px;
  }
  .card .h .lab{
    font-size:11px;
    letter-spacing:.24em;
    text-transform:uppercase;
    font-weight:900;
    color: rgba(255,255,255,.88);
  }
  .hint{
    font-size:11px;
    letter-spacing:.10em;
    color: rgba(255,255,255,.56);
    line-height:1.35;
  }

  .row{
    display:grid;
    grid-template-columns: 1fr 120px;
    gap:10px;
    align-items:center;
    margin-top:10px;
  }
  .row label{
    font-size:10px;
    letter-spacing:.24em;
    text-transform:uppercase;
    color: rgba(255,255,255,.72);
  }
  input[type="color"]{
    width:100%;
    height:36px;
    border:1px solid var(--hair);
    background: transparent;
    padding: 0;
    cursor:pointer;
  }

  .mini{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:10px;
  }
  .sw{
    width:28px;height:28px;
    border:1px solid var(--hair);
    cursor:pointer;
    background:#fff;
    box-shadow: 0 0 18px rgba(255,255,255,.06);
  }

  .rangeRow{
    display:flex;
    align-items:center;
    gap:10px;
    margin-top:10px;
  }
  .rangeRow label{
    flex:1;
    font-size:10px;
    letter-spacing:.24em;
    text-transform:uppercase;
    color: rgba(255,255,255,.72);
  }
  .rangeRow input[type="range"]{
    flex:1.2;
    accent-color: #fff;
  }
  .val{
    width:62px;
    text-align:right;
    font-size:11px;
    letter-spacing:.16em;
    color:#fff;
    font-weight:900;
  }

  /* toggle row */
  .togRow{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-top:10px;
    padding-top:10px;
    border-top:1px solid var(--hair2);
  }
  .togRow .lab2{
    font-size:10px;
    letter-spacing:.24em;
    text-transform:uppercase;
    color: rgba(255,255,255,.70);
  }
  .tog{
    display:flex;
    gap:8px;
  }
  .chip{
    height:26px;
    padding:0 10px;
    border:1px solid var(--hair);
    background: rgba(0,0,0,.18);
    color: rgba(255,255,255,.70);
    font-size:10px;
    letter-spacing:.22em;
    text-transform:uppercase;
    cursor:pointer;
    user-select:none;
  }
  .chip.on{
    color:#fff;
    border-color: rgba(255,255,255,.34);
    background: rgba(0,0,0,.34);
  }

  /* MAIN DOC AREA */
  #main{
    overflow:auto;
    background: linear-gradient(180deg, rgba(255,255,255,.02), transparent 140px);
  }

  /* =========================================================
     THE PAGE (VISCOUS / DRIPPING EDGE)
  ========================================================= */
  #page{
    position:relative;
    width: var(--pageW);
    margin: 26px auto 60px auto;
    background: var(--docBg);
    color: var(--text);
    border: 1px solid var(--hair);
    box-shadow:
      0 26px 100px var(--shadow),
      0 0 var(--searB) rgba(255,255,255,.05);
    border-radius: 14px;
    overflow:hidden;
  }

  /* acid halo */
  #page::before{
    content:"";
    position:absolute; inset:-60px;
    background:
      radial-gradient(closest-side at 30% 20%, rgba(255,255,255,.08), transparent 70%),
      radial-gradient(closest-side at 70% 30%, rgba(255,255,255,.06), transparent 72%),
      radial-gradient(closest-side at 50% 88%, rgba(255,255,255,.05), transparent 68%);
    opacity: calc(.85 * var(--visc));
    filter: blur(22px);
    mix-blend-mode: screen;
    pointer-events:none;
  }

  /* dripping glaze (only if --drip = 1) */
  #page::after{
    content:"";
    position:absolute;
    left:-10%;
    top:-40px;
    width:120%;
    height: 140px;
    pointer-events:none;
    opacity: calc(.78 * var(--drip));
    filter: blur(var(--gooBlur));
    background:
      radial-gradient(18px 40px at 6% 80%, rgba(255,255,255,.16), transparent 70%),
      radial-gradient(22px 50px at 16% 86%, rgba(255,255,255,.14), transparent 72%),
      radial-gradient(20px 46px at 28% 82%, rgba(255,255,255,.16), transparent 72%),
      radial-gradient(26px 60px at 40% 88%, rgba(255,255,255,.12), transparent 74%),
      radial-gradient(18px 40px at 52% 82%, rgba(255,255,255,.15), transparent 70%),
      radial-gradient(28px 64px at 64% 90%, rgba(255,255,255,.12), transparent 74%),
      radial-gradient(18px 40px at 76% 84%, rgba(255,255,255,.16), transparent 72%),
      radial-gradient(22px 52px at 88% 90%, rgba(255,255,255,.12), transparent 74%),
      linear-gradient(180deg, rgba(255,255,255,.10), transparent 70%);
    animation: dripSlide var(--dripSpeed) ease-in-out infinite;
    mix-blend-mode: screen;
  }
  @keyframes dripSlide{
    0%   { transform: translateY(0px); opacity: calc(.72 * var(--drip)); }
    50%  { transform: translateY(10px); opacity: calc(.86 * var(--drip)); }
    100% { transform: translateY(0px); opacity: calc(.72 * var(--drip)); }
  }

  #pageTop{
    position:relative;
    border-bottom:1px solid var(--hair2);
    padding: 14px 18px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    user-select:none;
    background: rgba(0,0,0,.10);
  }
  #pageTop::after{
    content:"";
    position:absolute; left:0; right:0; bottom:-1px; height:2px;
    background: rgba(255,255,255,.08);
    filter: blur(1px);
    opacity: calc(.85 * var(--visc));
  }

  #docTitle{
    font-weight: 950;
    letter-spacing:.08em;
    text-transform: uppercase;
    font-size: 12px;
    color: rgba(255,255,255,.92);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width: 62%;
    filter: drop-shadow(0 0 var(--searA) rgba(255,255,255,.10));
  }

  #status{
    font-size:10px;
    letter-spacing:.22em;
    text-transform:uppercase;
    color: rgba(255,255,255,.60);
    white-space:nowrap;
  }

  #editor{
    position:relative;
    padding: var(--pagePad);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    font-size: var(--fontSize);
    line-height: var(--lineHeight);
    outline:none;
    min-height: 68vh;
    white-space: pre-wrap;

    /* viscous “ink” */
    text-shadow:
      0 0 var(--searA) rgba(255,255,255,.10),
      0 0 var(--searB) rgba(255,255,255,.05);
  }

  /* thicker selection vibe */
  #editor b, #editor strong{ font-weight: 950; }

  #editor:focus{ caret-color: #fff; }

  /* subtle “ink bleed” overlay on the page content (very low) */
  #inkBleed{
    position:absolute; inset:0;
    pointer-events:none;
    opacity: calc(.35 * var(--visc));
    mix-blend-mode: overlay;
    background:
      radial-gradient(600px 420px at 22% 28%, rgba(255,255,255,.05), transparent 70%),
      radial-gradient(700px 520px at 72% 62%, rgba(255,255,255,.04), transparent 72%),
      radial-gradient(700px 520px at 52% 92%, rgba(255,255,255,.03), transparent 70%);
    filter: blur(18px);
  }

  /* focus rings minimal */
  .btn:focus-visible, input:focus-visible, textarea:focus-visible{
    outline: 2px solid rgba(255,255,255,.22);
    outline-offset: 2px;
  }

  /* responsive */
  @media (max-width: 980px){
    #wrap{ grid-template-columns: 1fr; }
    #panel{ border-right:0; border-bottom:1px solid var(--hair2); }
    #page{ width: min(940px, 94vw); }
  }
</style>
</head>

<body>
  <div id="acidField" aria-hidden="true"></div>

  <div id="top">
    <div id="brand">
      <div class="sq" aria-hidden="true"></div>
      <div class="t">KETADATA // DOC</div>
    </div>

    <div id="actions">
      <div class="pill"><span>STATE:</span> <b id="saveState">UNSAVED</b></div>
      <button class="btn" id="btnSave">SAVE</button>
      <button class="btn" id="btnExport">EXPORT</button>
      <button class="btn" id="btnImport">IMPORT</button>
      <button class="btn" id="btnClear">CLEAR</button>
    </div>
  </div>

  <div id="wrap">
    <aside id="panel">
      <div id="panelInner">

        <div class="card">
          <div class="h">
            <div class="lab">THEME</div>
            <button class="btn" id="btnReset" style="height:26px;padding:0 8px;">RESET</button>
          </div>
          <div class="hint">
            Adjust <b>APP BG</b>, <b>DOC BG</b>, <b>TEXT</b>. Instant update.
          </div>

          <div class="row">
            <label for="appBg">APP BG</label>
            <input id="appBg" type="color" value="#000000" />
          </div>

          <div class="row">
            <label for="docBg">DOC BG</label>
            <input id="docBg" type="color" value="#070707" />
          </div>

          <div class="row">
            <label for="textCol">TEXT</label>
            <input id="textCol" type="color" value="#ffffff" />
          </div>

          <div class="mini" aria-label="Quick swatches">
            <div class="sw" title="Black"    data-app="#000000" data-doc="#070707" data-text="#ffffff" style="background:#000"></div>
            <div class="sw" title="Graphite" data-app="#040404" data-doc="#111111" data-text="#f3f3f3" style="background:#1a1a1a"></div>
            <div class="sw" title="Acid"     data-app="#000000" data-doc="#001414" data-text="#eaffff" style="background:#00ffff"></div>
            <div class="sw" title="Infra"    data-app="#000000" data-doc="#0a0000" data-text="#fff1f1" style="background:#ff2a2a"></div>
            <div class="sw" title="Paper"    data-app="#0b0b0b" data-doc="#f2f2f2" data-text="#0a0a0a" style="background:#f2f2f2"></div>
          </div>

          <div class="togRow">
            <div class="lab2">VISCOUS</div>
            <div class="tog">
              <button class="chip on" id="togVisc">ON</button>
              <button class="chip on" id="togDrip">DRIP</button>
            </div>
          </div>

          <div class="hint" style="margin-top:10px;">
            Visceral mode thickens glow + adds slow “drip glaze” on the page edge.
          </div>
        </div>

        <div class="card">
          <div class="h">
            <div class="lab">DOC</div>
            <div class="hint" id="wordCount">0 WORDS</div>
          </div>

          <div class="rangeRow">
            <label for="fontSize">FONT SIZE</label>
            <input id="fontSize" type="range" min="12" max="30" value="18" />
            <div class="val" id="fontVal">18</div>
          </div>

          <div class="rangeRow">
            <label for="padSize">PAGE PADDING</label>
            <input id="padSize" type="range" min="28" max="104" value="60" />
            <div class="val" id="padVal">60</div>
          </div>

          <div class="rangeRow">
            <label for="lineH">LINE HEIGHT</label>
            <input id="lineH" type="range" min="120" max="240" value="158" />
            <div class="val" id="lhVal">1.58</div>
          </div>

          <div class="hint" style="margin-top:10px;">
            Hotkeys: <b>CTRL/CMD+S</b> save · <b>CTRL/CMD+E</b> export · <b>CTRL/CMD+I</b> import
          </div>
        </div>

        <div class="card" id="ioCard" style="display:none;">
          <div class="h">
            <div class="lab">IMPORT / EXPORT</div>
            <button class="btn" id="btnCloseIO" style="height:26px;padding:0 8px;">CLOSE</button>
          </div>
          <textarea id="io" spellcheck="false" style="
            width:100%; height:180px; resize:vertical;
            border:1px solid rgba(255,255,255,.12);
            background: rgba(0,0,0,.44);
            color:#fff;
            padding:10px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace;
            font-size: 11px;
            letter-spacing:.06em;
            line-height:1.35;
            outline:none;"></textarea>
          <div class="mini" style="margin-top:10px;">
            <button class="btn" id="btnApplyIO">APPLY</button>
            <button class="btn" id="btnCopyIO">COPY</button>
          </div>
        </div>

      </div>
    </aside>

    <main id="main">
      <div id="page" role="document" aria-label="Document">
        <div id="pageTop">
          <div id="docTitle" contenteditable="true" spellcheck="false">UNTITLED DOCUMENT</div>
          <div id="status"><span id="savedAt">—</span></div>
        </div>

        <div style="position:relative">
          <div id="inkBleed" aria-hidden="true"></div>
          <div id="editor" contenteditable="true" spellcheck="true" aria-label="Editor">KETADATA DOC

Type like it matters.

- Bold, clean, direct.
- Theme controls on the left.
- Viscous mode thickens the page.

          </div>
        </div>
      </div>
    </main>
  </div>

<script>
/* =========================================================
   KETADATA DOC — VISCOSITY UPGRADE (thicker / slower / searing)
========================================================= */
const FILE_ID = "KETADATA_DOC_VISC_V1";
const STATE_KEY = `KETADATA_DOC_STATE::${FILE_ID}`;

const el = (id)=>document.getElementById(id);

const editor   = el("editor");
const titleEl  = el("docTitle");
const saveFlag = el("saveState");
const savedAt  = el("savedAt");
const wordCount= el("wordCount");

const appBg  = el("appBg");
const docBg  = el("docBg");
const textCol= el("textCol");

const fontSize = el("fontSize");
const padSize  = el("padSize");
const lineH    = el("lineH");

const fontVal = el("fontVal");
const padVal  = el("padVal");
const lhVal   = el("lhVal");

const ioCard = el("ioCard");
const ioArea = el("io");

const togVisc = el("togVisc");
const togDrip = el("togDrip");

let dirty = false;
let saveT = null;

function setCSSVar(name, value){
  document.documentElement.style.setProperty(name, value);
}

function markDirty(){
  dirty = true;
  saveFlag.textContent = "UNSAVED";
  scheduleAutosave();
  updateCounts();
}

function scheduleAutosave(){
  clearTimeout(saveT);
  saveT = setTimeout(()=>saveState(true), 450);
}

function nowISO(){
  return new Date().toISOString();
}

function updateCounts(){
  const text = editor.innerText.trim();
  const words = text ? text.split(/\s+/).length : 0;
  wordCount.textContent = `${words} WORDS`;
}

function getState(){
  return {
    _ketadata: true,
    file_id: FILE_ID,
    version: "v1",
    updated_at: nowISO(),
    theme: {
      appBg: appBg.value,
      docBg: docBg.value,
      text: textCol.value
    },
    doc: {
      title: titleEl.innerText.trim() || "UNTITLED DOCUMENT",
      html: editor.innerHTML,
      fontSize: Number(fontSize.value),
      pad: Number(padSize.value),
      lineHeight: Number(lineH.value)/100
    },
    visc: {
      visc: Number(getComputedStyle(document.documentElement).getPropertyValue("--visc")) || 1,
      drip: Number(getComputedStyle(document.documentElement).getPropertyValue("--drip")) || 1
    }
  };
}

function applyState(s){
  if(!s || !s._ketadata) return;

  if(s.theme){
    if(s.theme.appBg)  appBg.value = s.theme.appBg;
    if(s.theme.docBg)  docBg.value = s.theme.docBg;
    if(s.theme.text)   textCol.value = s.theme.text;
  }

  if(s.doc){
    if(typeof s.doc.title === "string") titleEl.innerText = s.doc.title;
    if(typeof s.doc.html === "string")  editor.innerHTML = s.doc.html;

    if(typeof s.doc.fontSize === "number") fontSize.value = String(s.doc.fontSize);
    if(typeof s.doc.pad === "number")      padSize.value  = String(s.doc.pad);
    if(typeof s.doc.lineHeight === "number") lineH.value  = String(Math.round(s.doc.lineHeight*100));
  }

  if(s.visc){
    if(typeof s.visc.visc === "number") setCSSVar("--visc", s.visc.visc ? 1 : 0);
    if(typeof s.visc.drip === "number") setCSSVar("--drip", s.visc.drip ? 1 : 0);
    syncViscButtons();
  }

  applyTheme();
  applyDocSizing();

  dirty = false;
  saveFlag.textContent = "SAVED";
  savedAt.textContent = `SAVED ${nowISO()}`;
  updateCounts();
}

function saveState(silent=false){
  try{
    const s = getState();
    localStorage.setItem(STATE_KEY, JSON.stringify(s));
    dirty = false;
    saveFlag.textContent = "SAVED";
    savedAt.textContent = `SAVED ${nowISO()}`;
    if(!silent) flashSaved();
  }catch(e){}
}

function loadState(){
  const raw = localStorage.getItem(STATE_KEY);
  if(!raw) return false;
  try{
    const s = JSON.parse(raw);
    applyState(s);
    return true;
  }catch(e){
    return false;
  }
}

function flashSaved(){
  const old = saveFlag.textContent;
  saveFlag.textContent = "SAVED";
  setTimeout(()=>{ saveFlag.textContent = old; }, 500);
}

function hexToRgb(hex){
  const h = hex.replace('#','').trim();
  const full = h.length===3 ? h.split('').map(c=>c+c).join('') : h;
  const n = parseInt(full,16);
  return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 };
}

function luminance({r,g,b}){
  const f = (v)=>{
    v/=255;
    return v <= 0.04045 ? v/12.92 : Math.pow((v+0.055)/1.055, 2.4);
  };
  const R=f(r), G=f(g), B=f(b);
  return 0.2126*R + 0.7152*G + 0.0722*B;
}

function applyTheme(){
  setCSSVar("--appBg", appBg.value);
  setCSSVar("--docBg", docBg.value);
  setCSSVar("--text",  textCol.value);

  const isLight = luminance(hexToRgb(docBg.value)) > 0.62;
  setCSSVar("--btnBg",  isLight ? "rgba(255,255,255,.20)" : "rgba(0,0,0,.22)");
  setCSSVar("--btnBg2", isLight ? "rgba(255,255,255,.30)" : "rgba(0,0,0,.40)");
  document.body.style.color = textCol.value;
}

function applyDocSizing(){
  setCSSVar("--fontSize", `${fontSize.value}px`);
  setCSSVar("--pagePad", `${padSize.value}px`);
  const lh = (Number(lineH.value)/100).toFixed(2);
  setCSSVar("--lineHeight", lh);

  fontVal.textContent = fontSize.value;
  padVal.textContent  = padSize.value;
  lhVal.textContent   = lh;
}

function syncViscButtons(){
  const visc = Number(getComputedStyle(document.documentElement).getPropertyValue("--visc")) ? 1 : 0;
  const drip = Number(getComputedStyle(document.documentElement).getPropertyValue("--drip")) ? 1 : 0;
  togVisc.classList.toggle("on", !!visc);
  togDrip.classList.toggle("on", !!drip);
  togVisc.textContent = visc ? "ON" : "OFF";
  togDrip.textContent = drip ? "DRIP" : "DRIP OFF";
}

/* Bind inputs */
[appBg, docBg, textCol].forEach(x=>{
  x.addEventListener("input", ()=>{ applyTheme(); markDirty(); });
});
[fontSize, padSize, lineH].forEach(x=>{
  x.addEventListener("input", ()=>{ applyDocSizing(); markDirty(); });
});

editor.addEventListener("input", markDirty);
titleEl.addEventListener("input", markDirty);

/* Buttons */
el("btnSave").onclick   = ()=> saveState(false);

el("btnExport").onclick = ()=>{
  ioCard.style.display = "block";
  ioArea.value = JSON.stringify(getState(), null, 2);
};

el("btnImport").onclick = ()=>{
  ioCard.style.display = "block";
  ioArea.value = "";
  ioArea.focus();
};

el("btnApplyIO").onclick = ()=>{
  try{
    const s = JSON.parse(ioArea.value);
    applyState(s);
    saveState(true);
  }catch(e){}
};

el("btnCopyIO").onclick = ()=>{
  const t = ioArea.value || "";
  navigator.clipboard?.writeText(t).catch(()=>{});
};

el("btnCloseIO").onclick = ()=> ioCard.style.display = "none";

el("btnClear").onclick = ()=>{
  editor.innerHTML = "";
  markDirty();
};

el("btnReset").onclick = ()=>{
  appBg.value   = "#000000";
  docBg.value   = "#070707";
  textCol.value = "#ffffff";
  fontSize.value = "18";
  padSize.value  = "60";
  lineH.value    = "158";
  setCSSVar("--visc", 1);
  setCSSVar("--drip", 1);
  syncViscButtons();
  applyTheme();
  applyDocSizing();
  markDirty();
};

/* Swatches */
document.querySelectorAll(".sw").forEach(sw=>{
  sw.addEventListener("click", ()=>{
    appBg.value = sw.dataset.app;
    docBg.value = sw.dataset.doc;
    textCol.value = sw.dataset.text;
    applyTheme();
    markDirty();
  });
});

/* Visc toggles */
togVisc.addEventListener("click", ()=>{
  const cur = Number(getComputedStyle(document.documentElement).getPropertyValue("--visc")) ? 1 : 0;
  setCSSVar("--visc", cur ? 0 : 1);
  syncViscButtons();
  markDirty();
});
togDrip.addEventListener("click", ()=>{
  const cur = Number(getComputedStyle(document.documentElement).getPropertyValue("--drip")) ? 1 : 0;
  setCSSVar("--drip", cur ? 0 : 1);
  syncViscButtons();
  markDirty();
});

/* Hotkeys */
window.addEventListener("keydown", (e)=>{
  const mac = navigator.platform.toLowerCase().includes("mac");
  const mod = mac ? e.metaKey : e.ctrlKey;

  if(mod && e.key.toLowerCase()==="s"){
    e.preventDefault();
    saveState(false);
  }
  if(mod && e.key.toLowerCase()==="e"){
    e.preventDefault();
    ioCard.style.display = "block";
    ioArea.value = JSON.stringify(getState(), null, 2);
  }
  if(mod && e.key.toLowerCase()==="i"){
    e.preventDefault();
    ioCard.style.display = "block";
    ioArea.value = "";
    ioArea.focus();
  }
});

/* Init */
applyTheme();
applyDocSizing();
syncViscButtons();
loadState() || (savedAt.textContent = "NEW");
updateCounts();
</script>

<!-- ============================================================
KETADATA HTML SERIALIZATION STAMP
AE/EE/WB: WB
FILE_ID: KETADATA_DOC_VISC_V1
ROOM_ID: DOC
VERSION: v1
UPDATED_AT: 2025-12-28T00:00:00-05:00
CHANGELOG:
- VISCOSITY PASS: ACID FIELD BACKDROP + THICKER UI + SEARING PAGE HALO
- DRIP GLAZE: SLOW, HEAVY “DRIPPING” EDGE OVERLAY (TOGGLEABLE)
- CONTROLS: VISCOUS + DRIP TOGGLES ADDED (PERSISTED IN STATE)
- KEEP: APP/DOC/TEXT COLOR CONTROL + DOC SIZING + SAVE/EXPORT/IMPORT
============================================================ -->
</body>
</html>
