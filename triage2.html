<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>KETADATA // LINK TRIAGE v2 (CLEAN)</title>
<style>
:root{
  --bg:#000;
  --fg:rgba(255,255,255,.86);
  --muted:rgba(255,255,255,.52);
  --line:rgba(255,255,255,.12);
  --line2:rgba(255,255,255,.22);
  --panel:rgba(0,0,0,.55);

  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  --sans: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

  --top:44px;
  --bot:30px;
  --h:30px;
  --pad:10px;
  --gap:10px;
  --r:0px;

  --colL:320px;
  --colR:340px;
}
*{box-sizing:border-box}
html,body{height:100%; margin:0}
body{background:var(--bg); color:var(--fg); font-family:var(--sans); overflow:hidden}
a{color:inherit; text-decoration:none}
button,input,select,textarea{font:inherit; color:inherit}
::selection{background:rgba(255,255,255,.14)}

#root{position:fixed; inset:0; display:grid; grid-template-rows:var(--top) 1fr var(--bot)}

/* ===== TOP ===== */
#top{
  display:flex; align-items:center; gap:8px;
  padding:0 10px;
  border-bottom:1px solid var(--line);
  background:linear-gradient(to bottom, rgba(255,255,255,.06), rgba(255,255,255,.02));
}
#title{
  font-family:var(--mono);
  opacity:.9;
  display:flex;
  gap:10px;
  align-items:baseline;
  white-space:nowrap;
}
#title .sub{opacity:.62}
#top .sp{flex:1}
.btn{
  height:var(--h);
  padding:0 10px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,.45);
  border-radius:var(--r);
  cursor:pointer;
  opacity:.92;
}
.btn:hover{border-color:rgba(255,255,255,.36)}
.btn:active{transform:translateY(1px)}
.btn.ghost{border-color:var(--line); opacity:.74}
.seg{display:flex; border:1px solid var(--line2); height:var(--h); border-radius:var(--r); overflow:hidden}
.seg .btn{border:0; border-right:1px solid var(--line); height:100%}
.seg .btn:last-child{border-right:0}
.seg .btn.on{background:rgba(255,255,255,.08); opacity:1}
.pill{
  height:var(--h);
  padding:0 10px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.35);
  border-radius:999px;
  font-family:var(--mono);
  opacity:.72;
  display:flex; align-items:center;
  white-space:nowrap;
}
#sig{font-family:var(--mono); opacity:.62; font-size:12px; white-space:nowrap}

/* ===== MAIN ===== */
#main{
  min-height:0;
  display:grid;
  grid-template-columns: var(--colL) 1fr var(--colR);
}
.col{min-height:0; border-right:1px solid var(--line)}
.col:last-child{border-right:none}

/* ===== LEFT: COLLAPSIBLE RAIL ===== */
#rail{
  min-height:0;
  overflow:auto;
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.section{
  border:1px solid var(--line);
  background:rgba(0,0,0,.35);
}
.section .hd{
  height:var(--h);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 10px;
  border-bottom:1px solid var(--line);
  font-family:var(--mono);
  opacity:.88;
  cursor:pointer;
  user-select:none;
}
.section .hd .k{opacity:.62; font-size:12px}
.section .bd{padding:10px; display:none}
.section.open .bd{display:block}

.field{display:flex; flex-direction:column; gap:6px; margin-bottom:8px}
label{font-family:var(--mono); opacity:.62; font-size:12px}
.input,.select{
  height:var(--h);
  padding:0 8px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,.5);
  outline:none;
  border-radius:var(--r);
}
.input:focus,.select:focus{border-color:rgba(255,255,255,.40)}
.ta{
  width:100%;
  min-height:120px;
  resize:vertical;
  padding:8px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,.5);
  outline:none;
  border-radius:var(--r);
  font-family:var(--mono);
  font-size:12px;
  line-height:1.35;
}
.row{display:flex; gap:8px; flex-wrap:wrap}
.row .btn{flex:1}
.hint{font-family:var(--mono); opacity:.58; font-size:12px; line-height:1.35}

/* ===== CENTER: LIST ===== */
#center{min-height:0; display:flex; flex-direction:column}
#centerTop{
  padding:10px;
  border-bottom:1px solid var(--line);
  display:flex;
  gap:8px;
  align-items:center;
}
#q{
  flex:1;
  height:var(--h);
  padding:0 10px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,.5);
  outline:none;
  border-radius:var(--r);
}
#q:focus{border-color:rgba(255,255,255,.40)}
#count{font-family:var(--mono); opacity:.62; font-size:12px; white-space:nowrap}

#list{
  min-height:0;
  overflow:auto;
}
.item{
  display:grid;
  grid-template-columns: 14px 1fr;
  gap:10px;
  padding:10px;
  border-bottom:1px solid var(--line);
  align-items:start;
}
.item:hover{background:rgba(255,255,255,.03)}
.item.sel{
  background:rgba(255,255,255,.05);
  outline:1px solid rgba(255,255,255,.22);
  outline-offset:-1px;
}
.item.depr{opacity:.42}
.dot{
  width:10px; height:10px;
  border:1px solid rgba(255,255,255,.44);
  margin-top:4px;
  background:rgba(255,255,255,.06);
}
.url{
  font-family:var(--mono);
  font-size:12px;
  opacity:.92;
  word-break:break-all;
}
.meta{
  margin-top:4px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:baseline;
  font-family:var(--mono);
  font-size:12px;
}
.meta .t{opacity:.68}
.meta .time{opacity:.52}
.tags{display:flex; gap:6px; flex-wrap:wrap}
.tag{
  border:1px solid var(--line);
  padding:2px 6px;
  opacity:.66;
  font-family:var(--mono);
  font-size:11px;
}
.note{margin-top:6px; opacity:.70; font-size:12px; white-space:pre-wrap}
.actions{margin-top:8px; display:flex; gap:8px; flex-wrap:wrap}
.actions .btn{height:28px; padding:0 8px}
.actions .btn{border-color:var(--line); opacity:.78}

/* ===== RIGHT: EDITOR (SIMPLE) ===== */
#right{
  min-height:0;
  overflow:auto;
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.box{
  border:1px solid var(--line);
  background:rgba(0,0,0,.35);
}
.box .hd{
  height:var(--h);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 10px;
  border-bottom:1px solid var(--line);
  font-family:var(--mono);
  opacity:.88;
}
.box .bd{padding:10px}
.grid2{display:grid; grid-template-columns:1fr 1fr; gap:8px}
.chips{display:flex; gap:8px; flex-wrap:wrap}
.chip{
  width:18px; height:18px;
  border:1px solid rgba(255,255,255,.44);
  background:rgba(255,255,255,.06);
  cursor:pointer;
}
.chip.sel{outline:1px solid rgba(255,255,255,.66); outline-offset:2px}
#editorFoot{display:flex; gap:8px}
#editorFoot .btn{flex:1}
.kv{font-family:var(--mono); opacity:.62; font-size:12px}

/* ===== OUTPUT MODAL ===== */
#out{
  display:none;
  position:fixed;
  inset:56px 56px 56px 56px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,.94);
  z-index:50;
}
#out.open{display:flex; flex-direction:column}
#outTop{
  height:44px;
  display:flex; align-items:center; gap:8px;
  padding:0 10px;
  border-bottom:1px solid var(--line);
  font-family:var(--mono);
  opacity:.9;
}
#outTop .sp{flex:1}
#outBody{padding:10px; min-height:0; overflow:auto}
#outArea{
  width:100%;
  min-height:100%;
  border:1px solid var(--line2);
  background:rgba(0,0,0,.65);
  border-radius:var(--r);
  padding:10px;
  font-family:var(--mono);
  font-size:12px;
  line-height:1.35;
  outline:none;
  white-space:pre;
}

/* ===== BOTTOM ===== */
#bot{
  display:flex; align-items:center; gap:10px;
  padding:0 10px;
  border-top:1px solid var(--line);
  background:linear-gradient(to top, rgba(255,255,255,.06), rgba(255,255,255,.02));
}
#toast{font-family:var(--mono); opacity:.62; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
#bot .sp{flex:1}
kbd{font-family:var(--mono); font-size:11px; opacity:.72; border:1px solid var(--line); padding:2px 6px}
</style>
</head>
<body>
<div id="root">

  <div id="top">
    <div id="title">
      <span>KETADATA</span>
      <span class="sub">LINK TRIAGE</span>
      <span class="sub">v2</span>
    </div>

    <div class="seg" title="Sort">
      <button class="btn on" id="sortChrono">CHRONO</button>
      <button class="btn" id="sortAlpha">ALPHA</button>
    </div>

    <button class="btn ghost" id="toggleDepr">DEPR</button>

    <div class="seg" title="View">
      <button class="btn on" id="viewAll">ALL</button>
      <button class="btn" id="viewActive">ACTIVE</button>
      <button class="btn" id="viewDeprecated">DEPR-ONLY</button>
    </div>

    <button class="btn ghost" id="invertBtn">INVERT</button>
    <button class="btn ghost" id="nullBtn">NULL</button>

    <div class="sp"></div>
    <div id="sig"></div>
  </div>

  <div id="main">
    <!-- LEFT -->
    <div class="col" id="rail">
      <div class="section open" id="secAdd">
        <div class="hd"><span>ADD</span><span class="k">PASTE</span></div>
        <div class="bd">
          <div class="field">
            <label>PASTE (one per line). formats: url OR "title | url"</label>
            <textarea class="ta" id="bulk" placeholder="Example:
KETA NOTE | https://example.com
https://ketadata.com/map.html"></textarea>
          </div>
          <div class="row">
            <button class="btn" id="addLines">ADD</button>
            <button class="btn ghost" id="clearBulk">CLEAR</button>
          </div>
          <div class="hint">Auto-extract URLs from messy paste. Dups can be merged.</div>
        </div>
      </div>

      <div class="section open" id="secFilter">
        <div class="hd"><span>FILTER</span><span class="k">FAST</span></div>
        <div class="bd">
          <div class="field">
            <label>TEXT (url/title/note/tags)</label>
            <input class="input" id="fText" placeholder="type to filter"/>
          </div>
          <div class="grid2">
            <div class="field">
              <label>COLOR</label>
              <select class="select" id="fColor"><option value="">ANY</option></select>
            </div>
            <div class="field">
              <label>TAG CONTAINS</label>
              <input class="input" id="fTag" placeholder="tag fragment"/>
            </div>
          </div>
          <div class="grid2">
            <div class="field">
              <label>DUPS</label>
              <select class="select" id="fDup">
                <option value="any">ANY</option>
                <option value="only">ONLY DUPS</option>
                <option value="hide">HIDE DUPS</option>
              </select>
            </div>
            <div class="field">
              <label>—</label>
              <button class="btn ghost" id="mergeDups" style="width:100%">MERGE DUPS</button>
            </div>
          </div>
          <div class="row">
            <button class="btn ghost" id="resetFilters">RESET</button>
          </div>
        </div>
      </div>

      <div class="section" id="secExport">
        <div class="hd"><span>EXPORT</span><span class="k">COPY/DL</span></div>
        <div class="bd">
          <div class="grid2">
            <div class="field">
              <label>SCOPE</label>
              <select class="select" id="exScope">
                <option value="view">VIEW</option>
                <option value="all">ALL</option>
                <option value="active">ACTIVE</option>
                <option value="deprecated">DEPRECATED</option>
              </select>
            </div>
            <div class="field">
              <label>FORMAT</label>
              <select class="select" id="exFmt">
                <option value="list">LIST</option>
                <option value="md">MARKDOWN</option>
                <option value="json">JSON</option>
                <option value="csv">CSV</option>
              </select>
            </div>
          </div>
          <div class="row">
            <button class="btn" id="exportBtn">EXPORT</button>
            <button class="btn ghost" id="copyLast">COPY LAST</button>
          </div>
          <div class="row">
            <button class="btn ghost" id="dlOut">DOWNLOAD</button>
            <button class="btn ghost" id="dlState">STATE FILE</button>
          </div>
          <input type="file" id="stateIn" accept=".json,application/json,text/plain" style="display:none"/>
          <div class="row">
            <button class="btn ghost" id="importState">IMPORT STATE</button>
          </div>
          <div class="hint" id="keyLbl"></div>
        </div>
      </div>

      <div class="section" id="secKeys">
        <div class="hd"><span>KEYS</span><span class="k">HINTS</span></div>
        <div class="bd">
          <div class="hint">
            <div><kbd>↑</kbd>/<kbd>↓</kbd> select</div>
            <div><kbd>Enter</kbd> open</div>
            <div><kbd>D</kbd> toggle deprecate</div>
            <div><kbd>C</kbd> cycle color</div>
            <div><kbd>Ctrl/Cmd</kbd>+<kbd>S</kbd> save</div>
            <div><kbd>Ctrl/Cmd</kbd>+<kbd>K</kbd> focus search</div>
          </div>
        </div>
      </div>
    </div>

    <!-- CENTER -->
    <div class="col" id="center">
      <div id="centerTop">
        <input id="q" placeholder="search…"/>
        <div id="count">0</div>
      </div>
      <div id="list"></div>
    </div>

    <!-- RIGHT -->
    <div class="col" id="right">
      <div class="box">
        <div class="hd"><span>EDIT</span><span class="kv" id="rid">—</span></div>
        <div class="bd">
          <div class="field">
            <label>URL</label>
            <input class="input" id="eUrl" placeholder="https://…"/>
          </div>
          <div class="field">
            <label>TITLE</label>
            <input class="input" id="eTitle" placeholder="short label"/>
          </div>
          <div class="field">
            <label>NOTE</label>
            <textarea class="ta" id="eNote" style="min-height:88px" placeholder="routing / context"></textarea>
          </div>
          <div class="field">
            <label>TAGS (comma)</label>
            <input class="input" id="eTags" placeholder="archive, tool, pdf"/>
          </div>
          <div class="field">
            <label>COLOR</label>
            <div class="chips" id="chips"></div>
          </div>
          <div class="grid2">
            <div class="field">
              <label>CREATED</label>
              <input class="input" id="eCreated" disabled/>
            </div>
            <div class="field">
              <label>UPDATED</label>
              <input class="input" id="eUpdated" disabled/>
            </div>
          </div>
          <div id="editorFoot">
            <button class="btn" id="saveBtn">SAVE</button>
            <button class="btn ghost" id="newBtn">NEW</button>
          </div>
          <div class="row" style="margin-top:8px">
            <button class="btn ghost" id="openBtn">OPEN</button>
            <button class="btn ghost" id="depBtn">DEPRECATE</button>
            <button class="btn ghost" id="copyUrlBtn">COPY URL</button>
            <button class="btn ghost" id="delBtn">DELETE</button>
          </div>
        </div>
      </div>

      <div class="box">
        <div class="hd"><span>STATUS</span><span class="kv" id="statusK">—</span></div>
        <div class="bd">
          <div class="kv" id="statusV">—</div>
        </div>
      </div>
    </div>
  </div>

  <div id="bot">
    <div id="toast">READY</div>
    <div class="sp"></div>
    <div class="pill" id="pillSort">SORT: CHRONO</div>
    <div class="pill" id="pillView">VIEW: ALL</div>
  </div>

</div>

<!-- OUTPUT -->
<div id="out">
  <div id="outTop">
    <div>OUTPUT</div>
    <div class="sp"></div>
    <button class="btn ghost" id="outCopy">COPY</button>
    <button class="btn ghost" id="outDl">DOWNLOAD</button>
    <button class="btn" id="outClose">CLOSE</button>
  </div>
  <div id="outBody">
    <textarea id="outArea" spellcheck="false"></textarea>
  </div>
</div>

<script>
/* ===========================
   KETADATA LINK TRIAGE v2 CLEAN
   local-first, single-file
=========================== */
const $ = (id)=>document.getElementById(id);
const nowISO = ()=> new Date().toISOString();
const uid = ()=> Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);

function toast(msg){
  $("toast").textContent = msg;
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>{$("toast").textContent="READY";}, 1100);
}

function safeURL(u){
  try{ return new URL(u).href; }catch(e){ return null; }
}
function extractUrls(text){
  const urls=[];
  const re=/\bhttps?:\/\/[^\s<>"')\]]+/gi;
  let m;
  while((m=re.exec(text||""))!==null) urls.push(m[0].replace(/[.,;:]+$/,""));
  return urls;
}
function normalizeTags(s){
  return (s||"").split(",").map(t=>t.trim()).filter(Boolean).slice(0,32);
}
function hashKey(url){
  let s=(url||"").trim().toLowerCase();
  let h=2166136261;
  for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619); }
  return "h"+(h>>>0).toString(16);
}
function shortTime(iso){
  if(!iso) return "—";
  const d=new Date(iso);
  if(isNaN(d.getTime())) return "—";
  const yyyy=d.getFullYear();
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const dd=String(d.getDate()).padStart(2,"0");
  const hh=String(d.getHours()).padStart(2,"0");
  const mi=String(d.getMinutes()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
}

/* ===== palette ===== */
const PALETTE=[
  {id:"none", label:"NONE", css:"rgba(255,255,255,.06)"},
  {id:"w1",   label:"W1",   css:"rgba(255,255,255,.18)"},
  {id:"w2",   label:"W2",   css:"rgba(255,255,255,.32)"},
  {id:"w3",   label:"W3",   css:"rgba(255,255,255,.50)"},
  {id:"w4",   label:"W4",   css:"rgba(255,255,255,.70)"},
  {id:"blk",  label:"BLK",  css:"rgba(0,0,0,0)"}
];
const colorCss=(id)=> (PALETTE.find(p=>p.id===id)||PALETTE[0]).css;

/* ===== storage isolation ===== */
const FILE_ID=(()=>{
  const k="KETADATA_LINK_TRIAGE_V2__FILE_ID";
  let v=localStorage.getItem(k);
  if(!v){ v="KLT2-"+uid(); localStorage.setItem(k,v); }
  return v;
})();
const STORE_KEY="KETADATA_LINK_TRIAGE_V2__STATE__"+FILE_ID;

/* ===== state ===== */
const DEFAULTS={
  fileId: FILE_ID,
  createdAt: nowISO(),
  updatedAt: nowISO(),
  ui:{
    invert:false,
    blackout:false,
    sortMode:"chrono",   // chrono|alpha
    showDeprecated:true,
    viewMode:"all",      // all|active|deprecated
    dupMode:"any",       // any|only|hide
    fText:"",
    fTag:"",
    fColor:"",
    q:"",
    selectedId:null
  },
  records:[]
};

let STATE=loadState();
let chipSelId="none";
let LAST_EXPORT={text:"", ext:"txt", mime:"text/plain", filename:"export.txt"};

function loadState(){
  try{
    const raw=localStorage.getItem(STORE_KEY);
    if(!raw) return structuredClone(DEFAULTS);
    const st=JSON.parse(raw);

    const out=structuredClone(DEFAULTS);
    out.fileId=st.fileId||FILE_ID;
    out.createdAt=st.createdAt||out.createdAt;
    out.updatedAt=st.updatedAt||out.updatedAt;
    out.ui=Object.assign(out.ui, st.ui||{});
    out.records=Array.isArray(st.records)?st.records:[];
    out.records=out.records.map(r=>{
      const rr=Object.assign({
        id:uid(), url:"", title:"", note:"", tags:[], color:"none",
        deprecated:false, createdAt:nowISO(), updatedAt:nowISO(), hash:""
      }, r||{});
      rr.tags=Array.isArray(rr.tags)?rr.tags:normalizeTags(rr.tags);
      rr.url=(rr.url||"").trim();
      rr.title=(rr.title||"").trim();
      rr.note=(rr.note||"").trim();
      rr.color=rr.color||"none";
      rr.deprecated=!!rr.deprecated;
      rr.hash=rr.hash||hashKey(rr.url);
      return rr;
    });
    return out;
  }catch(e){
    return structuredClone(DEFAULTS);
  }
}
function saveState(){
  STATE.updatedAt=nowISO();
  localStorage.setItem(STORE_KEY, JSON.stringify(STATE));
  updateSig();
}

/* ===== UI plumbing ===== */
function updateSig(){
  $("sig").textContent = `FILE_ID ${STATE.fileId} · REC ${STATE.records.length} · UPDATED ${shortTime(STATE.updatedAt)}`;
  $("keyLbl").textContent = "KEY: " + STORE_KEY;
  $("pillSort").textContent = "SORT: " + (STATE.ui.sortMode==="chrono"?"CHRONO":"ALPHA");
  $("pillView").textContent = "VIEW: " + (STATE.ui.viewMode==="all"?"ALL":(STATE.ui.viewMode==="active"?"ACTIVE":"DEPR-ONLY"));
  $("statusK").textContent = `selected ${STATE.ui.selectedId ? "YES":"NO"}`;
}
function setInvert(on){
  STATE.ui.invert=!!on;
  document.documentElement.style.filter = STATE.ui.invert ? "invert(1)" : "none";
}
function setNull(on){
  STATE.ui.blackout=!!on;
  const base = STATE.ui.invert ? "invert(1) " : "";
  document.documentElement.style.filter = STATE.ui.blackout ? (base+"brightness(0.65)") : (STATE.ui.invert ? "invert(1)" : "none");
}
function openUrl(url){
  const u=safeURL(url||"");
  if(!u){ toast("NO URL"); return; }
  window.open(u,"_blank","noopener,noreferrer");
}
async function copyText(t){
  try{
    await navigator.clipboard.writeText(t||"");
    toast("COPIED");
    return true;
  }catch(e){
    try{
      const ta=document.createElement("textarea");
      ta.value=t||"";
      ta.style.position="fixed"; ta.style.left="-9999px";
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      document.execCommand("copy");
      ta.remove();
      toast("COPIED");
      return true;
    }catch(e2){
      toast("COPY FAILED");
      return false;
    }
  }
}

/* ===== chips ===== */
function buildChips(){
  const wrap=$("chips");
  wrap.innerHTML="";
  PALETTE.forEach(p=>{
    const d=document.createElement("div");
    d.className="chip";
    d.dataset.id=p.id;
    d.title=p.label;
    d.style.background=(p.id==="blk")?"rgba(255,255,255,.02)":p.css;
    d.addEventListener("click",()=>setChipSel(p.id));
    wrap.appendChild(d);
  });
}
function setChipSel(id){
  chipSelId=id||"none";
  document.querySelectorAll(".chip").forEach(el=>{
    el.classList.toggle("sel", el.dataset.id===chipSelId);
  });
}

/* ===== filtering/sorting ===== */
function getViewRecords(){
  const ui=STATE.ui;
  let rs=STATE.records.slice();

  // view mode
  if(ui.viewMode==="active") rs=rs.filter(r=>!r.deprecated);
  if(ui.viewMode==="deprecated") rs=rs.filter(r=>!!r.deprecated);

  // top toggle showDeprecated
  if(!ui.showDeprecated) rs=rs.filter(r=>!r.deprecated);

  // dup mode (by normalized url hash)
  const counts=new Map();
  rs.forEach(r=>{
    const k=r.hash||hashKey(r.url);
    counts.set(k,(counts.get(k)||0)+1);
  });
  if(ui.dupMode==="only") rs=rs.filter(r=>(counts.get(r.hash)||0)>1);
  if(ui.dupMode==="hide") rs=rs.filter(r=>(counts.get(r.hash)||0)<=1);

  // left filters
  const ftxt=(ui.fText||"").trim().toLowerCase();
  const ftag=(ui.fTag||"").trim().toLowerCase();
  const fcol=(ui.fColor||"").trim();

  if(ftxt){
    rs=rs.filter(r=>[
      r.url,r.title,r.note,(r.tags||[]).join(" ")
    ].join(" ").toLowerCase().includes(ftxt));
  }
  if(ftag){
    rs=rs.filter(r=>(r.tags||[]).join(",").toLowerCase().includes(ftag));
  }
  if(fcol){
    rs=rs.filter(r=>(r.color||"none")===fcol);
  }

  // center search
  const q=(ui.q||"").trim().toLowerCase();
  if(q){
    rs=rs.filter(r=>[
      r.url,r.title,r.note,(r.tags||[]).join(" ")
    ].join(" ").toLowerCase().includes(q));
  }

  // sort
  if(ui.sortMode==="chrono"){
    rs.sort((a,b)=>(Date.parse(b.createdAt)||0)-(Date.parse(a.createdAt)||0));
  }else{
    const k=(r)=>((r.title||r.url||"").toLowerCase());
    rs.sort((a,b)=>k(a).localeCompare(k(b)));
  }

  return rs;
}

/* ===== list render ===== */
function render(){
  // hydrate select options
  const fColor=$("fColor");
  if(fColor.options.length<=1){
    PALETTE.forEach(p=>{
      const o=document.createElement("option");
      o.value=p.id; o.textContent=p.label;
      fColor.appendChild(o);
    });
  }

  // ensure selection valid
  const rs=getViewRecords();
  if(rs.length && (!STATE.ui.selectedId || !rs.some(r=>r.id===STATE.ui.selectedId))){
    STATE.ui.selectedId=rs[0].id;
    saveState();
  }
  if(!rs.length) STATE.ui.selectedId=null;

  $("count").textContent = `${rs.length}/${STATE.records.length}`;
  $("statusV").textContent = `sort ${STATE.ui.sortMode} · showDepr ${STATE.ui.showDeprecated?"on":"off"} · dup ${STATE.ui.dupMode}`;

  const list=$("list");
  list.innerHTML="";
  rs.forEach(r=>{
    const row=document.createElement("div");
    row.className="item"+(r.deprecated?" depr":"")+(STATE.ui.selectedId===r.id?" sel":"");
    row.dataset.id=r.id;

    const dot=document.createElement("div");
    dot.className="dot";
    if(r.color && r.color!=="blk") dot.style.background=colorCss(r.color);
    if(r.color==="blk") dot.style.background="rgba(255,255,255,.02)";

    const main=document.createElement("div");

    const url=document.createElement("div");
    url.className="url";
    url.textContent=r.url||"(no url)";

    const meta=document.createElement("div");
    meta.className="meta";
    const t=document.createElement("div");
    t.className="t";
    t.textContent=r.title?("— "+r.title):"";
    const time=document.createElement("div");
    time.className="time";
    time.textContent=shortTime(r.createdAt);
    meta.appendChild(t);
    meta.appendChild(time);

    const tags=document.createElement("div");
    tags.className="tags";
    (r.tags||[]).slice(0,6).forEach(x=>{
      const s=document.createElement("span");
      s.className="tag";
      s.textContent=x;
      tags.appendChild(s);
    });

    const note=document.createElement("div");
    note.className="note";
    if(r.note) note.textContent=r.note;

    const actions=document.createElement("div");
    actions.className="actions";
    actions.appendChild(btn("OPEN",()=>openUrl(r.url)));
    actions.appendChild(btn("EDIT",()=>select(r.id,true)));
    actions.appendChild(btn("DEPR",()=>toggleDep(r.id)));
    actions.appendChild(btn("COPY",()=>copyText(r.url||"")));

    main.appendChild(url);
    if(r.title || r.createdAt) main.appendChild(meta);
    if((r.tags||[]).length) main.appendChild(tags);
    if(r.note) main.appendChild(note);
    main.appendChild(actions);

    row.appendChild(dot);
    row.appendChild(main);

    row.addEventListener("click",(ev)=>{
      if(ev.target.tagName==="BUTTON") return;
      select(r.id,true);
    });

    list.appendChild(row);
  });

  fillEditorBySelected();
  updateSig();
}

function btn(txt,fn){
  const b=document.createElement("button");
  b.className="btn ghost";
  b.textContent=txt;
  b.addEventListener("click",(e)=>{e.stopPropagation(); fn();});
  return b;
}

function select(id,scroll){
  STATE.ui.selectedId=id;
  saveState();
  render();
  if(scroll){
    const el=document.querySelector(`.item[data-id="${CSS.escape(id)}"]`);
    if(el) el.scrollIntoView({block:"nearest"});
  }
}

/* ===== editor ===== */
function fillEditorBySelected(){
  const id=STATE.ui.selectedId;
  const r=STATE.records.find(x=>x.id===id);
  if(!r){
    $("rid").textContent="—";
    $("eUrl").value="";
    $("eTitle").value="";
    $("eNote").value="";
    $("eTags").value="";
    $("eCreated").value="";
    $("eUpdated").value="";
    setChipSel("none");
    return;
  }
  $("rid").textContent=r.id;
  $("eUrl").value=r.url||"";
  $("eTitle").value=r.title||"";
  $("eNote").value=r.note||"";
  $("eTags").value=(r.tags||[]).join(", ");
  $("eCreated").value=shortTime(r.createdAt);
  $("eUpdated").value=shortTime(r.updatedAt);
  setChipSel(r.color||"none");
}

function upsertFromEditor(){
  let r=STATE.records.find(x=>x.id===STATE.ui.selectedId);
  if(!r){
    r={id:uid(), url:"", title:"", note:"", tags:[], color:"none", deprecated:false, createdAt:nowISO(), updatedAt:nowISO(), hash:""};
    STATE.records.unshift(r);
    STATE.ui.selectedId=r.id;
  }

  const raw=($("eUrl").value||"").trim();
  const url = raw ? (safeURL(raw) || safeURL(extractUrls(raw)[0]||"")) : "";
  if(raw && !url){ toast("INVALID URL"); return false; }

  r.url=url;
  r.title=($("eTitle").value||"").trim();
  r.note=($("eNote").value||"").trim();
  r.tags=normalizeTags($("eTags").value||"");
  r.color=chipSelId||"none";
  r.hash=hashKey(r.url||"");
  r.updatedAt=nowISO();

  saveState();
  toast("SAVED");
  return true;
}
function toggleDep(id){
  const r=STATE.records.find(x=>x.id===id);
  if(!r) return;
  r.deprecated=!r.deprecated;
  r.updatedAt=nowISO();
  saveState();
  toast(r.deprecated?"DEPRECATED":"ACTIVE");
  render();
}
function delSelected(){
  const id=STATE.ui.selectedId;
  if(!id) return;
  const i=STATE.records.findIndex(x=>x.id===id);
  if(i<0) return;
  STATE.records.splice(i,1);
  STATE.ui.selectedId=STATE.records[0]?.id||null;
  saveState();
  toast("DELETED");
  render();
}
function addBulk(){
  const text=$("bulk").value||"";
  const lines=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  let added=0;

  for(const line of lines){
    let title="", url="";
    if(line.includes("|")){
      const parts=line.split("|").map(s=>s.trim()).filter(Boolean);
      title=parts.slice(0,-1).join(" | ");
      url=safeURL(parts[parts.length-1]) || safeURL(extractUrls(parts[parts.length-1])[0]||"");
    }else{
      url=safeURL(line) || safeURL(extractUrls(line)[0]||"");
    }
    if(!url) continue;
    STATE.records.unshift({
      id:uid(),
      url,
      title:(title||"").trim(),
      note:"",
      tags:[],
      color:"none",
      deprecated:false,
      createdAt:nowISO(),
      updatedAt:nowISO(),
      hash:hashKey(url)
    });
    added++;
  }

  if(added){
    STATE.ui.selectedId=STATE.records[0].id;
    saveState();
    toast("ADDED "+added);
    render();
  }else{
    toast("NOTHING ADDED");
  }
}
function mergeDups(){
  const by=new Map();
  for(const r of STATE.records){
    const k=r.hash||hashKey(r.url);
    if(!by.has(k)) by.set(k,[]);
    by.get(k).push(r);
  }
  let merged=0;
  const out=[];
  for(const [k,arr] of by.entries()){
    if(arr.length===1){ out.push(arr[0]); continue; }
    arr.sort((a,b)=>(Date.parse(b.createdAt)||0)-(Date.parse(a.createdAt)||0));
    const keep=arr[0];
    for(let i=1;i<arr.length;i++){
      const r=arr[i];
      if(!keep.title && r.title) keep.title=r.title;
      if(!keep.note && r.note) keep.note=r.note;
      const tags=new Set([...(keep.tags||[]), ...(r.tags||[])]);
      keep.tags=Array.from(tags).slice(0,32);
      if((keep.color==="none"||!keep.color) && r.color && r.color!=="none") keep.color=r.color;
      if(r.deprecated) keep.deprecated=true;
      merged++;
    }
    keep.updatedAt=nowISO();
    out.push(keep);
  }
  STATE.records=out;
  saveState();
  toast(merged?("MERGED "+merged):"NO DUPS");
  render();
}

/* ===== export / download ===== */
function csvCell(s){
  const x=(s||"").replace(/\r?\n/g," ").trim();
  if(/[",]/.test(x)) return `"${x.replace(/"/g,'""')}"`;
  return x;
}
function escapeMd(s){ return (s||"").replace(/([\[\]\(\)\\])/g,"\\$1"); }
function stamp(){
  const d=new Date();
  const yyyy=d.getFullYear();
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const dd=String(d.getDate()).padStart(2,"0");
  const hh=String(d.getHours()).padStart(2,"0");
  const mi=String(d.getMinutes()).padStart(2,"0");
  return `${yyyy}${mm}${dd}_${hh}${mi}`;
}
function scopeRecords(scope){
  if(scope==="all") return STATE.records.slice();
  if(scope==="active") return STATE.records.filter(r=>!r.deprecated);
  if(scope==="deprecated") return STATE.records.filter(r=>!!r.deprecated);
  return getViewRecords();
}
function exportNow(){
  const scope=$("exScope").value;
  const fmt=$("exFmt").value;
  const rs=scopeRecords(scope);

  let text="", ext="txt", mime="text/plain";
  if(fmt==="list"){
    text=rs.map(r=>r.url).filter(Boolean).join("\n");
    ext="txt"; mime="text/plain";
  }else if(fmt==="md"){
    text=rs.map(r=>{
      const t=(r.title||r.url||"").replace(/\n/g," ").trim();
      const u=r.url||"";
      const tags=(r.tags||[]).length ? ` \`[${r.tags.join(", ")}]\`` : "";
      const dep=r.deprecated ? " (DEPRECATED)" : "";
      return `- [${escapeMd(t)}](${u})${tags}${dep}`;
    }).join("\n");
    ext="md"; mime="text/markdown";
  }else if(fmt==="csv"){
    const header=["createdAt","updatedAt","deprecated","color","title","url","tags","note"].join(",");
    const lines=rs.map(r=>[
      r.createdAt||"",
      r.updatedAt||"",
      r.deprecated?"1":"0",
      r.color||"",
      csvCell(r.title||""),
      csvCell(r.url||""),
      csvCell((r.tags||[]).join("|")),
      csvCell(r.note||"")
    ].join(","));
    text=header+"\n"+lines.join("\n");
    ext="csv"; mime="text/csv";
  }else{
    text=JSON.stringify({fileId:STATE.fileId, exportedAt:nowISO(), scope, count:rs.length, records:rs}, null, 2);
    ext="json"; mime="application/json";
  }
  LAST_EXPORT={text, ext, mime, filename:`KETADATA_LINK_TRIAGE_${STATE.fileId}_${scope}_${fmt}_${stamp()}.${ext}`};
  return LAST_EXPORT;
}
function openOut(text){
  $("outArea").value=text||"";
  $("out").classList.add("open");
  $("outArea").focus();
  $("outArea").select();
}
function closeOut(){ $("out").classList.remove("open"); }
function downloadTextFile(filename,mime,text){
  const blob=new Blob([text||""],{type:mime||"text/plain"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=filename||"export.txt";
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 800);
  toast("DOWNLOADED");
}
function exportStateFile(){
  const payload={...STATE, exportedAt:nowISO(), storeKey:STORE_KEY};
  downloadTextFile(`KETADATA_LINK_TRIAGE_STATE_${STATE.fileId}_${stamp()}.json`, "application/json", JSON.stringify(payload,null,2));
}
function importStateFile(file){
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const obj=JSON.parse(String(reader.result||""));
      if(!obj || !obj.records || !obj.ui){ toast("INVALID STATE"); return; }
      const merged=structuredClone(DEFAULTS);
      merged.fileId=FILE_ID;
      merged.createdAt=obj.createdAt||nowISO();
      merged.updatedAt=nowISO();
      merged.ui=Object.assign(merged.ui, obj.ui||{});
      merged.records=Array.isArray(obj.records)?obj.records:[];
      merged.records=merged.records.map(r=>{
        const rr=Object.assign({
          id:uid(), url:"", title:"", note:"", tags:[], color:"none",
          deprecated:false, createdAt:nowISO(), updatedAt:nowISO(), hash:""
        }, r||{});
        rr.tags=Array.isArray(rr.tags)?rr.tags:normalizeTags(rr.tags);
        rr.url=(rr.url||"").trim();
        rr.title=(rr.title||"").trim();
        rr.note=(rr.note||"").trim();
        rr.color=rr.color||"none";
        rr.deprecated=!!rr.deprecated;
        rr.hash=rr.hash||hashKey(rr.url);
        return rr;
      });
      STATE=merged;
      saveState();
      toast("STATE IMPORTED");
      render();
    }catch(e){
      toast("IMPORT FAILED");
    }
  };
  reader.readAsText(file);
}

/* ===== sections collapse ===== */
function bindSections(){
  document.querySelectorAll(".section .hd").forEach(h=>{
    h.addEventListener("click",()=>{
      const sec=h.parentElement;
      sec.classList.toggle("open");
    });
  });
}

/* ===== bindings ===== */
function bind(){
  // sort
  $("sortChrono").onclick=()=>{
    STATE.ui.sortMode="chrono";
    $("sortChrono").classList.add("on"); $("sortAlpha").classList.remove("on");
    saveState(); render();
  };
  $("sortAlpha").onclick=()=>{
    STATE.ui.sortMode="alpha";
    $("sortAlpha").classList.add("on"); $("sortChrono").classList.remove("on");
    saveState(); render();
  };

  // view
  const setView=(v)=>{
    STATE.ui.viewMode=v;
    $("viewAll").classList.toggle("on", v==="all");
    $("viewActive").classList.toggle("on", v==="active");
    $("viewDeprecated").classList.toggle("on", v==="deprecated");
    saveState(); render();
  };
  $("viewAll").onclick=()=>setView("all");
  $("viewActive").onclick=()=>setView("active");
  $("viewDeprecated").onclick=()=>setView("deprecated");

  // depr toggle (show/hide deprecated in list)
  $("toggleDepr").onclick=()=>{
    STATE.ui.showDeprecated=!STATE.ui.showDeprecated;
    $("toggleDepr").classList.toggle("on", !!STATE.ui.showDeprecated);
    saveState(); render();
  };
  $("toggleDepr").classList.toggle("on", !!STATE.ui.showDeprecated);

  // invert/null
  $("invertBtn").onclick=()=>{ STATE.ui.invert=!STATE.ui.invert; setInvert(STATE.ui.invert); saveState(); toast(STATE.ui.invert?"INVERT ON":"INVERT OFF"); };
  $("nullBtn").onclick=()=>{ STATE.ui.blackout=!STATE.ui.blackout; setNull(STATE.ui.blackout); saveState(); toast(STATE.ui.blackout?"NULL ON":"NULL OFF"); };

  // add
  $("addLines").onclick=()=>addBulk();
  $("clearBulk").onclick=()=>{ $("bulk").value=""; toast("CLEARED"); };

  // filters
  $("fText").addEventListener("input",(e)=>{ STATE.ui.fText=e.target.value; saveState(); render(); });
  $("fTag").addEventListener("input",(e)=>{ STATE.ui.fTag=e.target.value; saveState(); render(); });
  $("fColor").addEventListener("change",(e)=>{ STATE.ui.fColor=e.target.value; saveState(); render(); });
  $("fDup").addEventListener("change",(e)=>{ STATE.ui.dupMode=e.target.value; saveState(); render(); });
  $("resetFilters").onclick=()=>{
    STATE.ui.fText=""; STATE.ui.fTag=""; STATE.ui.fColor=""; STATE.ui.dupMode="any";
    $("fText").value=""; $("fTag").value=""; $("fColor").value=""; $("fDup").value="any";
    saveState(); render(); toast("RESET");
  };
  $("mergeDups").onclick=()=>mergeDups();

  // center search
  $("q").addEventListener("input",(e)=>{ STATE.ui.q=e.target.value; saveState(); render(); });

  // editor
  $("saveBtn").onclick=()=>{ if(upsertFromEditor()) render(); };
  $("newBtn").onclick=()=>{
    const r={id:uid(), url:"", title:"", note:"", tags:[], color:"none", deprecated:false, createdAt:nowISO(), updatedAt:nowISO(), hash:""};
    STATE.records.unshift(r);
    STATE.ui.selectedId=r.id;
    saveState(); toast("NEW"); render();
  };
  $("openBtn").onclick=()=>{
    const r=STATE.records.find(x=>x.id===STATE.ui.selectedId);
    if(r) openUrl(r.url);
  };
  $("depBtn").onclick=()=>{
    if(STATE.ui.selectedId) toggleDep(STATE.ui.selectedId);
  };
  $("copyUrlBtn").onclick=()=>{
    const r=STATE.records.find(x=>x.id===STATE.ui.selectedId);
    copyText(r?.url||"");
  };
  $("delBtn").onclick=()=>{
    if(!STATE.ui.selectedId) return;
    if(confirm("Delete this record?")) delSelected();
  };

  // export
  $("exportBtn").onclick=()=>{
    const ex=exportNow();
    openOut(ex.text);
    toast("EXPORTED");
  };
  $("copyLast").onclick=()=>{
    if(!LAST_EXPORT.text) exportNow();
    copyText(LAST_EXPORT.text);
  };
  $("dlOut").onclick=()=>{
    const ex=LAST_EXPORT.text ? LAST_EXPORT : exportNow();
    downloadTextFile(ex.filename, ex.mime, ex.text);
  };
  $("dlState").onclick=()=>exportStateFile();
  $("importState").onclick=()=>$("stateIn").click();
  $("stateIn").addEventListener("change",(e)=>{
    const f=e.target.files && e.target.files[0];
    if(f) importStateFile(f);
    e.target.value="";
  });

  // output modal
  $("outClose").onclick=()=>closeOut();
  $("outCopy").onclick=()=>copyText($("outArea").value||"");
  $("outDl").onclick=()=>{
    const ex=LAST_EXPORT.text ? LAST_EXPORT : {filename:"export.txt", mime:"text/plain"};
    downloadTextFile(ex.filename, ex.mime, $("outArea").value||"");
  };

  // keyboard
  window.addEventListener("keydown",(e)=>{
    const k=(e.key||"").toLowerCase();
    if($("out").classList.contains("open")){
      if(k==="escape") closeOut();
      return;
    }
    if((e.ctrlKey||e.metaKey) && k==="k"){
      e.preventDefault(); $("q").focus(); return;
    }
    if((e.ctrlKey||e.metaKey) && k==="s"){
      e.preventDefault(); if(upsertFromEditor()) render(); return;
    }

    const rs=getViewRecords();
    if(!rs.length) return;

    if(k==="arrowdown" || k==="arrowup"){
      e.preventDefault();
      const idx=rs.findIndex(r=>r.id===STATE.ui.selectedId);
      const ni=Math.max(0, Math.min(rs.length-1, (idx<0?0:idx)+(k==="arrowdown"?1:-1)));
      select(rs[ni].id,true);
      return;
    }
    if(k==="enter"){
      const r=STATE.records.find(x=>x.id===STATE.ui.selectedId);
      if(r) openUrl(r.url);
      return;
    }
    if(k==="d"){
      if(STATE.ui.selectedId) toggleDep(STATE.ui.selectedId);
      return;
    }
    if(k==="c"){
      const r=STATE.records.find(x=>x.id===STATE.ui.selectedId);
      if(!r) return;
      const idx=PALETTE.findIndex(p=>p.id===(r.color||"none"));
      const next=PALETTE[(idx+1)%PALETTE.length].id;
      r.color=next;
      r.updatedAt=nowISO();
      r.hash=hashKey(r.url||"");
      saveState();
      toast("COLOR "+next.toUpperCase());
      render();
      return;
    }
  });

  // editor auto-save on blur
  ["eUrl","eTitle","eNote","eTags"].forEach(id=>{
    $(id).addEventListener("blur",()=>{
      const r=STATE.records.find(x=>x.id===STATE.ui.selectedId);
      if(!r) return;
      // lightweight diff
      const url=($("eUrl").value||"").trim();
      const url2=url ? (safeURL(url) || safeURL(extractUrls(url)[0]||"")) : "";
      const title=($("eTitle").value||"").trim();
      const note=($("eNote").value||"").trim();
      const tags=normalizeTags($("eTags").value||"");
      const changed =
        (r.url||"")!==(url2||"") ||
        (r.title||"")!==title ||
        (r.note||"")!==note ||
        (r.tags||[]).join(",")!==tags.join(",") ||
        (r.color||"none")!==(chipSelId||"none");
      if(changed){
        upsertFromEditor();
        render();
      }
    });
  });
}

/* ===== init ===== */
function hydrateUI(){
  $("fText").value=STATE.ui.fText||"";
  $("fTag").value=STATE.ui.fTag||"";
  $("fDup").value=STATE.ui.dupMode||"any";
  $("q").value=STATE.ui.q||"";

  // sort buttons
  $("sortChrono").classList.toggle("on", STATE.ui.sortMode==="chrono");
  $("sortAlpha").classList.toggle("on", STATE.ui.sortMode==="alpha");

  // view buttons
  $("viewAll").classList.toggle("on", STATE.ui.viewMode==="all");
  $("viewActive").classList.toggle("on", STATE.ui.viewMode==="active");
  $("viewDeprecated").classList.toggle("on", STATE.ui.viewMode==="deprecated");

  // fColor options
  const fColor=$("fColor");
  fColor.innerHTML=`<option value="">ANY</option>`+PALETTE.map(p=>`<option value="${p.id}">${p.label}</option>`).join("");
  fColor.value=STATE.ui.fColor||"";

  setInvert(STATE.ui.invert);
  setNull(STATE.ui.blackout);

  $("keyLbl").textContent="KEY: "+STORE_KEY;
}

buildChips();
bindSections();
bind();
hydrateUI();
updateSig();
render();

/* ===========================
   AE/EE/WB SERIALIZATION STAMP
=========================== */
/*
AE: brutal minimal triage; reduced chrome; collapsible rail; list-first center; monochrome chips
EE: local-first isolated key; chrono/alpha; view modes; dup modes; deprecate; color; export list/md/json/csv; real download; state import/export
WB: single-file; no network; clipboard + download; keyboard ops

FILE_ID: ${FILE_ID}
ROOM_ID: LINK_TRIAGE
VERSION: 2.0.0
UPDATED_AT: ${new Date().toISOString()}
CHANGELOG:
- v2: cleaned layout, collapsible left rail, simplified editor and topbar; list readability fixed
*/
</script>
</body>
</html>
