<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KETADATA // SHOP SLOPSTREAM (K2 SOON)</title>
<style>
:root{
  --bg:#000;
  --fg:#fff;
  --muted:#9a9a9a;
  --line:#222;
  --line2:#333;

  --bar:#d60000; /* Kruger-adjacent red */
  --bar2:#111;

  --top:48px;
  --bot:34px;

  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  --sans: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

  --note-border: rgba(255,255,255,0.78);
  --ctl-bg: rgba(0,0,0,0.82);
}

*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  background:var(--bg);
  color:var(--fg);
  font-family:var(--sans);
  overflow:hidden;
}

/* Root + modes */
#root{position:fixed; inset:0; background:#000}
#root.invert{filter:invert(1)}
#root.null .topbar,
#root.null .bottombar,
#root.null .drawer,
#root.null .ketaNote,
#root.null .toast{display:none !important}

/* Stage */
#stage{position:absolute; inset:0; overflow:hidden; background:#000}
#c{position:absolute; inset:0; width:100%; height:100%}

/* Brutal scan / grit */
#scan{
  position:absolute; inset:-10%;
  pointer-events:none;
  background:
    repeating-linear-gradient(
      to bottom,
      rgba(255,255,255,0.06) 0px,
      rgba(255,255,255,0.06) 1px,
      rgba(0,0,0,0) 3px,
      rgba(0,0,0,0) 6px
    );
  mix-blend-mode:overlay;
  opacity:0.10;
  transform: translate3d(0,0,0);
  animation: scan 2.2s linear infinite;
}
@keyframes scan{
  0%{transform:translate3d(0,-22px,0)}
  100%{transform:translate3d(0,22px,0)}
}

/* Street tape / type belts */
.tape{
  position:absolute; left:-20vw; right:-20vw;
  height:64px;
  display:flex; align-items:center;
  font-weight:800;
  letter-spacing:.10em;
  text-transform:uppercase;
  white-space:nowrap;
  transform: rotate(-6deg);
  mix-blend-mode:screen;
  opacity:.95;
  filter: contrast(1.2);
}
.tape.red{
  background:var(--bar);
  top:18%;
  animation: tapeL 10s linear infinite;
}
.tape.black{
  background:var(--bar2);
  top:32%;
  height:54px;
  transform: rotate(7deg);
  animation: tapeR 12s linear infinite;
  opacity:.88;
}
.tape .txt{
  padding-left:22px;
  font-size:18px;
  line-height:1;
  color:#fff;
  font-family:var(--sans);
}
@keyframes tapeL{
  0%{transform:translateX(0) rotate(-6deg)}
  100%{transform:translateX(-40vw) rotate(-6deg)}
}
@keyframes tapeR{
  0%{transform:translateX(-10vw) rotate(7deg)}
  100%{transform:translateX(40vw) rotate(7deg)}
}

/* Center slab */
#slab{
  position:absolute;
  left:50%; top:58%;
  transform:translate(-50%,-50%);
  width:min(980px, calc(100vw - 26px));
  border:1px solid rgba(255,255,255,0.18);
  background:rgba(0,0,0,0.35);
  backdrop-filter: blur(5px);
  padding:14px;
  z-index:6;
}
#slab .head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}
#slab .brand{
  display:flex; align-items:center; gap:10px;
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.12em;
  text-transform:uppercase;
}
#slab .sq{
  width:10px; height:10px;
  border:1px solid var(--fg);
  background:#000;
}
#slab .status{
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.10em;
  text-transform:uppercase;
  color:rgba(255,255,255,0.65);
}
#slab .title{
  margin-top:10px;
  font-size:48px;
  font-weight:900;
  letter-spacing:.02em;
  text-transform:uppercase;
  line-height:1.02;
}
#slab .title .bar{
  display:inline-block;
  background:var(--bar);
  padding:6px 10px 8px 10px;
  margin-right:8px;
}
#slab .sub{
  margin-top:10px;
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.10em;
  text-transform:uppercase;
  color:rgba(255,255,255,0.72);
  line-height:1.45;
}
#slab .ctaRow{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  margin-top:14px;
}
.btn{
  background:transparent;
  color:var(--fg);
  border:1px solid rgba(255,255,255,0.26);
  padding:10px 14px;
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.10em;
  text-transform:uppercase;
  cursor:pointer;
}
.btn:hover{border-color:rgba(255,255,255,0.70)}
.btn.primary{
  background:var(--bar);
  border-color:var(--bar);
  color:#fff;
}
.btn.primary:hover{filter:brightness(1.03)}
.pill{
  border:1px solid rgba(255,255,255,0.20);
  padding:6px 10px;
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.10em;
  text-transform:uppercase;
  color:rgba(255,255,255,0.72);
}
#count{color:#fff}

/* Top / bottom bars (KETADATA universal IO) */
.topbar{
  position:absolute; top:0; left:0; right:0;
  height:var(--top);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 10px;
  border-bottom:1px solid var(--line);
  background:linear-gradient(180deg,#070707,#000);
  z-index:10;
}
.actions{display:flex; align-items:center; gap:8px; font-family:var(--mono); font-size:12px}
.kbd{border:1px solid var(--line2); padding:2px 6px; color:var(--muted); font-size:11px}

.ketaIcon{
  width:16px; height:16px;
  border:2px solid var(--fg);
  background:var(--fg);
  cursor:pointer;
}
.ketaIcon.open{background:#000}

.bottombar{
  position:absolute; left:0; right:0; bottom:0;
  height:var(--bot);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 10px;
  border-top:1px solid var(--line);
  background:linear-gradient(0deg,#070707,#000);
  z-index:10;
  font-family:var(--mono);
  font-size:11px;
  color:var(--muted);
}
.toggle{
  border:1px solid var(--line2);
  background:transparent;
  color:var(--fg);
  padding:4px 8px;
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.10em;
  text-transform:uppercase;
  cursor:pointer;
}
.toggle:hover{border-color:var(--fg)}

.drawer{
  position:absolute;
  left:0; right:0; bottom:var(--bot);
  height:46%;
  min-height:260px;
  border-top:1px solid var(--line);
  background:linear-gradient(180deg,#060606,#000);
  display:none;
  z-index:20;
}
.drawer.open{display:flex; flex-direction:column}
.drawerHead{
  padding:8px 10px;
  border-bottom:1px solid var(--line);
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.12em;
  text-transform:uppercase;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.drawerBody{padding:10px; min-height:0; flex:1; overflow:auto}
textarea{
  width:100%;
  border:1px solid var(--line2);
  background:#050505;
  color:var(--fg);
  font-family:var(--mono);
  font-size:12px;
  padding:10px;
  line-height:1.35;
  outline:none;
  resize:vertical;
  min-height:160px;
}

/* KETA NOTE */
.ketaNote{
  position:absolute;
  top:60px; right:16px;
  width:340px; height:220px;
  display:none;
  z-index:30;
  resize:both;
  overflow:hidden;
  border-radius:0;
  background:var(--ctl-bg);
  border:1px solid var(--note-border);
  backdrop-filter: blur(6px);
}
.ketaNote.open{display:flex; flex-direction:column}
.ketaHead{
  padding:8px 10px;
  border-bottom:1px solid rgba(255,255,255,0.14);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.14em;
  text-transform:uppercase;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:move;
}
.ketaBody{padding:10px; min-height:0; flex:1}
.ketaNote textarea{
  background:#000;
  border:1px solid rgba(255,255,255,0.22);
  width:100%;
  height:100%;
  resize:none;
}
.headBtn{
  background:transparent;
  color:var(--fg);
  border:1px solid rgba(255,255,255,0.18);
  padding:2px 8px;
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.08em;
  text-transform:uppercase;
  cursor:pointer;
}
.headBtn:hover{border-color:rgba(255,255,255,0.6)}

/* Toast */
.toast{
  position:absolute;
  left:12px;
  top:calc(var(--top) + 12px);
  padding:8px 10px;
  border:1px solid var(--line2);
  background:rgba(8,8,8,0.82);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.06em;
  color:var(--fg);
  display:none;
  z-index:40;
}
</style>
</head>

<body>
<div id="root" class="null">
  <div id="stage">
    <canvas id="c"></canvas>
    <div id="scan"></div>

    <div class="tape red" aria-hidden="true">
      <div class="txt" id="tapeRed"></div>
    </div>
    <div class="tape black" aria-hidden="true">
      <div class="txt" id="tapeBlack"></div>
    </div>

    <div id="slab">
      <div class="head">
        <div class="brand"><span class="sq"></span><span>KETADATA // SHOP</span></div>
        <div class="status">SLOPSTREAM HOLDING PAGE · K2 DROPPING SOON</div>
      </div>

      <div class="title">
        <span class="bar">K2</span><span>DROPS SOON</span>
      </div>

      <div class="sub" id="subCopy">
        LIMITED RUN DIGITAL OBJECTS · PRINTS · FILES · RITUAL COMMODITIES<br />
        THIS IS THE HOLDING CURRENT. FUNDING IS THE GATE.
      </div>

      <div class="ctaRow">
        <button class="btn primary" id="goFunding">GO TO FUNDING</button>
        <button class="btn" id="toggleNull">EXIT NULL</button>
        <span class="pill">AUTO-REDIRECT IN <span id="count">12</span>S</span>
        <span class="pill">SHIFT+0 NULL · SHIFT+I INVERT · SHIFT+` HOME</span>
      </div>
    </div>
  </div>

  <!-- TOP BAR -->
  <div class="topbar">
    <div style="display:flex; gap:10px; align-items:center">
      <div style="display:flex; align-items:center; gap:10px; font-family:var(--mono); font-size:12px; letter-spacing:.12em; text-transform:uppercase">
        <span style="width:10px;height:10px;border:1px solid #fff;background:#000;display:inline-block"></span>
        <span>KETADATA // SHOP SLOPSTREAM</span>
      </div>
      <div style="display:flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted); border:1px solid var(--line2); padding:4px 8px">
        <span>ROOM</span><span id="roomName">SHOP</span>
      </div>
    </div>

    <div class="actions">
      <button class="btn" id="btnImport">IMPORT</button>
      <button class="btn" id="btnExport">EXPORT</button>
      <button class="btn" id="btnCopy">COPY</button>
      <button class="btn" id="btnNull">NULL</button>
      <span class="kbd">SHIFT+0</span>
      <span class="kbd">SHIFT+I</span>
      <span class="kbd">1–6</span>
      <span class="kbd">SPACE</span>
      <div id="ketaIcon" class="ketaIcon" title="KETA_NOTE"></div>
    </div>
  </div>

  <!-- DRAWER -->
  <div class="drawer" id="drawer">
    <div class="drawerHead">
      <div>SYSTEM</div>
      <div style="display:flex; gap:8px; align-items:center">
        <span id="sig" style="color:var(--muted); font-family:var(--mono); font-size:11px">∅</span>
        <button class="btn" id="btnCloseDrawer">CLOSE</button>
      </div>
    </div>
    <div class="drawerBody">
      <textarea id="universals" placeholder="UNIVERSALS / LAWS / COPY."></textarea>
      <div style="margin-top:10px; font-family:var(--mono); font-size:11px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted)">
        EXPORT ENVELOPE: { STORAGE_KEY, FILE_ID, ROOM_ID, VERSION_ID, STATE }
      </div>
    </div>
  </div>

  <!-- BOTTOM BAR -->
  <div class="bottombar">
    <div style="display:flex; gap:10px; align-items:center">
      <button class="toggle" id="toggleDrawer">SYSTEM</button>
      <span>STATE: <span id="sig2">∅</span></span>
      <span style="margin-left:8px">NULL: <span id="nullLabel">ON</span></span>
    </div>
    <div style="display:flex; gap:12px; align-items:center">
      <span>LIGHT: <span id="lightLabel">1</span></span>
      <span>RUN: <span id="runLabel">OFF</span></span>
    </div>
  </div>

  <!-- KETA NOTE -->
  <div class="ketaNote" id="ketaNote">
    <div class="ketaHead" id="ketaHead">
      <div>KETA_NOTE</div>
      <button class="headBtn" id="btnHideNote">-</button>
    </div>
    <div class="ketaBody">
      <textarea id="ketaText" placeholder="GLOBAL NOTE"></textarea>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <input id="file" type="file" accept="application/json" style="display:none" />
</div>

<script>
/* =========================================================
KETADATA: CORE CONSTANTS
========================================================= */
const SHELL_HOME_URL = "system.html";
const FUNDING_URL = "funding.html";

const FILE_ID = "SHOP_SLOPSTREAM_K2";
const ROOM_ID = "SHOP";
const VERSION_ID = "shop.slopstream.k2.v1";
const STORAGE_KEY = `KDT::STATE::${FILE_ID}::${ROOM_ID}::${VERSION_ID}`;
const GLOBAL_KETA_NOTE_KEY = "KDT_GLOBAL_KETA_NOTE_V1";

const DEFAULT = {
  version: "KETADATA_SHELL_KERNEL_v1",
  updatedAt: new Date().toISOString(),

  room: "SHOP",
  ketaNote: "",
  universals: "",

  ketaNoteMeta: {
    version: "KETA_NOTE_META_v1",
    noteId: "GLOBAL",
    roomId: "SHOP",
    stateId: null,
    categoryIds: [],
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  },

  ui: {
    invert: false,
    nullMode: true,            // ENTRY: NULL MODE ON
    lightPreset: 1,
    lightRunning: false
  },

  payload: {
    redirectSeconds: 12,
    redirectEnabled: true,
    copy: {
      sub: "LIMITED RUN DIGITAL OBJECTS · PRINTS · FILES · RITUAL COMMODITIES\nTHIS IS THE HOLDING CURRENT. FUNDING IS THE GATE."
    },
    tape: {
      red: "KETADATA SHOP / K2 DROPPING SOON / FUND THE MACHINE / ",
      black: "NO SOUVENIRS / ONLY OBJECTS / ONLY FILES / ONLY SYSTEMS / "
    },
    slop: {
      speed: 0.9,
      grit: 0.55,
      pull: 0.65,
      seed: null
    }
  }
};

let STATE = loadLocal() || structuredClone(DEFAULT);
const $ = (id)=>document.getElementById(id);
const root = $("root");
const stage = $("stage");

/* GLOBAL NOTE continuity */
{ const g = loadGlobalKetaNote(); if(g) STATE.ketaNote = g; }

function nowISO(){ return new Date().toISOString(); }
function loadGlobalKetaNote(){ try{return localStorage.getItem(GLOBAL_KETA_NOTE_KEY) ?? ""}catch(e){return ""} }
function saveGlobalKetaNote(t){ try{localStorage.setItem(GLOBAL_KETA_NOTE_KEY, String(t??""))}catch(e){} }

function stableSig(){
  const core = JSON.stringify({
    v:STATE.version, room:STATE.room,
    i:STATE.ui.invert, n:STATE.ui.nullMode,
    p:STATE.ui.lightPreset, r:STATE.ui.lightRunning,
    u:(STATE.universals||"").length,
    k:(STATE.ketaNote||"").length,
    s:STATE.payload.slop.seed ?? 0
  });
  let h=2166136261;
  for(let i=0;i<core.length;i++){ h^=core.charCodeAt(i); h=Math.imul(h,16777619); }
  return (h>>>0).toString(16).slice(0,8);
}

function ensureKetaNoteMeta(){
  if(!STATE.ketaNoteMeta || typeof STATE.ketaNoteMeta !== "object"){
    STATE.ketaNoteMeta = structuredClone(DEFAULT.ketaNoteMeta);
  }else{
    STATE.ketaNoteMeta = Object.assign(structuredClone(DEFAULT.ketaNoteMeta), STATE.ketaNoteMeta);
  }
}

function syncKetaNoteMeta(reason){
  ensureKetaNoteMeta();
  STATE.ketaNoteMeta.roomId = String(STATE.room||"SHOP").trim().toUpperCase();
  STATE.ketaNoteMeta.stateId = stableSig();
  STATE.ketaNoteMeta.updatedAt = nowISO();
  if(reason){
    STATE.ketaNoteMeta._last = { reason, at: STATE.ketaNoteMeta.updatedAt };
  }
}

function mergeDefault(obj){
  const out = structuredClone(DEFAULT);
  Object.assign(out, obj||{});
  out.ui = Object.assign(structuredClone(DEFAULT.ui), (obj&&obj.ui)||{});
  out.payload = Object.assign(structuredClone(DEFAULT.payload), (obj&&obj.payload)||{});
  if(obj && obj.ketaNoteMeta){
    out.ketaNoteMeta = Object.assign(structuredClone(DEFAULT.ketaNoteMeta), obj.ketaNoteMeta);
  }
  return out;
}

function loadLocal(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    return mergeDefault(JSON.parse(raw));
  }catch(e){ return null; }
}

function persist(){
  STATE.updatedAt = nowISO();
  syncKetaNoteMeta("persist");
  saveGlobalKetaNote(STATE.ketaNote || "");
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE)); }catch(e){}
  render();
}

function exportState(){
  syncKetaNoteMeta("export");
  return JSON.stringify({ STORAGE_KEY, FILE_ID, ROOM_ID, VERSION_ID, STATE }, null, 2);
}

function importState(text){
  const parsed = JSON.parse(text);
  const incoming = (parsed && parsed.STATE) ? parsed.STATE : parsed;
  STATE = mergeDefault(incoming);
  saveGlobalKetaNote(STATE.ketaNote || "");
  stopLight(true);
  if(STATE.ui.lightRunning) startLight(STATE.ui.lightPreset);
  syncKetaNoteMeta("import");
  persist();
}

function download(filename, text){
  const blob = new Blob([text], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 800);
}

async function copy(text){
  try{ await navigator.clipboard.writeText(text); toast("COPIED"); }
  catch(e){ toast("COPY FAILED"); }
}

/* UI */
function setInvert(on){ STATE.ui.invert = !!on; persist(); }
function setNull(on){
  STATE.ui.nullMode = !!on;
  if(STATE.ui.nullMode){
    setDrawer(false);
    setKetaNote(false);
  }
  persist();
}
function toggleNull(){ setNull(!STATE.ui.nullMode); toast(STATE.ui.nullMode ? "NULL ON" : "NULL OFF"); }

function setDrawer(open){ $("drawer").classList.toggle("open", !!open); }
function setKetaNote(open){
  $("ketaNote").classList.toggle("open", !!open);
  $("ketaIcon").classList.toggle("open", !!open);
}

let toastTimer=null;
function toast(msg){
  if(STATE.ui.nullMode) return;
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ t.style.display="none"; }, 900);
}

function goFunding(){
  window.location.href = FUNDING_URL;
}
function goHome(){
  if(!SHELL_HOME_URL) return;
  window.location.href = SHELL_HOME_URL;
}

/* LIGHTS (same primitive set 1–6; harsh is fine) */
let lightInterval=null, lightCount=0, a1=0, a2=0;
function resetStageFX(){
  stage.style.backgroundColor="#000";
  stage.style.filter="none";
  lightCount=0; a1=0; a2=0;
}
function startLight(preset){
  stopLight(true);
  resetStageFX();
  STATE.ui.lightPreset = preset;
  STATE.ui.lightRunning = true;

  if(preset===1){
    lightInterval=setInterval(()=>{
      const curr = stage.style.backgroundColor || "black";
      stage.style.backgroundColor = (curr==="black" || curr==="rgb(0, 0, 0)") ? "white" : "black";
      stage.style.filter="none";
    }, 60);
  }
  if(preset===2){
    lightInterval=setInterval(()=>{
      a1=(a1+30)%360; a2+=0.6;
      const l=50+Math.sin(a2)*40;
      stage.style.backgroundColor=`hsl(${a1}, 100%, ${l}%)`;
      stage.style.filter="none";
    }, 12);
  }
  if(preset===3){
    lightInterval=setInterval(()=>{
      lightCount++;
      const beat = lightCount%14;
      if(beat===0||beat===1){ stage.style.backgroundColor="#fff"; stage.style.filter="invert(1) contrast(4)"; }
      else if(beat===2){ stage.style.backgroundColor="#000"; stage.style.filter="invert(1) contrast(3)"; }
      else if(beat===3){ stage.style.backgroundColor="#00ff00"; stage.style.filter="contrast(2) saturate(4)"; }
      else if(beat===4){ stage.style.backgroundColor="#ff00ff"; stage.style.filter="invert(1) hue-rotate(90deg)"; }
      else { stage.style.backgroundColor="#000"; stage.style.filter="none"; }
    }, 35);
  }
  if(preset===4){
    lightInterval=setInterval(()=>{
      a1+=0.09; lightCount++;
      const red=Math.abs(Math.sin(a1))*255;
      const pulse=Math.abs(Math.sin(a1*0.5));
      const contrast=2+pulse*2;
      stage.style.backgroundColor=`rgb(${red},0,0)`;
      stage.style.filter=`contrast(${contrast}) saturate(3) brightness(${1.2+pulse*0.7})`;
      if(lightCount%22===0){ stage.style.backgroundColor="#fff"; stage.style.filter="brightness(4) contrast(5)"; }
    }, 22);
  }
  if(preset===5){
    lightInterval=setInterval(()=>{
      a1+=18;
      const hue=260+Math.sin(a1*0.1)*45;
      stage.style.backgroundColor=`hsl(${hue}, 90%, 36%)`;
      stage.style.filter=`contrast(2.2) saturate(2.8) hue-rotate(${a1*0.4}deg)`;
    }, 26);
  }
  if(preset===6){
    lightInterval=setInterval(()=>{
      lightCount++;
      if(lightCount%40===0||lightCount%40===1){
        stage.style.backgroundColor="#fff";
        stage.style.filter="brightness(5) contrast(6)";
      } else {
        stage.style.backgroundColor="#000";
        stage.style.filter="none";
      }
    }, 30);
  }
  persist();
}
function stopLight(silent=false){
  if(lightInterval){clearInterval(lightInterval); lightInterval=null;}
  STATE.ui.lightRunning=false;
  resetStageFX();
  if(!silent) persist();
}
function selectPreset(p){
  STATE.ui.lightPreset=p;
  if(STATE.ui.lightRunning) startLight(p);
  else persist();
}

/* Render */
function render(){
  root.classList.toggle("invert", !!STATE.ui.invert);
  root.classList.toggle("null", !!STATE.ui.nullMode);

  $("roomName").textContent = (STATE.room||"SHOP").toUpperCase();
  $("universals").value = STATE.universals || "";
  $("ketaText").value = STATE.ketaNote || "";

  $("subCopy").innerHTML = (STATE.payload.copy.sub || "").split("\n").map(s=>s.trim()).filter(Boolean).join("<br />");

  const rr = STATE.payload.tape.red || "";
  const bb = STATE.payload.tape.black || "";
  $("tapeRed").textContent = rr.repeat(4);
  $("tapeBlack").textContent = bb.repeat(5);

  const s = stableSig();
  $("sig").textContent = s;
  $("sig2").textContent = s;

  $("lightLabel").textContent = String(STATE.ui.lightPreset);
  $("runLabel").textContent = STATE.ui.lightRunning ? "ON" : "OFF";
  $("nullLabel").textContent = STATE.ui.nullMode ? "ON" : "OFF";
}

/* IO buttons */
$("btnImport").addEventListener("click", ()=> $("file").click());
$("file").addEventListener("change", async (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const txt = await f.text();
  importState(txt);
  e.target.value = "";
  toast("STATE IMPORTED");
});
$("btnExport").addEventListener("click", ()=>{ download("SHOP_SLOPSTREAM_state.json", exportState()); toast("STATE EXPORTED"); });
$("btnCopy").addEventListener("click", ()=> copy(exportState()));
$("btnNull").addEventListener("click", ()=> toggleNull());

$("toggleDrawer").addEventListener("click", ()=>{
  if(STATE.ui.nullMode) return;
  setDrawer(!$("drawer").classList.contains("open"));
});
$("btnCloseDrawer").addEventListener("click", ()=> setDrawer(false));

$("universals").addEventListener("input", ()=>{
  STATE.universals = $("universals").value;
  persist();
});

$("ketaIcon").addEventListener("click", ()=>{
  if(STATE.ui.nullMode) return;
  const open = !$("ketaNote").classList.contains("open");
  setKetaNote(open);
});
$("btnHideNote").addEventListener("click", ()=> setKetaNote(false));
$("ketaText").addEventListener("input", ()=>{
  STATE.ketaNote = $("ketaText").value;
  saveGlobalKetaNote(STATE.ketaNote);
  persist();
});

/* Slab controls */
$("goFunding").addEventListener("click", goFunding);
$("toggleNull").addEventListener("click", toggleNull);

/* Hotkeys */
document.addEventListener("keydown", (e)=>{
  const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
  const typing = (tag==="textarea" || tag==="input");

  if(e.shiftKey && e.key.toLowerCase()==="i"){ e.preventDefault(); setInvert(!STATE.ui.invert); return; }
  if(e.shiftKey && e.key==="0"){ e.preventDefault(); toggleNull(); return; }
  if(e.shiftKey && e.key==="`"){ e.preventDefault(); goHome(); return; }

  if(!typing && /^[1-6]$/.test(e.key)){ e.preventDefault(); selectPreset(parseInt(e.key,10)); return; }

  if(!typing && (e.code==="Space" || e.key===" ")){
    e.preventDefault();
    if(STATE.ui.lightRunning) stopLight(true);
    else startLight(STATE.ui.lightPreset);
    persist();
    return;
  }

  if(e.key==="Escape"){
    setDrawer(false); setKetaNote(false);
    stopLight(true);
    setNull(false);
    return;
  }
});

/* Drag note */
(function dragNote(){
  const box = $("ketaNote");
  const head = $("ketaHead");
  let dragging=false, ox=0, oy=0;
  head.addEventListener("mousedown", (e)=>{
    if(e.target.closest("button")) return;
    dragging=true;
    const r = box.getBoundingClientRect();
    ox = e.clientX - r.left;
    oy = e.clientY - r.top;
    box.style.left = r.left + "px";
    box.style.top  = r.top + "px";
    box.style.right = "auto";
  });
  window.addEventListener("mousemove", (e)=>{
    if(!dragging) return;
    box.style.left = (e.clientX - ox) + "px";
    box.style.top  = (e.clientY - oy) + "px";
  });
  window.addEventListener("mouseup", ()=> dragging=false);
})();

/* =========================================================
AUTO REDIRECT (funding.html)
========================================================= */
let redirectTimer=null;
function startRedirect(){
  stopRedirect();
  if(!STATE.payload.redirectEnabled) return;

  let n = Math.max(1, parseInt(STATE.payload.redirectSeconds,10) || 12);
  $("count").textContent = String(n);

  redirectTimer = setInterval(()=>{
    n -= 1;
    $("count").textContent = String(Math.max(0,n));
    if(n <= 0){
      stopRedirect();
      goFunding();
    }
  }, 1000);
}
function stopRedirect(){
  if(redirectTimer){ clearInterval(redirectTimer); redirectTimer=null; }
}

/* =========================================================
CANVAS SLOPSTREAM (immersive harsh tunnel)
========================================================= */
(function slopstream(){
  const canvas = $("c");
  const ctx = canvas.getContext("2d", { alpha: false });
  let W=0,H=0,DPR=1;

  function resize(){
    DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    W = Math.floor(window.innerWidth * DPR);
    H = Math.floor(window.innerHeight * DPR);
    canvas.width = W; canvas.height = H;
  }
  window.addEventListener("resize", resize, {passive:true});
  resize();

  // seed + rng
  let seed = (STATE.payload.slop.seed ?? ((Math.random()*1e9)>>>0));
  STATE.payload.slop.seed = seed;
  function rnd(){
    seed ^= seed << 13; seed >>>= 0;
    seed ^= seed >> 17; seed >>>= 0;
    seed ^= seed << 5;  seed >>>= 0;
    return (seed>>>0)/4294967296;
  }

  // mouse pull
  let mx=0,my=0;
  window.addEventListener("mousemove",(e)=>{
    mx = (e.clientX/window.innerWidth)*2-1;
    my = (e.clientY/window.innerHeight)*2-1;
  },{passive:true});

  let t0 = performance.now();
  function frame(now){
    const dt = Math.min(0.05, (now - t0)/1000);
    t0 = now;

    const speed = (STATE.payload.slop.speed ?? 0.9);
    const grit  = (STATE.payload.slop.grit ?? 0.55);
    const pull  = (STATE.payload.slop.pull ?? 0.65);

    // base clear
    ctx.fillStyle = "#000";
    ctx.fillRect(0,0,W,H);

    const cx = W*0.5 + mx*W*0.06*pull;
    const cy = H*0.5 + my*H*0.06*pull;

    // tunnel rings + shards
    const rings = 120;
    const time = now/1000;

    for(let i=0;i<rings;i++){
      const z = (i / rings);
      const p = (z*z);
      const r = (Math.min(W,H) * (0.08 + p*0.58)) * (1 + 0.02*Math.sin(time*2 + i));
      const a = 0.20 * (1 - z) + 0.12*grit;

      // alternating brutal contrast
      const inv = (i % 7 === 0);
      ctx.strokeStyle = inv ? `rgba(255,255,255,${a})` : `rgba(255,255,255,${a*0.55})`;
      ctx.lineWidth = (1.0 + (1-z)*1.3) * DPR;

      const wob = 0.22*grit*(rnd()-0.5) + 0.10*Math.sin(time*speed + i*0.12);
      ctx.beginPath();
      const seg = 34;
      for(let s=0;s<=seg;s++){
        const u = s/seg;
        const ang = u*Math.PI*2;
        const k = 1 + 0.12*grit*Math.sin(ang*6 + time*1.2 + i*0.03) + wob;
        const x = cx + Math.cos(ang + wob) * r * k;
        const y = cy + Math.sin(ang - wob) * r * k;
        if(s===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();

      // shards / graffiti scratches
      if(i % 3 === 0){
        const count = 3 + ((i%9)===0 ? 4 : 0);
        for(let k=0;k<count;k++){
          const ang = rnd()*Math.PI*2;
          const rr = r * (0.65 + rnd()*0.5);
          const x1 = cx + Math.cos(ang) * rr;
          const y1 = cy + Math.sin(ang) * rr;
          const x2 = cx + Math.cos(ang + 0.6*(rnd()-0.5)) * (rr + (20+80*rnd())*DPR);
          const y2 = cy + Math.sin(ang + 0.6*(rnd()-0.5)) * (rr + (20+80*rnd())*DPR);
          ctx.strokeStyle = `rgba(255,255,255,${0.06 + 0.10*grit})`;
          ctx.lineWidth = (0.7 + 1.0*rnd()) * DPR;
          ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
        }
      }
    }

    // center void / glare
    const g = ctx.createRadialGradient(cx,cy, 0, cx,cy, Math.min(W,H)*0.55);
    g.addColorStop(0, "rgba(0,0,0,0)");
    g.addColorStop(0.35, "rgba(0,0,0,0.28)");
    g.addColorStop(1, "rgba(0,0,0,0.92)");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    // noise
    const nAlpha = 0.10 + 0.20*grit;
    ctx.fillStyle = `rgba(255,255,255,${nAlpha})`;
    for(let i=0;i<280;i++){
      const x = (rnd()*W)|0;
      const y = (rnd()*H)|0;
      const w = (1 + (rnd()*2)|0) * DPR;
      const h = (1 + (rnd()*2)|0) * DPR;
      ctx.fillRect(x,y,w,h);
    }

    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
})();

/* Boot */
ensureKetaNoteMeta();
syncKetaNoteMeta("boot");
render();
startRedirect();
</script>
</body>

<!--
============================================================
KETADATA HTML SERIALIZATION STAMP
FILE_ID: SHOP_SLOPSTREAM_K2
ROOM_ID: SHOP
VERSION: shop.slopstream.k2.v1
UPDATED_AT: 2025-12-25T00:00:00-05:00
INTENT: SHOP HOLDING PAGE / SLOPSTREAM. K2 DROPPING SOON. REDIRECT TO funding.html.
AE: HARSH BRUTALIST / STREET TAPE / RED BAR TYPOGRAPHY / SCANLINES / GRIT.
EE: EXPORTABLE STATE ENVELOPE. GLOBAL KETA_NOTE. NULL MODE ON ENTRY. INVERT. LIGHTS 1–6.
WB: LOCALSTORAGE SOVEREIGN KEY. IMPORT/EXPORT/COPY. MOVABLE NOTE (SQUARE ICON PRESET).
LOCALSTORAGE_KEY: KDT::STATE::SHOP_SLOPSTREAM_K2::SHOP::shop.slopstream.k2.v1
CHANGELOG:
- 2025-12-25: INITIAL SHOP SLOPSTREAM HOLDING PAGE + AUTO-REDIRECT TO FUNDING.
============================================================
-->
</html>

