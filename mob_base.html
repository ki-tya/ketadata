<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="theme-color" content="#000000" />
<title>KETADATA // MOB_BASE</title>

<style>
:root{
  --bg:#000;
  --fg:#fff;
  --muted:#8a8a8a;
  --line:#222;
  --line2:#333;
  --accent:#0f0;
  
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  --sans: Arial, system-ui, -apple-system;
  
  --header-h: 52px;
  --footer-h: 56px;
  --touch-min: 44px;
}

*{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
html,body{height:100%; margin:0; overflow:hidden}
body{
  background:var(--bg);
  color:var(--fg);
  font-family:var(--mono);
  font-size:13px;
  letter-spacing:.04em;
  touch-action:pan-y;
  overscroll-behavior:none;
}

/* LAYOUT */
#root{
  position:fixed;
  inset:0;
  display:flex;
  flex-direction:column;
  background:#000;
}

/* HEADER */
.header{
  height:var(--header-h);
  border-bottom:1px solid var(--line);
  background:linear-gradient(180deg,#0a0a0a,#000);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 12px;
  flex-shrink:0;
  z-index:100;
}
.brand{
  font-size:11px;
  letter-spacing:.12em;
  text-transform:uppercase;
  display:flex;
  align-items:center;
  gap:8px;
}
.brand .sq{
  width:8px;
  height:8px;
  border:1px solid var(--fg);
  background:#000;
}
.header-actions{
  display:flex;
  gap:6px;
  align-items:center;
}
.icon-btn{
  width:var(--touch-min);
  height:var(--touch-min);
  border:1px solid var(--line2);
  background:transparent;
  color:var(--fg);
  font-size:16px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition:border-color .15s;
}
.icon-btn:active{
  border-color:var(--fg);
  transform:scale(.95);
}

/* MAIN CONTENT */
.main{
  flex:1;
  overflow:hidden;
  position:relative;
}

/* SURFACE PLAYER */
#surfaceFrame{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  border:0;
  background:#000;
  display:none;
}
#surfaceFrame.active{display:block}

/* CONTENT AREA (when no surface playing) */
.content{
  position:absolute;
  inset:0;
  overflow-y:auto;
  overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
  display:none;
  padding:12px;
  padding-bottom:calc(var(--footer-h) + 12px);
}
.content.active{display:block}

/* CATEGORIES */
.category{
  border:1px solid var(--line2);
  margin-bottom:12px;
  background:rgba(255,255,255,.02);
}
.cat-header{
  padding:12px;
  border-bottom:1px solid var(--line);
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:11px;
  letter-spacing:.10em;
  text-transform:uppercase;
  cursor:pointer;
  min-height:var(--touch-min);
}
.cat-header:active{background:rgba(255,255,255,.05)}
.cat-count{
  color:var(--muted);
  font-size:10px;
}
.cat-body{
  display:none;
  padding:8px;
  max-height:400px;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
}
.cat-body.open{display:block}

/* LINK ITEMS */
.link-item{
  min-height:var(--touch-min);
  border:1px solid var(--line2);
  padding:10px 12px;
  margin-bottom:6px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  cursor:pointer;
  transition:border-color .15s;
}
.link-item:active{
  border-color:var(--fg);
  background:rgba(255,255,255,.08);
}
.link-name{
  flex:1;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  font-size:12px;
  letter-spacing:.06em;
}
.link-actions{
  display:flex;
  gap:4px;
  flex-shrink:0;
}
.mini-btn{
  width:32px;
  height:32px;
  border:1px solid var(--line2);
  background:#000;
  color:var(--fg);
  font-size:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  font-family:var(--mono);
}
.mini-btn:active{
  border-color:var(--fg);
  transform:scale(.95);
}

/* SEARCH */
.search-box{
  margin-bottom:12px;
  position:sticky;
  top:0;
  background:#000;
  z-index:10;
  padding-bottom:8px;
}
.search-input{
  width:100%;
  min-height:var(--touch-min);
  background:#000;
  border:1px solid var(--line2);
  color:var(--fg);
  font-family:var(--mono);
  font-size:13px;
  padding:0 12px;
  letter-spacing:.06em;
}
.search-input:focus{
  outline:none;
  border-color:var(--fg);
}

/* FOOTER NAV */
.footer{
  height:var(--footer-h);
  border-top:1px solid var(--line);
  background:linear-gradient(0deg,#0a0a0a,#000);
  display:flex;
  align-items:stretch;
  flex-shrink:0;
  z-index:100;
}
.nav-btn{
  flex:1;
  border:0;
  border-right:1px solid var(--line);
  background:transparent;
  color:var(--muted);
  font-family:var(--mono);
  font-size:10px;
  letter-spacing:.10em;
  text-transform:uppercase;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;
  cursor:pointer;
  transition:color .15s;
}
.nav-btn:last-child{border-right:0}
.nav-btn.active{
  color:var(--fg);
  background:rgba(255,255,255,.05);
}
.nav-btn:active{
  background:rgba(255,255,255,.1);
}
.nav-icon{
  font-size:18px;
  line-height:1;
}

/* ARMED BAR */
.armed-bar{
  padding:12px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,.9);
  margin-bottom:12px;
  display:none;
}
.armed-bar.active{display:block}
.armed-label{
  font-size:10px;
  letter-spacing:.10em;
  text-transform:uppercase;
  color:var(--muted);
  margin-bottom:6px;
}
.armed-name{
  font-size:13px;
  letter-spacing:.06em;
  margin-bottom:8px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.armed-url{
  font-size:10px;
  color:var(--muted);
  margin-bottom:10px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.armed-actions{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}
.btn{
  min-height:var(--touch-min);
  padding:0 16px;
  border:1px solid var(--line2);
  background:#000;
  color:var(--fg);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
  cursor:pointer;
  flex:1;
  min-width:80px;
}
.btn:active{
  border-color:var(--fg);
  transform:scale(.98);
}

/* LIGHTS PANEL */
.lights-panel{
  padding:12px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,.9);
  margin-bottom:12px;
}
.lights-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
  margin-bottom:8px;
}
.light-btn{
  min-height:var(--touch-min);
  border:1px solid var(--line2);
  background:#000;
  color:var(--fg);
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.08em;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
.light-btn.active{
  border-color:var(--fg);
  background:rgba(255,255,255,.1);
}
.light-btn:active{
  transform:scale(.95);
}

/* STAGE (light effects) */
#stage{
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:999;
  background:#000;
  display:none;
}
#stage.active{display:block}

/* TOAST */
.toast{
  position:fixed;
  top:calc(var(--header-h) + 12px);
  left:50%;
  transform:translateX(-50%);
  padding:10px 16px;
  background:rgba(0,0,0,.95);
  border:1px solid var(--fg);
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
  z-index:9999;
  display:none;
  white-space:nowrap;
}

/* EMPTY STATE */
.empty-state{
  text-align:center;
  padding:40px 20px;
  color:var(--muted);
  font-size:12px;
  letter-spacing:.06em;
}

/* UTILS */
.hidden{display:none !important}
</style>
</head>

<body>
<div id="root">
  <!-- HEADER -->
  <div class="header">
    <div class="brand">
      <span class="sq"></span>
      <span>KETADATA</span>
    </div>
    <div class="header-actions">
      <button class="icon-btn" id="btnMenu" title="Menu">☰</button>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <!-- SURFACE PLAYER -->
    <iframe id="surfaceFrame" title="SURFACE"></iframe>

    <!-- CONTENT -->
    <div class="content active" id="contentLinks">
      <div class="search-box">
        <input type="text" class="search-input" id="searchInput" placeholder="SEARCH LINKS..." />
      </div>

      <div class="armed-bar" id="armedBar">
        <div class="armed-label">ARMED</div>
        <div class="armed-name" id="armedName">—</div>
        <div class="armed-url" id="armedUrl">—</div>
        <div class="armed-actions">
          <button class="btn" id="btnGo">GO</button>
          <button class="btn" id="btnSurface">SURFACE</button>
          <button class="btn" id="btnCopy">COPY</button>
        </div>
      </div>

      <div id="categoriesContainer"></div>
    </div>

    <div class="content" id="contentLights">
      <div class="lights-panel">
        <div class="armed-label" style="margin-bottom:12px">LIGHT PRESETS</div>
        <div class="lights-grid">
          <button class="light-btn" data-light="1">L1</button>
          <button class="light-btn" data-light="2">L2</button>
          <button class="light-btn" data-light="3">L3</button>
          <button class="light-btn" data-light="4">L4</button>
          <button class="light-btn" data-light="5">L5</button>
          <button class="light-btn" data-light="6">L6</button>
        </div>
        <div class="armed-actions">
          <button class="btn" id="btnRun">RUN</button>
          <button class="btn" id="btnStop">STOP</button>
        </div>
      </div>
      
      <div class="empty-state">
        SPACE = TOGGLE RUN<br/>
        TAP PRESET TO SELECT<br/>
        RUN TO START SEQUENCE
      </div>
    </div>

    <div class="content" id="contentSettings">
      <div class="lights-panel">
        <div class="armed-label" style="margin-bottom:12px">SYSTEM</div>
        <div class="armed-actions" style="flex-direction:column">
          <button class="btn" id="btnExport">EXPORT STATE</button>
          <button class="btn" id="btnImport">IMPORT STATE</button>
          <button class="btn" id="btnClear">CLEAR STATE</button>
          <button class="btn" id="btnStopSurface">STOP SURFACE</button>
        </div>
      </div>
      
      <div class="empty-state">
        MOB_BASE v1.0<br/>
        MOBILE KETADATA SHELL<br/>
        LOCAL-FIRST STORAGE
      </div>
    </div>
  </div>

  <!-- FOOTER NAV -->
  <div class="footer">
    <button class="nav-btn active" data-tab="links">
      <span class="nav-icon">⚡</span>
      <span>LINKS</span>
    </button>
    <button class="nav-btn" data-tab="lights">
      <span class="nav-icon">◉</span>
      <span>LIGHTS</span>
    </button>
    <button class="nav-btn" data-tab="settings">
      <span class="nav-icon">⚙</span>
      <span>SYSTEM</span>
    </button>
  </div>

  <!-- STAGE -->
  <div id="stage"></div>

  <!-- TOAST -->
  <div class="toast" id="toast"></div>

  <input type="file" id="fileInput" accept="application/json" style="display:none" />
</div>

<script>
// ===== UTILITIES =====
const $=(id)=>document.getElementById(id);
function toast(msg,dur=1200){
  const t=$("toast");
  t.textContent=String(msg||"");
  t.style.display="block";
  setTimeout(()=>{t.style.display="none";},dur);
}
async function copy(text){
  try{
    await navigator.clipboard.writeText(String(text||""));
    toast("COPIED");
  }catch(e){
    toast("COPY FAILED");
  }
}
function hash8(str){
  const s=String(str||"");
  let h=2166136261;
  for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,16777619);}
  return (h>>>0).toString(16).slice(0,8);
}

// ===== DATA =====
const CATEGORIES=[
  {
    name:"LATEST (TENNIS & CATBALL)",
    links:[
      "catball.html","catball1.html","ktball.html","ktball1.html",
      "serve.html","serve1.html","serve2.html",
      "tball.html","tball1.html","tball2.html","tball3.html","tball4.html","tball5.html","tball6.html","tball7.html",
      "tennisball.html","tennisball0.html","tennisball2.html","tennisball3.html","tennisball4.html","tennisball5.html",
      "tennisball6.html","tennisball7.html","tennisball8.html","tennisball9.html","tennisball10.html","tennisball11.html",
      "tennisball12.html","tennisball13.html","tennisball14.html","tennisball15.html","tennisball16.html","tennisball91.html",
      "tennisball666.html","tenniscourt.html"
    ]
  },
  {
    name:"KETADATA / SYSTEM SEMANTICS",
    links:[
      "2812.html","depth.html","drugprotocol.html","fivethirtysix.html","intra.html","kmas.html",
      "memofest0.html","memofesto1.html","memofesto11.html","memofesto22.html",
      "metadata.html","metadata1.html","sur_base2.html"
    ]
  },
  {
    name:"KETA-CORE (PARTY ENTRANCE / MAIN)",
    links:[
      "anniversary1.html","anniversary11.html","anniversary111.html","aniversary1111.html",
      "crunch1.html","index.html","index11.html","index013.html","index_copy.html",
      "kdtv1.html","lib_gpt.html","liminal11.html","map.html","memofesto.html",
      "mirror.html","mirror1.html","obscura.html","room.html","screen6.html","thing.html"
    ]
  },
  {
    name:"BLEAK-TECH",
    links:[
      "67.html","ball.html","beatball.html","blacklotus2.html","bleak.html",
      "cashapp1.html","cashapp3.html","chakra.html"
    ]
  },
  {
    name:"CORE-UTIL (TOOLS & FRAMEWORKS)",
    links:[
      "acid_doc.html","board.htm","board1.htm","board2.html","board3.html","calendar1.html",
      "cctv1.html","circle.html","color1.html","color3.html","color5.html","compiler.html",
      "contextifier.htm","controller.html","controller1.html","controller2.html","controller3.html",
      "darkroom1.html","doc2.html","doc6.html","editor.html","font.html","libra.html",
      "manifest5.html","modern.html","pdf2jpeg7.htm","pdf2jpeg8.html","pdfreader.html",
      "pdfreader1.html","popsplit.html","prompt1.html","prompt3.html","router1.html",
      "sensory3.html","sheets.html","socials3.html","storage1.html","studio.html",
      "studiov1.html","surface1.html","to-do2.html","vidlist.html","wordbowl.html"
    ]
  },
  {
    name:"KETA-MONO (ENTITIES, PHILOSOPHY, IMAGERY)",
    links:[
      "artaud.html","ashtray.html","ashtray1.html","bataille1.html","borges.html","burroughs.html",
      "butterfly.html","butterfly1.html","butterfly2.html","butterfly3.html","capture.html",
      "capturegpt.html","capturegpt1.html","capturegpt2.html","capturegpt3.html","capturegpt4.html",
      "capturegpt5.html","capturegpt6.html","capturegpt7.html","capturegpt8.html","catface.html",
      "catface1.html","catface2.html","chroma.html","coffee.html","coffee1.html","cp.html","cp1.html",
      "crow.html","cube.html","cube1.html","debord.html","deleuze.html","dmt.html","dmt1.html",
      "dmt2.html","dmt3.html","dmt4.html","dmtzoom.html","etal.html","eye.html","eyes.html",
      "fishtank.html","funnel.html","funnel1.html","funnel4.html","goffman.html","grace.html",
      "grace1.html","grace3.html","growth.html","growth1.html","growth2.html","holzer.html",
      "hyperstition.html","hyperstition5.html","jan6.html","jan61.html","jung.html","kitty.html",
      "kittycat.html","kittycat1.html","kittycat2.html","land.html","leopard.html","lizard.html",
      "mandala.html","mandala1.html","mandala2.html","mandala3.html","mandalagpt4.html","matrix.html",
      "matryoshka.html","mcluhan.html","molecule.html","newtrap.html","newtrap1.html","newtrap2.html",
      "newtrap3.html","octopus.html","pigface.html","polka1.html","polka2.html","polkadot.html",
      "pool5.html","pool6.html","release.html","release1.html","release2.html","release3.html",
      "release4.html","ripple.html","ripple1.html","ripple2.html","ripple3.html","ripplegpt.html",
      "serp1.html","serpentine.html","sg.html","sg1.html","slopstream4.html","slopstream6.html",
      "snakes.html","sovereignty.html","subgpt2.html","subgpt3.html","subgpt4.html","subgpt5.html",
      "sublime.html","substance.html","substrate.html","substrate1.html","substrate3.html",
      "teleo.html","teleo1.html","trace.html","turbulence.html","underwater.html","underwater1.html",
      "widefield.html",
      "index0.html","index01.html","index02.html","index03.html","index04.html","index05.html",
      "index06.html","index07.html","index08.html","index09.html","index010.html","index011.html",
      "index012.html","index014.html","index015.html","index001.html","index002.html","index003.html",
      "index004.html","index005.html","index006.html","index007.html","index008.html","index009.html",
      "003.html"
    ]
  },
  {
    name:"KETA-CHROMA / KETA-SLOP",
    links:[
      "infinity.html","mandalagpt.html","mandalagpt2.html","mandalagpt3.html",
      "mdma.html","mdma2.html","mdmagpt.html","mdmagpt2.html",
      "pool.html","pool3.html","pool4.html","slopstream2.html","slopstream3.html",
      "temple.html","temple1.html"
    ]
  },
  {
    name:"KETA-MAIN (SCIENTOLOGY ENTRANCE)",
    links:[
      "anniversary1.html","backend.html","funding.html","kmas.html","shop.html","submit.html"
    ]
  },
  {
    name:"DIRECTORIES (TO BE FRANKENSTEINED)",
    links:[
      "design1.html","grotto.html","grotto1.html","grotto2.html","indesign.html","indesign1.html",
      "lab.html","lab1.html","lab3.html","lab9.html","labyrinth.html",
      "motion.html","motion1.html","motion2.html","motion3.html","motion4.html","motion5.html",
      "motion6.html","motion7.html","motion8.html","motion9.html","motion10.html","motion11.html",
      "orthodox.html","orthodox1.html","orthodox2.html","orthodox3.html",
      "pdfreader1.html","pdfreader2.html","pdfreader3.html","pdfreader4.html","pdfreader5.html",
      "pdfreader6.html","pdfreader7.html","pdfreader8.html","pdfreader9.html","pdfreader10.html",
      "pdfreader11.html","pdfreader12.html","pdfreader13.html","ppl_list.html","studiofront.html",
      "studiov3.html","tester3.html","tester31.html","trans.html","trans1.html",
      "triage.html","triage2.html","triage_cal.html","triage_cal1.html","triage_cal2.html",
      "triage_cal3.html","triage_cal4.html","triage_cal5.html","triage_cal6.html","triage_cal7.html"
    ]
  }
];

// ===== STATE =====
const STORAGE_KEY="KETADATA_MOB_BASE_v1";
let STATE={
  armed:{name:"",url:""},
  lightPreset:1,
  lightRunning:false,
  surfaceActive:false,
  surfaceUrl:"",
  recentLinks:[]
};

function loadState(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(raw){
      const loaded=JSON.parse(raw);
      STATE={...STATE,...loaded};
    }
  }catch(e){}
}

function saveState(){
  try{
    localStorage.setItem(STORAGE_KEY,JSON.stringify(STATE));
  }catch(e){}
}

// ===== ARMED =====
function arm(name,url){
  STATE.armed={name:String(name||""),url:String(url||"")};
  $("armedName").textContent=STATE.armed.name||"—";
  $("armedUrl").textContent=STATE.armed.url||"—";
  $("armedBar").classList.toggle("active",!!STATE.armed.url);
  saveState();
}

// ===== SURFACE =====
function playSurface(url,name){
  const u=String(url||"").trim();
  if(!u)return;
  
  STATE.surfaceActive=true;
  STATE.surfaceUrl=u;
  
  const frame=$("surfaceFrame");
  frame.classList.add("active");
  frame.src=u;
  
  $("contentLinks").classList.remove("active");
  
  // Add to recent
  const idx=STATE.recentLinks.findIndex(r=>r.url===u);
  if(idx>=0)STATE.recentLinks.splice(idx,1);
  STATE.recentLinks.unshift({name:String(name||""),url:u,ts:Date.now()});
  if(STATE.recentLinks.length>20)STATE.recentLinks.length=20;
  
  saveState();
  toast("SURFACE ACTIVE");
}

function stopSurface(){
  STATE.surfaceActive=false;
  STATE.surfaceUrl="";
  
  const frame=$("surfaceFrame");
  frame.classList.remove("active");
  frame.removeAttribute("src");
  
  const tab=document.querySelector('.nav-btn.active');
  if(tab && tab.dataset.tab==="links"){
    $("contentLinks").classList.add("active");
  }
  
  saveState();
  toast("SURFACE STOPPED");
}

// ===== LIGHTS =====
let lightInterval=null;
let lightCount=0;

function stopLight(){
  if(lightInterval){
    clearInterval(lightInterval);
    lightInterval=null;
  }
  STATE.lightRunning=false;
  const stage=$("stage");
  stage.classList.remove("active");
  stage.style.backgroundColor="#000";
  stage.style.filter="none";
  saveState();
}

function startLight(preset){
  stopLight();
  
  STATE.lightPreset=Number(preset)||1;
  STATE.lightRunning=true;
  
  const stage=$("stage");
  stage.classList.add("active");
  lightCount=0;
  
  if(preset===1){
    // Strobe
    lightInterval=setInterval(()=>{
      const curr=stage.style.backgroundColor||"black";
      stage.style.backgroundColor=(curr==="black"||curr==="rgb(0, 0, 0)")?"white":"black";
    },50);
  }else if(preset===2){
    // Rainbow
    let hue=0,wave=0;
    lightInterval=setInterval(()=>{
      hue=(hue+30)%360;
      wave+=0.5;
      const l=50+Math.sin(wave)*40;
      stage.style.backgroundColor=`hsl(${hue},100%,${l}%)`;
    },10);
  }else if(preset===3){
    // Chaos beat
    lightInterval=setInterval(()=>{
      lightCount++;
      const beat=lightCount%16;
      if(beat===0||beat===1){
        stage.style.backgroundColor="#fff";
        stage.style.filter="invert(1) contrast(3)";
      }else if(beat===2){
        stage.style.backgroundColor="#000";
        stage.style.filter="invert(1) contrast(2)";
      }else if(beat===3){
        stage.style.backgroundColor="#0f0";
        stage.style.filter="contrast(2) saturate(3)";
      }else if(beat===4){
        stage.style.backgroundColor="#f0f";
        stage.style.filter="invert(1) hue-rotate(90deg)";
      }else if(beat<8){
        stage.style.backgroundColor="#0ff";
        stage.style.filter="invert(0.7) contrast(2)";
      }else{
        stage.style.backgroundColor="#08f";
        stage.style.filter="contrast(1.5)";
      }
    },30);
  }else if(preset===4){
    // Red pulse
    let phase=0;
    lightInterval=setInterval(()=>{
      phase+=0.08;
      lightCount++;
      const red=Math.abs(Math.sin(phase))*255;
      const pulse=Math.abs(Math.sin(phase*0.5));
      if(lightCount%8===0){
        stage.style.backgroundColor="#000";
        stage.style.filter="brightness(3)";
      }else{
        stage.style.backgroundColor=`rgb(${red},0,0)`;
        stage.style.filter=`contrast(${2+pulse*2}) saturate(${4+pulse*2})`;
      }
    },20);
  }else if(preset===5){
    // Purple spiral
    let angle=0,cycle=0;
    lightInterval=setInterval(()=>{
      angle+=15;
      cycle=(cycle+2)%100;
      const hue=260+Math.sin(angle*0.1)*40;
      const sat=80+Math.cos(angle*0.05)*20;
      const light=30+Math.sin(cycle*0.1)*30;
      stage.style.backgroundColor=`hsl(${hue},${sat}%,${light}%)`;
      stage.style.filter=`contrast(${1.5+Math.abs(Math.cos(angle*0.08))}) hue-rotate(${angle*0.5}deg)`;
    },25);
  }else if(preset===6){
    // Lightning
    lightInterval=setInterval(()=>{
      lightCount++;
      if(lightCount%50===0||lightCount%50===2){
        stage.style.backgroundColor="#fff";
        stage.style.filter="brightness(5)";
      }else{
        stage.style.backgroundColor="#000";
        stage.style.filter="none";
      }
    },30);
  }
  
  saveState();
  updateLightUI();
  toast(`LIGHT ${preset} RUNNING`);
}

function updateLightUI(){
  document.querySelectorAll('.light-btn').forEach(btn=>{
    btn.classList.toggle('active',Number(btn.dataset.light)===STATE.lightPreset);
  });
}

// ===== RENDER =====
function renderCategories(){
  const container=$("categoriesContainer");
  container.innerHTML="";
  
  const searchTerm=$("searchInput").value.toLowerCase().trim();
  
  CATEGORIES.forEach((cat,catIdx)=>{
    let filteredLinks=cat.links;
    
    if(searchTerm){
      filteredLinks=cat.links.filter(link=>
        link.toLowerCase().includes(searchTerm)
      );
      if(filteredLinks.length===0)return;
    }
    
    const catEl=document.createElement("div");
    catEl.className="category";
    
    const header=document.createElement("div");
    header.className="cat-header";
    header.innerHTML=`
      <span>${cat.name}</span>
      <span class="cat-count">${filteredLinks.length}</span>
    `;
    
    const body=document.createElement("div");
    body.className="cat-body";
    
    filteredLinks.forEach(link=>{
      const item=document.createElement("div");
      item.className="link-item";
      
      const name=document.createElement("div");
      name.className="link-name";
      name.textContent=link.replace(".html","").toUpperCase();
      
      const actions=document.createElement("div");
      actions.className="link-actions";
      
      const armBtn=document.createElement("button");
      armBtn.className="mini-btn";
      armBtn.textContent="A";
      armBtn.title="ARM";
      armBtn.onclick=(e)=>{
        e.stopPropagation();
        arm(link.replace(".html",""),link);
        toast("ARMED");
      };
      
      const surfBtn=document.createElement("button");
      surfBtn.className="mini-btn";
      surfBtn.textContent="S";
      surfBtn.title="SURFACE";
      surfBtn.onclick=(e)=>{
        e.stopPropagation();
        playSurface(link,link.replace(".html",""));
      };
      
      actions.appendChild(armBtn);
      actions.appendChild(surfBtn);
      
      item.onclick=()=>{
        arm(link.replace(".html",""),link);
        toast("ARMED");
      };
      
      item.appendChild(name);
      item.appendChild(actions);
      body.appendChild(item);
    });
    
    header.onclick=()=>{
      body.classList.toggle("open");
    };
    
    // Auto-open if searching
    if(searchTerm){
      body.classList.add("open");
    }
    
    catEl.appendChild(header);
    catEl.appendChild(body);
    container.appendChild(catEl);
  });
  
  if(container.children.length===0){
    const empty=document.createElement("div");
    empty.className="empty-state";
    empty.textContent="NO MATCHES";
    container.appendChild(empty);
  }
}

function switchTab(tabName){
  document.querySelectorAll('.nav-btn').forEach(btn=>{
    btn.classList.toggle('active',btn.dataset.tab===tabName);
  });
  
  if(STATE.surfaceActive){
    $("contentLinks").classList.remove("active");
    $("contentLights").classList.remove("active");
    $("contentSettings").classList.remove("active");
  }else{
    $("contentLinks").classList.toggle("active",tabName==="links");
    $("contentLights").classList.toggle("active",tabName==="lights");
    $("contentSettings").classList.toggle("active",tabName==="settings");
  }
}

// ===== EXPORT/IMPORT =====
function exportState(){
  const blob=JSON.stringify(STATE,null,2);
  const url=URL.createObjectURL(new Blob([blob],{type:"application/json"}));
  const a=document.createElement("a");
  a.href=url;
  a.download=`mob_base_${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast("EXPORTED");
}

function importState(){
  $("fileInput").click();
}

function clearState(){
  if(!confirm("CLEAR ALL STATE?"))return;
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
}

// ===== INIT =====
function init(){
  loadState();
  renderCategories();
  updateLightUI();
  
  if(STATE.armed.url){
    $("armedBar").classList.add("active");
    $("armedName").textContent=STATE.armed.name||"—";
    $("armedUrl").textContent=STATE.armed.url||"—";
  }
  
  // Nav
  document.querySelectorAll('.nav-btn').forEach(btn=>{
    btn.onclick=()=>switchTab(btn.dataset.tab);
  });
  
  // Search
  $("searchInput").oninput=()=>renderCategories();
  
  // Armed actions
  $("btnGo").onclick=()=>{
    if(STATE.armed.url){
      window.location.href=STATE.armed.url;
    }else{
      toast("NO ARMED URL");
    }
  };
  
  $("btnSurface").onclick=()=>{
    if(STATE.armed.url){
      playSurface(STATE.armed.url,STATE.armed.name);
    }else{
      toast("NO ARMED URL");
    }
  };
  
  $("btnCopy").onclick=()=>{
    if(STATE.armed.url){
      copy(STATE.armed.url);
    }else{
      toast("NO ARMED URL");
    }
  };
  
  // Lights
  document.querySelectorAll('.light-btn').forEach(btn=>{
    btn.onclick=()=>{
      const preset=Number(btn.dataset.light);
      STATE.lightPreset=preset;
      updateLightUI();
      saveState();
      toast(`LIGHT ${preset}`);
    };
  });
  
  $("btnRun").onclick=()=>{
    if(STATE.lightRunning){
      stopLight();
      toast("STOPPED");
    }else{
      startLight(STATE.lightPreset);
    }
  };
  
  $("btnStop").onclick=()=>{
    stopLight();
    toast("STOPPED");
  };
  
  // Settings
  $("btnExport").onclick=exportState;
  $("btnImport").onclick=importState;
  $("btnClear").onclick=clearState;
  $("btnStopSurface").onclick=stopSurface;
  
  $("fileInput").onchange=(e)=>{
    const file=e.target.files[0];
    if(!file)return;
    const reader=new FileReader();
    reader.onload=()=>{
      try{
        const data=JSON.parse(reader.result);
        STATE={...STATE,...data};
        saveState();
        location.reload();
      }catch(err){
        toast("IMPORT FAILED");
      }
    };
    reader.readAsText(file);
  };
  
  // Hotkeys
  window.addEventListener("keydown",(e)=>{
    if(e.code==="Space" && e.target.tagName!=="INPUT"){
      e.preventDefault();
      if(STATE.lightRunning){
        stopLight();
        toast("STOPPED");
      }else{
        startLight(STATE.lightPreset);
      }
    }
  });
  
  // Prevent pull-to-refresh
  let lastY=0;
  document.body.addEventListener("touchstart",(e)=>{
    lastY=e.touches[0].clientY;
  },{passive:true});
  
  document.body.addEventListener("touchmove",(e)=>{
    const y=e.touches[0].clientY;
    if(y>lastY && window.scrollY<=0){
      e.preventDefault();
    }
  },{passive:false});
}

init();
</script>

</body>
</html>
