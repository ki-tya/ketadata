<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>KETADATA // LINK TRIAGE CALENDAR (GITHUB SYNC)</title>
<style>
:root{
  --bg:#000;
  --ink:rgba(255,255,255,.88);
  --muted:rgba(255,255,255,.56);
  --line:rgba(255,255,255,.14);
  --line2:rgba(255,255,255,.26);
  --panel:rgba(0,0,0,.72);

  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  --sans: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

  --top:44px;
  --bot:34px;
  --pad:10px;
  --gap:10px;
  --radius:0px;

  --btnH:30px;
  --ctlH:30px;

  --cunt:0; /* 0/1 toggle */
}
*{box-sizing:border-box}
html,body{height:100%; margin:0}
body{background:var(--bg); color:var(--ink); font-family:var(--sans); overflow:hidden}
a{color:inherit; text-decoration:none}
button,input,select,textarea{font:inherit; color:inherit}
::selection{background:rgba(255,255,255,.14)}

#root{
  position:fixed; inset:0;
  display:grid;
  grid-template-rows: var(--top) 1fr var(--bot);
}

/* ===== cunt overlay (monochrome, tighter, more "dignitas") ===== */
#cuntFx{
  pointer-events:none;
  position:fixed;
  inset:0;
  opacity:calc(var(--cunt) * 1);
  mix-blend-mode:screen;
  background:
    radial-gradient(ellipse at 50% 20%, rgba(255,255,255,.08), rgba(0,0,0,0) 55%),
    repeating-linear-gradient( to bottom, rgba(255,255,255,.03) 0px, rgba(255,255,255,.03) 1px, rgba(0,0,0,0) 3px, rgba(0,0,0,0) 6px);
  filter:contrast(1.05);
}
#cuntEdge{
  pointer-events:none;
  position:fixed;
  inset:0;
  opacity:calc(var(--cunt) * 1);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.14), inset 0 0 120px rgba(0,0,0,.85);
}

/* ===== top bar ===== */
#topbar{
  display:flex; align-items:center; gap:10px;
  padding:0 10px;
  border-bottom:1px solid var(--line);
  background:linear-gradient(to bottom, rgba(255,255,255,.06), rgba(255,255,255,.02));
}
#brand{
  display:flex; align-items:baseline; gap:10px; min-width:420px;
  font-family:var(--mono);
  letter-spacing:.3px;
}
#brand .t1{opacity:.92}
#brand .t2{opacity:.62}
#sig{
  margin-left:auto;
  font-family:var(--mono);
  font-size:12px;
  opacity:.62;
  white-space:nowrap;
}
.btn{
  height:var(--btnH);
  padding:0 10px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,.45);
  border-radius:var(--radius);
  cursor:pointer;
  opacity:.92;
}
.btn:hover{border-color:rgba(255,255,255,.38)}
.btn:active{transform:translateY(1px)}
.btn.ghost{border-color:var(--line); opacity:.72}
.btn.on{background:rgba(255,255,255,.08); opacity:1}
.pill{
  height:var(--btnH);
  display:flex; align-items:center; gap:6px;
  padding:0 10px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.35);
  border-radius:999px;
  font-family:var(--mono);
  font-size:12px;
  opacity:.8;
}

/* ===== layout ===== */
#main{
  display:grid;
  grid-template-columns: 420px 1fr;
  min-height:0;
}
.col{
  min-height:0;
  border-right:1px solid var(--line);
}
.col:last-child{border-right:none}

/* ===== left: day list ===== */
#left{
  display:flex;
  flex-direction:column;
  min-height:0;
}
#leftHdr{
  padding:10px;
  border-bottom:1px solid var(--line);
  display:flex;
  gap:8px;
  align-items:center;
}
#daySelect{
  height:var(--ctlH);
  padding:0 8px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,.5);
  outline:none;
  border-radius:var(--radius);
  font-family:var(--mono);
}
#daySelect:focus{border-color:rgba(255,255,255,.44)}
#dayMeta{
  margin-left:auto;
  font-family:var(--mono);
  font-size:12px;
  opacity:.62;
  white-space:nowrap;
}
#dayList{
  min-height:0;
  overflow:auto;
}
.item{
  display:grid;
  grid-template-columns: 14px 1fr;
  gap:10px;
  padding:10px;
  border-bottom:1px solid var(--line);
  align-items:start;
}
.item:hover{background:rgba(255,255,255,.03)}
.item.deprecated{opacity:.42}
.dot{
  width:10px; height:10px;
  border:1px solid rgba(255,255,255,.44);
  margin-top:4px;
  background:rgba(255,255,255,.06);
}
.url{
  font-family:var(--mono);
  font-size:12px;
  opacity:.92;
  word-break:break-all;
}
.title{
  font-family:var(--mono);
  font-size:12px;
  opacity:.72;
  margin-top:4px;
}
.tags{
  display:flex; gap:6px; flex-wrap:wrap;
  margin-top:6px;
}
.tag{
  font-family:var(--mono);
  font-size:11px;
  opacity:.7;
  border:1px solid var(--line);
  padding:2px 6px;
}
.note{
  margin-top:6px;
  font-size:12px;
  opacity:.7;
  white-space:pre-wrap;
}
.actions{
  margin-top:8px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.actions .btn{height:28px; padding:0 8px}

/* ===== right: month grid + editor ===== */
#right{
  display:grid;
  grid-template-rows: 340px 1fr;
  min-height:0;
}
#calWrap{
  border-bottom:1px solid var(--line);
  min-height:0;
  display:flex;
  flex-direction:column;
}
#calHdr{
  padding:10px;
  display:flex;
  align-items:center;
  gap:8px;
  border-bottom:1px solid var(--line);
}
#calHdr .pill{margin-left:auto}
#monthLabel{
  font-family:var(--mono);
  opacity:.86;
}
#grid{
  padding:10px;
  display:grid;
  grid-template-columns: repeat(7, 1fr);
  gap:8px;
  min-height:0;
}
.cell{
  border:1px solid var(--line);
  background:rgba(0,0,0,.35);
  border-radius:var(--radius);
  min-height:44px;
  padding:6px;
  cursor:pointer;
  position:relative;
  overflow:hidden;
}
.cell:hover{border-color:rgba(255,255,255,.38)}
.cell.sel{
  outline:1px solid rgba(255,255,255,.34);
  outline-offset:-1px;
  background:rgba(255,255,255,.04);
}
.cell .d{
  font-family:var(--mono);
  font-size:12px;
  opacity:.72;
}
.cell .dots{
  margin-top:6px;
  display:flex;
  gap:4px;
  flex-wrap:wrap;
}
.minidot{
  width:8px; height:8px;
  border:1px solid rgba(255,255,255,.44);
  background:rgba(255,255,255,.06);
}
.cell.mute{opacity:.35}
.cell.today{border-color:rgba(255,255,255,.42)}
/* cunt micro-gloss */
.cell::after{
  content:"";
  position:absolute; inset:0;
  opacity:calc(var(--cunt) * .22);
  background:linear-gradient(to bottom, rgba(255,255,255,.10), rgba(0,0,0,0) 55%);
  pointer-events:none;
}

/* editor */
#editor{
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:10px;
  min-height:0;
  overflow:auto;
}
.panel{
  border:1px solid var(--line);
  background:rgba(0,0,0,.35);
  border-radius:var(--radius);
}
.panel .hd{
  display:flex; align-items:center; justify-content:space-between;
  padding:8px 10px;
  border-bottom:1px solid var(--line);
  font-family:var(--mono);
  opacity:.9;
}
.panel .bd{
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.field{display:flex; flex-direction:column; gap:6px}
.field label{
  font-family:var(--mono);
  font-size:12px;
  opacity:.62;
}
.input, .select{
  height:var(--ctlH);
  padding:0 8px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,.5);
  outline:none;
  border-radius:var(--radius);
}
.input:focus,.select:focus{border-color:rgba(255,255,255,.44)}
.textarea{
  width:100%;
  min-height:84px;
  resize:vertical;
  padding:8px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,.5);
  outline:none;
  border-radius:var(--radius);
  font-family:var(--mono);
  font-size:12px;
  line-height:1.35;
}
.row{display:flex; gap:8px; flex-wrap:wrap}
.row .btn{flex:1}

/* chips */
.chips{display:flex; gap:8px; flex-wrap:wrap}
.chip{
  width:18px; height:18px;
  border:1px solid rgba(255,255,255,.44);
  background:rgba(255,255,255,.06);
  cursor:pointer;
}
.chip.sel{outline:1px solid rgba(255,255,255,.66); outline-offset:2px}

/* output */
#out{
  display:none;
  position:fixed;
  inset:60px 60px 60px 60px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,.94);
  z-index:50;
}
#out.open{display:flex; flex-direction:column}
#outTop{
  display:flex; align-items:center; gap:8px;
  padding:10px;
  border-bottom:1px solid var(--line);
  font-family:var(--mono);
  opacity:.9;
}
#outBody{
  padding:10px;
  min-height:0;
  overflow:auto;
}
#outArea{
  width:100%;
  min-height:100%;
  border:1px solid var(--line2);
  background:rgba(0,0,0,.65);
  border-radius:var(--radius);
  padding:10px;
  font-family:var(--mono);
  font-size:12px;
  line-height:1.35;
  outline:none;
  white-space:pre;
}

/* bottom bar */
#botbar{
  display:flex; align-items:center; gap:10px;
  padding:0 10px;
  border-top:1px solid var(--line);
  background:linear-gradient(to top, rgba(255,255,255,.06), rgba(255,255,255,.02));
}
#toast{
  font-family:var(--mono);
  font-size:12px;
  opacity:.62;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
#spacer{flex:1}
kbd{
  font-family:var(--mono);
  font-size:11px;
  opacity:.72;
  border:1px solid var(--line);
  padding:2px 6px;
}
.small{
  font-family:var(--mono);
  font-size:12px;
  opacity:.62;
  line-height:1.35;
}

/* github status line */
#ghStatus{
  font-family:var(--mono);
  font-size:12px;
  opacity:.62;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
</style>
</head>
<body>
<div id="root">
  <div id="topbar">
    <div id="brand">
      <span class="t1">KETADATA</span>
      <span class="t2">LINK TRIAGE</span>
      <span class="t2">CALENDAR</span>
    </div>

    <button class="btn ghost" id="btnPrev">◀</button>
    <button class="btn ghost" id="btnToday">TODAY</button>
    <button class="btn ghost" id="btnNext">▶</button>

    <button class="btn ghost" id="btnCunt">CUNT</button>
    <button class="btn ghost" id="btnInvert">INVERT</button>
    <button class="btn ghost" id="btnNull">NULL</button>

    <button class="btn" id="btnExportDay">EXPORT DAY</button>
    <button class="btn ghost" id="btnExportMonth">EXPORT MONTH</button>

    <div id="sig"></div>
  </div>

  <div id="main">
    <!-- left -->
    <div class="col" id="left">
      <div id="leftHdr">
        <select id="daySelect"></select>
        <div id="dayMeta">—</div>
      </div>
      <div id="dayList"></div>
    </div>

    <!-- right -->
    <div class="col" id="right">
      <div id="calWrap">
        <div id="calHdr">
          <div id="monthLabel">—</div>
          <div class="pill" id="monthMeta">0 links</div>
        </div>
        <div id="grid"></div>
      </div>

      <div id="editor">
        <div class="panel">
          <div class="hd"><span>ADD LINK (ASSIGN DATE)</span><span id="editStamp" class="small">—</span></div>
          <div class="bd">
            <div class="field">
              <label>DATE</label>
              <input class="input" id="eDate" type="date"/>
            </div>
            <div class="field">
              <label>URL</label>
              <input class="input" id="eUrl" placeholder="https://…"/>
            </div>
            <div class="field">
              <label>TITLE</label>
              <input class="input" id="eTitle" placeholder="short label"/>
            </div>
            <div class="field">
              <label>NOTE</label>
              <textarea class="textarea" id="eNote" placeholder="context / routing"></textarea>
            </div>
            <div class="field">
              <label>TAGS (comma separated)</label>
              <input class="input" id="eTags" placeholder="archive, tool, pdf"/>
            </div>

            <div class="field">
              <label>COLOR CODE</label>
              <div class="chips" id="chips"></div>
            </div>

            <div class="row">
              <button class="btn" id="btnAdd">ADD</button>
              <button class="btn ghost" id="btnClear">CLEAR</button>
            </div>

            <div class="row">
              <button class="btn ghost" id="btnMergeDups">MERGE DUPS</button>
              <button class="btn ghost" id="btnToggleDayDepr">TOGGLE DAY DEPR</button>
            </div>

            <div class="small">
              <div><kbd>↑</kbd>/<kbd>↓</kbd> day change</div>
              <div><kbd>Enter</kbd> open selected link</div>
              <div><kbd>D</kbd> deprecate selected</div>
              <div><kbd>C</kbd> cycle color selected</div>
              <div><kbd>Ctrl/Cmd</kbd>+<kbd>K</kbd> focus day selector</div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="hd"><span>GITHUB SYNC (OPTIONAL)</span><span id="ghStatus">—</span></div>
          <div class="bd">
            <div class="small">
              This uses the GitHub Contents API (network required). For private repos you need a token with repo access.
              Token is stored locally in this browser (localStorage) unless you clear it.
            </div>

            <div class="row">
              <div class="field" style="flex:1">
                <label>OWNER</label>
                <input class="input" id="ghOwner" placeholder="yourname"/>
              </div>
              <div class="field" style="flex:1">
                <label>REPO</label>
                <input class="input" id="ghRepo" placeholder="ketadata"/>
              </div>
            </div>

            <div class="row">
              <div class="field" style="flex:1">
                <label>BRANCH</label>
                <input class="input" id="ghBranch" placeholder="main"/>
              </div>
              <div class="field" style="flex:1">
                <label>PATH</label>
                <input class="input" id="ghPath" placeholder="state/link_triage_calendar.json"/>
              </div>
            </div>

            <div class="field">
              <label>TOKEN (fine-grained or classic)</label>
              <input class="input" id="ghToken" type="password" placeholder="ghp_… or github_pat_…"/>
            </div>

            <div class="row">
              <button class="btn ghost" id="ghPull">PULL</button>
              <button class="btn" id="ghPush">PUSH</button>
            </div>

            <div class="row">
              <button class="btn ghost" id="ghOpen">OPEN FILE</button>
              <button class="btn ghost" id="ghForget">FORGET TOKEN</button>
            </div>

            <div class="small" id="ghMeta">—</div>
          </div>
        </div>

        <div class="panel">
          <div class="hd"><span>STATE I/O</span><span class="small" id="stateKey">—</span></div>
          <div class="bd">
            <div class="row">
              <button class="btn ghost" id="btnStateExport">STATE → FILE</button>
              <button class="btn ghost" id="btnStateImport">FILE → STATE</button>
            </div>
            <input type="file" id="fileIn" accept=".json,application/json,text/plain" style="display:none"/>
            <div class="small">Local-first. Real download behavior. GitHub sync is additive, not required.</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div id="botbar">
    <div id="toast">READY</div>
    <div id="spacer"></div>
    <div class="pill" id="pillSel">DAY: —</div>
    <div class="pill" id="pillCount">0 items</div>
  </div>
</div>

<div id="cuntFx"></div>
<div id="cuntEdge"></div>

<!-- output modal -->
<div id="out">
  <div id="outTop">
    <div style="flex:1">EXPORT OUTPUT</div>
    <button class="btn ghost" id="btnOutCopy">COPY</button>
    <button class="btn ghost" id="btnOutDownload">DOWNLOAD</button>
    <button class="btn" id="btnOutClose">CLOSE</button>
  </div>
  <div id="outBody">
    <textarea id="outArea" spellcheck="false"></textarea>
  </div>
</div>

<script>
/* ===========================
   KETADATA LINK TRIAGE CALENDAR
   + optional GitHub sync
=========================== */
const $ = (id)=>document.getElementById(id);
const nowISO = ()=> new Date().toISOString();
const uid = ()=> Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);

function toast(msg){
  $("toast").textContent = msg;
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>{$("toast").textContent="READY";}, 1200);
}

function safeURL(u){
  try{ return new URL(u).href; }catch(e){ return null; }
}
function normalizeTags(s){
  return (s||"").split(",").map(t=>t.trim()).filter(Boolean).slice(0,32);
}
function hashKey(url){
  let s = (url||"").trim().toLowerCase();
  let h = 2166136261;
  for(let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h = Math.imul(h, 16777619); }
  return ("h"+(h>>>0).toString(16));
}

/* ===== palette ===== */
const PALETTE = [
  {id:"none", label:"NONE", css:"rgba(255,255,255,.06)"},
  {id:"w1",   label:"W1",   css:"rgba(255,255,255,.18)"},
  {id:"w2",   label:"W2",   css:"rgba(255,255,255,.32)"},
  {id:"w3",   label:"W3",   css:"rgba(255,255,255,.50)"},
  {id:"w4",   label:"W4",   css:"rgba(255,255,255,.70)"},
  {id:"blk",  label:"BLK",  css:"rgba(0,0,0,0)"}
];
function colorCss(id){
  const p = PALETTE.find(x=>x.id===id) || PALETTE[0];
  return p.css;
}

/* ===== storage isolation ===== */
const FILE_ID = (() => {
  const k = "KETADATA_LINK_TRIAGE_CAL__FILE_ID";
  let v = localStorage.getItem(k);
  if(!v){ v = "KLC-" + uid(); localStorage.setItem(k,v); }
  return v;
})();
const STORE_KEY = "KETADATA_LINK_TRIAGE_CAL__STATE__" + FILE_ID;
const GH_KEY = "KETADATA_LINK_TRIAGE_CAL__GITHUB__" + FILE_ID;

/* ===== dates ===== */
function toDayKey(d){
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function parseDayKey(k){
  const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(k||"");
  if(!m) return null;
  const d = new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));
  return isNaN(d.getTime()) ? null : d;
}
function monthLabel(y,m){
  const d = new Date(y,m,1);
  return d.toLocaleString(undefined,{month:"long", year:"numeric"});
}
function shortTime(iso){
  if(!iso) return "—";
  const d = new Date(iso);
  if(isNaN(d.getTime())) return "—";
  const yyyy=d.getFullYear();
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const dd=String(d.getDate()).padStart(2,"0");
  const hh=String(d.getHours()).padStart(2,"0");
  const mi=String(d.getMinutes()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
}
function stamp(){
  const d=new Date();
  const yyyy=d.getFullYear();
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const dd=String(d.getDate()).padStart(2,"0");
  const hh=String(d.getHours()).padStart(2,"0");
  const mi=String(d.getMinutes()).padStart(2,"0");
  return `${yyyy}${mm}${dd}_${hh}${mi}`;
}

/* ===== state ===== */
const DEFAULTS = {
  fileId: FILE_ID,
  createdAt: nowISO(),
  updatedAt: nowISO(),
  ui: {
    invert:false,
    blackout:false,
    cunt:false,
    monthY: new Date().getFullYear(),
    monthM: new Date().getMonth(),
    selectedDay: toDayKey(new Date()),
    selectedItemId: null
  },
  items: []
};

let STATE = loadState();
let LAST_EXPORT = {text:"", ext:"txt", mime:"text/plain", filename:"export.txt"};
let chipSelId = "none";

/* ===== github cfg ===== */
let GH = loadGh();
let GH_LAST_SHA = null;        // sha of remote file (for updates)
let GH_LAST_PATH = null;
let GH_LAST_AT = null;

function loadState(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return structuredClone(DEFAULTS);
    const st = JSON.parse(raw);
    const out = structuredClone(DEFAULTS);
    out.fileId = st.fileId || FILE_ID;
    out.createdAt = st.createdAt || out.createdAt;
    out.updatedAt = st.updatedAt || out.updatedAt;
    out.ui = Object.assign(out.ui, st.ui||{});
    out.items = Array.isArray(st.items) ? st.items : [];
    out.items = out.items.map(it=>{
      const x = Object.assign({
        id: uid(),
        day: toDayKey(new Date()),
        url:"",
        title:"",
        note:"",
        tags:[],
        color:"none",
        deprecated:false,
        createdAt: nowISO(),
        updatedAt: nowISO(),
        hash:""
      }, it||{});
      x.tags = Array.isArray(x.tags) ? x.tags : normalizeTags(x.tags);
      x.url = (x.url||"").trim();
      x.title = (x.title||"").trim();
      x.note = (x.note||"").trim();
      x.color = x.color || "none";
      x.deprecated = !!x.deprecated;
      x.hash = x.hash || hashKey(x.url);
      x.day = (x.day||"").trim() || toDayKey(new Date());
      return x;
    });
    return out;
  }catch(e){
    return structuredClone(DEFAULTS);
  }
}
function saveState(){
  STATE.updatedAt = nowISO();
  localStorage.setItem(STORE_KEY, JSON.stringify(STATE));
  updateSig();
}

function loadGh(){
  try{
    const raw = localStorage.getItem(GH_KEY);
    if(!raw) return {
      owner:"",
      repo:"",
      branch:"main",
      path:"state/link_triage_calendar.json",
      token:""
    };
    const x = JSON.parse(raw);
    return Object.assign({
      owner:"",
      repo:"",
      branch:"main",
      path:"state/link_triage_calendar.json",
      token:""
    }, x||{});
  }catch(e){
    return { owner:"", repo:"", branch:"main", path:"state/link_triage_calendar.json", token:"" };
  }
}
function saveGh(){
  localStorage.setItem(GH_KEY, JSON.stringify(GH));
}

/* ===== chips ===== */
function buildChips(){
  const wrap = $("chips");
  wrap.innerHTML = "";
  PALETTE.forEach(p=>{
    const d=document.createElement("div");
    d.className="chip";
    d.title=p.label;
    d.dataset.id=p.id;
    d.style.background = (p.id==="blk") ? "rgba(255,255,255,.02)" : p.css;
    d.addEventListener("click", ()=> setChipSel(p.id));
    wrap.appendChild(d);
  });
}
function setChipSel(id){
  chipSelId = id || "none";
  document.querySelectorAll(".chip").forEach(el=>{
    el.classList.toggle("sel", el.dataset.id===chipSelId);
  });
}

/* ===== derived maps ===== */
function itemsByDay(){
  const map = new Map();
  for(const it of STATE.items){
    const day = it.day || toDayKey(new Date());
    if(!map.has(day)) map.set(day, []);
    map.get(day).push(it);
  }
  for(const [k,arr] of map.entries()){
    arr.sort((a,b)=>(Date.parse(a.createdAt)||0)-(Date.parse(b.createdAt)||0));
  }
  return map;
}
function monthDays(y,m){
  const first = new Date(y,m,1);
  const startDow = first.getDay();
  const start = new Date(y,m,1 - startDow);
  const cells = [];
  for(let i=0;i<42;i++){
    const d = new Date(start.getFullYear(), start.getMonth(), start.getDate()+i);
    cells.push(d);
  }
  return cells;
}

/* ===== render ===== */
function applyFilters(){
  // invert + null + cunt are all "filters"
  let f = "";
  if(STATE.ui.invert) f += "invert(1) ";
  if(STATE.ui.blackout) f += "brightness(0.65) ";
  document.documentElement.style.filter = f.trim() || "none";
  document.documentElement.style.setProperty("--cunt", STATE.ui.cunt ? "1" : "0");
  $("btnCunt").classList.toggle("on", !!STATE.ui.cunt);
  $("btnInvert").classList.toggle("on", !!STATE.ui.invert);
  $("btnNull").classList.toggle("on", !!STATE.ui.blackout);
}
function render(){
  applyFilters();

  const y=STATE.ui.monthY, m=STATE.ui.monthM;
  $("monthLabel").textContent = monthLabel(y,m);

  const byDay = itemsByDay();

  // month meta
  const monthPrefix = `${y}-${String(m+1).padStart(2,"0")}-`;
  let monthCount = 0;
  for(const [day,arr] of byDay.entries()){
    if(day.startsWith(monthPrefix)) monthCount += arr.length;
  }
  $("monthMeta").textContent = `${monthCount} links`;

  // calendar grid
  const grid = $("grid");
  grid.innerHTML = "";
  const cells = monthDays(y,m);
  const selDay = STATE.ui.selectedDay;
  const todayKey = toDayKey(new Date());

  for(const d of cells){
    const dayKey = toDayKey(d);
    const cell = document.createElement("div");
    cell.className = "cell";
    if(d.getMonth()!==m) cell.classList.add("mute");
    if(dayKey===selDay) cell.classList.add("sel");
    if(dayKey===todayKey) cell.classList.add("today");

    const dd = document.createElement("div");
    dd.className="d";
    dd.textContent = String(d.getDate());

    const dots = document.createElement("div");
    dots.className="dots";

    const arr = byDay.get(dayKey) || [];
    arr.slice(0,10).forEach(it=>{
      const md=document.createElement("div");
      md.className="minidot";
      md.style.background = (it.color==="blk") ? "rgba(255,255,255,.02)" : colorCss(it.color||"none");
      if(it.deprecated) md.style.opacity = "0.35";
      dots.appendChild(md);
    });

    cell.appendChild(dd);
    cell.appendChild(dots);

    cell.addEventListener("click", ()=>{
      STATE.ui.selectedDay = dayKey;
      STATE.ui.selectedItemId = null;
      $("eDate").value = dayKey;
      saveState();
      renderDayList();
      render();
    });

    grid.appendChild(cell);
  }

  rebuildDaySelect(y,m);
  $("eDate").value = selDay;

  renderDayList();
  updatePills();
  updateSig();
  renderGhUI();
}

function rebuildDaySelect(y,m){
  const sel = $("daySelect");
  const cur = STATE.ui.selectedDay;

  const daysInMonth = new Date(y,m+1,0).getDate();
  sel.innerHTML = "";
  for(let d=1; d<=daysInMonth; d++){
    const dayKey = `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const opt = document.createElement("option");
    opt.value = dayKey;
    opt.textContent = dayKey;
    sel.appendChild(opt);
  }
  if(!cur.startsWith(`${y}-${String(m+1).padStart(2,"0")}-`)){
    STATE.ui.selectedDay = `${y}-${String(m+1).padStart(2,"0")}-01`;
    saveState();
  }
  sel.value = STATE.ui.selectedDay;
}

function renderDayList(){
  const byDay = itemsByDay();
  const day = STATE.ui.selectedDay;
  const arr = (byDay.get(day) || []).slice();
  const total = arr.length;
  const depr = arr.filter(x=>x.deprecated).length;

  $("dayMeta").textContent = `${total} items · ${depr} depr`;

  if(total && (!STATE.ui.selectedItemId || !arr.some(x=>x.id===STATE.ui.selectedItemId))){
    STATE.ui.selectedItemId = arr[0].id;
    saveState();
  }

  const list = $("dayList");
  list.innerHTML = "";

  arr.forEach(it=>{
    const row = document.createElement("div");
    row.className = "item" + (it.deprecated ? " deprecated":"");
    row.dataset.id = it.id;

    const dot = document.createElement("div");
    dot.className="dot";
    if(it.color && it.color!=="blk") dot.style.background = colorCss(it.color);
    if(it.color==="blk") dot.style.background = "rgba(255,255,255,.02)";

    const main = document.createElement("div");

    const url = document.createElement("div");
    url.className="url";
    url.textContent = it.url || "(no url)";

    const title = document.createElement("div");
    title.className="title";
    title.textContent = it.title ? it.title : "";

    const tags = document.createElement("div");
    tags.className="tags";
    (it.tags||[]).slice(0,6).forEach(t=>{
      const s=document.createElement("span");
      s.className="tag";
      s.textContent=t;
      tags.appendChild(s);
    });

    const note = document.createElement("div");
    note.className="note";
    if(it.note) note.textContent = it.note;

    const actions = document.createElement("div");
    actions.className="actions";
    actions.appendChild(mkBtn("OPEN", ()=>openUrl(it.url), true));
    actions.appendChild(mkBtn("DEPR", ()=>toggleDeprecate(it.id), true));
    actions.appendChild(mkBtn("COPY", ()=>copyText(it.url||""), true));

    main.appendChild(url);
    if(it.title) main.appendChild(title);
    if((it.tags||[]).length) main.appendChild(tags);
    if(it.note) main.appendChild(note);
    main.appendChild(actions);

    row.appendChild(dot);
    row.appendChild(main);

    if(STATE.ui.selectedItemId===it.id){
      row.style.background="rgba(255,255,255,.05)";
      row.style.outline="1px solid rgba(255,255,255,.26)";
      row.style.outlineOffset="-1px";
    }

    row.addEventListener("click",(ev)=>{
      if(ev.target.tagName==="BUTTON") return;
      STATE.ui.selectedItemId = it.id;
      saveState();
      renderDayList();
    });

    list.appendChild(row);
  });
}

function mkBtn(txt, fn, ghost){
  const b=document.createElement("button");
  b.className="btn" + (ghost ? " ghost":"");
  b.textContent=txt;
  b.addEventListener("click",(e)=>{e.stopPropagation(); fn();});
  return b;
}

function updatePills(){
  $("pillSel").textContent = `DAY: ${STATE.ui.selectedDay}`;
  const dayCount = STATE.items.filter(it=>it.day===STATE.ui.selectedDay).length;
  $("pillCount").textContent = `${dayCount} items`;
}

function updateSig(){
  $("sig").textContent = `FILE_ID ${STATE.fileId} · ITEMS ${STATE.items.length} · UPDATED ${shortTime(STATE.updatedAt)}`;
  $("stateKey").textContent = "KEY: " + STORE_KEY;
  $("editStamp").textContent = "updated " + shortTime(STATE.updatedAt);
}

/* ===== ops ===== */
function openUrl(url){
  const u = safeURL(url||"");
  if(!u){ toast("NO URL"); return; }
  window.open(u, "_blank", "noopener,noreferrer");
}
async function copyText(t){
  try{
    await navigator.clipboard.writeText(t||"");
    toast("COPIED");
    return true;
  }catch(e){
    try{
      const ta=document.createElement("textarea");
      ta.value=t||"";
      ta.style.position="fixed"; ta.style.left="-9999px";
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      document.execCommand("copy");
      ta.remove();
      toast("COPIED");
      return true;
    }catch(e2){
      toast("COPY FAILED");
      return false;
    }
  }
}

function addItem(){
  const day = ($("eDate").value||"").trim() || STATE.ui.selectedDay;
  if(!/^\d{4}-\d{2}-\d{2}$/.test(day)){ toast("BAD DATE"); return; }

  const rawUrl = ($("eUrl").value||"").trim();
  const url = safeURL(rawUrl);
  if(!url){ toast("INVALID URL"); return; }

  const it = {
    id: uid(),
    day,
    url,
    title: ($("eTitle").value||"").trim(),
    note: ($("eNote").value||"").trim(),
    tags: normalizeTags($("eTags").value||""),
    color: chipSelId || "none",
    deprecated:false,
    createdAt: nowISO(),
    updatedAt: nowISO(),
    hash: hashKey(url)
  };
  STATE.items.push(it);
  STATE.ui.selectedDay = day;
  STATE.ui.selectedItemId = it.id;

  const d = parseDayKey(day);
  if(d){
    STATE.ui.monthY = d.getFullYear();
    STATE.ui.monthM = d.getMonth();
  }

  saveState();
  toast("ADDED");
  render();
}

function toggleDeprecate(id){
  const it = STATE.items.find(x=>x.id===id);
  if(!it) return;
  it.deprecated = !it.deprecated;
  it.updatedAt = nowISO();
  saveState();
  toast(it.deprecated ? "DEPRECATED" : "ACTIVE");
  render();
}

function toggleDayDeprecate(){
  const day = STATE.ui.selectedDay;
  const arr = STATE.items.filter(it=>it.day===day);
  if(!arr.length){ toast("NO ITEMS"); return; }
  const anyActive = arr.some(it=>!it.deprecated);
  arr.forEach(it=>{ it.deprecated = anyActive; it.updatedAt = nowISO(); });
  saveState();
  toast(anyActive ? "DAY DEPRECATED" : "DAY ACTIVE");
  render();
}

function mergeDups(){
  const by = new Map();
  for(const it of STATE.items){
    const k = it.hash || hashKey(it.url);
    if(!by.has(k)) by.set(k, []);
    by.get(k).push(it);
  }
  let merged=0;
  const out=[];
  for(const [k,arr] of by.entries()){
    if(arr.length===1){ out.push(arr[0]); continue; }
    arr.sort((a,b)=>(Date.parse(a.createdAt)||0)-(Date.parse(b.createdAt)||0));
    const keep = arr[0];
    for(let i=1;i<arr.length;i++){
      const r=arr[i];
      if(r.day < keep.day) keep.day = r.day;
      if(!keep.title && r.title) keep.title = r.title;
      if(!keep.note && r.note) keep.note = r.note;
      const tags = new Set([...(keep.tags||[]), ...(r.tags||[])]);
      keep.tags = Array.from(tags).slice(0,32);
      if((keep.color==="none"||!keep.color) && r.color && r.color!=="none") keep.color = r.color;
      if(r.deprecated) keep.deprecated = true;
      merged++;
    }
    keep.updatedAt = nowISO();
    out.push(keep);
  }
  STATE.items = out;
  saveState();
  toast(merged ? ("MERGED " + merged) : "NO DUPS");
  render();
}

/* ===== export ===== */
function exportScope(which){
  const y=STATE.ui.monthY, m=STATE.ui.monthM;
  const day = STATE.ui.selectedDay;

  let arr = [];
  if(which==="day"){
    arr = STATE.items.filter(it=>it.day===day);
    arr.sort((a,b)=>(Date.parse(a.createdAt)||0)-(Date.parse(b.createdAt)||0));
  }else{
    const prefix = `${y}-${String(m+1).padStart(2,"0")}-`;
    arr = STATE.items.filter(it=> (it.day||"").startsWith(prefix));
    arr.sort((a,b)=>{
      if(a.day!==b.day) return a.day.localeCompare(b.day);
      return (Date.parse(a.createdAt)||0)-(Date.parse(b.createdAt)||0);
    });
  }

  let text = "";
  if(which==="day"){
    text = arr.map(it=>it.url).filter(Boolean).join("\n");
  }else{
    let cur="";
    const lines=[];
    for(const it of arr){
      if(it.day!==cur){
        cur=it.day;
        lines.push("");
        lines.push(cur);
      }
      const dep = it.deprecated ? " [DEPR]" : "";
      const t = it.title ? ` — ${it.title}` : "";
      lines.push(`${it.url}${t}${dep}`);
    }
    text = lines.join("\n").trim();
  }

  const fn = `KETADATA_LINK_TRIAGE_CAL_${STATE.fileId}_${which}_${stamp()}.txt`;
  LAST_EXPORT = {text, ext:"txt", mime:"text/plain", filename: fn};
  openOutput(text);
  toast("EXPORTED");
}

function openOutput(text){
  $("outArea").value = text || "";
  $("out").classList.add("open");
  $("outArea").focus();
  $("outArea").select();
}
function closeOutput(){ $("out").classList.remove("open"); }

function downloadTextFile(filename, mime, text){
  const blob = new Blob([text||""], {type:mime||"text/plain"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename || "export.txt";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 800);
  toast("DOWNLOADED");
}

/* ===== state i/o (real download behavior) ===== */
function exportStateObject(){
  return {
    ...STATE,
    exportedAt: nowISO(),
    storeKey: STORE_KEY,
    github: {
      owner: GH.owner || "",
      repo: GH.repo || "",
      branch: GH.branch || "main",
      path: GH.path || ""
    }
  };
}
function exportStateToFile(){
  const payload = exportStateObject();
  const text = JSON.stringify(payload, null, 2);
  const filename = `KETADATA_LINK_TRIAGE_CAL_STATE_${STATE.fileId}_${stamp()}.json`;
  downloadTextFile(filename, "application/json", text);
}
function importStateFromObject(obj){
  if(!obj || !obj.items || !obj.ui) return false;

  const merged = structuredClone(DEFAULTS);
  merged.fileId = FILE_ID; // keep local identity stable
  merged.createdAt = obj.createdAt || nowISO();
  merged.updatedAt = nowISO();
  merged.ui = Object.assign(merged.ui, obj.ui||{});
  merged.items = Array.isArray(obj.items) ? obj.items : [];
  merged.items = merged.items.map(it=>{
    const x = Object.assign({
      id: uid(),
      day: toDayKey(new Date()),
      url:"",
      title:"",
      note:"",
      tags:[],
      color:"none",
      deprecated:false,
      createdAt: nowISO(),
      updatedAt: nowISO(),
      hash:""
    }, it||{});
    x.tags = Array.isArray(x.tags) ? x.tags : normalizeTags(x.tags);
    x.url = (x.url||"").trim();
    x.title = (x.title||"").trim();
    x.note = (x.note||"").trim();
    x.color = x.color || "none";
    x.deprecated = !!x.deprecated;
    x.hash = x.hash || hashKey(x.url);
    x.day = (x.day||"").trim() || toDayKey(new Date());
    return x;
  });

  STATE = merged;
  saveState();
  return true;
}
function importStateFromFile(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(String(reader.result||""));
      if(!importStateFromObject(obj)){ toast("INVALID STATE"); return; }
      toast("STATE IMPORTED");
      render();
    }catch(e){
      toast("IMPORT FAILED");
    }
  };
  reader.readAsText(file);
}

/* ===========================
   GitHub sync (Contents API)
=========================== */
function b64EncodeUnicode(str){
  // base64 for UTF-8 JSON
  return btoa(unescape(encodeURIComponent(str)));
}
function b64DecodeUnicode(b64){
  return decodeURIComponent(escape(atob(b64)));
}
function ghHeaders(){
  const token = (GH.token||"").trim();
  const h = {
    "Accept": "application/vnd.github+json"
  };
  if(token){
    // Fine-grained tokens: Bearer works. Classic PAT: also works.
    h["Authorization"] = "Bearer " + token;
  }
  return h;
}
function ghEndpoint(){
  const owner=(GH.owner||"").trim();
  const repo=(GH.repo||"").trim();
  const path=(GH.path||"").trim().replace(/^\/+/,"");
  const branch=(GH.branch||"main").trim() || "main";
  if(!owner || !repo || !path) return null;
  return { owner, repo, path, branch,
    url: `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${path}?ref=${encodeURIComponent(branch)}`
  };
}
function renderGhUI(){
  $("ghOwner").value = GH.owner || "";
  $("ghRepo").value = GH.repo || "";
  $("ghBranch").value = GH.branch || "main";
  $("ghPath").value = GH.path || "state/link_triage_calendar.json";
  $("ghToken").value = GH.token || "";

  const ep = ghEndpoint();
  const status = ep
    ? `ready · ${ep.owner}/${ep.repo}@${ep.branch} · ${ep.path}`
    : `set owner/repo/path to enable`;
  $("ghStatus").textContent = status;

  const meta = [
    `remote_sha: ${GH_LAST_SHA ? GH_LAST_SHA.slice(0,12)+"…" : "—"}`,
    `last_sync: ${GH_LAST_AT ? shortTime(GH_LAST_AT) : "—"}`
  ].join(" · ");
  $("ghMeta").textContent = meta;
}
function setGhFromInputs(){
  GH.owner = ($("ghOwner").value||"").trim();
  GH.repo = ($("ghRepo").value||"").trim();
  GH.branch = ($("ghBranch").value||"main").trim() || "main";
  GH.path = ($("ghPath").value||"").trim() || "state/link_triage_calendar.json";
  GH.token = ($("ghToken").value||"").trim();
  saveGh();
  renderGhUI();
}
async function ghPull(){
  setGhFromInputs();
  const ep = ghEndpoint();
  if(!ep){ toast("GITHUB CFG INCOMPLETE"); return; }

  $("ghStatus").textContent = "pulling…";
  try{
    const res = await fetch(ep.url, { method:"GET", headers: ghHeaders() });
    if(!res.ok){
      const t = await res.text().catch(()=> "");
      $("ghStatus").textContent = `pull failed (${res.status})`;
      toast("PULL FAILED");
      return;
    }
    const data = await res.json();
    if(!data || !data.content){
      $("ghStatus").textContent = "pull failed (no content)";
      toast("PULL FAILED");
      return;
    }
    const jsonText = b64DecodeUnicode(String(data.content).replace(/\s+/g,""));
    const obj = JSON.parse(jsonText);

    if(!importStateFromObject(obj)){
      $("ghStatus").textContent = "pull failed (invalid state)";
      toast("INVALID STATE");
      return;
    }

    GH_LAST_SHA = data.sha || null;
    GH_LAST_PATH = ep.path;
    GH_LAST_AT = nowISO();
    $("ghStatus").textContent = "pulled";
    toast("PULLED");
    render();
  }catch(e){
    $("ghStatus").textContent = "pull error";
    toast("PULL ERROR");
  }
}
async function ghPush(){
  setGhFromInputs();
  const ep = ghEndpoint();
  if(!ep){ toast("GITHUB CFG INCOMPLETE"); return; }
  if(!(GH.token||"").trim()){ toast("TOKEN REQUIRED"); return; }

  // ensure we have sha for update if remote exists
  // if sha unknown or path changed, try lightweight GET first
  if(!GH_LAST_SHA || GH_LAST_PATH !== ep.path){
    try{
      const res0 = await fetch(ep.url, { method:"GET", headers: ghHeaders() });
      if(res0.ok){
        const data0 = await res0.json();
        GH_LAST_SHA = data0.sha || null;
        GH_LAST_PATH = ep.path;
      }else{
        // new file case: sha stays null
        GH_LAST_SHA = null;
        GH_LAST_PATH = ep.path;
      }
    }catch(e){
      // ignore; proceed as new file
      GH_LAST_SHA = null;
      GH_LAST_PATH = ep.path;
    }
  }

  $("ghStatus").textContent = "pushing…";
  try{
    const payloadObj = exportStateObject();
    const jsonText = JSON.stringify(payloadObj, null, 2);
    const content = b64EncodeUnicode(jsonText);

    const putUrl = `https://api.github.com/repos/${encodeURIComponent(ep.owner)}/${encodeURIComponent(ep.repo)}/contents/${ep.path}`;
    const body = {
      message: `KETADATA LINK TRIAGE CALENDAR · ${stamp()}`,
      content,
      branch: ep.branch
    };
    if(GH_LAST_SHA) body.sha = GH_LAST_SHA;

    const res = await fetch(putUrl, {
      method:"PUT",
      headers: Object.assign({ "Content-Type":"application/json" }, ghHeaders()),
      body: JSON.stringify(body)
    });

    if(!res.ok){
      const t = await res.text().catch(()=> "");
      $("ghStatus").textContent = `push failed (${res.status})`;
      toast("PUSH FAILED");
      return;
    }

    const data = await res.json();
    // contents API returns new content + commit; content.sha is file sha
    GH_LAST_SHA = (data && data.content && data.content.sha) ? data.content.sha : GH_LAST_SHA;
    GH_LAST_PATH = ep.path;
    GH_LAST_AT = nowISO();

    $("ghStatus").textContent = "pushed";
    toast("PUSHED");
    renderGhUI();
  }catch(e){
    $("ghStatus").textContent = "push error";
    toast("PUSH ERROR");
  }
}
function ghOpen(){
  setGhFromInputs();
  const owner=(GH.owner||"").trim();
  const repo=(GH.repo||"").trim();
  const branch=(GH.branch||"main").trim() || "main";
  const path=(GH.path||"").trim().replace(/^\/+/,"");
  if(!owner || !repo || !path){ toast("GITHUB CFG INCOMPLETE"); return; }
  const u = `https://github.com/${owner}/${repo}/blob/${branch}/${path}`;
  window.open(u, "_blank", "noopener,noreferrer");
}
function ghForget(){
  GH.token = "";
  saveGh();
  $("ghToken").value = "";
  toast("TOKEN CLEARED");
  renderGhUI();
}

/* ===== bindings ===== */
function bind(){
  $("btnPrev").onclick = ()=>{
    let y=STATE.ui.monthY, m=STATE.ui.monthM;
    m--;
    if(m<0){ m=11; y--; }
    STATE.ui.monthY=y; STATE.ui.monthM=m;
    const first = `${y}-${String(m+1).padStart(2,"0")}-01`;
    STATE.ui.selectedDay = first;
    STATE.ui.selectedItemId = null;
    saveState();
    render();
  };
  $("btnNext").onclick = ()=>{
    let y=STATE.ui.monthY, m=STATE.ui.monthM;
    m++;
    if(m>11){ m=0; y++; }
    STATE.ui.monthY=y; STATE.ui.monthM=m;
    const first = `${y}-${String(m+1).padStart(2,"0")}-01`;
    STATE.ui.selectedDay = first;
    STATE.ui.selectedItemId = null;
    saveState();
    render();
  };
  $("btnToday").onclick = ()=>{
    const d = new Date();
    STATE.ui.monthY=d.getFullYear();
    STATE.ui.monthM=d.getMonth();
    STATE.ui.selectedDay=toDayKey(d);
    STATE.ui.selectedItemId=null;
    saveState();
    render();
  };

  $("btnCunt").onclick = ()=>{
    STATE.ui.cunt = !STATE.ui.cunt;
    saveState();
    toast(STATE.ui.cunt ? "CUNT ON" : "CUNT OFF");
    render();
  };
  $("btnInvert").onclick = ()=>{
    STATE.ui.invert = !STATE.ui.invert;
    saveState();
    toast(STATE.ui.invert ? "INVERT ON" : "INVERT OFF");
    render();
  };
  $("btnNull").onclick = ()=>{
    STATE.ui.blackout = !STATE.ui.blackout;
    saveState();
    toast(STATE.ui.blackout ? "NULL ON" : "NULL OFF");
    render();
  };

  $("daySelect").addEventListener("change",(e)=>{
    const day = e.target.value;
    STATE.ui.selectedDay = day;
    STATE.ui.selectedItemId = null;
    $("eDate").value = day;
    saveState();
    render();
  });

  $("btnAdd").onclick = ()=>addItem();
  $("btnClear").onclick = ()=>{
    $("eUrl").value="";
    $("eTitle").value="";
    $("eNote").value="";
    $("eTags").value="";
    setChipSel("none");
    toast("CLEARED");
  };

  $("btnMergeDups").onclick = ()=>mergeDups();
  $("btnToggleDayDepr").onclick = ()=>toggleDayDeprecate();

  $("btnExportDay").onclick = ()=>exportScope("day");
  $("btnExportMonth").onclick = ()=>exportScope("month");

  // output modal
  $("btnOutClose").onclick = ()=>closeOutput();
  $("btnOutCopy").onclick = ()=>copyText($("outArea").value||"");
  $("btnOutDownload").onclick = ()=>{
    const t = $("outArea").value||"";
    const ex = LAST_EXPORT.text ? LAST_EXPORT : {filename:"export.txt", mime:"text/plain"};
    downloadTextFile(ex.filename, ex.mime, t);
  };

  // state i/o
  $("btnStateExport").onclick = ()=>exportStateToFile();
  $("btnStateImport").onclick = ()=>$("fileIn").click();
  $("fileIn").addEventListener("change",(e)=>{
    const f = e.target.files && e.target.files[0];
    if(f) importStateFromFile(f);
    e.target.value="";
  });

  // github bindings
  ["ghOwner","ghRepo","ghBranch","ghPath","ghToken"].forEach(id=>{
    $(id).addEventListener("change", ()=>{ setGhFromInputs(); });
    $(id).addEventListener("blur", ()=>{ setGhFromInputs(); });
  });
  $("ghPull").onclick = ()=>ghPull();
  $("ghPush").onclick = ()=>ghPush();
  $("ghOpen").onclick = ()=>ghOpen();
  $("ghForget").onclick = ()=>ghForget();

  // keyboard
  window.addEventListener("keydown",(e)=>{
    const k=(e.key||"").toLowerCase();
    if($("out").classList.contains("open")){
      if(k==="escape") closeOutput();
      return;
    }
    if((e.ctrlKey||e.metaKey) && k==="k"){
      e.preventDefault();
      $("daySelect").focus();
      return;
    }

    const d = parseDayKey(STATE.ui.selectedDay);
    if(!d) return;

    if(k==="arrowup" || k==="arrowdown"){
      e.preventDefault();
      const delta = (k==="arrowdown") ? 1 : -1;
      const nd = new Date(d.getFullYear(), d.getMonth(), d.getDate()+delta);
      if(nd.getMonth()!==STATE.ui.monthM || nd.getFullYear()!==STATE.ui.monthY){
        STATE.ui.monthY = nd.getFullYear();
        STATE.ui.monthM = nd.getMonth();
      }
      STATE.ui.selectedDay = toDayKey(nd);
      STATE.ui.selectedItemId = null;
      saveState();
      render();
      return;
    }

    if(k==="enter"){
      const id=STATE.ui.selectedItemId;
      const it=STATE.items.find(x=>x.id===id);
      if(it) openUrl(it.url);
      return;
    }
    if(k==="d"){
      const id=STATE.ui.selectedItemId;
      if(id) toggleDeprecate(id);
      return;
    }
    if(k==="c"){
      const id=STATE.ui.selectedItemId;
      const it=STATE.items.find(x=>x.id===id);
      if(!it) return;
      const idx = PALETTE.findIndex(p=>p.id===(it.color||"none"));
      const next = PALETTE[(idx+1) % PALETTE.length].id;
      it.color = next;
      it.updatedAt = nowISO();
      saveState();
      toast("COLOR " + next.toUpperCase());
      render();
      return;
    }
  });
}

/* ===== init ===== */
buildChips();
setChipSel("none");
bind();

(function hydrate(){
  $("eDate").value = STATE.ui.selectedDay;
  // hydrate github inputs (one-time)
  renderGhUI();
  updateSig();
  $("stateKey").textContent = "KEY: " + STORE_KEY;
  applyFilters();
})();

render();

/* ===========================
   AE/EE/WB SERIALIZATION STAMP
   (mandatory)
=========================== */
/*
AE: KETA_MONO calendar grid; cunt toggle adds monochrome scanline gloss + edge vignette; no color introduced
EE: day-keyed link items; month nav; day list; deprecate+color; dedup; export day/month; state file IO; optional GitHub sync (pull/push Contents API)
WB: localStorage isolation by FILE_ID; GitHub cfg isolated by FILE_ID; clipboard + download; keyboard navigation

FILE_ID: ${FILE_ID}
ROOM_ID: LINK_TRIAGE_CALENDAR
VERSION: 2.0.0
UPDATED_AT: ${new Date().toISOString()}
CHANGELOG:
- v2: CUNT toggle; GitHub sync panel (pull/push state JSON via Contents API); tightened styling
*/
</script>
</body>
</html>
