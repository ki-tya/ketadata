<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>KETADATA BASE - PERSISTENCE FIXED</title>
<style>
body { background: #000; color: #fff; font-family: monospace; padding: 20px; }
button { padding: 10px 20px; margin: 5px; font-size: 14px; }
textarea { width: 100%; height: 100px; background: #111; color: #0f0; border: 1px solid #333; padding: 10px; font-family: monospace; }
#debug { position: fixed; bottom: 10px; right: 10px; background: #222; padding: 10px; font-size: 10px; max-width: 400px; max-height: 300px; overflow: auto; border: 1px solid #444; }
</style>
</head>
<body>

<h1>KETADATA BASE SYSTEM - PERSISTENCE TEST</h1>

<h2>Controls</h2>
<label><input type="checkbox" id="noteOpen"> Note Open</label><br>
<label><input type="checkbox" id="drawerOpen"> Drawer Open</label><br>

<h2>Note Content</h2>
<textarea id="noteText" placeholder="Type something here..."></textarea>

<h2>State</h2>
<pre id="stateDisplay"></pre>

<h2>Actions</h2>
<button onclick="manualSave()">FORCE SAVE NOW</button>
<button onclick="manualLoad()">FORCE LOAD NOW</button>
<button onclick="clearStorage()">CLEAR STORAGE</button>
<button onclick="location.reload()">REFRESH PAGE</button>

<h2>Debug Log</h2>
<div id="debug"></div>

<script>
// =============================================================================
// CONSTANTS
// =============================================================================
const STORAGE_KEY = "ketadata_base_system_v1";

// =============================================================================
// DEBUG LOGGING
// =============================================================================
const logs = [];
function log(msg) {
  const time = new Date().toISOString().slice(11,19);
  const line = `[${time}] ${msg}`;
  logs.push(line);
  console.log(line);
  
  const el = document.getElementById('debug');
  if (el) {
    el.innerHTML = logs.slice(-20).join('<br>');
  }
}

// =============================================================================
// DEFAULT STATE
// =============================================================================
const DEFAULT_STATE = {
  version: "v1",
  noteText: "",
  noteOpen: false,
  drawerOpen: false,
  timestamp: null
};

// =============================================================================
// STORAGE FUNCTIONS WITH VERIFICATION
// =============================================================================
function saveToStorage(state) {
  try {
    state.timestamp = new Date().toISOString();
    const json = JSON.stringify(state);
    
    log(`Saving ${json.length} chars...`);
    localStorage.setItem(STORAGE_KEY, json);
    
    // VERIFY
    const verify = localStorage.getItem(STORAGE_KEY);
    if (verify === json) {
      log("✓ SAVE VERIFIED");
      return true;
    } else {
      log("✗ SAVE FAILED VERIFICATION!");
      return false;
    }
  } catch(e) {
    log(`✗ SAVE ERROR: ${e.message}`);
    return false;
  }
}

function loadFromStorage() {
  try {
    log("Loading from storage...");
    const raw = localStorage.getItem(STORAGE_KEY);
    
    if (!raw) {
      log("No saved data found");
      return null;
    }
    
    log(`Found ${raw.length} chars`);
    const parsed = JSON.parse(raw);
    log(`✓ LOADED: timestamp=${parsed.timestamp}`);
    return parsed;
    
  } catch(e) {
    log(`✗ LOAD ERROR: ${e.message}`);
    return null;
  }
}

// =============================================================================
// STATE MANAGEMENT
// =============================================================================
let STATE = {...DEFAULT_STATE};

// BOOT: Try to load saved state
log("=== BOOT START ===");

const loaded = loadFromStorage();
if (loaded) {
  STATE = loaded;
  log("Using loaded state");
} else {
  log("Using default state");
}

// CRITICAL: DO NOT SAVE AT BOOT - only load!
// The old bug was saving here, which overwrote saved data with defaults

// =============================================================================
// UI BINDING
// =============================================================================
function updateUI() {
  document.getElementById('noteOpen').checked = STATE.noteOpen;
  document.getElementById('drawerOpen').checked = STATE.drawerOpen;
  document.getElementById('noteText').value = STATE.noteText;
  document.getElementById('stateDisplay').textContent = JSON.stringify(STATE, null, 2);
}

function readUI() {
  STATE.noteOpen = document.getElementById('noteOpen').checked;
  STATE.drawerOpen = document.getElementById('drawerOpen').checked;
  STATE.noteText = document.getElementById('noteText').value;
  updateUI();
  saveToStorage(STATE); // Auto-save on change
}

// Bind events
document.getElementById('noteOpen').addEventListener('change', readUI);
document.getElementById('drawerOpen').addEventListener('change', readUI);
document.getElementById('noteText').addEventListener('input', readUI);

// =============================================================================
// MANUAL CONTROLS
// =============================================================================
window.manualSave = function() {
  log("=== MANUAL SAVE ===");
  readUI();
  saveToStorage(STATE);
};

window.manualLoad = function() {
  log("=== MANUAL LOAD ===");
  const loaded = loadFromStorage();
  if (loaded) {
    STATE = loaded;
    updateUI();
  }
};

window.clearStorage = function() {
  if (confirm("Clear all saved data?")) {
    localStorage.removeItem(STORAGE_KEY);
    STATE = {...DEFAULT_STATE};
    updateUI();
    log("Storage cleared");
  }
};

// =============================================================================
// AGGRESSIVE SAVE ON UNLOAD
// =============================================================================
window.addEventListener('beforeunload', () => {
  log("=== UNLOAD - SAVING ===");
  saveToStorage(STATE);
});

window.addEventListener('pagehide', () => {
  log("=== PAGEHIDE - SAVING ===");
  saveToStorage(STATE);
});

// =============================================================================
// AUTO-SAVE EVERY 2 SECONDS
// =============================================================================
setInterval(() => {
  if (!document.hidden) {
    saveToStorage(STATE);
  }
}, 2000);

// =============================================================================
// INIT
// =============================================================================
updateUI();
log("=== BOOT COMPLETE ===");
log("Change something, then refresh the page");
</script>

</body>
</html>
