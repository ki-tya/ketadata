<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>KETADATA LINK DIRECTORY — ARCHIVE</title>
  <style>
    :root{
      --bg:#0b0b0b; --fg:#f2f2f2; --muted:#bdbdbd; --muted2:#7a7a7a;
      --line:#2a2a2a; --panel:#101010; --chip:#161616; --chip2:#0f0f0f;
      --ok:#7dff7d; --danger:#ff4d4d; --font:12px/1.25 Arial, Helvetica, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:var(--font)}
    button,input,textarea{font:var(--font);color:var(--fg);background:var(--chip2);border:1px solid var(--line);outline:none}
    button{cursor:pointer}
    button:active{transform:translateY(1px)}
    a{color:var(--fg);text-decoration:none;border-bottom:1px solid transparent}
    a:hover{border-bottom:1px solid var(--fg)}
    .wrap{min-height:100%;display:flex;flex-direction:column;gap:8px;padding:10px}
    .bar{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
    .chip{display:inline-flex;gap:6px;align-items:center;height:26px;padding:0 8px;border:1px solid var(--line);background:var(--chip)}
    .chip b{font-weight:700}
    .muted{color:var(--muted)}
    .muted2{color:var(--muted2)}
    .grow{flex:1;min-width:180px;height:26px;padding:0 8px}
    .btn{height:26px;padding:0 10px}
    .btn.ghost{background:transparent}
    .btn.ok{border-color:var(--ok);color:var(--ok)}
    .btn.danger{border-color:var(--danger);color:var(--danger)}
    .status{margin-left:auto;color:var(--muted2)}
    .hr{height:1px;background:var(--line)}
    .stage{position:relative;flex:1;min-height:360px;border:1px solid var(--line);background:var(--panel);overflow:hidden}
    .cluster{
      position:absolute; width:420px; max-width:calc(100% - 16px);
      border:1px solid var(--line); background:var(--chip2);
    }
    .clusterHeader{
      display:flex;gap:6px;align-items:center; padding:6px;
      border-bottom:1px solid var(--line); background:var(--chip);
      cursor:move; user-select:none;
    }
    .clusterHeader input{height:26px;padding:0 8px;flex:1;min-width:120px}
    .clusterBody{padding:6px;display:flex;flex-direction:column;gap:6px}
    .tools{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .tools textarea{width:100%;min-height:64px;padding:8px;resize:vertical}
    .gridHead, .rowItem{
      display:grid; grid-template-columns: 26px 1.2fr 1.6fr 1fr 1.2fr 78px;
      gap:6px; align-items:start;
    }
    .gridHead{color:var(--muted);padding:2px 0;border-bottom:1px solid var(--line)}
    .rowItem{padding:4px 0;border-bottom:1px solid var(--line)}
    .handle{
      width:26px;height:26px;display:flex;align-items:center;justify-content:center;
      border:1px solid var(--line); background:var(--chip); user-select:none; cursor:grab;
    }
    .cell input{width:100%;height:26px;padding:0 8px}
    .cell textarea{width:100%;min-height:52px;padding:8px;resize:vertical}
    .acts{display:flex;gap:6px;justify-content:flex-end;align-items:center}
    .tiny{font-size:12px}
    .note{
      position:absolute; left:10px; top:10px; width:320px; max-width:calc(100% - 20px);
      border:1px solid var(--line); background:var(--chip2);
    }
    .noteHeader{display:flex;gap:6px;align-items:center;padding:6px;border-bottom:1px solid var(--line);background:var(--chip);cursor:move;user-select:none}
    .note textarea{width:100%;min-height:120px;padding:8px;border:0;border-top:1px solid var(--line);background:transparent}
    .foot{border-top:1px solid var(--line);padding-top:8px;color:var(--muted2)}
    .dropHint{outline:1px dashed var(--muted2)}
    @media (max-width: 820px){
      .cluster{width:calc(100% - 16px)}
      .gridHead,.rowItem{grid-template-columns:26px 1fr 1fr 1fr 1fr 78px}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <div class="chip"><b>CLASS</b><span class="muted">KETADATA</span></div>
    <div class="chip"><b>MODE</b><span class="muted">ARCHIVE</span></div>
    <div class="chip"><b>WEIGHT</b><span class="muted">STANDARD</span></div>
    <div class="chip"><b>TAGS</b><span class="muted">ketadata, links, directory, archive</span></div>
    <input id="q" class="grow" placeholder="SEARCH: label / url / tags / note" />
    <button id="exportBtn" class="btn ok">EXPORT</button>
    <button id="importBtn" class="btn">IMPORT</button>
    <input id="importFile" type="file" accept="application/json" style="display:none"/>
    <button id="resetViewBtn" class="btn ghost">RESET VIEW</button>
    <div id="status" class="status"></div>
  </div>

  <div class="chip" style="width:100%">
    <b>OPERATOR NOTE</b>
    <span class="muted">This record is treated as an index object. The library is not a checkout pipeline; it is a navigation surface.</span>
  </div>

  <div class="stage" id="stage"></div>

  <div class="foot">
    <div>HOTKEYS: SHIFT+I invert (display), SHIFT+F fullscreen, SHIFT+N NULL (quiet/blackout). DRAG: cluster header; link handle. EDIT: per cluster.</div>
  </div>

  <!-- KETADATA HTML SERIALIZATION STAMP (MANDATORY) -->
  <div class="foot">
    AE: KETADATA_LINK_DIRECTORY | EE: LOCAL_FIRST_STATE+DRAG_REORDER+IMPORT_EXPORT | WB: UI_WIRING
    | FILE_ID: KETADATA_LINK_DIRECTORY_V1
    | ROOM_ID: BASE
    | VERSION: V1
    | UPDATED_AT: 2026-01-02T23:00:00-05:00
    | CHANGELOG: seed-from-uploaded-link-doc, drag-clusters, drag-links, search, bulk-add, import-export, localStorage
  </div>
</div>

<script>
(() => {
  const FILE_ID = "KETADATA_LINK_DIRECTORY_V1";
  const STORAGE_KEY = "KDT::STATE::" + FILE_ID + "::BASE::v1";

  const $ = (s, el=document) => el.querySelector(s);
  const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));

  const stage = $("#stage");
  const statusEl = $("#status");
  const qEl = $("#q");

  const uid = () => (Math.random().toString(16).slice(2) + Date.now().toString(16)).slice(0,16);

  const nowISO = () => new Date().toISOString();

  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));

  function downloadJSON(obj, filename){
    const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 0);
  }

  function parseBulk(text){
    const lines = (text || "").split("\n").map(s => s.trim()).filter(Boolean);
    const out = [];
    for (const line of lines){
      // accept raw urls or "label — url" or "label | url"
      let urlMatch = line.match(/https?:\/\/[^\s]+|(?:ketadata\.com|ki-tya\.github\.io\/ketadata)\/[A-Za-z0-9_\-+.]+\.html/);
      if (!urlMatch) continue;
      let url = urlMatch[0];
      if (url.startsWith("ketadata.com/")) url = "https://" + url;
      if (url.startsWith("ki-tya.github.io/ketadata/")) url = "https://" + url;

      let label = line.replace(urlMatch[0], "").replace(/[—|]/g," ").trim();
      if (!label) {
        const p = url.split("/").pop() || url;
        label = p.replace(".html","").replace(/[_\-]+/g," ");
      }
      out.push({label, url});
    }
    return out;
  }

  function seedFromUpload(){
    // Seeded from your uploaded link doc (extracted lanes + urls).
    // This is intentionally literal and editable.
    // NOTE: The seed values were extracted offline; once you edit, your state becomes canonical.
    const clusters = [];

    const lane = (name, x, y, urls) => {
      const items = urls.map(u => ({
        id: uid(),
        label: (u.split("/").pop() || u).replace(".html",""),
        url: u.startsWith("http") ? u : ("https://" + u),
        tags: "",
        note: "",
        deprecated: false
      }));
      clusters.push({
        id: uid(),
        name,
        x, y,
        open: true,
        edit: false,
        bulk: "",
        items
      });
    };

    // URLs pulled from your uploaded state dump.
    // Source: /mnt/data/pasted.txt
    lane("LANE: BASE VARIANTS", 10, 10, [
      "ketadata.com/based_diva3.html","ketadata.com/based_diva8.html","ketadata.com/based_diva9.html","ketadata.com/based_diva98.html","ketadata.com/based_diva98x.html",
      "ketadata.com/based_diva9a.html","ketadata.com/based_diva9b.html","ketadata.com/based_diva9c.html","ketadata.com/based_diva9d.html","ketadata.com/based_diva9e.html",
      "ketadata.com/based_diva9f.html","ketadata.com/based_diva9g.html","ketadata.com/based_diva9h.html","ketadata.com/based_diva9i.html","ketadata.com/based_diva9ii.html",
      "ketadata.com/based_diva9iii.html","ketadata.com/bbd1.html","ketadata.com/bbd2.html","ketadata.com/bbd3.html","ketadata.com/diva.html","ketadata.com/divabased4.html",
      "ketadata.com/re_diva9.html","ketadata.com/systemkill.html"
    ]);

    lane("LANE: CORE", 460, 10, [
      "ketadata.com/index.html","ketadata.com/index11.html","ketadata.com/ball.html","ketadata.com/beatball.html","ketadata.com/blacklotus2.html","ketadata.com/bleak.html",
      "ketadata.com/chakra.html","ketadata.com/infinity.html","ketadata.com/darkroom1.html","ketadata.com/redroom.html","ketadata.com/cctv1.html","ketadata.com/obscura.html",
      "ketadata.com/pulse.html","ketadata.com/crunch1.html","ketadata.com/screenplane.html","ketadata.com/screenplane1.html","ketadata.com/map.html","ketadata.com/elevator3.html",
      "ketadata.com/vault.html","ketadata.com/kdtv1.html","ketadata.com/deprecated.html","ketadata.com/room.html","ketadata.com/library.html","ketadata.com/modern.html",
      "ketadata.com/desktop.html","ketadata.com/lobby.html","ketadata.com/login.html","ketadata.com/main2.html","ketadata.com/manifest1.html","ketadata.com/registry.html",
      "ketadata.com/funding1.html"
    ]);

    lane("LANE: EXPERIMENTS", 10, 270, [
      // This lane is long; keep it literal but editable.
      // If you want fewer on load, delete rows and it will persist.
      "ketadata.com/003.html","ketadata.com/2812.html","ketadata.com/kmas.html","ketadata.com/aniversary1111.html","ketadata.com/anniversary1.html","ketadata.com/anniversary11.html",
      "ketadata.com/anniversary111.html","ketadata.com/christmas25.html","ketadata.com/debord.html","ketadata.com/deleuze.html","ketadata.com/holzer.html","ketadata.com/artaud.html",
      "ketadata.com/bataille1.html","ketadata.com/borges.html","ketadata.com/burroughs.html","ketadata.com/goffman.html","ketadata.com/jung.html","ketadata.com/land.html","ketadata.com/mcluhan.html",
      "ketadata.com/etal.html","ketadata.com/capture.html","ketadata.com/capturegpt.html","ketadata.com/capturegpt2.html","ketadata.com/capturegpt3.html","ketadata.com/capturegpt4.html",
      "ketadata.com/capturegpt5.html","ketadata.com/capturegpt6.html","ketadata.com/capturegpt7.html","ketadata.com/capturegpt8.html","ketadata.com/cp.html","ketadata.com/cp1.html",
      "ketadata.com/kitty.html","ketadata.com/drugprotocol.html","ketadata.com/depth.html","ketadata.com/fivethirtysix.html","ketadata.com/matryoshka.html","ketadata.com/sg.html","ketadata.com/sg1.html",
      "ketadata.com/snakes.html","ketadata.com/sovereignty.html","ketadata.com/teleo.html","ketadata.com/teleo1.html","ketadata.com/widefield.html","ketadata.com/chroma.html","ketadata.com/intra.html",
      "ketadata.com/funnel.html","ketadata.com/funnel1.html","ketadata.com/funnel2.html","ketadata.com/funnel3.html","ketadata.com/funnel4.html","ketadata.com/cube.html","ketadata.com/cube1.html",
      "ketadata.com/hyperstition.html","ketadata.com/hyperstition1.html","ketadata.com/hyperstition2.html","ketadata.com/hyperstition3.html","ketadata.com/hyperstition5.html",
      "ketadata.com/index0.html","ketadata.com/index001.html","ketadata.com/index002.html","ketadata.com/index003.html","ketadata.com/index004.html","ketadata.com/index005.html","ketadata.com/index006.html",
      "ketadata.com/index007.html","ketadata.com/index008.html","ketadata.com/index009.html","ketadata.com/index01.html","ketadata.com/index011.html","ketadata.com/index012.html","ketadata.com/index013.html",
      "ketadata.com/index014.html","ketadata.com/index015.html","ketadata.com/index02.html","ketadata.com/index03.html","ketadata.com/index04.html","ketadata.com/index05.html","ketadata.com/index06.html",
      "ketadata.com/index07.html","ketadata.com/index08.html","ketadata.com/index09.html",
      "ketadata.com/dmt.html","ketadata.com/dmt2.html","ketadata.com/dmt3.html","ketadata.com/dmt4.html","ketadata.com/dmtzoom.html",
      "ketadata.com/gptsubject.html","ketadata.com/subgpt2.html","ketadata.com/subgpt3.html","ketadata.com/subgpt4.html","ketadata.com/subgpt5.html",
      "ketadata.com/mandala.html","ketadata.com/mandala2.html","ketadata.com/mandala3.html",
      "ketadata.com/mandalagpt.html","ketadata.com/mandalagpt2.html","ketadata.com/mandalagpt3.html","ketadata.com/mandalagpt4.html",
      "ketadata.com/mdma.html","ketadata.com/mdma2.html","ketadata.com/mdmagpt.html","ketadata.com/mdmagpt2.html",
      "ketadata.com/misc.html","ketadata.com/misc2.html","ketadata.com/misc3.html","ketadata.com/misc4.html","ketadata.com/misc5.html","ketadata.com/misc6.html","ketadata.com/misc7.html","ketadata.com/misc8.html",
      "ketadata.com/newtrap.html","ketadata.com/newtrap2.html","ketadata.com/newtrap3.html",
      "ketadata.com/polka1.html","ketadata.com/polka2.html","ketadata.com/polkadot.html",
      "ketadata.com/pool.html","ketadata.com/pool3.html","ketadata.com/pool4.html","ketadata.com/pool5.html","ketadata.com/pool6.html",
      "ketadata.com/release.html","ketadata.com/release2.html","ketadata.com/release3.html","ketadata.com/release4.html",
      "ketadata.com/ripple.html","ketadata.com/ripple2.html","ketadata.com/ripple3.html","ketadata.com/ripplegpt.html",
      "ketadata.com/slopstream.html","ketadata.com/slopstream2.html","ketadata.com/slopstream3.html","ketadata.com/slopstream4.html","ketadata.com/slopstream5.html","ketadata.com/slopstream6.html",
      "ketadata.com/temple.html","ketadata.com/temple1.html",
      "ketadata.com/sensory.html","ketadata.com/sensory1.html","ketadata.com/sensory3.html"
    ]);

    lane("LANE: SYSTEM / TOOLS", 460, 270, [
      "ketadata.com/reading.html","ketadata.com/d2.html","ketadata.com/67.html","ketadata.com/backbone.html","ketadata.com/backbone1.html","ketadata.com/backbone2.html","ketadata.com/backend.html",
      "ketadata.com/bugtest.html","ketadata.com/cashapp1.html","ketadata.com/cashapp3.html","ketadata.com/claude_cl3.html","ketadata.com/claude_mockup.html","ketadata.com/claude.html",
      "ketadata.com/concept_cl.html","ketadata.com/concept_cl1.html","ketadata.com/concept_cl2.html","ketadata.com/concept_cl4.html","ketadata.com/contract.html","ketadata.com/debug.html","ketadata.com/diagnostic.html",
      "ketadata.com/funding.html","ketadata.com/index_copy.html","ketadata.com/index_prev1.html","ketadata.com/index01_tester.html","ketadata.com/inspector.html","ketadata.com/inspector1.html",
      "ketadata.com/linklist.html","ketadata.com/linkorg4.html","ketadata.com/main3.html","ketadata.com/manifest.html","ketadata.com/memofesto.html","ketadata.com/memofesto1.html","ketadata.com/memofesto2.html",
      "ketadata.com/mockups.html","ketadata.com/mockups1.html","ketadata.com/mockups2.html","ketadata.com/monitor.html","ketadata.com/nav.html","ketadata.com/pads.html","ketadata.com/page.html","ketadata.com/page2.html",
      "ketadata.com/primitive.html","ketadata.com/primitive1.html","ketadata.com/primitive2.html","ketadata.com/quota.html","ketadata.com/shop.html","ketadata.com/storage.html","ketadata.com/storage1.html",
      "ketadata.com/storagemanager.html","ketadata.com/sublime.html","ketadata.com/submit.html","ketadata.com/substance.html","ketadata.com/substrate.html","ketadata.com/substrate1.html","ketadata.com/substrate3.html"
    ]);

    lane("LANE: PRODUCTION TOOLS", 910, 270, [
      "ketadata.com/acid_doc.html","ketadata.com/arranger.html","ketadata.com/artifact.html","ketadata.com/board.html","ketadata.com/board1.html","ketadata.com/board2.html","ketadata.com/board3.html",
      "ketadata.com/calendar1.html","ketadata.com/circle.html","ketadata.com/classifier.html","ketadata.com/classifier1.html","ketadata.com/color1.html","ketadata.com/color3.html","ketadata.com/color5.html",
      "ketadata.com/compiler.html","ketadata.com/contextifier.html","ketadata.com/controller.html","ketadata.com/controller1.html","ketadata.com/controller2.html","ketadata.com/controller3.html",
      "ketadata.com/design1.html","ketadata.com/display1.html","ketadata.com/doc2.html","ketadata.com/editor.html","ketadata.com/font.html",
      "ketadata.com/forge3.html","ketadata.com/forge4.html","ketadata.com/forge5.html","ketadata.com/forge7.html",
      "ketadata.com/html.html","ketadata.com/interfacer.html","ketadata.com/interfacer1.html","ketadata.com/interfacer2.html",
      "ketadata.com/lab.html","ketadata.com/lab1.html","ketadata.com/lab3.html","ketadata.com/lab9.html","ketadata.com/labyrinth.html","ketadata.com/libra.html",
      "ketadata.com/manifest5.html","ketadata.com/metadata.html","ketadata.com/metadata1.html","ketadata.com/pdf2jpeg7.html","ketadata.com/pdf2jpeg8.html",
      "ketadata.com/primitive3.html","ketadata.com/prompt.html","ketadata.com/prompt1.html","ketadata.com/prompt3.html","ketadata.com/prompter.html",
      "ketadata.com/sheets.html","ketadata.com/studio.html","ketadata.com/studiofront.html","ketadata.com/studiov1.html","ketadata.com/studiov2.html","ketadata.com/studiov3.html",
      "ketadata.com/system6.html","ketadata.com/system8.html","ketadata.com/tester3.html","ketadata.com/tester31.html","ketadata.com/to-do.html","ketadata.com/unifier.html","ketadata.com/version.html"
    ]);

    return {
      version: "KDT_LINK_DIR_v1",
      fileId: FILE_ID,
      updatedAt: nowISO(),
      ui: { invert:false, nullMode:false, fullscreen:false },
      ketaNote: "",
      ketaNotePos: { x: 10, y: 10 },
      clusters
    };
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return seedFromUpload();
      const st = JSON.parse(raw);
      if (!st || st.fileId !== FILE_ID) return seedFromUpload();
      return st;
    }catch(e){
      return seedFromUpload();
    }
  }

  let state = loadState();

  function saveState(reason){
    state.updatedAt = nowISO();
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){}
    statusEl.textContent = (reason ? reason + " — " : "") + "saved " + state.updatedAt;
  }

  function applyDisplay(){
    document.documentElement.style.filter = state.ui.invert ? "invert(1)" : "none";
    if (state.ui.fullscreen) {
      if (!document.fullscreenElement) document.documentElement.requestFullscreen?.().catch(()=>{});
    } else {
      if (document.fullscreenElement) document.exitFullscreen?.().catch(()=>{});
    }
    if (state.ui.nullMode) {
      stage.style.background = "#000";
    } else {
      stage.style.background = "var(--panel)";
    }
  }

  function render(){
    stage.innerHTML = "";

    // KETA_NOTE (movable, angular)
    const note = document.createElement("div");
    note.className = "note";
    note.style.left = state.ketaNotePos.x + "px";
    note.style.top = state.ketaNotePos.y + "px";
    note.innerHTML = `
      <div class="noteHeader">
        <span class="muted">KETA_NOTE</span>
        <span class="muted2">GLOBAL</span>
        <span class="status" style="margin-left:auto">${state.updatedAt ? ("updated " + state.updatedAt) : ""}</span>
      </div>
      <textarea placeholder="NOTES (optional).">${escapeHTML(state.ketaNote || "")}</textarea>
    `;
    stage.appendChild(note);

    const noteHeader = note.querySelector(".noteHeader");
    const noteTA = note.querySelector("textarea");
    wireDrag(noteHeader, note, (x,y)=>{ state.ketaNotePos={x,y}; saveState("note moved"); });
    noteTA.addEventListener("input", () => { state.ketaNote = noteTA.value; saveState("note"); });

    // clusters
    const query = (qEl.value || "").trim().toLowerCase();

    for (const c of state.clusters){
      const el = document.createElement("div");
      el.className = "cluster";
      el.style.left = c.x + "px";
      el.style.top = c.y + "px";
      el.dataset.clusterId = c.id;

      el.innerHTML = `
        <div class="clusterHeader">
          <span class="muted">CLUSTER</span>
          <input value="${escapeAttr(c.name)}" ${c.edit ? "" : "disabled"} />
          <button class="btn">${c.edit ? "EDIT: ON" : "EDIT: OFF"}</button>
          <button class="btn ghost">ADD</button>
          <button class="btn ghost">CLR</button>
        </div>
        <div class="clusterBody" style="${c.open ? "" : "display:none"}">
          <div class="tools" style="${c.edit ? "" : "display:none"}">
            <textarea placeholder="BULK ADD: paste urls (one per line).">${escapeHTML(c.bulk || "")}</textarea>
            <div class="tools" style="width:100%">
              <button class="btn ok">APPLY BULK</button>
              <button class="btn danger">DELETE CLUSTER</button>
              <button class="btn">NEW CLUSTER</button>
            </div>
          </div>

          <div class="gridHead">
            <div></div><div>LABEL</div><div>URL</div><div>TAGS</div><div>NOTE</div><div></div>
          </div>
          <div class="items"></div>
        </div>
      `;

      stage.appendChild(el);

      const header = el.querySelector(".clusterHeader");
      const nameInput = header.querySelector("input");
      const editBtn = header.querySelectorAll("button")[0];
      const addBtn = header.querySelectorAll("button")[1];
      const clrBtn = header.querySelectorAll("button")[2];

      // cluster drag
      wireDrag(header, el, (x,y)=>{ c.x=x; c.y=y; saveState("cluster moved"); });

      // edit toggle
      editBtn.addEventListener("click", (ev)=>{
        ev.stopPropagation();
        c.edit = !c.edit;
        saveState("edit");
        render();
      });

      // add one item
      addBtn.addEventListener("click", (ev)=>{
        ev.stopPropagation();
        c.items.unshift({ id: uid(), label:"", url:"", tags:"", note:"", deprecated:false });
        c.edit = true;
        saveState("add");
        render();
      });

      // clear search highlight in cluster body (no-op but kept minimal)
      clrBtn.addEventListener("click", (ev)=>{ ev.stopPropagation(); qEl.value=""; render(); });

      // rename cluster
      nameInput.addEventListener("input", ()=>{
        c.name = nameInput.value;
        saveState("cluster name");
      });

      // bulk tools
      const bulkTA = el.querySelector("textarea");
      const applyBulkBtn = el.querySelector(".tools .btn.ok");
      const delClusterBtn = el.querySelector(".tools .btn.danger");
      const newClusterBtn = el.querySelectorAll(".tools .btn")[2];

      if (bulkTA){
        bulkTA.addEventListener("input", ()=>{ c.bulk = bulkTA.value; saveState("bulk"); });
      }
      if (applyBulkBtn){
        applyBulkBtn.addEventListener("click", ()=>{
          const adds = parseBulk(c.bulk);
          for (const a of adds){
            c.items.unshift({ id: uid(), label: a.label, url: a.url, tags:"", note:"", deprecated:false });
          }
          c.bulk = "";
          saveState("bulk applied");
          render();
        });
      }
      if (delClusterBtn){
        delClusterBtn.addEventListener("click", ()=>{
          state.clusters = state.clusters.filter(x => x.id !== c.id);
          saveState("cluster deleted");
          render();
        });
      }
      if (newClusterBtn){
        newClusterBtn.addEventListener("click", ()=>{
          state.clusters.unshift({ id: uid(), name:"NEW CLUSTER", x: 10, y: 10, open:true, edit:true, bulk:"", items:[] });
          saveState("new cluster");
          render();
        });
      }

      // render items
      const itemsWrap = el.querySelector(".items");
      const filtered = (c.items || []).filter(it => {
        if (!query) return true;
        const hay = (it.label+" "+it.url+" "+it.tags+" "+it.note).toLowerCase();
        return hay.includes(query);
      });

      for (const it of filtered){
        const row = document.createElement("div");
        row.className = "rowItem item";
        row.draggable = false;
        row.dataset.itemId = it.id;
        row.innerHTML = `
          <div class="handle" draggable="true" title="drag">::</div>
          <div class="cell">${c.edit ? `<input value="${escapeAttr(it.label)}" />` : `<div>${escapeHTML(it.label || "")}</div>`}</div>
          <div class="cell">${c.edit ? `<input value="${escapeAttr(it.url)}" />` : `<div><a href="${escapeAttr(it.url || "#")}" target="_blank" rel="noopener">${escapeHTML(it.url || "")}</a></div>`}</div>
          <div class="cell">${c.edit ? `<input value="${escapeAttr(it.tags)}" />` : `<div class="muted">${escapeHTML(it.tags || "")}</div>`}</div>
          <div class="cell">${c.edit ? `<textarea>${escapeHTML(it.note || "")}</textarea>` : `<div class="muted2">${escapeHTML(it.note || "")}</div>`}</div>
          <div class="acts">
            ${c.edit ? `<button class="btn danger tiny">DEL</button>` : `<button class="btn tiny">OPEN</button>`}
          </div>
        `;

        itemsWrap.appendChild(row);

        // edit bindings
        if (c.edit){
          const inputs = $$("input", row);
          const ta = $("textarea", row);
          inputs[0]?.addEventListener("input", ()=>{ it.label = inputs[0].value; saveState("label"); });
          inputs[1]?.addEventListener("input", ()=>{ it.url = inputs[1].value; saveState("url"); });
          inputs[2]?.addEventListener("input", ()=>{ it.tags = inputs[2].value; saveState("tags"); });
          ta?.addEventListener("input", ()=>{ it.note = ta.value; saveState("note"); });

          const delBtn = $("button.btn.danger", row);
          delBtn?.addEventListener("click", ()=>{
            c.items = c.items.filter(x => x.id !== it.id);
            saveState("delete");
            render();
          });
        } else {
          const openBtn = $("button", row);
          openBtn?.addEventListener("click", ()=>{
            if (it.url) window.open(it.url, "_blank", "noopener");
          });
        }

        // drag and drop items between clusters
        const handle = $(".handle", row);
        wireItemDrag(handle, c.id, it.id);
      }

      // allow dropping items into this cluster's items area
      itemsWrap.addEventListener("dragover", (e)=>{ e.preventDefault(); itemsWrap.classList.add("dropHint"); });
      itemsWrap.addEventListener("dragleave", ()=>{ itemsWrap.classList.remove("dropHint"); });
      itemsWrap.addEventListener("drop", (e)=>{
        e.preventDefault();
        itemsWrap.classList.remove("dropHint");
        const payload = safeJSON(e.dataTransfer.getData("text/plain"));
        if (!payload || payload.type !== "ITEM") return;
        moveItem(payload.fromClusterId, payload.itemId, c.id);
      });
    }

    applyDisplay();
  }

  function safeJSON(s){ try{return JSON.parse(s);}catch(e){return null;} }

  function moveItem(fromClusterId, itemId, toClusterId){
    if (!fromClusterId || !toClusterId) return;
    const from = state.clusters.find(x=>x.id===fromClusterId);
    const to = state.clusters.find(x=>x.id===toClusterId);
    if (!from || !to) return;
    const idx = (from.items||[]).findIndex(x=>x.id===itemId);
    if (idx < 0) return;
    const [item] = from.items.splice(idx,1);
    to.items.unshift(item);
    saveState("move item");
    render();
  }

  function wireItemDrag(handle, clusterId, itemId){
    if (!handle) return;
    handle.addEventListener("dragstart", (e)=>{
      e.dataTransfer.effectAllowed = "move";
      e.dataTransfer.setData("text/plain", JSON.stringify({ type:"ITEM", fromClusterId: clusterId, itemId }));
    });
  }

  function wireDrag(gripEl, boxEl, onDrop){
    let dragging=false, startX=0, startY=0, origX=0, origY=0;

    const onDown = (e)=>{
      // ignore button clicks
      if (e.target && (e.target.tagName === "BUTTON" || e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA")) return;
      dragging=true;
      const rect = boxEl.getBoundingClientRect();
      startX = (e.touches?e.touches[0].clientX:e.clientX);
      startY = (e.touches?e.touches[0].clientY:e.clientY);
      origX = rect.left - stage.getBoundingClientRect().left + stage.scrollLeft;
      origY = rect.top - stage.getBoundingClientRect().top + stage.scrollTop;
      document.addEventListener("mousemove", onMove);
      document.addEventListener("mouseup", onUp);
      document.addEventListener("touchmove", onMove, {passive:false});
      document.addEventListener("touchend", onUp);
    };

    const onMove = (e)=>{
      if (!dragging) return;
      if (e.cancelable) e.preventDefault();
      const x = (e.touches?e.touches[0].clientX:e.clientX);
      const y = (e.touches?e.touches[0].clientY:e.clientY);
      const dx = x - startX, dy = y - startY;
      const stageRect = stage.getBoundingClientRect();
      const nx = clamp(origX + dx, 0, stageRect.width - 40);
      const ny = clamp(origY + dy, 0, stageRect.height - 40);
      boxEl.style.left = nx + "px";
      boxEl.style.top = ny + "px";
    };

    const onUp = ()=>{
      if (!dragging) return;
      dragging=false;
      document.removeEventListener("mousemove", onMove);
      document.removeEventListener("mouseup", onUp);
      document.removeEventListener("touchmove", onMove);
      document.removeEventListener("touchend", onUp);

      const rect = boxEl.getBoundingClientRect();
      const stageRect = stage.getBoundingClientRect();
      const x = rect.left - stageRect.left + stage.scrollLeft;
      const y = rect.top - stageRect.top + stage.scrollTop;
      onDrop?.(Math.round(x), Math.round(y));
    };

    gripEl.addEventListener("mousedown", onDown);
    gripEl.addEventListener("touchstart", onDown, {passive:false});
  }

  function escapeHTML(s){
    return (s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function escapeAttr(s){ return escapeHTML(s).replace(/\n/g," "); }

  // top bar actions
  $("#exportBtn").addEventListener("click", ()=>{
    downloadJSON(state, FILE_ID + "__" + new Date().toISOString().replace(/[:.]/g,"-") + ".json");
    saveState("export");
  });

  $("#importBtn").addEventListener("click", ()=> $("#importFile").click());
  $("#importFile").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if (!f) return;
    try{
      const text = await f.text();
      const obj = JSON.parse(text);
      if (!obj || obj.fileId !== FILE_ID) {
        // allow import anyway if structure looks right
        if (obj && obj.clusters) {
          obj.fileId = FILE_ID;
          state = obj;
        } else {
          return;
        }
      } else {
        state = obj;
      }
      saveState("import");
      render();
    }catch(err){}
    e.target.value = "";
  });

  $("#resetViewBtn").addEventListener("click", ()=>{
    // keep data, reset positions
    let x=10,y=10;
    for (const c of state.clusters){
      c.x=x; c.y=y;
      x += 450; if (x > (stage.clientWidth - 440)) { x = 10; y += 260; }
    }
    state.ketaNotePos = {x:10,y:10};
    saveState("reset view");
    render();
  });

  qEl.addEventListener("input", ()=> render());

  // universals hotkeys (display-only)
  window.addEventListener("keydown", (e)=>{
    if (e.shiftKey && e.key.toLowerCase() === "i"){ state.ui.invert = !state.ui.invert; saveState("invert"); render(); }
    if (e.shiftKey && e.key.toLowerCase() === "f"){ state.ui.fullscreen = !state.ui.fullscreen; saveState("fullscreen"); render(); }
    if (e.shiftKey && e.key.toLowerCase() === "n"){ state.ui.nullMode = !state.ui.nullMode; saveState("null"); render(); }
  });

  // first render
  saveState("boot");
  render();
})();
</script>

  <!-- KETADATA HTML SERIALIZATION STAMP (MANDATORY) -->
<div id="KETADATA_SERIALIZATION_STAMP" style="border-top:1px solid #2a2a2a;padding:8px 10px;color:#7a7a7a;font:12px/1.25 Arial, Helvetica, sans-serif;background:#0b0b0b;">
  AE: KETADATA_LINK_DIRECTORY |
  EE: LOCAL_FIRST_STATE+DRAG_REORDER+SEARCH+BULK_ADD+IMPORT_EXPORT |
  WB: UI_WIRING |
  FILE_ID: KETADATA_LINK_DIRECTORY_V1 |
  ROOM_ID: BASE |
  VERSION: V1 |
  UPDATED_AT: 2026-01-02T23:00:00-05:00 |
  CHANGELOG: seed-from-uploaded-link-doc, drag-clusters, drag-links, search, bulk-add, import-export, localStorage
</div>

</body>
</html>
