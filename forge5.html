<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KETADATA // FORGE v3</title>
  <style>
    :root{
      --bg:#060606;
      --line:rgba(255,255,255,.12);
      --line2:rgba(255,255,255,.06);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.55);
      --muted2:rgba(255,255,255,.35);
      --danger:#ff3b3b;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --ui: Arial, Helvetica, sans-serif;
      --r:0px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:var(--ui);
      overflow:hidden;
    }

    /* PURE GRID ONLY (NO GRADIENTS) */
    .bggrid{
      position:fixed; inset:0;
      pointer-events:none;
      background:
        linear-gradient(to right, var(--line2) 1px, transparent 1px),
        linear-gradient(to bottom, var(--line2) 1px, transparent 1px);
      background-size: 48px 48px;
      opacity:.85;
      filter:contrast(1.05);
    }
    .bggrid::after{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(to right, rgba(255,255,255,.08) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.08) 1px, transparent 1px);
      background-size: 240px 240px;
      opacity:.18;
    }

    .app{
      position:relative;
      height:100%;
      display:grid;
      grid-template-columns: 320px 1fr 420px;
      grid-template-rows: 44px 1fr;
      gap:0;
    }

    /* TOP BAR: STICKY, HIGH Z, NEVER DISAPPEARS */
    .topbar{
      grid-column:1 / 4;
      grid-row:1;
      position:sticky;
      top:0;
      z-index:5000;
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.75);
      backdrop-filter: blur(6px);
    }
    .brand{
      font-family:var(--mono);
      letter-spacing:.08em;
      font-size:12px;
      white-space:nowrap;
    }
    .status{
      margin-left:10px;
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      display:flex;
      gap:14px;
      align-items:center;
      white-space:nowrap;
    }
    .status b{ color:var(--text); font-weight:700; }
    .spacer{ flex:1; }

    .btn{
      font-family:var(--mono);
      font-size:11px;
      letter-spacing:.06em;
      color:var(--text);
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:7px 10px;
      cursor:pointer;
      user-select:none;
      transition: background .12s linear, border-color .12s linear, transform .06s linear;
    }
    .btn:hover{ background:rgba(255,255,255,.06); border-color:rgba(255,255,255,.22); }
    .btn:active{ transform:translateY(1px); }
    .btn.danger{ border-color: rgba(255,59,59,.4); }
    .btn.danger:hover{ background: rgba(255,59,59,.08); border-color: rgba(255,59,59,.65); }
    .btn.primary{ border-color: rgba(255,255,255,.35); }
    .btn.primary:hover{ background: rgba(255,255,255,.09); }

    .panel{
      border-right:1px solid var(--line);
      overflow:hidden;
      min-width:0;
    }
    .panel.right{
      border-right:none;
      border-left:1px solid var(--line);
    }
    .paneHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 10px 8px;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.28);
    }
    .paneHead .title{
      font-family:var(--mono);
      font-size:11px;
      letter-spacing:.08em;
      color:var(--muted);
      text-transform:uppercase;
    }
    .paneBody{
      height:calc(100% - 42px);
      overflow:auto;
      padding:10px;
    }

    label{
      display:block;
      font-family:var(--mono);
      font-size:10px;
      letter-spacing:.08em;
      color:var(--muted);
      margin:10px 0 6px;
      text-transform:uppercase;
    }
    input, textarea, select{
      width:100%;
      color:var(--text);
      background:rgba(255,255,255,.02);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:9px 10px;
      font-family:var(--mono);
      font-size:12px;
      outline:none;
    }
    textarea{ min-height:92px; resize:vertical; }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(255,255,255,.28);
      background: rgba(255,255,255,.035);
    }
    .row{ display:grid; grid-template-columns: 1fr 120px; gap:10px; }
    .hint{ font-family:var(--mono); font-size:10px; color:var(--muted2); margin-top:8px; line-height:1.35; }
    .leftActions{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:10px; }
    .leftActions .btn{ width:100%; }

    .centerWrap{ grid-column:2; grid-row:2; overflow:hidden; min-width:0; }
    .centerHead{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 10px 8px; border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.22);
    }
    .centerHead .title{
      font-family:var(--mono);
      font-size:11px; letter-spacing:.08em; color:var(--muted);
      text-transform:uppercase;
    }
    .centerHead .controls{ display:flex; gap:8px; align-items:center; }
    .search{ width:260px; max-width:40vw; }

    .grid{ height:calc(100% - 42px); overflow:auto; padding:10px; }
    .cards{
      display:grid;
      grid-template-columns: repeat(2, minmax(420px, 1fr));
      gap:10px;
      align-items:start;
    }
    @media (max-width: 1400px){ .cards{ grid-template-columns: 1fr; } }

    .card{
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      border-radius:var(--r);
      overflow:hidden;
    }
    .card.selected{
      border-color: rgba(255,255,255,.35);
      box-shadow: 0 0 0 1px rgba(255,255,255,.08) inset;
    }
    .cardHead{
      display:flex; align-items:center; justify-content:space-between;
      padding:8px; border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.18);
    }
    .badge{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      border:1px solid var(--line);
      padding:4px 6px;
      white-space:nowrap;
    }
    .cardTitle{
      font-family:var(--mono);
      font-size:12px;
      letter-spacing:.06em;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 340px;
    }
    .cardHead .left{ display:flex; gap:10px; align-items:center; min-width:0; }
    .cardHead .right{ display:flex; gap:6px; align-items:center; }
    .iconBtn{
      width:28px; height:26px;
      display:grid; place-items:center;
      font-family:var(--mono);
      font-size:12px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      cursor:pointer;
      user-select:none;
    }
    .iconBtn:hover{ background:rgba(255,255,255,.06); border-color:rgba(255,255,255,.22); }
    .iconBtn.danger:hover{ background:rgba(255,59,59,.08); border-color:rgba(255,59,59,.65); }

    details{ border-bottom:1px solid var(--line); background:rgba(0,0,0,.12); }
    details:last-child{ border-bottom:none; }
    summary{
      list-style:none; cursor:pointer; padding:8px 10px;
      font-family:var(--mono); font-size:11px; letter-spacing:.08em;
      color:var(--muted); text-transform:uppercase;
      display:flex; align-items:center; justify-content:space-between;
      user-select:none;
    }
    summary::-webkit-details-marker{ display:none; }
    .sectBody{ padding:10px; background:rgba(0,0,0,.18); }
    .two{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .mini{ font-size:10px; color:var(--muted2); font-family:var(--mono); line-height:1.25; margin-top:6px; }

    .shotBox{
      border:1px dashed var(--line);
      background:rgba(255,255,255,.02);
      height:220px;
      position:relative;
      overflow:hidden;
    }
    .shotBox img{
      position:absolute; inset:0;
      width:100%;
      height:100%;
      object-fit:contain; /* NEVER CROP */
      background:#000;
    }
    .shotOverlay{
      position:absolute; inset:0;
      display:grid; place-items:center;
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      pointer-events:none;
    }
    .shotActions{ display:flex; gap:8px; margin-top:8px; }
    .shotActions .btn{ padding:6px 9px; }

    .mods{
      display:grid;
      grid-template-columns: repeat(2, minmax(220px, 1fr));
      gap:8px;
    }
    .mod{
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      padding:8px;
    }
    .modTop{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:6px; }
    .modName{
      font-family:var(--mono);
      font-size:11px;
      letter-spacing:.08em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .modNote{ min-height:68px; resize:vertical; padding:8px; font-size:11px; }

    .outBox{
      width:100%;
      height:420px;
      resize:vertical;
      font-family:var(--mono);
      font-size:11px;
      line-height:1.35;
      white-space:pre;
      overflow:auto;
    }
    .outMeta{
      display:flex; gap:10px;
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted2);
      margin-top:8px;
      align-items:center;
      justify-content:space-between;
    }
    .pill{
      border:1px solid var(--line);
      padding:4px 6px;
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
    }

    /* system note primitive */
    .noteIcon{
      position:fixed;
      top:10px;
      right:10px;
      width:14px; height:14px;
      border:1px solid rgba(255,255,255,.85);
      background:#fff;
      cursor:pointer;
      z-index:9999;
    }
    .noteIcon.open{ background:transparent; }
    .sysNote{
      position:fixed;
      top:44px;
      right:10px;
      width:360px;
      height:260px;
      border:1px solid rgba(255,255,255,.24);
      background:rgba(0,0,0,.82);
      backdrop-filter: blur(8px);
      display:none;
      z-index:9998;
    }
    .sysNote.open{ display:block; }
    .sysNoteHead{
      display:flex; align-items:center; justify-content:space-between;
      padding:8px;
      border-bottom:1px solid rgba(255,255,255,.12);
      cursor:move;
      user-select:none;
      font-family:var(--mono);
      font-size:11px;
      letter-spacing:.08em;
      color:var(--muted);
      text-transform:uppercase;
    }
    .sysNote textarea{
      border:none;
      height: calc(100% - 36px);
      resize:none;
      background:transparent;
      padding:10px;
      font-family:var(--mono);
      font-size:11px;
      line-height:1.35;
    }

    /* crucial: overlays MUST NOT block clicks */
    .bggrid{ pointer-events:none; }
  </style>
</head>
<body>
  <div class="bggrid"></div>

  <div class="noteIcon" id="noteIcon" title="SYSTEM NOTE (Cmd+;)"></div>
  <div class="sysNote" id="sysNote">
    <div class="sysNoteHead" id="sysNoteHead">
      <span>SYSTEM NOTE</span>
      <button class="btn" id="sysNoteClose" style="padding:5px 8px;">CLOSE</button>
    </div>
    <textarea id="sysNoteText" spellcheck="false" placeholder="Global free-form system note."></textarea>
  </div>

  <div class="app">
    <div class="topbar">
      <div class="brand">KETADATA // FORGE v3</div>
      <div class="status">
        <span>MODE: <b>ROOMS</b></span>
        <span>STATE: <b id="stateLabel">READY</b></span>
        <span>ROOMS: <b id="roomsCount">0</b></span>
        <span>SELECTED: <b id="selectedLabel">—</b></span>
      </div>
      <div class="spacer"></div>

      <button class="btn primary" id="btnNew">NEW</button>
      <button class="btn primary" id="btnSave">SAVE</button>
      <button class="btn primary" id="btnGenerate">GENERATE</button>
      <button class="btn" id="btnCopy">COPY</button>
      <button class="btn" id="btnExportRoom">EXPORT ROOM</button>
      <button class="btn" id="btnExportJSON">EXPORT.JSON</button>
      <label class="btn" style="display:inline-flex; align-items:center; gap:8px;">
        IMPORT.JSON
        <input id="importFile" type="file" accept="application/json" style="display:none;">
      </label>
      <button class="btn danger" id="btnReset">RESET</button>
    </div>

    <div class="panel">
      <div class="paneHead">
        <div class="title">DEFINITIONS</div>
        <div class="pill">Ctrl/Cmd+S</div>
      </div>
      <div class="paneBody">
        <label>ROOM</label>

        <div class="row">
          <div>
            <label style="margin-top:0">ID</label>
            <input id="inId" placeholder="e.g. lab / studio" spellcheck="false" />
          </div>
          <div>
            <label style="margin-top:0">ACCESS</label>
            <select id="inAccess">
              <option value="public">public</option>
              <option value="internal">internal</option>
              <option value="private">private</option>
            </select>
          </div>
        </div>

        <label>TITLE</label>
        <input id="inTitle" placeholder="e.g. LAB" spellcheck="false" />

        <label>URL</label>
        <input id="inUrl" placeholder="e.g. /lab.html" spellcheck="false" />

        <label>TAGS (comma)</label>
        <input id="inTags" placeholder="e.g. research,tools" spellcheck="false" />

        <label>NOTES</label>
        <textarea id="inNotes" spellcheck="false" placeholder="Room-specific notes."></textarea>

        <div class="leftActions">
          <button class="btn primary" id="btnAddRoom">ADD ROOM</button>
          <button class="btn" id="btnApply">APPLY TO SELECTED</button>
        </div>

        <div class="leftActions">
          <button class="btn" id="btnSelectPrev">SELECT PREV</button>
          <button class="btn" id="btnSelectNext">SELECT NEXT</button>
        </div>

        <div class="leftActions">
          <button class="btn danger" id="btnDelete">DELETE</button>
          <button class="btn" id="btnDuplicate">DUPLICATE</button>
        </div>

        <div class="hint">
          Critical: this build assumes inline scripts are blocked on your domain. Logic is in <b>/forge.v3.js</b>.
        </div>

        <label style="margin-top:14px;">REGISTRY</label>
        <div id="regList" class="mod" style="padding:8px; max-height:240px; overflow:auto;"></div>

        <div class="hint">
          Hotkeys: Cmd+; note • Ctrl/Cmd+S save • G generate • C copy
        </div>
      </div>
    </div>

    <div class="centerWrap">
      <div class="centerHead">
        <div class="title">ROOM MODULES (GRID)</div>
        <div class="controls">
          <input class="search" id="search" placeholder="search: id / title / tag" spellcheck="false" />
          <button class="btn" id="btnCollapseAll">COLLAPSE ALL</button>
          <button class="btn" id="btnExpandAll">EXPAND ALL</button>
        </div>
      </div>
      <div class="grid">
        <div class="cards" id="cards"></div>
        <div class="hint" style="margin-top:10px;">
          Select a card. Everything collapsible. Screenshot uses <b>object-fit:contain</b> (never crop).
        </div>
      </div>
    </div>

    <div class="panel right">
      <div class="paneHead">
        <div class="title">OUTPUT</div>
        <div class="pill">HTML</div>
      </div>
      <div class="paneBody">
        <label style="margin-top:0;">GENERATED HTML</label>
        <textarea class="outBox" id="out" readonly spellcheck="false">No output yet.
(select a room → Generate)</textarea>
        <div class="outMeta">
          <span id="outInfo">—</span>
          <span class="pill">Export: room JSON, forge JSON, generated HTML</span>
        </div>

        <label>ROOM JSON (selected)</label>
        <textarea class="outBox" id="roomJson" readonly style="height:220px;" spellcheck="false"></textarea>
      </div>
    </div>
  </div>

  <!-- CSP-SAFE: external script -->
  <script src="/forge.v3.js" defer></script>
</body>
</html>

