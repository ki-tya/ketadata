<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KETADATA ROUTER — LIMINAL MAP</title>
  <style>
    :root{
      --bg:#ffffff;
      --fg:#111111;
      --muted:#7a7a7a;
      --line:#cfcfcf;
      --panel:#f2f2f2;
      --panel2:#e8e8e8;
      --accent:#111111;
      --danger:#111111;
      --font: 12px/1.15 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:var(--font);overflow:hidden;}
    *{box-sizing:border-box;}
    #root{position:fixed;inset:0;}
    canvas{position:absolute;inset:0;display:block;}
    /* Decorative layers must not steal clicks */
    #fx{pointer-events:none;opacity:.28;mix-blend-mode:multiply;}
    #hud{
      position:absolute;left:10px;top:10px;
      background:var(--panel);
      border:1px solid var(--line);
      padding:8px;
      width:360px;
      user-select:none;
    }
    #hud .row{display:flex;gap:6px;flex-wrap:wrap;align-items:center;}
    #hud .row + .row{margin-top:6px;}
    #hud button{
      font:var(--font);
      padding:4px 6px;
      background:var(--bg);
      border:1px solid var(--line);
      color:var(--fg);
      cursor:pointer;
    }
    #hud button:active{transform:translateY(1px);}
    #hud .pill{
      display:inline-block;
      padding:3px 6px;
      border:1px solid var(--line);
      background:var(--bg);
      color:var(--muted);
    }
    #hud .label{color:var(--muted);}
    #hud .k{border:1px solid var(--line);padding:1px 4px;background:var(--bg);color:var(--muted);}
    #hud .sp{flex:1;}
    #legend{
      margin-top:6px;
      border-top:1px solid var(--line);
      padding-top:6px;
      color:var(--muted);
      max-height:210px;
      overflow:auto;
    }
    #legend .item{display:flex;gap:8px;align-items:flex-start;padding:3px 0;}
    #legend .dot{width:10px;height:10px;border:1px solid var(--line);background:var(--bg);margin-top:2px;flex:0 0 auto;}
    #legend .name{color:var(--fg);}
    #legend .count{color:var(--muted);}
    #toast{
      position:absolute;right:10px;top:10px;
      background:var(--panel);
      border:1px solid var(--line);
      padding:8px;
      width:340px;
      display:none;
    }
    #toast .t{color:var(--muted);}
    #toast .a{color:var(--fg);word-break:break-all;}
    #toast .btns{margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;}
    #toast button{font:var(--font);padding:4px 6px;background:var(--bg);border:1px solid var(--line);cursor:pointer;}
    #corner{
      position:absolute;left:10px;bottom:10px;
      color:var(--muted);
      background:transparent;
      user-select:none;
    }
    /* NULL mode */
    .null #hud, .null #toast, .null #corner{display:none;}
    /* Invert */
    .invert{
      --bg:#0b0b0b;
      --fg:#f2f2f2;
      --muted:#a0a0a0;
      --line:#3a3a3a;
      --panel:#111111;
      --panel2:#161616;
      --accent:#f2f2f2;
      --danger:#f2f2f2;
    }
  </style>
</head>
<body>
<div id="root">
  <canvas id="fx"></canvas>
  <canvas id="c"></canvas>

  <div id="hud">
    <div class="row">
      <span class="pill">KETADATA ROUTER / LIMINAL MAP</span>
      <span class="sp"></span>
      <span class="pill" id="statusPill">RUNNING</span>
    </div>
    <div class="row">
      <button id="btnPause">PAUSE (SPACE)</button>
      <button id="btnCenter">CENTER</button>
      <button id="btnReset">RESET LAYOUT</button>
      <button id="btnNull">NULL (SHIFT+N)</button>
      <button id="btnInvert">INVERT (SHIFT+I)</button>
      <button id="btnFull">FULL (SHIFT+F)</button>
    </div>
    <div class="row">
      <span class="label">ZOOM</span>
      <button id="zOut">-</button>
      <button id="zIn">+</button>
      <span class="label">DRAG:</span><span class="k">MOUSE</span>
      <span class="label">WHEEL:</span><span class="k">ZOOM</span>
      <span class="label">CLICK NODE:</span><span class="k">OPEN</span>
    </div>
    <div id="legend"></div>
  </div>

  <div id="toast">
    <div class="t">SELECTED</div>
    <div class="a" id="selName"></div>
    <div class="t" style="margin-top:6px;">URL</div>
    <div class="a" id="selUrl"></div>
    <div class="btns">
      <button id="openHere">OPEN</button>
      <button id="openNew">OPEN NEW TAB</button>
      <button id="copyUrl">COPY URL</button>
      <button id="closeToast">CLOSE</button>
    </div>
  </div>

  <div id="corner">
    LIMINAL CENTER / ORGANISM ROUTER — PAUSEABLE + ZOOMABLE + CLICKABLE
  </div>
</div>

<script>
(() => {
  // ========= DATA (from your consolidated cluster map; no inference) =========
  const BASE_URL = "https://ki-tya.github.io/ketadata/";

  const CLUSTERS = [
    { name:"KETA-CORE", links:[
      "based_diva9.html","elevator3.html","index.html","index013.html","index11.html","map.html","room.html"
    ]},
    { name:"BLEAK-TECH", links:[
      "ball.html","beatball.html","blacklotus2.html","bleak.html","chakra.html","memofesto.html"
    ]},
    { name:"SCREENS", links:[
      "cctv1.html","crunch1.html","darkroom1.html","kdtv1.html","obscura.html"
    ]},
    { name:"EXPERIMENTS", links:[
      "003.html","aniversary1111.html","artaud.html","bataille1.html","borges.html","burroughs.html",
      "capture.html","capturegpt.html","capturegpt2.html","capturegpt3.html","capturegpt4.html",
      "capturegpt5.html","capturegpt6.html","capturegpt7.html","capturegpt8.html","christmas25.html",
      "chroma.html","coffee.html","coffee1.html","cp1.html","cube.html","cube1.html","debord.html",
      "deleuze.html","dmt.html","dmt2.html","dmt3.html","dmt4.html","dmtzoom.html","etal.html",
      "funnel.html","funnel1.html","funnel2.html","funnel3.html","funnel4.html","goffman.html",
      "gptsubject.html","holzer.html","hyperstition.html","hyperstition1.html","hyperstition2.html",
      "hyperstition3.html","hyperstition5.html","index0.html","index001.html","index002.html",
      "index003.html","index004.html","index005.html","index006.html","index007.html","index008.html",
      "index009.html","index01.html","index011.html","index012.html","index014.html","index015.html",
      "index02.html","index03.html","index04.html","index05.html","index06.html","index07.html",
      "index08.html","index09.html","infinity.html","jung.html","kitty.html","kmas.html","land.html",
      "mandala.html","mandala2.html","mandala3.html","mandalagpt.html","mandalagpt2.html",
      "mandalagpt3.html","mandalagpt4.html","matrix.html","matryoshka.html","mcluhan.html","mdma.html",
      "mdma2.html","mdmagpt.html","mdmagpt2.html","misc.html","misc2.html","misc3.html","misc4.html",
      "misc5.html","misc6.html","misc7.html","misc8.html","molecule.html","newtrap.html","newtrap2.html",
      "newtrap3.html","polka1.html","polka2.html","polkadot.html","pool.html","pool3.html","pool4.html",
      "pool5.html","pool6.html","release.html","release2.html","release3.html","release4.html",
      "ripple.html","ripple2.html","ripple3.html","ripplegpt.html","sg.html","sg1.html","slopstream2.html",
      "slopstream3.html","slopstream4.html","slopstream6.html","snakes.html","sovereignty.html",
      "subgpt2.html","subgpt3.html","subgpt4.html","subgpt5.html","sublime.html","substance.html",
      "substrate.html","substrate1.html","substrate3.html","teleo.html","teleo1.html","temple.html","temple1.html"
    ]},
    { name:"CONCEPTUAL ALIGNMENT", links:[
      "2812.html","claude_cl3.html","concept_cl4.html","cp.html","depth.html","drugprotocol.html",
      "fivethirtysix.html","intra.html","reading.html","widefield.html"
    ]},
    { name:"BASE", links:[
      "based_diva3.html","based_diva8.html","based_diva98.html","based_diva98x.html","based_diva9a.html",
      "based_diva9b.html","based_diva9c.html","based_diva9d.html","based_diva9e.html","based_diva9f.html",
      "based_diva9g.html","based_diva9h.html","based_diva9i.html","based_diva9ii.html","based_diva9iii.html",
      "bbd1.html","bbd2.html","bbd3.html","diva.html","divabased4.html","re_diva9.html","systemkill.html"
    ]},
    { name:"SYSTEM", links:[
      "backbone.html","backbone1.html","backbone2.html","backend.html","claude_mockup.html","claude.html",
      "contract.html","memofesto1.html","memofesto2.html","mockups.html","mockups1.html","mockups2.html",
      "nav.html","pads.html","page.html"
    ]},
    { name:"SYS-UTIL", links:[
      "arranger.html","bugtest.html","debug.html","diagnostic.html","inspector.html","inspector1.html",
      "linklist.html","linkorg4.html","main3.html","manifest.html","master2.html","mastergpt.html","monitor.html",
      "primitive.html","primitive1.html","primitive2.html","primitive3.html","pulse.html","quota.html","reg.html",
      "regv3.html","regv4.html","screenplane.html","screenplane1.html","storage.html","storage1.html",
      "storagemanager.html","system8.html","version.html","videomanager.html"
    ]},
    { name:"SYS-PR", links:[
      "cashapp1.html","cashapp3.html","funding.html","shop.html","submit.html"
    ]},
    { name:"TESTERS", links:[
      "anniversary1.html","anniversary11.html","anniversary111.html","concept_cl.html","concept_cl1.html","concept_cl2.html",
      "darkroom.html","doc5.html","index_copy.html","index_prev1.html","index01_tester.html","lib_cl.html","mandala88.html",
      "master.html","master1.html","redroom.html","to-do.html","to-do1.html","vape-drive.html","vault.html","video.html","video2.html"
    ]},
    { name:"SECRET", links:["67.html","page2.html"]},
    { name:"CORE", links:[
      "deprecated.html","design1.html","lab.html","lab1.html","labyrinth.html","lib_gpt.html","linksv3.html",
      "main2.html","sensory3.html","studiofront.html","studiov2.html","studiov3.html","tester3.html","tester31.html"
    ]},
    { name:"CORE-UTIL", links:[
      "acid_doc.html","artifact.html","board.html","board1.html","board2.html","board3.html","calendar1.html",
      "controller.html","controller1.html","controller2.html","controller3.html","display1.html","doc2.html",
      "manifest5.html","modern.html","pdf2jpeg7.html","sheets.html","studio.html","to-do2.html"
    ]},
    { name:"DESIGN-UTIL", links:["color1.html","color3.html","font.html"]},
    { name:"PHOTOG-UTIL", links:["editor.html","studiov1.html"]},
    { name:"DATA-UTIL", links:["pdf2jpeg8.html"]},
    { name:"META-COG", links:["circle.html","libra.html"]},
    { name:"LLM-UTIL", links:["compiler.html","contextifier.html","d2.html","prompt.html","prompt1.html","prompt3.html","prompter.html"]},
    { name:"HTML-UTIL", links:["classifier.html","classifier1.html","forge3.html","forge4.html","forge5.html","forge7.html","html.html","metadata.html","metadata1.html","unifier.html"]},
    { name:"UI-UTIL", links:["color5.html","interfacer.html","interfacer1.html","interfacer2.html","lab3.html","lab9.html","system6.html"]},
  ];

  // ========= CANVAS + SIM =========
  const root = document.documentElement;
  const canvas = document.getElementById("c");
  const fx = document.getElementById("fx");
  const ctx = canvas.getContext("2d", { alpha:false });
  const fctx = fx.getContext("2d");

  const hud = document.getElementById("hud");
  const legend = document.getElementById("legend");
  const toast = document.getElementById("toast");
  const selNameEl = document.getElementById("selName");
  const selUrlEl = document.getElementById("selUrl");

  const btnPause = document.getElementById("btnPause");
  const btnCenter = document.getElementById("btnCenter");
  const btnReset = document.getElementById("btnReset");
  const btnNull = document.getElementById("btnNull");
  const btnInvert = document.getElementById("btnInvert");
  const btnFull = document.getElementById("btnFull");
  const zIn = document.getElementById("zIn");
  const zOut = document.getElementById("zOut");
  const statusPill = document.getElementById("statusPill");

  const openHere = document.getElementById("openHere");
  const openNew = document.getElementById("openNew");
  const copyUrl = document.getElementById("copyUrl");
  const closeToast = document.getElementById("closeToast");

  const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  let W=0,H=0;

  function resize(){
    W = Math.floor(window.innerWidth);
    H = Math.floor(window.innerHeight);
    canvas.width = Math.floor(W * DPR);
    canvas.height = Math.floor(H * DPR);
    canvas.style.width = W+"px";
    canvas.style.height = H+"px";
    fx.width = canvas.width;
    fx.height = canvas.height;
    fx.style.width = canvas.style.width;
    fx.style.height = canvas.style.height;
    ctx.setTransform(DPR,0,0,DPR,0,0);
    fctx.setTransform(DPR,0,0,DPR,0,0);
  }
  window.addEventListener("resize", resize);
  resize();

  function cssVar(name){
    return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  }

  const sim = {
    running:true,
    t:0,
    nodes:[],
    edges:[],
    selected:null,
    view:{ x:0, y:0, z:1 }, // pan + zoom
    drag:{ active:false, vx:0, vy:0, sx:0, sy:0, startX:0, startY:0 },
    pointer:{ x:0, y:0, down:false, moved:false },
  };

  function makeUrl(path){
    if (/^https?:\/\//i.test(path)) return path;
    return BASE_URL + path.replace(/^\//,'');
  }

  function hashColor(str){
    // grey-scale deterministic
    let h=2166136261>>>0;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i); h = Math.imul(h, 16777619)>>>0;
    }
    const v = 55 + (h % 160); // 55..214
    return `rgb(${v},${v},${v})`;
  }

  function buildLegend(){
    legend.innerHTML = "";
    const frag = document.createDocumentFragment();
    CLUSTERS.forEach(c => {
      const row = document.createElement("div");
      row.className = "item";
      const dot = document.createElement("div");
      dot.className = "dot";
      dot.style.borderColor = cssVar("--line");
      dot.style.background = hashColor(c.name);
      const name = document.createElement("div");
      name.innerHTML = `<span class="name">${c.name}</span> <span class="count">(${c.links.length})</span>`;
      row.appendChild(dot);
      row.appendChild(name);
      frag.appendChild(row);
    });
    legend.appendChild(frag);
  }
  buildLegend();

  function initLayout(){
    sim.nodes = [];
    sim.edges = [];

    const center = { x:0, y:0 };
    const centerNode = {
      id:"CENTER",
      type:"center",
      label:"LIMINAL",
      url:"",
      x:center.x, y:center.y, vx:0, vy:0,
      r:26,
      mass:3.0,
      color: cssVar("--fg"),
    };
    sim.nodes.push(centerNode);

    // Place clusters in a ring around center
    const R = 360;
    const nC = CLUSTERS.length;
    for(let i=0;i<nC;i++){
      const c = CLUSTERS[i];
      const a = (i / nC) * Math.PI * 2;
      const cx = Math.cos(a)*R;
      const cy = Math.sin(a)*R;

      const clusterNode = {
        id:`CL_${c.name}`,
        type:"cluster",
        label:c.name,
        url:"",
        x:cx, y:cy, vx:0, vy:0,
        r:18,
        mass:2.2,
        color: hashColor(c.name),
        count:c.links.length,
      };
      sim.nodes.push(clusterNode);
      sim.edges.push({ a:centerNode, b:clusterNode, k:0.010, rest:R, kind:"spine" });

      // Child nodes (links) around each cluster
      const m = c.links.length;
      const childR = Math.max(90, Math.min(240, 80 + m*4));
      for(let j=0;j<m;j++){
        const p = c.links[j];
        const aa = (j / Math.max(1,m)) * Math.PI * 2;
        const jitter = (j%7)*3;
        const lx = cx + Math.cos(aa)*(childR + jitter);
        const ly = cy + Math.sin(aa)*(childR + jitter);

        const node = {
          id:`L_${c.name}_${p}`,
          type:"link",
          label:p,
          url:makeUrl(p),
          x:lx, y:ly, vx:0, vy:0,
          r:10,
          mass:1.0,
          color: clusterNode.color,
          parent: clusterNode,
        };
        sim.nodes.push(node);
        sim.edges.push({ a:clusterNode, b:node, k:0.012, rest:childR, kind:"tether" });
      }
    }

    // Pan/zoom to show everything
    sim.view.z = 0.85;
    sim.view.x = W/2;
    sim.view.y = H/2;
  }

  initLayout();

  function worldToScreen(x,y){
    const z = sim.view.z;
    return { x: sim.view.x + x*z, y: sim.view.y + y*z };
  }
  function screenToWorld(x,y){
    const z = sim.view.z;
    return { x: (x - sim.view.x)/z, y: (y - sim.view.y)/z };
  }

  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

  function step(dt){
    // physics constants (surreal brutalist machine = restrained, not gooey)
    const repel = 2200;
    const damp = 0.88;
    const maxV = 900;
    const centerPull = 0.0008;

    const nodes = sim.nodes;

    // gentle organismic drift (deterministic)
    sim.t += dt;
    const driftT = sim.t;

    // pairwise repulsion (skip center->link overwork with coarse gating)
    for(let i=0;i<nodes.length;i++){
      const A = nodes[i];
      for(let j=i+1;j<nodes.length;j++){
        const B = nodes[j];

        // Light gating: don’t heavily repel link nodes that share a parent (keeps “organism” clustered)
        if (A.type==="link" && B.type==="link" && A.parent && B.parent && A.parent===B.parent){
          continue;
        }

        const dx = B.x - A.x;
        const dy = B.y - A.y;
        const d2 = dx*dx + dy*dy + 0.0001;
        const d = Math.sqrt(d2);
        const minD = (A.r + B.r) * 2.2;
        const strength = repel / d2;

        const ux = dx / d;
        const uy = dy / d;

        const push = (d < minD) ? (strength*2.2) : strength;

        A.vx -= ux * push / A.mass;
        A.vy -= uy * push / A.mass;
        B.vx += ux * push / B.mass;
        B.vy += uy * push / B.mass;
      }
    }

    // edges (springs)
    for(const e of sim.edges){
      const A = e.a, B = e.b;
      const dx = B.x - A.x;
      const dy = B.y - A.y;
      const d = Math.sqrt(dx*dx + dy*dy) + 0.0001;
      const ux = dx / d, uy = dy / d;
      const stretch = (d - e.rest);
      const f = stretch * e.k * 1000; // scale to feel alive but controlled

      A.vx += ux * f / A.mass;
      A.vy += uy * f / A.mass;
      B.vx -= ux * f / B.mass;
      B.vy -= uy * f / B.mass;
    }

    // central gravity keeps the organism coherent
    const centerNode = nodes[0];
    for(const n of nodes){
      if (n===centerNode) continue;
      n.vx += (centerNode.x - n.x) * centerPull;
      n.vy += (centerNode.y - n.y) * centerPull;
    }

    // organism drift (very slight)
    for(const n of nodes){
      const s = (n.type==="center") ? 0.0 : (n.type==="cluster" ? 14 : 8);
      const nx = Math.sin(driftT*0.0007 + (n.id.length*0.31)) * s;
      const ny = Math.cos(driftT*0.0006 + (n.id.length*0.27)) * s;
      n.vx += nx * 0.0008;
      n.vy += ny * 0.0008;
    }

    // integrate
    for(const n of nodes){
      n.vx *= damp;
      n.vy *= damp;

      n.vx = clamp(n.vx, -maxV, maxV);
      n.vy = clamp(n.vy, -maxV, maxV);

      n.x += n.vx * (dt/1000);
      n.y += n.vy * (dt/1000);
    }
  }

  function draw(){
    const bg = cssVar("--bg");
    const fg = cssVar("--fg");
    const muted = cssVar("--muted");
    const line = cssVar("--line");

    ctx.fillStyle = bg;
    ctx.fillRect(0,0,W,H);

    // FX: subtle “machine haze”
    fctx.clearRect(0,0,W,H);
    fctx.globalAlpha = 0.28;
    fctx.strokeStyle = line;
    fctx.lineWidth = 1;
    fctx.beginPath();
    const grid = 64;
    for(let x=0;x<=W;x+=grid){
      fctx.moveTo(x,0); fctx.lineTo(x,H);
    }
    for(let y=0;y<=H;y+=grid){
      fctx.moveTo(0,y); fctx.lineTo(W,y);
    }
    fctx.stroke();
    fctx.globalAlpha = 1;

    // edges
    ctx.lineWidth = 1;
    ctx.strokeStyle = line;
    ctx.beginPath();
    for(const e of sim.edges){
      const A = worldToScreen(e.a.x, e.a.y);
      const B = worldToScreen(e.b.x, e.b.y);
      ctx.moveTo(A.x, A.y);
      // slight curve = “organism”
      const mx = (A.x + B.x)/2;
      const my = (A.y + B.y)/2;
      const bend = (e.kind==="spine") ? 0.0 : 12.0;
      const nx = (B.y - A.y);
      const ny = -(B.x - A.x);
      const nd = Math.sqrt(nx*nx + ny*ny) + 0.0001;
      const cx = mx + (nx/nd)*bend;
      const cy = my + (ny/nd)*bend;
      ctx.quadraticCurveTo(cx, cy, B.x, B.y);
    }
    ctx.stroke();

    // nodes
    const z = sim.view.z;
    ctx.textBaseline = "middle";
    ctx.font = getComputedStyle(document.body).font; // uniform

    for(const n of sim.nodes){
      const S = worldToScreen(n.x, n.y);
      const r = n.r * Math.max(0.7, Math.min(1.25, z));
      const isSel = sim.selected && sim.selected.id === n.id;

      // body
      ctx.fillStyle = (n.type==="center") ? fg : n.color;
      ctx.strokeStyle = line;
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.arc(S.x, S.y, r, 0, Math.PI*2);
      ctx.fill();
      ctx.stroke();

      // label
      const showLabel =
        (n.type!=="link") ||
        (z > 0.70) ||
        isSel;

      if(showLabel){
        const pad = 6;
        const text = (n.type==="cluster") ? `${n.label} (${n.count})` : (n.type==="center" ? n.label : n.label);
        const tw = ctx.measureText(text).width;
        const bx = S.x + r + 6;
        const by = S.y;
        const bh = 18;
        const bw = tw + pad*2;

        ctx.fillStyle = bg;
        ctx.strokeStyle = line;
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.rect(bx, by - bh/2, bw, bh);
        ctx.fill();
        ctx.stroke();

        ctx.fillStyle = (n.type==="link") ? muted : fg;
        if(isSel) ctx.fillStyle = fg;
        ctx.fillText(text, bx + pad, by);
      }

      // selected ring
      if(isSel){
        ctx.strokeStyle = fg;
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(S.x, S.y, r+4, 0, Math.PI*2);
        ctx.stroke();
      }
    }
  }

  // ========= HIT TEST / INTERACTION =========
  function pickNode(screenX, screenY){
    const w = screenToWorld(screenX, screenY);
    let best = null;
    let bestD = Infinity;
    for(const n of sim.nodes){
      const dx = w.x - n.x, dy = w.y - n.y;
      const d2 = dx*dx + dy*dy;
      const r = n.r;
      if (d2 <= (r*r)*1.3){
        if (d2 < bestD){
          bestD = d2;
          best = n;
        }
      }
    }
    return best;
  }

  function showToast(node, screenX, screenY){
    sim.selected = node;
    if(!node) { toast.style.display="none"; return; }

    const name = (node.type==="link") ? node.label : node.label;
    const url = node.url || "";
    selNameEl.textContent = `${node.type.toUpperCase()} — ${name}`;
    selUrlEl.textContent = url || "(no url)";

    toast.style.display = "block";
    // pin top-right; keep simple (uniform text size rule)
  }

  function openNode(node, newTab){
    if(!node || !node.url) return;
    if(newTab) window.open(node.url, "_blank", "noopener,noreferrer");
    else window.location.href = node.url;
  }

  // Pan drag
  canvas.addEventListener("mousedown", (e) => {
    sim.pointer.down = true;
    sim.pointer.moved = false;
    sim.drag.active = true;
    sim.drag.sx = e.clientX;
    sim.drag.sy = e.clientY;
    sim.drag.startX = sim.view.x;
    sim.drag.startY = sim.view.y;
  });
  window.addEventListener("mousemove", (e) => {
    sim.pointer.x = e.clientX;
    sim.pointer.y = e.clientY;
    if(sim.drag.active){
      const dx = e.clientX - sim.drag.sx;
      const dy = e.clientY - sim.drag.sy;
      if (Math.abs(dx)+Math.abs(dy) > 2) sim.pointer.moved = true;
      sim.view.x = sim.drag.startX + dx;
      sim.view.y = sim.drag.startY + dy;
    }
  });
  window.addEventListener("mouseup", (e) => {
    if(sim.drag.active){
      sim.drag.active = false;
    }
    if(sim.pointer.down){
      sim.pointer.down = false;
      // click if not dragged
      if(!sim.pointer.moved){
        const node = pickNode(e.clientX, e.clientY);
        if(node){
          showToast(node, e.clientX, e.clientY);
          // direct click: open links; clusters just select
          if(node.type==="link") openNode(node, true);
        }else{
          sim.selected = null;
          toast.style.display="none";
        }
      }
    }
  });

  // zoom wheel
  canvas.addEventListener("wheel", (e) => {
    e.preventDefault();
    const prev = sim.view.z;
    const delta = -e.deltaY;
    const factor = Math.exp(delta * 0.0012);
    const next = clamp(prev * factor, 0.18, 2.8);

    // zoom around pointer
    const mx = e.clientX, my = e.clientY;
    const before = screenToWorld(mx, my);
    sim.view.z = next;
    const after = screenToWorld(mx, my);
    sim.view.x += (after.x - before.x) * next;
    sim.view.y += (after.y - before.y) * next;
  }, { passive:false });

  // Buttons
  function setRunning(r){
    sim.running = r;
    statusPill.textContent = r ? "RUNNING" : "PAUSED";
    btnPause.textContent = r ? "PAUSE (SPACE)" : "RUN (SPACE)";
  }
  btnPause.onclick = () => setRunning(!sim.running);
  btnCenter.onclick = () => { sim.view.x = W/2; sim.view.y = H/2; };
  btnReset.onclick = () => { initLayout(); toast.style.display="none"; sim.selected=null; };
  zIn.onclick = () => sim.view.z = clamp(sim.view.z*1.15, 0.18, 2.8);
  zOut.onclick = () => sim.view.z = clamp(sim.view.z/1.15, 0.18, 2.8);

  function toggleNull(){
    document.body.classList.toggle("null");
  }
  function toggleInvert(){
    document.body.classList.toggle("invert");
    buildLegend();
  }
  function toggleFull(){
    if(!document.fullscreenElement){
      document.documentElement.requestFullscreen?.();
    }else{
      document.exitFullscreen?.();
    }
  }
  btnNull.onclick = toggleNull;
  btnInvert.onclick = toggleInvert;
  btnFull.onclick = toggleFull;

  openHere.onclick = () => openNode(sim.selected, false);
  openNew.onclick = () => openNode(sim.selected, true);
  copyUrl.onclick = async () => {
    const u = sim.selected?.url;
    if(!u) return;
    try { await navigator.clipboard.writeText(u); } catch {}
  };
  closeToast.onclick = () => { toast.style.display="none"; };

  // Hotkeys (system universals + pause)
  window.addEventListener("keydown", (e) => {
    if(e.key === " "){
      e.preventDefault();
      setRunning(!sim.running);
      return;
    }
    if(e.shiftKey && (e.key === "I" || e.key === "i")) { e.preventDefault(); toggleInvert(); return; }
    if(e.shiftKey && (e.key === "N" || e.key === "n")) { e.preventDefault(); toggleNull(); return; }
    if(e.shiftKey && (e.key === "F" || e.key === "f")) { e.preventDefault(); toggleFull(); return; }
    if(e.key === "Escape"){
      toast.style.display="none";
      sim.selected=null;
    }
  });

  // ========= LOOP =========
  let last = performance.now();
  function loop(now){
    const dt = Math.min(40, now - last);
    last = now;
    if(sim.running) step(dt);
    draw();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

})();
</script>

<!--
AE / EE / WB — KETADATA SERIALIZATION STAMP (MANDATORY)
AE: BRUTAL MINIMAL MAP / MONOCHROME / SURREAL-MACHINE ORGANISM
EE: FORCE-DIRECTED ROUTER (PAUSE / ZOOM / PAN / CLICK-OPEN)
WB: SINGLE-FILE, SYSTEM UNIVERSALS (SHIFT+I INVERT, SHIFT+N NULL, SHIFT+F FULL, SPACE PAUSE)

FILE_ID: "KETADATA_ROUTER_LIMINAL_MINDMAP"
ROOM_ID: "K_ROUTER"
VERSION_ID: "V1"
UPDATED_AT: "2026-01-04T00:00:00.000-05:00"
CHANGELOG:
- V1: LIMINAL CENTER ROUTER, CLUSTER MODULES + LINK OFFSHOOTS, ORGANISM MOTION, PAUSE/ZOOM/CLICK, KD AESTHETICS, SYSTEM UNIVERSALS
-->
</body>
</html>
