<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Meditation Room — KETADATA</title>
  <style>
    /* Fullscreen canvas mount */
    html, body { margin:0; height:100%; background:#000; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    #mount { position:fixed; inset:0; }
    /* Overlay */
    .overlay { position:fixed; inset:0; pointer-events:none; }
    .hud { position:absolute; left:50%; bottom:8rem; transform:translateX(-50%); text-align:center; pointer-events:auto; display:flex; flex-direction:column; gap:1rem; align-items:center; }
    .timer {
      font-size: clamp(48px, 12vw, 140px);
      font-weight: 900;
      letter-spacing: 0.15em;
      color:#ff0000;
      text-shadow: 0 0 20px rgba(255,0,0,.8), 0 0 40px rgba(255,0,0,.5);
      font-variant-numeric: tabular-nums;
    }
    .btn {
      cursor:pointer; background:none; border:none; color:#ff0000; font-size:32px;
      text-shadow: 0 0 10px rgba(255,0,0,0.8); transition: transform .15s ease;
      padding:0 .25rem;
    }
    .btn:hover { transform: scale(1.1); }
    .corner { position:absolute; top:1rem; display:flex; gap:.5rem; align-items:center; pointer-events:auto; }
    .left { left:1rem; }
    .right { right:1rem; flex-direction:column; align-items:flex-end; }
    .chip {
      font-size:12px; color:#fff; border:1px solid rgba(255,255,255,.25);
      border-radius:999px; padding:.4rem .6rem; background: rgba(255,255,255,.08);
      backdrop-filter: blur(6px); cursor:pointer;
    }
    .chip.active { background: rgba(168,85,247,.35); }  /* purple-ish when active */
    .swatch {
      width:32px; height:32px; border-radius:999px; border:2px solid rgba(255,255,255,.35);
      transition: transform .15s ease; cursor:pointer;
    }
    .swatch:hover { transform: scale(1.1); }
    .picker { display:flex; gap:.5rem; background:rgba(0,0,0,.7); padding:.5rem; border-radius:.75rem; margin-left:.5rem; }
    .hint { position:fixed; bottom:.5rem; left:50%; transform:translateX(-50%); opacity:.5; font-size:12px; letter-spacing:.06em; }
    a { color:#fff; }
  </style>
</head>
<body>
  <!-- Three.js mount -->
  <div id="mount"></div>

  <!-- UI overlays -->
  <div class="overlay">
    <!-- Left controls: color + pulsate -->
    <div class="corner left">
      <button id="colorButton" class="swatch" title="Light color"></button>
      <div id="picker" class="picker" style="display:none"></div>
      <button id="pulsate" class="chip">○</button>
    </div>

    <!-- Right controls: rotate -->
    <div class="corner right">
      <button id="rotate" class="chip">⟳</button>
    </div>

    <!-- Timer + controls -->
    <div class="hud">
      <div id="timer" class="timer">10:00</div>
      <div>
        <button id="startStop" class="btn" title="Start/Pause">⏻</button>
        <button id="reset" class="btn" title="Reset">↻</button>
      </div>
    </div>

    <div class="hint">Press <b>R</b> from index to open this room • Press <b>M</b> for map (if you wired it)</div>
  </div>

  <!-- Three.js (CDN) -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>

  <script>
    // ---------------- State ----------------
    let isActive = false;
    let seconds = 600; // 10 minutes
    let lightColor = '#808080';
    let isPulsating = false;
    let isRotating = false;

    const colorPresets = [
      { name: 'Green',  color: '#51cf66' },
      { name: 'Red',    color: '#ff6b6b' },
      { name: 'Purple', color: '#9775fa' },
      { name: 'Blue',   color: '#4a90e2' },
      { name: 'Orange', color: '#ffa94d' }
    ];

    // ---------------- UI refs ----------------
    const mount = document.getElementById('mount');
    const timerEl = document.getElementById('timer');
    const startStopEl = document.getElementById('startStop');
    const resetEl = document.getElementById('reset');
    const colorBtn = document.getElementById('colorButton');
    const picker = document.getElementById('picker');
    const pulsateBtn = document.getElementById('pulsate');
    const rotateBtn = document.getElementById('rotate');

    // ---------------- Three.js setup ----------------
    let scene, camera, renderer, floodLight, animationId;
    let time = 0;

    function initThree() {
      const width = mount.clientWidth;
      const height = mount.clientHeight;

      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x1a1a1a);

      camera = new THREE.PerspectiveCamera(95, width / height, 0.1, 1000);
      camera.position.set(0, 0.5, 0);
      camera.lookAt(0, 1.5, -8);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(width, height);
      renderer.shadowMap.enabled = true;
      renderer.domElement.style.width = '100%';
      renderer.domElement.style.height = '100%';
      renderer.domElement.style.display = 'block';
      mount.appendChild(renderer.domElement);

      const ambientLight = new THREE.AmbientLight(0xffffff, 0.3);
      scene.add(ambientLight);

      floodLight = new THREE.PointLight(0x808080, 2, 25);
      floodLight.position.set(0, 4, 0);
      scene.add(floodLight);

      // Floor
      const floor = new THREE.Mesh(
        new THREE.CircleGeometry(6, 64),
        new THREE.MeshStandardMaterial({ color: 0x0a0a0a, roughness: 0.8, metalness: 0.2 })
      );
      floor.rotation.x = -Math.PI / 2;
      scene.add(floor);

      // Walls
      const walls = new THREE.Mesh(
        new THREE.CylinderGeometry(6, 6, 5, 64, 1, true),
        new THREE.MeshStandardMaterial({ color: 0x2a2a2a, roughness: 0.3, metalness: 0.7, side: THREE.BackSide })
      );
      walls.position.y = 2.5;
      scene.add(walls);

      // Ceiling
      const ceiling = new THREE.Mesh(
        new THREE.CircleGeometry(6, 64),
        new THREE.MeshStandardMaterial({ color: 0x1a1a1a, roughness: 0.1, metalness: 0.9, side: THREE.BackSide })
      );
      ceiling.rotation.x = Math.PI / 2;
      ceiling.position.y = 5;
      scene.add(ceiling);

      // Panoramic window
      const windowMesh = new THREE.Mesh(
        new THREE.CylinderGeometry(5.85, 5.85, 3.5, 64, 1, true, 0, Math.PI * 1.3),
        new THREE.MeshStandardMaterial({ color: 0xaaccee, transparent: true, opacity: 0.15, roughness: 0.05, metalness: 0.95, side: THREE.DoubleSide })
      );
      windowMesh.position.y = 2.5;
      windowMesh.rotation.y = -Math.PI * 0.65;
      scene.add(windowMesh);

      // Window frame rings
      const frameMat = new THREE.MeshStandardMaterial({ color: 0xcccccc, roughness: 0.1, metalness: 0.95 });
      const frameTop = new THREE.Mesh(new THREE.TorusGeometry(5.85, 0.08, 16, 64), frameMat);
      frameTop.position.y = 4.25; frameTop.rotation.x = Math.PI / 2; scene.add(frameTop);
      const frameBottom = new THREE.Mesh(new THREE.TorusGeometry(5.85, 0.08, 16, 64), frameMat);
      frameBottom.position.y = 0.75; frameBottom.rotation.x = Math.PI / 2; scene.add(frameBottom);

      // Vertical supports
      for (let i = 0; i < 4; i++) {
        const angle = (Math.PI * 1.3 / 3) * i - Math.PI * 0.65;
        const x = Math.sin(angle) * 5.85;
        const z = Math.cos(angle) * 5.85;
        const support = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.08, 3.5, 16), frameMat);
        support.position.set(x, 2.5, z);
        scene.add(support);
      }

      // Sky + horizon
      const sky = new THREE.Mesh(new THREE.SphereGeometry(50, 32, 32), new THREE.MeshBasicMaterial({ color: 0x0a0a0a, side: THREE.BackSide }));
      scene.add(sky);
      const horizon = new THREE.Mesh(new THREE.PlaneGeometry(100, 25), new THREE.MeshBasicMaterial({ color: 0x0a0a0a }));
      horizon.position.set(0, -2, -35);
      scene.add(horizon);

      // Animate
      function animate() {
        animationId = requestAnimationFrame(animate);
        time += 0.01;

        if (isPulsating && floodLight) {
          floodLight.intensity = 2 + Math.sin(time * 2) * 0.8;
        } else if (floodLight) {
          floodLight.intensity = 2;
        }

        if (isRotating) {
          scene.rotation.y += 0.002;
        }

        renderer.render(scene, camera);
      }
      animate();

      // Resize
      window.addEventListener('resize', onResize);
      function onResize() {
        const w = mount.clientWidth, h = mount.clientHeight;
        camera.aspect = w / h; camera.updateProjectionMatrix(); renderer.setSize(w, h);
      }
    }

    // ---------------- Timer ----------------
    let tickInterval = null;
    function formatTime(totalSeconds) {
      const m = Math.floor(totalSeconds / 60);
      const s = totalSeconds % 60;
      return String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
    }
    function updateTimerDisplay() { timerEl.textContent = formatTime(seconds); }
    function startTimer() {
      if (tickInterval || seconds <= 0) return;
      tickInterval = setInterval(() => {
        seconds--;
        updateTimerDisplay();
        if (seconds <= 0) { stopTimer(); isActive = false; startStopEl.style.color = '#888888'; }
      }, 1000);
    }
    function stopTimer() { clearInterval(tickInterval); tickInterval = null; }
    function resetTimer() { stopTimer(); seconds = 600; isActive = false; updateTimerDisplay(); startStopEl.style.color = '#ff0000'; }

    // ---------------- UI wiring ----------------
    function buildColorPicker() {
      picker.innerHTML = '';
      colorPresets.forEach(p => {
        const b = document.createElement('button');
        b.className = 'swatch';
        b.style.backgroundColor = p.color;
        b.title = p.name;
        b.onclick = () => {
          lightColor = p.color;
          colorBtn.style.backgroundColor = lightColor;
          if (floodLight) floodLight.color.set(lightColor);
          picker.style.display = 'none';
        };
        picker.appendChild(b);
      });
      colorBtn.style.backgroundColor = lightColor;
    }

    startStopEl.addEventListener('click', () => {
      isActive = !isActive;
      if (isActive) { startTimer(); startStopEl.style.color = '#888888'; startStopEl.style.textShadow = '0 0 10px rgba(136,136,136,.5)'; }
      else { stopTimer(); startStopEl.style.color = '#ff0000'; startStopEl.style.textShadow = '0 0 10px rgba(255,0,0,.8)'; }
    });
    resetEl.addEventListener('click', resetTimer);

    colorBtn.addEventListener('click', () => {
      picker.style.display = (picker.style.display === 'none') ? 'flex' : 'none';
    });

    pulsateBtn.addEventListener('click', () => {
      isPulsating = !isPulsating;
      pulsateBtn.textContent = isPulsating ? '◉' : '○';
      pulsateBtn.classList.toggle('active', isPulsating);
    });

    rotateBtn.addEventListener('click', () => {
      isRotating = !isRotating;
      rotateBtn.classList.toggle('active', isRotating);
    });

    // ---------------- Boot ----------------
    updateTimerDisplay();
    buildColorPicker();
    initThree();
  </script>
</body>
</html>
