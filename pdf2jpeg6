<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KETADATA // PDF → JPG (UNBREAKABLE)</title>
  <style>
    :root{
      --bg:#fff; --fg:#000;
      --muted:rgba(0,0,0,.60);
      --line:rgba(0,0,0,.14);
      --line2:rgba(0,0,0,.08);
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --sans: Arial,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,sans-serif;
      --r:12px; --pad:16px;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:var(--sans)}
    header{
      position:sticky;top:0;z-index:10;
      background:rgba(255,255,255,.94);backdrop-filter:blur(8px);
      border-bottom:1px solid var(--line);
      padding:14px var(--pad);
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    .brand .k{font-weight:700;font-size:14px;letter-spacing:1.4px}
    .brand .s{font-family:var(--mono);font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{
      appearance:none;border:1px solid var(--fg);background:transparent;color:var(--fg);
      padding:9px 12px;border-radius:999px;font-size:12px;font-family:var(--mono);
      cursor:pointer;transition:.12s;user-select:none;
    }
    .btn:hover{background:var(--fg);color:var(--bg)}
    .btn.secondary{border-color:var(--line)}
    .btn.secondary:hover{background:rgba(0,0,0,.06);color:var(--fg);border-color:rgba(0,0,0,.22)}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    main{display:grid;grid-template-columns: 1fr 380px;min-height:calc(100vh - 56px)}
    @media (max-width:980px){main{grid-template-columns: 1fr}}
    .left{padding:var(--pad);border-right:1px solid var(--line);min-width:0}
    .right{padding:var(--pad);min-width:0}
    @media (max-width:980px){.left{border-right:none;border-bottom:1px solid var(--line)}}
    .card{border:1px solid var(--line);border-radius:var(--r);background:#fff;overflow:hidden}
    .card h3{
      margin:0;padding:12px;border-bottom:1px solid var(--line2);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      font-family:var(--mono);font-size:12px;letter-spacing:.7px;text-transform:uppercase;
    }
    .card .c{padding:12px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .mono{font-family:var(--mono)}
    .small{font-family:var(--mono);font-size:11px;color:var(--muted);line-height:1.35}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-family:var(--mono);font-size:12px;color:#000;background:#fff}
    input[type="file"]{font-family:var(--mono)}
    select,input[type="number"],input[type="text"]{
      width:100%;
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px;
      font-family:var(--mono);
      font-size:12px;
      background:#fff;color:#000;
    }
    .grid{display:grid;grid-template-columns: 1fr 1fr;gap:10px}
    @media (max-width:640px){.grid{grid-template-columns:1fr}}
    .sliderWrap{display:flex;gap:10px;align-items:center}
    input[type="range"]{width:100%}
    .bar{
      height:10px;border-radius:999px;border:1px solid var(--line);
      overflow:hidden;background:#fff;
    }
    .bar > div{height:100%;width:0%;background:#000}
    .preview{
      border:1px solid var(--line);
      border-radius:var(--r);
      background:#fff;
      overflow:hidden;
      box-shadow:var(--shadow);
    }
    .previewTop{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      padding:10px;border-bottom:1px solid var(--line2);
      font-family:var(--mono);font-size:12px;
    }
    .stage{
      width:100%;
      aspect-ratio: 16/10;
      display:grid;place-items:center;
      background:#fff;
      position:relative;
    }
    canvas{max-width:100%;max-height:100%}
    textarea{
      width:100%;
      min-height:160px;
      resize:vertical;
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px;
      font-family:var(--mono);
      font-size:12px;
      line-height:1.35;
      background:#fff;color:#000;
    }
    .err{
      border:1px solid rgba(0,0,0,.25);
      border-radius:var(--r);
      padding:12px;
      font-family:var(--mono);
      font-size:12px;
      white-space:pre-wrap;
      background:#fff;
    }
    .kbd{
      font-family:var(--mono);
      border:1px solid var(--line);
      border-bottom-width:2px;
      border-radius:6px;
      padding:2px 6px;
      background:#fff;color:#000;font-size:11px
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="k">KETADATA</div>
      <div class="s">PDF → JPG // LOCAL-FIRST // SEQUENTIAL // ZIP OUT // NORMAL OR INVERT</div>
    </div>
    <div class="actions">
      <button class="btn secondary" id="clearBtn">CLEAR</button>
      <button class="btn" id="convertBtn" disabled>CONVERT → ZIP</button>
    </div>
  </header>

  <main>
    <section class="left">
      <div class="card">
        <h3><span>INPUT</span><span class="small">no upload</span></h3>
        <div class="c">
          <div class="row">
            <input id="pdfInput" type="file" accept="application/pdf" />
            <span class="pill"><strong id="pdfName">—</strong></span>
          </div>
          <div style="height:10px"></div>
          <div class="row">
            <span class="pill"><strong id="pagesPill">0</strong> pages</span>
            <span class="pill"><strong id="statusPill">BOOT</strong></span>
          </div>
          <div style="height:12px"></div>
          <div class="bar"><div id="barFill"></div></div>
          <div style="height:8px"></div>
          <div class="small" id="progressTxt">Waiting.</div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <h3><span>OUTPUT CONTROLS</span><span class="small">stability first</span></h3>
        <div class="c">
          <div class="grid">
            <div>
              <div class="small">FORMAT</div>
              <select id="fmt">
                <option value="jpeg">JPEG (.jpg)</option>
                <option value="png">PNG (.png)</option>
              </select>
            </div>
            <div>
              <div class="small">OUTPUT MODE</div>
              <select id="invertMode">
                <option value="invert">INVERT (black page / white writing)</option>
                <option value="normal">NORMAL</option>
              </select>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="grid">
            <div>
              <div class="small">RENDER SCALE (1.0–2.5)</div>
              <div class="sliderWrap">
                <input id="scale" type="range" min="1" max="2.5" step="0.1" value="2" />
                <span class="pill"><strong id="scaleV">2.0</strong>x</span>
              </div>
              <div class="small">If memory spikes, drop to 1.5.</div>
            </div>
            <div>
              <div class="small">JPEG QUALITY (0.5–1.0)</div>
              <div class="sliderWrap">
                <input id="quality" type="range" min="0.5" max="1" step="0.05" value="0.9" />
                <span class="pill"><strong id="qualityV">0.90</strong></span>
              </div>
              <div class="small">PNG ignores quality.</div>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="grid">
            <div>
              <div class="small">PAGE RANGE</div>
              <select id="rangeMode">
                <option value="all">ALL PAGES</option>
                <option value="custom">CUSTOM (start/end)</option>
              </select>
            </div>
            <div>
              <div class="small">FOLDER NAMING</div>
              <select id="folderMode">
                <option value="perpdf">Folder per PDF</option>
                <option value="flat">Flat (no folder)</option>
              </select>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="grid" id="customRange" style="display:none">
            <div>
              <div class="small">START PAGE (1-indexed)</div>
              <input id="startPage" type="number" min="1" value="1" />
            </div>
            <div>
              <div class="small">END PAGE</div>
              <input id="endPage" type="number" min="1" value="1" />
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="grid">
            <div>
              <div class="small">ZIP NAME</div>
              <input id="zipName" type="text" value="pdf_to_images.zip" />
            </div>
            <div class="small">
              Keys: <span class="kbd">←</span><span class="kbd">→</span> preview page,
              <span class="kbd">C</span> convert
            </div>
          </div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="preview">
        <div class="previewTop">
          <span class="mono">PREVIEW</span>
          <span class="pill"><strong id="prevIdx">0</strong>/<span id="prevMax">0</span></span>
        </div>
        <div class="stage" id="stage">
          <div class="small mono" id="prevEmpty">Load a PDF.</div>
        </div>
      </div>
    </section>

    <section class="right">
      <div class="card">
        <h3><span>KETA NOTE</span><span class="small">page-level</span></h3>
        <div class="c">
          <textarea id="kNote" placeholder="SYSTEM NOTE // decisions, constraints, next actions"></textarea>
          <div style="height:10px"></div>
          <div class="row">
            <button class="btn secondary" id="exportNoteBtn">EXPORT NOTE JSON</button>
          </div>
          <div style="height:10px"></div>
          <div class="small" id="metaTxt">META: —</div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <h3><span>DIAGNOSTICS</span><span class="small">real errors only</span></h3>
        <div class="c">
          <div class="err" id="err">Booting…</div>
          <div style="height:10px"></div>
          <div class="small">
            If this page cannot load PDF.js, your browser/network is blocking scripts.
            This build tries local vendor first, then CDN fallbacks.
          </div>
        </div>
      </div>
    </section>
  </main>

<script>
/**
 * KETADATA PDF → IMAGE (UNBREAKABLE)
 * Strategy:
 *  1) Load JSZip (local vendor → CDN fallback)
 *  2) Load PDF.js LEGACY UMD build (local vendor → CDN fallback)
 *  3) Rasterize sequentially (one page at a time) to keep memory stable
 *  4) Add each image to zip as Blob/Uint8
 */

const ui = {
  pdfInput: document.getElementById("pdfInput"),
  pdfName: document.getElementById("pdfName"),
  pagesPill: document.getElementById("pagesPill"),
  statusPill: document.getElementById("statusPill"),
  barFill: document.getElementById("barFill"),
  progressTxt: document.getElementById("progressTxt"),
  convertBtn: document.getElementById("convertBtn"),
  clearBtn: document.getElementById("clearBtn"),

  fmt: document.getElementById("fmt"),
  invertMode: document.getElementById("invertMode"),
  scale: document.getElementById("scale"),
  scaleV: document.getElementById("scaleV"),
  quality: document.getElementById("quality"),
  qualityV: document.getElementById("qualityV"),
  rangeMode: document.getElementById("rangeMode"),
  folderMode: document.getElementById("folderMode"),
  customRange: document.getElementById("customRange"),
  startPage: document.getElementById("startPage"),
  endPage: document.getElementById("endPage"),
  zipName: document.getElementById("zipName"),

  stage: document.getElementById("stage"),
  prevEmpty: document.getElementById("prevEmpty"),
  prevIdx: document.getElementById("prevIdx"),
  prevMax: document.getElementById("prevMax"),

  kNote: document.getElementById("kNote"),
  exportNoteBtn: document.getElementById("exportNoteBtn"),
  metaTxt: document.getElementById("metaTxt"),

  err: document.getElementById("err"),
};

let PDFJS = null;     // pdfjsLib
let JSZipLib = null;  // JSZip
let pdfDoc = null;
let pdfFile = null;
let previewPage = 1;

function setErr(msg){
  ui.err.textContent = String(msg || "");
}
function log(msg){
  ui.err.textContent = (ui.err.textContent === "Booting…" ? "" : ui.err.textContent + "\n") + msg;
}
function setStatus(s){ ui.statusPill.textContent = s; }
function setProgress(p, msg){
  const pct = Math.max(0, Math.min(100, p));
  ui.barFill.style.width = pct + "%";
  ui.progressTxt.textContent = msg || "";
}
function meta(){
  const payload = {
    page:"KETADATA_PDF_TO_IMAGE_UNBREAKABLE",
    room:"STUDIO/TOOLS",
    timestamp:new Date().toISOString(),
    file: pdfFile ? { name: pdfFile.name, size: pdfFile.size } : null,
    settings:{
      format: ui.fmt.value,
      output: ui.invertMode.value,
      scale: Number(ui.scale.value),
      quality: Number(ui.quality.value),
      range: ui.rangeMode.value === "custom"
        ? { start: Number(ui.startPage.value), end: Number(ui.endPage.value) }
        : "all"
    }
  };
  ui.metaTxt.textContent = "META: " + JSON.stringify(payload);
  return payload;
}

function downloadBlob(blob, filename){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 4000);
}

function loadScript(src){
  return new Promise((resolve, reject) => {
    const s = document.createElement("script");
    s.src = src;
    s.async = true;
    s.onload = () => resolve(src);
    s.onerror = () => reject(new Error("Failed to load: " + src));
    document.head.appendChild(s);
  });
}

async function loadFirstWorking(label, sources, validateFn){
  for (const src of sources){
    try{
      log(`[LOAD] ${label}: ${src}`);
      await loadScript(src);
      const ok = await validateFn();
      if(ok){
        log(`[OK] ${label}: ${src}`);
        return src;
      } else {
        log(`[WARN] ${label} loaded but did not validate: ${src}`);
      }
    } catch(e){
      log(`[FAIL] ${label}: ${src}`);
    }
  }
  throw new Error(`All sources failed for ${label}.`);
}

async function boot(){
  setErr("Booting…");
  setStatus("BOOT");
  setProgress(0, "Loading libraries…");

  // 1) JSZip sources
  const jszipSources = [
    "/vendor/jszip.min.js",
    "https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js",
    "https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"
  ];

  await loadFirstWorking("JSZip", jszipSources, async () => typeof window.JSZip === "function");
  JSZipLib = window.JSZip;

  // 2) PDF.js LEGACY UMD sources (this is the important part)
  // Legacy build guarantees window.pdfjsLib
  const pdfSources = [
    "/vendor/pdfjs/pdf.min.js",
    "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/legacy/build/pdf.min.js",
    "https://unpkg.com/pdfjs-dist@4.10.38/legacy/build/pdf.min.js"
  ];

  const workerSources = [
    "/vendor/pdfjs/pdf.worker.min.js",
    "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/legacy/build/pdf.worker.min.js",
    "https://unpkg.com/pdfjs-dist@4.10.38/legacy/build/pdf/pdf.worker.min.js" // extra fallback
  ];

  await loadFirstWorking("PDF.js", pdfSources, async () => !!window.pdfjsLib);

  PDFJS = window.pdfjsLib;

  // Worker: we set to first source that actually loads (not perfect to validate, but good enough)
  // We test by attempting a fetch HEAD-ish via <script> load is not applicable for worker, so we just pick first reachable URL.
  let workerURL = null;
  for (const w of workerSources){
    try{
      // Use fetch to test existence; if blocked, move on
      const r = await fetch(w, { method:"GET", cache:"no-store" });
      if(r.ok){
        workerURL = w;
        log(`[OK] Worker: ${w}`);
        break;
      } else {
        log(`[WARN] Worker not ok (${r.status}): ${w}`);
      }
    } catch(e){
      log(`[FAIL] Worker fetch: ${w}`);
    }
  }
  if(!workerURL) throw new Error("Could not resolve PDF.js worker URL.");

  PDFJS.GlobalWorkerOptions.workerSrc = workerURL;

  setStatus("READY");
  setProgress(0, "Ready. Load a PDF.");
  ui.convertBtn.disabled = true;
  meta();
}

ui.scale.addEventListener("input", () => { ui.scaleV.textContent = Number(ui.scale.value).toFixed(1); meta(); });
ui.quality.addEventListener("input", () => { ui.qualityV.textContent = Number(ui.quality.value).toFixed(2); meta(); });
ui.rangeMode.addEventListener("change", () => {
  ui.customRange.style.display = ui.rangeMode.value === "custom" ? "grid" : "none";
  meta();
});
["fmt","invertMode","folderMode","zipName"].forEach(id => {
  document.getElementById(id).addEventListener("change", meta);
});

async function loadPDF(file){
  pdfFile = file;
  ui.pdfName.textContent = file ? file.name : "—";
  ui.pagesPill.textContent = "0";
  ui.prevIdx.textContent = "0";
  ui.prevMax.textContent = "0";
  ui.convertBtn.disabled = true;
  ui.stage.innerHTML = `<div class="small mono" id="prevEmpty">Loading…</div>`;
  setProgress(0, "Reading file…");

  const url = URL.createObjectURL(file);
  try{
    setStatus("LOADING");
    setProgress(10, "Opening PDF…");

    // Important: keep it simple. No worker hacks beyond proper workerSrc.
    const task = PDFJS.getDocument({ url });
    pdfDoc = await task.promise;

    const n = pdfDoc.numPages;
    ui.pagesPill.textContent = String(n);
    ui.prevMax.textContent = String(n);

    // range defaults
    ui.startPage.value = "1";
    ui.endPage.value = String(n);

    previewPage = 1;
    await renderPreview(previewPage);

    setStatus("READY");
    setProgress(0, "Ready. Click CONVERT → ZIP.");
    ui.convertBtn.disabled = false;
    meta();
  } finally {
    URL.revokeObjectURL(url);
  }
}

function invertCanvasPixels(ctx, w, h){
  const img = ctx.getImageData(0,0,w,h);
  const d = img.data;
  for(let i=0;i<d.length;i+=4){
    d[i]   = 255 - d[i];
    d[i+1] = 255 - d[i+1];
    d[i+2] = 255 - d[i+2];
  }
  ctx.putImageData(img,0,0);
}

async function renderPreview(pageNum){
  if(!pdfDoc) return;
  pageNum = Math.max(1, Math.min(pdfDoc.numPages, pageNum));
  previewPage = pageNum;
  ui.prevIdx.textContent = String(pageNum);

  const page = await pdfDoc.getPage(pageNum);
  const scale = Number(ui.scale.value);
  const viewport = page.getViewport({ scale });

  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d", { willReadFrequently: ui.invertMode.value === "invert" });

  canvas.width = Math.floor(viewport.width);
  canvas.height = Math.floor(viewport.height);

  ui.stage.innerHTML = "";
  ui.stage.appendChild(canvas);

  await page.render({ canvasContext: ctx, viewport }).promise;

  if(ui.invertMode.value === "invert"){
    invertCanvasPixels(ctx, canvas.width, canvas.height);
  }
}

function canvasToBlob(canvas){
  const fmt = ui.fmt.value;
  const q = Number(ui.quality.value);
  return new Promise((resolve) => {
    if(fmt === "jpeg"){
      canvas.toBlob(b => resolve(b), "image/jpeg", q);
    } else {
      canvas.toBlob(b => resolve(b), "image/png");
    }
  });
}

function safeBaseName(name){
  return name.replace(/\.pdf$/i,"").replace(/[^\w\-]+/g,"_").slice(0,90) || "PDF";
}

async function convertToZip(){
  if(!pdfDoc || !pdfFile) return;

  const total = pdfDoc.numPages;

  let start = 1, end = total;
  if(ui.rangeMode.value === "custom"){
    start = Math.max(1, Math.min(total, Number(ui.startPage.value)||1));
    end = Math.max(start, Math.min(total, Number(ui.endPage.value)||start));
  }

  const fmt = ui.fmt.value;
  const ext = (fmt === "jpeg") ? "jpg" : "png";
  const scale = Number(ui.scale.value);

  // Zip
  const zip = new JSZipLib();
  const base = safeBaseName(pdfFile.name);
  const folder = (ui.folderMode.value === "perpdf") ? zip.folder(base) : zip;

  setStatus("CONVERT");
  ui.convertBtn.disabled = true;
  setProgress(0, `Converting pages ${start}–${end}…`);

  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d", { willReadFrequently: ui.invertMode.value === "invert" });

  try{
    const count = (end - start + 1);
    for(let i=0;i<count;i++){
      const pageNum = start + i;

      const pct = Math.round((i / count) * 100);
      setProgress(pct, `Rendering page ${pageNum}/${end}…`);

      const page = await pdfDoc.getPage(pageNum);
      const viewport = page.getViewport({ scale });
      canvas.width = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);

      // Render
      await page.render({ canvasContext: ctx, viewport }).promise;

      // Invert (if requested)
      if(ui.invertMode.value === "invert"){
        invertCanvasPixels(ctx, canvas.width, canvas.height);
      }

      // Preview update occasionally
      if(i === 0 || i % 10 === 0) {
        previewPage = pageNum;
        ui.prevIdx.textContent = String(pageNum);
      }

      // Encode
      setProgress(pct, `Encoding page ${pageNum}/${end}…`);
      const blob = await canvasToBlob(canvas);

      const fname = `${base}_page_${String(pageNum).padStart(3,"0")}.${ext}`;
      folder.file(fname, blob);

      // Yield to UI (keeps browser responsive)
      await new Promise(r => setTimeout(r, 0));
    }

    setProgress(98, "Building ZIP…");
    const out = await zip.generateAsync({ type:"blob", compression:"DEFLATE", compressionOptions:{ level: 6 } });

    setProgress(100, "Done.");
    setStatus("DONE");
    downloadBlob(out, ui.zipName.value || `${base}.zip`);
  } catch(e){
    setStatus("ERROR");
    setErr(e.stack || e.message || String(e));
  } finally {
    ui.convertBtn.disabled = false;
    meta();
  }
}

// Events
ui.pdfInput.addEventListener("change", async (e) => {
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  try{
    await loadPDF(f);
  } catch(err){
    setStatus("ERROR");
    setErr(err.stack || err.message || String(err));
  }
});

ui.convertBtn.addEventListener("click", convertToZip);

ui.clearBtn.addEventListener("click", async () => {
  pdfDoc = null; pdfFile = null; previewPage = 1;
  ui.pdfInput.value = "";
  ui.pdfName.textContent = "—";
  ui.pagesPill.textContent = "0";
  ui.prevIdx.textContent = "0";
  ui.prevMax.textContent = "0";
  ui.stage.innerHTML = `<div class="small mono" id="prevEmpty">Load a PDF.</div>`;
  ui.convertBtn.disabled = true;
  setStatus("READY");
  setProgress(0, "Cleared. Load a PDF.");
  meta();
});

// Preview nav keys
document.addEventListener("keydown", async (e) => {
  const t = e.target;
  if(t && (t.tagName === "TEXTAREA" || t.tagName === "INPUT" || t.tagName === "SELECT")) return;
  if(!pdfDoc) return;

  if(e.key === "ArrowLeft"){ e.preventDefault(); await renderPreview(previewPage - 1); }
  if(e.key === "ArrowRight"){ e.preventDefault(); await renderPreview(previewPage + 1); }
  if(e.key.toLowerCase() === "c"){ e.preventDefault(); await convertToZip(); }
});

// Note export
ui.exportNoteBtn.addEventListener("click", () => {
  const payload = {
    id: "note_" + Date.now(),
    room: "STUDIO/TOOLS",
    page: "KETADATA_PDF_TO_IMAGE_UNBREAKABLE",
    timestamp: new Date().toISOString(),
    meta: meta(),
    note: ui.kNote.value || ""
  };
  downloadBlob(new Blob([JSON.stringify(payload,null,2)], {type:"application/json"}), `KETA_NOTE_PDF_TO_IMAGE_${Date.now()}.json`);
});

// Boot
(async () => {
  try{
    ui.scaleV.textContent = Number(ui.scale.value).toFixed(1);
    ui.qualityV.textContent = Number(ui.quality.value).toFixed(2);
    await boot();
    setErr("OK.\nPDF.js + JSZip loaded.");
  } catch(e){
    setStatus("BLOCKED");
    setErr("BOOT FAILED.\n\n" + (e.stack || e.message || String(e)) + "\n\n" +
      "If you are blocking CDNs, you MUST provide /vendor/pdfjs/pdf.min.js and /vendor/pdfjs/pdf.worker.min.js.\n" +
      "Use pdfjs-dist legacy build (UMD), not module build."
    );
  }
})();
</script>
</body>
</html>
