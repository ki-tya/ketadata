<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>KETADATA // MONTHLY CALENDAR (V2)</title>

<!-- =========================================================
AE ▸ AESTHETIC ▸ BLACK / SHARP / SQUARE GRID / CENTERED
========================================================= -->
<style>
:root{
  --bg:#000; --fg:#fff; --muted:#777; --line:#222;
  --invert:0;
  --cell:132px;             /* square size */
  --gap:8px;
  --maxW: calc((var(--cell) * 7) + (var(--gap) * 6));
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  background:var(--bg);
  color:var(--fg);
  font-family: Arial, system-ui;
  filter: invert(var(--invert));
  overflow:hidden;
}

header{
  height:48px;
  border-bottom:1px solid var(--line);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 10px;
}
header .left{display:flex; gap:10px; align-items:center}
header .right{display:flex; gap:8px; align-items:center}

button,input,select,textarea{
  background:#000; color:#fff; border:1px solid var(--line);
  padding:6px 8px; font-family:inherit;
}
button:hover{background:#111; cursor:pointer}

.keta-icon{
  width:14px; height:14px; border:2px solid #fff;
}
.keta-icon.filled{background:#fff}

main{
  height:calc(100% - 48px);
  display:grid;
  grid-template-rows:auto 1fr auto; /* controls, calendar, bottom */
}

.controls{
  padding:10px;
  border-bottom:1px solid var(--line);
  display:flex; gap:10px; flex-wrap:wrap;
  align-items:center;
}
.controls .spacer{flex:1}

.canvasWrap{
  overflow:auto;
  padding:16px 0;
}
.calendar{
  width:var(--maxW);
  margin:0 auto;                 /* centered */
  display:grid;
  grid-template-columns:repeat(7, var(--cell));
  grid-auto-rows:var(--cell);    /* squares */
  gap:var(--gap);
}

.cell{
  border:1px solid var(--line);
  padding:8px;
  display:flex;
  flex-direction:column;
  position:relative;
}
.cell.pad{opacity:.15}
.cell .daynum{
  position:absolute;
  top:6px; left:6px;
  font-size:11px;
  color:var(--muted);
}
.cell .label{
  margin-top:18px;
  font-size:11px;
  color:var(--muted);
}
.cell textarea{
  margin-top:8px;
  flex:1;
  width:100%;
  resize:none;
  border:1px solid var(--line);
  padding:6px;
  outline:none;
  background:#000;
  color:#fff;
}

.weekMode .calendar{
  grid-template-columns:repeat(7, var(--cell));
}
.weekMode .cell{
  display:none;
}
.weekMode .cell.inWeek{
  display:flex;
}

.bottom{
  border-top:1px solid var(--line);
  padding:8px 10px;
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:space-between;
}
.bottom .hint{color:var(--muted); font-size:12px}
.bottom textarea{
  width:100%;
  height:64px;
  border:1px solid var(--line);
  resize:vertical;
}

/* KETA NOTE (movable) */
#ketaNote{
  position:fixed; top:70px; right:20px;
  width:320px; height:220px;
  background:#fff; color:#000;
  border:1px solid #000;
  display:none;
  z-index:50;
}
#ketaNote header{
  height:28px;
  background:#000; color:#fff;
  padding:4px 6px;
  cursor:move;
  display:flex; justify-content:space-between; align-items:center;
  border-bottom:1px solid #000;
}
#ketaNote textarea{
  width:100%;
  height:calc(100% - 28px);
  border:none;
  resize:none;
  padding:8px;
  font-family:inherit;
  outline:none;
}
.small{font-size:12px;color:var(--muted)}
</style>
</head>

<body>

<!-- =========================================================
WB ▸ TOP BAR ▸ GLOBAL ACCESS + STATE IO + NOTE ICON
========================================================= -->
<header>
  <div class="left">
    <strong>KETADATA</strong>
    <span class="small">MONTHLY CALENDAR</span>
  </div>

  <div class="right">
    <button id="btnImport" title="Import state JSON">IMPORT</button>
    <button id="btnExport" title="Export state JSON">EXPORT</button>
    <button id="toggleView" title="Toggle month/week">MONTH / WEEK</button>
    <div id="ketaIcon" class="keta-icon filled" title="KETA NOTE"></div>
    <input id="fileState" type="file" accept="application/json" style="display:none">
  </div>
</header>

<main>

<!-- =========================================================
EE ▸ INPUTS ▸ MINIMAL (Month / Days / First Weekday)
========================================================= -->
<div class="controls">
  <label>Month
    <input id="monthName" placeholder="DECEMBER" style="width:160px">
  </label>

  <label>Days
    <input id="daysInMonth" type="number" min="28" max="31" value="30" style="width:80px">
  </label>

  <label>1st weekday
    <select id="firstWeekday">
      <option value="0">Sun</option><option value="1">Mon</option>
      <option value="2">Tue</option><option value="3">Wed</option>
      <option value="4">Thu</option><option value="5">Fri</option>
      <option value="6">Sat</option>
    </select>
  </label>

  <button id="build">BUILD</button>

  <div class="spacer"></div>
  <span class="small">Shift+I invert • Ctrl/Cmd+S export • Ctrl/Cmd+O import</span>
</div>

<!-- =========================================================
EE ▸ CALENDAR (CENTERED SQUARE GRID)
========================================================= -->
<div class="canvasWrap">
  <div id="calendar" class="calendar" aria-label="calendar grid"></div>
</div>

<!-- =========================================================
WB ▸ SYSTEM PANEL (ALWAYS PRESENT) ▸ exports with state
========================================================= -->
<div class="bottom">
  <div style="min-width:240px">
    <div class="hint">SYSTEM RULES / REFERENCES (exports with state)</div>
  </div>
  <textarea id="systemRules" placeholder="laws / constraints / references // no page without state + keta_note"></textarea>
</div>

</main>

<!-- =========================================================
EE ▸ KETA NOTE (MENTAL ATOM) ▸ movable
========================================================= -->
<div id="ketaNote">
  <header>
    <span>KETA NOTE</span>
    <div style="display:flex; gap:6px;">
      <button id="closeNote" title="close">×</button>
    </div>
  </header>
  <textarea id="ketaNoteText" placeholder="decisions / deviations / next actions"></textarea>
</div>

<!-- =========================================================
EE/WB ▸ ENGINE + STATE
========================================================= -->
<script>
/* =========================================================
EE ▸ STATE MODEL (atomic, exportable)
========================================================= */
const STATE = {
  version: "ketadata-calendar-monthly-v2",
  createdAt: new Date().toISOString(),
  updatedAt: new Date().toISOString(),

  // calendar inputs
  monthName: "",
  daysInMonth: 30,
  firstWeekday: 1,
  isWeekView: false,
  selectedWeekIndex: 0, // for week mode

  // per-day notes
  days: {}, // { "1": { text:"" }, ... }

  // global notes
  ketaNote: "",
  systemRules: ""
};

/* =========================================================
WB ▸ DOM
========================================================= */
const el = {
  monthName: document.getElementById('monthName'),
  daysInMonth: document.getElementById('daysInMonth'),
  firstWeekday: document.getElementById('firstWeekday'),
  build: document.getElementById('build'),
  cal: document.getElementById('calendar'),
  toggleView: document.getElementById('toggleView'),
  systemRules: document.getElementById('systemRules'),

  ketaIcon: document.getElementById('ketaIcon'),
  ketaNote: document.getElementById('ketaNote'),
  ketaNoteText: document.getElementById('ketaNoteText'),
  closeNote: document.getElementById('closeNote'),

  btnExport: document.getElementById('btnExport'),
  btnImport: document.getElementById('btnImport'),
  fileState: document.getElementById('fileState')
};

/* =========================================================
EE ▸ RENDER
========================================================= */
function buildCalendar(){
  pullInputsToState();
  STATE.updatedAt = new Date().toISOString();

  el.cal.innerHTML = "";

  const days = clampInt(+STATE.daysInMonth, 28, 31);
  const start = clampInt(+STATE.firstWeekday, 0, 6);
  const month = (STATE.monthName || "").trim();

  // number of cells = pad + days, we let grid auto-wrap
  for(let i=0;i<start;i++){
    const pad = document.createElement('div');
    pad.className = 'cell pad';
    el.cal.appendChild(pad);
  }

  for(let d=1; d<=days; d++){
    const cell = document.createElement('div');
    cell.className = 'cell';
    cell.dataset.day = String(d);

    const num = document.createElement('div');
    num.className = 'daynum';
    num.textContent = d;

    const label = document.createElement('div');
    label.className = 'label';
    label.textContent = month ? `${month} ${d}` : `DAY ${d}`;

    const ta = document.createElement('textarea');
    ta.placeholder = "";
    ta.value = (STATE.days[String(d)] && STATE.days[String(d)].text) ? STATE.days[String(d)].text : "";
    ta.addEventListener('input', ()=>{
      STATE.days[String(d)] = STATE.days[String(d)] || {text:""};
      STATE.days[String(d)].text = ta.value;
      STATE.updatedAt = new Date().toISOString();
      persistLocal();
    });

    cell.appendChild(num);
    cell.appendChild(label);
    cell.appendChild(ta);

    // click selects week in week mode
    cell.addEventListener('click', (e)=>{
      if(!STATE.isWeekView) return;
      const idx = weekIndexForDay(d, start);
      STATE.selectedWeekIndex = idx;
      applyWeekFilter();
      STATE.updatedAt = new Date().toISOString();
      persistLocal();
    });

    el.cal.appendChild(cell);
  }

  applyWeekFilter();
  persistLocal();
}

function applyWeekFilter(){
  document.body.classList.toggle('weekMode', !!STATE.isWeekView);
  if(!STATE.isWeekView){
    // show all
    el.cal.querySelectorAll('.cell').forEach(c=>c.classList.remove('inWeek'));
    return;
  }
  const start = clampInt(+STATE.firstWeekday, 0, 6);
  const cells = Array.from(el.cal.querySelectorAll('.cell')).filter(c=>!c.classList.contains('pad'));
  const target = STATE.selectedWeekIndex || 0;

  // mark cells in that week
  cells.forEach(cell=>{
    const d = +cell.dataset.day;
    const idx = weekIndexForDay(d, start);
    cell.classList.toggle('inWeek', idx === target);
  });

  // also keep pads that belong to first week visible in week 0
  const pads = Array.from(el.cal.querySelectorAll('.cell.pad'));
  pads.forEach((p,i)=> p.classList.toggle('inWeek', target===0));
}

/* =========================================================
EE ▸ HELPERS
========================================================= */
function clampInt(n,min,max){
  n = Number.isFinite(n) ? Math.floor(n) : min;
  return Math.min(max, Math.max(min, n));
}
function weekIndexForDay(day, startWeekday){
  // day 1 sits at index startWeekday within week 0
  const offset = (startWeekday + (day-1));
  return Math.floor(offset / 7);
}

/* =========================================================
WB ▸ STATE IO (MANDATORY)
========================================================= */
function pullInputsToState(){
  STATE.monthName = (el.monthName.value || "").toUpperCase();
  STATE.daysInMonth = clampInt(+el.daysInMonth.value, 28, 31);
  STATE.firstWeekday = clampInt(+el.firstWeekday.value, 0, 6);
  STATE.ketaNote = el.ketaNoteText.value || "";
  STATE.systemRules = el.systemRules.value || "";
}
function pushStateToInputs(){
  el.monthName.value = STATE.monthName || "";
  el.daysInMonth.value = clampInt(+STATE.daysInMonth, 28, 31);
  el.firstWeekday.value = clampInt(+STATE.firstWeekday, 0, 6);
  el.ketaNoteText.value = STATE.ketaNote || "";
  el.systemRules.value = STATE.systemRules || "";
}

function exportState(){
  pullInputsToState();
  STATE.updatedAt = new Date().toISOString();
  const blob = new Blob([JSON.stringify(STATE, null, 2)], {type:"application/json"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  const safeMonth = (STATE.monthName || "month").toLowerCase().replace(/[^a-z0-9]+/g,'-');
  a.download = `ketadata_calendar_${safeMonth}.json`;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 500);
}

function importStateFromFile(file){
  const r = new FileReader();
  r.onload = ()=>{
    try{
      const data = JSON.parse(String(r.result||"{}"));
      if(!data || typeof data !== "object") throw new Error("bad json");
      // shallow merge with guardrails
      Object.assign(STATE, data);
      if(!STATE.days || typeof STATE.days !== "object") STATE.days = {};
      if(typeof STATE.isWeekView !== "boolean") STATE.isWeekView = false;
      if(!Number.isFinite(+STATE.selectedWeekIndex)) STATE.selectedWeekIndex = 0;

      pushStateToInputs();
      buildCalendar();
    }catch(err){
      alert("Import failed: " + (err && err.message ? err.message : "unknown"));
    }
  };
  r.readAsText(file);
}

function persistLocal(){
  // localStorage = guerilla, zero permission prompts
  try{
    const payload = JSON.stringify(STATE);
    localStorage.setItem("ketadata.calendar.monthly.v2", payload);
  }catch(e){}
}
function loadLocal(){
  try{
    const raw = localStorage.getItem("ketadata.calendar.monthly.v2");
    if(!raw) return false;
    const data = JSON.parse(raw);
    if(!data || typeof data !== "object") return false;
    Object.assign(STATE, data);
    if(!STATE.days || typeof STATE.days !== "object") STATE.days = {};
    return true;
  }catch(e){ return false; }
}

/* =========================================================
WB ▸ KETA NOTE ICON (filled when collapsed)
========================================================= */
function toggleNote(){
  const open = el.ketaNote.style.display === 'block';
  el.ketaNote.style.display = open ? 'none' : 'block';
  // icon rule: filled when collapsed; hollow when on screen
  el.ketaIcon.classList.toggle('filled', open);
  persistLocal();
}

/* =========================================================
WB ▸ DRAG NOTE
========================================================= */
(function dragNote(){
  const box = el.ketaNote;
  const bar = box.querySelector('header');
  let dragging=false, ox=0, oy=0;

  bar.addEventListener('mousedown', (e)=>{
    dragging=true;
    const r = box.getBoundingClientRect();
    ox = e.clientX - r.left;
    oy = e.clientY - r.top;
  });
  window.addEventListener('mousemove', (e)=>{
    if(!dragging) return;
    box.style.left = (e.clientX - ox) + "px";
    box.style.top  = (e.clientY - oy) + "px";
    box.style.right = "auto";
  });
  window.addEventListener('mouseup', ()=> dragging=false);
})();

/* =========================================================
WB ▸ HOTKEYS
========================================================= */
document.addEventListener('keydown', (e)=>{
  // Shift+I invert (safe while typing)
  if(e.shiftKey && e.key.toLowerCase()==='i'){
    const cur = getComputedStyle(document.documentElement).getPropertyValue('--invert').trim();
    document.documentElement.style.setProperty('--invert', cur==='1' ? 0 : 1);
  }
  // Ctrl/Cmd+S export
  if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='s'){
    e.preventDefault();
    exportState();
  }
  // Ctrl/Cmd+O import
  if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='o'){
    e.preventDefault();
    el.fileState.click();
  }
  // N toggle note
  if(!e.ctrlKey && !e.metaKey && !e.altKey && e.key.toLowerCase()==='n'){
    // ignore if typing into input/textarea
    const tag = (document.activeElement && document.activeElement.tagName) ? document.activeElement.tagName.toLowerCase() : "";
    if(tag === "textarea" || tag === "input") return;
    toggleNote();
  }
});

/* =========================================================
WB ▸ WIRES
========================================================= */
el.build.addEventListener('click', buildCalendar);

el.toggleView.addEventListener('click', ()=>{
  pullInputsToState();
  STATE.isWeekView = !STATE.isWeekView;
  // default: if entering week mode, go to week 0 unless a day was clicked
  if(!Number.isFinite(+STATE.selectedWeekIndex)) STATE.selectedWeekIndex = 0;
  applyWeekFilter();
  STATE.updatedAt = new Date().toISOString();
  persistLocal();
});

el.ketaIcon.addEventListener('click', toggleNote);
el.closeNote.addEventListener('click', toggleNote);

el.btnExport.addEventListener('click', exportState);
el.btnImport.addEventListener('click', ()=> el.fileState.click());
el.fileState.addEventListener('change', ()=>{
  const f = el.fileState.files && el.fileState.files[0];
  if(f) importStateFromFile(f);
  el.fileState.value = "";
});

el.ketaNoteText.addEventListener('input', ()=>{ pullInputsToState(); persistLocal(); });
el.systemRules.addEventListener('input', ()=>{ pullInputsToState(); persistLocal(); });

/* =========================================================
EE ▸ BOOT
========================================================= */
(function boot(){
  const hadLocal = loadLocal();
  pushStateToInputs();
  buildCalendar();
  // if local state had note open, keep it (we store presence implicitly by icon class)
  // default: note closed; icon filled
  if(hadLocal && (STATE.ketaNoteOpen===true)){
    // not used in this v2; left as future hook
  }
})();
</script>

</body>
</html>
