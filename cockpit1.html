<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>KETADATA // CASE BOARD (TIMELINE + NETWORK)</title>
<style>
:root{
  --bg:#000;
  --fg:rgba(255,255,255,.86);
  --muted:rgba(255,255,255,.52);
  --line:rgba(255,255,255,.14);
  --line2:rgba(255,255,255,.22);
  --panel:rgba(0,0,0,.92);
  --panel2:rgba(255,255,255,.03);
  --hit:rgba(255,255,255,.08);

  --top:44px;
  --right:320px;
  --bottom:180px;

  --font: 12px;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  --sans: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

  --zoomMin: .25;
  --zoomMax: 3.0;
}

*{ box-sizing:border-box; }
html,body{ height:100%; margin:0; background:var(--bg); color:var(--fg); overflow:hidden; }
body{ font-family: var(--sans); font-size: var(--font); }

#root{
  position:fixed; inset:0;
  background:var(--bg);
}

#root.invert{
  filter: invert(1) hue-rotate(180deg);
}

.topbar{
  position:fixed; left:0; right:0; top:0; height:var(--top);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 10px;
  border-bottom:1px solid var(--line);
  background:var(--panel);
  z-index:1000;
}
.brand{
  user-select:none;
  color:var(--muted);
  letter-spacing:1px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
button, input[type="text"], input[type="file"], textarea, select{
  background:var(--panel2);
  border:1px solid var(--line2);
  color:var(--fg);
  padding:7px 9px;
  border-radius:0;
  font-size: var(--font);
  outline:none;
  font-family: var(--sans);
}
button{ cursor:pointer; }
button:hover{ border-color:rgba(255,255,255,.34); }
button.ghost{ border-color:rgba(255,255,255,.10); color:rgba(255,255,255,.62); }
button.danger:hover{ border-color:rgba(255,140,140,.55); }

.shell{
  position:absolute;
  top:var(--top); left:0; right:0; bottom:0;
  display:grid;
  grid-template-columns: 1fr 6px var(--right);
  grid-template-rows: 1fr 6px var(--bottom);
  grid-template-areas:
    "stage v inspector"
    "stage v inspector"
    "timeline h inspector";
}
.resizer{
  background:rgba(255,255,255,.06);
  z-index:900;
}
.resizer:hover{ background:rgba(255,255,255,.10); }
.resizer.v{ grid-area:v; cursor:col-resize; }
.resizer.h{ grid-area:h; cursor:row-resize; }

.panel{
  background:var(--panel);
  border-left:1px solid var(--line);
  overflow:hidden;
  min-width:0; min-height:0;
}
#inspector{ grid-area:inspector; display:flex; flex-direction:column; }
#timelinePanel{ grid-area:timeline; border-top:1px solid var(--line); border-right:1px solid var(--line); }

.panelHead{
  height:36px;
  display:flex; align-items:center; justify-content:space-between;
  padding:0 10px;
  border-bottom:1px solid var(--line);
  user-select:none;
  color:var(--muted);
}
.panelHead .left{ display:flex; gap:8px; align-items:center; }
.panelHead .right{ display:flex; gap:8px; align-items:center; }
.panelBody{
  flex:1;
  min-height:0;
  overflow:auto;
  padding:10px;
}

.kv{
  display:grid;
  grid-template-columns: 92px 1fr;
  gap:8px;
  align-items:center;
}
.k{ color:rgba(255,255,255,.50); }
.v{ color:rgba(255,255,255,.86); }
.v input, .v textarea, .v select{ width:100%; }
.v textarea{
  height:120px;
  resize:vertical;
  font-family: var(--mono);
  line-height:1.25;
}

.row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.row .grow{ flex:1 1 auto; min-width:0; }

.small{ color:rgba(255,255,255,.52); }

#stage{
  grid-area:stage;
  position:relative;
  overflow:hidden;
  background:var(--bg);
  touch-action:none;
}
#viewport{
  position:absolute; inset:0;
  transform-origin:0 0;
}
#linkLayer{
  position:absolute; inset:0;
  pointer-events:auto;
}
#linkSvg{ width:100%; height:100%; display:block; }
.edge{ stroke: rgba(255,255,255,.18); stroke-width:1; }
.edge.selected{ stroke: rgba(255,255,255,.46); stroke-width:2; }
.edgeHit{ stroke: rgba(255,255,255,0); stroke-width:12; cursor:pointer; }
.edgeLabel{
  fill: rgba(255,255,255,.62);
  font-size: var(--font);
  font-family: var(--sans);
  user-select:none;
}

#board{
  position:absolute; inset:0;
}

.item{
  position:absolute;
  border:1px solid transparent;
  background:transparent;
  user-select:none;
  transform-origin:center center;
}
.item.selected{ border-color:rgba(255,255,255,.22); }
.item .card{
  width:100%; height:100%;
  background:rgba(255,255,255,.02);
  border:1px solid rgba(255,255,255,.10);
  overflow:hidden;
}
.item .head{
  height:26px;
  display:flex; align-items:center; justify-content:space-between;
  padding:0 8px;
  border-bottom:1px solid rgba(255,255,255,.08);
  background:rgba(0,0,0,.22);
  cursor:move;
  color:rgba(255,255,255,.68);
}
.item .head .tag{ opacity:.85; }
.item .head .meta{ opacity:.70; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:55%; }

.item .body{
  height:calc(100% - 26px);
  padding:8px;
}
.item .name{
  width:100%;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.18);
  color:rgba(255,255,255,.86);
  padding:6px 7px;
  outline:none;
  font-family: var(--sans);
  font-size: var(--font);
}
.item .note{
  margin-top:8px;
  width:100%;
  height:calc(100% - 34px);
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.18);
  color:rgba(255,255,255,.86);
  padding:7px;
  outline:none;
  resize:none;
  font-family: var(--mono);
  font-size: var(--font);
  line-height:1.25;
}
.item img{
  width:100%; height:100%;
  object-fit:contain;
  display:block;
  pointer-events:none;
  background:#000;
}
.item .caption{
  position:absolute;
  left:0; right:0; bottom:0;
  padding:6px 8px;
  border-top:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.72);
  color:rgba(255,255,255,.70);
  font-family: var(--sans);
  font-size: var(--font);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.handle{
  position:absolute;
  width:16px; height:16px;
  border:1px solid rgba(255,255,255,.40);
  background:rgba(0,0,0,.80);
}
.h-nw{ left:-9px; top:-9px; cursor:nwse-resize; }
.h-ne{ right:-9px; top:-9px; cursor:nesw-resize; }
.h-sw{ left:-9px; bottom:-9px; cursor:nesw-resize; }
.h-se{ right:-9px; bottom:-9px; cursor:nwse-resize; }
.rot{
  position:absolute; left:50%; top:-30px; transform:translateX(-50%);
  width:16px; height:16px;
  border-radius:50%;
  border:1px solid rgba(255,255,255,.40);
  background:rgba(0,0,0,.82);
  cursor:grab;
}

.timelineList{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.tRow{
  display:grid;
  grid-template-columns: 84px 1fr 64px;
  gap:8px;
  padding:6px 8px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.02);
  cursor:pointer;
}
.tRow:hover{ border-color:rgba(255,255,255,.24); }
.tDate{ color:rgba(255,255,255,.70); font-family:var(--mono); }
.tTitle{ color:rgba(255,255,255,.86); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.tType{ color:rgba(255,255,255,.52); text-align:right; }

#toast{
  position:fixed;
  left:50%;
  bottom:12px;
  transform:translateX(-50%);
  padding:7px 9px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(0,0,0,.92);
  color:rgba(255,255,255,.72);
  display:none;
  z-index:2000;
}
#toast.show{ display:block; }

@media (max-width: 980px){
  .shell{
    grid-template-columns: 1fr;
    grid-template-rows: 1fr 6px var(--bottom);
    grid-template-areas:
      "stage"
      "h"
      "timeline";
  }
  #inspector, .resizer.v{ display:none; }
  #timelinePanel{ border-right:none; }
}
</style>
</head>
<body>
<div id="root">
  <div class="topbar">
    <div class="brand">KETADATA // CASE BOARD</div>
    <div class="actions">
      <button id="addPerson" class="ghost">Add Person</button>
      <button id="addEvent" class="ghost">Add Event</button>
      <button id="addNote" class="ghost">Add Note</button>
      <label style="display:inline-flex;gap:8px;align-items:center;">
        <input id="imgInput" type="file" accept="image/*" multiple style="width:220px;"/>
      </label>
      <button id="linkMode" class="ghost">Link: Off</button>
      <button id="toggleLinks" class="ghost">Links: On</button>
      <button id="invertBtn" class="ghost">Invert</button>
      <button id="exportJson" class="ghost">Export .json</button>
      <label style="display:inline-flex;gap:8px;align-items:center;">
        <input id="importJsonFile" type="file" accept="application/json" style="width:170px;"/>
      </label>
      <button id="saveLocal" class="ghost">Save Local</button>
      <button id="loadLocal" class="ghost">Load Local</button>
      <button id="clearAll" class="ghost danger">Clear</button>
    </div>
  </div>

  <div class="shell" id="shell">
    <div id="stage">
      <div id="viewport">
        <div id="linkLayer"><svg id="linkSvg" xmlns="http://www.w3.org/2000/svg"></svg></div>
        <div id="board"></div>
      </div>
    </div>

    <div class="resizer v" id="resV"></div>

    <aside class="panel" id="inspector">
      <div class="panelHead">
        <div class="left">Inspector</div>
        <div class="right"><button id="collapseInspector" class="ghost">–</button></div>
      </div>
      <div class="panelBody">
        <div class="group">
          <div class="kv">
            <div class="k">Selection</div><div class="v" id="selSummary">—</div>
            <div class="k">Label</div><div class="v"><input id="selLabel" type="text" disabled/></div>
            <div class="k">Type</div>
            <div class="v">
              <select id="selType" disabled>
                <option value="person">person</option>
                <option value="event">event</option>
                <option value="note">note</option>
                <option value="evidence">evidence</option>
              </select>
            </div>
            <div class="k">Date</div><div class="v"><input id="selDate" type="text" placeholder="YYYY-MM-DD" disabled/></div>
            <div class="k">Opacity</div>
            <div class="v">
              <input id="selOpacity" type="range" min="10" max="100" step="1" value="100" disabled/>
            </div>
          </div>
          <div style="height:10px"></div>
          <div class="row">
            <button id="bringFront" class="ghost" disabled>Front</button>
            <button id="sendBack" class="ghost" disabled>Back</button>
            <button id="deleteSel" class="ghost danger" disabled>Delete</button>
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="group">
          <div class="row">
            <input id="edgeLabel" class="grow" type="text" placeholder="edge label" disabled/>
            <button id="deleteEdge" class="ghost danger" disabled>Delete Edge</button>
          </div>
          <div style="height:8px"></div>
          <textarea id="edgeNote" placeholder="edge note" disabled></textarea>
        </div>

        <div style="height:10px"></div>
        <div class="small">
          Space = pan. Wheel = zoom. Delete = remove selection. Esc = cancel link selection. Shift+I = invert.
        </div>
      </div>
    </aside>

    <div class="resizer h" id="resH"></div>

    <section class="panel" id="timelinePanel">
      <div class="panelHead">
        <div class="left">Timeline</div>
        <div class="right"><button id="collapseTimeline" class="ghost">–</button></div>
      </div>
      <div class="panelBody">
        <div id="timelineList" class="timelineList"></div>
      </div>
    </section>
  </div>

  <div id="toast"></div>
</div>

<script>
(() => {
  const FILE_ID = "KETADATA_CASE_BOARD_v1";
  const ROOM_ID = "CASE_BOARD";
  const VERSION = "1.0.0";
  const KEY_LOCAL = "ketadata_case_board_local_v1";

  const $ = (id)=>document.getElementById(id);
  const root = $("root");

  const toast = $("toast");
  function showToast(msg){
    toast.textContent = msg;
    toast.className = "show";
    setTimeout(()=>toast.className="", 900);
  }

  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

  const shell = $("shell");
  const stage = $("stage");
  const viewport = $("viewport");
  const board = $("board");
  const linkSvg = $("linkSvg");

  const resV = $("resV");
  const resH = $("resH");

  const btnAddPerson = $("addPerson");
  const btnAddEvent = $("addEvent");
  const btnAddNote = $("addNote");
  const imgInput = $("imgInput");

  const btnLinkMode = $("linkMode");
  const btnToggleLinks = $("toggleLinks");
  const invertBtn = $("invertBtn");

  const btnExportJson = $("exportJson");
  const importJsonFile = $("importJsonFile");
  const btnSaveLocal = $("saveLocal");
  const btnLoadLocal = $("loadLocal");
  const btnClearAll = $("clearAll");

  const inspector = $("inspector");
  const timelinePanel = $("timelinePanel");
  const btnCollapseInspector = $("collapseInspector");
  const btnCollapseTimeline = $("collapseTimeline");

  const selSummary = $("selSummary");
  const selLabel = $("selLabel");
  const selType = $("selType");
  const selDate = $("selDate");
  const selOpacity = $("selOpacity");
  const bringFront = $("bringFront");
  const sendBack = $("sendBack");
  const deleteSel = $("deleteSel");

  const edgeLabel = $("edgeLabel");
  const edgeNote = $("edgeNote");
  const deleteEdge = $("deleteEdge");

  const timelineList = $("timelineList");

  let layout = {
    rightW: 320,
    bottomH: 180,
    inspectorCollapsed: false,
    timelineCollapsed: false
  };

  function applyLayout(){
    const cols = layout.inspectorCollapsed ? "1fr" : `1fr 6px ${layout.rightW}px`;
    const rows = layout.timelineCollapsed ? "1fr" : `1fr 6px ${layout.bottomH}px`;

    shell.style.gridTemplateColumns = cols;
    shell.style.gridTemplateRows = rows;

    resV.style.display = layout.inspectorCollapsed ? "none" : "block";
    inspector.style.display = layout.inspectorCollapsed ? "none" : "flex";

    resH.style.display = layout.timelineCollapsed ? "none" : "block";
    timelinePanel.style.display = layout.timelineCollapsed ? "none" : "block";
  }

  function startResizer(kind, e){
    e.preventDefault();
    const sx = e.clientX, sy = e.clientY;
    const start = {...layout};

    const onMove = (ev)=>{
      if(kind==="right"){
        layout.rightW = clamp(start.rightW - (ev.clientX - sx), 240, 560);
      }
      if(kind==="bottom"){
        layout.bottomH = clamp(start.bottomH - (ev.clientY - sy), 120, 420);
      }
      applyLayout();
    };
    const onUp = ()=>{
      window.removeEventListener("mousemove", onMove);
      window.removeEventListener("mouseup", onUp);
      autosave(false);
    };
    window.addEventListener("mousemove", onMove);
    window.addEventListener("mouseup", onUp);
  }

  resV.addEventListener("mousedown", (e)=> startResizer("right", e));
  resH.addEventListener("mousedown", (e)=> startResizer("bottom", e));

  btnCollapseInspector.addEventListener("click", ()=>{
    layout.inspectorCollapsed = !layout.inspectorCollapsed;
    applyLayout(); autosave(false);
  });
  btnCollapseTimeline.addEventListener("click", ()=>{
    layout.timelineCollapsed = !layout.timelineCollapsed;
    applyLayout(); autosave(false);
  });

  let view = { scale:1, panX:0, panY:0 };
  function applyView(){
    viewport.style.transform = `translate(${view.panX}px, ${view.panY}px) scale(${view.scale})`;
    renderLinks();
  }
  function screenToWorld(clientX, clientY){
    const r = stage.getBoundingClientRect();
    const sx = clientX - r.left;
    const sy = clientY - r.top;
    return {
      x: (sx - view.panX) / view.scale,
      y: (sy - view.panY) / view.scale,
      sx, sy
    };
  }

  let spaceDown = false;
  document.addEventListener("keydown", (e)=>{
    if(e.code==="Space") spaceDown = true;
    if(e.shiftKey && e.key.toLowerCase()==="i"){
      toggleInvert();
    }
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="s"){
      e.preventDefault();
      autosave(true);
    }
  });
  document.addEventListener("keyup", (e)=>{
    if(e.code==="Space") spaceDown = false;
  });

  stage.addEventListener("wheel", (e)=>{
    e.preventDefault();
    const delta = -Math.sign(e.deltaY) * 0.10;
    const before = screenToWorld(e.clientX, e.clientY);
    const next = clamp(view.scale * (1 + delta), parseFloat(getCss("--zoomMin")), parseFloat(getCss("--zoomMax")));
    view.scale = next;
    const after = screenToWorld(e.clientX, e.clientY);
    view.panX += (after.sx - before.sx);
    view.panY += (after.sy - before.sy);
    applyView();
  }, { passive:false });

  function getCss(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }

  let dragView = null;
  stage.addEventListener("mousedown", (e)=>{
    const onItem = e.target.closest && e.target.closest(".item");
    const onEdge = e.target.closest && e.target.closest("svg");
    if(onItem) return;

    if(spaceDown){
      dragView = { sx:e.clientX, sy:e.clientY, px:view.panX, py:view.panY };
      return;
    }

    // blank click
    if(!linkMode || !linkFromId){
      selectItem(null);
      selectEdge(null);
    }
  });
  window.addEventListener("mousemove", (e)=>{
    if(!dragView) return;
    view.panX = dragView.px + (e.clientX - dragView.sx);
    view.panY = dragView.py + (e.clientY - dragView.sy);
    applyView();
  });
  window.addEventListener("mouseup", ()=> dragView=null);

  // Data
  let items = []; // {id,type,label,date, x,y,w,h,r,opacity,z, name, note, image:{dataUrl, caption}}
  let edges = []; // {id,from,to,label,note}
  let selectedId = null;
  let selectedEdgeId = null;

  let linkMode = false;
  let linkFromId = null;
  let linksVisible = true;

  function nextZ(){ return items.reduce((m,it)=>Math.max(m,it.z||0),0)+1; }
  function getItem(id){ return items.find(it=>it.id===id)||null; }
  function itemCenter(it){ return { x: it.x + it.w/2, y: it.y + it.h/2 }; }

  function selectItem(id){
    selectedId = id;
    if(id!==null) selectedEdgeId = null;
    syncInspector();
    render();
    renderTimeline();
  }
  function selectEdge(id){
    selectedEdgeId = id;
    if(id!==null) selectedId = null;
    syncInspector();
    renderLinks();
  }

  function render(){
    board.innerHTML = "";
    const sorted = [...items].sort((a,b)=>(a.z||0)-(b.z||0));

    for(const it of sorted){
      const el = document.createElement("div");
      el.className = "item" + (it.id===selectedId ? " selected" : "");
      el.dataset.id = it.id;
      el.style.left = it.x + "px";
      el.style.top = it.y + "px";
      el.style.width = it.w + "px";
      el.style.height = it.h + "px";
      el.style.opacity = String(it.opacity ?? 1);
      el.style.transform = `rotate(${it.r||0}deg)`;
      el.style.zIndex = String(it.z||0);

      // evidence: image only + caption bar
      if(it.type==="evidence"){
        const img = document.createElement("img");
        img.src = it.image?.dataUrl || "";
        el.appendChild(img);

        const cap = document.createElement("div");
        cap.className = "caption";
        cap.textContent = (it.label || it.image?.caption || "evidence");
        el.appendChild(cap);

        el.addEventListener("mousedown", onItemDown);
        board.appendChild(el);
        if(it.id===selectedId) addHandles(el);
        continue;
      }

      const card = document.createElement("div");
      card.className = "card";

      const head = document.createElement("div");
      head.className = "head";
      const tag = document.createElement("div");
      tag.className = "tag";
      tag.textContent = it.type.toUpperCase();
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = it.type==="event" && it.date ? it.date : "";
      head.appendChild(tag);
      head.appendChild(meta);

      const body = document.createElement("div");
      body.className = "body";

      const name = document.createElement("input");
      name.className = "name";
      name.value = it.name || "";
      name.placeholder = (it.type==="person") ? "name" : (it.type==="event" ? "event" : "label");
      name.addEventListener("input", ()=>{
        const x = getItem(it.id); if(!x) return;
        x.name = name.value;
        if(!x.label) x.label = x.name;
        autosave(false);
        renderTimeline();
      });
      name.addEventListener("mousedown", (ev)=>ev.stopPropagation());

      const note = document.createElement("textarea");
      note.className = "note";
      note.value = it.note || "";
      note.placeholder = "notes";
      note.addEventListener("input", ()=>{
        const x = getItem(it.id); if(!x) return;
        x.note = note.value;
        autosave(false);
      });
      note.addEventListener("mousedown", (ev)=>ev.stopPropagation());

      body.appendChild(name);
      body.appendChild(note);

      card.appendChild(head);
      card.appendChild(body);
      el.appendChild(card);

      el.addEventListener("mousedown", onItemDown);
      board.appendChild(el);

      if(it.id===selectedId) addHandles(el);
    }
    renderLinks();
  }

  function addHandles(el){
    ["nw","ne","sw","se"].forEach(pos=>{
      const h = document.createElement("div");
      h.className = `handle h-${pos}`;
      h.dataset.handle = pos;
      el.appendChild(h);
    });
    const rot = document.createElement("div");
    rot.className = "rot";
    rot.dataset.handle = "rot";
    el.appendChild(rot);
  }

  function renderLinks(){
    linkSvg.innerHTML = "";
    if(!linksVisible) return;

    for(const e of edges){
      const a = getItem(e.from);
      const b = getItem(e.to);
      if(!a || !b) continue;

      const ca = itemCenter(a);
      const cb = itemCenter(b);
      const midx = (ca.x + cb.x)/2;
      const midy = (ca.y + cb.y)/2;
      const isSel = (e.id===selectedEdgeId);

      const line = document.createElementNS("http://www.w3.org/2000/svg","line");
      line.setAttribute("x1", ca.x);
      line.setAttribute("y1", ca.y);
      line.setAttribute("x2", cb.x);
      line.setAttribute("y2", cb.y);
      line.setAttribute("class", "edge" + (isSel ? " selected" : ""));
      linkSvg.appendChild(line);

      const hit = document.createElementNS("http://www.w3.org/2000/svg","line");
      hit.setAttribute("x1", ca.x);
      hit.setAttribute("y1", ca.y);
      hit.setAttribute("x2", cb.x);
      hit.setAttribute("y2", cb.y);
      hit.setAttribute("class", "edgeHit");
      hit.addEventListener("mousedown", (ev)=>{
        ev.stopPropagation();
        selectEdge(e.id);
      });
      linkSvg.appendChild(hit);

      const lbl = (e.label||"").trim();
      if(lbl){
        const t = document.createElementNS("http://www.w3.org/2000/svg","text");
        t.setAttribute("x", midx + 6);
        t.setAttribute("y", midy - 6);
        t.setAttribute("class", "edgeLabel");
        t.textContent = lbl;
        linkSvg.appendChild(t);
      }
    }
  }

  // Timeline panel (events only)
  function renderTimeline(){
    const evs = items
      .filter(it=>it.type==="event")
      .map(it=>({
        id: it.id,
        date: (it.date||"").trim(),
        title: (it.name||it.label||"").trim() || "event",
        type: "event"
      }))
      .sort((a,b)=>{
        // empty dates last
        if(!a.date && !b.date) return a.title.localeCompare(b.title);
        if(!a.date) return 1;
        if(!b.date) return -1;
        return a.date.localeCompare(b.date);
      });

    timelineList.innerHTML = "";
    if(!evs.length){
      const d = document.createElement("div");
      d.className = "small";
      d.textContent = "No events.";
      timelineList.appendChild(d);
      return;
    }

    for(const e of evs){
      const row = document.createElement("div");
      row.className = "tRow";
      row.dataset.id = e.id;

      const c1 = document.createElement("div");
      c1.className = "tDate";
      c1.textContent = e.date || "—";

      const c2 = document.createElement("div");
      c2.className = "tTitle";
      c2.textContent = e.title;

      const c3 = document.createElement("div");
      c3.className = "tType";
      c3.textContent = "event";

      row.appendChild(c1);
      row.appendChild(c2);
      row.appendChild(c3);

      row.addEventListener("click", ()=>{
        selectItem(e.id);
        focusOnItem(e.id);
      });

      timelineList.appendChild(row);
    }
  }

  function focusOnItem(id){
    const it = getItem(id); if(!it) return;
    const rect = stage.getBoundingClientRect();
    const cx = rect.width/2;
    const cy = rect.height/2;
    // world center to screen center
    const tx = -it.x - it.w/2;
    const ty = -it.y - it.h/2;
    view.panX = cx + tx * view.scale;
    view.panY = cy + ty * view.scale;
    applyView();
  }

  // Create items
  function addItem(type){
    const rect = stage.getBoundingClientRect();
    const c = screenToWorld(rect.left + rect.width/2, rect.top + rect.height/2);

    const base = {
      id: uid(),
      type,
      label: "",
      date: "",
      x: c.x - 220,
      y: c.y - 120,
      w: 440,
      h: 240,
      r: 0,
      opacity: 1,
      z: nextZ(),
      name: "",
      note: ""
    };

    if(type==="person"){
      base.name = "person";
      base.label = "person";
      base.note = "";
    } else if(type==="event"){
      base.name = "event";
      base.label = "event";
      base.date = "";
      base.note = "";
    } else if(type==="note"){
      base.name = "note";
      base.label = "note";
      base.note = "";
    }

    items.push(base);
    selectItem(base.id);
    autosave(false);
    showToast("added");
  }

  btnAddPerson.addEventListener("click", ()=> addItem("person"));
  btnAddEvent.addEventListener("click", ()=> addItem("event"));
  btnAddNote.addEventListener("click", ()=> addItem("note"));

  // Import images as evidence items
  function readAsDataURL(file){
    return new Promise((res, rej)=>{
      const fr = new FileReader();
      fr.onload = ()=>res(fr.result);
      fr.onerror = rej;
      fr.readAsDataURL(file);
    });
  }

  // spiral placement
  const GOLDEN = 2.399963229728653;
  const STEP = 90;
  function spiralPos(n, cx, cy){
    const r = STEP * Math.sqrt(Math.max(0,n));
    const t = n * GOLDEN;
    return { x: cx + r*Math.cos(t), y: cy + r*Math.sin(t) };
  }

  imgInput.addEventListener("change", async (ev)=>{
    const files = [...(ev.target.files||[])];
    if(!files.length) return;

    const rect = stage.getBoundingClientRect();
    const c = screenToWorld(rect.left + rect.width/2, rect.top + rect.height/2);
    const baseN = items.filter(it=>it.type==="evidence").length;

    for(let i=0;i<files.length;i++){
      const f = files[i];
      const dataUrl = await readAsDataURL(f);
      const W = 420, H = 270;
      const p = spiralPos(baseN+i, c.x, c.y);

      items.push({
        id: uid(),
        type: "evidence",
        label: f.name,
        date: "",
        x: p.x - W/2,
        y: p.y - H/2,
        w: W,
        h: H,
        r: 0,
        opacity: 1,
        z: nextZ(),
        image: { dataUrl, caption: f.name }
      });
    }

    ev.target.value = "";
    render();
    renderTimeline();
    autosave(false);
    showToast("imported");
  });

  // Drag / resize / rotate / link
  let dragItem = null;

  function onItemDown(e){
    const el = e.currentTarget;
    const id = el.dataset.id;

    if(linkMode){
      e.preventDefault();
      e.stopPropagation();

      if(!linkFromId){
        linkFromId = id;
        selectItem(id);
        showToast("select target");
        return;
      }
      if(linkFromId === id){
        linkFromId = null;
        showToast("cancel");
        return;
      }
      edges.push({ id: uid(), from: linkFromId, to: id, label: "", note: "" });
      linkFromId = null;
      selectEdge(edges[edges.length-1].id);
      autosave(false);
      showToast("linked");
      return;
    }

    selectItem(id);

    const it = getItem(id);
    if(!it) return;

    const handle = e.target.dataset && e.target.dataset.handle;
    const pt = screenToWorld(e.clientX, e.clientY);

    if(handle==="rot"){
      const cx = it.x + it.w/2;
      const cy = it.y + it.h/2;
      const ang0 = Math.atan2(pt.y - cy, pt.x - cx);
      dragItem = { mode:"rot", id, cx, cy, ang0, r0: it.r||0 };
      bindItemMove();
      return;
    }

    if(handle){
      dragItem = { mode:"resize", id, handle, x0:it.x,y0:it.y,w0:it.w,h0:it.h, p0:pt };
      bindItemMove();
      return;
    }

    // head drag preferred; allow whole card drag (utilitarian)
    dragItem = { mode:"move", id, x0:it.x,y0:it.y, p0:pt };
    bindItemMove();
  }

  function bindItemMove(){
    window.addEventListener("mousemove", onItemMove);
    window.addEventListener("mouseup", onItemUp);
  }

  function onItemMove(e){
    if(!dragItem) return;
    const it = getItem(dragItem.id);
    if(!it) return;
    const pt = screenToWorld(e.clientX, e.clientY);

    if(dragItem.mode==="move"){
      it.x = dragItem.x0 + (pt.x - dragItem.p0.x);
      it.y = dragItem.y0 + (pt.y - dragItem.p0.y);
      render(); // keeps handles aligned
      return;
    }

    if(dragItem.mode==="resize"){
      const dx = pt.x - dragItem.p0.x;
      const dy = pt.y - dragItem.p0.y;

      let x = dragItem.x0, y = dragItem.y0, w = dragItem.w0, h = dragItem.h0;

      if(dragItem.handle==="se"){ w = dragItem.w0 + dx; h = dragItem.h0 + dy; }
      if(dragItem.handle==="sw"){ x = dragItem.x0 + dx; w = dragItem.w0 - dx; h = dragItem.h0 + dy; }
      if(dragItem.handle==="ne"){ y = dragItem.y0 + dy; w = dragItem.w0 + dx; h = dragItem.h0 - dy; }
      if(dragItem.handle==="nw"){ x = dragItem.x0 + dx; y = dragItem.y0 + dy; w = dragItem.w0 - dx; h = dragItem.h0 - dy; }

      it.x = x; it.y = y;
      it.w = clamp(w, 140, 5000);
      it.h = clamp(h, 120, 5000);
      render();
      return;
    }

    if(dragItem.mode==="rot"){
      const ang = Math.atan2(pt.y - dragItem.cy, pt.x - dragItem.cx);
      it.r = dragItem.r0 + (ang - dragItem.ang0) * 180/Math.PI;
      render();
      return;
    }
  }

  function onItemUp(){
    if(!dragItem) return;
    dragItem = null;
    window.removeEventListener("mousemove", onItemMove);
    window.removeEventListener("mouseup", onItemUp);
    autosave(false);
  }

  // Link controls
  btnLinkMode.addEventListener("click", ()=>{
    linkMode = !linkMode;
    linkFromId = null;
    btnLinkMode.textContent = "Link: " + (linkMode ? "On" : "Off");
    showToast(linkMode ? "link on" : "link off");
  });

  btnToggleLinks.addEventListener("click", ()=>{
    linksVisible = !linksVisible;
    btnToggleLinks.textContent = "Links: " + (linksVisible ? "On" : "Off");
    renderLinks();
    autosave(false);
  });

  function toggleInvert(){
    root.classList.toggle("invert");
    autosave(false);
  }
  invertBtn.addEventListener("click", toggleInvert);

  // Inspector sync
  function syncInspector(){
    const it = getItem(selectedId);
    const ed = edges.find(x=>x.id===selectedEdgeId) || null;

    if(ed){
      selSummary.textContent = "edge";
      selLabel.value = ed.label || "";
      selLabel.disabled = false;
      selType.disabled = true;
      selDate.disabled = true;
      selOpacity.disabled = true;

      bringFront.disabled = true;
      sendBack.disabled = true;
      deleteSel.disabled = true;

      edgeLabel.disabled = false;
      edgeNote.disabled = false;
      deleteEdge.disabled = false;

      edgeLabel.value = ed.label || "";
      edgeNote.value = ed.note || "";
      return;
    }

    edgeLabel.disabled = true;
    edgeNote.disabled = true;
    deleteEdge.disabled = true;
    edgeLabel.value = "";
    edgeNote.value = "";

    if(!it){
      selSummary.textContent = "—";
      selLabel.value = "";
      selType.value = "note";
      selDate.value = "";
      selOpacity.value = "100";

      selLabel.disabled = true;
      selType.disabled = true;
      selDate.disabled = true;
      selOpacity.disabled = true;

      bringFront.disabled = true;
      sendBack.disabled = true;
      deleteSel.disabled = true;
      return;
    }

    selSummary.textContent = it.type;
    selLabel.value = it.label || "";
    selType.value = it.type;
    selDate.value = it.date || "";
    selOpacity.value = String(Math.round((it.opacity ?? 1)*100));

    selLabel.disabled = false;
    selType.disabled = false;
    selDate.disabled = (it.type!=="event");
    selOpacity.disabled = false;

    bringFront.disabled = false;
    sendBack.disabled = false;
    deleteSel.disabled = false;
  }

  selLabel.addEventListener("input", ()=>{
    const it = getItem(selectedId);
    if(it){
      it.label = selLabel.value;
      autosave(false);
      render();
      renderTimeline();
    }
  });

  selType.addEventListener("change", ()=>{
    const it = getItem(selectedId);
    if(!it) return;
    const next = selType.value;

    // preserve content fields where possible
    if(it.type==="evidence" && next!=="evidence"){
      // convert evidence -> note-like: create a note item instead (evidence stays evidence)
      selType.value = it.type;
      return;
    }
    it.type = next;

    if(next!=="event"){ it.date = ""; }
    if(next==="event" && !it.name) it.name = it.label || "event";

    autosave(false);
    syncInspector();
    render();
    renderTimeline();
  });

  selDate.addEventListener("input", ()=>{
    const it = getItem(selectedId);
    if(!it || it.type!=="event") return;
    it.date = selDate.value.trim();
    autosave(false);
    render();
    renderTimeline();
  });

  selOpacity.addEventListener("input", ()=>{
    const it = getItem(selectedId);
    if(!it) return;
    it.opacity = clamp(Number(selOpacity.value)/100, 0.10, 1);
    autosave(false);
    render();
  });

  bringFront.addEventListener("click", ()=>{
    const it = getItem(selectedId); if(!it) return;
    it.z = nextZ();
    autosave(false);
    render();
  });

  sendBack.addEventListener("click", ()=>{
    const it = getItem(selectedId); if(!it) return;
    it.z = 0;
    autosave(false);
    render();
  });

  deleteSel.addEventListener("click", ()=>{
    if(!selectedId) return;
    const id = selectedId;
    items = items.filter(x=>x.id!==id);
    edges = edges.filter(e=>e.from!==id && e.to!==id);
    selectItem(null);
    autosave(false);
    showToast("deleted");
  });

  edgeLabel.addEventListener("input", ()=>{
    const ed = edges.find(x=>x.id===selectedEdgeId);
    if(!ed) return;
    ed.label = edgeLabel.value;
    autosave(false);
    renderLinks();
  });

  edgeNote.addEventListener("input", ()=>{
    const ed = edges.find(x=>x.id===selectedEdgeId);
    if(!ed) return;
    ed.note = edgeNote.value;
    autosave(false);
  });

  deleteEdge.addEventListener("click", ()=>{
    if(!selectedEdgeId) return;
    edges = edges.filter(x=>x.id!==selectedEdgeId);
    selectEdge(null);
    autosave(false);
    showToast("edge deleted");
  });

  // Keyboard delete / esc cancel link
  document.addEventListener("keydown", (e)=>{
    if(e.key==="Escape"){
      linkFromId = null;
      if(linkMode) showToast("cancel");
      return;
    }

    if(e.key==="Delete" || e.key==="Backspace"){
      const active = document.activeElement;
      if(active && (active.tagName==="INPUT" || active.tagName==="TEXTAREA" || active.isContentEditable)) return;

      if(selectedEdgeId){
        edges = edges.filter(x=>x.id!==selectedEdgeId);
        selectEdge(null);
        autosave(false);
        showToast("edge deleted");
        return;
      }
      if(selectedId){
        const id = selectedId;
        items = items.filter(x=>x.id!==id);
        edges = edges.filter(e=>e.from!==id && e.to!==id);
        selectItem(null);
        autosave(false);
        showToast("deleted");
        return;
      }
    }
  });

  // Export / import JSON files (real download behavior)
  function buildPayload(){
    return {
      file_id: FILE_ID,
      room_id: ROOM_ID,
      version: VERSION,
      updated_at: new Date().toISOString(),
      layout,
      view,
      items,
      edges,
      linksVisible,
      invert: root.classList.contains("invert")
    };
  }

  function download(filename, textOrBlob){
    const blob = (textOrBlob instanceof Blob) ? textOrBlob : new Blob([textOrBlob], {type:"application/octet-stream"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 250);
  }

  btnExportJson.addEventListener("click", ()=>{
    const payload = buildPayload();
    const name = `case_board__${new Date().toISOString().slice(0,19).replace(/[:T]/g,"-")}.json`;
    download(name, JSON.stringify(payload, null, 2));
    showToast("exported");
  });

  importJsonFile.addEventListener("change", async (ev)=>{
    const f = (ev.target.files||[])[0];
    if(!f) return;
    try{
      const text = await f.text();
      const p = JSON.parse(text);
      applyPayload(p);
      autosave(false);
      showToast("imported");
    }catch{
      showToast("import fail");
    }finally{
      ev.target.value = "";
    }
  });

  function applyPayload(p){
    layout = p.layout || layout;
    view = p.view || view;
    items = p.items || [];
    edges = p.edges || [];
    linksVisible = (p.linksVisible!==undefined) ? p.linksVisible : true;

    root.classList.toggle("invert", !!p.invert);

    applyLayout();
    applyView();

    btnToggleLinks.textContent = "Links: " + (linksVisible ? "On" : "Off");
    btnLinkMode.textContent = "Link: " + (linkMode ? "On" : "Off");

    selectedId = null;
    selectedEdgeId = null;
    linkFromId = null;

    render();
    renderTimeline();
    syncInspector();
  }

  // Local save/load
  function autosave(withToast){
    const payload = buildPayload();
    localStorage.setItem(KEY_LOCAL, JSON.stringify(payload));
    if(withToast) showToast("saved");
  }

  btnSaveLocal.addEventListener("click", ()=> autosave(true));
  btnLoadLocal.addEventListener("click", ()=>{
    const raw = localStorage.getItem(KEY_LOCAL);
    if(!raw){ showToast("no save"); return; }
    try{
      const p = JSON.parse(raw);
      applyPayload(p);
      showToast("loaded");
    }catch{
      showToast("load fail");
    }
  });

  btnClearAll.addEventListener("click", ()=>{
    if(!confirm("clear all?")) return;
    items = [];
    edges = [];
    selectedId = null;
    selectedEdgeId = null;
    linkFromId = null;
    render();
    renderTimeline();
    syncInspector();
    autosave(false);
    showToast("cleared");
  });

  // Init
  applyLayout();
  applyView();

  // optional restore
  const raw = localStorage.getItem(KEY_LOCAL);
  if(raw){
    try{ applyPayload(JSON.parse(raw)); }catch{}
  } else {
    // seed minimal: one person + one event + one note (blank)
    addItem("person");
    addItem("event");
    addItem("note");
    items[0].x -= 520;
    items[1].x += 80;
    items[2].y += 320;
    items[0].name = ""; items[0].label = "";
    items[1].name = ""; items[1].label = ""; items[1].date = "";
    items[2].name = ""; items[2].label = "";
    selectedId = null;
    render();
    renderTimeline();
    syncInspector();
    autosave(false);
  }

})();
</script>

<!--
AE: brutal minimal board UI, single text size, black void, no decorative language.
EE: draggable items (person/event/note/evidence), links w/ labels+notes, timeline list from events, pan/zoom, json import/export + local save, invert.
WB: state wiring + inspector synchronization + selection model.
FILE_ID: KETADATA_CASE_BOARD_v1
ROOM_ID: CASE_BOARD
VERSION: 1.0.0
UPDATED_AT: 2026-02-05
CHANGELOG:
- v1.0.0: minimal case board with items + links + timeline; file import/export; local save; invert.
-->
</body>
</html>
