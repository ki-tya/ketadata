<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KETADATA // INTERFACE COMPARER + EXTRACTER</title>
  <style>
    :root{
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --bg:#07090c; --panel:#0c0f14; --panel2:#0a0d12;
      --ink:#e8edf4; --muted:rgba(232,237,244,.65);
      --line:rgba(232,237,244,.14); --line2:rgba(232,237,244,.22);
      --shadow: 0 10px 30px rgba(0,0,0,.55);
      --pad:12px;
      --radius:0px; /* unrounded */
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; background:radial-gradient(1200px 800px at 30% 30%, rgba(255,255,255,.06), transparent 55%), var(--bg);
      color:var(--ink); font-family:var(--sans); letter-spacing:.2px;
    }
    header{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(to bottom, rgba(7,9,12,.92), rgba(7,9,12,.78));
      border-bottom:1px solid var(--line);
      backdrop-filter: blur(10px);
    }
    .bar{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      gap:12px;
      max-width:1400px; margin:0 auto;
    }
    .title{
      display:flex; flex-direction:column; gap:4px; min-width:260px;
    }
    .title .h{
      font-family:var(--mono); font-weight:700; font-size:14px; letter-spacing:.8px;
    }
    .title .sub{
      font-family:var(--mono); font-size:11px; color:var(--muted);
    }
    .actions{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    }
    button,.btn{
      border:1px solid var(--line2);
      background:linear-gradient(to bottom, rgba(255,255,255,.06), rgba(255,255,255,.02));
      color:var(--ink);
      font-family:var(--mono);
      font-size:12px;
      padding:8px 10px;
      cursor:pointer;
      border-radius:var(--radius);
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
    }
    button:hover{ border-color:rgba(232,237,244,.32); }
    button:active{ transform: translateY(1px); }
    button.warn{ border-color:rgba(255,153,153,.35); }
    button.good{ border-color:rgba(153,255,204,.28); }
    button.gold{ border-color:rgba(255,216,120,.35); }
    .wrap{
      max-width:1400px; margin:0 auto;
      padding:16px;
    }

    .toprow{
      display:grid;
      grid-template-columns: 1fr 420px;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 1100px){
      .toprow{ grid-template-columns:1fr; }
    }

    .panel{
      background:linear-gradient(to bottom, rgba(255,255,255,.04), rgba(255,255,255,.015));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .ph{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .ph .k{
      font-family:var(--mono); font-size:12px; letter-spacing:.6px; opacity:.9;
    }
    .ph .m{
      font-family:var(--mono); font-size:11px; color:var(--muted);
    }
    .panel .pc{
      padding:12px;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
    }
    @media (max-width: 1200px){ .grid{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 760px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background:linear-gradient(to bottom, rgba(12,15,20,.9), rgba(10,13,18,.86));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex; flex-direction:column;
      min-height: 520px;
    }
    .card .ch{
      padding:10px 12px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--line);
      gap:10px;
    }
    .tag{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      border:1px solid var(--line2);
      padding:4px 6px;
    }
    .card .ch .left{
      display:flex; gap:8px; align-items:center; min-width:0;
    }
    .card .ch .name{
      font-family:var(--mono);
      font-size:12px;
      font-weight:700;
      letter-spacing:.6px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 240px;
    }
    .card .ch .right{
      display:flex; gap:6px; align-items:center;
    }
    .iconbtn{
      padding:6px 8px;
      font-size:12px;
      opacity:.95;
    }
    .card .cc{
      padding:12px;
      display:flex; flex-direction:column; gap:10px;
    }

    label{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      display:block;
      margin-bottom:4px;
    }
    input[type="text"], input[type="url"], textarea{
      width:100%;
      background: rgba(0,0,0,.35);
      color: var(--ink);
      border: 1px solid var(--line2);
      border-radius:var(--radius);
      padding:8px 10px;
      font-family: var(--mono);
      font-size:12px;
      outline:none;
    }
    textarea{
      min-height: 86px;
      resize: vertical;
      line-height: 1.25rem;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){ .row{ grid-template-columns:1fr; } }

    .shot{
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
    }
    .shot .preview{
      width:100%;
      height:170px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.28);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .shot img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      filter: contrast(1.05) brightness(.95);
    }
    .mini{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
    }

    .notesgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){ .notesgrid{ grid-template-columns:1fr; } }

    .muteblock{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      line-height:1.3rem;
      white-space:pre-wrap;
    }

    .exportBox{
      width:100%;
      height: 320px;
      background: rgba(0,0,0,.42);
      border:1px solid var(--line2);
      padding:10px;
      font-family: var(--mono);
      font-size:12px;
      color: var(--ink);
      border-radius:var(--radius);
      resize: vertical;
    }

    .sep{ height:1px; background:var(--line); margin:10px 0; }

    .hint{ font-family:var(--mono); font-size:11px; color:var(--muted); }
    .pill{
      display:inline-block;
      padding:3px 6px;
      border:1px solid var(--line2);
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      margin-right:6px;
      margin-top:6px;
    }
  </style>
</head>

<body>
<header>
  <div class="bar">
    <div class="title">
      <div class="h">KETADATA // INTERFACE COMPARER + EXTRACTER</div>
      <div class="sub">input: title + link + screenshot + html + notes — export: prompt pack or json</div>
    </div>
    <div class="actions">
      <button id="btnAdd" class="good">add interface</button>
      <button id="btnExport" class="gold">export prompts</button>
      <button id="btnCopy">copy prompts</button>
      <button id="btnDownload">download prompts.txt</button>
      <button id="btnExportJson">export.json</button>
      <label class="btn" style="display:inline-flex; gap:8px; align-items:center;">
        import.json
        <input id="importJson" type="file" accept="application/json" style="display:none" />
      </label>
      <button id="btnReset" class="warn">reset</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="toprow">
    <div class="panel">
      <div class="ph">
        <div>
          <div class="k">GRID</div>
          <div class="m">up to 9 — each card is one interface specimen</div>
        </div>
        <div class="m" id="countLabel">0 / 9</div>
      </div>
      <div class="pc">
        <div class="grid" id="grid"></div>
      </div>
    </div>

    <div class="panel">
      <div class="ph">
        <div>
          <div class="k">EXPORT PROMPTS</div>
          <div class="m">paste into LLM — includes title + link + html + notes</div>
        </div>
        <div class="m" id="dirtyLabel">saved</div>
      </div>
      <div class="pc">
        <textarea id="exportText" class="exportBox" placeholder="hit “export prompts”"></textarea>
        <div class="sep"></div>
        <div class="hint">
          output format is stable and machine-parseable. each interface is wrapped in
          <span class="pill">BEGIN INTERFACE</span> / <span class="pill">END INTERFACE</span>.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const MAX = 9;
  const STORAGE_KEY = "ketadata_interface_comparer_v1";
  const $ = (id) => document.getElementById(id);

  const state = {
    dirty: false,
    items: []
  };

  function markDirty(on=true){
    state.dirty = on;
    $("dirtyLabel").textContent = on ? "unsaved" : "saved";
    $("dirtyLabel").style.color = on ? "rgba(255,216,120,.9)" : "rgba(232,237,244,.65)";
  }

  function persist(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ items: state.items }));
      markDirty(false);
    }catch(e){ console.warn(e); }
  }

  function restore(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const data = JSON.parse(raw);
      if(data && Array.isArray(data.items)){
        state.items = data.items;
      }
    }catch(e){ console.warn(e); }
  }

  function makeItem(){
    const n = state.items.length + 1;
    return {
      id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
      title: `Interface ${n}`,
      link: "",
      screenshotDataUrl: "",   // stored as data url
      html: "",
      notes_like: "",
      notes_dislike: "",
      notes_features: "",
      notes_bugs: "",
      createdAt: Date.now()
    };
  }

  function clampItems(){
    if(state.items.length > MAX) state.items = state.items.slice(0, MAX);
  }

  function updateCount(){
    $("countLabel").textContent = `${state.items.length} / ${MAX}`;
  }

  function escapeBlock(s){
    // keep raw; just ensure it's string
    return (s ?? "").toString();
  }

  function buildPromptPack(){
    const chunks = [];
    chunks.push("KETADATA INTERFACE COMPARER EXPORT");
    chunks.push("INSTRUCTIONS: analyze each interface specimen. do not invent details not provided. use html if present. use screenshot reference only if described in notes. respond with: strengths, weaknesses, bugs, consolidation opportunities, reusable primitives.");
    chunks.push("");

    state.items.forEach((it, idx) => {
      chunks.push(`BEGIN INTERFACE ${idx+1}`);
      chunks.push(`TITLE: ${escapeBlock(it.title).trim()}`);
      chunks.push(`LINK: ${escapeBlock(it.link).trim()}`);
      chunks.push(`SCREENSHOT: ${it.screenshotDataUrl ? "[attached as data-url in json export]" : "[none]"}`);
      chunks.push("");
      chunks.push("HTML:");
      chunks.push("```html");
      chunks.push(escapeBlock(it.html));
      chunks.push("```");
      chunks.push("");
      chunks.push("NOTES_LIKE:");
      chunks.push(escapeBlock(it.notes_like));
      chunks.push("");
      chunks.push("NOTES_DISLIKE:");
      chunks.push(escapeBlock(it.notes_dislike));
      chunks.push("");
      chunks.push("FEATURES:");
      chunks.push(escapeBlock(it.notes_features));
      chunks.push("");
      chunks.push("BUGS:");
      chunks.push(escapeBlock(it.notes_bugs));
      chunks.push(`END INTERFACE ${idx+1}`);
      chunks.push("");
    });

    return chunks.join("\n");
  }

  function downloadText(filename, text){
    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function downloadJson(filename, obj){
    const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function moveItem(index, dir){
    const j = index + dir;
    if(j < 0 || j >= state.items.length) return;
    const tmp = state.items[index];
    state.items[index] = state.items[j];
    state.items[j] = tmp;
    markDirty(true);
    render();
  }

  function removeItem(index){
    state.items.splice(index, 1);
    markDirty(true);
    render();
  }

  async function copyToClipboard(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch(e){
      // fallback
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      try{ document.execCommand("copy"); }catch(_){}
      ta.remove();
      return true;
    }
  }

  function render(){
    clampItems();
    updateCount();

    const grid = $("grid");
    grid.innerHTML = "";

    state.items.forEach((it, idx) => {
      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <div class="ch">
          <div class="left">
            <span class="tag">#${idx+1}</span>
            <div class="name" title="${it.title ?? ""}">${it.title ?? ""}</div>
          </div>
          <div class="right">
            <button class="iconbtn" title="move up" data-act="up">↑</button>
            <button class="iconbtn" title="move down" data-act="down">↓</button>
            <button class="iconbtn warn" title="remove" data-act="remove">x</button>
          </div>
        </div>

        <div class="cc">
          <div class="row">
            <div>
              <label>title</label>
              <input type="text" data-k="title" value="${escapeHtml(it.title ?? "")}" placeholder="e.g. Constellation Notes v2" />
            </div>
            <div>
              <label>link</label>
              <input type="url" data-k="link" value="${escapeHtml(it.link ?? "")}" placeholder="https://ketadata.com/..." />
            </div>
          </div>

          <div class="shot">
            <div>
              <label>screenshot</label>
              <input type="file" accept="image/*" data-k="shot" />
            </div>
            <div class="preview" data-k="preview">
              ${it.screenshotDataUrl ? `<img alt="screenshot" src="${it.screenshotDataUrl}" />` : `<div class="mini">no screenshot</div>`}
            </div>
            <div class="mini">stored locally (browser). json export preserves it as data-url.</div>
          </div>

          <div>
            <label>html code (optional)</label>
            <textarea data-k="html" placeholder="paste html here">${escapeHtml(it.html ?? "")}</textarea>
          </div>

          <div class="notesgrid">
            <div>
              <label>what i like</label>
              <textarea data-k="notes_like" placeholder="tightness, spacing, routing, etc">${escapeHtml(it.notes_like ?? "")}</textarea>
            </div>
            <div>
              <label>what i don’t like</label>
              <textarea data-k="notes_dislike" placeholder="kitsch, bleed, clutter, etc">${escapeHtml(it.notes_dislike ?? "")}</textarea>
            </div>
            <div>
              <label>features / primitives</label>
              <textarea data-k="notes_features" placeholder="drag nodes, export json, camera, etc">${escapeHtml(it.notes_features ?? "")}</textarea>
            </div>
            <div>
              <label>bugs / failures</label>
              <textarea data-k="notes_bugs" placeholder="lines overlap, focus bug, lag, etc">${escapeHtml(it.notes_bugs ?? "")}</textarea>
            </div>
          </div>

          <div class="hint">tip: keep html + notes minimal and factual — export prompts will be cleaner.</div>
        </div>
      `;

      // header actions
      card.querySelectorAll("button[data-act]").forEach(btn => {
        btn.addEventListener("click", () => {
          const act = btn.getAttribute("data-act");
          if(act === "up") moveItem(idx, -1);
          if(act === "down") moveItem(idx, +1);
          if(act === "remove") removeItem(idx);
        });
      });

      // inputs binding
      card.querySelectorAll("input[data-k], textarea[data-k]").forEach(el => {
        const k = el.getAttribute("data-k");

        if(k === "shot"){
          el.addEventListener("change", async () => {
            const file = el.files && el.files[0];
            if(!file) return;
            const dataUrl = await fileToDataUrl(file);
            it.screenshotDataUrl = dataUrl;
            markDirty(true);
            render(); // refresh preview
          });
          return;
        }

        el.addEventListener("input", () => {
          it[k] = el.value;
          // update title in header live
          if(k === "title"){
            card.querySelector(".name").textContent = el.value || "(untitled)";
          }
          markDirty(true);
        });
      });

      grid.appendChild(card);
    });

    // autosave if dirty and user pauses typing
    scheduleAutosave();
  }

  let autosaveTimer = null;
  function scheduleAutosave(){
    if(autosaveTimer) clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(() => {
      if(state.dirty) persist();
    }, 900);
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function fileToDataUrl(file){
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  // top actions
  $("btnAdd").addEventListener("click", () => {
    if(state.items.length >= MAX) return alert("max 9 interfaces.");
    state.items.push(makeItem());
    markDirty(true);
    render();
  });

  $("btnExport").addEventListener("click", () => {
    const pack = buildPromptPack();
    $("exportText").value = pack;
  });

  $("btnCopy").addEventListener("click", async () => {
    const txt = $("exportText").value || buildPromptPack();
    $("exportText").value = txt;
    await copyToClipboard(txt);
  });

  $("btnDownload").addEventListener("click", () => {
    const txt = $("exportText").value || buildPromptPack();
    $("exportText").value = txt;
    downloadText("interfaces_prompts.txt", txt);
  });

  $("btnExportJson").addEventListener("click", () => {
    downloadJson("interfaces_export.json", {
      schema: "ketadata.interface-comparer.v1",
      exportedAt: new Date().toISOString(),
      items: state.items
    });
  });

  $("importJson").addEventListener("change", async (e) => {
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    try{
      const text = await file.text();
      const obj = JSON.parse(text);
      if(!obj || !Array.isArray(obj.items)) throw new Error("bad json");
      state.items = obj.items.slice(0, MAX);
      markDirty(true);
      render();
      persist();
    }catch(err){
      alert("import failed. expected { items: [...] }");
    }finally{
      e.target.value = "";
    }
  });

  $("btnReset").addEventListener("click", () => {
    const ok = confirm("reset all interfaces? this clears local storage.");
    if(!ok) return;
    state.items = [];
    localStorage.removeItem(STORAGE_KEY);
    markDirty(false);
    $("exportText").value = "";
    render();
  });

  // init
  restore();
  if(state.items.length === 0){
    // start with 1 empty card for momentum
    state.items.push(makeItem());
  }
  render();

})();
</script>
</body>
</html>
