<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KETADATA // PRIMITIVES (CENTER GRID + COLLAPSIBLE)</title>
  <style>
    :root{
      --bg:#000;
      --fg:#fff;
      --stroke:rgba(255,255,255,0.16);
      --stroke2:rgba(255,255,255,0.10);
      --glass:rgba(255,255,255,0.06);
      --panel:rgba(0,0,0,0.92);
      --muted:rgba(255,255,255,0.55);
      --muted2:rgba(255,255,255,0.38);
      --shadow:rgba(0,0,0,0.82);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:Arial, Helvetica, sans-serif;}
    body{overflow:hidden;}
    button,input,select,textarea{font-family:inherit}
    ::selection{background:rgba(255,255,255,0.18);}

    /* TOPBAR */
    #topbar{
      position:fixed; left:0; right:0; top:0;
      height:48px;
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid var(--stroke2);
      background:#000;
      user-select:none;
      z-index:80;
    }
    #brand{
      display:flex; align-items:center; gap:10px;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.80);
      min-width:240px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .whiteBox{width:10px;height:10px;background:#fff;display:inline-block;}
    .btn{
      border:1px solid var(--stroke);
      background:transparent;
      color:rgba(255,255,255,0.86);
      padding:7px 10px;
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{background:var(--glass);border-color:rgba(255,255,255,0.34);}
    .btnPrimary{background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.30);}
    .btnPrimary:hover{background:rgba(255,255,255,0.09);border-color:rgba(255,255,255,0.44);}

    /* NOTE SQUARE (TOP RIGHT) */
    #noteIcon{
      width:28px;height:28px;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,0.20);
      background:rgba(255,255,255,0.10);
      cursor:pointer;
    }
    #noteIcon:hover{border-color:rgba(255,255,255,0.36);background:rgba(255,255,255,0.14);}

    /* MAIN LAYOUT: LEFT | CENTER | RIGHT */
    #main{
      position:fixed; inset:48px 0 0 0;
      display:grid;
      grid-template-columns: 360px 1fr 420px;
      min-height:0;
    }

    /* LEFT */
    #left{
      border-right:1px solid var(--stroke2);
      background:rgba(0,0,0,0.90);
      display:flex; flex-direction:column;
      min-height:0;
    }
    #leftHeader{
      padding:12px;
      border-bottom:1px solid var(--stroke2);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      user-select:none;
    }
    #leftHeader .title{
      margin:0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.78);
      display:flex;align-items:center;gap:10px;
    }
    #leftBody{
      padding:12px;
      overflow:auto;
      min-height:0;
    }

    .field{display:grid;gap:6px;margin-bottom:12px;}
    label{
      font-size:11px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.60);
    }
    input[type="text"], textarea, select{
      width:100%;
      border:1px solid rgba(255,255,255,0.16);
      background:rgba(255,255,255,0.04);
      color:rgba(255,255,255,0.90);
      padding:9px 10px;
      font-size:12px;
      outline:none;
    }
    textarea{min-height:90px;resize:vertical;}
    input[type="text"]:focus, textarea:focus, select:focus{
      border-color:rgba(255,255,255,0.36);
      background:rgba(255,255,255,0.06);
    }
    .hint{
      font-size:11px;
      line-height:1.35;
      color:rgba(255,255,255,0.48);
      letter-spacing:0.04em;
    }
    .pill{
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.55);
      border:1px solid rgba(255,255,255,0.14);
      padding:3px 6px;
      background:rgba(0,0,0,0.40);
      white-space:nowrap;
    }
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}

    /* CENTER: REGISTRY GRID/LIST + INLINE EDITOR */
    #center{
      position:relative;
      min-height:0;
      overflow:hidden;
      background:#000;
      display:flex;
      flex-direction:column;
    }
    #centerHeader{
      padding:12px 14px;
      border-bottom:1px solid var(--stroke2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    #centerHeader .title{
      margin:0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.78);
      display:flex;align-items:center;gap:10px;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }

    /* view toggle in center header */
    .chip{
      border:1px solid rgba(255,255,255,0.16);
      background:transparent;
      color:rgba(255,255,255,0.72);
      padding:7px 10px;
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{background:var(--glass);border-color:rgba(255,255,255,0.34);}
    .chip.on{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.40);color:rgba(255,255,255,0.88);}

    #centerBody{
      flex:1;
      min-height:0;
      overflow:auto;
      padding:14px;
      display:grid;
      gap:12px;
    }

    /* Registry cards in center */
    #registryGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    #registryList{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .primCard{
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.03);
      padding:10px;
      display:grid;
      gap:8px;
      cursor:pointer;
      user-select:none;
    }
    .primCard:hover{background:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.22);}
    .primCard.active{background:rgba(255,255,255,0.07);border-color:rgba(255,255,255,0.32);}
    .primTop{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .primName{
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.86);
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .mini{
      color:rgba(255,255,255,0.48);
      font-size:11px;
      letter-spacing:0.04em;
      line-height:1.35;
      user-select:none;
    }

    /* Collapsible primitive modules (the "sections") */
    .module{
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.03);
      overflow:hidden;
    }
    .moduleBar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,0.10);
      cursor:pointer;
      user-select:none;
    }
    .moduleTitle{
      margin:0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.78);
      display:flex;align-items:center;gap:10px;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .caret{
      width:10px;height:10px;
      border-right:1px solid rgba(255,255,255,0.60);
      border-bottom:1px solid rgba(255,255,255,0.60);
      transform:rotate(45deg);
      opacity:0.72;
      margin-left:10px;
      flex:0 0 auto;
    }
    .module.collapsed .caret{transform:rotate(-45deg);}
    .moduleBody{
      padding:12px;
      display:grid;
      gap:10px;
    }
    .module.collapsed .moduleBody{display:none;}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .muted{color:rgba(255,255,255,0.46);font-size:11px;letter-spacing:0.04em;line-height:1.35;}

    /* RIGHT: prompt preview */
    #right{
      border-left:1px solid var(--stroke2);
      background:rgba(0,0,0,0.92);
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    #rightHeader{
      padding:12px;
      border-bottom:1px solid var(--stroke2);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      user-select:none;
    }
    #rightHeader .title{
      margin:0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.78);
      display:flex;align-items:center;gap:10px;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    #promptWrap{
      padding:12px;
      overflow:auto;
      min-height:0;
      display:grid;
      gap:10px;
    }
    pre{
      margin:0;
      padding:12px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.03);
      color:rgba(255,255,255,0.82);
      font-size:11px;
      line-height:1.35;
      letter-spacing:0.04em;
      white-space:pre-wrap;
      word-break:break-word;
    }

    /* SYSTEM NOTE MODAL (free form) — opened by TOP RIGHT SQUARE */
    #noteBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.72);
      display:none;
      z-index:120;
    }
    #noteModal{
      position:absolute; right:16px; top:58px;
      width:min(620px, calc(100% - 32px));
      border:1px solid rgba(255,255,255,0.22);
      background:rgba(0,0,0,0.92);
      box-shadow:0 28px 110px rgba(0,0,0,0.82);
      padding:12px;
    }
    #noteTitle{
      margin:0 0 10px 0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.82);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      user-select:none;
    }

    /* LOAD STATE MODAL */
    #loadBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.72);
      display:none;
      z-index:130;
    }
    #loadModal{
      position:absolute; left:50%; top:84px;
      transform:translateX(-50%);
      width:min(680px, calc(100% - 32px));
      border:1px solid rgba(255,255,255,0.22);
      background:rgba(0,0,0,0.92);
      box-shadow:0 28px 110px rgba(0,0,0,0.82);
      padding:12px;
    }
    #loadTitle{
      margin:0 0 10px 0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.82);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      user-select:none;
    }

    /* Toast */
    #toast{
      position:fixed;
      left:50%;
      top:68px;
      transform:translateX(-50%);
      padding:8px 10px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.72);
      color:rgba(255,255,255,0.65);
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      display:none;
      z-index:200;
    }

    @media (max-width: 1200px){
      #main{grid-template-columns: 340px 1fr 380px;}
      #registryGrid{grid-template-columns: repeat(2, minmax(0,1fr));}
    }
    @media (max-width: 980px){
      #main{grid-template-columns: 1fr;}
      #left{display:none;}
      #right{display:none;}
      #registryGrid{grid-template-columns: repeat(2, minmax(0,1fr));}
    }
  </style>
</head>

<body>
  <div id="topbar">
    <div id="brand">
      <span class="whiteBox" aria-hidden="true"></span>
      <span>KETADATA // PRIMITIVES</span>
    </div>
    <div class="row">
      <button id="exportState" class="btn btnPrimary" type="button">Export State</button>
      <button id="loadState" class="btn" type="button">Load State</button>
      <button id="exportPromptTop" class="btn" type="button">Export Prompt</button>
      <button id="noteIcon" type="button" aria-label="System Note"><span class="whiteBox" aria-hidden="true"></span></button>
    </div>
  </div>

  <div id="main">
    <!-- LEFT -->
    <div id="left">
      <div id="leftHeader">
        <p class="title"><span class="whiteBox" aria-hidden="true"></span> Controls</p>
        <button id="newPrim" class="btn btnPrimary" type="button">New Primitive</button>
      </div>
      <div id="leftBody">
        <div class="field">
          <label for="project">Project</label>
          <input id="project" type="text" />
        </div>

        <div class="field">
          <label for="scopeFilter">Scope Filter</label>
          <select id="scopeFilter">
            <option value="">ALL</option>
            <option>SYSTEM</option>
            <option>ROOM</option>
            <option>INTERFACE</option>
            <option>MODULE</option>
            <option>CONTROL</option>
            <option>NOTE</option>
            <option>STATE</option>
            <option>PROMPT</option>
            <option>ACCESS</option>
            <option>MODE</option>
          </select>
          <div class="hint">Filter what propagates where.</div>
        </div>

        <div class="field">
          <label for="search">Search</label>
          <input id="search" type="text" placeholder="name / tags / scope" />
        </div>

        <div class="field">
          <label>Registry Stats</label>
          <div class="row">
            <span class="pill" id="countPill">0 PRIMITIVES</span>
            <span class="pill" id="activePill">ACTIVE: —</span>
          </div>
          <div class="hint">Tip: collapse modules to scan more primitives at once.</div>
        </div>
      </div>
    </div>

    <!-- CENTER -->
    <div id="center">
      <div id="centerHeader">
        <p class="title">
          <span class="whiteBox" aria-hidden="true"></span>
          <span>Registry</span>
          <span id="activeName" style="color:rgba(255,255,255,0.40);margin-left:6px;"></span>
        </p>
        <div class="row">
          <button id="viewGrid" class="chip on" type="button">Grid</button>
          <button id="viewList" class="chip" type="button">List</button>
          <button id="collapseAll" class="btn" type="button">Collapse All</button>
          <button id="expandAll" class="btn" type="button">Expand All</button>
        </div>
      </div>

      <div id="centerBody">
        <!-- registry cards -->
        <div id="registryGrid"></div>
        <div id="registryList" style="display:none;"></div>

        <!-- editor modules for ACTIVE primitive -->
        <div class="module" data-mod="identity">
          <div class="moduleBar">
            <p class="moduleTitle"><span class="whiteBox" style="width:9px;height:9px;"></span> Identity</p>
            <div class="row"><span class="pill" id="activeScopePill">—</span><span class="caret"></span></div>
          </div>
          <div class="moduleBody">
            <div class="grid2">
              <div class="field" style="margin:0;">
                <label for="primName">Name</label>
                <input id="primName" type="text" />
              </div>
              <div class="field" style="margin:0;">
                <label for="primScope">Scope</label>
                <select id="primScope">
                  <option>SYSTEM</option><option>ROOM</option><option>INTERFACE</option>
                  <option>MODULE</option><option>CONTROL</option><option>NOTE</option>
                  <option>STATE</option><option>PROMPT</option><option>ACCESS</option><option>MODE</option>
                </select>
              </div>
            </div>
            <div class="field" style="margin:0;">
              <label for="primTags">Tags (comma separated)</label>
              <input id="primTags" type="text" />
            </div>
            <div class="muted">Primitive = smallest stable unit across pages/tools.</div>
          </div>
        </div>

        <div class="module" data-mod="definition">
          <div class="moduleBar">
            <p class="moduleTitle"><span class="whiteBox" style="width:9px;height:9px;"></span> Definition</p>
            <span class="caret"></span>
          </div>
          <div class="moduleBody">
            <div class="field" style="margin:0;">
              <label for="primDef">One-line definition</label>
              <input id="primDef" type="text" />
            </div>
            <div class="field" style="margin:0;">
              <label for="primWhy">Why it exists</label>
              <textarea id="primWhy"></textarea>
            </div>
            <div class="muted">If you can’t justify it, it’s not a primitive.</div>
          </div>
        </div>

        <div class="module" data-mod="implementation">
          <div class="moduleBar">
            <p class="moduleTitle"><span class="whiteBox" style="width:9px;height:9px;"></span> Implementation</p>
            <span class="caret"></span>
          </div>
          <div class="moduleBody">
            <div class="field" style="margin:0;">
              <label for="primUI">UI Manifestation</label>
              <textarea id="primUI"></textarea>
            </div>
            <div class="field" style="margin:0;">
              <label for="primRules">Rules (invariants)</label>
              <textarea id="primRules"></textarea>
            </div>
            <div class="grid2">
              <div class="field" style="margin:0;">
                <label for="primAPI">State / Metadata keys</label>
                <input id="primAPI" type="text" />
              </div>
              <div class="field" style="margin:0;">
                <label for="primVersion">Version</label>
                <input id="primVersion" type="text" />
              </div>
            </div>
          </div>
        </div>

        <div class="module" data-mod="semantics">
          <div class="moduleBar">
            <p class="moduleTitle"><span class="whiteBox" style="width:9px;height:9px;"></span> Semantics</p>
            <span class="caret"></span>
          </div>
          <div class="moduleBody">
            <div class="field" style="margin:0;">
              <label for="primSem">Semantics note</label>
              <textarea id="primSem"></textarea>
            </div>
            <div class="muted">System visual language: mind=angular; senses=circular; note=white square.</div>
          </div>
        </div>

        <div class="module" data-mod="actions">
          <div class="moduleBar">
            <p class="moduleTitle"><span class="whiteBox" style="width:9px;height:9px;"></span> Actions</p>
            <span class="caret"></span>
          </div>
          <div class="moduleBody">
            <div class="row">
              <button id="save" class="btn btnPrimary" type="button">Save</button>
              <button id="dup" class="btn" type="button">Duplicate</button>
              <button id="del" class="btn" type="button">Delete</button>
            </div>
            <div class="muted">Collapse modules to scan the registry; expand only what you’re filling.</div>
          </div>
        </div>

      </div>
    </div>

    <!-- RIGHT: prompt preview -->
    <div id="right">
      <div id="rightHeader">
        <p class="title"><span class="whiteBox" aria-hidden="true"></span> Prompt Preview</p>
        <button id="copyPromptRight" class="btn btnPrimary" type="button">Copy Prompt</button>
      </div>
      <div id="promptWrap">
        <pre id="promptPre">—</pre>
        <div class="hint">Prompt updates live from active primitive.</div>
      </div>
    </div>
  </div>

  <!-- SYSTEM NOTE MODAL (free form) -->
  <div id="noteBack" aria-hidden="true">
    <div id="noteModal" role="dialog" aria-label="System Note">
      <div id="noteTitle">
        <span><span class="whiteBox" style="width:9px;height:9px;"></span> SYSTEM NOTE</span>
        <button id="closeNote" class="btn" type="button">Close</button>
      </div>
      <div class="field">
        <label for="systemNote">Free-form note</label>
        <textarea id="systemNote" placeholder="system laws / constraints / reminders"></textarea>
        <div class="hint">This is global. Saved into state. Not tied to any single primitive.</div>
      </div>
      <div class="row">
        <button id="saveNote" class="btn btnPrimary" type="button">Save</button>
        <button id="clearNote" class="btn" type="button">Clear</button>
      </div>
    </div>
  </div>

  <!-- LOAD STATE MODAL -->
  <div id="loadBack" aria-hidden="true">
    <div id="loadModal" role="dialog" aria-label="Load State">
      <div id="loadTitle">
        <span><span class="whiteBox" style="width:9px;height:9px;"></span> LOAD STATE</span>
        <button id="closeLoad" class="btn" type="button">Close</button>
      </div>
      <div class="field">
        <label for="stateInput">Paste state URL or base64</label>
        <textarea id="stateInput" placeholder="Paste exported URL (#state=...) or raw base64."></textarea>
      </div>
      <div class="row">
        <button id="applyState" class="btn btnPrimary" type="button">Apply</button>
        <button id="clearStateInput" class="btn" type="button">Clear</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    // =========================================================
    // Requested fixes:
    // - Top-right white square opens FREE-FORM SYSTEM NOTE modal.
    // - Center is the registry view (grid/list toggle) + editor modules below.
    // - Primitive editor modules are COLLAPSIBLE so user can hide details
    //   and scan the registry (all primitives) at once.
    // =========================================================

    const el = (id)=>document.getElementById(id);
    const uid = ()=>Math.random().toString(36).slice(2, 9)+"-"+Date.now().toString(36);

    const toastEl = el('toast');
    function toast(msg, ms=650){
      toastEl.textContent = msg;
      toastEl.style.display = 'block';
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>{ toastEl.style.display='none'; }, ms);
    }
    async function copyText(s){
      try{ await navigator.clipboard.writeText(s); toast("COPIED"); }
      catch{ window.prompt("Copy:", s); }
    }
    function encode(obj){ return btoa(unescape(encodeURIComponent(JSON.stringify(obj)))); }
    function decode(b64){ return JSON.parse(decodeURIComponent(escape(atob(b64)))); }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (m)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    // Elements
    const projectEl = el('project');
    const scopeFilterEl = el('scopeFilter');
    const searchEl = el('search');

    const countPill = el('countPill');
    const activePill = el('activePill');

    const viewGridBtn = el('viewGrid');
    const viewListBtn = el('viewList');

    const registryGrid = el('registryGrid');
    const registryList = el('registryList');

    const newPrimBtn = el('newPrim');

    const activeNameEl = el('activeName');
    const activeScopePill = el('activeScopePill');

    const primNameEl = el('primName');
    const primScopeEl = el('primScope');
    const primTagsEl = el('primTags');
    const primDefEl = el('primDef');
    const primWhyEl = el('primWhy');
    const primUIEl = el('primUI');
    const primRulesEl = el('primRules');
    const primAPIEl = el('primAPI');
    const primVersionEl = el('primVersion');
    const primSemEl = el('primSem');

    const saveBtn = el('save');
    const dupBtn = el('dup');
    const delBtn = el('del');

    const collapseAllBtn = el('collapseAll');
    const expandAllBtn = el('expandAll');

    const promptPre = el('promptPre');
    const copyPromptRight = el('copyPromptRight');
    const exportPromptTop = el('exportPromptTop');

    const exportStateBtn = el('exportState');
    const loadStateBtn = el('loadState');

    // System note modal
    const noteIcon = el('noteIcon');
    const noteBack = el('noteBack');
    const closeNote = el('closeNote');
    const systemNoteEl = el('systemNote');
    const saveNoteBtn = el('saveNote');
    const clearNoteBtn = el('clearNote');

    // Load modal
    const loadBack = el('loadBack');
    const closeLoad = el('closeLoad');
    const stateInput = el('stateInput');
    const applyStateBtn = el('applyState');
    const clearStateInputBtn = el('clearStateInput');

    function makePrim(){
      return {
        id: uid(),
        name: "NEW_PRIMITIVE",
        scope: "SYSTEM",
        tags: [],
        def: "",
        why: "",
        ui: "",
        rules: "",
        api: "",
        version: "v1",
        semantics: ""
      };
    }

    let state = {
      v: 3,
      project: "KETADATA",
      view: "grid", // grid|list
      primitives: [],
      activeId: null,
      systemNote: "",
      modulesCollapsed: { // remember collapses
        identity: false,
        definition: false,
        implementation: false,
        semantics: false,
        actions: false
      }
    };

    // Load hash
    (function(){
      const m = location.hash.match(/state=([^&]+)/);
      if(!m){
        const p = makePrim();
        p.name = "NOTE_WHITE_SQUARE";
        p.scope = "SYSTEM";
        p.tags = ["angular","mind","export","UI"];
        p.def = "Notes are the universal metadata atom; visible as a white square.";
        p.why = "All pages must emit note metadata; the note entry point is invariant.";
        p.ui = "White square icon (upper right) opens global system note; per-primitive notes handled elsewhere.";
        p.rules = "Must exist on every page; must export; must not be decorative; must support tags + glossary.";
        p.api = "note:{id,title,tags,body,anchors[]}; exportState(); exportPrompt()";
        p.version = "v1";
        p.semantics = "mind=angular; senses=circular; note=white square";
        state.primitives = [p];
        state.activeId = p.id;
        state.systemNote = "SYSTEM NOTE = global free-form. Opens from top-right square.";
        return;
      }
      try{
        const s = decode(m[1]);
        if(s && (s.v === 1 || s.v === 2 || s.v === 3)){
          state = { ...state, ...s, v: 3 };
          state.primitives = state.primitives || [];
          if(!state.primitives.length){
            const p = makePrim();
            state.primitives = [p];
            state.activeId = p.id;
          }
          state.activeId = state.activeId || state.primitives[0].id;
          state.modulesCollapsed = state.modulesCollapsed || {
            identity:false,definition:false,implementation:false,semantics:false,actions:false
          };
        }
      }catch{
        const p = makePrim();
        state.primitives = [p];
        state.activeId = p.id;
      }
    })();

    function activePrim(){
      return state.primitives.find(p=>p.id===state.activeId) || state.primitives[0];
    }

    function commitEditorToPrim(){
      const p = activePrim();
      p.name = primNameEl.value.trim() || "UNNAMED_PRIMITIVE";
      p.scope = primScopeEl.value;
      p.tags = primTagsEl.value.split(",").map(s=>s.trim()).filter(Boolean);
      p.def = primDefEl.value.trim();
      p.why = primWhyEl.value;
      p.ui = primUIEl.value;
      p.rules = primRulesEl.value;
      p.api = primAPIEl.value.trim();
      p.version = primVersionEl.value.trim() || "v1";
      p.semantics = primSemEl.value;
    }

    function syncEditor(){
      const p = activePrim();
      activeNameEl.textContent = p.name ? ("// " + p.name) : "";
      activeScopePill.textContent = p.scope || "—";
      activePill.textContent = "ACTIVE: " + (p.name || "—");
      countPill.textContent = state.primitives.length + " PRIMITIVES";

      primNameEl.value = p.name || "";
      primScopeEl.value = p.scope || "SYSTEM";
      primTagsEl.value = (p.tags || []).join(", ");
      primDefEl.value = p.def || "";
      primWhyEl.value = p.why || "";
      primUIEl.value = p.ui || "";
      primRulesEl.value = p.rules || "";
      primAPIEl.value = p.api || "";
      primVersionEl.value = p.version || "v1";
      primSemEl.value = p.semantics || "";

      projectEl.value = state.project || "KETADATA";
      systemNoteEl.value = state.systemNote || "";
    }

    function filteredPrimitives(){
      const q = searchEl.value.trim().toLowerCase();
      const scopeF = scopeFilterEl.value;
      return state.primitives.filter(p=>{
        if(scopeF && p.scope !== scopeF) return false;
        if(!q) return true;
        const blob = [
          p.name, p.scope, (p.tags||[]).join(" "),
          p.def, p.why, p.ui, p.rules, p.api, p.version, p.semantics
        ].join(" ").toLowerCase();
        return blob.includes(q);
      });
    }

    function renderRegistry(){
      const items = filteredPrimitives();

      viewGridBtn.classList.toggle('on', state.view === 'grid');
      viewListBtn.classList.toggle('on', state.view === 'list');

      registryGrid.style.display = (state.view === 'grid') ? 'grid' : 'none';
      registryList.style.display = (state.view === 'list') ? 'grid' : 'none';

      const buildCard = (p)=>{
        const d = document.createElement('div');
        d.className = "primCard" + (p.id===state.activeId ? " active" : "");
        d.innerHTML = `
          <div class="primTop">
            <div class="primName">${escapeHtml(p.name || "UNNAMED")}</div>
            <div class="pill">${escapeHtml(p.scope || "—")}</div>
          </div>
          <div class="row">
            <span class="pill">${escapeHtml(p.version || "v1")}</span>
            <span class="pill">${(p.tags||[]).length} TAGS</span>
          </div>
          <div class="mini">${escapeHtml(p.def || "—")}</div>
        `;
        d.addEventListener('click', ()=>{
          commitEditorToPrim();
          state.activeId = p.id;
          syncEditor();
          renderRegistry();
          renderPromptPreview();
        });
        return d;
      };

      registryGrid.innerHTML = "";
      registryList.innerHTML = "";
      items.forEach(p=>{
        const card = buildCard(p);
        if(state.view === 'grid') registryGrid.appendChild(card);
        else registryList.appendChild(card);
      });

      countPill.textContent = state.primitives.length + " PRIMITIVES";
    }

    // Collapsible modules
    function setModuleCollapsed(key, collapsed){
      state.modulesCollapsed[key] = !!collapsed;
      const mod = document.querySelector(`.module[data-mod="${key}"]`);
      if(!mod) return;
      mod.classList.toggle('collapsed', state.modulesCollapsed[key]);
    }
    function syncModuleCollapsed(){
      Object.keys(state.modulesCollapsed).forEach(k=> setModuleCollapsed(k, state.modulesCollapsed[k]));
    }

    document.querySelectorAll('.module').forEach(mod=>{
      const key = mod.getAttribute('data-mod');
      const bar = mod.querySelector('.moduleBar');
      bar.addEventListener('click', (e)=>{
        // don't toggle when clicking inside inputs (none exist in bar anyway)
        state.modulesCollapsed[key] = !state.modulesCollapsed[key];
        mod.classList.toggle('collapsed', state.modulesCollapsed[key]);
      });
    });

    collapseAllBtn.addEventListener('click', ()=>{
      Object.keys(state.modulesCollapsed).forEach(k=> state.modulesCollapsed[k]=true);
      syncModuleCollapsed();
      toast("COLLAPSED");
    });
    expandAllBtn.addEventListener('click', ()=>{
      Object.keys(state.modulesCollapsed).forEach(k=> state.modulesCollapsed[k]=false);
      syncModuleCollapsed();
      toast("EXPANDED");
    });

    // Prompt preview
    function buildPrompt(){
      commitEditorToPrim();
      const p = activePrim();
      const payload = {
        system: "KETADATA",
        page: "primitives-registry",
        project: state.project,
        view: state.view,
        activePrimitive: p,
        modulesCollapsed: state.modulesCollapsed,
        systemNote: state.systemNote || ""
      };
      return [
        "KETADATA PRIMITIVES / PROMPT",
        "RULES:",
        "- Top-right white square opens free-form SYSTEM NOTE modal.",
        "- Center is registry grid/list. Default = grid.",
        "- Primitive editor sections are collapsible; collapse to scan registry.",
        "",
        `PROJECT: ${state.project}`,
        `ACTIVE: ${p.name} (${p.scope})`,
        "",
        "SYSTEM NOTE:",
        state.systemNote ? state.systemNote : "(none)",
        "",
        "STATE(JSON):",
        JSON.stringify(payload, null, 2)
      ].join("\\n");
    }
    function renderPromptPreview(){
      promptPre.textContent = buildPrompt();
    }

    // Export / Load
    function exportState(){
      commitEditorToPrim();
      const safe = JSON.parse(JSON.stringify(state));
      const b64 = encode(safe);
      const url = location.origin + location.pathname + "#state=" + b64;
      return { safe, url };
    }

    function showLoad(){
      loadBack.style.display = 'block';
      loadBack.setAttribute('aria-hidden','false');
      stateInput.value = "";
      setTimeout(()=>stateInput.focus(), 0);
    }
    function hideLoad(){
      loadBack.style.display = 'none';
      loadBack.setAttribute('aria-hidden','true');
    }
    function applyStateFromText(txt){
      const t = (txt||"").trim();
      if(!t){ toast("EMPTY"); return; }
      let b64 = t;
      const m = t.match(/#state=([^&\\s]+)/);
      if(m) b64 = m[1];
      try{
        const s = decode(b64);
        if(!s || (s.v !== 1 && s.v !== 2 && s.v !== 3)) throw new Error("bad");
        state = { ...state, ...s, v: 3 };
        state.primitives = state.primitives || [];
        if(!state.primitives.length){
          const p = makePrim();
          state.primitives = [p];
          state.activeId = p.id;
        }
        state.activeId = state.activeId || state.primitives[0].id;
        state.modulesCollapsed = state.modulesCollapsed || {identity:false,definition:false,implementation:false,semantics:false,actions:false};
        toast("LOADED");
        location.hash = "state=" + b64;
        renderAll();
        hideLoad();
      }catch{
        toast("INVALID");
      }
    }

    // System note modal
    function showSystemNote(){
      noteBack.style.display = 'block';
      noteBack.setAttribute('aria-hidden','false');
      systemNoteEl.value = state.systemNote || "";
      setTimeout(()=>systemNoteEl.focus(), 0);
    }
    function hideSystemNote(){
      noteBack.style.display = 'none';
      noteBack.setAttribute('aria-hidden','true');
    }

    // Events
    projectEl.addEventListener('input', ()=>{
      state.project = projectEl.value;
      renderPromptPreview();
    });
    scopeFilterEl.addEventListener('change', renderRegistry);
    searchEl.addEventListener('input', renderRegistry);

    viewGridBtn.addEventListener('click', ()=>{
      state.view = "grid";
      renderRegistry();
      renderPromptPreview();
    });
    viewListBtn.addEventListener('click', ()=>{
      state.view = "list";
      renderRegistry();
      renderPromptPreview();
    });

    newPrimBtn.addEventListener('click', ()=>{
      commitEditorToPrim();
      const p = makePrim();
      state.primitives.unshift(p);
      state.activeId = p.id;
      syncEditor();
      renderRegistry();
      renderPromptPreview();
      toast("NEW");
    });

    saveBtn.addEventListener('click', ()=>{
      commitEditorToPrim();
      renderRegistry();
      renderPromptPreview();
      toast("SAVED");
    });

    dupBtn.addEventListener('click', ()=>{
      commitEditorToPrim();
      const p = activePrim();
      const copy = JSON.parse(JSON.stringify(p));
      copy.id = uid();
      copy.name = (p.name || "PRIMITIVE") + "_COPY";
      state.primitives.unshift(copy);
      state.activeId = copy.id;
      renderAll();
      toast("DUP");
    });

    delBtn.addEventListener('click', ()=>{
      if(state.primitives.length <= 1){ toast("KEEP ONE"); return; }
      const id = state.activeId;
      state.primitives = state.primitives.filter(p=>p.id !== id);
      state.activeId = state.primitives[0].id;
      renderAll();
      toast("DELETED");
    });

    exportStateBtn.addEventListener('click', async ()=>{
      const { url } = exportState();
      await copyText(url);
      location.hash = url.split("#")[1];
    });
    loadStateBtn.addEventListener('click', showLoad);

    exportPromptTop.addEventListener('click', async ()=>{
      await copyText(buildPrompt());
    });
    copyPromptRight.addEventListener('click', async ()=>{
      await copyText(buildPrompt());
    });

    noteIcon.addEventListener('click', showSystemNote);
    el('closeNote').addEventListener('click', hideSystemNote);
    noteBack.addEventListener('click', (e)=>{ if(e.target===noteBack) hideSystemNote(); });

    saveNoteBtn.addEventListener('click', ()=>{
      state.systemNote = systemNoteEl.value;
      toast("SAVED");
      renderPromptPreview();
      hideSystemNote();
    });
    clearNoteBtn.addEventListener('click', ()=>{
      state.systemNote = "";
      systemNoteEl.value = "";
      toast("CLEARED");
      renderPromptPreview();
    });

    closeLoad.addEventListener('click', hideLoad);
    loadBack.addEventListener('click', (e)=>{ if(e.target===loadBack) hideLoad(); });
    applyStateBtn.addEventListener('click', ()=> applyStateFromText(stateInput.value));
    clearStateInputBtn.addEventListener('click', ()=> stateInput.value = "");

    // keyboard
    window.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){
        if(noteBack.style.display === 'block') hideSystemNote();
        if(loadBack.style.display === 'block') hideLoad();
      }
      // quick collapse/expand
      if((e.key === 'k' || e.key === 'K') && (e.metaKey || e.ctrlKey)){
        Object.keys(state.modulesCollapsed).forEach(k=> state.modulesCollapsed[k]=true);
        syncModuleCollapsed();
        toast("COLLAPSED");
      }
      if((e.key === 'j' || e.key === 'J') && (e.metaKey || e.ctrlKey)){
        Object.keys(state.modulesCollapsed).forEach(k=> state.modulesCollapsed[k]=false);
        syncModuleCollapsed();
        toast("EXPANDED");
      }
    });

    function renderAll(){
      syncEditor();
      renderRegistry();
      syncModuleCollapsed();
      renderPromptPreview();
    }

    // init
    renderAll();
  </script>
</body>
</html>
