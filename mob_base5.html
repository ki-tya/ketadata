<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="theme-color" content="#000000" />
<title>KETADATA // COMBINED</title>

<style>
:root{
  --bg:#000;
  --fg:#fff;
  --muted:#8a8a8a;
  --line:#222;
  --line2:#333;
  
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  
  --nav-h: 60px;
  --corner-btn: 44px;
}

*{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
html,body{height:100%; margin:0; overflow:hidden}
body{
  background:var(--bg);
  color:var(--fg);
  font-family:var(--mono);
  font-size:13px;
  letter-spacing:.04em;
  touch-action:pan-y;
  overscroll-behavior:none;
}

/* ROOT */
#root{
  position:fixed;
  inset:0;
  display:flex;
  flex-direction:column;
  background:#000;
}
#root.invert{filter:invert(1)}

/* STAGE */
#stage{
  position:fixed;
  inset:0;
  background:#000;
  pointer-events:none;
  z-index:999;
  display:none;
}
#stage.active{display:block}

/* SURFACE PLAYER */
#surfaceFrame{
  position:fixed;
  inset:0;
  width:100%;
  height:100%;
  border:0;
  background:#000;
  display:none;
  z-index:1;
}
#surfaceFrame.active{display:block}

/* MAIN CONTENT */
.main{
  flex:1;
  overflow:hidden;
  position:relative;
}

.content{
  position:absolute;
  inset:0;
  overflow-y:auto;
  overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
  display:none;
  padding:12px;
  padding-top:calc(var(--corner-btn) + 20px);
  padding-bottom:calc(var(--nav-h) + 12px);
}
.content.active{display:block}

/* CORNER CONTROLS */
.corner-btn{
  position:fixed;
  width:var(--corner-btn);
  height:var(--corner-btn);
  border:1px solid var(--line2);
  background:rgba(0,0,0,.9);
  backdrop-filter:blur(6px);
  color:var(--fg);
  font-size:9px;
  font-family:var(--mono);
  letter-spacing:.06em;
  text-transform:uppercase;
  line-height:1.2;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  cursor:pointer;
  z-index:100;
  transition:all .15s;
}
.corner-btn:active{
  transform:scale(.95);
  border-color:var(--fg);
}
.corner-btn.active{
  background:rgba(255,255,255,.1);
  border-color:var(--fg);
}

#btnMine{top:10px; left:10px}
#btnNote{top:10px; right:10px}
#btnInvert{bottom:calc(var(--nav-h) + 10px); left:10px}
#btnNull{bottom:calc(var(--nav-h) + 10px); right:10px}

/* BOTTOM NAV */
.nav{
  height:var(--nav-h);
  border-top:1px solid var(--line);
  background:linear-gradient(0deg,#0a0a0a,#000);
  display:flex;
  align-items:stretch;
  flex-shrink:0;
  z-index:90;
}
.nav-btn{
  flex:1;
  border:0;
  border-right:1px solid var(--line);
  background:transparent;
  color:var(--muted);
  font-family:var(--mono);
  font-size:10px;
  letter-spacing:.10em;
  text-transform:uppercase;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;
  cursor:pointer;
  transition:color .15s;
}
.nav-btn:last-child{border-right:0}
.nav-btn.active{
  color:var(--fg);
  background:rgba(255,255,255,.05);
}
.nav-btn:active{
  background:rgba(255,255,255,.1);
}
.nav-icon{
  font-size:18px;
  line-height:1;
}

/* KETA NOTE */
.note-panel{
  position:fixed;
  top:calc(var(--corner-btn) + 20px);
  right:10px;
  width:min(92vw, 400px);
  max-height:calc(100vh - var(--corner-btn) - var(--nav-h) - 40px);
  border:1px solid rgba(255,255,255,0.22);
  background:rgba(0,0,0,.95);
  backdrop-filter:blur(6px);
  display:none;
  flex-direction:column;
  z-index:110;
}
.note-panel.active{display:flex}
.note-head{
  padding:10px 12px;
  border-bottom:1px solid var(--line);
  font-size:11px;
  letter-spacing:.10em;
  text-transform:uppercase;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.note-body{
  flex:1;
  padding:10px;
  min-height:120px;
  overflow:auto;
}
.note-panel textarea{
  width:100%;
  height:100%;
  min-height:120px;
  background:#000;
  color:#fff;
  border:1px solid var(--line2);
  padding:10px;
  font-family:var(--mono);
  font-size:12px;
  resize:none;
  outline:none;
}

/* CATEGORIES */
.category{
  border:1px solid var(--line2);
  margin-bottom:12px;
  background:rgba(255,255,255,.02);
}
.cat-header{
  padding:12px;
  border-bottom:1px solid var(--line);
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:11px;
  letter-spacing:.10em;
  text-transform:uppercase;
  cursor:pointer;
  min-height:var(--corner-btn);
}
.cat-header:active{background:rgba(255,255,255,.05)}
.cat-count{
  color:var(--muted);
  font-size:10px;
}
.cat-body{
  display:none;
  padding:8px;
  max-height:400px;
  overflow-y:auto;
}
.cat-body.open{display:block}

/* LINK ITEMS */
.link-item{
  min-height:var(--corner-btn);
  border:1px solid var(--line2);
  padding:10px 12px;
  margin-bottom:6px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  cursor:pointer;
}
.link-item:active{
  border-color:var(--fg);
  background:rgba(255,255,255,.08);
}
.link-name{
  flex:1;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  font-size:12px;
  letter-spacing:.06em;
}
.link-actions{
  display:flex;
  gap:4px;
  flex-shrink:0;
}
.mini-btn{
  width:32px;
  height:32px;
  border:1px solid var(--line2);
  background:#000;
  color:var(--fg);
  font-size:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  font-family:var(--mono);
}
.mini-btn:active{
  border-color:var(--fg);
  transform:scale(.95);
}

/* SEARCH */
.search-box{
  margin-bottom:12px;
  position:sticky;
  top:0;
  background:#000;
  z-index:10;
  padding-bottom:8px;
}
.search-input{
  width:100%;
  min-height:var(--corner-btn);
  background:#000;
  border:1px solid var(--line2);
  color:var(--fg);
  font-family:var(--mono);
  font-size:13px;
  padding:0 12px;
  letter-spacing:.06em;
}
.search-input:focus{
  outline:none;
  border-color:var(--fg);
}

/* LIGHTS PANEL */
.lights-panel{
  padding:12px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,.9);
  margin-bottom:12px;
}
.lights-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
  margin-bottom:8px;
}
.light-btn{
  min-height:var(--corner-btn);
  border:1px solid var(--line2);
  background:#000;
  color:var(--fg);
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.08em;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
.light-btn.active{
  border-color:var(--fg);
  background:rgba(255,255,255,.1);
}
.light-btn:active{
  transform:scale(.95);
}

/* SYSTEM PANEL */
.system-panel{
  padding:12px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,.9);
  margin-bottom:12px;
}
.btn{
  width:100%;
  min-height:var(--corner-btn);
  padding:0 16px;
  border:1px solid var(--line2);
  background:#000;
  color:var(--fg);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
  cursor:pointer;
  margin-bottom:8px;
}
.btn:active{
  border-color:var(--fg);
  transform:scale(.98);
}

/* TOAST */
.toast{
  position:fixed;
  top:calc(var(--corner-btn) + 20px);
  left:50%;
  transform:translateX(-50%);
  padding:10px 16px;
  background:rgba(0,0,0,.95);
  border:1px solid var(--fg);
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
  z-index:120;
  display:none;
  white-space:nowrap;
}

.empty-state{
  text-align:center;
  padding:40px 20px;
  color:var(--muted);
  font-size:12px;
  letter-spacing:.06em;
}

.hidden{display:none !important}
</style>
</head>

<body>
<div id="root">
  <!-- STAGE -->
  <div id="stage"></div>

  <!-- SURFACE PLAYER -->
  <iframe id="surfaceFrame" title="SURFACE"></iframe>

  <!-- CORNER CONTROLS -->
  <button class="corner-btn" id="btnMine">KETA<br/>MINE</button>
  <button class="corner-btn" id="btnNote">KETA<br/>NOTE</button>
  <button class="corner-btn" id="btnInvert">INVERT</button>
  <button class="corner-btn" id="btnNull">NULL</button>

  <!-- KETA NOTE -->
  <div class="note-panel" id="notePanel">
    <div class="note-head">
      <span>KETA_NOTE</span>
      <button class="mini-btn" id="btnCloseNote">X</button>
    </div>
    <div class="note-body">
      <textarea id="noteText" placeholder="GLOBAL NOTE" spellcheck="false"></textarea>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main">
    <!-- PLAYER TAB -->
    <div class="content active" id="contentPlayer">
      <div class="search-box">
        <input type="text" class="search-input" id="searchInput" placeholder="SEARCH LINKS..." />
      </div>
      <div id="categoriesContainer"></div>
    </div>

    <!-- LIGHTS TAB -->
    <div class="content" id="contentLights">
      <div class="lights-panel">
        <div style="margin-bottom:12px; font-size:11px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted)">LIGHT PRESETS</div>
        <div class="lights-grid">
          <button class="light-btn" data-light="1">L1</button>
          <button class="light-btn" data-light="2">L2</button>
          <button class="light-btn" data-light="3">L3</button>
          <button class="light-btn" data-light="4">L4</button>
          <button class="light-btn" data-light="5">L5</button>
          <button class="light-btn" data-light="6">L6</button>
        </div>
        <button class="btn" id="btnRun">RUN</button>
        <button class="btn" id="btnStop">STOP</button>
      </div>
      
      <div class="empty-state">
        TAP PRESET TO SELECT<br/>
        RUN TO START SEQUENCE<br/>
        SPACE = TOGGLE
      </div>
    </div>

    <!-- SYSTEM TAB -->
    <div class="content" id="contentSystem">
      <div class="system-panel">
        <div style="margin-bottom:12px; font-size:11px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted)">SYSTEM</div>
        <button class="btn" id="btnExport">EXPORT STATE</button>
        <button class="btn" id="btnImport">IMPORT STATE</button>
        <button class="btn" id="btnClear">CLEAR STATE</button>
        <button class="btn" id="btnStopSurface">STOP SURFACE</button>
      </div>
      
      <div class="empty-state">
        KETA_COMBINED v1.0<br/>
        UNIFIED INTERFACE<br/>
        LOCAL-FIRST STORAGE
      </div>
    </div>
  </div>

  <!-- BOTTOM NAV -->
  <div class="nav">
    <button class="nav-btn active" data-tab="player">
      <span class="nav-icon">⚡</span>
      <span>PLAYER</span>
    </button>
    <button class="nav-btn" data-tab="lights">
      <span class="nav-icon">◉</span>
      <span>LIGHTS</span>
    </button>
    <button class="nav-btn" data-tab="system">
      <span class="nav-icon">⚙</span>
      <span>SYSTEM</span>
    </button>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast"></div>

  <input type="file" id="fileInput" accept="application/json" style="display:none" />
</div>

<script>
// ===== UTILITIES =====
const $=(id)=>document.getElementById(id);
function toast(msg,dur=1200){
  const t=$("toast");
  t.textContent=String(msg||"");
  t.style.display="block";
  setTimeout(()=>{t.style.display="none";},dur);
}
async function copy(text){
  try{
    await navigator.clipboard.writeText(String(text||""));
    toast("COPIED");
  }catch(e){
    toast("COPY FAILED");
  }
}
function hash8(str){
  const s=String(str||"");
  let h=2166136261;
  for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,16777619);}
  return (h>>>0).toString(16).slice(0,8);
}

// ===== DATA =====
const CATEGORIES=[
  {
    name:"LATEST (TENNIS & CATBALL)",
    links:[
      "catball.html","catball1.html","ktball.html","ktball1.html",
      "serve.html","serve1.html","serve2.html",
      "tball.html","tball1.html","tball2.html","tball3.html","tball4.html","tball5.html","tball6.html","tball7.html",
      "tennisball.html","tennisball0.html","tennisball2.html","tennisball3.html","tennisball4.html","tennisball5.html",
      "tennisball6.html","tennisball7.html","tennisball8.html","tennisball9.html","tennisball10.html","tennisball11.html",
      "tennisball12.html","tennisball13.html","tennisball14.html","tennisball15.html","tennisball16.html","tennisball91.html",
      "tennisball666.html","tenniscourt.html"
    ]
  },
  {
    name:"KETADATA / SYSTEM SEMANTICS",
    links:[
      "2812.html","depth.html","drugprotocol.html","fivethirtysix.html","intra.html","kmas.html",
      "memofest0.html","memofesto1.html","memofesto11.html","memofesto22.html",
      "metadata.html","metadata1.html","sur_base2.html"
    ]
  },
  {
    name:"KETA-CORE (PARTY ENTRANCE / MAIN)",
    links:[
      "anniversary1.html","anniversary11.html","anniversary111.html","aniversary1111.html",
      "crunch1.html","index.html","index11.html","index013.html","index_copy.html",
      "kdtv1.html","lib_gpt.html","liminal11.html","map.html","memofesto.html",
      "mirror.html","mirror1.html","obscura.html","room.html","screen6.html","thing.html"
    ]
  },
  {
    name:"BLEAK-TECH",
    links:[
      "67.html","ball.html","beatball.html","blacklotus2.html","bleak.html",
      "cashapp1.html","cashapp3.html","chakra.html"
    ]
  },
  {
    name:"CORE-UTIL (TOOLS & FRAMEWORKS)",
    links:[
      "acid_doc.html","board.htm","board1.htm","board2.html","board3.html","calendar1.html",
      "cctv1.html","circle.html","color1.html","color3.html","color5.html","compiler.html",
      "contextifier.htm","controller.html","controller1.html","controller2.html","controller3.html",
      "darkroom1.html","doc2.html","doc6.html","editor.html","font.html","libra.html",
      "manifest5.html","modern.html","pdf2jpeg7.htm","pdf2jpeg8.html","pdfreader.html",
      "pdfreader1.html","popsplit.html","prompt1.html","prompt3.html","router1.html",
      "sensory3.html","sheets.html","socials3.html","storage1.html","studio.html",
      "studiov1.html","surface1.html","to-do2.html","vidlist.html","wordbowl.html"
    ]
  }
];

// ===== STATE =====
const STORAGE_KEY="KETADATA_COMBINED_v1";
let STATE={
  note:"",
  invert:false,
  blackout:false,
  lightPreset:1,
  lightRunning:false,
  surfaceActive:false,
  surfaceUrl:"",
  noteOpen:false,
  recentLinks:[]
};

function loadState(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(raw){
      const loaded=JSON.parse(raw);
      STATE={...STATE,...loaded};
    }
  }catch(e){}
}

function saveState(){
  try{
    localStorage.setItem(STORAGE_KEY,JSON.stringify(STATE));
  }catch(e){}
}

// ===== SURFACE =====
function playSurface(url,name){
  const u=String(url||"").trim();
  if(!u)return;
  
  STATE.surfaceActive=true;
  STATE.surfaceUrl=u;
  
  const frame=$("surfaceFrame");
  frame.classList.add("active");
  frame.src=u;
  
  // Hide all content
  document.querySelectorAll('.content').forEach(el=>el.classList.remove('active'));
  
  // Add to recent
  const idx=STATE.recentLinks.findIndex(r=>r.url===u);
  if(idx>=0)STATE.recentLinks.splice(idx,1);
  STATE.recentLinks.unshift({name:String(name||""),url:u,ts:Date.now()});
  if(STATE.recentLinks.length>20)STATE.recentLinks.length=20;
  
  saveState();
  toast("SURFACE ACTIVE");
}

function stopSurface(){
  STATE.surfaceActive=false;
  STATE.surfaceUrl="";
  
  const frame=$("surfaceFrame");
  frame.classList.remove("active");
  frame.removeAttribute("src");
  
  // Restore active tab
  const tab=document.querySelector('.nav-btn.active');
  if(tab){
    switchTab(tab.dataset.tab);
  }
  
  saveState();
  toast("SURFACE STOPPED");
}

// ===== LIGHTS =====
let lightInterval=null;
let lightCount=0;

function stopLight(){
  if(lightInterval){
    clearInterval(lightInterval);
    lightInterval=null;
  }
  STATE.lightRunning=false;
  const stage=$("stage");
  stage.classList.remove("active");
  stage.style.backgroundColor="#000";
  stage.style.filter="none";
  saveState();
}

function startLight(preset){
  stopLight();
  
  STATE.lightPreset=Number(preset)||1;
  STATE.lightRunning=true;
  
  const stage=$("stage");
  stage.classList.add("active");
  lightCount=0;
  
  if(preset===1){
    // Strobe
    lightInterval=setInterval(()=>{
      const curr=stage.style.backgroundColor||"black";
      stage.style.backgroundColor=(curr==="black"||curr==="rgb(0, 0, 0)")?"white":"black";
    },50);
  }else if(preset===2){
    // Rainbow
    let hue=0,wave=0;
    lightInterval=setInterval(()=>{
      hue=(hue+30)%360;
      wave+=0.5;
      const l=50+Math.sin(wave)*40;
      stage.style.backgroundColor=`hsl(${hue},100%,${l}%)`;
    },10);
  }else if(preset===3){
    // Chaos beat
    lightInterval=setInterval(()=>{
      lightCount++;
      const beat=lightCount%16;
      if(beat===0||beat===1){
        stage.style.backgroundColor="#fff";
        stage.style.filter="invert(1) contrast(3)";
      }else if(beat===2){
        stage.style.backgroundColor="#000";
        stage.style.filter="invert(1) contrast(2)";
      }else if(beat===3){
        stage.style.backgroundColor="#0f0";
        stage.style.filter="contrast(2) saturate(3)";
      }else if(beat<8){
        stage.style.backgroundColor="#0ff";
        stage.style.filter="invert(0.7) contrast(2)";
      }else{
        stage.style.backgroundColor="#08f";
        stage.style.filter="contrast(1.5)";
      }
    },30);
  }else if(preset===4){
    // Red pulse
    let phase=0;
    lightInterval=setInterval(()=>{
      phase+=0.08;
      lightCount++;
      const red=Math.abs(Math.sin(phase))*255;
      const pulse=Math.abs(Math.sin(phase*0.5));
      if(lightCount%8===0){
        stage.style.backgroundColor="#000";
        stage.style.filter="brightness(3)";
      }else{
        stage.style.backgroundColor=`rgb(${red},0,0)`;
        stage.style.filter=`contrast(${2+pulse*2}) saturate(${4+pulse*2})`;
      }
    },20);
  }else if(preset===5){
    // Purple spiral
    let angle=0,cycle=0;
    lightInterval=setInterval(()=>{
      angle+=15;
      cycle=(cycle+2)%100;
      const hue=260+Math.sin(angle*0.1)*40;
      const sat=80+Math.cos(angle*0.05)*20;
      const light=30+Math.sin(cycle*0.1)*30;
      stage.style.backgroundColor=`hsl(${hue},${sat}%,${light}%)`;
      stage.style.filter=`contrast(${1.5+Math.abs(Math.cos(angle*0.08))})`;
    },25);
  }else if(preset===6){
    // Lightning
    lightInterval=setInterval(()=>{
      lightCount++;
      if(lightCount%50===0||lightCount%50===2){
        stage.style.backgroundColor="#fff";
        stage.style.filter="brightness(5)";
      }else{
        stage.style.backgroundColor="#000";
        stage.style.filter="none";
      }
    },30);
  }
  
  saveState();
  updateLightUI();
  toast(`LIGHT ${preset} RUNNING`);
}

function updateLightUI(){
  document.querySelectorAll('.light-btn').forEach(btn=>{
    btn.classList.toggle('active',Number(btn.dataset.light)===STATE.lightPreset);
  });
}

// ===== RENDER =====
function renderCategories(){
  const container=$("categoriesContainer");
  container.innerHTML="";
  
  const searchTerm=$("searchInput").value.toLowerCase().trim();
  
  CATEGORIES.forEach((cat)=>{
    let filteredLinks=cat.links;
    
    if(searchTerm){
      filteredLinks=cat.links.filter(link=>
        link.toLowerCase().includes(searchTerm)
      );
      if(filteredLinks.length===0)return;
    }
    
    const catEl=document.createElement("div");
    catEl.className="category";
    
    const header=document.createElement("div");
    header.className="cat-header";
    header.innerHTML=`
      <span>${cat.name}</span>
      <span class="cat-count">${filteredLinks.length}</span>
    `;
    
    const body=document.createElement("div");
    body.className="cat-body";
    
    filteredLinks.forEach(link=>{
      const item=document.createElement("div");
      item.className="link-item";
      
      const name=document.createElement("div");
      name.className="link-name";
      name.textContent=link.replace(".html","").toUpperCase();
      
      const actions=document.createElement("div");
      actions.className="link-actions";
      
      const surfBtn=document.createElement("button");
      surfBtn.className="mini-btn";
      surfBtn.textContent="▶";
      surfBtn.title="PLAY";
      surfBtn.onclick=(e)=>{
        e.stopPropagation();
        playSurface(link,link.replace(".html",""));
      };
      
      actions.appendChild(surfBtn);
      
      item.onclick=()=>{
        playSurface(link,link.replace(".html",""));
      };
      
      item.appendChild(name);
      item.appendChild(actions);
      body.appendChild(item);
    });
    
    header.onclick=()=>{
      body.classList.toggle("open");
    };
    
    // Auto-open if searching
    if(searchTerm){
      body.classList.add("open");
    }
    
    catEl.appendChild(header);
    catEl.appendChild(body);
    container.appendChild(catEl);
  });
  
  if(container.children.length===0){
    const empty=document.createElement("div");
    empty.className="empty-state";
    empty.textContent="NO MATCHES";
    container.appendChild(empty);
  }
}

function switchTab(tabName){
  document.querySelectorAll('.nav-btn').forEach(btn=>{
    btn.classList.toggle('active',btn.dataset.tab===tabName);
  });
  
  if(STATE.surfaceActive){
    document.querySelectorAll('.content').forEach(el=>el.classList.remove('active'));
  }else{
    $("contentPlayer").classList.toggle("active",tabName==="player");
    $("contentLights").classList.toggle("active",tabName==="lights");
    $("contentSystem").classList.toggle("active",tabName==="system");
  }
}

// ===== EXPORT/IMPORT =====
function exportState(){
  const blob=JSON.stringify(STATE,null,2);
  const url=URL.createObjectURL(new Blob([blob],{type:"application/json"}));
  const a=document.createElement("a");
  a.href=url;
  a.download=`keta_combined_${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast("EXPORTED");
}

function importState(){
  $("fileInput").click();
}

function clearState(){
  if(!confirm("CLEAR ALL STATE?"))return;
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
}

// ===== INIT =====
function init(){
  loadState();
  renderCategories();
  updateLightUI();
  
  // Update invert state
  if(STATE.invert){
    $("root").classList.add("invert");
    $("btnInvert").classList.add("active");
  }
  
  // Update note
  $("noteText").value=STATE.note||"";
  if(STATE.noteOpen){
    $("notePanel").classList.add("active");
    $("btnNote").classList.add("active");
  }
  
  // Nav
  document.querySelectorAll('.nav-btn').forEach(btn=>{
    btn.onclick=()=>switchTab(btn.dataset.tab);
  });
  
  // Corner buttons
  $("btnMine").onclick=()=>{
    window.location.href="index.html";
  };
  
  $("btnNote").onclick=()=>{
    STATE.noteOpen=!STATE.noteOpen;
    $("notePanel").classList.toggle("active",STATE.noteOpen);
    $("btnNote").classList.toggle("active",STATE.noteOpen);
    saveState();
  };
  
  $("btnCloseNote").onclick=()=>{
    STATE.noteOpen=false;
    $("notePanel").classList.remove("active");
    $("btnNote").classList.remove("active");
    saveState();
  };
  
  $("btnInvert").onclick=()=>{
    STATE.invert=!STATE.invert;
    $("root").classList.toggle("invert",STATE.invert);
    $("btnInvert").classList.toggle("active",STATE.invert);
    saveState();
    toast(STATE.invert?"INVERTED":"NORMAL");
  };
  
  $("btnNull").onclick=()=>{
    STATE.blackout=!STATE.blackout;
    if(STATE.blackout){
      // Enter NULL: black screen, hide everything
      stopLight();
      stopSurface();
      document.body.style.background="#000";
      document.querySelectorAll('.corner-btn, .nav, .content, .note-panel').forEach(el=>el.style.display="none");
      $("btnNull").style.display="flex";
      $("btnNull").style.background="rgba(255,255,255,.1)";
      toast("NULL MODE");
    }else{
      // Exit NULL: restore
      document.body.style.background="";
      document.querySelectorAll('.corner-btn, .nav').forEach(el=>el.style.display="");
      $("btnNull").style.background="";
      const tab=document.querySelector('.nav-btn.active');
      if(tab)switchTab(tab.dataset.tab);
      toast("EXIT NULL");
    }
    $("btnNull").classList.toggle("active",STATE.blackout);
    saveState();
  };
  
  // Search
  $("searchInput").oninput=()=>renderCategories();
  
  // Note
  $("noteText").oninput=()=>{
    STATE.note=$("noteText").value;
    saveState();
  };
  
  // Lights
  document.querySelectorAll('.light-btn').forEach(btn=>{
    btn.onclick=()=>{
      const preset=Number(btn.dataset.light);
      STATE.lightPreset=preset;
      updateLightUI();
      saveState();
      toast(`LIGHT ${preset}`);
    };
  });
  
  $("btnRun").onclick=()=>{
    if(STATE.lightRunning){
      stopLight();
      toast("STOPPED");
    }else{
      startLight(STATE.lightPreset);
    }
  };
  
  $("btnStop").onclick=()=>{
    stopLight();
    toast("STOPPED");
  };
  
  // System
  $("btnExport").onclick=exportState;
  $("btnImport").onclick=importState;
  $("btnClear").onclick=clearState;
  $("btnStopSurface").onclick=stopSurface;
  
  $("fileInput").onchange=(e)=>{
    const file=e.target.files[0];
    if(!file)return;
    const reader=new FileReader();
    reader.onload=()=>{
      try{
        const data=JSON.parse(reader.result);
        STATE={...STATE,...data};
        saveState();
        location.reload();
      }catch(err){
        toast("IMPORT FAILED");
      }
    };
    reader.readAsText(file);
  };
  
  // Hotkeys
  window.addEventListener("keydown",(e)=>{
    if(e.code==="Space" && e.target.tagName!=="INPUT" && e.target.tagName!=="TEXTAREA"){
      e.preventDefault();
      if(STATE.lightRunning){
        stopLight();
        toast("STOPPED");
      }else{
        startLight(STATE.lightPreset);
      }
    }
  });
  
  // Prevent pull-to-refresh
  let lastY=0;
  document.body.addEventListener("touchstart",(e)=>{
    lastY=e.touches[0].clientY;
  },{passive:true});
  
  document.body.addEventListener("touchmove",(e)=>{
    const y=e.touches[0].clientY;
    if(y>lastY && window.scrollY<=0){
      e.preventDefault();
    }
  },{passive:false});
}

init();
</script>

</body>
</html>
