<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KETADATA // STUDIO</title>

  <style>
    :root{
      /* core palette */
      --laser:#ff0033;
      --uv:#7a00ff;

      /* user-customizable */
      --bg1:#000000;
      --bg2:#06060a;
      --bgAngle: 160deg;
      --txt:#ffffff;

      /* motion */
      --bgMotion: 1;     /* 1 on, 0 off */
      --bgSpeed: 0.35;   /* motion scalar */

      /* glow strengths */
      --rA: 0.080;
      --uA: 0.060;

      /* glow centers (animated) */
      --rx: 50%;
      --ry: 12%;
      --ux: 78%;
      --uy: 82%;

      /* typography */
      --nameFont: Arial, sans-serif;
      --uiFont: Arial, sans-serif;
      --uiSize: 12px;

      /* links */
      --linkRest:#666;
      --linkHover:#fff;

      /* system HUD visibility (NULL) */
      --hudOpacity: 1;

      /* title sizing */
      --titleClamp: clamp(96px, 14vw, 22rem);
      --titleSize: var(--titleClamp);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    html{ scroll-behavior:auto; } /* HARD SNAP: no smooth */

    body{
      margin:0;
      color: var(--txt);
      font-family: var(--uiFont);
      font-size: var(--uiSize);
      overflow-x:hidden;

      /* snap */
      scroll-snap-type: y mandatory;
      scroll-snap-stop: always;

      background:#000; /* base only */
    }

    section{
      height:100vh;
      scroll-snap-align:start;
      overflow:hidden;
      position:relative;
      z-index: 20; /* above background layers */
    }

    /* ===== BACKGROUND LAYERS =====
       stage = lights (behind)
       bgLayer = gradient (visible by default, always above stage)
    */
    #stage{
      position:fixed;
      inset:0;
      z-index:0;
      background: transparent; /* IMPORTANT: do not block bgLayer */
      pointer-events:none;
    }

    #bgLayer{
      position:fixed;
      inset:0;
      z-index:1;
      pointer-events:none;

      background:
        radial-gradient(900px 520px at var(--rx) var(--ry), rgba(255,0,51,var(--rA)), transparent 70%),
        radial-gradient(800px 460px at var(--ux) var(--uy), rgba(122,0,255,var(--uA)), transparent 72%),
        linear-gradient(var(--bgAngle), var(--bg1), var(--bg2));
    }

    #fxScan{
      position:fixed;
      inset:0;
      z-index:5;
      pointer-events:none;
      opacity:0.40;
      background:
        repeating-linear-gradient(to bottom, rgba(255,255,255,0.010) 0px, rgba(255,255,255,0.00) 2px, rgba(0,0,0,0.00) 7px),
        repeating-linear-gradient(to right, rgba(255,255,255,0.006) 0px, rgba(255,255,255,0.00) 3px, rgba(0,0,0,0.00) 13px);
      mix-blend-mode:screen;
    }

    /* ========= LINKS ========= */
    a.klink{
      color: var(--linkRest);
      text-decoration:none;
      font-family: var(--uiFont);
      letter-spacing:.18em;
      text-transform:uppercase;
      font-weight:900;
      font-size: 1em;
      transition: color .12s ease, transform .12s ease, text-shadow .12s ease;
    }
    a.klink:hover{
      color: var(--linkHover);
      transform: translateY(-1px);
      text-shadow: 0 0 16px rgba(255,255,255,.18);
    }

    /* ========= LANDING ========= */
    .landing{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 0 1.2vw;
      text-align:center;
    }

    .titleWrap{
      width: 100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 2.2vh;
    }

    /* ONE LINE */
    .title{
      margin:0;
      padding:0;
      font-family: var(--nameFont);
      font-weight: 900;
      letter-spacing: .06em;
      text-transform: uppercase;
      user-select:none;
      line-height: .92;
      font-size: var(--titleSize);
      white-space:nowrap;
    }

    .navRow{
      display:flex;
      justify-content:center;
      align-items:center;
      gap: 2.4vw;
      flex-wrap:wrap;
    }

    .warning{
      text-align:center;
      font-size: .92em;
      letter-spacing: .22em;
      text-transform: uppercase;
      color: rgba(255,255,255,.72);
      line-height: 1.6;
      padding: 10px 14px;
      border: 1px dashed rgba(255,0,51,.62);
      background: rgba(255,0,51,.10);
      max-width: 820px;
    }
    .warning b{ color: var(--laser); letter-spacing:.26em; }

    .hint{
      position:absolute;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: .92em;
      letter-spacing: .18em;
      text-transform: uppercase;
      color: rgba(255,255,255,.55);
      display:flex;
      align-items:center;
      gap: 10px;
      user-select:none;
      font-family: var(--uiFont);
      opacity: .85;
    }
    .arrow{ opacity:.7; }

    /* ========= DIRECTORY ========= */
    .directory{
      border-top: 1px solid rgba(255,255,255,.12);
      padding: 0;
      display:flex;
      align-items:stretch;
      justify-content:stretch;
      overflow:hidden;
    }

    .blueprint{
      position:relative;
      width:100%;
      height:100%;
      background:
        linear-gradient(rgba(255,255,255,.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.05) 1px, transparent 1px),
        radial-gradient(900px 520px at 20% 30%, rgba(255,0,51,.10), transparent 68%),
        radial-gradient(900px 520px at 80% 70%, rgba(122,0,255,.08), transparent 70%),
        transparent;
      background-size: 44px 44px, 44px 44px, auto, auto, auto;
      background-position: 0 0, 0 0, center, center, center;
    }

    /* ========= SYSTEM CHROME ========= */
    .topbar, .bottombar{
      position:fixed; left:0; right:0;
      height:44px;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 14px;
      z-index:2000;
      background:linear-gradient(to bottom, rgba(0,0,0,0.70), rgba(0,0,0,0.18));
      border-bottom:1px solid rgba(255,255,255,0.12);
      opacity:var(--hudOpacity);
    }
    .bottombar{
      top:auto; bottom:0;
      background:linear-gradient(to top, rgba(0,0,0,0.70), rgba(0,0,0,0.18));
      border-bottom:none;
      border-top:1px solid rgba(255,255,255,0.12);
    }

    .brand{
      display:flex; align-items:center; gap:10px;
      font-size:11px; letter-spacing:0.18em; text-transform:uppercase;
      color:rgba(255,255,255,0.86);
      user-select:none;
      pointer-events:none;
    }
    .whiteBox{width:10px;height:10px;background:#fff;display:inline-block;}
    .mini{
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.70);
      user-select:none;
    }
    .mini b{color:#fff;font-weight:600}

    .btn{
      height:28px;
      padding:0 10px;
      border:1px solid rgba(255,255,255,0.24);
      background:rgba(0,0,0,0.45);
      color:rgba(255,255,255,0.86);
      font-size:11px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      cursor:pointer;
    }
    .btn:hover{background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.42);}
    .btn.on{background:rgba(255,255,255,0.10);border-color:rgba(255,255,255,0.52);}

    /* KETA_NOTE icon anchor: WHITE SQUARE ONLY */
    .noteIconBtn{
      width:28px;height:28px;
      display:inline-flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,0.24);
      background:rgba(0,0,0,0.45);
      cursor:pointer;
    }
    .noteIconBtn:hover{background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.42);}
    .ketaSquare{ width:10px;height:10px;background:#fff;display:inline-block; }

    /* ========= DRAGGABLE CONTROL PANEL ========= */
    .controlPanel{
      position:fixed;
      top: 60px;
      right: 16px;
      width: 320px;
      z-index: 2200;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(8px);
      opacity: var(--hudOpacity);
      resize: both;
      overflow:auto;
      min-width: 240px;
      min-height: 54px;
      max-width: min(560px, 96vw);
      max-height: min(820px, 86vh);
    }
    .cpHead{
      height:34px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      border-bottom:1px solid rgba(255,255,255,0.10);
      cursor:move;
      user-select:none;
    }
    .cpHead .t{
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color: rgba(255,255,255,.86);
      font-weight:900;
    }
    .cpHead .actions{ display:flex; gap:8px; align-items:center; }
    .hbtn{
      height:22px;
      padding:0 8px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.25);
      color:rgba(255,255,255,0.82);
      font-size:12px;
      cursor:pointer;
    }
    .hbtn:hover{background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.36);}
    .cpBody{ padding:12px; }
    .cpBody.collapsed{ display:none; }

    .lbl{
      font-size: 10px;
      letter-spacing:.16em;
      text-transform: uppercase;
      opacity:.72;
      margin: 10px 0 6px;
      display:block;
      font-weight: 900;
    }
    .twoCol{ display:grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .row{ display:grid; grid-template-columns: 1fr; gap: 8px; }

    select, input[type="number"], input[type="color"], input[type="range"]{
      width: 100%;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.92);
      padding: 9px 10px;
      outline:none;
      font-family: var(--uiFont);
    }
    .mini2{
      font-size: 10px;
      letter-spacing:.14em;
      opacity:.72;
      text-transform: uppercase;
      line-height: 1.4;
      font-weight: 900;
    }

    /* ========= GLOBAL KETA_NOTE PANEL ========= */
    .ketaNote{
      position:fixed;
      right: 16px;
      top: 60px;
      width:min(420px, calc(100vw - 40px));
      height:260px;
      z-index: 2300;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(0,0,0,0.70);
      display:none;
      flex-direction:column;
      user-select:none;
      box-shadow:0 0 0 1px rgba(0,0,0,0.65);
      opacity: var(--hudOpacity);
    }
    .ketaHead{
      height:34px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      border-bottom:1px solid rgba(255,255,255,0.10);
      cursor:move;
      font-size:11px; letter-spacing:0.18em; text-transform:uppercase;
      color:rgba(255,255,255,0.82);
    }
    .ketaBody{
      flex:1;
      padding:10px;
      display:flex;
      gap:10px;
      align-items:stretch;
    }
    .ketaIconCol{ width:18px; padding-top:2px; }
    .ketaBody textarea{
      flex:1;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(0,0,0,0.40);
      color:rgba(255,255,255,0.88);
      font-family:Arial, Helvetica, sans-serif;
      font-size:12px;
      letter-spacing:0.02em;
      padding:10px;
      outline:none;
      resize:none;
    }
    .headBtn{
      height:22px;
      padding:0 8px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.25);
      color:rgba(255,255,255,0.82);
      font-size:12px;
      cursor:pointer;
    }
    .headBtn:hover{background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.36);}

    body.invert{ filter:invert(1); background:#fff; }

    @media (max-width: 860px){
      .blueprint{ overflow:auto; padding-top: 86px; padding-bottom: 88px; }
    }
  </style>
</head>

<body>
  <!-- Background stage for lights 1–6 -->
  <div id="stage"></div>

  <!-- Visible gradient layer (always) -->
  <div id="bgLayer" aria-hidden="true"></div>

  <div id="fxScan" aria-hidden="true"></div>

  <!-- SYSTEM TOP BAR -->
  <div class="topbar" id="topbar">
    <div class="brand"><span class="whiteBox"></span><span>KETADATA // STUDIO</span></div>

    <div style="display:flex;gap:10px;align-items:center">
      <button class="btn" id="btnSystem" type="button">SYSTEM</button>

      <button class="noteIconBtn" id="btnNoteIcon" type="button" aria-label="KETA_NOTE">
        <span class="ketaSquare"></span>
      </button>

      <button class="btn" id="btnPanel" type="button">PANEL</button>
    </div>
  </div>

  <!-- SYSTEM BOTTOM BAR -->
  <div class="bottombar" id="bottombar">
    <div class="mini">NULL: <b id="nullLabel">OFF</b> · INVERT: <b id="invLabel">OFF</b></div>
    <div class="mini">LIGHT: <b id="lightLabel">1</b> · RUN: <b id="runLabel">OFF</b> · MOTION: <b id="motionLabel">ON</b></div>
  </div>

  <!-- DRAGGABLE CONTROL PANEL (collapsed by default) -->
  <div class="controlPanel" id="controlPanel">
    <div class="cpHead" id="cpHead">
      <div class="t">STUDIO CONTROL</div>
      <div class="actions">
        <button class="hbtn" id="cpToggle" type="button">+</button>
        <button class="hbtn" id="cpHide" type="button">-</button>
      </div>
    </div>

    <div class="cpBody collapsed" id="cpBody">
      <span class="lbl">AUTO GRADIENT</span>
      <div class="twoCol">
        <div>
          <div class="mini2">AUTO</div>
          <button class="btn on" id="btnAutoBg" type="button">ON</button>
        </div>
        <div>
          <div class="mini2">SPEED</div>
          <input id="bgSpeed" type="range" min="0.05" max="1.25" step="0.01" value="0.35" />
        </div>
      </div>

      <span class="lbl">BACKGROUND GRADIENT</span>
      <div class="twoCol">
        <div>
          <div class="mini2">START</div>
          <input id="bg1" type="color" value="#000000" />
        </div>
        <div>
          <div class="mini2">END</div>
          <input id="bg2" type="color" value="#06060a" />
        </div>
      </div>

      <span class="lbl">ANGLE</span>
      <div class="row">
        <input id="bgAngle" type="range" min="0" max="360" value="160" />
      </div>

      <span class="lbl">TEXT</span>
      <div class="twoCol">
        <div>
          <div class="mini2">COLOR</div>
          <input id="txt" type="color" value="#ffffff" />
        </div>
        <div>
          <div class="mini2">UI SIZE (PX)</div>
          <input id="uiSize" type="number" min="10" max="18" step="1" value="12" />
        </div>
      </div>
    </div>
  </div>

  <!-- GLOBAL KETA_NOTE PANEL -->
  <div class="ketaNote" id="ketaNote">
    <div class="ketaHead" id="ketaHead">
      <div>KETA_NOTE</div>
      <button class="headBtn" id="btnHideNote" type="button">-</button>
    </div>
    <div class="ketaBody">
      <div class="ketaIconCol"><span class="ketaSquare"></span></div>
      <textarea id="ketaText" placeholder="GLOBAL NOTE" spellcheck="false"></textarea>
    </div>
  </div>

  <!-- PAGE 1 -->
  <section class="landing" id="top">
    <div class="titleWrap">
      <h1 class="title" id="bigTitle" aria-label="KETADATA STUDIO">KETADATA [STUDIO]</h1>

      <div class="navRow" aria-label="primary">
        <a class="klink" href="#directory">[DIRECTORY]</a>
        <a class="klink" href="page2.html">[K-LIGHT]</a>
        <a class="klink" href="observatory.html">[K-WORLD]</a>
        <a class="klink" href="room.html">[K-ROOM]</a>
        <a class="klink" href="vape-drive.html">[K-APPS]</a>
        <a class="klink" href="shop.html">[SHOP]</a>
        <a class="klink" href="stylebook.html">[STYLEBOOK]</a>
      </div>

      <div class="warning">
        <b>STUDIO ENTRY</b><br/>
        AUTO GRADIENT ACTIVE · SIGNAL DENSITY HIGH
      </div>
    </div>

    <div class="hint">SCROLL <span class="arrow">↓</span></div>
  </section>

  <!-- PAGE 2 -->
  <section class="directory" id="directory">
    <div class="blueprint" id="bp">
      <!-- keep your directory content as-is or paste it here later -->
    </div>
  </section>

  <script>
    /* WB ▸ NAV */
    const SHELL_HOME_URL = "system.html";
    const LANDING_URL = "index11.html";

    /* WB ▸ STORAGE NAMESPACE */
    const FILE_ID = "KETADATA_STUDIO";
    const ROOM_ID = "STUDIO";
    const VERSION_ID = "studio.v2";
    const STORAGE_KEY = `KDT::STATE::${FILE_ID}::${ROOM_ID}::${VERSION_ID}`;

    /* GLOBAL NOTE continuity */
    const GLOBAL_KETA_NOTE_KEY = "KDT_GLOBAL_KETA_NOTE_V1";

    const DEFAULT = {
      ui: {
        invert:false,
        nullMode:false,
        lightPreset:1,
        lightRunning:false,
        motionOn:true,
        panelVisible:true,
        panelCollapsed:true,
        noteVisible:false
      },
      bg: {
        auto:true,
        speed:0.35
      },
      tester: {
        bg1:"#000000",
        bg2:"#06060a",
        txt:"#ffffff",
        angle:160,
        uiSize:12
      }
    };

    const $ = (id)=>document.getElementById(id);
    const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){ return null; }
    }
    function mergeDefault(s){
      const out = structuredClone(DEFAULT);
      s = s || {};
      out.ui = Object.assign(structuredClone(DEFAULT.ui), s.ui||{});
      out.bg = Object.assign(structuredClone(DEFAULT.bg), s.bg||{});
      out.tester = Object.assign(structuredClone(DEFAULT.tester), s.tester||{});
      return out;
    }
    let STATE = mergeDefault(loadState());

    function persist(){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE)); }catch(e){}
      renderHud();
    }

    function loadGlobalNote(){
      try{ return localStorage.getItem(GLOBAL_KETA_NOTE_KEY) || ""; }catch(e){ return ""; }
    }
    function saveGlobalNote(v){
      try{ localStorage.setItem(GLOBAL_KETA_NOTE_KEY, String(v||"")); }catch(e){}
    }

    /* ===== Title auto-fit ===== */
    const bigTitle = $("bigTitle");
    function fitTitle(){
      if(!bigTitle) return;
      let lo = 80, hi = 1400, best = lo;
      const maxW = Math.max(320, window.innerWidth - 24);
      const maxH = Math.max(140, window.innerHeight * 0.52);

      for(let i=0;i<18;i++){
        const mid = (lo+hi)/2;
        document.documentElement.style.setProperty("--titleSize", mid+"px");
        const r = bigTitle.getBoundingClientRect();
        if(r.width <= maxW && r.height <= maxH){ best = mid; lo = mid; }
        else hi = mid;
      }
      document.documentElement.style.setProperty("--titleSize", best+"px");
    }

    /* ===== Apply controls ===== */
    const bg1 = $("bg1"), bg2 = $("bg2"), txt = $("txt"), bgAngle = $("bgAngle"), uiSize = $("uiSize");
    const btnAutoBg = $("btnAutoBg"), bgSpeed = $("bgSpeed");

    function applyVars(){
      document.documentElement.style.setProperty("--bg1", bg1.value);
      document.documentElement.style.setProperty("--bg2", bg2.value);
      document.documentElement.style.setProperty("--txt", txt.value);
      document.documentElement.style.setProperty("--bgAngle", (parseInt(bgAngle.value,10)||160) + "deg");
      document.documentElement.style.setProperty("--uiSize", (parseInt(uiSize.value,10)||12) + "px");

      STATE.tester.bg1 = bg1.value;
      STATE.tester.bg2 = bg2.value;
      STATE.tester.txt = txt.value;
      STATE.tester.angle = parseInt(bgAngle.value,10)||160;
      STATE.tester.uiSize = parseInt(uiSize.value,10)||12;

      fitTitle();
      persist();
    }

    /* ===== HUD ===== */
    function renderHud(){
      document.body.classList.toggle("invert", !!STATE.ui.invert);
      document.documentElement.style.setProperty("--hudOpacity", STATE.ui.nullMode ? "0" : "1");

      $("nullLabel").textContent = STATE.ui.nullMode ? "ON" : "OFF";
      $("invLabel").textContent = STATE.ui.invert ? "ON" : "OFF";
      $("lightLabel").textContent = String(STATE.ui.lightPreset||1);
      $("runLabel").textContent = STATE.ui.lightRunning ? "ON" : "OFF";
      $("motionLabel").textContent = STATE.bg.auto ? "ON" : "OFF";

      $("controlPanel").style.display = (STATE.ui.panelVisible && !STATE.ui.nullMode) ? "block" : "none";
      $("cpBody").classList.toggle("collapsed", !!STATE.ui.panelCollapsed);

      $("ketaNote").style.display = (STATE.ui.noteVisible && !STATE.ui.nullMode) ? "flex" : "none";
    }

    /* ===== HARD SNAP (instant) ===== */
    function hardSnapTo(targetId){
      const el = document.getElementById(targetId);
      if(!el) return;
      el.scrollIntoView({behavior:"auto", block:"start"});
    }

    let wheelLock=false;
    window.addEventListener("wheel", (e)=>{
      if(wheelLock) return;
      const dy = e.deltaY || 0;
      const atTop = (window.scrollY || window.pageYOffset || 0) < 8;
      if(atTop && dy > 6){
        wheelLock=true;
        hardSnapTo("directory");
        setTimeout(()=>wheelLock=false, 180);
      } else if(!atTop && dy < -6){
        wheelLock=true;
        hardSnapTo("top");
        setTimeout(()=>wheelLock=false, 180);
      }
    }, {passive:true});

    /* ===== Background motion engine (always visible now) ===== */
    function tick(now){
      if(STATE.bg.auto){
        const sp = STATE.bg.speed || 0.35;

        // angle drift
        const baseAngle = STATE.tester.angle || 160;
        const a = baseAngle + Math.sin(now*0.00022) * 22 * sp;
        document.documentElement.style.setProperty("--bgAngle", a.toFixed(1) + "deg");

        // center drift
        const rx = 50 + Math.sin(now*0.00018) * 10 * sp;
        const ry = 12 + Math.cos(now*0.00016) * 6 * sp;
        const ux = 78 + Math.cos(now*0.00014) * 8 * sp;
        const uy = 82 + Math.sin(now*0.00015) * 6 * sp;

        document.documentElement.style.setProperty("--rx", rx.toFixed(2) + "%");
        document.documentElement.style.setProperty("--ry", ry.toFixed(2) + "%");
        document.documentElement.style.setProperty("--ux", ux.toFixed(2) + "%");
        document.documentElement.style.setProperty("--uy", uy.toFixed(2) + "%");
      }
      requestAnimationFrame(tick);
    }

    /* ===== Lights 1–6 behind gradient ===== */
    const stage = $("stage");
    let lightInterval=null, lightCount=0, lightAuxA=0, lightAuxB=0;

    function resetStage(){
      stage.style.backgroundColor = "transparent";
      stage.style.filter = "none";
      lightCount=0; lightAuxA=0; lightAuxB=0;
    }
    function stopLight(silent){
      if(lightInterval) clearInterval(lightInterval);
      lightInterval=null;
      STATE.ui.lightRunning=false;
      resetStage();
      if(!silent) persist();
    }
    function startLight(preset){
      stopLight(true);
      resetStage();
      STATE.ui.lightPreset=preset;
      STATE.ui.lightRunning=true;

      // lights act as *luminance* under the gradient; keep them intense but not occluding
      if(preset===1){
        lightInterval=setInterval(()=>{
          const curr = stage.dataset.on === "1";
          stage.dataset.on = curr ? "0" : "1";
          stage.style.backgroundColor = curr ? "#000000" : "#ffffff";
        }, 50);
      }
      if(preset===2){
        lightInterval=setInterval(()=>{
          lightAuxA=(lightAuxA+30)%360;
          lightAuxB+=0.5;
          const lightness = 50 + Math.sin(lightAuxB) * 40;
          stage.style.backgroundColor = `hsl(${lightAuxA}, 100%, ${lightness}%)`;
        }, 10);
      }
      if(preset===3){
        lightInterval=setInterval(()=>{
          lightCount++;
          const beat=lightCount%16;
          if(beat===0 || beat===1){
            stage.style.backgroundColor="#ffffff";
            stage.style.filter="contrast(3) brightness(2)";
          } else if(beat===2){
            stage.style.backgroundColor="#000000";
            stage.style.filter="contrast(2)";
          } else {
            stage.style.backgroundColor="#000000";
            stage.style.filter="none";
          }
        }, 50);
      }
      if(preset===4){
        lightInterval=setInterval(()=>{
          lightAuxB += 0.08;
          const v = 0.5 + 0.5*Math.sin(lightAuxB);
          const a = 0.18 + 0.42*v;
          stage.style.backgroundColor = "#ffffff";
          stage.style.filter = `brightness(${0.4+a}) contrast(${1.2+v*1.6})`;
        }, 16);
      }
      if(preset===5){
        lightInterval=setInterval(()=>{
          lightAuxB += 0.11;
          const v = 0.5 + 0.5*Math.sin(lightAuxB);
          stage.style.backgroundColor = v>0.5 ? "#ffffff" : "#000000";
          stage.style.filter = `contrast(2.2)`;
        }, 90);
      }
      if(preset===6){
        lightInterval=setInterval(()=>{
          lightAuxB += 0.06;
          const v = 0.5 + 0.5*Math.sin(lightAuxB);
          stage.style.backgroundColor = "#ffffff";
          stage.style.filter = `invert(${v}) contrast(${1.6+v*1.2}) brightness(${0.6+v*0.8})`;
        }, 16);
      }

      persist();
    }

    function toggleTransport(){
      // transport = lights toggle; motion stays controlled by AUTO button
      if(STATE.ui.lightRunning) stopLight(true);
      else startLight(STATE.ui.lightPreset || 1);
      persist();
    }

    /* ===== Minimal system UI buttons ===== */
    $("btnPanel").addEventListener("click", ()=>{
      STATE.ui.panelVisible = !STATE.ui.panelVisible;
      persist();
    });
    $("btnSystem").addEventListener("click", ()=>{
      STATE.ui.panelCollapsed = !STATE.ui.panelCollapsed;
      persist();
      $("cpToggle").textContent = STATE.ui.panelCollapsed ? "+" : "–";
    });
    $("cpToggle").addEventListener("click", ()=>{
      STATE.ui.panelCollapsed = !STATE.ui.panelCollapsed;
      persist();
      $("cpToggle").textContent = STATE.ui.panelCollapsed ? "+" : "–";
    });
    $("cpHide").addEventListener("click", ()=>{
      STATE.ui.panelVisible = false;
      persist();
    });

    btnAutoBg.addEventListener("click", ()=>{
      STATE.bg.auto = !STATE.bg.auto;
      btnAutoBg.classList.toggle("on", STATE.bg.auto);
      btnAutoBg.textContent = STATE.bg.auto ? "ON" : "OFF";
      persist();
    });
    bgSpeed.addEventListener("input", (e)=>{
      STATE.bg.speed = parseFloat(e.target.value) || 0.35;
      persist();
    });

    /* ===== Input bindings ===== */
    [bg1,bg2,txt,bgAngle,uiSize].forEach(el=>{
      el.addEventListener("input", applyVars);
      el.addEventListener("change", applyVars);
    });

    /* ===== Global KETA_NOTE ===== */
    function setNoteVisible(on){
      STATE.ui.noteVisible = !!on;
      persist();
    }
    $("btnNoteIcon").addEventListener("click", ()=> setNoteVisible(!STATE.ui.noteVisible));
    $("btnHideNote").addEventListener("click", ()=> setNoteVisible(false));

    const ketaText = $("ketaText");
    ketaText.value = loadGlobalNote();
    ketaText.addEventListener("input", ()=> saveGlobalNote(ketaText.value || ""));

    // draggable note
    (function noteDrag(){
      const note = $("ketaNote");
      const head = $("ketaHead");
      let isDrag=false, ox=0, oy=0;
      head.addEventListener("mousedown", (e)=>{
        isDrag=true;
        const r=note.getBoundingClientRect();
        ox=e.clientX-r.left; oy=e.clientY-r.top;
        e.preventDefault();
      });
      window.addEventListener("mousemove", (e)=>{
        if(!isDrag) return;
        note.style.left=""; note.style.right="auto";
        note.style.top = clamp(e.clientY-oy, 50, window.innerHeight - note.offsetHeight - 50) + "px";
        note.style.left = clamp(e.clientX-ox, 6, window.innerWidth - note.offsetWidth - 6) + "px";
      });
      window.addEventListener("mouseup", ()=> isDrag=false);
    })();

    // draggable control panel
    (function panelDrag(){
      const panel = $("controlPanel");
      const head = $("cpHead");
      let isDrag=false, ox=0, oy=0;
      head.addEventListener("mousedown", (e)=>{
        isDrag=true;
        const r=panel.getBoundingClientRect();
        ox=e.clientX-r.left; oy=e.clientY-r.top;
        e.preventDefault();
      });
      window.addEventListener("mousemove", (e)=>{
        if(!isDrag) return;
        panel.style.left="auto"; panel.style.right="auto";
        panel.style.top = clamp(e.clientY-oy, 50, window.innerHeight - panel.offsetHeight - 50) + "px";
        panel.style.left = clamp(e.clientX-ox, 6, window.innerWidth - panel.offsetWidth - 6) + "px";
      });
      window.addEventListener("mouseup", ()=> isDrag=false);
    })();

    /* ===== SYSTEM UNIVERSALS ONLY ===== */
    window.addEventListener("keydown", (e)=>{
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
      const typing = (tag==="textarea" || tag==="input" || tag==="select");

      if(!typing && e.shiftKey && e.key === "I"){
        STATE.ui.invert = !STATE.ui.invert;
        persist();
      }

      if(!typing && e.shiftKey && e.key === "0"){
        STATE.ui.nullMode = !STATE.ui.nullMode;
        if(STATE.ui.nullMode) STATE.ui.noteVisible = false;
        persist();
      }

      if(!typing && e.shiftKey && (e.key === "B" || e.key === "b")){
        window.location.href = SHELL_HOME_URL;
      }

      if(!typing && e.shiftKey && (e.key === "K" || e.key === "k")){
        window.location.href = LANDING_URL;
      }

      if(!typing && e.code === "Space"){
        e.preventDefault();
        toggleTransport();
      }

      if(!typing && !e.shiftKey && !e.ctrlKey && !e.metaKey){
        const n = parseInt(e.key, 10);
        if(n>=1 && n<=6) startLight(n);
      }

      if(!typing && e.key === "Escape"){
        if(STATE.ui.nullMode){
          STATE.ui.nullMode = false;
          persist();
        }
      }
    });

    /* ===== init ===== */
    function init(){
      // restore inputs
      bg1.value = STATE.tester.bg1;
      bg2.value = STATE.tester.bg2;
      txt.value = STATE.tester.txt;
      bgAngle.value = String(STATE.tester.angle);
      uiSize.value = String(STATE.tester.uiSize);

      // restore bg toggles
      btnAutoBg.classList.toggle("on", !!STATE.bg.auto);
      btnAutoBg.textContent = STATE.bg.auto ? "ON" : "OFF";
      bgSpeed.value = String(STATE.bg.speed || 0.35);

      // panel collapsed by default
      $("cpToggle").textContent = STATE.ui.panelCollapsed ? "+" : "–";

      applyVars();
      renderHud();
      fitTitle();
      persist();
      resetStage();

      requestAnimationFrame(tick);
    }

    window.addEventListener("resize", fitTitle);
    window.addEventListener("load", fitTitle);

    init();
  </script>
</body>
</html>

<!--
============================================================
KETADATA HTML SERIALIZATION STAMP
FILE_ID: KETADATA_STUDIO
ROOM_ID: STUDIO
VERSION: studio.v2
UPDATED_AT: 2025-12-24T00:00:00-05:00
CHANGELOG:
- FIX: STAGE NO LONGER OCCLUDES GRADIENT (GRADIENT MOVED TO #bgLayer)
- AUTO GRADIENT MOTION ON BY DEFAULT; COLOR PICKERS WORK
- TITLE ONE LINE: "KETADATA [STUDIO]"
- SNAP HARD/INSTANT (NO SMOOTH SCROLL; WHEEL INTENT JUMPS IMMEDIATELY)
- SYSTEM UNIVERSALS ONLY PRESERVED
============================================================
-->
