<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KETADATA // STUDIO</title>

  <style>
    :root{
      /* DEFAULT: PURPLE MOVING GRADIENT */
      --bg1:#0a0010;
      --bg2:#2a0066;
      --bg3:#5a00ff;
      --bg4:#24002f;

      /* motion */
      --motionSpeed: 0.55; /* visible by default */
      --angle: 145deg;

      /* blob centers (animated) */
      --aX: 18%; --aY: 20%;
      --bX: 78%; --bY: 28%;
      --cX: 28%; --cY: 86%;
      --dX: 86%; --dY: 82%;

      /* blob alpha */
      --aA: 0.22;
      --bA: 0.18;
      --cA: 0.16;
      --dA: 0.14;

      /* ui */
      --txt:#ffffff;
      --uiFont: Arial, Helvetica, sans-serif;
      --uiSize: 12px;
      --hudOpacity: 1;

      --linkRest:#7a7a7a;
      --linkHover:#ffffff;

      /* TYPOGRAPHY CONTROLS */
      --titleMaxPx: 180px;  /* max in clamp() */
      --linkSizePx: 11px;   /* directory/link font size */

      /* LANDING POSITION (RELATIVE SCREEN POSITION, CENTERED, SMALL MARGINS) */
      --titleX: 50vw;   /* centered */
      --titleY: 55vh;   /* like screenshot (slightly above mid) */
      --titleMaxWidth: calc(100vw - 88px); /* small margins, keeps inside screen */
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    html{ scroll-behavior:auto; }
    body{
      margin:0;
      font-family: var(--uiFont);
      font-size: var(--uiSize);
      color: var(--txt);
      background:#000;
      overflow-x:hidden;

      /* SNAP */
      scroll-snap-type: y mandatory;
      scroll-snap-stop: always;
    }
    section{
      height:100vh;
      scroll-snap-align:start;
      position:relative;
      z-index: 30;
      overflow:hidden;
    }

    /* ===== LAYERS ===== */
    #bgLayer{
      position:fixed;
      inset:0;
      z-index: 1;
      pointer-events:none;

      background:
        radial-gradient(1100px 680px at var(--aX) var(--aY), rgba(90,0,255,var(--aA)), transparent 70%),
        radial-gradient(900px 620px at var(--bX) var(--bY), rgba(180,0,255,var(--bA)), transparent 72%),
        radial-gradient(1000px 720px at var(--cX) var(--cY), rgba(40,120,255,var(--cA)), transparent 74%),
        radial-gradient(900px 640px at var(--dX) var(--dY), rgba(255,0,120,var(--dA)), transparent 72%),
        linear-gradient(var(--angle), var(--bg1), var(--bg2), var(--bg3), var(--bg4));
      background-size: auto, auto, auto, auto, 180% 180%;
      background-position: center, center, center, center, 0% 0%;
      filter: contrast(1.08) saturate(1.15);
      animation: bgDrift 10s linear infinite;
    }
    @keyframes bgDrift{
      0%   { background-position: center, center, center, center,   0% 0%; }
      50%  { background-position: center, center, center, center, 100% 100%; }
      100% { background-position: center, center, center, center,   0% 0%; }
    }

    /* System lights overlay: OVER the interface */
    #lightOverlay{
      position:fixed;
      inset:0;
      z-index: 15;
      pointer-events:none;
      opacity: 0;
      mix-blend-mode: screen;
      background: #000;
      filter:none;
    }

    /* grid + scan */
    #grid{
      position:fixed;
      inset:0;
      z-index: 8;
      pointer-events:none;
      opacity:0.18;
      background:
        linear-gradient(rgba(255,255,255,.06) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.04) 1px, transparent 1px);
      background-size: 48px 48px;
    }
    #fxScan{
      position:fixed;
      inset:0;
      z-index: 9;
      pointer-events:none;
      opacity:0.35;
      background:
        repeating-linear-gradient(to bottom, rgba(255,255,255,0.010) 0px, rgba(255,255,255,0.00) 2px, rgba(0,0,0,0.00) 7px),
        repeating-linear-gradient(to right, rgba(255,255,255,0.006) 0px, rgba(255,255,255,0.00) 3px, rgba(0,0,0,0.00) 13px);
      mix-blend-mode:screen;
    }

    /* ===== system bars ===== */
    .topbar,.bottombar{
      position:fixed; left:0; right:0;
      height:44px;
      z-index: 2200;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 14px;
      opacity: var(--hudOpacity);

      background:linear-gradient(to bottom, rgba(0,0,0,0.72), rgba(0,0,0,0.18));
      border-bottom: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(6px);
    }
    .bottombar{
      top:auto; bottom:0;
      background:linear-gradient(to top, rgba(0,0,0,0.72), rgba(0,0,0,0.18));
      border-bottom:none;
      border-top: 1px solid rgba(255,255,255,.12);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-size:11px; letter-spacing:.18em; text-transform:uppercase;
      color: rgba(255,255,255,.86);
      user-select:none;
      pointer-events:none;
    }
    .whiteBox{ width:10px; height:10px; background:#fff; display:inline-block; }

    .mini{
      font-size:11px; letter-spacing:.14em; text-transform:uppercase;
      color: rgba(255,255,255,.70);
      user-select:none;
    }
    .mini b{ color:#fff; font-weight:600; }

    .btn{
      height:28px;
      padding:0 10px;
      border:1px solid rgba(255,255,255,0.24);
      background: rgba(0,0,0,0.45);
      color: rgba(255,255,255,0.86);
      font-size:11px;
      letter-spacing:.16em;
      text-transform:uppercase;
      cursor:pointer;
    }
    .btn:hover{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.42); }
    .btn.on{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.52); }

    /* KETA_NOTE ICON: WHITE SQUARE ONLY */
    .noteIconBtn{
      width:28px;height:28px;
      display:inline-flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,0.24);
      background: rgba(0,0,0,0.45);
      cursor:pointer;
    }
    .noteIconBtn:hover{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.42); }
    .ketaSquare{ width:10px;height:10px;background:#fff;display:inline-block; }

    /* ===== landing (CENTERED; SMALL MARGINS; FIT INSIDE SCREEN) ===== */
    .landing{ position:relative; }
    .landingTitleWrap{
      position:absolute;
      left: var(--titleX);
      top: var(--titleY);
      transform: translate(-50%, -50%);
      text-align:center;
      width: var(--titleMaxWidth);
      max-width: var(--titleMaxWidth);
    }
    .title{
      margin:0;
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;

      /* KEY: fits inside screen while keeping the “big” look */
      font-size: clamp(56px, 8.8vw, var(--titleMaxPx));
      line-height:.92;
      white-space:nowrap;
      user-select:none;
      text-shadow: 0 0 30px rgba(255,255,255,.06);

      /* guarantee it never spills horizontally */
      max-width: 100%;
      overflow:hidden;
      text-overflow: clip;
    }
    .sub{
      margin-top: 12px;
      font-size: 11px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color: rgba(255,255,255,.35);
      font-weight:900;
    }

    /* ===== directory ===== */
    .directory{
      border-top: 1px solid rgba(255,255,255,.12);
      display:flex;
      align-items:stretch;
      justify-content:center;
      padding: 84px 22px 72px;
    }
    .dirBox{
      width: min(1100px, 100%);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.46);
      backdrop-filter: blur(8px);
      padding: 16px 16px 10px;
    }
    .dirHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom: 1px solid rgba(255,255,255,.10);
      padding-bottom: 10px;
      margin-bottom: 12px;
    }
    .dirHead .t{
      font-size:11px;
      letter-spacing:.22em;
      text-transform:uppercase;
      font-weight:900;
      color: rgba(255,255,255,.86);
    }
    .dirGrid{
      display:grid;
      grid-template-columns: repeat(4, minmax(180px, 1fr));
      gap: 18px 22px;
      padding: 10px 0 6px;
    }
    .dirGroupTitle{
      grid-column: 1 / -1;
      font-size:10px;
      letter-spacing:.22em;
      text-transform:uppercase;
      font-weight:900;
      color: rgba(255,255,255,.72);
      padding: 12px 0 10px;
      border-top: 1px solid rgba(255,255,255,.10);
      border-bottom: 1px solid rgba(255,255,255,.10);
      margin-top: 6px;
    }
    .dirItem{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap: 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      padding: 10px 0;
    }
    .tag{
      font-size:10px;
      letter-spacing:.14em;
      text-transform:uppercase;
      font-weight:900;
      color: rgba(255,255,255,.48);
      white-space:nowrap;
    }

    a.klink{
      color: var(--linkRest);
      text-decoration:none;
      letter-spacing:.18em;
      text-transform:uppercase;
      font-weight:900;
      font-size: var(--linkSizePx);
      transition: color .12s ease, transform .12s ease, text-shadow .12s ease;
    }
    a.klink:hover{
      color: var(--linkHover);
      transform: translateY(-1px);
      text-shadow: 0 0 16px rgba(255,255,255,.18);
    }

    @media (max-width: 980px){
      .dirGrid{ grid-template-columns: repeat(2, minmax(180px, 1fr)); }
      .title{ white-space:normal; }
      .landingTitleWrap{
        width: calc(100vw - 56px);
        max-width: calc(100vw - 56px);
      }
    }
    @media (max-width: 560px){
      .dirGrid{ grid-template-columns: 1fr; }
    }

    /* ===== control panel ===== */
    .controlPanel{
      position:fixed;
      top: 60px;
      right: 16px;
      width: 360px;
      z-index: 2300;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(8px);
      opacity: var(--hudOpacity);
      resize: both;
      overflow:auto;
      min-width: 260px;
      min-height: 54px;
      max-width: min(680px, 96vw);
      max-height: min(820px, 86vh);
    }
    .cpHead{
      height:34px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      border-bottom:1px solid rgba(255,255,255,0.10);
      cursor:move;
      user-select:none;
    }
    .cpHead .t{
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color: rgba(255,255,255,.86);
      font-weight:900;
    }
    .hbtn{
      height:22px;
      padding:0 8px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.25);
      color:rgba(255,255,255,0.82);
      font-size:12px;
      cursor:pointer;
    }
    .hbtn:hover{ background:rgba(255,255,255,0.06); border-color:rgba(255,255,255,0.36); }
    .cpBody{ padding:12px; }
    .cpBody.collapsed{ display:none; }
    .lbl{
      font-size: 10px;
      letter-spacing:.16em;
      text-transform: uppercase;
      opacity:.72;
      margin: 10px 0 6px;
      display:block;
      font-weight: 900;
    }
    .twoCol{ display:grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .mini2{
      font-size: 10px;
      letter-spacing:.14em;
      opacity:.72;
      text-transform: uppercase;
      line-height: 1.4;
      font-weight: 900;
    }
    input[type="range"], input[type="color"], input[type="number"]{
      width: 100%;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.92);
      padding: 9px 10px;
      outline:none;
      font-family: var(--uiFont);
    }

    /* ===== global note ===== */
    .ketaNote{
      position:fixed;
      right: 16px;
      top: 60px;
      width:min(420px, calc(100vw - 40px));
      height:260px;
      z-index: 2400;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(0,0,0,0.70);
      display:none;
      flex-direction:column;
      user-select:none;
      box-shadow:0 0 0 1px rgba(0,0,0,0.65);
      opacity: var(--hudOpacity);
    }
    .ketaHead{
      height:34px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      border-bottom:1px solid rgba(255,255,255,0.10);
      cursor:move;
      font-size:11px; letter-spacing:0.18em; text-transform:uppercase;
      color:rgba(255,255,255,0.82);
    }
    .ketaBody{
      flex:1;
      padding:10px;
      display:flex;
      gap:10px;
      align-items:stretch;
    }
    .ketaIconCol{ width:18px; padding-top:2px; }
    .ketaBody textarea{
      flex:1;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(0,0,0,0.40);
      color:rgba(255,255,255,0.88);
      font-family:Arial, Helvetica, sans-serif;
      font-size:12px;
      letter-spacing:0.02em;
      padding:10px;
      outline:none;
      resize:none;
    }

    body.invert{ filter:invert(1); background:#fff; }
  </style>
</head>

<body>
  <div id="bgLayer"></div>
  <div id="grid"></div>
  <div id="fxScan"></div>
  <div id="lightOverlay"></div>

  <!-- SYSTEM TOP BAR -->
  <div class="topbar" id="topbar">
    <div class="brand"><span class="whiteBox"></span><span>KETADATA // STUDIO</span></div>
    <div style="display:flex;gap:10px;align-items:center">
      <button class="btn" id="btnSystem" type="button">SYSTEM</button>
      <button class="noteIconBtn" id="btnNoteIcon" type="button" aria-label="KETA_NOTE">
        <span class="ketaSquare"></span>
      </button>
      <button class="btn" id="btnPanel" type="button">PANEL</button>
    </div>
  </div>

  <!-- SYSTEM BOTTOM BAR -->
  <div class="bottombar" id="bottombar">
    <div class="mini">NULL: <b id="nullLabel">OFF</b> · INVERT: <b id="invLabel">OFF</b></div>
    <div class="mini">LIGHT: <b id="lightLabel">1</b> · RUN: <b id="runLabel">OFF</b> · MOTION: <b id="motionLabel">ON</b></div>
  </div>

  <!-- CONTROL PANEL (collapsed by default) -->
  <div class="controlPanel" id="controlPanel">
    <div class="cpHead" id="cpHead">
      <div class="t">STUDIO CONTROL</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="hbtn" id="cpToggle" type="button">+</button>
        <button class="hbtn" id="cpHide" type="button">-</button>
      </div>
    </div>

    <div class="cpBody collapsed" id="cpBody">
      <span class="lbl">MOTION</span>
      <div class="twoCol">
        <div>
          <div class="mini2">AUTO</div>
          <button class="btn on" id="btnMotion" type="button">ON</button>
        </div>
        <div>
          <div class="mini2">SPEED</div>
          <input id="motionSpeed" type="range" min="0.10" max="1.60" step="0.01" value="0.55" />
        </div>
      </div>

      <span class="lbl">PURPLE GRADIENT</span>
      <div class="twoCol">
        <div>
          <div class="mini2">BG 1</div>
          <input id="bg1" type="color" value="#0a0010" />
        </div>
        <div>
          <div class="mini2">BG 2</div>
          <input id="bg2" type="color" value="#2a0066" />
        </div>
      </div>
      <div class="twoCol" style="margin-top:8px;">
        <div>
          <div class="mini2">BG 3</div>
          <input id="bg3" type="color" value="#5a00ff" />
        </div>
        <div>
          <div class="mini2">BG 4</div>
          <input id="bg4" type="color" value="#24002f" />
        </div>
      </div>

      <span class="lbl">ANGLE</span>
      <input id="angle" type="range" min="0" max="360" step="1" value="145" />

      <span class="lbl">TEXT</span>
      <div class="twoCol">
        <div>
          <div class="mini2">COLOR</div>
          <input id="txt" type="color" value="#ffffff" />
        </div>
        <div>
          <div class="mini2">UI SIZE</div>
          <input id="uiSize" type="number" min="10" max="18" step="1" value="12" />
        </div>
      </div>

      <!-- TEXT SIZE CONTROLS -->
      <div class="twoCol" style="margin-top:8px;">
        <div>
          <div class="mini2">TITLE SIZE</div>
          <input id="titleMax" type="range" min="120" max="260" step="1" value="180" />
        </div>
        <div>
          <div class="mini2">LINK SIZE</div>
          <input id="linkSize" type="range" min="10" max="18" step="1" value="11" />
        </div>
      </div>
    </div>
  </div>

  <!-- GLOBAL KETA_NOTE -->
  <div class="ketaNote" id="ketaNote">
    <div class="ketaHead" id="ketaHead">
      <div>KETA_NOTE</div>
      <button class="hbtn" id="btnHideNote" type="button">-</button>
    </div>
    <div class="ketaBody">
      <div class="ketaIconCol"><span class="ketaSquare"></span></div>
      <textarea id="ketaText" placeholder="GLOBAL NOTE" spellcheck="false"></textarea>
    </div>
  </div>

  <!-- LANDING -->
  <section class="landing" id="top">
    <div class="landingTitleWrap">
      <h1 class="title">KETADATA [STUDIO]</h1>
      <div class="sub">[DIRECTORY]</div>
    </div>
  </section>

  <!-- DIRECTORY -->
  <section class="directory" id="directory">
    <div class="dirBox">
      <div class="dirHead">
        <div class="t">STUDIO DIRECTORY</div>
        <div class="mini">LINKS ONLY</div>
      </div>
      <div class="dirGrid" id="dirGrid"></div>
    </div>
  </section>

  <script>
    const SHELL_HOME_URL = "system.html";
    const LANDING_URL = "index11.html";
    const GLOBAL_KETA_NOTE_KEY = "KDT_GLOBAL_KETA_NOTE_V1";

    const FILE_ID = "KETADATA_STUDIO";
    const ROOM_ID = "STUDIO";
    const VERSION_ID = "studio.v6_centered_small_margins";
    const STORAGE_KEY = `KDT::STATE::${FILE_ID}::${ROOM_ID}::${VERSION_ID}`;

    const DIRECTORY = [
      { group:"INTERFACE DESIGN", items:[
        ["[CONTROLLER1.HTML]","controller1.html"],
        ["[COLOR1.HTML]","color1.html"],
        ["[COLOR3.HTML]","color3.html"],
        ["[FONT.HTML]","font.html"],
        ["[PROMPT.HTML → 6.HTML]","prompt.html"],
        ["[REF.HTML]","ref.html"],
        ["[COLOR5.HTML]","color5.html"],
        ["[CONTROLLER3.HTML]","controller3.html"]
      ]},
      { group:"MOOD-BOARDS", items:[
        ["[STUDIO.HTML]","studio.html"],
        ["[BOARD3.HTML]","board3.html"]
      ]},
      { group:"UGLY DUCKLINGS & VARIANTS", items:[
        ["[DARKROOM.HTML]","darkroom.html"],
        ["[CONTROLLER2.HTML]","controller2.html"],
        ["[CONTROLLER.HTML]","controller.html"]
      ]},
      { group:"DATA PRODUCTION", items:[
        ["[STUDIO.HTML]","studio.html"],
        ["[STUDIOV1.HTML]","studiov1.html"],
        ["[EDITOR.HTML]","editor.html"]
      ]}
    ];

    const DEFAULT = {
      ui:{ invert:false, nullMode:false, lightPreset:1, lightRunning:false, panelVisible:true, panelCollapsed:true, noteVisible:false },
      motion:{ on:true, speed:0.55 },
      colors:{ bg1:"#0a0010", bg2:"#2a0066", bg3:"#5a00ff", bg4:"#24002f", angle:145, txt:"#ffffff", uiSize:12 },
      type:{ titleMax:180, linkSize:11 }
    };

    const $=(id)=>document.getElementById(id);
    const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));

    function loadState(){
      try{ const raw=localStorage.getItem(STORAGE_KEY); return raw?JSON.parse(raw):null; }catch(e){ return null; }
    }
    function mergeDefault(s){
      const out=structuredClone(DEFAULT);
      s=s||{};
      out.ui = Object.assign(structuredClone(DEFAULT.ui), s.ui||{});
      out.motion = Object.assign(structuredClone(DEFAULT.motion), s.motion||{});
      out.colors = Object.assign(structuredClone(DEFAULT.colors), s.colors||{});
      out.type = Object.assign(structuredClone(DEFAULT.type), s.type||{});
      return out;
    }
    let STATE = mergeDefault(loadState());

    function persist(){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE)); }catch(e){}
      renderHud();
    }

    function loadGlobalNote(){ try{ return localStorage.getItem(GLOBAL_KETA_NOTE_KEY)||""; }catch(e){ return ""; } }
    function saveGlobalNote(v){ try{ localStorage.setItem(GLOBAL_KETA_NOTE_KEY, String(v||"")); }catch(e){} }

    function applyVars(){
      const c = STATE.colors;
      document.documentElement.style.setProperty("--bg1", c.bg1);
      document.documentElement.style.setProperty("--bg2", c.bg2);
      document.documentElement.style.setProperty("--bg3", c.bg3);
      document.documentElement.style.setProperty("--bg4", c.bg4);
      document.documentElement.style.setProperty("--angle", (c.angle||145) + "deg");
      document.documentElement.style.setProperty("--txt", c.txt);
      document.documentElement.style.setProperty("--uiSize", (c.uiSize||12) + "px");

      const t = STATE.type || DEFAULT.type;
      document.documentElement.style.setProperty("--titleMaxPx", clamp(parseInt(t.titleMax,10)||180, 120, 260) + "px");
      document.documentElement.style.setProperty("--linkSizePx", clamp(parseInt(t.linkSize,10)||11, 10, 18) + "px");

      $("bgLayer").style.animationDuration = (10 / (STATE.motion.speed || 0.55)).toFixed(2) + "s";
      $("bgLayer").style.animationPlayState = STATE.motion.on ? "running" : "paused";

      $("motionLabel").textContent = STATE.motion.on ? "ON" : "OFF";
    }

    /* SNAP */
    let snapLocked = false;
    let intent = 0;
    let lastDir = 0;
    let holdTimer = null;

    const HOLD_MS = 120;
    const THRESH = 120;
    const DECAY = 0.88;

    function doSnap(dir){
      const atTop = (window.scrollY || 0) < 8;
      const target = atTop ? (dir > 0 ? "directory" : "top") : (dir < 0 ? "top" : "directory");
      document.getElementById(target)?.scrollIntoView({ behavior: "auto", block: "start" });
    }

    window.addEventListener("wheel", (e)=>{
      if (snapLocked) return;

      const dir = e.deltaY > 0 ? 1 : -1;

      const y = window.scrollY || 0;
      const maxY = (document.documentElement.scrollHeight - window.innerHeight) || 0;
      const nearTop = y < 12;
      const nearBottom = (maxY - y) < 12;

      if (!nearTop && !nearBottom) return;

      e.preventDefault();

      const d = Math.min(140, Math.abs(e.deltaY));
      intent = intent * DECAY + d;

      if (dir !== lastDir){
        lastDir = dir;
        intent = d;
        if (holdTimer) clearTimeout(holdTimer);
        holdTimer = null;
      }

      if (intent >= THRESH && !holdTimer){
        holdTimer = setTimeout(()=>{
          snapLocked = true;
          doSnap(dir);

          intent = 0;
          lastDir = 0;
          holdTimer = null;

          setTimeout(()=>{ snapLocked = false; }, 180);
        }, HOLD_MS);
      }
    }, { passive: false });

    function buildDirectory(){
      const grid = $("dirGrid");
      grid.innerHTML = "";

      DIRECTORY.forEach((block)=>{
        const title = document.createElement("div");
        title.className = "dirGroupTitle";
        title.textContent = block.group;
        grid.appendChild(title);

        block.items.forEach(([label, href])=>{
          const row = document.createElement("div");
          row.className = "dirItem";
          row.innerHTML = `<a class="klink" href="${href}">${label}</a><span class="tag">PAGE</span>`;
          grid.appendChild(row);
        });
      });
    }

    function renderHud(){
      document.body.classList.toggle("invert", !!STATE.ui.invert);
      document.documentElement.style.setProperty("--hudOpacity", STATE.ui.nullMode ? "0" : "1");

      $("nullLabel").textContent = STATE.ui.nullMode ? "ON" : "OFF";
      $("invLabel").textContent = STATE.ui.invert ? "ON" : "OFF";
      $("lightLabel").textContent = String(STATE.ui.lightPreset||1);
      $("runLabel").textContent = STATE.ui.lightRunning ? "ON" : "OFF";

      $("controlPanel").style.display = (STATE.ui.panelVisible && !STATE.ui.nullMode) ? "block" : "none";
      $("cpBody").classList.toggle("collapsed", !!STATE.ui.panelCollapsed);

      $("ketaNote").style.display = (STATE.ui.noteVisible && !STATE.ui.nullMode) ? "flex" : "none";
    }

    function tick(now){
      if(STATE.motion.on){
        const sp = (STATE.motion.speed||0.55);
        const t = now * 0.00022 * sp;

        const aX = 18 + Math.sin(t*1.20)*10;
        const aY = 20 + Math.cos(t*1.05)*9;
        const bX = 78 + Math.cos(t*1.10)*11;
        const bY = 28 + Math.sin(t*1.00)*8;
        const cX = 28 + Math.sin(t*0.90)*12;
        const cY = 86 + Math.cos(t*0.95)*10;
        const dX = 86 + Math.cos(t*1.15)*9;
        const dY = 82 + Math.sin(t*1.25)*8;

        const root = document.documentElement.style;
        root.setProperty("--aX", aX.toFixed(2) + "%");
        root.setProperty("--aY", aY.toFixed(2) + "%");
        root.setProperty("--bX", bX.toFixed(2) + "%");
        root.setProperty("--bY", bY.toFixed(2) + "%");
        root.setProperty("--cX", cX.toFixed(2) + "%");
        root.setProperty("--cY", cY.toFixed(2) + "%");
        root.setProperty("--dX", dX.toFixed(2) + "%");
        root.setProperty("--dY", dY.toFixed(2) + "%");
      }
      requestAnimationFrame(tick);
    }

    const ui = {
      btnPanel: $("btnPanel"),
      btnSystem: $("btnSystem"),
      cpToggle: $("cpToggle"),
      cpHide: $("cpHide"),
      btnMotion: $("btnMotion"),
      motionSpeed: $("motionSpeed"),
      bg1: $("bg1"), bg2:$("bg2"), bg3:$("bg3"), bg4:$("bg4"),
      angle:$("angle"), txt:$("txt"), uiSize:$("uiSize"),
      titleMax:$("titleMax"),
      linkSize:$("linkSize")
    };

    function syncInputs(){
      const c = STATE.colors;
      ui.bg1.value=c.bg1; ui.bg2.value=c.bg2; ui.bg3.value=c.bg3; ui.bg4.value=c.bg4;
      ui.angle.value=String(c.angle||145);
      ui.txt.value=c.txt;
      ui.uiSize.value=String(c.uiSize||12);
      ui.motionSpeed.value=String(STATE.motion.speed||0.55);

      ui.titleMax.value = String((STATE.type && STATE.type.titleMax) ?? 180);
      ui.linkSize.value = String((STATE.type && STATE.type.linkSize) ?? 11);

      ui.btnMotion.classList.toggle("on", !!STATE.motion.on);
      ui.btnMotion.textContent = STATE.motion.on ? "ON" : "OFF";
      ui.cpToggle.textContent = STATE.ui.panelCollapsed ? "+" : "–";
    }

    function updateColorsFromInputs(){
      STATE.colors.bg1 = ui.bg1.value;
      STATE.colors.bg2 = ui.bg2.value;
      STATE.colors.bg3 = ui.bg3.value;
      STATE.colors.bg4 = ui.bg4.value;
      STATE.colors.angle = parseInt(ui.angle.value,10)||145;
      STATE.colors.txt = ui.txt.value;
      STATE.colors.uiSize = parseInt(ui.uiSize.value,10)||12;
      applyVars();
      persist();
    }

    function updateTypeFromInputs(){
      STATE.type = STATE.type || { titleMax:180, linkSize:11 };
      STATE.type.titleMax = parseInt(ui.titleMax.value,10)||180;
      STATE.type.linkSize = parseInt(ui.linkSize.value,10)||11;
      applyVars();
      persist();
    }

    ui.btnPanel.addEventListener("click", ()=>{ STATE.ui.panelVisible = !STATE.ui.panelVisible; persist(); });
    ui.btnSystem.addEventListener("click", ()=>{ STATE.ui.panelCollapsed = !STATE.ui.panelCollapsed; syncInputs(); persist(); });
    ui.cpToggle.addEventListener("click", ()=>{ STATE.ui.panelCollapsed = !STATE.ui.panelCollapsed; syncInputs(); persist(); });
    ui.cpHide.addEventListener("click", ()=>{ STATE.ui.panelVisible = false; persist(); });

    ui.btnMotion.addEventListener("click", ()=>{
      STATE.motion.on = !STATE.motion.on;
      syncInputs();
      applyVars();
      persist();
    });

    ui.motionSpeed.addEventListener("input", (e)=>{
      STATE.motion.speed = parseFloat(e.target.value)||0.55;
      applyVars();
      persist();
    });

    [ui.bg1,ui.bg2,ui.bg3,ui.bg4,ui.angle,ui.txt,ui.uiSize].forEach(el=>{
      el.addEventListener("input", updateColorsFromInputs);
      el.addEventListener("change", updateColorsFromInputs);
    });

    [ui.titleMax, ui.linkSize].forEach(el=>{
      el.addEventListener("input", updateTypeFromInputs);
      el.addEventListener("change", updateTypeFromInputs);
    });

    $("btnNoteIcon").addEventListener("click", ()=>{ STATE.ui.noteVisible = !STATE.ui.noteVisible; persist(); });
    $("btnHideNote").addEventListener("click", ()=>{ STATE.ui.noteVisible = false; persist(); });

    const ketaText = $("ketaText");
    ketaText.value = loadGlobalNote();
    ketaText.addEventListener("input", ()=> saveGlobalNote(ketaText.value||""));

    (function noteDrag(){
      const note=$("ketaNote"), head=$("ketaHead");
      let d=false, ox=0, oy=0;
      head.addEventListener("mousedown",(e)=>{
        d=true;
        const r=note.getBoundingClientRect();
        ox=e.clientX-r.left; oy=e.clientY-r.top;
        e.preventDefault();
      });
      window.addEventListener("mousemove",(e)=>{
        if(!d) return;
        note.style.left=""; note.style.right="auto";
        note.style.top = clamp(e.clientY-oy, 50, window.innerHeight - note.offsetHeight - 50) + "px";
        note.style.left = clamp(e.clientX-ox, 6, window.innerWidth - note.offsetWidth - 6) + "px";
      });
      window.addEventListener("mouseup",()=>d=false);
    })();

    (function panelDrag(){
      const p=$("controlPanel"), h=$("cpHead");
      let d=false, ox=0, oy=0;
      h.addEventListener("mousedown",(e)=>{
        d=true;
        const r=p.getBoundingClientRect();
        ox=e.clientX-r.left; oy=e.clientY-r.top;
        e.preventDefault();
      });
      window.addEventListener("mousemove",(e)=>{
        if(!d) return;
        p.style.left="auto"; p.style.right="auto";
        p.style.top = clamp(e.clientY-oy, 50, window.innerHeight - p.offsetHeight - 50) + "px";
        p.style.left = clamp(e.clientX-ox, 6, window.innerWidth - p.offsetWidth - 6) + "px";
      });
      window.addEventListener("mouseup",()=>d=false);
    })();

    /* LIGHTS OVERLAY */
    const overlay = $("lightOverlay");
    let lightInterval=null, lightCount=0, auxA=0, auxB=0;

    function stopLight(silent){
      if(lightInterval) clearInterval(lightInterval);
      lightInterval=null;
      STATE.ui.lightRunning=false;
      overlay.style.opacity = "0";
      overlay.style.backgroundColor = "#000";
      overlay.style.filter = "none";
      if(!silent) persist();
    }

    function startLight(preset){
      stopLight(true);
      STATE.ui.lightPreset = preset;
      STATE.ui.lightRunning = true;
      overlay.style.opacity = "0.85";

      lightCount=0; auxA=0; auxB=0;

      if(preset===1){
        lightInterval=setInterval(()=>{
          const on = overlay.dataset.on === "1";
          overlay.dataset.on = on ? "0" : "1";
          overlay.style.backgroundColor = on ? "#000" : "#fff";
          overlay.style.filter = "contrast(2.4)";
        }, 50);
      }
      if(preset===2){
        lightInterval=setInterval(()=>{
          auxA=(auxA+24)%360;
          auxB+=0.35;
          const l = 45 + Math.sin(auxB)*35;
          overlay.style.backgroundColor = `hsl(${auxA},100%,${l}%)`;
          overlay.style.filter = "contrast(2.2)";
        }, 18);
      }
      if(preset===3){
        lightInterval=setInterval(()=>{
          lightCount++;
          const beat = lightCount%16;
          if(beat===0 || beat===1){
            overlay.style.backgroundColor="#fff";
            overlay.style.filter="contrast(3.0) brightness(1.35)";
          } else if(beat===2){
            overlay.style.backgroundColor="#000";
            overlay.style.filter="contrast(2.2)";
          } else {
            overlay.style.backgroundColor="#000";
            overlay.style.filter="none";
          }
        }, 50);
      }
      if(preset===4){
        lightInterval=setInterval(()=>{
          auxB += 0.08;
          const v = 0.5 + 0.5*Math.sin(auxB);
          overlay.style.backgroundColor = "#fff";
          overlay.style.filter = `brightness(${0.35+v*0.95}) contrast(${1.6+v*1.4})`;
        }, 16);
      }
      if(preset===5){
        lightInterval=setInterval(()=>{
          auxB += 0.11;
          const v = 0.5 + 0.5*Math.sin(auxB);
          overlay.style.backgroundColor = v>0.5 ? "#fff" : "#000";
          overlay.style.filter = "contrast(2.6)";
        }, 90);
      }
      if(preset===6){
        lightInterval=setInterval(()=>{
          auxB += 0.06;
          const v = 0.5 + 0.5*Math.sin(auxB);
          overlay.style.backgroundColor = "#fff";
          overlay.style.filter = `invert(${v}) contrast(${1.8+v*1.2}) brightness(${0.7+v*0.8})`;
        }, 16);
      }
      persist();
    }

    function toggleTransport(){
      if(STATE.ui.lightRunning) stopLight(true);
      else startLight(STATE.ui.lightPreset||1);
      persist();
    }

    /* HOTKEYS */
    window.addEventListener("keydown", (e)=>{
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
      const typing = (tag==="textarea" || tag==="input" || tag==="select");

      if(!typing && e.shiftKey && e.key==="I"){ STATE.ui.invert = !STATE.ui.invert; persist(); }
      if(!typing && e.shiftKey && e.key==="0"){
        STATE.ui.nullMode = !STATE.ui.nullMode;
        if(STATE.ui.nullMode) STATE.ui.noteVisible=false;
        persist();
      }
      if(!typing && e.shiftKey && (e.key==="B" || e.key==="b")) window.location.href = SHELL_HOME_URL;
      if(!typing && e.shiftKey && (e.key==="K" || e.key==="k")) window.location.href = LANDING_URL;

      if(!typing && e.code==="Space"){ e.preventDefault(); toggleTransport(); }

      if(!typing && !e.shiftKey && !e.ctrlKey && !e.metaKey){
        const n = parseInt(e.key,10);
        if(n>=1 && n<=6) startLight(n);
      }
      if(!typing && e.key==="Escape"){
        if(STATE.ui.nullMode){ STATE.ui.nullMode=false; persist(); }
      }
    });

    function init(){
      buildDirectory();
      syncInputs();
      applyVars();
      renderHud();
      stopLight(true);
      persist();
      requestAnimationFrame(tick);
    }
    init();
  </script>
</body>
</html>

<!--
============================================================
KETADATA HTML SERIALIZATION STAMP
AE/EE/WB: WB
FILE_ID: KETADATA_STUDIO
ROOM_ID: STUDIO
VERSION: studio.v6_centered_small_margins
UPDATED_AT: 2025-12-27T00:00:00-05:00
CHANGELOG:
- LANDING TITLE DEFAULT POSITION IS CENTERED (RELATIVE) WITH SMALL MARGINS AND HARD FIT INSIDE SCREEN
============================================================
-->
