<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KETADATA // INTERFACE ANNOTATOR</title>
  <style>
    :root{
      --bg:#000;
      --fg:#fff;

      --stroke:rgba(255,255,255,0.18);
      --stroke2:rgba(255,255,255,0.12);

      --glass:rgba(255,255,255,0.06);
      --panel:rgba(0,0,0,0.86);
      --shadow:rgba(0,0,0,0.78);

      --muted:rgba(255,255,255,0.62);
      --muted2:rgba(255,255,255,0.40);

      --node:rgba(255,255,255,0.22);
      --nodeOn:rgba(255,255,255,0.65);

      --danger:rgba(255,255,255,0.88);
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:Arial, Helvetica, sans-serif;}
    body{overflow:hidden;}
    button,input,select,textarea{font-family:inherit}

    /* layout */
    #app{
      position:fixed; inset:0;
      display:grid;
      grid-template-columns: 1fr;
      grid-template-rows: 48px 1fr;
      background:#000;
    }

    /* topbar */
    #topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border-bottom:1px solid var(--stroke2);
      background:#000;
      user-select:none;
    }
    #brand{
      display:flex; align-items:center; gap:10px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      font-size:11px;
      color:rgba(255,255,255,0.80);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:220px;
    }
    .noteBox{
      width:10px; height:10px; background:#fff;
      display:inline-block;
    }
    #topbarRight{
      display:flex; align-items:center; gap:8px;
    }

    .btn{
      border:1px solid var(--stroke);
      background:transparent;
      color:rgba(255,255,255,0.86);
      padding:7px 10px;
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      cursor:pointer;
    }
    .btn:hover{ background:var(--glass); border-color:rgba(255,255,255,0.34); }

    .btnPrimary{
      border-color:rgba(255,255,255,0.30);
      background:rgba(255,255,255,0.06);
    }
    .btnPrimary:hover{
      background:rgba(255,255,255,0.09);
      border-color:rgba(255,255,255,0.44);
    }

    .tiny{
      padding:6px 8px;
      font-size:10px;
      letter-spacing:0.16em;
    }

    /* WHITE NOTE ICON (required) */
    #noteIcon{
      width:28px; height:28px;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,0.20);
      background:rgba(255,255,255,0.10);
      cursor:pointer;
    }
    #noteIcon:hover{
      border-color:rgba(255,255,255,0.36);
      background:rgba(255,255,255,0.14);
    }
    #noteIcon .sq{
      width:10px; height:10px; background:#fff;
    }

    /* main */
    #main{
      display:grid;
      grid-template-columns: 320px 1fr 320px;
      height:100%;
      min-height:0;
    }

    /* left panel (tabs + interface registry) */
    .panel{
      border-right:1px solid var(--stroke2);
      background:rgba(0,0,0,0.90);
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    #rightPanel{
      border-right:none;
      border-left:1px solid var(--stroke2);
    }

    .panelHeader{
      padding:12px;
      border-bottom:1px solid var(--stroke2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    .panelTitle{
      margin:0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.78);
      display:flex; align-items:center; gap:10px;
    }
    .panelBody{
      padding:12px;
      overflow:auto;
      min-height:0;
    }

    .field{
      display:grid;
      gap:6px;
      margin-bottom:12px;
    }
    label{
      font-size:11px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.60);
    }
    input[type="text"], textarea, select{
      width:100%;
      border:1px solid rgba(255,255,255,0.16);
      background:rgba(255,255,255,0.04);
      color:rgba(255,255,255,0.90);
      padding:9px 10px;
      font-size:12px;
      outline:none;
    }
    textarea{min-height:84px; resize:vertical;}
    input[type="text"]:focus, textarea:focus, select:focus{
      border-color:rgba(255,255,255,0.36);
      background:rgba(255,255,255,0.06);
    }
    .hint{
      font-size:11px;
      line-height:1.35;
      color:rgba(255,255,255,0.48);
      letter-spacing:0.04em;
    }

    /* tab list */
    #tabList{
      display:grid;
      gap:8px;
    }
    .tabItem{
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.03);
      padding:10px;
      cursor:pointer;
      display:grid;
      gap:6px;
    }
    .tabItem:hover{ background:rgba(255,255,255,0.05); border-color:rgba(255,255,255,0.22); }
    .tabItem.active{
      background:rgba(255,255,255,0.07);
      border-color:rgba(255,255,255,0.32);
    }
    .tabTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .tabName{
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.86);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .pill{
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.55);
      border:1px solid rgba(255,255,255,0.14);
      padding:3px 6px;
      background:rgba(0,0,0,0.40);
      white-space:nowrap;
    }
    .tabMeta{
      display:flex; flex-wrap:wrap; gap:6px;
    }

    /* center stage */
    #stageWrap{
      position:relative;
      min-height:0;
      overflow:hidden;
      background:#000;
    }

    #stageHeader{
      position:absolute;
      left:12px; top:12px;
      z-index:8;
      pointer-events:none;
      display:flex;
      align-items:center;
      gap:10px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      font-size:11px;
      color:rgba(255,255,255,0.78);
    }

    /* command/control (drawer toggle) */
    #cc{
      position:absolute;
      right:12px; top:12px;
      z-index:9;
      width:28px; height:28px;
      border:1px solid rgba(255,255,255,0.24);
      background:rgba(0,0,0,0.45);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      cursor:pointer;
      display:grid;
      place-items:center;
      padding:0;
    }
    #cc:hover{ background:rgba(255,255,255,0.06); border-color:rgba(255,255,255,0.38); }
    #ccGlyph{
      width:10px; height:10px;
      border:1px solid rgba(255,255,255,0.55);
      opacity:0.85;
    }

    /* viewer */
    #viewer{
      position:absolute; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      background:#000;
    }
    #viewerInner{
      position:relative;
      width:min(94%, 1100px);
      height:min(92%, 780px);
      border:1px solid var(--stroke);
      box-shadow:0 22px 90px var(--shadow);
      background:#000;
      overflow:hidden;
    }
    #iframe{
      position:absolute; inset:0;
      width:100%; height:100%;
      border:0;
      background:#000;
    }
    #img{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:contain;
      display:none;
      background:#000;
      image-rendering:auto;
    }

    /* annotation layer */
    #annoLayer{
      position:absolute; inset:0;
      z-index:6;
      pointer-events:auto;
    }
    #annoLayer.locked{ pointer-events:none; }
    #crosshair{
      position:absolute;
      width:10px; height:10px;
      margin:-5px 0 0 -5px;
      border:1px solid rgba(255,255,255,0.24);
      background:rgba(255,255,255,0.06);
      display:none;
      pointer-events:none;
      z-index:7;
    }

    /* annotation pins */
    .pin{
      position:absolute;
      width:10px; height:10px;
      margin:-5px 0 0 -5px;
      border-radius:999px;
      background:rgba(255,255,255,0.28);
      border:1px solid rgba(255,255,255,0.14);
      cursor:pointer;
      opacity:0.65;
      transition:opacity 120ms linear, transform 120ms linear, background 120ms linear;
    }
    .pin:hover{ opacity:0.95; }
    .pin.active{
      opacity:1;
      background:rgba(255,255,255,0.70);
      transform:scale(1.18);
      border-color:rgba(255,255,255,0.28);
    }

    /* minimal bottom whisper */
    #whisper{
      position:absolute;
      left:12px; bottom:12px;
      z-index:8;
      color:rgba(255,255,255,0.34);
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      user-select:none;
      pointer-events:none;
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      max-width:70%;
    }

    /* right panel: note editor + glossary + prompt/state */
    .subsection{
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.03);
      padding:12px;
      margin-bottom:12px;
    }
    .subTitle{
      margin:0 0 10px 0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.74);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .tagRow{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:8px;
    }
    .tag{
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(0,0,0,0.35);
      color:rgba(255,255,255,0.62);
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      padding:4px 6px;
    }

    .miniBtns{ display:flex; gap:8px; flex-wrap:wrap; }

    /* glossary subtle */
    #glossary{
      font-size:11px;
      line-height:1.35;
      color:rgba(255,255,255,0.52);
      letter-spacing:0.04em;
    }
    #glossary .gline{
      display:flex; justify-content:space-between; gap:10px;
      padding:6px 0;
      border-top:1px solid rgba(255,255,255,0.08);
    }
    #glossary .gterm{
      letter-spacing:0.14em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.66);
      white-space:nowrap;
    }
    #glossary .gdef{
      color:rgba(255,255,255,0.48);
      text-align:right;
    }

    /* modal (white note icon opens this) */
    #modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.72);
      display:none;
      z-index:50;
    }
    #modal{
      position:absolute;
      right:16px; top:58px;
      width:min(460px, calc(100% - 32px));
      border:1px solid rgba(255,255,255,0.22);
      background:rgba(0,0,0,0.92);
      box-shadow:0 28px 110px rgba(0,0,0,0.82);
      padding:12px;
    }
    #modalTitle{
      margin:0 0 10px 0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.82);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
  </style>
</head>

<body>
  <div id="app">
    <div id="topbar">
      <div id="brand">
        <span class="noteBox" aria-hidden="true"></span>
        <span>KETADATA // INTERFACE ANNOTATOR</span>
      </div>

      <div id="topbarRight">
        <!-- REQUIRED WHITE NOTE BOX UPPER RIGHT -->
        <button id="noteIcon" type="button" aria-label="Notes">
          <span class="sq" aria-hidden="true"></span>
        </button>

        <button id="exportState" class="btn btnPrimary tiny" type="button">Export State</button>
        <button id="importState" class="btn tiny" type="button">Import State</button>
        <button id="exportPrompt" class="btn tiny" type="button">Export Prompt</button>
      </div>
    </div>

    <div id="main">
      <!-- LEFT PANEL -->
      <div class="panel" id="leftPanel">
        <div class="panelHeader">
          <p class="panelTitle"><span class="noteBox" aria-hidden="true"></span> Interfaces</p>
          <button id="newTab" class="btn tiny" type="button">New</button>
        </div>

        <div class="panelBody">
          <div class="field">
            <label for="globalProject">Project / Set</label>
            <input id="globalProject" type="text" value="KETADATA" />
          </div>

          <div class="field">
            <label for="globalRoom">Room Context</label>
            <select id="globalRoom">
              <option>ENTRY</option>
              <option>LOBBY</option>
              <option>TEMPLE</option>
              <option>ELEVATOR</option>
              <option>OBSERVATORY</option>
              <option>KDTV CINEMA</option>
              <option>LIBRARY</option>
              <option>ROOM</option>
              <option>STUDIO</option>
              <option>LAB</option>
              <option>VAULT</option>
              <option>BASEMENT</option>
              <option>GIFT SHOP</option>
              <option>WHITE ROOM</option>
            </select>
            <div class="hint">Context only. Interfaces still declare VI / DI / VI-DI.</div>
          </div>

          <div class="field">
            <label>Interface Tabs</label>
            <div id="tabList"></div>
          </div>
        </div>
      </div>

      <!-- CENTER STAGE -->
      <div id="stageWrap">
        <div id="stageHeader">
          <span class="noteBox" aria-hidden="true"></span>
          <span id="stageTitle">NO INTERFACE LOADED</span>
        </div>

        <button id="cc" type="button" aria-label="Command / Control">
          <span id="ccGlyph" aria-hidden="true"></span>
        </button>

        <div id="viewer">
          <div id="viewerInner">
            <iframe id="iframe" title="Interface Preview" sandbox="allow-scripts allow-forms allow-same-origin allow-pointer-lock allow-popups"></iframe>
            <img id="img" alt="Interface Reference" />
            <div id="annoLayer"></div>
            <div id="crosshair"></div>
          </div>
        </div>

        <div id="whisper">
          <span>BLACK ONLY</span>
          <span>NO GRADIENTS</span>
          <span><span class="noteBox" style="width:8px;height:8px;"></span> NOTES</span>
          <span>DOUBLE-CLICK = PIN</span>
          <span>DRAG PIN = MOVE</span>
        </div>
      </div>

      <!-- RIGHT PANEL -->
      <div class="panel" id="rightPanel">
        <div class="panelHeader">
          <p class="panelTitle"><span class="noteBox" aria-hidden="true"></span> Annotation</p>
          <button id="deletePin" class="btn tiny" type="button">Delete</button>
        </div>

        <div class="panelBody">
          <!-- Current interface settings -->
          <div class="subsection">
            <p class="subTitle">
              <span>Interface</span>
              <span class="pill" id="ifaceTypePill">—</span>
            </p>

            <div class="field">
              <label for="ifaceName">Name</label>
              <input id="ifaceName" type="text" placeholder="e.g. photobooth-crunch-v1" />
            </div>

            <div class="field">
              <label for="ifaceType">Type (VI / DI / VI-DI)</label>
              <select id="ifaceType">
                <option>VI</option>
                <option>DI</option>
                <option>VI-DI</option>
              </select>
            </div>

            <div class="field">
              <label for="ifaceSource">Source (URL or Image)</label>
              <select id="ifaceSource">
                <option value="url">URL (iframe)</option>
                <option value="image">Image (upload)</option>
                <option value="blank">Blank canvas</option>
              </select>
            </div>

            <div class="field" id="urlField">
              <label for="ifaceUrl">URL</label>
              <input id="ifaceUrl" type="text" placeholder="https://ketadata.com/studio.html" />
              <div class="hint">Iframe cannot be annotated *inside* the DOM; pins attach to the visual plane.</div>
            </div>

            <div class="field" id="imgField" style="display:none;">
              <label for="ifaceImg">Upload Image</label>
              <input id="ifaceImg" type="file" accept="image/*" />
              <div class="hint">Use for stable markup, screenshots, comps, exported frames.</div>
            </div>

            <div class="miniBtns">
              <button id="loadInterface" class="btn btnPrimary tiny" type="button">Load</button>
              <button id="clearPins" class="btn tiny" type="button">Clear Pins</button>
            </div>
          </div>

          <!-- Selected note -->
          <div class="subsection">
            <p class="subTitle">
              <span>Note</span>
              <span class="pill" id="pinIdPill">—</span>
            </p>

            <div class="field">
              <label for="pinTitle">Title</label>
              <input id="pinTitle" type="text" placeholder="short label" />
            </div>

            <div class="field">
              <label for="pinComponent">Component (free label)</label>
              <input id="pinComponent" type="text" placeholder="e.g. ccBtn / rail nodes / viewerInner" />
            </div>

            <div class="field">
              <label for="pinGlossary">Glossary Tag (subtle structure)</label>
              <select id="pinGlossary">
                <option value="">—</option>
                <option>ROOM</option>
                <option>INTERFACE</option>
                <option>MODULE</option>
                <option>CONTROL</option>
                <option>NOTE</option>
                <option>STATE</option>
                <option>PROMPT</option>
                <option>LIGHT</option>
                <option>COLLAPSE</option>
                <option>MODE</option>
                <option>ACCESS</option>
                <option>TRANSITION</option>
              </select>
              <div class="hint">This is the tagging spine for later indexing.</div>
            </div>

            <div class="field">
              <label for="pinSeverity">Priority</label>
              <select id="pinSeverity">
                <option value="n">N</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
              </select>
              <div class="hint">N = neutral; 3 = fix now.</div>
            </div>

            <div class="field">
              <label for="pinText">Body</label>
              <textarea id="pinText" placeholder="note text"></textarea>
            </div>

            <div class="field">
              <label for="pinTags">Tags (comma separated)</label>
              <input id="pinTags" type="text" placeholder="e.g. collapse, hotkeys, node-visibility" />
            </div>

            <div class="miniBtns">
              <button id="savePin" class="btn btnPrimary tiny" type="button">Save Note</button>
              <button id="newPin" class="btn tiny" type="button">New Pin</button>
            </div>

            <div class="hint">Double-click stage to place a pin. Drag pins to reposition.</div>
          </div>

          <!-- prompt / state -->
          <div class="subsection">
            <p class="subTitle"><span>Prompt / State</span></p>
            <div class="miniBtns">
              <button id="copyStateJson" class="btn tiny" type="button">Copy State JSON</button>
              <button id="copyNotesJson" class="btn tiny" type="button">Copy Notes JSON</button>
              <button id="copyPrompt" class="btn btnPrimary tiny" type="button">Copy Prompt</button>
            </div>
            <div class="hint">
              States are portable snapshots; prompts are extracted intent/spec. Both are first-class exports.
            </div>
          </div>

          <!-- glossary subtle -->
          <div class="subsection">
            <p class="subTitle"><span>Glossary (subtle)</span></p>
            <div id="glossary" aria-label="Interface glossary">
              <div class="gline"><span class="gterm">ROOM</span><span class="gdef">context container</span></div>
              <div class="gline"><span class="gterm">INTERFACE</span><span class="gdef">action surface</span></div>
              <div class="gline"><span class="gterm">MODULE</span><span class="gdef">collapsible unit</span></div>
              <div class="gline"><span class="gterm">CONTROL</span><span class="gdef">adjustable variable</span></div>
              <div class="gline"><span class="gterm">NOTE</span><span class="gdef">atomic cognition</span></div>
              <div class="gline"><span class="gterm">STATE</span><span class="gdef">serialized perception</span></div>
              <div class="gline"><span class="gterm">PROMPT</span><span class="gdef">extracted intent</span></div>
              <div class="gline"><span class="gterm">COLLAPSE</span><span class="gdef">modality shift</span></div>
              <div class="gline"><span class="gterm">MODE</span><span class="gdef">global modifier</span></div>
              <div class="gline"><span class="gterm">LIGHT</span><span class="gdef">global modulation</span></div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- top-right NOTE modal -->
  <div id="modalBack" aria-hidden="true">
    <div id="modal" role="dialog" aria-label="Global Notes">
      <div id="modalTitle">
        <span><span class="noteBox" style="width:9px;height:9px;"></span> GLOBAL NOTE</span>
        <button id="closeModal" class="btn tiny" type="button">Close</button>
      </div>
      <div class="field">
        <label for="globalNote">Text</label>
        <textarea id="globalNote" placeholder="system note"></textarea>
        <div class="hint">This persists in state exports. Use for global constraints, rules, reminders.</div>
      </div>
      <div class="miniBtns">
        <button id="saveGlobalNote" class="btn btnPrimary tiny" type="button">Save</button>
        <button id="clearGlobalNote" class="btn tiny" type="button">Clear</button>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // KETADATA Interface Annotator
    // - 1 interface per tab
    // - visually attach notes (pins) to components/regions
    // - structured but free-form
    // - subtle glossary + glossary tagging field
    // - required NOTE icon (white square upper right)
    // - state + prompt exports
    // =========================

    // ---------- DOM ----------
    const tabList = document.getElementById('tabList');
    const newTabBtn = document.getElementById('newTab');

    const globalProject = document.getElementById('globalProject');
    const globalRoom = document.getElementById('globalRoom');

    const stageTitle = document.getElementById('stageTitle');
    const viewerInner = document.getElementById('viewerInner');
    const annoLayer = document.getElementById('annoLayer');
    const crosshair = document.getElementById('crosshair');

    const iframe = document.getElementById('iframe');
    const img = document.getElementById('img');

    const ccBtn = document.getElementById('cc');
    const rightPanel = document.getElementById('rightPanel'); // we’ll "drawer" this subtly
    const leftPanel = document.getElementById('leftPanel');

    const ifaceName = document.getElementById('ifaceName');
    const ifaceType = document.getElementById('ifaceType');
    const ifaceTypePill = document.getElementById('ifaceTypePill');
    const ifaceSource = document.getElementById('ifaceSource');
    const ifaceUrl = document.getElementById('ifaceUrl');
    const ifaceImg = document.getElementById('ifaceImg');
    const urlField = document.getElementById('urlField');
    const imgField = document.getElementById('imgField');
    const loadInterfaceBtn = document.getElementById('loadInterface');
    const clearPinsBtn = document.getElementById('clearPins');

    const pinIdPill = document.getElementById('pinIdPill');
    const pinTitle = document.getElementById('pinTitle');
    const pinComponent = document.getElementById('pinComponent');
    const pinGlossary = document.getElementById('pinGlossary');
    const pinSeverity = document.getElementById('pinSeverity');
    const pinText = document.getElementById('pinText');
    const pinTags = document.getElementById('pinTags');
    const savePinBtn = document.getElementById('savePin');
    const newPinBtn = document.getElementById('newPin');
    const deletePinBtn = document.getElementById('deletePin');

    const exportStateBtn = document.getElementById('exportState');
    const importStateBtn = document.getElementById('importState');
    const exportPromptBtn = document.getElementById('exportPrompt');

    const copyStateJsonBtn = document.getElementById('copyStateJson');
    const copyNotesJsonBtn = document.getElementById('copyNotesJson');
    const copyPromptBtn = document.getElementById('copyPrompt');

    const noteIcon = document.getElementById('noteIcon');
    const modalBack = document.getElementById('modalBack');
    const closeModalBtn = document.getElementById('closeModal');
    const globalNoteEl = document.getElementById('globalNote');
    const saveGlobalNoteBtn = document.getElementById('saveGlobalNote');
    const clearGlobalNoteBtn = document.getElementById('clearGlobalNote');

    // ---------- UTIL ----------
    const uid = () => Math.random().toString(36).slice(2, 9) + "-" + Date.now().toString(36);
    const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
    function toast(text){
      // minimal: use document title flicker
      const t = document.title;
      document.title = text;
      setTimeout(()=>{ document.title = t; }, 600);
    }
    async function copyText(s){
      try{
        await navigator.clipboard.writeText(s);
        toast("COPIED");
      }catch{
        // fallback prompt
        window.prompt("Copy:", s);
      }
    }

    // ---------- DATA MODEL ----------
    // State shape:
    // {
    //  v:1,
    //  project, room, globalNote,
    //  ui: { rightOpen: boolean },
    //  tabs: [{id,name,type,source,url,imageDataUrl,notes:[...]}],
    //  activeTabId, activeNoteId
    // }
    const DEFAULT_TAB = () => ({
      id: uid(),
      name: "UNNAMED",
      type: "VI-DI",
      source: "blank", // url | image | blank
      url: "",
      imageDataUrl: "",
      notes: [] // [{id,x,y,title,component,glossary,severity,text,tags}]
    });

    let state = {
      v: 1,
      project: "KETADATA",
      room: "STUDIO",
      globalNote: "",
      ui: { rightOpen: true },
      tabs: [DEFAULT_TAB()],
      activeTabId: null,
      activeNoteId: null
    };

    // ---------- LOAD FROM HASH (optional) ----------
    function encodeState(obj){
      const json = JSON.stringify(obj);
      return btoa(unescape(encodeURIComponent(json)));
    }
    function decodeState(b64){
      const json = decodeURIComponent(escape(atob(b64)));
      return JSON.parse(json);
    }
    function applyHash(){
      const m = location.hash.match(/state=([^&]+)/);
      if(!m) return;
      try{
        const s = decodeState(m[1]);
        if(s && s.v === 1) state = s;
      }catch{}
    }
    applyHash();

    // ---------- DERIVED ----------
    function getActiveTab(){
      const id = state.activeTabId ?? state.tabs[0]?.id;
      return state.tabs.find(t=>t.id===id) || state.tabs[0];
    }
    function getActiveNote(tab){
      if(!tab) return null;
      const id = state.activeNoteId;
      return tab.notes.find(n=>n.id===id) || null;
    }

    // ---------- RENDER ----------
    function renderTabs(){
      tabList.innerHTML = "";
      state.tabs.forEach((t)=>{
        const el = document.createElement("div");
        el.className = "tabItem" + (t.id===getActiveTab().id ? " active" : "");
        el.innerHTML = `
          <div class="tabTop">
            <div class="tabName">${escapeHtml(t.name || "UNNAMED")}</div>
            <div class="pill">${escapeHtml(t.type)}</div>
          </div>
          <div class="tabMeta">
            <span class="pill">${escapeHtml((t.source||"blank").toUpperCase())}</span>
            <span class="pill">${t.notes.length} NOTES</span>
          </div>
        `;
        el.addEventListener("click", ()=>{
          state.activeTabId = t.id;
          state.activeNoteId = null;
          syncPanelsFromState();
          renderAll();
        });
        tabList.appendChild(el);
      });
    }

    function renderStage(){
      const tab = getActiveTab();
      stageTitle.textContent = `${tab.name || "UNNAMED"} // ${tab.type} // ${tab.source.toUpperCase()}`;

      // show correct surface
      iframe.style.display = tab.source === "url" ? "block" : "none";
      img.style.display = tab.source === "image" ? "block" : "none";

      if(tab.source === "url"){
        iframe.src = tab.url || "about:blank";
      }else if(tab.source === "image"){
        img.src = tab.imageDataUrl || "";
      }else{
        iframe.src = "about:blank";
        img.src = "";
      }

      // render pins
      annoLayer.innerHTML = "";
      tab.notes.forEach((n)=>{
        const p = document.createElement("div");
        p.className = "pin" + (n.id === state.activeNoteId ? " active" : "");
        p.style.left = (n.x*100) + "%";
        p.style.top = (n.y*100) + "%";
        p.title = n.title || "NOTE";
        p.dataset.id = n.id;

        // click select
        p.addEventListener("click", (e)=>{
          e.stopPropagation();
          state.activeNoteId = n.id;
          syncNoteEditorFromState();
          renderStage();
        });

        // drag move
        let dragging = false;
        let didMove = false;
        const onDown = (e)=>{
          e.preventDefault();
          e.stopPropagation();
          dragging = true; didMove = false;
          document.addEventListener("mousemove", onMove);
          document.addEventListener("mouseup", onUp, { once:true });
        };
        const onMove = (e)=>{
          if(!dragging) return;
          didMove = true;
          const r = annoLayer.getBoundingClientRect();
          const nx = clamp((e.clientX - r.left)/r.width, 0, 1);
          const ny = clamp((e.clientY - r.top)/r.height, 0, 1);
          n.x = nx; n.y = ny;
          p.style.left = (nx*100)+"%";
          p.style.top = (ny*100)+"%";
        };
        const onUp = ()=>{
          dragging = false;
          document.removeEventListener("mousemove", onMove);
          if(didMove) {
            state.activeNoteId = n.id;
            syncNoteEditorFromState();
            toast("MOVED");
          }
        };
        p.addEventListener("mousedown", onDown);

        annoLayer.appendChild(p);
      });
    }

    function renderRightPanelVisibility(){
      rightPanel.style.display = state.ui.rightOpen ? "flex" : "none";
      // Keep layout stable by also collapsing left if needed in future; for now only right.
      document.getElementById('main').style.gridTemplateColumns =
        state.ui.rightOpen ? "320px 1fr 320px" : "320px 1fr 0px";
    }

    function renderAll(){
      globalProject.value = state.project || "KETADATA";
      globalRoom.value = state.room || "STUDIO";
      globalNoteEl.value = state.globalNote || "";

      renderRightPanelVisibility();
      renderTabs();
      renderStage();
      syncNoteEditorFromState();
      syncIfaceEditorPills();
    }

    // ---------- SYNC PANELS ----------
    function syncPanelsFromState(){
      const tab = getActiveTab();
      ifaceName.value = tab.name || "";
      ifaceType.value = tab.type || "VI-DI";
      ifaceSource.value = tab.source || "blank";
      ifaceUrl.value = tab.url || "";
      ifaceTypePill.textContent = tab.type || "—";

      urlField.style.display = (tab.source === "url") ? "block" : "none";
      imgField.style.display = (tab.source === "image") ? "block" : "none";

      syncIfaceEditorPills();
      syncNoteEditorFromState();
    }

    function syncIfaceEditorPills(){
      const tab = getActiveTab();
      ifaceTypePill.textContent = tab.type || "—";
    }

    function syncNoteEditorFromState(){
      const tab = getActiveTab();
      const note = getActiveNote(tab);

      if(!note){
        pinIdPill.textContent = "—";
        pinTitle.value = "";
        pinComponent.value = "";
        pinGlossary.value = "";
        pinSeverity.value = "n";
        pinText.value = "";
        pinTags.value = "";
        return;
      }

      pinIdPill.textContent = note.id.slice(0,8).toUpperCase();
      pinTitle.value = note.title || "";
      pinComponent.value = note.component || "";
      pinGlossary.value = note.glossary || "";
      pinSeverity.value = note.severity || "n";
      pinText.value = note.text || "";
      pinTags.value = (note.tags || []).join(", ");
    }

    // ---------- ANNOTATION INTERACTIONS ----------
    function placePinAt(clientX, clientY){
      const tab = getActiveTab();
      const r = annoLayer.getBoundingClientRect();
      const x = clamp((clientX - r.left)/r.width, 0, 1);
      const y = clamp((clientY - r.top)/r.height, 0, 1);

      const n = {
        id: uid(),
        x, y,
        title: "NOTE",
        component: "",
        glossary: "",
        severity: "n",
        text: "",
        tags: []
      };
      tab.notes.push(n);
      state.activeNoteId = n.id;
      toast("PIN");
      syncNoteEditorFromState();
      renderStage();
    }

    // crosshair preview on move (subtle)
    annoLayer.addEventListener("mousemove", (e)=>{
      const r = annoLayer.getBoundingClientRect();
      const inside = e.clientX>=r.left && e.clientX<=r.right && e.clientY>=r.top && e.clientY<=r.bottom;
      if(!inside){ crosshair.style.display="none"; return; }
      crosshair.style.display="block";
      crosshair.style.left = (e.clientX - r.left) + "px";
      crosshair.style.top  = (e.clientY - r.top) + "px";
    });
    annoLayer.addEventListener("mouseleave", ()=>{ crosshair.style.display="none"; });

    // double-click to place
    annoLayer.addEventListener("dblclick", (e)=>{
      e.preventDefault();
      placePinAt(e.clientX, e.clientY);
    });

    // ---------- EVENTS ----------
    newTabBtn.addEventListener("click", ()=>{
      const t = DEFAULT_TAB();
      t.name = "NEW INTERFACE";
      state.tabs.unshift(t);
      state.activeTabId = t.id;
      state.activeNoteId = null;
      syncPanelsFromState();
      renderAll();
      toast("NEW TAB");
    });

    // global fields
    globalProject.addEventListener("input", ()=>{ state.project = globalProject.value; });
    globalRoom.addEventListener("change", ()=>{ state.room = globalRoom.value; });

    // interface editor writes to tab
    ifaceName.addEventListener("input", ()=>{
      const tab = getActiveTab();
      tab.name = ifaceName.value;
      renderTabs();
      renderStage();
    });
    ifaceType.addEventListener("change", ()=>{
      const tab = getActiveTab();
      tab.type = ifaceType.value;
      syncIfaceEditorPills();
      renderTabs();
      renderStage();
    });
    ifaceSource.addEventListener("change", ()=>{
      const tab = getActiveTab();
      tab.source = ifaceSource.value;
      urlField.style.display = (tab.source==="url") ? "block" : "none";
      imgField.style.display = (tab.source==="image") ? "block" : "none";
      renderTabs();
    });

    loadInterfaceBtn.addEventListener("click", ()=>{
      const tab = getActiveTab();
      tab.url = ifaceUrl.value.trim();
      tab.type = ifaceType.value;
      tab.name = ifaceName.value.trim() || tab.name;
      tab.source = ifaceSource.value;

      // load image if present
      if(tab.source==="image"){
        const f = ifaceImg.files?.[0];
        if(f){
          const reader = new FileReader();
          reader.onload = ()=>{
            tab.imageDataUrl = String(reader.result || "");
            state.activeNoteId = null;
            syncPanelsFromState();
            renderAll();
            toast("LOADED");
          };
          reader.readAsDataURL(f);
          return;
        }
      }

      state.activeNoteId = null;
      syncPanelsFromState();
      renderAll();
      toast("LOADED");
    });

    clearPinsBtn.addEventListener("click", ()=>{
      const tab = getActiveTab();
      tab.notes = [];
      state.activeNoteId = null;
      syncNoteEditorFromState();
      renderStage();
      renderTabs();
      toast("CLEARED");
    });

    // note editor save
    savePinBtn.addEventListener("click", ()=>{
      const tab = getActiveTab();
      const note = getActiveNote(tab);
      if(!note){ toast("NO NOTE"); return; }

      note.title = pinTitle.value.trim() || "NOTE";
      note.component = pinComponent.value.trim();
      note.glossary = pinGlossary.value;
      note.severity = pinSeverity.value;
      note.text = pinText.value;
      note.tags = pinTags.value.split(",").map(s=>s.trim()).filter(Boolean);

      renderStage();
      renderTabs();
      toast("SAVED");
    });

    newPinBtn.addEventListener("click", ()=>{
      // place pin in center
      const r = annoLayer.getBoundingClientRect();
      placePinAt(r.left + r.width/2, r.top + r.height/2);
    });

    deletePinBtn.addEventListener("click", ()=>{
      const tab = getActiveTab();
      const id = state.activeNoteId;
      if(!id){ toast("NO NOTE"); return; }
      tab.notes = tab.notes.filter(n=>n.id!==id);
      state.activeNoteId = null;
      syncNoteEditorFromState();
      renderStage();
      renderTabs();
      toast("DELETED");
    });

    // command/control toggles right panel (keep booth clean)
    ccBtn.addEventListener("click", ()=>{
      state.ui.rightOpen = !state.ui.rightOpen;
      renderRightPanelVisibility();
      toast(state.ui.rightOpen ? "PANEL" : "HIDE");
    });

    // top-right NOTE modal
    noteIcon.addEventListener("click", ()=>{
      modalBack.style.display = "block";
      modalBack.setAttribute("aria-hidden","false");
    });
    closeModalBtn.addEventListener("click", ()=>{
      modalBack.style.display = "none";
      modalBack.setAttribute("aria-hidden","true");
    });
    modalBack.addEventListener("click", (e)=>{
      if(e.target === modalBack){
        modalBack.style.display = "none";
        modalBack.setAttribute("aria-hidden","true");
      }
    });
    saveGlobalNoteBtn.addEventListener("click", ()=>{
      state.globalNote = globalNoteEl.value;
      toast("SAVED");
    });
    clearGlobalNoteBtn.addEventListener("click", ()=>{
      state.globalNote = "";
      globalNoteEl.value = "";
      toast("CLEARED");
    });

    // ---------- PROMPT / STATE EXPORTS ----------
    function buildPrompt(){
      const tab = getActiveTab();
      const notes = tab.notes.map(n=>({
        id:n.id,
        x:n.x, y:n.y,
        title:n.title,
        component:n.component,
        glossary:n.glossary,
        severity:n.severity,
        tags:n.tags,
        text:n.text
      }));

      const spec = {
        system: "KETADATA",
        tool: "Interface Annotator",
        project: state.project,
        room: state.room,
        interface: {
          name: tab.name,
          type: tab.type,
          source: tab.source,
          url: tab.url || "",
          notesCount: tab.notes.length
        },
        globalNote: state.globalNote || "",
        notes
      };

      // Tight prompt wrapper (copy-pasteable)
      return [
        "You are operating within the KETADATA system.",
        "Respect GLOBAL LAWS: black-only, no gradients, collapse-by-module, notes are white-square primitives, states+prompts exportable.",
        `ROOM CONTEXT: ${spec.room}`,
        `INTERFACE: ${spec.interface.name} (${spec.interface.type}) SOURCE=${spec.interface.source}${spec.interface.url?(" URL="+spec.interface.url):""}`,
        spec.globalNote ? `GLOBAL NOTE: ${spec.globalNote}` : "GLOBAL NOTE: (none)",
        "TASK: Implement revisions implied by the annotations. Preserve minimal black brutalism. Make hotkeys subtle. Keep control panels off-stage when possible.",
        "ANNOTATIONS (JSON):",
        JSON.stringify(spec.notes, null, 2)
      ].join("\n");
    }

    function exportState(){
      const s = JSON.parse(JSON.stringify(state));
      // keep hash stable: remove heavyweight image data from hash if huge (optional)
      // Here we keep it; user asked for portability. If it gets too large, export file instead.
      const b64 = encodeState(s);
      const url = location.origin + location.pathname + "#state=" + b64;
      return { state: s, url };
    }

    exportStateBtn.addEventListener("click", async ()=>{
      const { url } = exportState();
      await copyText(url);
      location.hash = url.split("#")[1];
    });

    importStateBtn.addEventListener("click", async ()=>{
      const pasted = window.prompt("Paste state URL or base64 payload:");
      if(!pasted) return;

      try{
        // accept full url or raw base64
        let b64 = pasted;
        const m = pasted.match(/state=([^&]+)/);
        if(m) b64 = m[1];
        const s = decodeState(b64);
        if(!s || s.v !== 1) throw new Error("Bad state");
        state = s;
        // normalize
        if(!state.tabs?.length) state.tabs = [DEFAULT_TAB()];
        if(!state.activeTabId) state.activeTabId = state.tabs[0].id;
        renderAll();
        toast("IMPORTED");
      }catch{
        toast("IMPORT FAIL");
      }
    });

    exportPromptBtn.addEventListener("click", async ()=>{
      const p = buildPrompt();
      await copyText(p);
    });

    copyStateJsonBtn.addEventListener("click", async ()=>{
      await copyText(JSON.stringify(state, null, 2));
    });

    copyNotesJsonBtn.addEventListener("click", async ()=>{
      const tab = getActiveTab();
      await copyText(JSON.stringify(tab.notes, null, 2));
    });

    copyPromptBtn.addEventListener("click", async ()=>{
      await copyText(buildPrompt());
    });

    // ---------- KEYBOARD ----------
    window.addEventListener("keydown", (e)=>{
      const k = e.key.toLowerCase();

      // Keep the surface clean: minimal hotkeys
      if(k === "c"){ // command/control toggle
        state.ui.rightOpen = !state.ui.rightOpen;
        renderRightPanelVisibility();
        toast(state.ui.rightOpen ? "PANEL" : "HIDE");
      }
      if(k === "n"){ // new pin center
        const r = annoLayer.getBoundingClientRect();
        placePinAt(r.left + r.width/2, r.top + r.height/2);
      }
      if(k === "delete" || k === "backspace"){
        if(state.activeNoteId){
          const tab = getActiveTab();
          tab.notes = tab.notes.filter(n=>n.id!==state.activeNoteId);
          state.activeNoteId = null;
          syncNoteEditorFromState();
          renderStage();
          renderTabs();
          toast("DELETED");
        }
      }
    });

    // ---------- HELPERS ----------
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (m)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    // ---------- INIT ----------
    // normalize
    state.project = state.project || "KETADATA";
    state.room = state.room || "STUDIO";
    state.tabs = state.tabs?.length ? state.tabs : [DEFAULT_TAB()];
    state.activeTabId = state.activeTabId || state.tabs[0].id;

    // start with a clean stage
    syncPanelsFromState();
    renderAll();
  </script>
</body>
</html>
