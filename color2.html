<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KETADATA — COLOR VAULT</title>
  <style>
    :root{
      --void:#000000;
      --panel:#0a0a0a;
      --panel2:#050505;
      --mind:#ffffff;

      --steel:#666666;
      --hair: rgba(255,255,255,.12);
      --hair2: rgba(255,255,255,.08);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: Arial, ui-sans-serif, system-ui, -apple-system, "Helvetica Neue", Helvetica, sans-serif;

      --grid: 12px;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      background: var(--void);
      color: var(--mind);
      font-family: var(--sans);
      overflow: hidden;
    }

    /* ====== TOP BAR (DECLUTTERED) ====== */
    header{
      height: 56px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 14px;
      border-bottom: 1px solid var(--hair);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.00));
    }

    .brand{
      display:flex;
      align-items:baseline;
      gap: 10px;
      min-width: 220px;
      user-select:none;
      white-space:nowrap;
    }
    .brand .k{
      font-family: var(--sans);
      font-weight: 800;
      letter-spacing: .16em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(255,255,255,.92);
    }
    .brand .slashes{
      font-family: var(--mono);
      font-weight: 800;
      letter-spacing: .32em;
      font-size: 12px;
      opacity:.9;
    }
    .brand .sub{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .14em;
      color: rgba(255,255,255,.55);
      text-transform: uppercase;
    }

    .headerCenter{
      display:flex;
      align-items:center;
      gap: 10px;
      flex: 1 1 auto;
      justify-content:center;
      min-width: 240px;
    }

    .search{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 8px 10px;
      border: 1px solid var(--hair);
      background: rgba(255,255,255,.02);
      min-width: min(760px, 62vw);
      max-width: 900px;
    }
    .search label{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .14em;
      color: rgba(255,255,255,.60);
      text-transform: uppercase;
      white-space:nowrap;
    }
    .search input{
      width: 100%;
      border:none;
      outline:none;
      background:transparent;
      color: rgba(255,255,255,.92);
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .12em;
    }
    .hint{
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: .12em;
      color: rgba(255,255,255,.42);
      text-transform: uppercase;
      white-space:nowrap;
      display:none;
    }
    @media (min-width: 1100px){
      .hint{ display:block; }
    }

    .actions{
      display:flex;
      gap: 8px;
      align-items:center;
      justify-content:flex-end;
      min-width: 260px;
    }
    button{
      appearance:none;
      border: 1px solid var(--hair);
      background: rgba(255,255,255,.02);
      color: rgba(255,255,255,.86);
      padding: 8px 10px;
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .14em;
      text-transform: uppercase;
      cursor:pointer;
    }
    button:hover{
      border-color: rgba(255,255,255,.35);
      background: rgba(255,255,255,.04);
      color: #ffffff;
    }

    /* ====== LAYOUT ====== */
    .wrap{
      height: calc(100vh - 56px);
      display:grid;
      grid-template-columns: 1.05fr 1fr;
      gap: 0;
    }

    .left, .right{
      height: 100%;
      overflow:hidden;
      position:relative;
    }

    .left{
      border-right: 1px solid var(--hair);
      background: radial-gradient(1200px 700px at 20% 20%, rgba(255,255,255,.06), rgba(0,0,0,0));
    }

    .right{
      background: radial-gradient(1000px 600px at 80% 10%, rgba(255,255,255,.05), rgba(0,0,0,0));
    }

    .paneHead{
      height: 42px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 14px;
      border-bottom: 1px solid var(--hair2);
      background: rgba(0,0,0,.35);
    }
    .paneHead b{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .16em;
      text-transform: uppercase;
    }
    .paneHead .meta{
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: .14em;
      color: rgba(255,255,255,.55);
      text-transform: uppercase;
      white-space:nowrap;
    }

    .scroll{
      height: calc(100% - 42px);
      overflow:auto;
      padding: 14px;
    }

    /* ====== SWATCH GRID ====== */
    .swatchGrid{
      display:grid;
      grid-template-columns: repeat(5, minmax(140px, 1fr));
      gap: 12px;
      align-items:stretch;
    }
    @media (max-width: 1300px){
      .swatchGrid{ grid-template-columns: repeat(4, minmax(140px, 1fr)); }
    }
    @media (max-width: 1100px){
      .wrap{ grid-template-columns: 1fr; }
      .left{ border-right:none; border-bottom: 1px solid var(--hair); }
      .swatchGrid{ grid-template-columns: repeat(3, minmax(140px, 1fr)); }
      header{ height:auto; padding: 10px 14px; flex-wrap:wrap; gap: 10px; }
      .search{ min-width: min(900px, 92vw); }
    }

    .swatch{
      border: 1px solid var(--hair);
      background: rgba(255,255,255,.02);
      min-height: 132px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      overflow:hidden;
      position:relative;
    }

    /* top color block */
    .chipColor{
      height: 62px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: #111;
    }

    /* bottom label area (no overlap) */
    .chipInfo{
      padding: 10px 10px 10px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items:start;
      min-height: 68px;
    }

    .chipText{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .chipName{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: rgba(255,255,255,.90);
      line-height: 1.1;
      white-space: normal;   /* key: allows wrap */
      word-break: break-word;
    }
    .chipValue{
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: .12em;
      color: rgba(255,255,255,.58);
      line-height: 1.2;
      white-space: normal;   /* key: wrap for rgba() */
      word-break: break-word;
    }

    .chipBtns{
      display:flex;
      flex-direction:column;
      gap: 8px;
      align-items:flex-end;
    }
    .mini{
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.02);
      color: rgba(255,255,255,.82);
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: .12em;
      text-transform: uppercase;
      padding: 6px 8px;
      cursor:pointer;
    }
    .mini:hover{
      border-color: rgba(255,255,255,.35);
      color: #fff;
      background: rgba(255,255,255,.04);
    }

    .swatch[draggable="true"]{ cursor:grab; }
    .swatch:active{ cursor:grabbing; }

    /* ====== PALETTES (OPEN PLAN) ====== */
    .palArea{
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .palette{
      border: 1px solid var(--hair);
      background: rgba(255,255,255,.02);
    }
    .palHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--hair2);
      background: rgba(0,0,0,.30);
      cursor: move; /* reorder handle */
      user-select:none;
    }
    .palHeader b{
      font-family: var(--mono);
      letter-spacing: .16em;
      text-transform: uppercase;
      font-size: 11px;
    }
    .palHeader .count{
      font-family: var(--mono);
      letter-spacing: .12em;
      text-transform: uppercase;
      font-size: 10px;
      color: rgba(255,255,255,.55);
      white-space:nowrap;
    }

    .slots{
      display:grid;
      grid-template-columns: repeat(6, minmax(84px, 1fr));
      gap: 10px;
      padding: 12px;
    }
    @media (max-width: 1200px){
      .slots{ grid-template-columns: repeat(5, minmax(84px, 1fr)); }
    }
    @media (max-width: 900px){
      .slots{ grid-template-columns: repeat(4, minmax(84px, 1fr)); }
    }
    @media (max-width: 560px){
      .slots{ grid-template-columns: repeat(3, minmax(84px, 1fr)); }
    }

    .slot{
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.25);
      height: 72px;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .slot.dropHover{
      border-color: rgba(255,255,255,.40);
      background: rgba(255,255,255,.04);
    }

    .slot .slotLabel{
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: rgba(255,255,255,.40);
      padding: 8px;
      text-align:center;
      pointer-events:none;
    }

    .slotFilled{
      width:100%;
      height:100%;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      border: none;
      background: transparent;
      position:absolute;
      inset:0;
    }
    .slotTop{
      height: 44px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .slotBot{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 6px 8px;
      gap: 8px;
      background: rgba(0,0,0,.35);
    }
    .slotBot .t{
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: .12em;
      color: rgba(255,255,255,.88);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
    }
    .slotBot .x{
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.02);
      color: rgba(255,255,255,.70);
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: .12em;
      padding: 2px 6px;
      cursor:pointer;
      user-select:none;
    }
    .slotBot .x:hover{
      border-color: rgba(255,255,255,.35);
      color: #fff;
    }

    /* ====== “WHATEVER THIS IS” — KETADATA COLOR PAD (TONAL SELECTIONS) ====== */
    .pad{
      border: 1px solid var(--hair);
      background: rgba(255,255,255,.02);
      margin-bottom: 12px;
    }
    .padHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--hair2);
      background: rgba(0,0,0,.30);
    }
    .padHead b{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .16em;
      text-transform: uppercase;
    }
    .padControls{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    .ctl{
      display:flex;
      align-items:center;
      gap: 8px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.02);
      padding: 6px 8px;
    }
    .ctl span{
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: rgba(255,255,255,.60);
      white-space:nowrap;
    }
    .ctl input[type="range"]{ width: 110px; }
    .ctl input[type="text"]{
      width: 120px;
      border:none;
      outline:none;
      background:transparent;
      color: rgba(255,255,255,.90);
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: .12em;
      text-transform: uppercase;
    }

    .padBody{
      padding: 12px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .padGrid{
      display:grid;
      grid-template-columns: repeat(8, minmax(74px, 1fr));
      gap: 10px;
    }
    @media (max-width: 1100px){
      .padGrid{ grid-template-columns: repeat(6, minmax(74px, 1fr)); }
    }
    @media (max-width: 720px){
      .padGrid{ grid-template-columns: repeat(4, minmax(74px, 1fr)); }
    }

    .tone{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.02);
      height: 74px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      overflow:hidden;
    }
    .toneTop{ height: 44px; border-bottom: 1px solid rgba(255,255,255,.08); }
    .toneBot{
      padding: 6px 8px;
      background: rgba(0,0,0,.35);
      font-family: var(--mono);
      font-size: 9px;
      letter-spacing: .12em;
      color: rgba(255,255,255,.78);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tone[draggable="true"]{ cursor:grab; }
    .tone:active{ cursor:grabbing; }

    /* Utility */
    .muted{ color: rgba(255,255,255,.55); }
  </style>
</head>
<body>

<header>
  <div class="brand">
    <span class="k">KETA</span>
    <span class="slashes">///</span>
    <span class="k">DATA</span>
    <span class="sub">COLOR VAULT</span>
  </div>

  <div class="headerCenter">
    <div class="search">
      <label for="q">SEARCH</label>
      <input id="q" type="text" autocomplete="off" spellcheck="false"
             placeholder="name / tag / hex (e.g. #FF00FF) — any hex is valid"/>
    </div>
    <div class="hint">DRAG SWATCH → PALETTE • CLICK COPY</div>
  </div>

  <div class="actions">
    <button id="addPal">ADD PALETTE</button>
    <button id="reset">RESET</button>
    <button id="export">EXPORT JSON</button>
  </div>
</header>

<div class="wrap">

  <!-- LEFT: VAULT -->
  <section class="left">
    <div class="paneHead">
      <b>[KETADATA COLORS]</b>
      <div class="meta">CURATED + GENERATED HEX • ALL DRAGGABLE</div>
    </div>

    <div class="scroll">
      <!-- TONAL PAD -->
      <div class="pad" id="pad">
        <div class="padHead">
          <b>[KETADATA COLOR PAD]</b>
          <div class="padControls">
            <div class="ctl">
              <span>BASE</span>
              <input id="padHex" type="text" value="#FF1A1A" />
            </div>
            <div class="ctl">
              <span>TONE</span>
              <input id="toneLight" type="range" min="10" max="90" value="42"/>
            </div>
            <div class="ctl">
              <span>SPREAD</span>
              <input id="toneSpread" type="range" min="6" max="30" value="16"/>
            </div>
            <button class="mini" id="regenPad">REGEN</button>
          </div>
        </div>

        <div class="padBody">
          <div class="muted" style="font-family:var(--mono); font-size:10px; letter-spacing:.12em; text-transform:uppercase;">
            TONAL SELECTIONS (SHADES / TINTS) • DRAG ANY TILE INTO PALETTES
          </div>
          <div class="padGrid" id="padGrid"></div>
        </div>
      </div>

      <div class="swatchGrid" id="vault"></div>
    </div>
  </section>

  <!-- RIGHT: PALETTES -->
  <section class="right">
    <div class="paneHead">
      <b>[PALETTES]</b>
      <div class="meta">OPEN PLAN • DROP ZONES • REORDER BY DRAGGING HEADER</div>
    </div>

    <div class="scroll">
      <div class="palArea" id="palArea"></div>
    </div>
  </section>

</div>

<script>
  /* ========= DATA ========= */
  const CURATED = [
    // CORE
    { name:"VOID", value:"#000000", tags:["core","void"] },
    { name:"MIND", value:"#FFFFFF", tags:["core","mind"] },
    { name:"STEEL", value:"#666666", tags:["core","steel"] },
    { name:"HAIR", value:"rgba(255,255,255,.12)", tags:["core","hair"] },
    { name:"HAIR2", value:"rgba(255,255,255,.08)", tags:["core","hair"] },

    // SIGNAL / RED
    { name:"RECORD", value:"#FF1A1A", tags:["signal","red","record"] },
    { name:"DANGER", value:"#FF0000", tags:["signal","red"] },
    { name:"DARKROOM", value:"#4A0000", tags:["red","darkroom","blood"] },

    // UV / VIOLET
    { name:"UV", value:"#7A00FF", tags:["uv","violet","signal"] },
    { name:"VIOLET", value:"#B000FF", tags:["uv","violet"] },
    { name:"ULTRAVIOLET", value:"#5B2CFF", tags:["uv","violet"] },

    // MED / XRAY
    { name:"MED-GREEN", value:"#00FF66", tags:["med","green"] },
    { name:"XRAY-CYAN", value:"#00FFFF", tags:["med","xray","cyan"] },
    { name:"SHOCK-MAGENTA", value:"#FF00FF", tags:["med","shock","magenta"] },
    { name:"MED-BLUE", value:"#0088FF", tags:["med","blue"] },

    // TECH / LASER (extra)
    { name:"LASER-GREEN", value:"#00FF00", tags:["tech","laser","green"] },
    { name:"SCANNER-AMBER", value:"#FFB000", tags:["tech","scanner","amber"] }
  ];

  let ALL_ITEMS = []; // curated + generated hex results
  let palettes = [];  // { id, title, slots:[{name,value}] }
  let paletteCounter = 0;

  /* ========= UTIL ========= */
  const $ = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

  function normalizeHex(input) {
    const raw = (input || "").trim().toUpperCase();
    if (!raw) return null;
    const s = raw.startsWith("#") ? raw.slice(1) : raw;
    if (!/^[0-9A-F]{3}$|^[0-9A-F]{6}$|^[0-9A-F]{8}$/.test(s)) return null;
    if (s.length === 3) {
      const r=s[0], g=s[1], b=s[2];
      return `#${r}${r}${g}${g}${b}${b}`;
    }
    return `#${s}`;
  }

  function isColorValue(v){
    return typeof v === "string" && (v.startsWith("#") || v.startsWith("rgb") || v.startsWith("hsl"));
  }

  async function copyText(t){
    try{ await navigator.clipboard.writeText(t); }
    catch(e){
      const ta = document.createElement("textarea");
      ta.value = t;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
    }
  }

  function toUpperSafe(s){ return String(s || "").toUpperCase(); }

  /* ========= VAULT SEARCH / RENDER ========= */
  function buildAllItems(){
    ALL_ITEMS = CURATED.map(x => ({...x, id: uid()}));
  }

  function filterItems(query){
    const q = (query || "").trim();
    if(!q) return ALL_ITEMS;

    const terms = q.split(/\s+/).filter(Boolean).map(toUpperSafe);
    const maybeHex = normalizeHex(terms.find(t => normalizeHex(t)) || q);

    const matches = ALL_ITEMS.filter(it=>{
      const name = toUpperSafe(it.name);
      const val = toUpperSafe(it.value);
      const tags = (it.tags || []).map(toUpperSafe).join(" ");
      const hay = `${name} ${val} ${tags}`;
      return terms.every(t => hay.includes(t));
    });

    if(maybeHex){
      const dup = matches.some(m => toUpperSafe(m.value) === maybeHex);
      if(!dup){
        matches.unshift({
          id: uid(),
          name: `HEX ${maybeHex}`,
          value: maybeHex,
          tags: ["generated","hex"],
          __generated: true
        });
      }
    }
    return matches;
  }

  function renderVault(items){
    const vault = $("#vault");
    vault.innerHTML = "";

    items.forEach(it=>{
      const el = document.createElement("div");
      el.className = "swatch";
      el.setAttribute("draggable", "true");
      el.dataset.payload = JSON.stringify({ name: it.name, value: it.value });

      const colorBlock = document.createElement("div");
      colorBlock.className = "chipColor";
      if(isColorValue(it.value)) colorBlock.style.background = it.value;
      else colorBlock.style.background = "#111";

      const info = document.createElement("div");
      info.className = "chipInfo";

      const text = document.createElement("div");
      text.className = "chipText";

      const nm = document.createElement("div");
      nm.className = "chipName";
      nm.textContent = it.name;

      const val = document.createElement("div");
      val.className = "chipValue";
      val.textContent = it.value;

      text.appendChild(nm);
      text.appendChild(val);

      const btns = document.createElement("div");
      btns.className = "chipBtns";

      const copyBtn = document.createElement("button");
      copyBtn.className = "mini";
      copyBtn.textContent = "COPY";
      copyBtn.addEventListener("click", async (e)=>{
        e.stopPropagation();
        await copyText(it.value);
      });

      const setPadBtn = document.createElement("button");
      setPadBtn.className = "mini";
      setPadBtn.textContent = "PAD";
      setPadBtn.addEventListener("click", (e)=>{
        e.stopPropagation();
        const hx = normalizeHex(it.value);
        if(hx){
          $("#padHex").value = hx;
          regenPad();
        }
      });

      btns.appendChild(copyBtn);
      btns.appendChild(setPadBtn);

      info.appendChild(text);
      info.appendChild(btns);

      el.appendChild(colorBlock);
      el.appendChild(info);

      el.addEventListener("dragstart", (ev)=>{
        ev.dataTransfer.setData("text/plain", el.dataset.payload);
      });

      vault.appendChild(el);
    });
  }

  /* ========= TONAL PAD ========= */
  function hexToRgb(hex){
    const h = normalizeHex(hex);
    if(!h) return null;
    const s = h.slice(1);
    const r = parseInt(s.slice(0,2),16);
    const g = parseInt(s.slice(2,4),16);
    const b = parseInt(s.slice(4,6),16);
    return {r,g,b};
  }

  function rgbToHsl(r,g,b){
    r/=255; g/=255; b/=255;
    const max = Math.max(r,g,b), min = Math.min(r,g,b);
    let h=0, s=0, l=(max+min)/2;
    if(max !== min){
      const d = max-min;
      s = l > 0.5 ? d/(2-max-min) : d/(max+min);
      switch(max){
        case r: h=(g-b)/d + (g<b?6:0); break;
        case g: h=(b-r)/d + 2; break;
        case b: h=(r-g)/d + 4; break;
      }
      h/=6;
    }
    return { h: h*360, s: s*100, l: l*100 };
  }

  function hslToCss(h,s,l){
    return `hsl(${h.toFixed(1)}, ${clamp(s,0,100).toFixed(1)}%, ${clamp(l,0,100).toFixed(1)}%)`;
  }

  function regenPad(){
    const hex = $("#padHex").value;
    const base = normalizeHex(hex);
    const rgb = hexToRgb(base);
    if(!rgb) return;

    const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);

    const centerL = parseFloat($("#toneLight").value);     // 10..90
    const spread  = parseFloat($("#toneSpread").value);    // 6..30

    // Build 16 tones: 8 columns across, 2 rows.
    // Lightness ramps around center; saturation subtly modulates too.
    const tones = [];
    const cols = 8;
    const rows = 2;

    for(let r=0; r<rows; r++){
      for(let c=0; c<cols; c++){
        const t = (c/(cols-1))*2 - 1; // -1..1
        const l = centerL + t*spread + (r===1 ? 6 : 0);
        const s = clamp(hsl.s + (r===1 ? -8 : 6) + t*10, 12, 100);
        tones.push({
          name: `TONE ${r+1}-${c+1}`,
          value: hslToCss(hsl.h, s, l)
        });
      }
    }

    const grid = $("#padGrid");
    grid.innerHTML = "";
    tones.forEach(tn=>{
      const el = document.createElement("div");
      el.className = "tone";
      el.setAttribute("draggable", "true");
      el.dataset.payload = JSON.stringify({ name: tn.name, value: tn.value });

      const top = document.createElement("div");
      top.className = "toneTop";
      top.style.background = tn.value;

      const bot = document.createElement("div");
      bot.className = "toneBot";
      bot.textContent = tn.value.toUpperCase();

      el.appendChild(top);
      el.appendChild(bot);

      el.addEventListener("click", ()=> copyText(tn.value));
      el.addEventListener("dragstart", (ev)=>{
        ev.dataTransfer.setData("text/plain", el.dataset.payload);
      });

      grid.appendChild(el);
    });
  }

  /* ========= PALETTES ========= */
  function addPalette(title){
    paletteCounter++;
    palettes.push({
      id: uid(),
      title: title || `PALETTE ${String.fromCharCode(64 + clamp(paletteCounter,1,26))}`,
      slots: Array.from({length: 12}, () => null)
    });
    renderPalettes();
  }

  function renderPalettes(){
    const area = $("#palArea");
    area.innerHTML = "";

    palettes.forEach((pal, palIndex)=>{
      const card = document.createElement("div");
      card.className = "palette";
      card.dataset.palId = pal.id;

      const head = document.createElement("div");
      head.className = "palHeader";
      head.setAttribute("draggable", "true");
      head.dataset.dragPal = pal.id;

      const b = document.createElement("b");
      b.textContent = `[${pal.title}]`;

      const count = document.createElement("div");
      const filled = pal.slots.filter(Boolean).length;
      count.className = "count";
      count.textContent = `${filled}/12`;

      head.appendChild(b);
      head.appendChild(count);

      // reorder palettes by dragging header
      head.addEventListener("dragstart", (ev)=>{
        ev.dataTransfer.setData("text/plain", JSON.stringify({ __palReorder:true, palId: pal.id }));
      });

      head.addEventListener("dragover", (ev)=> ev.preventDefault());
      head.addEventListener("drop", (ev)=>{
        ev.preventDefault();
        const raw = ev.dataTransfer.getData("text/plain");
        try{
          const payload = JSON.parse(raw);
          if(payload && payload.__palReorder){
            const fromId = payload.palId;
            const toId = pal.id;
            if(fromId === toId) return;

            const fromIdx = palettes.findIndex(p => p.id === fromId);
            const toIdx = palettes.findIndex(p => p.id === toId);
            if(fromIdx < 0 || toIdx < 0) return;

            const [moved] = palettes.splice(fromIdx, 1);
            palettes.splice(toIdx, 0, moved);
            renderPalettes();
          }
        }catch(e){}
      });

      const slots = document.createElement("div");
      slots.className = "slots";

      pal.slots.forEach((slotData, slotIndex)=>{
        const slot = document.createElement("div");
        slot.className = "slot";
        slot.dataset.palId = pal.id;
        slot.dataset.slotIndex = String(slotIndex);

        const label = document.createElement("div");
        label.className = "slotLabel";
        label.textContent = "[DROP]";

        slot.appendChild(label);

        // drop behavior
        slot.addEventListener("dragover", (ev)=>{
          ev.preventDefault();
          slot.classList.add("dropHover");
        });
        slot.addEventListener("dragleave", ()=> slot.classList.remove("dropHover"));
        slot.addEventListener("drop", (ev)=>{
          ev.preventDefault();
          slot.classList.remove("dropHover");
          const raw = ev.dataTransfer.getData("text/plain");
          if(!raw) return;

          // ignore palette reorder payload
          try{
            const maybe = JSON.parse(raw);
            if(maybe && maybe.__palReorder) return;
          }catch(e){}

          let data = null;
          try{ data = JSON.parse(raw); }catch(e){ return; }
          if(!data || !data.value) return;

          palettes[palIndex].slots[slotIndex] = { name: data.name || "SWATCH", value: data.value };
          renderPalettes();
        });

        // filled UI
        if(slotData){
          const fill = document.createElement("div");
          fill.className = "slotFilled";

          const top = document.createElement("div");
          top.className = "slotTop";
          top.style.background = slotData.value;

          const bot = document.createElement("div");
          bot.className = "slotBot";

          const t = document.createElement("div");
          t.className = "t";
          t.textContent = (slotData.value || "").toUpperCase();

          const x = document.createElement("div");
          x.className = "x";
          x.textContent = "X";
          x.title = "Remove";
          x.addEventListener("click", (e)=>{
            e.stopPropagation();
            palettes[palIndex].slots[slotIndex] = null;
            renderPalettes();
          });

          bot.appendChild(t);
          bot.appendChild(x);

          fill.appendChild(top);
          fill.appendChild(bot);

          // click copy
          slot.addEventListener("click", ()=> copyText(slotData.value));

          slot.appendChild(fill);
          label.style.display = "none";
        }

        slots.appendChild(slot);
      });

      card.appendChild(head);
      card.appendChild(slots);
      area.appendChild(card);
    });
  }

  /* ========= EXPORT / RESET ========= */
  function exportJSON(){
    const out = {
      curated: CURATED,
      palettes: palettes.map(p => ({
        title: p.title,
        slots: p.slots
      }))
    };
    const blob = new Blob([JSON.stringify(out, null, 2)], { type:"application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "ketadata-palettes.json";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function resetAll(){
    buildAllItems();
    palettes = [];
    paletteCounter = 0;
    addPalette("PALETTE A");
    addPalette("PALETTE B");
    $("#q").value = "";
    renderVault(filterItems(""));
    regenPad();
  }

  /* ========= WIRE ========= */
  buildAllItems();

  $("#q").addEventListener("input", ()=>{
    const items = filterItems($("#q").value);
    renderVault(items);
  });

  $("#addPal").addEventListener("click", ()=> addPalette());
  $("#reset").addEventListener("click", resetAll);
  $("#export").addEventListener("click", exportJSON);

  $("#regenPad").addEventListener("click", regenPad);
  $("#padHex").addEventListener("keydown", (e)=>{
    if(e.key === "Enter") regenPad();
  });
  $("#toneLight").addEventListener("input", regenPad);
  $("#toneSpread").addEventListener("input", regenPad);

  // First render
  addPalette("PALETTE A");
  addPalette("PALETTE B");
  renderVault(filterItems(""));
  regenPad();

  // Keyboard: "/" focus search, ESC clear
  document.addEventListener("keydown", (e)=>{
    if(e.key === "/"){
      e.preventDefault();
      $("#q").focus();
      $("#q").select();
    }
    if(e.key === "Escape"){
      if(document.activeElement === $("#q") && $("#q").value){
        $("#q").value = "";
        renderVault(filterItems(""));
      }
    }
  });
</script>
</body>
</html>
