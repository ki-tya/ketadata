<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>KETADATA // MASTERDOC</title>

  <style>
    :root{
      --bg:#000;
      --fg:#fff;
      --inkA: rgba(255,255,255,.86);
      --inkB: rgba(255,255,255,.62);
      --inkC: rgba(255,255,255,.42);
      --hair: rgba(255,255,255,.14);
      --hair2: rgba(255,255,255,.09);
      --ui: Arial, Helvetica, sans-serif;
      --topH: 38px;
      --botH: 26px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }
    body{
      background:var(--bg);
      color:var(--fg);
      font-family:var(--ui);
      overflow:hidden;
    }

    @media screen {
      .topbar{
        position:fixed; left:0; right:0; top:0;
        z-index:40;
        height:var(--topH);
        display:flex;
        align-items:center;
        justify-content:space-between;
        padding:0 12px;
        border-bottom:1px solid var(--hair);
        background: rgba(0,0,0,.96);
        user-select:none;
      }
      .brandMini{
        display:flex; align-items:center; gap:10px;
        font-size:11px;
        letter-spacing:.18em;
        text-transform:uppercase;
        color: rgba(255,255,255,.85);
      }
      .noteIcon{
        width:12px; height:12px;
        display:inline-block;
        border:1px solid #fff;
        background: #fff;
        cursor:pointer;
      }
      .noteIcon.outlined{
        background: transparent;
      }
      .topRight{
        display:flex; align-items:center; gap:10px;
      }
      .btn{
        font-family:var(--ui);
        font-size:11px;
        letter-spacing:.18em;
        text-transform:uppercase;
        color: rgba(255,255,255,.82);
        background: rgba(0,0,0,.22);
        border:1px solid var(--hair);
        padding:6px 10px;
        cursor:pointer;
      }
      .btn:hover{ border-color: rgba(255,255,255,.28); color:#fff; }
      .footer{
        position:fixed; left:0; right:0; bottom:0;
        z-index:40;
        height:var(--botH);
        display:flex;
        align-items:center;
        justify-content:space-between;
        padding:0 10px;
        border-top:1px solid var(--hair);
        background: rgba(0,0,0,.96);
        font-size:10px;
        letter-spacing:.14em;
        text-transform:uppercase;
        color: rgba(255,255,255,.70);
        user-select:none;
      }
      .footer b{ color:#fff; font-weight:900; }
      .muted{ color: rgba(255,255,255,.55); }

      .docWrap{
        position:fixed; inset:0;
        padding-top: var(--topH);
        padding-bottom: var(--botH);
        display:flex;
      }
      .sidebar{
        width:280px;
        border-right:1px solid var(--hair);
        background: rgba(0,0,0,.50);
        overflow-y:auto;
        padding:20px 16px;
        transition: margin-left .3s, opacity .3s;
      }
      .sidebar.collapsed{
        margin-left:-280px;
        opacity:0;
        pointer-events:none;
      }
      .tocTitle{
        font-size:11px;
        letter-spacing:.22em;
        text-transform:uppercase;
        font-weight:900;
        color: rgba(255,255,255,.85);
        margin-bottom:16px;
        padding-bottom:12px;
        border-bottom:1px solid var(--hair2);
      }
      .tocItem{
        font-size:11px;
        letter-spacing:.08em;
        color: rgba(255,255,255,.65);
        padding:8px 12px;
        margin-bottom:4px;
        cursor:pointer;
        border:1px solid transparent;
        transition: all .2s;
      }
      .tocItem:hover{
        color: rgba(255,255,255,.90);
        border-color: var(--hair);
        background: rgba(255,255,255,.04);
      }
      .tocItem.active{
        color: #fff;
        border-color: var(--hair);
        background: rgba(255,255,255,.08);
      }
      .docView{
        flex:1;
        overflow-y:auto;
        padding:60px 80px;
      }

      #note{
        position:fixed;
        top: 64px;
        left: 16px;
        z-index:45;
        width: min(420px, 92vw);
        height: 220px;
        border:1px solid var(--hair);
        background: rgba(0,0,0,.34);
        backdrop-filter: blur(8px);
        display:none;
        box-shadow: 0 22px 80px rgba(0,0,0,.55);
      }
      #note.open{ display:block; }
      #noteHead{
        height: 34px;
        display:flex;
        align-items:center;
        justify-content:space-between;
        padding: 0 10px;
        border-bottom:1px solid var(--hair2);
        cursor:move;
        user-select:none;
      }
      #noteHead .label{
        font-size:11px;
        letter-spacing:.22em;
        text-transform:uppercase;
        font-weight:900;
        color: rgba(255,255,255,.86);
      }
      #noteHead .mini{
        display:flex; gap:8px; align-items:center;
      }
      .miniBtn{
        width: 26px;
        height: 22px;
        display:flex;
        align-items:center;
        justify-content:center;
        border:1px solid var(--hair);
        background: rgba(0,0,0,.22);
        color: rgba(255,255,255,.85);
        cursor:pointer;
        font-weight:900;
        user-select:none;
      }
      .miniBtn:hover{ border-color: rgba(255,255,255,.28); color:#fff; }
      #noteArea{
        width:100%;
        height: calc(100% - 34px);
        border:0;
        resize:none;
        outline:none;
        padding: 10px 10px;
        background: transparent;
        color:#fff;
        font-family: var(--ui);
        font-size: 12px;
        letter-spacing:.06em;
        line-height:1.45;
      }

      body.null .topbar,
      body.null .footer,
      body.null .sidebar,
      body.null #note{
        display:none !important;
      }
      body.invert{
        filter: invert(1) hue-rotate(180deg);
      }
    }

    @media print {
      .topbar, .footer, .sidebar, .btn{ display:none !important; }
      body{
        background:#000;
        color:#fff;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .docWrap{
        position:static;
        padding:0;
        display:block;
      }
      .docView{
        padding:0;
        overflow:visible;
      }
      .section{
        page-break-after: always;
      }
      .section:last-child{
        page-break-after: auto;
      }
      h1, h2, h3{
        page-break-after: avoid;
      }
      .coverPage{
        page-break-after: always;
      }
      * {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
    }

    .coverPage{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      border-bottom:1px solid var(--hair2);
      margin-bottom:60px;
    }
    .docTitle{
      font-size:52px;
      font-weight:900;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: rgba(255,255,255,.95);
      margin-bottom:20px;
      line-height:1.1;
      outline:none;
    }
    .docTitle:focus{
      background: rgba(255,255,255,.04);
    }
    .docSubtitle{
      font-size:28px;
      font-weight:300;
      letter-spacing:.18em;
      text-transform:uppercase;
      color: rgba(255,255,255,.70);
      margin-bottom:60px;
      outline:none;
    }
    .docSubtitle:focus{
      background: rgba(255,255,255,.04);
    }
    .docMeta{
      font-size:12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: rgba(255,255,255,.50);
      line-height:2;
    }

    .section{
      margin-bottom:80px;
    }
    .section h1{
      font-size:32px;
      font-weight:900;
      letter-spacing:.10em;
      text-transform:uppercase;
      color: rgba(255,255,255,.92);
      margin:0 0 30px 0;
      padding-bottom:16px;
      border-bottom:1px solid var(--hair2);
      outline:none;
    }
    .section h1:focus{
      background: rgba(255,255,255,.04);
    }
    .section h2{
      font-size:22px;
      font-weight:700;
      letter-spacing:.08em;
      text-transform:uppercase;
      color: rgba(255,255,255,.85);
      margin:40px 0 20px 0;
      outline:none;
    }
    .section h2:focus{
      background: rgba(255,255,255,.04);
    }
    .section .content{
      font-family:var(--ui);
      font-size:15px;
      line-height:1.75;
      color: rgba(255,255,255,.75);
      max-width:720px;
      outline:none;
      min-height:40px;
    }
    .section .content:focus{
      background: rgba(255,255,255,.02);
    }
    .section .content:empty:before{
      content: attr(data-placeholder);
      color: rgba(255,255,255,.35);
      font-style: italic;
    }

    .addSection{
      width:100%;
      padding:20px;
      margin:40px 0;
      border:1px dashed var(--hair);
      background: rgba(0,0,0,.20);
      color: rgba(255,255,255,.60);
      font-family:var(--ui);
      font-size:12px;
      letter-spacing:.18em;
      text-transform:uppercase;
      cursor:pointer;
      transition: all .2s;
    }
    .addSection:hover{
      border-color: rgba(255,255,255,.28);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.85);
    }

    .docView::-webkit-scrollbar,
    .sidebar::-webkit-scrollbar{
      width: 10px;
    }
    .docView::-webkit-scrollbar-thumb,
    .sidebar::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.10);
    }
  </style>
</head>

<body>
  <div class="topbar" id="topbar">
    <div class="brandMini">
      <span style="display:inline-block;width:10px;height:10px;border:1px solid #fff;"></span>
      <span>KETADATA // MASTERDOC</span>
      <button class="btn" id="toggleSidebar" style="margin-left:10px;">TOC</button>
    </div>
    <div class="topRight">
      <button class="btn" id="saveBtn">SAVE</button>
      <button class="btn" id="loadBtn">LOAD</button>
      <button class="btn" id="exportBtn">EXPORT PDF</button>
      <span class="noteIcon" id="ketaNoteIcon" title="KETA_NOTE"></span>
      <button class="btn" id="goSystem">SYSTEM</button>
      <button class="btn" id="goHome">HOME</button>
    </div>
  </div>

  <div class="docWrap">
    <div class="sidebar">
      <div class="tocTitle">CONTENTS</div>
      <div id="tocContainer"></div>
    </div>

    <div class="docView" id="docView">
      <div class="coverPage">
        <div class="docTitle" contenteditable="true" data-placeholder="DOCUMENT TITLE">KETADATA</div>
        <div class="docSubtitle" contenteditable="true" data-placeholder="DOCUMENT SUBTITLE">V-I MASTERDOC</div>
        <div class="docMeta">
          DOCUMENT VERSION: 1.0<br/>
          CLASSIFICATION: VOID MODE<br/>
          GENERATED: <span id="docDate"></span>
        </div>
      </div>

      <div class="section" data-section="1">
        <h1 contenteditable="true" data-placeholder="SECTION TITLE">1. </h1>
        <div class="content" contenteditable="true" data-placeholder="Start writing..."></div>
      </div>

      <button class="addSection" id="addSection">+ ADD SECTION</button>
    </div>
  </div>

  <div id="note">
    <div id="noteHead">
      <div class="label">KETA_NOTE</div>
      <div class="mini">
        <div class="miniBtn" id="noteCollapse">–</div>
      </div>
    </div>
    <textarea id="noteArea" placeholder="KETA_NOTE (GLOBAL)"></textarea>
  </div>

  <div class="footer" id="footer">
    <div>
      <span class="muted">NULL:</span> <b id="nullStatus">OFF</b> ·
      <span class="muted">INVERT:</span> <b id="invStatus">OFF</b>
    </div>
    <div>
      <span class="muted">MODE:</span> <b>VOID</b> ·
      <span class="muted">SECTIONS:</span> <b id="sectionCount">1</b>
    </div>
  </div>

  <script>
    const SHELL_HOME_URL = "system.html";
    const NOTE_KEYS = [
      "KETADATA_GLOBAL_KETA_NOTE_V1",
      "KETADATA_GLOBAL_KETA_NOTE",
      "KETA_NOTE",
      "SHELL8_KETA_NOTE",
      "KETADATA_SHELL8_KETA_NOTE"
    ];

    function readGlobalNote(){
      for(const k of NOTE_KEYS){
        const v = localStorage.getItem(k);
        if(v && v.trim().length) return v;
      }
      return "";
    }
    function writeGlobalNote(v){
      for(const k of NOTE_KEYS){
        localStorage.setItem(k, v);
      }
    }

    const note = document.getElementById('note');
    const noteArea = document.getElementById('noteArea');
    const noteIcon = document.getElementById('ketaNoteIcon');
    const noteCollapse = document.getElementById('noteCollapse');

    function setNoteOpen(open){
      note.classList.toggle('open', open);
      noteIcon.classList.toggle('outlined', open);
    }

    setNoteOpen(false);
    noteArea.value = readGlobalNote();

    let saveT = null;
    noteArea.addEventListener('input', ()=>{
      clearTimeout(saveT);
      saveT = setTimeout(()=> writeGlobalNote(noteArea.value), 180);
    });

    noteIcon.addEventListener('click', ()=>{
      const open = !note.classList.contains('open');
      if(open) noteArea.value = readGlobalNote();
      setNoteOpen(open);
    });

    noteCollapse.addEventListener('click', ()=> setNoteOpen(false));

    (function drag(){
      const head = document.getElementById('noteHead');
      let down=false, sx=0, sy=0, ox=0, oy=0;
      head.addEventListener('mousedown', (e)=>{
        down=true;
        sx=e.clientX; sy=e.clientY;
        const r = note.getBoundingClientRect();
        ox=r.left; oy=r.top;
      });
      window.addEventListener('mousemove', (e)=>{
        if(!down) return;
        const nx = ox + (e.clientX - sx);
        const ny = oy + (e.clientY - sy);
        note.style.left = Math.max(8, Math.min(window.innerWidth - 220, nx)) + 'px';
        note.style.top  = Math.max(46, Math.min(window.innerHeight - 80, ny)) + 'px';
        note.style.right = 'auto';
      });
      window.addEventListener('mouseup', ()=> down=false);
    })();

    const sidebar = document.querySelector('.sidebar');
    const toggleSidebarBtn = document.getElementById('toggleSidebar');
    let sidebarOpen = true;

    toggleSidebarBtn.addEventListener('click', ()=>{
      sidebarOpen = !sidebarOpen;
      sidebar.classList.toggle('collapsed', !sidebarOpen);
      toggleSidebarBtn.style.opacity = sidebarOpen ? '1' : '0.5';
    });

    let sectionCounter = 1;

    document.getElementById('addSection').addEventListener('click', ()=>{
      sectionCounter++;
      const section = document.createElement('div');
      section.className = 'section';
      section.setAttribute('data-section', sectionCounter);
      section.innerHTML = `
        <h1 contenteditable="true" data-placeholder="SECTION TITLE">${sectionCounter}. </h1>
        <div class="content" contenteditable="true" data-placeholder="Start writing..."></div>
      `;
      
      const addBtn = document.getElementById('addSection');
      addBtn.parentNode.insertBefore(section, addBtn);
      
      generateTOC();
      section.querySelector('h1').focus();
    });

    function generateTOC(){
      const sections = document.querySelectorAll('.section');
      const tocContainer = document.getElementById('tocContainer');
      const sectionCount = document.getElementById('sectionCount');

      tocContainer.innerHTML = '';
      sectionCount.textContent = sections.length;

      sections.forEach((section, idx) => {
        const h1 = section.querySelector('h1');
        if(!h1) return;

        const item = document.createElement('div');
        item.className = 'tocItem';
        item.textContent = h1.textContent || `Section ${idx + 1}`;
        item.onclick = () => {
          section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        };
        tocContainer.appendChild(item);
      });
    }

    document.getElementById('docDate').textContent = new Date().toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    document.getElementById('exportBtn').addEventListener('click', ()=>{
      window.print();
    });

    document.getElementById('saveBtn').addEventListener('click', ()=>{
      const data = {
        html: document.getElementById('docView').innerHTML,
        timestamp: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ketadata-masterdoc-' + Date.now() + '.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('loadBtn').addEventListener('click', ()=>{
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
          try{
            const data = JSON.parse(event.target.result);
            document.getElementById('docView').innerHTML = data.html;
            generateTOC();
          } catch(err){
            alert('Error loading file: ' + err.message);
          }
        };
        reader.readAsText(file);
      };
      input.click();
    });

    document.getElementById('goSystem').addEventListener('click', ()=> location.href = SHELL_HOME_URL);
    document.getElementById('goHome').addEventListener('click', ()=> location.href = SHELL_HOME_URL);

    const nullStatus = document.getElementById('nullStatus');
    const invStatus = document.getElementById('invStatus');

    let nullMode = false;
    let invert = false;

    function setNull(on){
      nullMode = on;
      document.body.classList.toggle('null', on);
      nullStatus.textContent = on ? "ON" : "OFF";
    }
    function setInvert(on){
      invert = on;
      document.body.classList.toggle('invert', on);
      invStatus.textContent = on ? "ON" : "OFF";
    }

    window.addEventListener('keydown', (e)=>{
      if(e.key === "Escape"){ setNull(false); return; }
      if(e.key.toLowerCase() === "n"){ setNull(!nullMode); return; }
      if(e.shiftKey && e.key.toLowerCase() === "i"){ setInvert(!invert); return; }
      if(e.shiftKey && e.key.toLowerCase() === "b"){ location.href = SHELL_HOME_URL; return; }
      if(e.key.toLowerCase() === "t"){
        sidebarOpen = !sidebarOpen;
        sidebar.classList.toggle('collapsed', !sidebarOpen);
        toggleSidebarBtn.style.opacity = sidebarOpen ? '1' : '0.5';
        return;
      }
    });

    generateTOC();

    document.addEventListener('input', (e)=>{
      if(e.target.matches('.section h1')){
        generateTOC();
      }
    });
  </script>
</body>
</html>
