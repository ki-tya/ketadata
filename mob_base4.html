<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="theme-color" content="#000000" />
<title>KETADATA // MOB_PLAYER</title>

<style>
:root{
  --bg:#000;
  --fg:rgba(255,255,255,.86);
  --muted:rgba(255,255,255,.52);
  --line:rgba(255,255,255,.12);
  --line2:rgba(255,255,255,.22);

  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  --sans: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

  --h:44px;
  --f:44px;
  --touch:44px;
  --zHeader:100;
  --zDrawer:200;
  --zStage:900;
  --zNote:950;
  --zToast:1000;
}
*{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
html,body{height:100%; margin:0; overflow:hidden}
body{
  background:var(--bg);
  color:var(--fg);
  font-family:var(--mono);
  font-size:12px;        /* single-size text discipline */
  letter-spacing:.06em;
  touch-action:manipulation;
  overscroll-behavior:none;
}
button,input,textarea{font:inherit; letter-spacing:inherit}

#root{
  position:fixed;
  inset:0;
  display:flex;
  flex-direction:column;
  background:#000;
}

/* HEADER */
.header{
  height:calc(var(--h) + env(safe-area-inset-top));
  padding-top:env(safe-area-inset-top);
  border-bottom:1px solid var(--line);
  background:linear-gradient(180deg,#070707,#000);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding-left:10px;
  padding-right:10px;
  flex-shrink:0;
  z-index:var(--zHeader);
}
.brand{
  display:flex;
  align-items:center;
  gap:8px;
  text-transform:uppercase;
  user-select:none;
  -webkit-user-select:none;
  white-space:nowrap;
}
.brand .sq{
  width:10px; height:10px;
  border:1px solid rgba(255,255,255,.86);
  background:#000;
}
.header-actions{
  display:flex;
  gap:8px;
  align-items:center;
}
.icon-btn{
  width:var(--touch);
  height:var(--touch);
  border:1px solid var(--line2);
  background:#000;
  color:var(--fg);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  user-select:none;
  -webkit-user-select:none;
}
.icon-btn:active{transform:translateY(1px); border-color:rgba(255,255,255,.86)}

/* MAIN */
.main{flex:1; position:relative; overflow:hidden}

/* SURFACE */
#surfaceFrame{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  border:0;
  background:#000;
  display:block;
}

/* DRAWER */
.drawer{
  position:absolute;
  left:0; right:0; bottom:0;
  height:60vh;
  max-height:560px;
  background:rgba(0,0,0,.92);
  border-top:1px solid var(--line);
  z-index:var(--zDrawer);
  transform:translateY(calc(100% - 54px));
  transition:transform 140ms linear;
  display:flex;
  flex-direction:column;
  padding-bottom:env(safe-area-inset-bottom);
}
.drawer.open{transform:translateY(0)}
.drawer-handle{
  height:54px;
  border-bottom:1px solid var(--line);
  display:flex;
  align-items:center;
  gap:8px;
  padding:0 10px;
  user-select:none;
  -webkit-user-select:none;
}
.tabs{
  display:flex;
  gap:8px;
  flex:1;
  overflow:hidden;
}
.tab{
  height:var(--touch);
  min-width:92px;
  padding:0 10px;
  border:1px solid var(--line2);
  background:#000;
  color:var(--muted);
  display:flex;
  align-items:center;
  justify-content:center;
  text-transform:uppercase;
  cursor:pointer;
  user-select:none;
  -webkit-user-select:none;
}
.tab.active{color:var(--fg); background:rgba(255,255,255,.05); border-color:rgba(255,255,255,.30)}
.tab:active{transform:translateY(1px); border-color:rgba(255,255,255,.86)}
.drawer-now{
  flex:1;
  text-align:right;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  text-transform:uppercase;
  color:var(--muted);
}
.drawer-body{
  flex:1;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  padding:10px;
}

/* CONTROLS */
.row{display:flex; gap:8px; margin-bottom:10px}
.btn{
  min-height:var(--touch);
  border:1px solid var(--line2);
  background:#000;
  color:var(--fg);
  padding:0 10px;
  text-transform:uppercase;
  cursor:pointer;
  user-select:none;
  -webkit-user-select:none;
  flex:1;
}
.btn:active{transform:translateY(1px); border-color:rgba(255,255,255,.86)}
.btn.muted{color:var(--muted)}
.btn.small{flex:0 0 auto; width:auto; padding:0 12px}
.btn:disabled{opacity:.35; cursor:default; transform:none}

/* PRESETS */
.search{
  width:100%;
  min-height:var(--touch);
  border:1px solid var(--line2);
  background:#000;
  color:var(--fg);
  padding:0 10px;
  text-transform:uppercase;
}
.search:focus{outline:none; border-color:rgba(255,255,255,.86)}
.section{
  border:1px solid var(--line2);
  background:rgba(255,255,255,.02);
  margin-bottom:10px;
}
.section-h{
  min-height:var(--touch);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 10px;
  border-bottom:1px solid var(--line);
  text-transform:uppercase;
  color:var(--muted);
  cursor:pointer;
  user-select:none;
  -webkit-user-select:none;
}
.section-h:active{background:rgba(255,255,255,.05)}
.section-b{
  display:none;
  padding:10px;
}
.section-b.open{display:block}
.grid{display:grid; grid-template-columns:repeat(2,1fr); gap:8px}
.preset{
  min-height:var(--touch);
  border:1px solid var(--line2);
  background:#000;
  color:var(--fg);
  padding:10px;
  cursor:pointer;
  user-select:none;
  -webkit-user-select:none;
  text-transform:uppercase;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
}
.preset:active{transform:translateY(1px); border-color:rgba(255,255,255,.86); background:rgba(255,255,255,.08)}
.preset .name{flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
.preset .tag{color:var(--muted); white-space:nowrap}

/* LIGHTS */
.lgrid{display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:10px}
.lbtn{
  min-height:var(--touch);
  border:1px solid var(--line2);
  background:#000;
  color:var(--fg);
  cursor:pointer;
  user-select:none;
  -webkit-user-select:none;
  text-transform:uppercase;
}
.lbtn.active{border-color:rgba(255,255,255,.86); background:rgba(255,255,255,.10)}
.lbtn:active{transform:translateY(1px); border-color:rgba(255,255,255,.86)}
.note{
  color:var(--muted);
  text-transform:uppercase;
  line-height:1.25;
}

/* FOOTER (minimal hotkeys as buttons) */
.footer{
  height:calc(var(--f) + env(safe-area-inset-bottom));
  padding-bottom:env(safe-area-inset-bottom);
  border-top:1px solid var(--line);
  background:linear-gradient(0deg,#070707,#000);
  display:flex;
  align-items:stretch;
  flex-shrink:0;
  z-index:var(--zHeader);
}
.nav{
  flex:1;
  border:0;
  border-right:1px solid var(--line);
  background:transparent;
  color:var(--muted);
  cursor:pointer;
  text-transform:uppercase;
}
.nav:last-child{border-right:0}
.nav:active{background:rgba(255,255,255,.10)}
.nav.active{color:var(--fg); background:rgba(255,255,255,.05)}

/* STAGE */
#stage{
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:var(--zStage);
  display:none;
  background:#000;
}
#stage.active{display:block}

/* TOAST */
.toast{
  position:fixed;
  top:calc(var(--h) + env(safe-area-inset-top) + 10px);
  left:50%;
  transform:translateX(-50%);
  padding:10px 12px;
  background:rgba(0,0,0,.95);
  border:1px solid rgba(255,255,255,.86);
  color:var(--fg);
  z-index:var(--zToast);
  display:none;
  white-space:nowrap;
  text-transform:uppercase;
}

/* INVERT + NULL */
body.invert{filter:invert(1)}
body.null .header,
body.null .footer,
body.null .drawer,
body.null .toast{display:none !important}
body.null #surfaceFrame{display:block !important}
#nullSquare{
  position:fixed;
  right:10px;
  bottom:calc(10px + env(safe-area-inset-bottom));
  width:22px;
  height:22px;
  border:1px solid rgba(255,255,255,.86);
  background:transparent;
  z-index:9999;
  cursor:pointer;
}
#nullSquare:active{transform:translateY(1px)}

/* KETA_NOTE (full-screen) */
#noteOverlay{
  position:fixed;
  inset:0;
  background:#000;
  z-index:var(--zNote);
  display:none;
  flex-direction:column;
}
#noteOverlay.open{display:flex}
.noteTop{
  height:calc(var(--h) + env(safe-area-inset-top));
  padding-top:env(safe-area-inset-top);
  border-bottom:1px solid var(--line);
  display:flex;
  align-items:center;
  gap:8px;
  padding-left:10px;
  padding-right:10px;
  background:linear-gradient(180deg,#070707,#000);
}
.noteTop .sp{flex:1}
.noteField{
  width:100%;
  border:0;
  outline:none;
  background:#000;
  color:var(--fg);
  padding:12px 10px;
  text-transform:none;        /* note content should not be forced uppercase */
  letter-spacing:0;          /* Apple Notes vibe: plain */
  font-family:var(--sans);
  font-size:14px;            /* within note: still one size, but readable */
}
#noteTitle{
  border-bottom:1px solid var(--line);
  font-weight:600;
}
#noteBody{
  flex:1;
  resize:none;
}
.noteHint{
  padding:8px 10px;
  border-top:1px solid var(--line);
  color:var(--muted);
  font-family:var(--mono);
  text-transform:uppercase;
  letter-spacing:.06em;
}
.hidden{display:none !important}
</style>
</head>

<body>
<div id="root">
  <div class="header">
    <div class="brand" id="brandHold" title="LONG PRESS = INVERT">
      <span class="sq"></span>
      <span>SHELL8 // MOB_PLAYER</span>
    </div>
    <div class="header-actions">
      <button class="icon-btn" id="btnNote" title="KETA_NOTE">▣</button>
      <button class="icon-btn" id="btnDrawer" title="SYSTEM">▤</button>
    </div>
  </div>

  <div class="main">
    <iframe id="surfaceFrame" title="SURFACE"></iframe>

    <div class="drawer" id="drawer">
      <div class="drawer-handle" id="drawerHandle">
        <div class="tabs">
          <button class="tab active" data-tab="presets" id="tabPresets">PRESETS</button>
          <button class="tab" data-tab="lights" id="tabLights">LIGHTS</button>
          <button class="tab" data-tab="system" id="tabSystem">SYSTEM</button>
        </div>
        <div class="drawer-now" id="nowLabel">—</div>
      </div>

      <div class="drawer-body" id="panelPresets">
        <div class="row">
          <button class="btn" id="btnPrev">PREV</button>
          <button class="btn" id="btnNext">NEXT</button>
          <button class="btn" id="btnReload">RELOAD</button>
          <button class="btn" id="btnStop">STOP</button>
        </div>

        <input class="search" id="searchInput" placeholder="SEARCH PRESETS..." />

        <div id="sections"></div>
      </div>

      <div class="drawer-body hidden" id="panelLights">
        <div class="row">
          <button class="btn" id="btnLightRun">RUN</button>
          <button class="btn muted" id="btnLightStop">STOP</button>
          <button class="btn" id="btnLightPick">PICK</button>
        </div>

        <div class="lgrid" id="lightGrid">
          <button class="lbtn" data-light="1">L1</button>
          <button class="lbtn" data-light="2">L2</button>
          <button class="lbtn" data-light="3">L3</button>
          <button class="lbtn" data-light="4">L4</button>
          <button class="lbtn" data-light="5">L5</button>
          <button class="lbtn" data-light="6">L6</button>
        </div>

        <div class="note">
          DOUBLE TAP ANYWHERE = TOGGLE RUN<br/>
          TAP L1–L6 = SELECT PRESET
        </div>
      </div>

      <div class="drawer-body hidden" id="panelSystem">
        <div class="row">
          <button class="btn" id="btnExport">EXPORT</button>
          <button class="btn" id="btnImport">IMPORT</button>
          <button class="btn muted" id="btnClear">CLEAR</button>
        </div>
        <div class="row">
          <button class="btn" id="btnStopLights">STOP LIGHTS</button>
          <button class="btn" id="btnStopSurface">STOP SURFACE</button>
        </div>

        <div class="note" id="storageInfo">STORAGE: —</div>
      </div>
    </div>
  </div>

  <div class="footer">
    <button class="nav" id="btnInvert">INVERT</button>
    <button class="nav" id="btnNull">NULL</button>
    <button class="nav" id="btnSys">SYSTEM</button>
  </div>

  <div id="stage"></div>
  <div class="toast" id="toast"></div>
  <div id="nullSquare" title="NULL"></div>

  <input type="file" id="fileInput" accept="application/json" class="hidden" />
</div>

<!-- KETA_NOTE FULL PAGE -->
<div id="noteOverlay">
  <div class="noteTop">
    <button class="icon-btn" id="btnNoteBack" title="BACK">◀</button>
    <div class="sp"></div>
    <button class="icon-btn" id="btnNoteExport" title="EXPORT NOTE">⇩</button>
  </div>
  <input id="noteTitle" class="noteField" placeholder="Title" />
  <textarea id="noteBody" class="noteField" placeholder="Note"></textarea>
  <div class="noteHint">KETA_NOTE AUTO-SAVES</div>
</div>

<script>
/* ===== UTIL ===== */
const $=(id)=>document.getElementById(id);
function toast(msg,dur=900){
  const t=$("toast");
  t.textContent=String(msg||"");
  t.style.display="block";
  clearTimeout(t._t);
  t._t=setTimeout(()=>{t.style.display="none";},dur);
}
function hash8(str){
  const s=String(str||"");
  let h=2166136261;
  for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,16777619);}
  return (h>>>0).toString(16).slice(0,8);
}
function clamp(n,a,b){return Math.max(a,Math.min(b,n));}

/* ===== PRESETS =====
   Player-first: toy + keta-mono + keta-chroma
*/
const PRESET_SECTIONS = [
  {
    key:"toy",
    name:"TOYS (TENNIS & CATBALL)",
    open:true,
    items:[
      "catball.html","catball1.html","ktball.html","ktball1.html",
      "serve.html","serve1.html","serve2.html",
      "tball.html","tball1.html","tball2.html","tball3.html","tball4.html","tball5.html","tball6.html","tball7.html",
      "tennisball.html","tennisball0.html","tennisball2.html","tennisball3.html","tennisball4.html","tennisball5.html",
      "tennisball6.html","tennisball7.html","tennisball8.html","tennisball9.html","tennisball10.html","tennisball11.html",
      "tennisball12.html","tennisball13.html","tennisball14.html","tennisball15.html","tennisball16.html","tennisball91.html",
      "tennisball666.html","tenniscourt.html"
    ].map(u=>({name:u.replace(".html","").toUpperCase(), url:u, tag:"TOY"}))
  },
  {
    key:"mono",
    name:"KETA_MONO",
    open:false,
    items:[
      "butterfly.html","butterfly1.html","butterfly2.html","butterfly3.html",
      "catface.html","catface1.html","catface2.html",
      "kitty.html","kittycat.html","kittycat1.html","kittycat2.html",
      "octopus.html","fishtank.html","lizard.html","serpentine.html","serp1.html","underwater.html","underwater1.html","widefield.html",
      "eye.html","eyes.html","matrix.html","molecule.html","mandala.html","mandala1.html","mandala2.html","mandala3.html",
      "ripple.html","ripple1.html","ripple2.html","ripple3.html",
      "substrate.html","substrate1.html","substrate3.html",
      "sovereignty.html","sublime.html","substance.html","teleo.html","teleo1.html","trace.html","turbulence.html"
    ].map(u=>({name:u.replace(".html","").toUpperCase(), url:u, tag:"MONO"}))
  },
  {
    key:"chroma",
    name:"KETA_CHROMA / KETA_SLOP",
    open:false,
    items:[
      "infinity.html",
      "pool.html","pool3.html","pool4.html",
      "slopstream2.html","slopstream3.html",
      "mandalagpt.html","mandalagpt2.html","mandalagpt3.html",
      "mdma.html","mdma2.html","mdmagpt.html","mdmagpt2.html",
      "temple.html","temple1.html"
    ].map(u=>({name:u.replace(".html","").toUpperCase(), url:u, tag:"CHROMA"}))
  }
];

/* Flatten list for prev/next */
function flatPresets(){
  const out=[];
  PRESET_SECTIONS.forEach(sec=>sec.items.forEach(it=>out.push(it)));
  return out;
}

/* ===== STATE ===== */
const PAGE_ID="MOB_PLAYER_v1";
const STORAGE_KEY="KDT::MOB_PLAYER::"+hash8(location.pathname+"|"+PAGE_ID)+"::STATE";

let STATE={
  idx:0,
  url:"",
  name:"",
  invert:false,
  null:false,
  drawerOpen:true,
  activeTab:"presets",
  lightPreset:1,
  lightRunning:false,
  note:{ title:"", body:"" }
};

function loadState(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(raw){
      const loaded=JSON.parse(raw);
      STATE={...STATE,...loaded};
      if(!STATE.note) STATE.note={title:"",body:""};
    }
  }catch(e){}
}
function saveState(){
  try{ localStorage.setItem(STORAGE_KEY,JSON.stringify(STATE)); }catch(e){}
}
function storageInfo(){
  const raw = localStorage.getItem(STORAGE_KEY) || "";
  const bytes = new Blob([raw]).size;
  $("storageInfo").textContent = `STORAGE: KEY=${STORAGE_KEY.slice(0,28)}… SIZE=${bytes}B`;
}

/* ===== MODES ===== */
function applyModes(){
  document.body.classList.toggle("invert", !!STATE.invert);
  document.body.classList.toggle("null", !!STATE.null);
  $("drawer").classList.toggle("open", !!STATE.drawerOpen);
}
function toggleInvert(){
  STATE.invert=!STATE.invert;
  saveState(); applyModes();
  toast(STATE.invert ? "INVERT" : "NORMAL");
}
function toggleNull(){
  STATE.null=!STATE.null;
  saveState(); applyModes();
  toast(STATE.null ? "NULL" : "RETURN");
}

/* LONG PRESS BRAND = INVERT */
(function bindLongPress(){
  const el=$("brandHold");
  let t=null;
  const LONG=520;
  const clear=()=>{ if(t){clearTimeout(t); t=null;} };
  el.addEventListener("pointerdown",(ev)=>{
    if(ev.pointerType!=="touch") return;
    clear();
    t=setTimeout(()=>{ toggleInvert(); }, LONG);
  },{passive:true});
  el.addEventListener("pointerup", clear, {passive:true});
  el.addEventListener("pointercancel", clear, {passive:true});
})();

/* ===== PLAYER ===== */
let ALL = [];
function setNowLabel(){
  $("nowLabel").textContent = STATE.name ? STATE.name : "—";
}
function loadByIndex(i){
  ALL = ALL.length ? ALL : flatPresets();
  const idx = clamp(i|0, 0, ALL.length-1);
  const p = ALL[idx];
  STATE.idx = idx;
  STATE.url = p.url;
  STATE.name = p.name;

  $("surfaceFrame").src = p.url;
  setNowLabel();
  saveState();
  toast(p.name);
}
function prev(){ ALL=flatPresets(); loadByIndex((STATE.idx-1+ALL.length)%ALL.length); }
function next(){ ALL=flatPresets(); loadByIndex((STATE.idx+1)%ALL.length); }
function reload(){
  const frame=$("surfaceFrame");
  const u=STATE.url || (flatPresets()[STATE.idx] && flatPresets()[STATE.idx].url) || "";
  if(!u) return;
  frame.src="about:blank";
  setTimeout(()=>{ frame.src=u; }, 20);
  toast("RELOAD");
}
function stopSurface(){
  $("surfaceFrame").src="about:blank";
  toast("STOP SURFACE");
}

/* ===== DRAWER / TABS ===== */
function toggleDrawer(){
  STATE.drawerOpen = !STATE.drawerOpen;
  saveState(); applyModes();
}
function setTab(tab){
  STATE.activeTab = tab;
  saveState();
  $("tabPresets").classList.toggle("active", tab==="presets");
  $("tabLights").classList.toggle("active", tab==="lights");
  $("tabSystem").classList.toggle("active", tab==="system");
  $("panelPresets").classList.toggle("hidden", tab!=="presets");
  $("panelLights").classList.toggle("hidden", tab!=="lights");
  $("panelSystem").classList.toggle("hidden", tab!=="system");
}

/* ===== PRESETS UI ===== */
function buildSections(){
  const wrap=$("sections");
  wrap.innerHTML="";
  const q = String($("searchInput").value||"").trim().toUpperCase();

  PRESET_SECTIONS.forEach((sec)=>{
    const box=document.createElement("div");
    box.className="section";

    const h=document.createElement("div");
    h.className="section-h";
    const count = sec.items.length;
    h.innerHTML = `<span>${sec.name}</span><span>${count}</span>`;

    const b=document.createElement("div");
    b.className="section-b";
    if(sec.open || q) b.classList.add("open");

    const items = q
      ? sec.items.filter(it => it.name.includes(q) || it.url.toUpperCase().includes(q))
      : sec.items;

    const g=document.createElement("div");
    g.className="grid";

    items.forEach((it)=>{
      const p=document.createElement("div");
      p.className="preset";
      p.innerHTML = `<span class="name">${it.name}</span><span class="tag">${it.tag}</span>`;
      p.addEventListener("click", ()=> {
        ALL = flatPresets();
        const idx = ALL.findIndex(x=>x.url===it.url);
        loadByIndex(idx>=0?idx:0);
      });
      g.appendChild(p);
    });

    b.appendChild(g);
    h.addEventListener("click", ()=>{
      b.classList.toggle("open");
      sec.open = b.classList.contains("open");
    });

    box.appendChild(h);
    box.appendChild(b);
    wrap.appendChild(box);
  });
}

/* ===== LIGHTS (1–6) ===== */
let lightInterval=null;
let lightCount=0;

function updateLightUI(){
  document.querySelectorAll(".lbtn").forEach(btn=>{
    btn.classList.toggle("active", Number(btn.dataset.light)===Number(STATE.lightPreset));
  });
}
function stopLight(){
  if(lightInterval){ clearInterval(lightInterval); lightInterval=null; }
  STATE.lightRunning=false;
  const stage=$("stage");
  stage.classList.remove("active");
  stage.style.backgroundColor="#000";
  stage.style.filter="none";
  saveState();
}
function startLight(preset){
  stopLight();
  STATE.lightPreset = Number(preset)||1;
  STATE.lightRunning=true;

  const stage=$("stage");
  stage.classList.add("active");
  lightCount=0;

  const p=STATE.lightPreset;

  if(p===1){
    lightInterval=setInterval(()=>{
      const curr=stage.style.backgroundColor||"black";
      stage.style.backgroundColor=(curr==="black"||curr==="rgb(0, 0, 0)")?"white":"black";
      stage.style.filter="none";
    },50);
  }else if(p===2){
    let hue=0,wave=0;
    lightInterval=setInterval(()=>{
      hue=(hue+18)%360;
      wave+=0.22;
      const l=34+Math.sin(wave)*22;
      stage.style.backgroundColor=`hsl(${hue},100%,${l}%)`;
      stage.style.filter="contrast(1.35) saturate(1.6)";
    },16);
  }else if(p===3){
    lightInterval=setInterval(()=>{
      lightCount++;
      const beat=lightCount%16;
      if(beat===0||beat===1){
        stage.style.backgroundColor="#fff";
        stage.style.filter="invert(1) contrast(3)";
      }else if(beat===2){
        stage.style.backgroundColor="#000";
        stage.style.filter="invert(1) contrast(2)";
      }else if(beat===3){
        stage.style.backgroundColor="#111";
        stage.style.filter="contrast(3)";
      }else if(beat<8){
        stage.style.backgroundColor="#fff";
        stage.style.filter="contrast(1.8) invert(.15)";
      }else{
        stage.style.backgroundColor="#000";
        stage.style.filter="contrast(2.2) invert(.08)";
      }
    },30);
  }else if(p===4){
    let phase=0;
    lightInterval=setInterval(()=>{
      phase+=0.08;
      lightCount++;
      const red=Math.abs(Math.sin(phase))*255;
      const pulse=Math.abs(Math.sin(phase*0.5));
      if(lightCount%10===0){
        stage.style.backgroundColor="#000";
        stage.style.filter="brightness(3)";
      }else{
        stage.style.backgroundColor=`rgb(${red|0},0,0)`;
        stage.style.filter=`contrast(${1.8+pulse*1.6}) saturate(${2.2+pulse*1.6})`;
      }
    },20);
  }else if(p===5){
    let a=0,c=0;
    lightInterval=setInterval(()=>{
      a+=13;
      c=(c+2)%100;
      const hue=260+Math.sin(a*0.1)*40;
      const sat=80+Math.cos(a*0.05)*20;
      const light=28+Math.sin(c*0.1)*26;
      stage.style.backgroundColor=`hsl(${hue},${sat}%,${light}%)`;
      stage.style.filter=`contrast(${1.4+Math.abs(Math.cos(a*0.07))}) hue-rotate(${a*0.45}deg)`;
    },25);
  }else if(p===6){
    lightInterval=setInterval(()=>{
      lightCount++;
      if(lightCount%50===0 || lightCount%50===2 || lightCount%50===4){
        stage.style.backgroundColor="#fff";
        stage.style.filter="brightness(5) contrast(2)";
      }else{
        stage.style.backgroundColor="#000";
        stage.style.filter="none";
      }
    },30);
  }

  saveState();
  updateLightUI();
  toast(`LIGHT ${p} RUN`);
}
function toggleLight(){
  if(STATE.lightRunning){ stopLight(); toast("LIGHT STOP"); }
  else startLight(STATE.lightPreset||1);
}

/* DOUBLE TAP ANYWHERE = TOGGLE LIGHT RUN */
let lastTapAt=0;
const DBL_MS=280;
document.addEventListener("pointerdown",(ev)=>{
  if(ev.pointerType!=="touch") return;
  const now=performance.now();
  if(now-lastTapAt < DBL_MS){
    ev.preventDefault();
    toggleLight();
    lastTapAt = 0;
  }else{
    lastTapAt = now;
  }
},{passive:false});

/* ===== KETA_NOTE ===== */
function openNote(){
  $("noteOverlay").classList.add("open");
  $("noteTitle").value = STATE.note.title || "";
  $("noteBody").value = STATE.note.body || "";
}
function closeNote(){
  $("noteOverlay").classList.remove("open");
}
function saveNoteFromUI(){
  STATE.note.title = $("noteTitle").value || "";
  STATE.note.body  = $("noteBody").value || "";
  saveState();
}
function exportNote(){
  saveNoteFromUI();
  const payload = {
    title: STATE.note.title,
    body: STATE.note.body,
    updated_at: new Date().toISOString(),
    source: "KETA_NOTE"
  };
  const blob = new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=`keta_note_${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast("NOTE EXPORTED");
}

/* ===== SYSTEM EXPORT/IMPORT ===== */
function exportState(){
  saveNoteFromUI();
  const payload = {
    STATE,
    exported_at: new Date().toISOString(),
    file_id: "mob_player_v1"
  };
  const blob = new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=`mob_player_state_${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast("EXPORTED");
}
function importState(){
  $("fileInput").value="";
  $("fileInput").click();
}
function clearState(){
  if(!confirm("CLEAR STATE?")) return;
  stopLight();
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
}

/* ===== BINDINGS ===== */
$("btnDrawer").onclick=toggleDrawer;
$("drawerHandle").onclick=toggleDrawer;

$("btnPrev").onclick=prev;
$("btnNext").onclick=next;
$("btnReload").onclick=reload;
$("btnStop").onclick=stopSurface;

$("tabPresets").onclick=()=>setTab("presets");
$("tabLights").onclick=()=>setTab("lights");
$("tabSystem").onclick=()=>setTab("system");

$("searchInput").addEventListener("input", buildSections);

document.querySelectorAll(".lbtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    STATE.lightPreset = Number(btn.dataset.light)||1;
    saveState();
    updateLightUI();
    toast(`LIGHT ${STATE.lightPreset}`);
  });
});

$("btnLightRun").onclick=()=>startLight(STATE.lightPreset||1);
$("btnLightStop").onclick=()=>{ stopLight(); toast("LIGHT STOP"); };
$("btnLightPick").onclick=()=>{ /* no-op: pick is tap L1–L6 */ toast("TAP L1–L6"); };

$("btnExport").onclick=exportState;
$("btnImport").onclick=importState;
$("btnClear").onclick=clearState;
$("btnStopLights").onclick=()=>{ stopLight(); toast("LIGHT STOP"); };
$("btnStopSurface").onclick=stopSurface;

$("btnInvert").onclick=toggleInvert;
$("btnNull").onclick=toggleNull;
$("btnSys").onclick=()=>{
  STATE.drawerOpen = true;
  applyModes();
  setTab("system");
  saveState();
};

$("nullSquare").onclick=toggleNull;

/* KETA_NOTE in usual place (top-right icon) */
$("btnNote").onclick=openNote;
$("btnNoteBack").onclick=()=>{ saveNoteFromUI(); closeNote(); toast("NOTE SAVED"); };
$("btnNoteExport").onclick=exportNote;
$("noteTitle").addEventListener("input", saveNoteFromUI);
$("noteBody").addEventListener("input", saveNoteFromUI);

/* File import handler */
$("fileInput").addEventListener("change",(e)=>{
  const file=e.target.files && e.target.files[0];
  if(!file) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const data=JSON.parse(String(r.result||"{}"));
      const incoming = data.STATE ? data.STATE : data;

      // merge safely
      STATE = {...STATE, ...incoming};
      if(!STATE.note) STATE.note={title:"",body:""};
      saveState();

      // apply
      applyModes();
      setTab(STATE.activeTab || "presets");
      updateLightUI();
      buildSections();
      storageInfo();

      // restore surface
      ALL = flatPresets();
      const idx = clamp(Number(STATE.idx)||0, 0, ALL.length-1);
      loadByIndex(idx);

      toast("IMPORTED");
    }catch(err){
      toast("IMPORT FAILED");
    }
  };
  r.readAsText(file);
});

/* ===== INIT ===== */
(function init(){
  loadState();
  ALL = flatPresets();

  // UI
  applyModes();
  setTab(STATE.activeTab || "presets");
  buildSections();
  updateLightUI();
  storageInfo();

  // start surface
  if(!STATE.url){
    STATE.idx=0;
    STATE.url=ALL[0].url;
    STATE.name=ALL[0].name;
  }else{
    // ensure idx matches url if possible
    const idx = ALL.findIndex(p=>p.url===STATE.url);
    if(idx>=0) STATE.idx=idx;
  }
  loadByIndex(STATE.idx);

  // stop any running light on reload (stable default)
  stopLight();
})();
</script>

<!--
AE:
- MOB_PLAYER: SURFACE FULL VIEWPORT + COLLAPSIBLE SYSTEM DRAWER.
- KETA_NOTE: FULL-PAGE (APPLE NOTES VIBE), TOP-RIGHT ICON, AUTO-SAVE.
- INVERT + NULL: UNIVERSALS AS BUTTONS; NULL SQUARE BOTTOM-RIGHT.

EE:
- PRESETS: TOY + KETA_MONO + KETA_CHROMA.
- LIGHTS: PRESETS 1–6 SELECTABLE; DOUBLE TAP ANYWHERE TO TOGGLE RUN.
- SYSTEM: EXPORT/IMPORT (FILE DOWNLOAD/UPLOAD) + CLEAR + STORAGE READOUT.

WB:
FILE_ID: mob_player_v1.html
ROOM_ID: MOB_PLAYER
VERSION: v1.1.0
UPDATED_AT: 2026-01-15
CHANGELOG:
- Added sections: TOYS + KETA_MONO + KETA_CHROMA presets.
- Implemented LIGHTS 1–6 with selectable presets and double-tap run.
- Added KETA_NOTE full-page overlay with auto-save + export note.
- Added system state export/import + storage readout.
-->
</body>
</html>
