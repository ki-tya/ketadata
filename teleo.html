<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>NON-TELEOLOGICAL STATE HOLDER // RAW</title>
<style>
  :root{
    --bg:#0b0b0b;
    --fg:#f5f5f5;
    --dim:rgba(245,245,245,.65);
    --line:rgba(245,245,245,.20);
    --line2:rgba(245,245,245,.10);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;overflow:hidden}
  button,input,select,textarea{font-family:inherit}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

  .app{height:100%;display:grid;grid-template-columns:360px 1fr;gap:10px;padding:10px}
  .panel{border:1px solid var(--line);background:rgba(255,255,255,.03);min-height:0;display:flex;flex-direction:column}
  .hdr{padding:10px;border-bottom:1px solid var(--line2);display:flex;justify-content:space-between;gap:10px;align-items:center}
  .hdr .t{font-weight:700;font-size:12px;letter-spacing:.08em;text-transform:uppercase}
  .chip{border:1px solid var(--line);padding:4px 8px;font-size:11px;letter-spacing:.08em;text-transform:uppercase;color:var(--dim)}
  .body{padding:10px;overflow:auto;min-height:0}
  .body::-webkit-scrollbar{width:10px}
  .body::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15)}

  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .row + .row{margin-top:10px}
  .label{font-size:11px;letter-spacing:.08em;text-transform:uppercase;color:var(--dim)}
  input[type="range"]{width:100%}
  input[type="text"], textarea, select{
    width:100%;
    border:1px solid var(--line);
    background:transparent;color:var(--fg);
    padding:8px;font-size:12px;outline:none;border-radius:0;
  }
  textarea{min-height:110px;resize:vertical}
  .btn{
    border:1px solid var(--line);
    background:transparent;color:var(--fg);
    padding:8px 10px;
    font-size:11px;letter-spacing:.08em;text-transform:uppercase;
    cursor:pointer;border-radius:0;
  }
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:rgba(255,255,255,.08)}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}

  /* field */
  canvas{width:100%;height:100%;display:block}
  .fieldWrap{position:relative;min-height:0}
  .overlay{
    position:absolute;left:12px;top:12px;right:12px;
    display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
    pointer-events:none;
  }
  .overlay .blk{
    border:1px solid var(--line);
    background:rgba(0,0,0,.30);
    padding:8px 10px;
    max-width:52%;
  }
  .overlay .blk .h{font-weight:700;font-size:11px;letter-spacing:.08em;text-transform:uppercase}
  .overlay .blk .p{margin-top:6px;font-size:12px;line-height:1.35;color:var(--dim)}
  .overlay .right{text-align:right}

  /* "hold" behavior: UI remains, renderer slows (not freezes) */
  body.hold .chipMode{color:var(--fg)}
</style>
</head>
<body>
<div class="app">
  <!-- CONTROL PANEL -->
  <section class="panel">
    <div class="hdr">
      <div class="t">STATE HOLDER</div>
      <div class="chip mono chipMode" id="modeChip">MODE: OPEN</div>
    </div>
    <div class="body">
      <div class="row">
        <div class="label">STATE (NAME IT WITHOUT GOAL)</div>
      </div>
      <div class="row">
        <input id="stateName" type="text" value="DIVINE URGE / BECOMING / WITHOUT OBJECT"/>
      </div>

      <div class="row">
        <div class="label">NOTE (OPTIONAL, NOT INTERPRETED)</div>
      </div>
      <div class="row">
        <textarea id="note" class="mono" spellcheck="false">This is a non-teleological state. The interface holds it without converting it into a task.</textarea>
      </div>

      <div class="row grid">
        <button class="btn primary" id="toggleHold">TOGGLE HOLD (SPACE)</button>
        <button class="btn" id="pulse">PULSE (P)</button>
        <button class="btn" id="clearTrail">CLEAR TRAIL (C)</button>
        <button class="btn" id="reset">RESET (R)</button>
      </div>

      <div class="row" style="margin-top:14px">
        <div class="label">INTENSITY (ENERGY, NOT URGENCY)</div>
      </div>
      <div class="row">
        <input id="intensity" type="range" min="0" max="100" value="55"/>
      </div>

      <div class="row">
        <div class="label">STABILITY (HOW MUCH IT HOLDS SHAPE)</div>
      </div>
      <div class="row">
        <input id="stability" type="range" min="0" max="100" value="65"/>
      </div>

      <div class="row">
        <div class="label">DRIFT (HOW MUCH IT WANDERS)</div>
      </div>
      <div class="row">
        <input id="drift" type="range" min="0" max="100" value="40"/>
      </div>

      <div class="row">
        <div class="label">BREATH (SLOW OSCILLATION)</div>
      </div>
      <div class="row">
        <input id="breath" type="range" min="0" max="100" value="50"/>
      </div>

      <div class="row">
        <div class="label">BOUNDARY (SOFT CONTAINER, NOT CONSTRAINT)</div>
      </div>
      <div class="row">
        <input id="boundary" type="range" min="0" max="100" value="60"/>
      </div>

      <div class="row" style="margin-top:14px">
        <div class="label">EXPORT / IMPORT STATE</div>
      </div>
      <div class="row grid">
        <button class="btn" id="exportBtn">EXPORT JSON (E)</button>
        <button class="btn" id="importBtn">IMPORT JSON</button>
      </div>
      <div class="row">
        <textarea id="io" class="mono" spellcheck="false" style="min-height:150px"></textarea>
      </div>

      <div class="row">
        <div class="label">HOTKEYS</div>
      </div>
      <div class="row">
        <div class="mono" style="font-size:11px;color:var(--dim);line-height:1.4">
SPACE = HOLD TOGGLE<br/>
P = PULSE<br/>
C = CLEAR TRAIL<br/>
R = RESET<br/>
E = EXPORT<br/>
        </div>
      </div>
    </div>
  </section>

  <!-- FIELD -->
  <section class="panel fieldWrap">
    <div class="hdr">
      <div class="t">FIELD</div>
      <div class="chip mono" id="readout">ENERGY: 0.55 | STABILITY: 0.65 | DRIFT: 0.40</div>
    </div>
    <canvas id="cv"></canvas>
    <div class="overlay">
      <div class="blk">
        <div class="h" id="ovName">DIVINE URGE / BECOMING / WITHOUT OBJECT</div>
        <div class="p" id="ovMode">Holding state without task conversion.</div>
      </div>
      <div class="blk right">
        <div class="h mono" id="ovTime">--:--:--</div>
        <div class="p mono" id="ovSig">signature: NTSH_V1</div>
      </div>
    </div>
  </section>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const cv = $("cv");
  const ctx = cv.getContext("2d", { alpha: false });

  const S = {
    signature: "NTSH_V1", // Non-Teleological State Holder v1
    updatedAt: new Date().toISOString(),

    hold: false,

    stateName: $("stateName").value,
    note: $("note").value,

    // normalized 0..1
    intensity: 0.55,
    stability: 0.65,
    drift: 0.40,
    breath: 0.50,
    boundary: 0.60,

    // transient renderer state
    t: 0,
    pulse: 0,
    seed: Math.random()*1000
  };

  function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
  const pad2 = (n) => String(n).padStart(2,"0");

  function resize(){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const r = cv.getBoundingClientRect();
    cv.width = Math.floor(r.width * dpr);
    cv.height = Math.floor(r.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener("resize", resize);

  function setModeUI(){
    document.body.classList.toggle("hold", S.hold);
    $("modeChip").textContent = `MODE: ${S.hold ? "HOLD" : "OPEN"}`;
    $("ovMode").textContent = S.hold
      ? "HOLD: reduce change-rate. preserve tension. do not force closure."
      : "OPEN: allow movement. do not demand an object.";
    $("ovSig").textContent = `signature: ${S.signature}`;
  }

  function updateReadout(){
    $("readout").textContent =
      `ENERGY: ${S.intensity.toFixed(2)} | STABILITY: ${S.stability.toFixed(2)} | DRIFT: ${S.drift.toFixed(2)}`;
    $("ovName").textContent = S.stateName || "UNTITLED STATE";
  }

  function pullInputs(){
    S.stateName = $("stateName").value;
    S.note = $("note").value;

    S.intensity = $("intensity").value / 100;
    S.stability = $("stability").value / 100;
    S.drift = $("drift").value / 100;
    S.breath = $("breath").value / 100;
    S.boundary = $("boundary").value / 100;

    updateReadout();
  }

  // Deterministic-ish hash from text (for *rhythm*, not interpretation)
  function hash01(str){
    let h = 2166136261;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return ((h>>>0) % 10000) / 10000;
  }

  function exportState(){
    S.updatedAt = new Date().toISOString();
    pullInputs();
    const payload = {
      signature: S.signature,
      version: "v1",
      updatedAt: S.updatedAt,
      hold: S.hold,
      stateName: S.stateName,
      note: S.note,
      controls: {
        intensity: Number(S.intensity.toFixed(3)),
        stability: Number(S.stability.toFixed(3)),
        drift: Number(S.drift.toFixed(3)),
        breath: Number(S.breath.toFixed(3)),
        boundary: Number(S.boundary.toFixed(3))
      }
    };
    $("io").value = JSON.stringify(payload, null, 2);
  }

  function importState(){
    let obj;
    try{ obj = JSON.parse($("io").value || "{}"); }
    catch(e){ alert("IMPORT FAILED: INVALID JSON"); return; }
    if(!obj || typeof obj !== "object"){ alert("IMPORT FAILED: INVALID PAYLOAD"); return; }

    if(typeof obj.hold === "boolean") S.hold = obj.hold;
    if(typeof obj.stateName === "string") $("stateName").value = obj.stateName;
    if(typeof obj.note === "string") $("note").value = obj.note;

    if(obj.controls && typeof obj.controls === "object"){
      const c = obj.controls;
      if(typeof c.intensity === "number") $("intensity").value = clamp(Math.round(c.intensity*100),0,100);
      if(typeof c.stability === "number") $("stability").value = clamp(Math.round(c.stability*100),0,100);
      if(typeof c.drift === "number") $("drift").value = clamp(Math.round(c.drift*100),0,100);
      if(typeof c.breath === "number") $("breath").value = clamp(Math.round(c.breath*100),0,100);
      if(typeof c.boundary === "number") $("boundary").value = clamp(Math.round(c.boundary*100),0,100);
    }

    pullInputs();
    setModeUI();
    exportState();
  }

  function reset(){
    S.hold = false;
    $("stateName").value = "DIVINE URGE / BECOMING / WITHOUT OBJECT";
    $("note").value = "This is a non-teleological state. The interface holds it without converting it into a task.";
    $("intensity").value = 55;
    $("stability").value = 65;
    $("drift").value = 40;
    $("breath").value = 50;
    $("boundary").value = 60;

    S.pulse = 0;
    pullInputs();
    setModeUI();
    exportState();
  }

  function toggleHold(){
    S.hold = !S.hold;
    setModeUI();
    exportState();
  }

  function doPulse(){
    // pulse increases visibility/contrast for a moment, then decays
    S.pulse = Math.min(1, S.pulse + 0.85);
  }

  function clearTrail(){
    ctx.fillStyle = "#000";
    ctx.fillRect(0,0,cv.clientWidth, cv.clientHeight);
  }

  // UI wiring
  ["stateName","note","intensity","stability","drift","breath","boundary"].forEach(id => {
    $(id).addEventListener("input", () => { pullInputs(); });
  });

  $("toggleHold").addEventListener("click", toggleHold);
  $("pulse").addEventListener("click", () => { doPulse(); });
  $("clearTrail").addEventListener("click", clearTrail);
  $("reset").addEventListener("click", reset);
  $("exportBtn").addEventListener("click", exportState);
  $("importBtn").addEventListener("click", importState);

  // Hotkeys (ignore while typing)
  function isTyping(){
    const a = document.activeElement;
    if(!a) return false;
    const tag = (a.tagName || "").toLowerCase();
    return tag === "textarea" || tag === "input" || tag === "select";
  }

  window.addEventListener("keydown", (e) => {
    if(isTyping()) return;
    const k = (e.key || "").toLowerCase();
    if(k === " "){ e.preventDefault(); toggleHold(); }
    if(k === "p"){ e.preventDefault(); doPulse(); }
    if(k === "c"){ e.preventDefault(); clearTrail(); }
    if(k === "r"){ e.preventDefault(); reset(); }
    if(k === "e"){ e.preventDefault(); exportState(); }
  }, {passive:false});

  // Renderer: a "container" that does not imply telos
  // - boundary controls how close the paths stay to the center
  // - drift controls wandering
  // - stability controls coherence of direction
  // - breath controls slow oscillation of the whole field
  // - intensity controls contrast and density (energy, not urgency)
  let W=0,H=0;
  function tick(now){
    const dt = Math.min(0.033, (now - (tick._last||now))/1000);
    tick._last = now;

    // time
    const d = new Date();
    $("ovTime").textContent = `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;

    // update dimensions
    const r = cv.getBoundingClientRect();
    W = r.width; H = r.height;

    // pull text rhythm (again: rhythm only)
    const rhythm = 0.85 + 0.30 * hash01((S.note||"").slice(0,240));

    // speed: HOLD reduces change-rate, doesn't freeze
    const baseSpeed = 0.18 + S.intensity * 0.90;
    const speed = (S.hold ? baseSpeed * 0.12 : baseSpeed) * rhythm;

    S.t += dt * speed;

    // pulse decay
    S.pulse = Math.max(0, S.pulse - dt*0.9);

    // trail / persistence
    // HOLD increases persistence (thicker memory)
    const fade = S.hold ? 0.06 : 0.16;
    ctx.fillStyle = `rgba(0,0,0,${fade})`;
    ctx.fillRect(0,0,W,H);

    // global parameters
    const cx = W*0.5, cy = H*0.5;
    const boundary = 0.15 + S.boundary * 0.45; // radius factor
    const maxR = Math.min(W,H) * boundary;

    const stability = clamp(S.stability, 0, 1);
    const drift = clamp(S.drift, 0, 1);
    const breath = clamp(S.breath, 0, 1);

    const nLines = 60 + Math.floor(S.intensity * 140);
    const w = 1 + S.intensity*1.4;

    // breath as slow global oscillation (container "alive")
    const bx = Math.cos(S.t*0.7) * (breath*18);
    const by = Math.sin(S.t*0.6) * (breath*18);

    // base contrast
    const pulseBoost = S.pulse * 0.35;
    const alpha = 0.06 + S.intensity*0.16 + pulseBoost;
    ctx.strokeStyle = `rgba(255,255,255,${clamp(alpha,0.05,0.45)})`;
    ctx.lineWidth = w;

    // coherent direction field: stability reduces randomness
    for(let i=0;i<nLines;i++){
      const u = i / nLines;

      // ring placement with drift jitter
      const a = (u*Math.PI*2) + S.t*(0.25 + drift*0.6);
      const jitter = (Math.sin(S.t*1.7 + i*0.9) + Math.cos(S.t*1.3 + i*1.1))*0.5;

      const rr = maxR * (0.35 + 0.65*u) * (1 + jitter*0.08*drift);
      const x1 = cx + bx + Math.cos(a)*rr;
      const y1 = cy + by + Math.sin(a)*rr;

      // direction: blend between stable tangential flow and wandering noise
      const tang = a + Math.PI/2;
      const wander = a + (jitter*2.6);
      const dir = tang*stability + wander*(1-stability);

      // step length: not goal, just movement allowance
      const step = 18 + S.intensity*58;
      const x2 = x1 + Math.cos(dir) * step;
      const y2 = y1 + Math.sin(dir) * step;

      ctx.beginPath();
      ctx.moveTo(x1,y1);
      ctx.lineTo(x2,y2);
      ctx.stroke();
    }

    // boundary ring (soft container)
    ctx.strokeStyle = `rgba(255,255,255,${0.06 + S.boundary*0.10})`;
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.arc(cx+bx, cy+by, maxR, 0, Math.PI*2);
    ctx.stroke();

    requestAnimationFrame(tick);
  }

  // init
  resize();
  setModeUI();
  pullInputs();
  exportState();
  requestAnimationFrame(tick);
})();
</script>
</body>
</html>
