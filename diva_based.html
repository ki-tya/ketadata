<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KETADATA_BASE_SYSTEM.html</title>

<style>
:root{
  --bg:#000; --fg:#fff; --muted:#8a8a8a; --line:#222; --line2:#333;
  --top:44px; --bot:34px;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  --sans: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  --ctl-radius:0px;
  --ctl-alpha:0.82;
  --ctl-bg: rgba(0,0,0,var(--ctl-alpha));
  --note-border: rgba(255,255,255,0.78);
  --drawer-h: 0.42;
}
*{box-sizing:border-box}
html,body{height:100%; margin:0}
body{background:var(--bg); color:var(--fg); font-family:var(--sans); overflow:hidden; user-select:none}
#root{position:fixed; inset:0; background:#000}
#root.invert{filter:invert(1)}
#root.fs .topbar,#root.fs .bottombar,#root.fs .drawer,#root.fs #pinnedPanel,#root.fs #armedBar,#root.fs .toast{display:none !important}
#root.blackout .topbar,#root.blackout .bottombar,#root.blackout .drawer,#root.blackout #pinnedPanel,#root.blackout #armedBar,#root.blackout .toast,#root.blackout .ketaNote{display:none !important}
#root.blackout #stage{background:#000 !important; filter:none !important}
#root.blackout #motion{display:none !important}
#stage{position:absolute; inset:0; background:#000; pointer-events:none}
#motion{position:absolute; inset:0; pointer-events:none; opacity:0; background:repeating-linear-gradient(135deg, rgba(255,255,255,0.06) 0px, rgba(255,255,255,0.06) 1px, rgba(0,0,0,0) 12px, rgba(0,0,0,0) 22px); mix-blend-mode:screen; transform:translate3d(0,0,0)}
#motion.run{opacity:0.12; animation:scanflow 2.2s linear infinite}
@keyframes scanflow{0%{transform:translate3d(-80px,60px,0)}100%{transform:translate3d(80px,-60px,0)}}
.topbar{position:absolute; top:0; left:0; right:0; height:var(--top); display:flex; align-items:center; justify-content:space-between; padding:0 10px; border-bottom:1px solid var(--line); background:linear-gradient(180deg,#070707,#000); z-index:10}
.brand{display:flex; align-items:center; gap:10px; font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase}
.brand .sq{width:10px; height:10px; border:1px solid var(--fg); background:#000}
.roomBadge{display:flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted); border:1px solid var(--line2); padding:4px 8px}
.actions{display:flex; align-items:center; gap:8px; font-family:var(--mono); font-size:12px}
.btn{background:transparent; color:var(--fg); border:1px solid var(--line2); padding:6px 10px; font-family:var(--mono); font-size:12px; letter-spacing:.08em; text-transform:uppercase; cursor:pointer}
.btn:hover{border-color:var(--fg)}
.btn:active{transform:translateY(1px)}
.kbd{border:1px solid var(--line2); padding:2px 6px; color:var(--muted); font-size:11px}
.ketaIcon{width:16px; height:16px; border:2px solid var(--fg); background:var(--fg); cursor:pointer}
.ketaIcon.open{background:#000}
.bottombar{position:absolute; left:0; right:0; bottom:0; height:var(--bot); display:flex; align-items:center; justify-content:space-between; padding:0 10px; border-top:1px solid var(--line); background:linear-gradient(0deg,#070707,#000); z-index:10; font-family:var(--mono); font-size:11px; color:var(--muted)}
.toggle{border:1px solid var(--line2); background:transparent; color:var(--fg); padding:4px 8px; font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase; cursor:pointer}
.toggle:hover{border-color:var(--fg)}
.drawer{position:absolute; left:0; right:0; bottom:var(--bot); height:calc((100vh - var(--top) - var(--bot)) * var(--drawer-h)); min-height:200px; border-top:1px solid var(--line); background:linear-gradient(180deg,#060606,#000); display:none; z-index:20}
.drawer.open{display:flex; flex-direction:column}
.drawerSizer{height:10px; cursor:ns-resize; border-bottom:1px solid var(--line); background:linear-gradient(180deg,#0a0a0a,#050505)}
.drawerHead{padding:8px 10px; border-bottom:1px solid var(--line); font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; display:flex; justify-content:space-between; align-items:center}
.drawerBody{padding:10px; min-height:0; flex:1; overflow:auto}
textarea{width:100%; border:1px solid var(--line2); background:#050505; color:var(--fg); font-family:var(--mono); font-size:12px; padding:10px; line-height:1.35; outline:none; resize:vertical; min-height:140px}
input{outline:none}
.ketaNote{position:absolute; top:76px; right:16px; left:auto; width:340px; height:220px; display:none; z-index:30; resize:both; overflow:hidden; border-radius:var(--ctl-radius); background:var(--ctl-bg); border:1px solid var(--note-border); backdrop-filter:blur(6px)}
.ketaNote.open{display:flex; flex-direction:column}
.ketaHead{padding:8px 10px; border-bottom:1px solid rgba(255,255,255,0.14); font-family:var(--mono); font-size:11px; letter-spacing:.14em; text-transform:uppercase; display:flex; justify-content:space-between; align-items:center; cursor:move}
.ketaBody{padding:10px; min-height:0; flex:1}
.ketaNote textarea{background:#000; color:#fff; border:1px solid rgba(255,255,255,0.22); width:100%; height:100%; resize:none; padding:10px; outline:none}
.headBtn{background:transparent; color:var(--fg); border:1px solid rgba(255,255,255,0.18); padding:2px 8px; font-family:var(--mono); font-size:12px; letter-spacing:.08em; text-transform:uppercase; cursor:pointer}
.headBtn:hover{border-color:rgba(255,255,255,0.6)}
#armedBar{position:absolute; left:10px; top:calc(var(--top) + 10px); z-index:27; display:none; gap:8px; align-items:center; flex-wrap:wrap; padding:8px 10px; border:1px solid var(--line2); background:rgba(0,0,0,0.86); font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase}
#armedBar .label{color:var(--muted)}
#armedBar .val{color:var(--fg)}
#armedBar input{background:#000; color:#fff; border:1px solid var(--line2); padding:6px 8px; font-family:var(--mono); font-size:11px; letter-spacing:.08em; width:340px; max-width:calc(100vw - 40px)}
#pinnedPanel{position:absolute; left:10px; top:calc(var(--top) + 64px); z-index:26; display:none; gap:8px; flex-wrap:wrap; align-items:flex-start; padding:8px 10px; border:1px solid var(--line2); background:rgba(0,0,0,0.86); font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase}
#activeStrip{position:absolute; left:10px; top:calc(var(--top) + 122px); z-index:25; display:none; gap:8px; flex-wrap:wrap; align-items:center; padding:8px 10px; border:1px solid var(--line2); background:rgba(0,0,0,0.86); font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase}
#activeStrip .label{color:var(--muted)}
#padPanel{position:absolute; left:14px; top:calc(var(--top) + 170px); width:360px; height:360px; display:none; z-index:31; border:1px solid rgba(255,255,255,0.22); border-radius:var(--ctl-radius); background:rgba(0,0,0,0.86); backdrop-filter:blur(6px); overflow:hidden; resize:both; min-width:340px; min-height:260px}
#padPanel.open{display:flex; flex-direction:column}
#padHead{padding:8px 10px; border-bottom:1px solid rgba(255,255,255,0.14); font-family:var(--mono); font-size:11px; letter-spacing:.14em; text-transform:uppercase; display:flex; justify-content:space-between; align-items:center; cursor:move}
#padBody{padding:10px; min-height:0; flex:1; display:flex; flex-direction:column; gap:10px}
#padGrid{flex:1; display:grid; grid-template-columns:repeat(4, 1fr); grid-template-rows:repeat(4, 1fr); gap:8px; min-height:0}
.padCell{border:1px solid rgba(255,255,255,0.18); background:rgba(0,0,0,0.35); padding:8px; overflow:hidden; display:flex; flex-direction:column; gap:6px; min-width:0}
.padCell .nm{font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.padCell a{color:var(--fg); font-family:var(--mono); font-size:11px; letter-spacing:.02em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-decoration:none; border-bottom:1px solid rgba(255,255,255,0.18); padding-bottom:2px}
.padCell a:hover{border-bottom-color:rgba(255,255,255,0.55)}
.padCell input{width:100%; background:#000; color:#fff; border:1px solid rgba(255,255,255,0.22); padding:6px 8px; font-family:var(--mono); font-size:11px; letter-spacing:.06em; outline:none; min-width:0}
.toast{position:absolute; left:12px; top:calc(var(--top) + 12px); padding:8px 10px; border:1px solid var(--line2); background:rgba(8,8,8,0.82); font-family:var(--mono); font-size:11px; letter-spacing:.06em; color:var(--fg); display:none; z-index:40}
</style>
</head>

<body>
<div id="root">
  <div id="stage"></div>
  <div id="motion" aria-hidden="true"></div>
  <div id="armedBar"><span class="label">ARMED</span><span class="val" id="armedName">—</span><button class="btn" id="armedGo" style="padding:4px 8px; font-size:11px">GO</button><button class="btn" id="armedNewTab" style="padding:4px 8px; font-size:11px">NEW TAB</button><button class="btn" id="armedCopy" style="padding:4px 8px; font-size:11px">COPY URL</button><input id="armedUrl" readonly value="—" /></div>
  <div id="pinnedPanel"></div>
  <div id="activeStrip"></div>
  <div id="padPanel"><div id="padHead"><span id="padTitle">PAD</span><div style="display:flex; gap:8px; align-items:center"><button class="headBtn" id="padEditBtn">EDIT</button><button class="headBtn" id="padCloseBtn">X</button></div></div><div id="padBody"><div id="padGrid"></div><div style="display:flex; gap:8px; align-items:center; justify-content:space-between; font-family:var(--mono); font-size:11px; color:var(--muted); letter-spacing:.08em; text-transform:uppercase"><span id="padHint">CLICK = ARM</span><span id="padSetId" style="opacity:.7">—</span></div></div></div>
  <div class="toast" id="toast"></div>
  <div class="topbar"><div style="display:flex; gap:10px; align-items:center"><div class="brand"><span class="sq"></span><span>KETADATA // BASE // DIVA9</span><span style="color:var(--muted); letter-spacing:.02em; text-transform:none">v1</span></div><div class="roomBadge"><span>ROOM</span><span id="roomName">BASE</span></div></div><div class="actions"><button class="btn" id="btnImport">IMPORT</button><button class="btn" id="btnExport">EXPORT</button><button class="btn" id="btnCopy">COPY</button><span class="kbd" title="Run">Space</span><span class="kbd" title="Invert">Shift+I</span><span class="kbd" title="Blackout">Shift+N</span><span class="kbd" title="Fullscreen">Shift+F</span><span class="kbd" title="Landing">Shift+K</span><div id="ketaIcon" class="ketaIcon" title="KETA_NOTE"></div></div></div>
  <div class="drawer" id="drawer"><div class="drawerSizer" id="drawerSizer" title="DRAG"></div><div class="drawerHead"><div>SYSTEM</div><div style="display:flex; gap:8px; align-items:center"><span id="sig" style="color:var(--muted); font-family:var(--mono); font-size:11px">∅</span><button class="btn" id="btnToggleMotion">MOTION</button><button class="btn" id="btnCopyUniversals">COPY</button><button class="btn" id="btnCloseDrawer">CLOSE</button></div></div><div class="drawerBody"><div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px"><div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted)">SYSTEM UNIVERSALS</div><button class="btn" id="btnToggleUniversals" style="padding:4px 8px; font-size:11px">TOGGLE</button></div><textarea id="universals" spellcheck="false" autocomplete="off" placeholder="LAWS / REFERENCES"></textarea><div style="margin-top:12px; border-top:1px solid var(--line); padding-top:10px"><div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px"><div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted)">ROOM REGISTRY</div><button class="btn" id="btnToggleRegistry" style="padding:4px 8px; font-size:11px">TOGGLE</button></div><div id="registryBody"><div style="margin-top:8px; display:flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted)"><span>ROOM</span><input id="roomInput" spellcheck="false" autocomplete="off" style="flex:1; background:#000; color:#fff; border:1px solid var(--line2); padding:6px 8px; font-family:var(--mono);" placeholder="NAME" /></div><div style="margin-top:8px; display:flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted)"><span>URL</span><input id="roomUrlInput" spellcheck="false" autocomplete="off" style="flex:1; background:#000; color:#fff; border:1px solid var(--line2); padding:6px 8px; font-family:var(--mono);" placeholder="ANY LINK / PATH" /></div><div style="margin-top:8px; display:flex; gap:8px; align-items:center"><button class="btn" id="btnSaveRoom">SAVE</button><button class="btn" id="btnSetActiveRoom">SET ACTIVE</button><button class="btn" id="btnDeleteRoom">DELETE</button><button class="btn" id="btnTogglePins">PINS</button></div></div><div style="margin-top:10px; border-top:1px solid var(--line); padding-top:10px"><div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px"><div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted)">ACTIVE</div><button class="btn" id="btnToggleActive" style="padding:4px 8px; font-size:11px">TOGGLE</button></div><div id="activeBody"><div style="display:flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted)"><span style="min-width:44px">ROOM</span><input id="activeRoomBox" readonly style="flex:1; background:#000; color:#fff; border:1px solid var(--line2); padding:6px 8px; font-family:var(--mono);" placeholder="—" /></div><div style="margin-top:8px; display:flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted)"><span style="min-width:44px">URL</span><input id="activeUrlBox" readonly style="flex:1; background:#000; color:#fff; border:1px solid var(--line2); padding:6px 8px; font-family:var(--mono);" placeholder="—" /></div><div style="margin-top:8px; display:flex; gap:8px; align-items:center"><button class="btn" id="btnGoActive">GO</button><button class="btn" id="btnNewTabActive">NEW TAB</button><button class="btn" id="btnCopyActiveUrl">COPY URL</button></div><div style="margin-top:8px; color:var(--muted); font-family:var(--mono); font-size:11px">CLICK = ARM. GO = COMMIT.</div></div></div><div id="setsBox" style="margin-top:10px; border-top:1px solid var(--line); padding-top:10px"><div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px"><div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted)">SETS</div><button class="btn" id="btnToggleSets" style="padding:4px 8px; font-size:11px">TOGGLE</button></div><div id="setsBody"><div style="margin-top:8px; display:flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted)"><span>SET</span><input id="setNameInput" spellcheck="false" autocomplete="off" style="flex:1; background:#000; color:#fff; border:1px solid var(--line2); padding:6px 8px; font-family:var(--mono);" placeholder="NAME" /></div><div style="margin-top:8px; display:flex; gap:8px; align-items:center"><button class="btn" id="btnCreateSet">CREATE</button><button class="btn" id="btnRenameSet">RENAME</button><button class="btn" id="btnDeleteSet">DELETE</button><button class="btn" id="btnPinSet">PIN/UNPIN</button></div><div style="margin-top:8px; color:var(--muted); font-family:var(--mono); font-size:11px">SET EDITOR (BULK): ONE PER LINE: NAME | URL  OR URL</div><textarea id="setItemsInput" spellcheck="false" autocomplete="off" style="min-height:120px; margin-top:8px" placeholder="ITEMS:
NAME | URL
OR URL"></textarea><div style="margin-top:8px; display:flex; gap:8px; align-items:center"><button class="btn" id="btnSaveSetItems">SAVE ITEMS</button><button class="btn" id="btnClearSetItems">CLEAR</button></div><div style="margin-top:10px; border-top:1px solid var(--line); padding-top:10px"><div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted); margin-bottom:8px">SET LIST</div><div id="setList" style="display:flex; flex-direction:column; gap:6px"></div><div style="margin-top:8px; color:var(--muted); font-family:var(--mono); font-size:11px">CLICK SET = LOAD EDITOR. CLICK ITEM = ARM.</div></div></div></div><div style="margin-top:10px; border-top:1px solid var(--line); padding-top:10px"><div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px"><div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted)">BULK INPUT</div><button class="btn" id="btnToggleBulk" style="padding:4px 8px; font-size:11px">TOGGLE</button></div><div id="bulkBody"><textarea id="bulkRoomInput" spellcheck="false" autocomplete="off" style="min-height:110px" placeholder="ONE PER LINE:
NAME | URL
OR URL

# lines starting with # are ignored"></textarea><div style="margin-top:8px; display:flex; gap:8px; align-items:center"><button class="btn" id="btnBulkAdd">BULK ADD</button><button class="btn" id="btnBulkClear">CLEAR</button></div><div style="margin-top:8px; color:var(--muted); font-family:var(--mono); font-size:11px">NO AUTOFILL. OVERWRITE FAST.</div></div></div><div style="margin-top:10px; border-top:1px solid var(--line); padding-top:10px"><div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px"><div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted)">PRESETS</div><button class="btn" id="btnTogglePresets" style="padding:4px 8px; font-size:11px">TOGGLE</button></div><div id="presetsBody"><div id="roomList" style="display:flex; flex-direction:column; gap:6px"></div><div style="margin-top:8px; color:var(--muted); font-family:var(--mono); font-size:11px">CLICK = ARM. PIN = BASE.</div></div></div></div></div></div>
  <div class="bottombar"><div style="display:flex; gap:10px; align-items:center"><button class="toggle" id="toggleDrawer">SYSTEM</button><button class="toggle" id="toggleRun">RUN</button><span>STATE: <span id="sig2">∅</span></span><span style="margin-left:8px">FS: <span id="fsLabel">OFF</span></span><span style="margin-left:8px">BLK: <span id="blkLabel">OFF</span></span></div><div style="display:flex; gap:12px; align-items:center"><span>LIGHT: <span id="lightLabel">1</span></span><span>RUN: <span id="runLabel">OFF</span></span><span>MOTION: <span id="motionLabel">OFF</span></span></div></div>
  <div class="ketaNote" id="ketaNote"><div class="ketaHead" id="ketaHead"><div>KETA_NOTE</div><button class="headBtn" id="btnHideNote">-</button></div><div class="ketaBody"><textarea id="ketaText" spellcheck="false" autocomplete="off" placeholder="GLOBAL NOTE"></textarea></div></div>
  <input id="file" type="file" accept="application/json" style="display:none" />
</div>

<script>
const URLS={LANDING:"index11.html",PHOTOBOOTH:"crunch1.html",KDTV:"kdtv1.html",POD:"room.html",WORLD:"map.html",INFINITY:"infinity.html",CALENDAR:"calendar1.html",STUDIO:"tester3.html",LAB:"labyrinth.html"};
const FILE_ID="KETADATA_DIVA9";const PAGE_ID="BASE";const STORAGE_EPOCH="SOVEREIGN_FIX";
const STORAGE_KEY="KDT::BASE::SOVEREIGN::STATE::FIXED";
function nowISO(){return new Date().toISOString()}
const $=id=>document.getElementById(id);
const root=$("root"),stage=$("stage"),motion=$("motion");
const CORE_PRESETS=[{room:"CALENDAR",roomUrl:URLS.CALENDAR},{room:"POD",roomUrl:URLS.POD},{room:"WORLD",roomUrl:URLS.WORLD},{room:"KDTV",roomUrl:URLS.KDTV},{room:"PHOTOBOOTH",roomUrl:URLS.PHOTOBOOTH},{room:"STUDIO",roomUrl:URLS.STUDIO},{room:"LAB",roomUrl:URLS.LAB}];
const DEFAULT={version:"KETADATA_DIVA9_SOVEREIGN_FIX",updatedAt:nowISO(),ketaNote:"",universals:"",room:"BASE",roomUrl:"",ui:{invert:false,blackout:false,fullscreen:false,lightPreset:1,lightRunning:false,motionOn:false,pinnedRooms:[],pinnedSets:[],activeSets:[],activeSetId:"",padOpen:false,padEdit:false,padRect:{x:null,y:null,w:360,h:360},drawerOpen:false,noteOpen:false,universalsCollapsed:false,registryCollapsed:false,activeCollapsed:false,setsCollapsed:false,bulkCollapsed:false,presetsCollapsed:false,noteRect:{x:null,y:76,w:340,h:220},drawerH:0.42},payload:{roomPresets:[],sets:[]}};
function cloneDeep(o){return JSON.parse(JSON.stringify(o))}
function deepFill(obj){const out=cloneDeep(DEFAULT);if(!obj||typeof obj!=="object")return out;for(const k in DEFAULT){if(obj[k]!==undefined)out[k]=obj[k]}if(obj.ui&&typeof obj.ui==="object"){for(const k in DEFAULT.ui){if(obj.ui[k]!==undefined)out.ui[k]=obj.ui[k]}}if(obj.payload&&typeof obj.payload==="object"){for(const k in DEFAULT.payload){if(obj.payload[k]!==undefined)out.payload[k]=obj.payload[k]}}if(!Array.isArray(out.ui.pinnedRooms))out.ui.pinnedRooms=[];if(!Array.isArray(out.ui.pinnedSets))out.ui.pinnedSets=[];if(!Array.isArray(out.ui.activeSets))out.ui.activeSets=[];if(!out.ui.padRect||typeof out.ui.padRect!=="object")out.ui.padRect=cloneDeep(DEFAULT.ui.padRect);if(!out.ui.noteRect||typeof out.ui.noteRect!=="object")out.ui.noteRect=cloneDeep(DEFAULT.ui.noteRect);if(typeof out.ui.drawerH!=="number")out.ui.drawerH=0.42;if(!Array.isArray(out.payload.roomPresets))out.payload.roomPresets=[];if(!Array.isArray(out.payload.sets))out.payload.sets=[];return out}
function loadLocal(){try{const raw=localStorage.getItem(STORAGE_KEY);if(!raw)return null;return deepFill(JSON.parse(raw))}catch(e){return null}}
let STATE=loadLocal()||cloneDeep(DEFAULT);
function canonRoomName(n){return String(n||"").trim().toUpperCase()}
function canonSetName(n){return String(n||"").trim().toUpperCase()}
function uid8(){const a=new Uint32Array(1);try{crypto.getRandomValues(a)}catch(e){a[0]=Math.floor(Math.random()*1e9)}return(a[0]>>>0).toString(16).padStart(8,"0")}
function hash8(s){const str=String(s||"");let h=2166136261;for(let i=0;i<str.length;i++){h^=str.charCodeAt(i);h=Math.imul(h,16777619)}return(h>>>0).toString(16).slice(0,8)}
function stableSig(){const core=JSON.stringify({v:STATE.version,room:STATE.room,roomUrl:STATE.roomUrl,keta:hash8(STATE.ketaNote||""),i:STATE.ui.invert,f:STATE.ui.fullscreen,b:STATE.ui.blackout,p:STATE.ui.lightPreset,r:STATE.ui.lightRunning,m:STATE.ui.motionOn,dh:STATE.ui.drawerH,pins:STATE.ui.pinnedRooms,pinnedSets:STATE.ui.pinnedSets});let h=2166136261;for(let i=0;i<core.length;i++){h^=core.charCodeAt(i);h=Math.imul(h,16777619)}return(h>>>0).toString(16).slice(0,8)}
let _PERSIST_LOCK=false;
function persist(silent=false){if(_PERSIST_LOCK)return;STATE.updatedAt=nowISO();ensureCorePresets();root.style.setProperty("--drawer-h",String(STATE.ui.drawerH));try{localStorage.setItem(STORAGE_KEY,JSON.stringify(STATE))}catch(e){}if(!silent)render()}
function flush(){try{_PERSIST_LOCK=true;STATE.updatedAt=nowISO();localStorage.setItem(STORAGE_KEY,JSON.stringify(STATE));_PERSIST_LOCK=false}catch(e){_PERSIST_LOCK=false}}
window.addEventListener("pagehide",flush,{capture:true});window.addEventListener("beforeunload",flush,{capture:true});document.addEventListener("visibilitychange",()=>{if(document.visibilityState==="hidden")flush()},{capture:true});
function ensureCorePresets(){const map=new Map();(STATE.payload.roomPresets||[]).forEach(p=>{const k=canonRoomName(p.room);if(!k)return;map.set(k,Object.assign({},p,{room:k}))});CORE_PRESETS.forEach(cp=>{const k=canonRoomName(cp.room);if(!map.has(k)){map.set(k,{room:k,roomUrl:cp.roomUrl,createdAt:nowISO(),updatedAt:nowISO()})}else{const cur=map.get(k);if(!String(cur.roomUrl||"").trim())cur.roomUrl=cp.roomUrl;map.set(k,cur)}});STATE.payload.roomPresets=[...map.values()]}
function ensurePinnedRooms(){if(!Array.isArray(STATE.ui.pinnedRooms))STATE.ui.pinnedRooms=[];STATE.ui.pinnedRooms=STATE.ui.pinnedRooms.map(canonRoomName).filter(Boolean)}
function ensurePinnedSets(){if(!Array.isArray(STATE.ui.pinnedSets))STATE.ui.pinnedSets=[];STATE.ui.pinnedSets=STATE.ui.pinnedSets.map(String).filter(Boolean)}
function ensureActiveSets(){if(!Array.isArray(STATE.ui.activeSets))STATE.ui.activeSets=[];STATE.ui.activeSets=STATE.ui.activeSets.map(String).filter(Boolean).filter(id=>!!getSetById(id));if(!STATE.ui.activeSets.length){const seeds=(STATE.payload.sets||[]).slice(0,4).map(s=>String(s.id||"")).filter(Boolean);STATE.ui.activeSets=seeds}if(STATE.ui.activeSetId&&!getSetById(STATE.ui.activeSetId))STATE.ui.activeSetId="";if(!STATE.ui.activeSetId&&STATE.ui.activeSets.length)STATE.ui.activeSetId=String(STATE.ui.activeSets[0])}
function getPreset(roomName){const room=canonRoomName(roomName);return(STATE.payload.roomPresets||[]).find(r=>canonRoomName(r.room)===room)||null}
function isPinned(roomName){ensurePinnedRooms();const r=canonRoomName(roomName);return STATE.ui.pinnedRooms.includes(r)}
function togglePin(roomName){ensurePinnedRooms();const r=canonRoomName(roomName);const i=STATE.ui.pinnedRooms.indexOf(r);if(i>=0)STATE.ui.pinnedRooms.splice(i,1);else STATE.ui.pinnedRooms.push(r)}
function getSetById(id){const sid=String(id||"").trim();return(STATE.payload.sets||[]).find(s=>String(s.id)===sid)||null}
function isSetPinned(id){ensurePinnedSets();const sid=String(id||"").trim();return STATE.ui.pinnedSets.includes(sid)}
function togglePinSet(id){ensurePinnedSets();const sid=String(id||"").trim();const i=STATE.ui.pinnedSets.indexOf(sid);if(i>=0)STATE.ui.pinnedSets.splice(i,1);else STATE.ui.pinnedSets.push(sid)}
let toastTimer=null;
function toast(msg){if(STATE.ui.blackout||STATE.ui.fullscreen)return;const t=$("toast");t.textContent=msg;t.style.display="block";if(toastTimer)clearTimeout(toastTimer);toastTimer=setTimeout(()=>{t.style.display="none"},900)}
async function copy(text){try{await navigator.clipboard.writeText(text);toast("COPIED")}catch(e){toast("COPY FAILED")}}
function exportState(){ensureCorePresets();return JSON.stringify({STORAGE_KEY,FILE_ID,PAGE_ID,STORAGE_EPOCH,STATE},null,2)}
function importState(text){const parsed=JSON.parse(text);const incoming=(parsed&&parsed.STATE)?parsed.STATE:parsed;STATE=deepFill(incoming);ensureCorePresets();stopLight(true);if(STATE.ui.lightRunning&&!STATE.ui.blackout)startLight(STATE.ui.lightPreset);persist(false)}
function exportFilename(){const sig=stableSig();const stamp=new Date().toISOString().replace(/[:.]/g,"-");return`KETADATA_DIVA9_${sig}_${stamp}.json`}
function downloadJsonFile(filename,text){const blob=new Blob([String(text||"")],{type:"application/json"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=filename||"KETADATA_STATE.json";document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(url),250)}
let lightInterval=null,lightCount=0,lightAuxA=0,lightAuxB=0;
function resetStage(){stage.style.backgroundColor="#000";stage.style.filter="none";lightCount=0;lightAuxA=0;lightAuxB=0}
function stopLight(silent=false){if(lightInterval){clearInterval(lightInterval);lightInterval=null}STATE.ui.lightRunning=false;resetStage();if(!silent)persist(false)}
function startLight(preset){stopLight(true);resetStage();STATE.ui.lightPreset=preset;STATE.ui.lightRunning=true;if(preset===1){lightInterval=setInterval(()=>{const curr=stage.style.backgroundColor||"black";stage.style.backgroundColor=(curr==="black"||curr==="rgb(0, 0, 0)")?"white":"black";stage.style.filter="none"},50)}else if(preset===2){lightInterval=setInterval(()=>{lightAuxA=(lightAuxA+30)%360;lightAuxB+=0.5;const l=50+Math.sin(lightAuxB)*40;stage.style.backgroundColor=`hsl(${lightAuxA},100%,${l}%)`;stage.style.filter="none"},10)}else if(preset===3){lightInterval=setInterval(()=>{lightCount++;const beat=lightCount%16;if(beat===0||beat===1){stage.style.backgroundColor="#fff";stage.style.filter="invert(1) contrast(3) brightness(2)"}else if(beat===2){stage.style.backgroundColor="#000";stage.style.filter="invert(1) contrast(2)"}else if(beat===3){stage.style.backgroundColor="#0f0";stage.style.filter="contrast(2) saturate(3)"}else if(beat===4){stage.style.backgroundColor="#f0f";stage.style.filter="invert(1) hue-rotate(90deg)"}else if(beat===5||beat===6){stage.style.backgroundColor="#0ff";stage.style.filter="invert(0.7) contrast(2)"}else if(beat===7){stage.style.backgroundColor="#fff";stage.style.filter="invert(1) brightness(3)"}else if(beat===8){stage.style.backgroundColor="#000";stage.style.filter="invert(1) contrast(3)"}else if(beat===9||beat===10){stage.style.backgroundColor="#0f0";stage.style.filter="saturate(5) contrast(2)"}else if(beat===11){stage.style.backgroundColor="#f0f";stage.style.filter="invert(1) saturate(3)"}else{stage.style.backgroundColor="#08f";stage.style.filter="contrast(1.5) brightness(1.2)"}},30)}else if(preset===4){lightInterval=setInterval(()=>{lightAuxA+=0.08;lightCount++;const red=Math.abs(Math.sin(lightAuxA))*255;const pulse=Math.abs(Math.sin(lightAuxA*0.5));const contrast=2+pulse*2;const saturation=4+pulse*2;if(lightCount%8===0){stage.style.backgroundColor="#000";stage.style.filter="brightness(3) contrast(3)"}else{stage.style.backgroundColor=`rgb(${red},0,0)`;stage.style.filter=`contrast(${contrast}) saturate(${saturation}) brightness(${1.2+pulse*0.5})`}},20)}else if(preset===5){lightInterval=setInterval(()=>{lightAuxA+=15;lightAuxB=(lightAuxB+2)%100;const hue=260+Math.sin(lightAuxA*0.1)*40;const saturation=80+Math.cos(lightAuxA*0.05)*20;const lightness=30+Math.sin(lightAuxB*0.1)*30;const spiralBrightness=1+Math.abs(Math.sin(lightAuxA*0.05))*0.8;const spiralContrast=1.5+Math.abs(Math.cos(lightAuxA*0.08))*1;stage.style.backgroundColor=`hsl(${hue},${saturation}%,${lightness}%)`;stage.style.filter=`contrast(${spiralContrast}) saturate(2) brightness(${spiralBrightness}) hue-rotate(${lightAuxA*0.5}deg)`},25)}else if(preset===6){lightInterval=setInterval(()=>{lightCount++;if(lightCount%50===0||lightCount%50===2){stage.style.backgroundColor="#fff";stage.style.filter="brightness(5) contrast(5)"}else{stage.style.backgroundColor="#000";stage.style.filter="none"}},30)}persist(false)}
function selectPreset(p){STATE.ui.lightPreset=p;if(STATE.ui.lightRunning)startLight(p);else persist(false)}
function toggleRun(){if(STATE.ui.blackout)return;if(STATE.ui.lightRunning)stopLight(false);else startLight(STATE.ui.lightPreset||1)}
function syncMotion(){if(STATE.ui.motionOn)motion.classList.add("run");else motion.classList.remove("run")}
function upsertRoomPreset(roomName,url){const room=canonRoomName(roomName)||"LINK";const roomUrl=String(url||"").trim();const idx=STATE.payload.roomPresets.findIndex(r=>canonRoomName(r.room)===room);const preset={room,roomUrl,updatedAt:nowISO()};if(idx>=0)STATE.payload.roomPresets[idx]=Object.assign({},STATE.payload.roomPresets[idx],preset);else STATE.payload.roomPresets.unshift(Object.assign({createdAt:nowISO()},preset));ensureCorePresets();return preset}
function deleteRoomPreset(roomName){const room=canonRoomName(roomName);if(!room)return;if(CORE_PRESETS.some(p=>canonRoomName(p.room)===room))return;STATE.payload.roomPresets=STATE.payload.roomPresets.filter(r=>canonRoomName(r.room)!==room);ensurePinnedRooms();STATE.ui.pinnedRooms=STATE.ui.pinnedRooms.filter(x=>x!==room)}
function loadPresetToFields(roomName){const room=canonRoomName(roomName);const preset=getPreset(room);if(!preset)return;$("roomInput").value=preset.room||"";$("roomUrlInput").value=preset.roomUrl||""}
function setActiveRoom(roomName,url){STATE.room=(canonRoomName(roomName)||"BASE").trim();STATE.roomUrl=String(url||"").trim()}
function deriveNameFromUrl(url){try{const u=new URL(url,location.href);const path=(u.pathname||"").split("/").filter(Boolean);const last=path.length?path[path.length-1]:(u.hostname||"LINK");return String(last).replace(/\.(html?|php|aspx|jsp)$/i,"").replace(/[-_]+/g," ").trim().toUpperCase()||"LINK"}catch(e){return String(url||"LINK").trim().slice(0,28).toUpperCase()||"LINK"}}
function parseBulkLines(text){return String(text||"").split(/\r?\n/).map(l=>l.trim()).filter(l=>l&&!l.startsWith("#")).map(l=>{let name="",url="";if(l.includes("|")){const parts=l.split("|");name=(parts[0]||"").trim();url=(parts.slice(1).join("|")||"").trim()}else url=l.trim();if(!url&&name){url=name;name=""}if(!name)name=deriveNameFromUrl(url);return{name,url}}).filter(x=>x.url)}
let ACTIVE_SET_ID="";
function ensureActiveSet(){if(ACTIVE_SET_ID&&getSetById(ACTIVE_SET_ID))return;const first=(STATE.payload.sets||[])[0];ACTIVE_SET_ID=first?String(first.id):""}
function setEditorFromSet(setObj){if(!setObj)return;ACTIVE_SET_ID=String(setObj.id);$("setNameInput").value=canonSetName(setObj.label||"SET")||"SET";const lines=(setObj.items||[]).map(it=>{const n=canonRoomName(it.label||"")||deriveNameFromUrl(it.url);return`${n} | ${String(it.url||"").trim()}`});$("setItemsInput").value=lines.join("\n")}
function createSet(label){const l=canonSetName(label||"SET")||"SET";const id=`SET_${uid8()}`;const obj={id,label:l,items:[],createdAt:nowISO(),updatedAt:nowISO()};STATE.payload.sets.unshift(obj);ACTIVE_SET_ID=id;return obj}
function renameSet(id,newLabel){const s=getSetById(id);if(!s)return;s.label=canonSetName(newLabel||s.label||"SET")||"SET";s.updatedAt=nowISO()}
function deleteSet(id){const sid=String(id||"").trim();if(!sid)return;STATE.payload.sets=(STATE.payload.sets||[]).filter(s=>String(s.id)!==sid);ensurePinnedSets();STATE.ui.pinnedSets=STATE.ui.pinnedSets.filter(x=>x!==sid);if(ACTIVE_SET_ID===sid)ACTIVE_SET_ID=""}
function saveSetItems(id,bulkText){const s=getSetById(id);if(!s)return;const parsed=parseBulkLines(bulkText||"");s.items=parsed.map(x=>({label:canonRoomName(x.name||"")||deriveNameFromUrl(x.url),url:String(x.url||"").trim()}));s.updatedAt=nowISO()}
function setDrawer(on){STATE.ui.drawerOpen=!!on;if(on)STATE.ui.blackout=false;persist(false)}
function setKetaNote(on){STATE.ui.noteOpen=!!on;if(on){STATE.ui.blackout=false;if(STATE.ui.noteRect&&typeof STATE.ui.noteRect==="object"){STATE.ui.noteRect.x=null}}persist(false)}
function setUniversalsCollapsed(on){STATE.ui.universalsCollapsed=!!on;persist(false)}
function setRegistryCollapsed(on){STATE.ui.registryCollapsed=!!on;persist(false)}
function setActiveCollapsed(on){STATE.ui.activeCollapsed=!!on;persist(false)}
function setSetsCollapsed(on){STATE.ui.setsCollapsed=!!on;persist(false)}
function setBulkCollapsed(on){STATE.ui.bulkCollapsed=!!on;persist(false)}
function setPresetsCollapsed(on){STATE.ui.presetsCollapsed=!!on;persist(false)}
function setInvert(on){STATE.ui.invert=!!on;persist(false)}
let BLACKOUT_CACHE=null;
function setBlackout(on){const next=!!on;if(next&&!STATE.ui.blackout){BLACKOUT_CACHE={drawerOpen:!!STATE.ui.drawerOpen,noteOpen:!!STATE.ui.noteOpen,motionOn:!!STATE.ui.motionOn,lightRunning:!!STATE.ui.lightRunning,lightPreset:Number(STATE.ui.lightPreset||1)}}STATE.ui.blackout=next;if(STATE.ui.blackout){STATE.ui.motionOn=false;stopLight(true);resetStage();motion.classList.remove("run");STATE.ui.drawerOpen=false;STATE.ui.noteOpen=false}else{if(BLACKOUT_CACHE){STATE.ui.drawerOpen=!!BLACKOUT_CACHE.drawerOpen;STATE.ui.noteOpen=!!BLACKOUT_CACHE.noteOpen;STATE.ui.motionOn=!!BLACKOUT_CACHE.motionOn;const wasRunning=!!BLACKOUT_CACHE.lightRunning;const wasPreset=Number(BLACKOUT_CACHE.lightPreset||1);STATE.ui.lightPreset=wasPreset;if(wasRunning)startLight(wasPreset);BLACKOUT_CACHE=null}}persist(false)}
function toggleBlackout(){setBlackout(!STATE.ui.blackout)}
function setFullscreen(on){STATE.ui.fullscreen=!!on;persist(false)}
function toggleFullscreen(){setFullscreen(!STATE.ui.fullscreen)}
function finalizeBeforeNav(){flush()}
function go(url){const u=String(url||"").trim();if(!u)return;finalizeBeforeNav();window.location.href=u}
function openNewTab(url){const u=String(url||"").trim();if(!u)return;finalizeBeforeNav();window.open(u,"_blank","noopener,noreferrer")}
function bindHotkeys(){window.addEventListener("keydown",ev=>{if(ev.repeat)return;const ae=document.activeElement;const typing=ae&&(ae.tagName==="TEXTAREA"||ae.tagName==="INPUT");if(ev.code==="Space"){if(!typing){ev.preventDefault();toggleRun();toast(STATE.ui.lightRunning?"RUN ON":"RUN OFF")}return}if(ev.shiftKey&&(ev.key==="I"||ev.key==="i")){if(typing)return;ev.preventDefault();setInvert(!STATE.ui.invert);return}if(ev.shiftKey&&(ev.key==="N"||ev.key==="n")){if(typing)return;ev.preventDefault();toggleBlackout();return}if(ev.shiftKey&&(ev.key==="F"||ev.key==="f")){if(typing)return;ev.preventDefault();toggleFullscreen();return}if(ev.shiftKey&&(ev.key==="K"||ev.key==="k")){if(typing)return;ev.preventDefault();go(URLS.LANDING);return}if(ev.shiftKey&&(ev.key==="X"||ev.key==="x")){if(typing)return;ev.preventDefault();go(URLS.PHOTOBOOTH);return}if(ev.shiftKey&&(ev.key==="Z"||ev.key==="z")){if(typing)return;ev.preventDefault();go(URLS.KDTV);return}if(ev.shiftKey&&(ev.key==="V"||ev.key==="v")){if(typing)return;ev.preventDefault();go(URLS.POD);return}if(ev.shiftKey&&(ev.key==="W"||ev.key==="w")){if(typing)return;ev.preventDefault();go(URLS.WORLD);return}if(ev.shiftKey&&(ev.key==="P"||ev.key==="p")){if(typing)return;ev.preventDefault();go(URLS.INFINITY);return}if(!typing&&!ev.shiftKey&&!ev.altKey&&!ev.metaKey&&!ev.ctrlKey){const n=Number(ev.key);if(n>=1&&n<=6){ev.preventDefault();selectPreset(n);toast(`LIGHT ${n}`)}}},{passive:false})}
function renderRoomList(){const el=$("roomList");el.innerHTML="";const order=["CALENDAR","POD","WORLD","KDTV","PHOTOBOOTH","STUDIO","LAB"];const by=new Map((STATE.payload.roomPresets||[]).map(p=>[canonRoomName(p.room),p]));const coreOrdered=order.map(k=>by.get(k)).filter(Boolean);const others=(STATE.payload.roomPresets||[]).filter(p=>!order.includes(canonRoomName(p.room))).slice().sort((a,b)=>Date.parse(b.updatedAt||b.createdAt||0)-Date.parse(a.updatedAt||a.createdAt||0));const presets=[...coreOrdered,...others];presets.forEach(p=>{const row=document.createElement("div");row.style.display="flex";row.style.gap="8px";row.style.alignItems="center";row.style.border="1px solid var(--line2)";row.style.padding="8px 10px";row.style.fontFamily="var(--mono)";row.style.fontSize="11px";row.style.letterSpacing=".06em";row.style.textTransform="uppercase";row.style.cursor="pointer";const left=document.createElement("div");left.style.flex="1";left.textContent=p.room||"—";const right=document.createElement("div");right.style.color="var(--muted)";right.textContent=(p.roomUrl||"—").replace(/^https?:\/\//,"");const pin=document.createElement("button");pin.className="btn";pin.style.padding="4px 8px";pin.style.fontSize="11px";pin.textContent=isPinned(p.room)?"UNPIN":"PIN";pin.addEventListener("click",ev=>{ev.stopPropagation();togglePin(p.room);toast(isPinned(p.room)?"PINNED":"UNPINNED");persist()});row.addEventListener("click",()=>{loadPresetToFields(p.room);setActiveRoom(p.room,p.roomUrl);toast("ARMED");persist()});if(canonRoomName(STATE.room)===canonRoomName(p.room))row.style.borderColor="var(--fg)";row.appendChild(left);row.appendChild(right);row.appendChild(pin);el.appendChild(row)})}
function renderSetList(){const el=$("setList");if(!el)return;el.innerHTML="";const sets=(STATE.payload.sets||[]).slice().sort((a,b)=>{const ta=Date.parse(a.updatedAt||a.createdAt||0);const tb=Date.parse(b.updatedAt||b.createdAt||0);return tb-ta});sets.forEach(s=>{const row=document.createElement("div");row.style.display="flex";row.style.gap="8px";row.style.alignItems="center";row.style.border="1px solid var(--line2)";row.style.padding="8px 10px";row.style.fontFamily="var(--mono)";row.style.fontSize="11px";row.style.letterSpacing=".06em";row.style.textTransform="uppercase";row.style.cursor="pointer";const left=document.createElement("div");left.style.flex="1";left.textContent=canonSetName(s.label||"SET");const mid=document.createElement("div");mid.style.color="var(--muted)";mid.textContent=`${(s.items||[]).length} ITEMS`;const pin=document.createElement("button");pin.className="btn";pin.style.padding="4px 8px";pin.style.fontSize="11px";pin.textContent=isSetPinned(s.id)?"UNPIN":"PIN";pin.addEventListener("click",ev=>{ev.stopPropagation();togglePinSet(s.id);toast(isSetPinned(s.id)?"SET PINNED":"SET UNPINNED");persist()});row.addEventListener("click",()=>{setEditorFromSet(s);toast("SET LOADED");persist()});if(String(ACTIVE_SET_ID||"")===String(s.id||""))row.style.borderColor="var(--fg)";row.appendChild(left);row.appendChild(mid);row.appendChild(pin);el.appendChild(row);if((s.items||[]).length){const list=document.createElement("div");list.style.display="flex";list.style.flexWrap="wrap";list.style.gap="6px";list.style.marginTop="6px";(s.items||[]).forEach(it=>{const b=document.createElement("button");b.className="btn";b.style.padding="4px 8px";b.style.fontSize="11px";b.textContent=canonRoomName(it.label||"")||deriveNameFromUrl(it.url);b.addEventListener("click",ev=>{ev.stopPropagation();setActiveRoom(b.textContent,it.url);toast("ARMED");persist()});list.appendChild(b)});el.appendChild(list)}})}
function renderPinnedPanel(){const el=$("pinnedPanel");ensurePinnedRooms();ensurePinnedSets();if(STATE.ui.blackout||STATE.ui.fullscreen){el.style.display="none";el.innerHTML="";return}const hasPins=(STATE.ui.pinnedRooms.length>0)||(STATE.ui.pinnedSets.length>0);if(!hasPins){el.style.display="none";el.innerHTML="";return}el.style.display="flex";el.innerHTML="";const byPreset=new Map((STATE.payload.roomPresets||[]).map(p=>[canonRoomName(p.room),p]));STATE.ui.pinnedRooms.forEach(name=>{const p=byPreset.get(name);if(!p)return;const chip=document.createElement("button");chip.className="btn";chip.textContent=name;chip.draggable=true;chip.addEventListener("dragstart",ev=>{try{ev.dataTransfer.setData("text/plain",name);ev.dataTransfer.effectAllowed="move"}catch(e){}});chip.addEventListener("dragover",ev=>ev.preventDefault());chip.addEventListener("drop",ev=>{ev.preventDefault();const from=(ev.dataTransfer&&ev.dataTransfer.getData("text/plain"))||"";const to=name;if(!from||from===to)return;const a=STATE.ui.pinnedRooms;const fi=a.indexOf(from),ti=a.indexOf(to);if(fi<0||ti<0)return;a.splice(ti,0,a.splice(fi,1)[0]);toast("PIN ORDER SET");persist()});chip.addEventListener("click",()=>{setActiveRoom(p.room,p.roomUrl);toast("ARMED");persist()});if(canonRoomName(STATE.room)===name)chip.style.borderColor="var(--fg)";el.appendChild(chip)});STATE.ui.pinnedSets.forEach(setId=>{const s=getSetById(setId);if(!s)return;const idStr=String(s.id||setId);const name=canonSetName(s.name||s.label||s.id||"SET");const chip=document.createElement("button");chip.className="btn";chip.textContent=name;chip.draggable=true;chip.addEventListener("dragstart",ev=>{try{ev.dataTransfer.setData("text/plain","SET:"+idStr);ev.dataTransfer.effectAllowed="move"}catch(e){}});chip.addEventListener("dragover",ev=>ev.preventDefault());chip.addEventListener("drop",ev=>{ev.preventDefault();const raw=(ev.dataTransfer&&ev.dataTransfer.getData("text/plain"))||"";if(!raw.startsWith("SET:"))return;const from=raw.slice(4);const to=idStr;if(!from||from===to)return;const a=STATE.ui.pinnedSets.map(String);const fi=a.indexOf(String(from)),ti=a.indexOf(String(to));if(fi<0||ti<0)return;a.splice(ti,0,a.splice(fi,1)[0]);STATE.ui.pinnedSets=a;toast("PIN ORDER SET");persist();render()});chip.addEventListener("click",()=>{ensureActiveSets();if(!STATE.ui.activeSets.map(String).includes(idStr)){STATE.ui.activeSets.unshift(idStr)}STATE.ui.activeSetId=idStr;STATE.ui.padOpen=true;openPadFromAnchor(chip);toast("SET");persist();render()});if(String(STATE.ui.activeSetId||"")===idStr)chip.style.borderColor="var(--fg)";el.appendChild(chip)})}
function renderArmedBar(){const bar=$("armedBar");if(STATE.ui.blackout||STATE.ui.fullscreen){bar.style.display="none";return}bar.style.display="flex";const name=canonRoomName(STATE.room)||"—";const url=String(STATE.roomUrl||"").trim()||"—";$("armedName").textContent=name;$("armedUrl").value=url}
function normalizeSetToPad16(setObj){if(!setObj)return;if(!Array.isArray(setObj.items))setObj.items=[];for(let i=setObj.items.length;i<16;i++){setObj.items.push({label:"",url:""})}if(setObj.items.length>16)setObj.items=setObj.items.slice(0,16)}
function renderActiveStrip(){const el=$("activeStrip");ensureActiveSets();if(STATE.ui.blackout||STATE.ui.fullscreen){el.style.display="none";el.innerHTML="";return}if(!STATE.ui.activeSets.length){el.style.display="none";el.innerHTML="";return}el.style.display="flex";el.innerHTML="";const lab=document.createElement("span");lab.className="label";lab.textContent="ACTIVE";el.appendChild(lab);STATE.ui.activeSets.forEach(id=>{const s=getSetById(id);if(!s)return;const chip=document.createElement("button");chip.className="btn";chip.textContent=String(s.name||s.id||"SET");chip.style.padding="4px 8px";chip.style.fontSize="11px";if(String(STATE.ui.activeSetId||"")===String(id))chip.style.borderColor="var(--fg)";chip.addEventListener("click",ev=>{ev.preventDefault();STATE.ui.activeSetId=String(id);STATE.ui.padOpen=true;openPadFromAnchor(chip);toast("PAD OPEN");persist();render()});el.appendChild(chip)});const padBtn=document.createElement("button");padBtn.className="btn";padBtn.textContent=STATE.ui.padOpen?"PAD ON":"PAD";padBtn.style.padding="4px 8px";padBtn.style.fontSize="11px";padBtn.addEventListener("click",()=>{STATE.ui.padOpen=!STATE.ui.padOpen;toast(STATE.ui.padOpen?"PAD OPEN":"PAD CLOSED");persist()});el.appendChild(padBtn)}
function upsertPadSlot(setId,idx,label,url){const s=getSetById(setId);if(!s)return;normalizeSetToPad16(s);s.items[idx]={label:String(label||""),url:String(url||"")}}
function renderPad(){const panel=$("padPanel"),grid=$("padGrid"),title=$("padTitle"),hint=$("padHint"),sid=$("padSetId");ensureActiveSets();const activeId=String(STATE.ui.activeSetId||"");const s=getSetById(activeId);if(STATE.ui.blackout||!STATE.ui.padOpen||!s){panel.classList.remove("open");panel.style.display="none";grid.innerHTML="";return}normalizeSetToPad16(s);panel.classList.add("open");panel.style.display="";title.textContent=String(s.name||"PAD");sid.textContent=String(s.id||"—");hint.textContent=STATE.ui.padEdit?"EDIT MODE":"CLICK = ARM";grid.innerHTML="";for(let i=0;i<16;i++){const it=s.items[i]||{label:"",url:""};const cell=document.createElement("div");cell.className="padCell";if(STATE.ui.padEdit){const nm=document.createElement("input");nm.value=String(it.label||"");nm.placeholder="NAME";nm.addEventListener("input",()=>{upsertPadSlot(activeId,i,nm.value,(s.items[i]&&s.items[i].url)||"");persist(true)});const ur=document.createElement("input");ur.value=String(it.url||"");ur.placeholder="URL";ur.addEventListener("input",()=>{upsertPadSlot(activeId,i,(s.items[i]&&s.items[i].label)||"",ur.value);persist(true)});ur.addEventListener("keydown",ev=>{if(ev.key==="Enter"){ev.preventDefault();persist(false)}});cell.appendChild(nm);cell.appendChild(ur)}else{const nm=document.createElement("div");nm.className="nm";nm.textContent=canonRoomName(it.label||"")||(it.url?deriveNameFromUrl(it.url):"—");cell.appendChild(nm);const a=document.createElement("a");a.href=String(it.url||"#");a.textContent=it.url?it.url:"—";a.target="_blank";a.rel="noopener";a.addEventListener("click",ev=>{ev.preventDefault();if(!it.url)return;setActiveRoom(nm.textContent,it.url);toast("ARMED");persist()});cell.appendChild(a)}grid.appendChild(cell)}}
function openPadFromAnchor(anchorEl){try{if(!anchorEl)return;const r=anchorEl.getBoundingClientRect();if(!STATE.ui.padRect)STATE.ui.padRect={x:null,y:null,w:360,h:360};const margin=8;const targetX=Math.round(r.left);const targetY=Math.round(r.bottom+margin);STATE.ui.padRect.x=Math.max(6,Math.min(targetX,window.innerWidth-60));STATE.ui.padRect.y=Math.max(6,Math.min(targetY,window.innerHeight-60));STATE.ui.padOpen=true;const panel=$("padPanel");if(panel){panel.classList.add("open");panel.style.display=""}if(typeof renderPad==="function")renderPad()}catch(_){}}
function render(){root.classList.toggle("invert",!!STATE.ui.invert);root.classList.toggle("blackout",!!STATE.ui.blackout);root.classList.toggle("fs",!!STATE.ui.fullscreen);syncMotion();$("drawer").classList.toggle("open",!!STATE.ui.drawerOpen&&!STATE.ui.blackout&&!STATE.ui.fullscreen);$("ketaNote").classList.toggle("open",!!STATE.ui.noteOpen&&!STATE.ui.blackout);$("ketaIcon").classList.toggle("open",!!STATE.ui.noteOpen&&!STATE.ui.blackout);$("ketaText").value=STATE.ketaNote||"";$("universals").value=STATE.universals||"";$("roomName").textContent=canonRoomName(STATE.room)||"BASE";$("universals").style.display=STATE.ui.universalsCollapsed?"none":"block";$("registryBody").style.display=STATE.ui.registryCollapsed?"none":"block";$("activeBody").style.display=STATE.ui.activeCollapsed?"none":"block";$("setsBody").style.display=STATE.ui.setsCollapsed?"none":"block";$("bulkBody").style.display=STATE.ui.bulkCollapsed?"none":"block";$("presetsBody").style.display=STATE.ui.presetsCollapsed?"none":"block";if($("activeRoomBox"))$("activeRoomBox").value=canonRoomName(STATE.room)||"BASE";if($("activeUrlBox"))$("activeUrlBox").value=String(STATE.roomUrl||"");const s=stableSig();$("sig").textContent=s;$("sig2").textContent=s;$("fsLabel").textContent=STATE.ui.fullscreen?"ON":"OFF";$("blkLabel").textContent=STATE.ui.blackout?"ON":"OFF";$("lightLabel").textContent=String(STATE.ui.lightPreset||1);$("runLabel").textContent=STATE.ui.lightRunning?"ON":"OFF";$("motionLabel").textContent=STATE.ui.motionOn?"ON":"OFF";if(STATE.ui.noteRect){const r=STATE.ui.noteRect;const box=$("ketaNote");if(r.x===null||typeof r.x==="undefined"){box.style.left="auto";box.style.right="16px";box.style.top=(Number(r.y)||76)+"px";box.style.width=(Number(r.w)||340)+"px";box.style.height=(Number(r.h)||220)+"px"}else{box.style.left=(Number(r.x)||16)+"px";box.style.top=(Number(r.y)||76)+"px";box.style.width=(Number(r.w)||340)+"px";box.style.height=(Number(r.h)||220)+"px";box.style.right="auto"}}ensureActiveSet();renderRoomList();renderSetList();renderArmedBar();renderPinnedPanel();renderActiveStrip();const __pad=$("padPanel");if(__pad){__pad.classList.toggle("open",!!STATE.ui.padOpen&&!STATE.ui.blackout)}renderPad()}
$("btnExport").addEventListener("click",()=>{const js=exportState();downloadJsonFile(exportFilename(),js);if(typeof toast==="function")toast("DOWNLOADED JSON")});
$("btnCopy").addEventListener("click",()=>copy(exportState()));
$("btnImport").addEventListener("click",()=>$("file").click());
$("file").addEventListener("change",async ev=>{const f=ev.target.files&&ev.target.files[0];if(!f)return;const text=await f.text();importState(text);ev.target.value=""});
$("btnCopyUniversals").addEventListener("click",()=>copy($("universals").value||""));
$("btnCloseDrawer").addEventListener("click",()=>setDrawer(false));
$("btnToggleMotion").addEventListener("click",()=>{STATE.ui.motionOn=!STATE.ui.motionOn;toast(STATE.ui.motionOn?"MOTION ON":"MOTION OFF");persist()});
$("padCloseBtn").addEventListener("click",()=>{STATE.ui.padOpen=false;toast("PAD CLOSED");persist()});
$("padEditBtn").addEventListener("click",()=>{STATE.ui.padEdit=!STATE.ui.padEdit;toast(STATE.ui.padEdit?"PAD EDIT":"PAD VIEW");persist();render()});
$("btnToggleUniversals").addEventListener("click",()=>{setUniversalsCollapsed(!STATE.ui.universalsCollapsed);toast(STATE.ui.universalsCollapsed?"UNIVERSALS CLOSED":"UNIVERSALS OPEN")});
$("btnToggleRegistry").addEventListener("click",()=>{setRegistryCollapsed(!STATE.ui.registryCollapsed);toast(STATE.ui.registryCollapsed?"REGISTRY CLOSED":"REGISTRY OPEN")});
$("btnToggleActive").addEventListener("click",()=>{setActiveCollapsed(!STATE.ui.activeCollapsed);toast(STATE.ui.activeCollapsed?"ACTIVE CLOSED":"ACTIVE OPEN")});
$("btnToggleSets").addEventListener("click",()=>{setSetsCollapsed(!STATE.ui.setsCollapsed);toast(STATE.ui.setsCollapsed?"SETS CLOSED":"SETS OPEN")});
$("btnToggleBulk").addEventListener("click",()=>{setBulkCollapsed(!STATE.ui.bulkCollapsed);toast(STATE.ui.bulkCollapsed?"BULK CLOSED":"BULK OPEN")});
$("btnTogglePresets").addEventListener("click",()=>{setPresetsCollapsed(!STATE.ui.presetsCollapsed);toast(STATE.ui.presetsCollapsed?"PRESETS CLOSED":"PRESETS OPEN")});
$("toggleDrawer").addEventListener("click",()=>{if(STATE.ui.blackout||STATE.ui.fullscreen)return;setDrawer(!STATE.ui.drawerOpen)});
$("toggleRun").addEventListener("click",()=>toggleRun());
$("universals").addEventListener("input",()=>{STATE.universals=$("universals").value||"";persist()});
$("ketaText").addEventListener("input",()=>{STATE.ketaNote=$("ketaText").value||"";persist()});
$("ketaIcon").addEventListener("click",()=>{if(STATE.ui.blackout)return;setKetaNote(!STATE.ui.noteOpen)});
$("btnHideNote").addEventListener("click",()=>setKetaNote(false));
$("btnSaveRoom").addEventListener("click",()=>{upsertRoomPreset($("roomInput").value||"LINK",$("roomUrlInput").value||"");toast("SAVED");persist()});
$("btnSetActiveRoom").addEventListener("click",()=>{const r=$("roomInput").value||"BASE";const u=$("roomUrlInput").value||"";upsertRoomPreset(r,u);setActiveRoom(r,u);toast("ACTIVE SET");persist()});
$("btnDeleteRoom").addEventListener("click",()=>{const r=$("roomInput").value||"";if(!r.trim()){toast("NO ROOM");return}deleteRoomPreset(r);toast("DELETED");persist()});
$("btnTogglePins").addEventListener("click",()=>{toast("PINS = VISIBLE WHEN PINNED")});
$("btnGoActive").addEventListener("click",()=>{if(STATE.roomUrl)go(STATE.roomUrl);else toast("NO ACTIVE URL")});
$("btnNewTabActive").addEventListener("click",()=>{if(STATE.roomUrl)openNewTab(STATE.roomUrl);else toast("NO ACTIVE URL")});
$("btnCopyActiveUrl").addEventListener("click",()=>{copy(String(STATE.roomUrl||""))});
$("armedGo").addEventListener("click",()=>{if(STATE.roomUrl)go(STATE.roomUrl);else toast("NO ACTIVE URL")});
$("armedNewTab").addEventListener("click",()=>{if(STATE.roomUrl)openNewTab(STATE.roomUrl);else toast("NO ACTIVE URL")});
$("armedCopy").addEventListener("click",()=>{copy(String(STATE.roomUrl||""))});
$("btnCreateSet").addEventListener("click",()=>{const s=createSet($("setNameInput").value||"SET");setEditorFromSet(s);toast("SET CREATED");persist()});
$("btnRenameSet").addEventListener("click",()=>{if(!ACTIVE_SET_ID){toast("NO SET");return}renameSet(ACTIVE_SET_ID,$("setNameInput").value||"SET");toast("SET RENAMED");persist()});
$("btnDeleteSet").addEventListener("click",()=>{if(!ACTIVE_SET_ID){toast("NO SET");return}deleteSet(ACTIVE_SET_ID);$("setNameInput").value="";$("setItemsInput").value="";ACTIVE_SET_ID="";toast("SET DELETED");persist()});
$("btnPinSet").addEventListener("click",()=>{if(!ACTIVE_SET_ID){toast("NO SET");return}togglePinSet(ACTIVE_SET_ID);toast(isSetPinned(ACTIVE_SET_ID)?"SET PINNED":"SET UNPINNED");persist()});
$("btnSaveSetItems").addEventListener("click",()=>{if(!ACTIVE_SET_ID){toast("NO SET");return}saveSetItems(ACTIVE_SET_ID,$("setItemsInput").value||"");toast("ITEMS SAVED");persist()});
$("btnClearSetItems").addEventListener("click",()=>{$("setItemsInput").value="";toast("CLEARED")});
$("btnBulkAdd").addEventListener("click",()=>{const items=parseBulkLines($("bulkRoomInput").value||"");if(!items.length){toast("NO BULK");return}items.forEach(({name,url})=>upsertRoomPreset(name,url));toast(`BULK ${items.length}`);persist()});
$("btnBulkClear").addEventListener("click",()=>{$("bulkRoomInput").value="";toast("CLEARED")});
["roomInput","roomUrlInput","bulkRoomInput","setNameInput","setItemsInput"].forEach(id=>{const el=$(id);if(!el)return;el.addEventListener("focus",()=>{try{el.select&&el.select()}catch(e){}})});
(function bindDrawerSizer(){const s=$("drawerSizer");let dragging=false;function clamp(v,min,max){return Math.max(min,Math.min(max,v))}s.addEventListener("mousedown",ev=>{if(!STATE.ui.drawerOpen)return;dragging=true;ev.preventDefault()});window.addEventListener("mousemove",ev=>{if(!dragging)return;const usable=window.innerHeight-44-34;const bottomBound=window.innerHeight-34;const desiredHeight=clamp(bottomBound-ev.clientY,usable*0.18,usable*0.92);const ratio=desiredHeight/usable;STATE.ui.drawerH=Number(ratio.toFixed(3));root.style.setProperty("--drawer-h",String(STATE.ui.drawerH));render()});window.addEventListener("mouseup",()=>{if(!dragging)return;dragging=false;persist()})})();
(function noteGeometry(){const box=$("ketaNote");const head=$("ketaHead");let dragging=false,ox=0,oy=0;function clamp(n,min,max){return Math.max(min,Math.min(max,n))}function saveRect(){const r=box.getBoundingClientRect();STATE.ui.noteRect={x:Math.round(r.left),y:Math.round(r.top),w:Math.round(r.width),h:Math.round(r.height)};persist()}head.addEventListener("mousedown",ev=>{if(ev.target.closest("button"))return;if(STATE.ui.blackout)return;dragging=true;const r=box.getBoundingClientRect();ox=ev.clientX-r.left;oy=ev.clientY-r.top;box.style.left=r.left+"px";box.style.top=r.top+"px";box.style.right="auto"});window.addEventListener("mousemove",ev=>{if(!dragging)return;box.style.left=clamp(ev.clientX-ox,0,window.innerWidth-40)+"px";box.style.top=clamp(ev.clientY-oy,44,window.innerHeight-40)+"px"});window.addEventListener("mouseup",()=>{if(!dragging)return;dragging=false;saveRect()});try{const ro=new ResizeObserver(()=>{if(dragging)return;if(STATE.ui.blackout)return;saveRect()});ro.observe(box)}catch(_){}})();
(function padGeometry(){const panel=$("padPanel");const head=$("padHead");function apply(){const r=STATE.ui.padRect||{};if(r.w)panel.style.width=r.w+"px";if(r.h)panel.style.height=r.h+"px";const px=(r.x==null)?14:r.x;const py=(r.y==null)?(parseInt(getComputedStyle(document.documentElement).getPropertyValue("--top")||"0",10)+170):r.y;panel.style.left=Math.max(6,Math.min(px,window.innerWidth-60))+"px";panel.style.top=Math.max(6,Math.min(py,window.innerHeight-60))+"px"}function snap(){const rect=panel.getBoundingClientRect();STATE.ui.padRect={x:Math.round(rect.left),y:Math.round(rect.top),w:Math.round(rect.width),h:Math.round(rect.height)};persist()}let dragging=false,sx=0,sy=0,ox=0,oy=0;head.addEventListener("mousedown",ev=>{if(ev.button!==0)return;if(STATE.ui.blackout||STATE.ui.fullscreen)return;dragging=true;sx=ev.clientX;sy=ev.clientY;const rect=panel.getBoundingClientRect();ox=rect.left;oy=rect.top;document.body.style.userSelect="none"});window.addEventListener("mousemove",ev=>{if(!dragging)return;const nx=ox+(ev.clientX-sx);const ny=oy+(ev.clientY-sy);panel.style.left=Math.max(6,Math.min(nx,window.innerWidth-60))+"px";panel.style.top=Math.max(6,Math.min(ny,window.innerHeight-60))+"px"});window.addEventListener("mouseup",()=>{if(!dragging)return;dragging=false;document.body.style.userSelect="";snap()});try{const ro=new ResizeObserver(()=>{if(dragging)return;if(STATE.ui.blackout||STATE.ui.fullscreen)return;snap()});ro.observe(panel)}catch(_){}window.addEventListener("resize",apply);panel.addEventListener("mouseup",()=>{if(panel.classList.contains("open"))snap()});apply()})();
window.addEventListener("storage",e=>{if(e.key!==STORAGE_KEY)return;try{const incoming=JSON.parse(e.newValue||"null");if(!incoming)return;STATE=deepFill(incoming);ensureCorePresets();render()}catch(_){}});
window.addEventListener("pageshow",()=>{const stored=loadLocal();if(stored){STATE=deepFill(stored);ensureCorePresets();render()}});
ensureCorePresets();root.style.setProperty("--drawer-h",String(STATE.ui.drawerH));bindHotkeys();render();if(STATE.ui.lightRunning&&!STATE.ui.blackout)startLight(STATE.ui.lightPreset||1);
</script>

<!--
EE: SOVEREIGNTY FIX — SINGLE STORAGE KEY: "KDT::BASE::SOVEREIGN::STATE::FIXED"
EE: PERSIST LOCK PREVENTS CONCURRENT WRITES
EE: LIFECYCLE FLUSH (pagehide/beforeunload/visibilitychange) GUARANTEED
EE: DEEP-FILL ENSURES STATE SHAPE ALWAYS VALID
WB: NO UI CHANGES, PERSISTENCE ONLY
FILE_ID: KETADATA_DIVA9
ROOM_ID: BASE
VERSION: SOVEREIGN_FIX_v1
UPDATED_AT: 2025-12-31T00:00:00Z
CHANGELOG:
- EE: FIXED STORAGE KEY TO SINGLE CONSTANT (NO SCOPING)
- EE: ADDED PERSIST LOCK TO PREVENT RACE CONDITIONS
- EE: SIMPLIFIED DEEP-FILL (JSON PARSE/STRINGIFY FOR CLONING)
- EE: LIFECYCLE FLUSH USES DEDICATED flush() FUNCTION
- WB: REMOVED ALL MIGRATION LOGIC (CLEAN START)
-->
</body>
</html>
