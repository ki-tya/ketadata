<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>KETADATA // FORGE (INDUSTRIAL v1.2)</title>
<style>
:root{
  --bg:#000;
  --fg:#fff;
  --muted:rgba(255,255,255,.58);
  --line:rgba(255,255,255,.14);
  --line2:rgba(255,255,255,.22);
  --panel:rgba(255,255,255,.03);
  --panel2:rgba(255,255,255,.06);
  --ui: Arial, Helvetica, sans-serif;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  --h:44px;
  --pad:12px;
  --gap:10px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);overflow:hidden}
body{font-family:var(--ui)}
/* GRID OVERLAY — MUST NOT BLOCK INPUT */
body::before{
  content:"";
  position:fixed; inset:0;
  background:
    linear-gradient(rgba(255,255,255,.09) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,.09) 1px, transparent 1px);
  background-size:36px 36px;
  opacity:.26;
  pointer-events:none;
  z-index:0;
}
body::after{
  content:"";
  position:fixed; inset:0;
  background:radial-gradient(1200px 700px at 50% -10%, rgba(255,255,255,.06), transparent 60%);
  pointer-events:none;
  z-index:0;
}
.top{
  position:relative;
  z-index:5;
  height:var(--h);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  border-bottom:1px solid var(--line);
  background:#000;
}
.brand{
  font-weight:900;
  font-size:11px;
  letter-spacing:.22em;
  text-transform:uppercase;
  user-select:none;
}
.status{
  display:flex; gap:10px; align-items:center;
  font-family:var(--mono);
  font-size:10px;
  color:var(--muted);
}
.pill{
  border:1px solid var(--line);
  padding:4px 8px;
  font-family:var(--ui);
  font-size:9px;
  text-transform:uppercase;
  letter-spacing:.14em;
  color:var(--muted);
}
.pill strong{color:#fff;font-weight:900}
.actions{display:flex;align-items:center;gap:10px}
.btn{
  border:1px solid var(--line);
  background:transparent;
  color:#fff;
  font-size:10px;
  letter-spacing:.18em;
  text-transform:uppercase;
  padding:6px 10px;
  cursor:pointer;
  user-select:none;
}
.btn:hover{border-color:#fff}
.btn:disabled{opacity:.35;cursor:not-allowed}
.noteIcon{
  width:14px;height:14px;
  border:1px solid #fff;
  background:#fff;
  cursor:pointer;
}
.noteIcon.open{background:transparent}

.main{
  position:relative;
  z-index:2;
  height:calc(100% - var(--h));
  display:grid;
  grid-template-columns: 320px 1fr 460px;
}
.rail{
  min-width:0;
  border-right:1px solid var(--line);
  display:flex;
  flex-direction:column;
}
.rail:last-child{border-right:none}
.railHead{
  padding:var(--pad);
  border-bottom:1px solid var(--line);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.railTitle{
  font-size:10px;
  letter-spacing:.18em;
  text-transform:uppercase;
  font-weight:900;
}
.railBody{
  padding:var(--pad);
  overflow:auto;
  display:flex;
  flex-direction:column;
  gap:var(--gap);
}

label{
  font-size:10px;
  letter-spacing:.14em;
  text-transform:uppercase;
  color:var(--muted);
}
input,textarea,select{
  width:100%;
  background:transparent;
  color:#fff;
  border:1px solid var(--line);
  padding:8px;
  font-family:var(--mono);
  font-size:11px;
  outline:none;
}
textarea{resize:vertical;min-height:86px}
.row{display:flex;gap:10px}
.row > *{flex:1}

.card{
  border:1px solid var(--line);
  background:var(--panel);
}
.cardPad{padding:12px}
.cardTitle{
  margin:0 0 10px 0;
  font-size:10px;
  letter-spacing:.18em;
  text-transform:uppercase;
  font-weight:900;
}
.small{font-family:var(--mono);font-size:10px;color:var(--muted);line-height:1.5}
.hr{height:1px;background:var(--line);margin:10px 0}

.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{
  border:1px solid var(--line);
  padding:6px 10px;
  font-size:10px;
  letter-spacing:.18em;
  text-transform:uppercase;
  cursor:pointer;
  user-select:none;
}
.tab.active{background:rgba(255,255,255,.08)}
.tab:hover{border-color:#fff}

.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.chk{
  border:1px solid var(--line);
  background:rgba(255,255,255,.01);
  padding:10px;
  display:flex;
  gap:10px;
  cursor:pointer;
  user-select:none;
}
.chk:hover{border-color:rgba(255,255,255,.26)}
.chk input{margin-top:2px}
.chk .meta{min-width:0}
.chk .name{
  font-size:10px;letter-spacing:.16em;text-transform:uppercase;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis
}
.chk .desc{font-family:var(--mono);font-size:10px;color:var(--muted);line-height:1.35}

.warn{
  border:1px solid var(--line2);
  background:var(--panel2);
  padding:10px;
  font-family:var(--mono);
  font-size:10px;
  color:var(--muted);
  line-height:1.5;
}
.warn strong{color:#fff}
.outputBox{
  border:1px solid var(--line);
  background:rgba(255,255,255,.02);
  padding:10px;
  font-family:var(--mono);
  font-size:11px;
  white-space:pre-wrap;
  line-height:1.45;
  min-height:260px;
}
.kbd{font-family:var(--mono);font-size:10px;color:var(--muted)}
.footerBtns{display:flex;gap:10px;flex-wrap:wrap}

.note{
  position:fixed;
  top:110px; right:120px;
  width:360px; height:360px;
  border:1px solid #fff;
  background:#000;
  display:none;
  z-index:50;
}
.note.open{display:block}
.noteHead{
  padding:8px;
  border-bottom:1px solid var(--line);
  font-size:10px;
  letter-spacing:.18em;
  text-transform:uppercase;
  cursor:move;
  user-select:none;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.noteClose{
  border:1px solid var(--line);
  width:18px;height:18px;
  display:flex;align-items:center;justify-content:center;
  font-family:var(--mono);
  cursor:pointer;
}
.noteClose:hover{border-color:#fff}
.noteBody{height:calc(100% - 34px)}
.noteBody textarea{
  height:100%;
  border:none;
  outline:none;
  resize:none;
}

.toast{
  position:fixed;
  bottom:14px;
  left:14px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.85);
  padding:10px 12px;
  font-family:var(--mono);
  font-size:10px;
  color:var(--muted);
  display:none;
  z-index:60;
  max-width:520px;
}
.toast.show{display:block}
.toast strong{color:#fff}
</style>
</head>
<body>

<div class="top">
  <div style="display:flex;align-items:center;gap:12px;">
    <div class="brand">KETADATA // FORGE</div>
    <div class="status">
      <div class="pill">MODE: <strong>ROOM</strong></div>
      <div class="pill">STATE: <strong id="pillState">DRAFT</strong></div>
      <div class="pill">ROOMS: <strong id="pillRooms">0</strong></div>
    </div>
  </div>
  <div class="actions">
    <button class="btn" id="btnNew">new</button>
    <button class="btn" id="btnSave">save</button>
    <button class="btn" id="btnGenerate">generate</button>
    <button class="btn" id="btnCopy">copy</button>
    <button class="btn" id="btnExportRoom">export room</button>
    <button class="btn" id="btnExportForge">export.json</button>
    <button class="btn" id="btnImportForge">import.json</button>
    <button class="btn" id="btnReset">reset</button>
    <div class="noteIcon" id="noteIcon" title="SYSTEM NOTE"></div>
  </div>
</div>

<div class="main">

  <!-- LEFT: DEFINITIONS + REGISTRY -->
  <div class="rail">
    <div class="railHead">
      <div class="railTitle">Definitions</div>
      <div class="kbd">Ctrl/Cmd+S</div>
    </div>
    <div class="railBody">

      <div class="card">
        <div class="cardPad">
          <div class="cardTitle">Room</div>

          <div class="row">
            <div>
              <label>ID</label>
              <input id="inId" placeholder="e.g. lab / studio / vault"/>
            </div>
            <div>
              <label>ACCESS</label>
              <select id="inAccess">
                <option value="public">public</option>
                <option value="internal">internal</option>
                <option value="private">private</option>
              </select>
            </div>
          </div>

          <div style="margin-top:10px;">
            <label>TITLE</label>
            <input id="inTitle" placeholder="e.g. LAB"/>
          </div>

          <div style="margin-top:10px;">
            <label>TAGS (COMMA)</label>
            <input id="inTags" placeholder="e.g. research,tools"/>
          </div>

          <div style="margin-top:10px;">
            <label>NOTES</label>
            <textarea id="inNotes" placeholder=""></textarea>
          </div>

          <div class="hr"></div>
          <div class="footerBtns">
            <button class="btn" id="btnSelectPrev">select prev</button>
            <button class="btn" id="btnSelectNext">select next</button>
            <button class="btn" id="btnDelete">delete</button>
          </div>

          <div class="hr"></div>
          <div class="small" id="hintLeft">
            Use <strong>save</strong> to create/update by ID. Use <strong>generate</strong> to preview HTML.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardPad">
          <div class="cardTitle">Registry</div>
          <div class="small">Click a room to load. Reorder later (v2).</div>
          <div class="hr"></div>
          <div id="registryList" class="small"></div>
        </div>
      </div>

      <div class="warn">
        <strong>HOTKEYS</strong><br>
        Cmd+; : system note<br>
        Ctrl/Cmd+S : save<br>
        G : generate<br>
        C : copy output
      </div>

    </div>
  </div>

  <!-- CENTER: CONFIG (VISIBLE VIA TABS) -->
  <div class="rail">
    <div class="railHead">
      <div class="railTitle">Build Config</div>
      <div class="kbd">Tabs</div>
    </div>
    <div class="railBody">

      <div class="tabs" id="tabs">
        <div class="tab active" data-tab="modules">modules</div>
        <div class="tab" data-tab="flow">flow</div>
        <div class="tab" data-tab="review">review</div>
      </div>

      <div id="tab_modules" class="card">
        <div class="cardPad">
          <div class="cardTitle">Modules</div>
          <div class="small">Select modules included in the generated room scaffold.</div>
          <div class="hr"></div>
          <div class="grid2" id="modsGrid"></div>
        </div>
      </div>

      <div id="tab_flow" class="card" style="display:none;">
        <div class="cardPad">
          <div class="cardTitle">Flow / Nav</div>
          <div class="small">Snap and operator controls. Discrete, not scroll mush.</div>
          <div class="hr"></div>

          <div class="row">
            <div>
              <label>RAILS</label>
              <select id="inRails">
                <option value="on">on</option>
                <option value="off">off</option>
              </select>
            </div>
            <div>
              <label>SNAP</label>
              <select id="inSnap">
                <option value="off">off</option>
                <option value="on">on</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div>
              <label>SECTIONS</label>
              <input id="inSections" placeholder="1" value="1"/>
            </div>
            <div>
              <label>KEYBOARD NAV</label>
              <select id="inKeys">
                <option value="on">on</option>
                <option value="off">off</option>
              </select>
            </div>
          </div>

          <div style="margin-top:10px;">
            <label>PALETTE</label>
            <select id="inPalette">
              <option value="mono">mono</option>
              <option value="grey">grey</option>
              <option value="white_mode">white_mode</option>
            </select>
          </div>

          <div class="hr"></div>
          <div class="warn" id="flowHint"><strong>RULE</strong><br>Snap ON => fixed 100vh sections and discrete stepping.</div>
        </div>
      </div>

      <div id="tab_review" class="card" style="display:none;">
        <div class="cardPad">
          <div class="cardTitle">Review</div>
          <div class="small">Validation + summary. Fix errors in left rail + flow.</div>
          <div class="hr"></div>
          <div class="outputBox" id="reviewBox"></div>
          <div class="hr"></div>
          <div class="warn" id="valBox"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- RIGHT: OUTPUT -->
  <div class="rail">
    <div class="railHead">
      <div class="railTitle">Output</div>
      <div class="kbd">HTML</div>
    </div>
    <div class="railBody">
      <div class="card">
        <div class="cardPad">
          <div class="cardTitle">Generated HTML</div>
          <div class="small" id="outMeta">No output yet.</div>
          <div class="hr"></div>
          <div class="outputBox" id="outBox">(enter id + title, then Generate)</div>
        </div>
      </div>

      <div class="warn" id="outWarn">
        <strong>EXPORTABILITY</strong><br>
        This Forge exports: room JSON, forge JSON, and generated HTML.
      </div>
    </div>
  </div>

</div>

<!-- NOTE -->
<div class="note" id="note">
  <div class="noteHead" id="noteHead">
    <span>SYSTEM NOTE</span>
    <div class="noteClose" id="noteClose">x</div>
  </div>
  <div class="noteBody">
    <textarea id="systemNote" placeholder="global free-form"></textarea>
  </div>
</div>

<input type="file" id="filePick" accept="application/json" style="display:none;"/>

<div class="toast" id="toast"><strong>OK</strong> <span id="toastMsg"></span></div>

<script>
(function(){
  // -------------------------------
  // Storage
  // -------------------------------
  var LS_FORGE = "KETADATA_FORGE_V12_STATE";
  var LS_NOTE  = "KETADATA_FORGE_V12_NOTE";

  function nowISO(){ return new Date().toISOString(); }
  function safeParse(s){ try{return JSON.parse(s);}catch(e){return null;} }
  function saveState(){ localStorage.setItem(LS_FORGE, JSON.stringify(app.state,null,2)); }
  function loadState(){
    var raw = localStorage.getItem(LS_FORGE);
    var o = raw ? safeParse(raw) : null;
    return o && typeof o === "object" ? o : { rooms: [], draft: null };
  }

  function toast(msg){
    var t = document.getElementById("toast");
    var m = document.getElementById("toastMsg");
    m.textContent = msg;
    t.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(function(){ t.classList.remove("show"); }, 1200);
  }

  // -------------------------------
  // Data model
  // -------------------------------
  var MODULES = [
    {id:"registry", name:"REGISTRY", desc:"table/list surface for items"},
    {id:"ledger", name:"LEDGER", desc:"transactions / proof-of-motion panel"},
    {id:"gallery", name:"GALLERY", desc:"grid gallery for media"},
    {id:"vi_surface", name:"VI–DI SURFACE SLOT", desc:"controlled visual surface mount"},
    {id:"capture", name:"CAPTURE", desc:"export/import state hooks"},
    {id:"prompt_export", name:"PROMPT EXPORT", desc:"prompt pack exporter"},
    {id:"audit", name:"AUDIT", desc:"continuity checklist"}
  ];

  function freshDraft(){
    return {
      id:"",
      title:"",
      access:"public",
      tags:[],
      notes:"",
      modules:[],
      flow:{ rails:true, snap:false, sections:1, keys:true, palette:"mono" },
      createdAt: nowISO(),
      updatedAt: nowISO()
    };
  }

  function validateDraft(d){
    var errs = [];
    var id = (d.id||"").trim();
    var title = (d.title||"").trim();
    if(!id) errs.push("Missing room id.");
    if(id && !/^[a-z0-9_-]+$/i.test(id)) errs.push("Room id must be alphanumeric/underscore/dash.");
    if(!title) errs.push("Missing room title.");
    if(d.flow && d.flow.snap){
      var n = Number(d.flow.sections||0);
      if(!isFinite(n) || n<1 || n>64) errs.push("Snap sections must be 1–64.");
    }
    return errs;
  }

  // -------------------------------
  // DOM
  // -------------------------------
  var app = {
    state: loadState(),
    selectedIndex: 0,
    outHTML: ""
  };
  if(!app.state.draft) app.state.draft = freshDraft();

  var el = {
    pillState: document.getElementById("pillState"),
    pillRooms: document.getElementById("pillRooms"),

    inId: document.getElementById("inId"),
    inTitle: document.getElementById("inTitle"),
    inAccess: document.getElementById("inAccess"),
    inTags: document.getElementById("inTags"),
    inNotes: document.getElementById("inNotes"),

    registryList: document.getElementById("registryList"),

    modsGrid: document.getElementById("modsGrid"),

    inRails: document.getElementById("inRails"),
    inSnap: document.getElementById("inSnap"),
    inSections: document.getElementById("inSections"),
    inKeys: document.getElementById("inKeys"),
    inPalette: document.getElementById("inPalette"),

    reviewBox: document.getElementById("reviewBox"),
    valBox: document.getElementById("valBox"),

    outBox: document.getElementById("outBox"),
    outMeta: document.getElementById("outMeta"),

    btnNew: document.getElementById("btnNew"),
    btnSave: document.getElementById("btnSave"),
    btnGenerate: document.getElementById("btnGenerate"),
    btnCopy: document.getElementById("btnCopy"),
    btnExportRoom: document.getElementById("btnExportRoom"),
    btnExportForge: document.getElementById("btnExportForge"),
    btnImportForge: document.getElementById("btnImportForge"),
    btnReset: document.getElementById("btnReset"),

    btnDelete: document.getElementById("btnDelete"),
    btnSelectPrev: document.getElementById("btnSelectPrev"),
    btnSelectNext: document.getElementById("btnSelectNext"),

    filePick: document.getElementById("filePick"),

    tabs: document.getElementById("tabs"),
    tab_modules: document.getElementById("tab_modules"),
    tab_flow: document.getElementById("tab_flow"),
    tab_review: document.getElementById("tab_review"),

    noteIcon: document.getElementById("noteIcon"),
    note: document.getElementById("note"),
    noteHead: document.getElementById("noteHead"),
    noteClose: document.getElementById("noteClose"),
    systemNote: document.getElementById("systemNote")
  };

  // -------------------------------
  // Render
  // -------------------------------
  function setPills(){
    var errs = validateDraft(app.state.draft);
    el.pillState.textContent = errs.length ? "DRAFT" : "READY";
    el.pillRooms.textContent = String((app.state.rooms||[]).length);
  }

  function bindDraftToInputs(){
    var d = app.state.draft;
    el.inId.value = d.id || "";
    el.inTitle.value = d.title || "";
    el.inAccess.value = d.access || "public";
    el.inTags.value = (d.tags||[]).join(", ");
    el.inNotes.value = d.notes || "";

    el.inRails.value = (d.flow && d.flow.rails) ? "on" : "off";
    el.inSnap.value  = (d.flow && d.flow.snap) ? "on" : "off";
    el.inSections.value = String((d.flow && d.flow.sections) ? d.flow.sections : 1);
    el.inKeys.value = (d.flow && d.flow.keys) ? "on" : "off";
    el.inPalette.value = (d.flow && d.flow.palette) ? d.flow.palette : "mono";
  }

  function renderRegistry(){
    var rooms = app.state.rooms || [];
    if(!rooms.length){
      el.registryList.textContent = "(empty)";
      return;
    }
    var html = "";
    for(var i=0;i<rooms.length;i++){
      var r = rooms[i];
      var mark = (i===app.selectedIndex) ? "• " : "  ";
      html += mark + r.id + "  //  " + (r.title||"") + "  [" + (r.access||"public") + "]\n";
    }
    el.registryList.textContent = html;
    // click to select (simple hit-test by line)
    el.registryList.onclick = function(ev){
      // approximate: compute clicked line by y
      var rect = el.registryList.getBoundingClientRect();
      var y = ev.clientY - rect.top;
      var lineH = 16;
      var idx = Math.floor(y / lineH);
      if(idx>=0 && idx<rooms.length){
        app.selectedIndex = idx;
        loadRoomIntoDraft(rooms[idx]);
      }
    };
  }

  function renderModules(){
    el.modsGrid.innerHTML = "";
    var d = app.state.draft;
    var set = {};
    for(var i=0;i<(d.modules||[]).length;i++) set[d.modules[i]] = true;

    MODULES.forEach(function(m){
      var wrap = document.createElement("div");
      wrap.className = "chk";
      var checked = !!set[m.id];
      wrap.innerHTML =
        '<input type="checkbox" '+(checked?'checked':'')+' />' +
        '<div class="meta">' +
          '<div class="name">'+m.name+'</div>' +
          '<div class="desc">'+m.desc+'</div>' +
        '</div>';
      var cb = wrap.querySelector("input");
      function commit(){
        var arr = [];
        var cur = {};
        (d.modules||[]).forEach(function(x){ cur[x]=true; });
        cur[m.id] = cb.checked;
        for(var k in cur) if(cur[k]) arr.push(k);
        d.modules = arr;
        d.updatedAt = nowISO();
        saveState();
        setPills();
        renderReview();
      }
      wrap.onclick = function(e){
        if(e.target.tagName.toLowerCase() !== "input") cb.checked = !cb.checked;
        commit();
      };
      cb.onclick = function(e){ e.stopPropagation(); };
      cb.onchange = commit;
      el.modsGrid.appendChild(wrap);
    });
  }

  function renderReview(){
    var d = app.state.draft;
    var summary = {
      id: (d.id||"").trim(),
      title: (d.title||"").trim(),
      access: d.access || "public",
      tags: d.tags || [],
      modules: d.modules || [],
      flow: d.flow || {}
    };
    el.reviewBox.textContent = JSON.stringify(summary, null, 2);

    var errs = validateDraft(d);
    if(errs.length){
      el.valBox.innerHTML = "<strong>VALIDATION</strong><br>" + errs.map(function(e){return "• "+e;}).join("<br>");
    } else {
      el.valBox.innerHTML = "<strong>VALIDATION</strong><br>OK. Ready to generate.";
    }
  }

  // -------------------------------
  // Generate (no template literals)
  // -------------------------------
  function esc(s){
    return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  }

  function buildRoomHTML(d){
    var roomId = (d.id||"room").trim() || "room";
    var title  = (d.title||roomId.toUpperCase()).trim() || roomId.toUpperCase();
    var tags   = (d.tags||[]).join(", ");
    var snapOn = !!(d.flow && d.flow.snap);
    var sections = snapOn ? Math.max(1, Math.min(64, Number(d.flow.sections||1))) : 1;
    var railsOn = !!(d.flow && d.flow.rails);
    var keysOn  = !!(d.flow && d.flow.keys);

    var moduleBlocks = "";
    (d.modules||[]).forEach(function(mid){
      var mod = MODULES.filter(function(x){return x.id===mid;})[0];
      var name = mod ? mod.name : String(mid).toUpperCase();
      moduleBlocks += '<div class="box"><div class="h">'+esc(name)+'</div><div class="mono">placeholder</div></div>\n';
    });
    if(!moduleBlocks) moduleBlocks = '<div class="mono">none</div>';

    var snapCSS = snapOn
      ? '.stage{overflow:auto;scroll-snap-type:y mandatory;} .section{height:100vh;scroll-snap-align:start;}'
      : '.stage{overflow:auto;} .section{min-height:100vh;}';

    var railsCSS = railsOn
      ? '.stageInner{display:grid;grid-template-columns:320px 1fr 420px;min-height:100%;}.rail{border-right:1px solid rgba(255,255,255,.14);} .rail:last-child{border-right:none;}'
      : '.stageInner{display:block;min-height:100%;}.rail{border:none;}';

    var sectionsHTML = "";
    for(var i=0;i<sections;i++){
      var idx = i+1;
      sectionsHTML += '<section class="section"><div class="stageInner">';
      if(railsOn){
        sectionsHTML +=
          '<div class="rail pad"><div class="h">LEFT RAIL</div><div class="box"><div class="mono">inputs / controls</div></div></div>' +
          '<div class="rail pad"><div class="h">CENTER STAGE</div><div class="box"><div class="mono">content</div></div>' +
          (idx===1 ? ('<div class="box"><div class="h">MODULES</div>'+moduleBlocks+'</div>') : '') +
          '</div>' +
          '<div class="rail pad"><div class="h">RIGHT RAIL</div><div class="box"><div class="mono">output</div></div></div>';
      } else {
        sectionsHTML +=
          '<div class="pad"><div class="h">STAGE</div><div class="box"><div class="mono">content</div></div>' +
          (idx===1 ? ('<div class="box"><div class="h">MODULES</div>'+moduleBlocks+'</div>') : '') +
          '</div>';
      }
      sectionsHTML += '</div></section>\n';
    }

    var keysJS = "";
    if(keysOn && snapOn){
      keysJS =
        "document.addEventListener('keydown',function(e){var st=document.querySelector('.stage');if(!st)return;var h=window.innerHeight;var down=(e.key==='j'||e.key==='ArrowDown'||e.key==='PageDown');var up=(e.key==='k'||e.key==='ArrowUp'||e.key==='PageUp');if(down||up){e.preventDefault();st.scrollTo({top:st.scrollTop+(down?h:-h),behavior:'smooth'});}});";
    }

    var html =
'<!DOCTYPE html>\n<html lang="en"><head>\n<meta charset="UTF-8"/>\n<meta name="viewport" content="width=device-width,initial-scale=1.0"/>\n' +
'<title>'+esc(title)+' // KETADATA</title>\n' +
'<style>\n' +
'html,body{height:100%;margin:0;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif;overflow:hidden}\n' +
'body::before{content:"";position:fixed;inset:0;background:linear-gradient(rgba(255,255,255,.09) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.09) 1px,transparent 1px);background-size:36px 36px;opacity:.26;pointer-events:none;}\n' +
'.top{position:fixed;left:0;right:0;top:0;height:44px;display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.14);background:#000;z-index:5;}\n' +
'.brand{font-weight:900;font-size:11px;letter-spacing:.22em;text-transform:uppercase}\n' +
'.meta{font-family:ui-monospace,Menlo,monospace;font-size:10px;color:rgba(255,255,255,.58)}\n' +
'.noteIcon{width:14px;height:14px;border:1px solid #fff;background:#fff;cursor:pointer}\n' +
'.noteIcon.open{background:transparent}\n' +
'.stage{position:absolute;inset:44px 0 0 0;}\n' +
snapCSS + '\n' + railsCSS + '\n' +
'.pad{padding:12px}\n' +
'.h{font-size:10px;letter-spacing:.18em;text-transform:uppercase;color:rgba(255,255,255,.58);margin-bottom:8px;font-weight:900}\n' +
'.mono{font-family:ui-monospace,Menlo,monospace;font-size:11px;color:rgba(255,255,255,.9)}\n' +
'.box{border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.02);padding:10px;margin-bottom:10px}\n' +
'.note{position:fixed;top:120px;right:120px;width:360px;height:360px;border:1px solid #fff;background:#000;display:none;z-index:20}\n' +
'.note.open{display:block}\n' +
'.noteHead{padding:8px;border-bottom:1px solid rgba(255,255,255,.14);font-size:10px;letter-spacing:.18em;text-transform:uppercase;cursor:move;user-select:none;display:flex;justify-content:space-between}\n' +
'.noteClose{border:1px solid rgba(255,255,255,.14);width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-family:ui-monospace,Menlo,monospace;cursor:pointer}\n' +
'.noteBody{height:calc(100% - 34px)}\n' +
'.noteBody textarea{height:100%;width:100%;border:none;outline:none;background:transparent;color:#fff;padding:10px;font-family:ui-monospace,Menlo,monospace;font-size:11px;resize:none}\n' +
'</style>\n</head><body>\n' +
'<div class="top"><div><div class="brand">'+esc(title)+' // KETADATA</div><div class="meta">id:'+esc(roomId)+' | access:'+esc(d.access||"public")+' | tags:'+esc(tags||"-")+'</div></div><div class="noteIcon" id="noteIcon" title="SYSTEM NOTE"></div></div>\n' +
'<div class="stage">\n' + sectionsHTML + '\n</div>\n' +
'<div class="note" id="note"><div class="noteHead" id="noteHead"><span>SYSTEM NOTE</span><div class="noteClose" id="noteClose">x</div></div><div class="noteBody"><textarea id="systemNote">SYSTEM NOTE</textarea></div></div>\n' +
'<script>\n' +
"(function(){var noteIcon=document.getElementById('noteIcon');var note=document.getElementById('note');var noteClose=document.getElementById('noteClose');var systemNote=document.getElementById('systemNote');var noteHead=document.getElementById('noteHead');function toggle(force){var open=(typeof force==='boolean')?force:!note.classList.contains('open');note.classList.toggle('open',open);noteIcon.classList.toggle('open',open);}noteIcon.addEventListener('click',function(){toggle();});noteClose.addEventListener('click',function(){toggle(false);});document.addEventListener('keydown',function(e){var isCmd=e.metaKey||e.ctrlKey;if(isCmd&&e.key===';'){e.preventDefault();toggle();}});var dragging=false,ox=0,oy=0;noteHead.addEventListener('mousedown',function(e){dragging=true;var r=note.getBoundingClientRect();ox=e.clientX-r.left;oy=e.clientY-r.top;});window.addEventListener('mousemove',function(e){if(!dragging)return;note.style.left=(e.clientX-ox)+'px';note.style.top=(e.clientY-oy)+'px';note.style.right='auto';});window.addEventListener('mouseup',function(){dragging=false;});var KEY='KETADATA_ROOM_NOTE_"+roomId+"';systemNote.value=localStorage.getItem(KEY)||systemNote.value;systemNote.addEventListener('input',function(){localStorage.setItem(KEY,systemNote.value);});"+keysJS+"})();\n" +
'</script>\n</body></html>\n';

    return html;
  }

  // -------------------------------
  // Actions
  // -------------------------------
  function syncDraftFromInputs(){
    var d = app.state.draft;
    d.id = (el.inId.value||"").trim();
    d.title = el.inTitle.value || "";
    d.access = el.inAccess.value || "public";
    d.tags = (el.inTags.value||"").split(",").map(function(x){return x.trim();}).filter(Boolean);
    d.notes = el.inNotes.value || "";

    d.flow.rails = (el.inRails.value === "on");
    d.flow.snap  = (el.inSnap.value === "on");
    var n = Math.floor(Number(el.inSections.value||1));
    if(!isFinite(n) || n<1) n = 1;
    if(n>64) n = 64;
    d.flow.sections = n;
    d.flow.keys = (el.inKeys.value === "on");
    d.flow.palette = el.inPalette.value || "mono";
    d.updatedAt = nowISO();
  }

  function loadRoomIntoDraft(r){
    app.state.draft = JSON.parse(JSON.stringify(r));
    // ensure flow defaults exist
    if(!app.state.draft.flow) app.state.draft.flow = { rails:true, snap:false, sections:1, keys:true, palette:"mono" };
    bindDraftToInputs();
    renderModules();
    renderReview();
    setPills();
    saveState();
    toast("loaded: "+(r.id||""));
  }

  function saveDraftToRegistry(){
    syncDraftFromInputs();
    var d = app.state.draft;
    var errs = validateDraft(d);
    if(errs.length){
      toast("blocked: fix validation");
      renderReview();
      return;
    }
    var rooms = app.state.rooms || [];
    var id = (d.id||"").trim();
    var idx = -1;
    for(var i=0;i<rooms.length;i++){
      if(String(rooms[i].id||"").trim() === id){ idx = i; break; }
    }
    var rec = JSON.parse(JSON.stringify(d));
    rec.createdAt = (idx>=0 && rooms[idx].createdAt) ? rooms[idx].createdAt : nowISO();
    rec.updatedAt = nowISO();
    if(idx>=0){ rooms[idx] = rec; }
    else { rooms.push(rec); app.selectedIndex = rooms.length-1; }
    app.state.rooms = rooms;
    saveState();
    renderRegistry();
    renderReview();
    setPills();
    toast(idx>=0 ? "updated" : "created");
  }

  function generateOutput(){
    syncDraftFromInputs();
    renderReview();
    var errs = validateDraft(app.state.draft);
    if(errs.length){
      toast("blocked: fix validation");
      return;
    }
    app.outHTML = buildRoomHTML(app.state.draft);
    el.outBox.textContent = app.outHTML;
    el.outMeta.textContent = "Generated: "+nowISO()+" | chars: "+String(app.outHTML.length);
    toast("generated");
    saveState();
  }

  function copyOutput(){
    var txt = el.outBox.textContent || "";
    if(!txt || txt.indexOf("<!DOCTYPE html>") !== 0){
      toast("no html to copy");
      return;
    }
    navigator.clipboard.writeText(txt).then(function(){ toast("copied"); }).catch(function(){ toast("copy failed"); });
  }

  function exportRoomFile(){
    var txt = el.outBox.textContent || "";
    if(!txt || txt.indexOf("<!DOCTYPE html>") !== 0){
      toast("generate first");
      return;
    }
    var id = (app.state.draft.id||"room").trim() || "room";
    var blob = new Blob([txt], {type:"text/html"});
    var a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = id + ".html";
    a.click();
    toast("room exported");
  }

  function exportForgeFile(){
    var blob = new Blob([JSON.stringify(app.state,null,2)], {type:"application/json"});
    var a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "ketadata.forge.state.json";
    a.click();
    toast("forge exported");
  }

  function importForgeFile(file){
    file.text().then(function(txt){
      var incoming = safeParse(txt);
      if(!incoming || typeof incoming !== "object") throw new Error("bad json");
      if(!incoming.rooms) incoming.rooms = [];
      if(!incoming.draft) incoming.draft = freshDraft();
      app.state = incoming;
      app.selectedIndex = 0;
      saveState();
      bindDraftToInputs();
      renderModules();
      renderRegistry();
      renderReview();
      setPills();
      toast("imported");
    }).catch(function(){
      alert("IMPORT FAILED: invalid JSON");
    });
  }

  function resetAll(){
    if(!confirm("RESET FORGE STATE?")) return;
    app.state = { rooms: [], draft: freshDraft() };
    app.selectedIndex = 0;
    app.outHTML = "";
    saveState();
    bindDraftToInputs();
    renderModules();
    renderRegistry();
    renderReview();
    setPills();
    el.outBox.textContent = "(enter id + title, then Generate)";
    el.outMeta.textContent = "No output yet.";
    toast("reset");
  }

  function newDraft(){
    app.state.draft = freshDraft();
    bindDraftToInputs();
    renderModules();
    renderReview();
    setPills();
    saveState();
    toast("new draft");
  }

  function deleteSelected(){
    var rooms = app.state.rooms || [];
    if(!rooms.length){ toast("registry empty"); return; }
    var r = rooms[app.selectedIndex];
    if(!r){ toast("no selection"); return; }
    if(!confirm("DELETE "+r.id+" ?")) return;
    rooms.splice(app.selectedIndex, 1);
    if(app.selectedIndex >= rooms.length) app.selectedIndex = rooms.length-1;
    app.state.rooms = rooms;
    saveState();
    renderRegistry();
    setPills();
    toast("deleted");
  }

  function selectPrev(){
    var rooms = app.state.rooms || [];
    if(!rooms.length) return;
    app.selectedIndex = Math.max(0, app.selectedIndex - 1);
    loadRoomIntoDraft(rooms[app.selectedIndex]);
  }
  function selectNext(){
    var rooms = app.state.rooms || [];
    if(!rooms.length) return;
    app.selectedIndex = Math.min(rooms.length-1, app.selectedIndex + 1);
    loadRoomIntoDraft(rooms[app.selectedIndex]);
  }

  // -------------------------------
  // Tabs
  // -------------------------------
  function setTab(name){
    Array.prototype.forEach.call(document.querySelectorAll(".tab"), function(t){
      t.classList.toggle("active", t.getAttribute("data-tab")===name);
    });
    el.tab_modules.style.display = (name==="modules") ? "" : "none";
    el.tab_flow.style.display    = (name==="flow") ? "" : "none";
    el.tab_review.style.display  = (name==="review") ? "" : "none";
  }

  // -------------------------------
  // Note primitive
  // -------------------------------
  function initNote(){
    el.systemNote.value = localStorage.getItem(LS_NOTE) || "";
    function toggle(force){
      var open = (typeof force==="boolean") ? force : !el.note.classList.contains("open");
      el.note.classList.toggle("open", open);
      el.noteIcon.classList.toggle("open", open);
    }
    el.noteIcon.onclick = function(){ toggle(); };
    el.noteClose.onclick = function(){ toggle(false); };
    el.systemNote.oninput = function(){ localStorage.setItem(LS_NOTE, el.systemNote.value); };

    // drag
    var dragging=false, ox=0, oy=0;
    el.noteHead.addEventListener("mousedown", function(e){
      dragging=true;
      var r = el.note.getBoundingClientRect();
      ox = e.clientX - r.left;
      oy = e.clientY - r.top;
    });
    window.addEventListener("mousemove", function(e){
      if(!dragging) return;
      el.note.style.left = (e.clientX - ox) + "px";
      el.note.style.top  = (e.clientY - oy) + "px";
      el.note.style.right = "auto";
    });
    window.addEventListener("mouseup", function(){ dragging=false; });

    document.addEventListener("keydown", function(e){
      var isCmd = e.metaKey || e.ctrlKey;
      if(isCmd && e.key === ";"){ e.preventDefault(); toggle(); }
    });
  }

  // -------------------------------
  // Wire events
  // -------------------------------
  el.btnNew.onclick = newDraft;
  el.btnSave.onclick = saveDraftToRegistry;
  el.btnGenerate.onclick = generateOutput;
  el.btnCopy.onclick = copyOutput;
  el.btnExportRoom.onclick = exportRoomFile;
  el.btnExportForge.onclick = exportForgeFile;
  el.btnImportForge.onclick = function(){ el.filePick.click(); };
  el.filePick.onchange = function(){
    var f = el.filePick.files && el.filePick.files[0];
    if(f) importForgeFile(f);
    el.filePick.value = "";
  };
  el.btnReset.onclick = resetAll;

  el.btnDelete.onclick = deleteSelected;
  el.btnSelectPrev.onclick = selectPrev;
  el.btnSelectNext.onclick = selectNext;

  // live review updates
  ["input","change"].forEach(function(evt){
    el.inId.addEventListener(evt, function(){ syncDraftFromInputs(); setPills(); renderReview(); });
    el.inTitle.addEventListener(evt, function(){ syncDraftFromInputs(); setPills(); renderReview(); });
    el.inAccess.addEventListener(evt, function(){ syncDraftFromInputs(); setPills(); renderReview(); });
    el.inTags.addEventListener(evt, function(){ syncDraftFromInputs(); setPills(); renderReview(); });
    el.inNotes.addEventListener(evt, function(){ syncDraftFromInputs(); setPills(); });
    el.inRails.addEventListener(evt, function(){ syncDraftFromInputs(); renderReview(); });
    el.inSnap.addEventListener(evt, function(){ syncDraftFromInputs(); renderReview(); });
    el.inSections.addEventListener(evt, function(){ syncDraftFromInputs(); renderReview(); });
    el.inKeys.addEventListener(evt, function(){ syncDraftFromInputs(); renderReview(); });
    el.inPalette.addEventListener(evt, function(){ syncDraftFromInputs(); renderReview(); });
  });

  // tabs
  el.tabs.onclick = function(e){
    var t = e.target.closest(".tab");
    if(!t) return;
    setTab(t.getAttribute("data-tab"));
  };

  // hotkeys
  document.addEventListener("keydown", function(e){
    var isCmd = e.metaKey || e.ctrlKey;
    if(isCmd && (e.key==="s" || e.key==="S")){
      e.preventDefault();
      saveDraftToRegistry();
      return;
    }
    if(!isCmd && (e.key==="g" || e.key==="G")){
      e.preventDefault();
      generateOutput();
      return;
    }
    if(!isCmd && (e.key==="c" || e.key==="C")){
      e.preventDefault();
      copyOutput();
      return;
    }
  });

  // -------------------------------
  // Boot
  // -------------------------------
  function boot(){
    initNote();
    bindDraftToInputs();
    renderModules();
    renderRegistry();
    renderReview();
    setPills();
    setTab("modules");
    toast("forge ready");
  }
  boot();
})();
</script>

</body>
</html>
