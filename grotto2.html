<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>KETA_MONO // GROTTO</title>
<style>
  :root{
    --bg:#000;
    --ink:rgba(255,255,255,.88);
    --muted:rgba(255,255,255,.54);
    --line:rgba(255,255,255,.14);
    --line2:rgba(255,255,255,.22);

    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;

    --top:44px;
    --pad:10px;
    --r:18px;

    --glow: 0 0 26px rgba(255,255,255,.10), 0 0 90px rgba(255,255,255,.06);
    --grainA:.055;
  }

  *{box-sizing:border-box}
  html,body{height:100%; margin:0; background:var(--bg); overflow:hidden; color:var(--ink); font-family:var(--mono)}
  #root{position:fixed; inset:0; background:#000}

  /* ===== TOP BAR (KETA_MONO) ===== */
  #top{
    position:fixed; left:0; right:0; top:0; height:var(--top);
    display:flex; align-items:center; justify-content:space-between;
    padding:0 var(--pad);
    background: linear-gradient(to bottom, rgba(0,0,0,.92), rgba(0,0,0,.30));
    border-bottom:1px solid var(--line);
    z-index:50;
    user-select:none;
  }
  .rail{
    display:flex; align-items:center; gap:10px;
    font-size:12px; line-height:1;
    white-space:nowrap;
  }
  .tag{
    padding:6px 8px;
    border:1px solid var(--line);
    background: rgba(0,0,0,.22);
  }
  .sep{opacity:.55}
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 8px;
    border:1px solid var(--line);
    background: rgba(0,0,0,.22);
  }
  .sq{
    width:10px;height:10px;
    border:1px solid rgba(255,255,255,.65);
    background: rgba(255,255,255,.08);
  }
  button.m{
    font:inherit; font-size:12px;
    padding:6px 8px;
    border:1px solid var(--line);
    background: rgba(0,0,0,.22);
    color:var(--ink);
    cursor:pointer;
  }
  button.m:active{transform: translateY(1px)}
  button.m[aria-pressed="true"]{border-color:rgba(255,255,255,.45); background: rgba(255,255,255,.06)}
  .readout{opacity:.78}

  /* ===== SCENE ===== */
  #scene{
    position:fixed; inset:var(--top) 0 0 0;
    display:grid; place-items:center;
  }
  #grotto{
    position:relative;
    width:min(1180px, calc(100vw - 28px));
    height:min(650px, calc(100vh - var(--top) - 22px));
    border-radius: var(--r);
    overflow:hidden;
    box-shadow: 0 18px 120px rgba(0,0,0,.72), var(--glow);
    background:#000;
  }

  /* Vignette */
  #grotto:before{
    content:"";
    position:absolute; inset:-1px;
    background:
      radial-gradient(1200px 700px at 60% 45%, transparent 55%, rgba(0,0,0,.55) 78%, rgba(0,0,0,.90) 100%),
      radial-gradient(900px 900px at 20% 110%, rgba(0,0,0,.60), rgba(0,0,0,.95));
    pointer-events:none;
    z-index:80;
    mix-blend-mode:multiply;
  }

  /* Cave mass (mono coral texture) */
  .cave{
    position:absolute;
    inset:-80px -120px -140px -120px;
    background:
      radial-gradient(520px 420px at 12% 18%, rgba(255,255,255,.10), transparent 72%),
      radial-gradient(680px 540px at 86% 30%, rgba(255,255,255,.06), transparent 74%),
      radial-gradient(980px 700px at 55% 0%, rgba(255,255,255,.05), transparent 70%),
      radial-gradient(900px 820px at 50% 100%, rgba(255,255,255,.05), transparent 75%),
      conic-gradient(from 40deg at 70% 35%,
        rgba(255,255,255,.10), rgba(255,255,255,.04), rgba(255,255,255,.08), rgba(255,255,255,.10));
    opacity:.95;
    z-index:18;

    /* EDIT #2: sharper “cave mouth” silhouette with a second edge */
    mask-image:
      radial-gradient(1100px 650px at 55% 58%, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 56%, rgba(0,0,0,1) 69%),
      radial-gradient(1100px 650px at 55% 58%, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 60%, rgba(0,0,0,1) 70%),
      radial-gradient(900px 560px at 20% 50%, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 52%, rgba(0,0,0,1) 66%),
      radial-gradient(900px 560px at 20% 50%, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 56%, rgba(0,0,0,1) 67%);
    mask-composite:add;
  }

  /* Underwater window (mono) */
  #water{
    position:absolute;
    left:-6%;
    top:-6%;
    width:56%;
    height:80%;
    border-radius: 40% 60% 58% 42% / 55% 45% 55% 45%;
    background:
      radial-gradient(900px 600px at 30% 20%, rgba(255,255,255,.12), transparent 70%),
      radial-gradient(900px 700px at 40% 60%, rgba(255,255,255,.06), transparent 70%),
      linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04) 60%, rgba(0,0,0,0) 100%);
    box-shadow:
      inset 0 0 70px rgba(0,0,0,.45),
      inset 0 0 120px rgba(255,255,255,.05),
      0 0 70px rgba(255,255,255,.05);
    z-index:20;
    overflow:hidden;
  }
  #water:before{
    content:"";
    position:absolute; inset:-30%;
    background:
      repeating-linear-gradient(120deg,
        rgba(255,255,255,.16) 0 6px,
        rgba(255,255,255,0) 6px 18px);
    opacity:.12;
    filter: blur(2px);
    animation: caustics 9s linear infinite;
    mix-blend-mode: screen;
  }
  #water:after{
    content:"";
    position:absolute; inset:0;
    background:
      radial-gradient(600px 420px at 52% 30%, rgba(255,255,255,.16), transparent 70%),
      radial-gradient(800px 500px at 35% 60%, rgba(255,255,255,.10), transparent 75%),
      radial-gradient(900px 700px at 60% 90%, rgba(0,0,0,.12), transparent 75%);
    opacity:.9;
    pointer-events:none;
  }
  @keyframes caustics{
    0%{transform: translate(-8%, -6%) rotate(0.5deg) scale(1.02)}
    50%{transform: translate(6%, 2%) rotate(-0.4deg) scale(1.05)}
    100%{transform: translate(-8%, -6%) rotate(0.5deg) scale(1.02)}
  }

  /* Plants silhouettes (mono) */
  .plant{
    position:absolute;
    bottom:6%;
    left:3%;
    width:34%;
    height:48%;
    opacity:.26;
    z-index:24;
    mix-blend-mode: overlay;
    filter: blur(.4px);
  }
  .plant:before,.plant:after{content:"";position:absolute;inset:0}
  .plant:before{
    background:
      radial-gradient(90px 260px at 15% 100%, rgba(0,0,0,.86), rgba(0,0,0,0) 70%),
      radial-gradient(120px 320px at 28% 100%, rgba(0,0,0,.78), rgba(0,0,0,0) 72%),
      radial-gradient(130px 340px at 45% 100%, rgba(0,0,0,.70), rgba(0,0,0,0) 74%),
      radial-gradient(130px 360px at 62% 100%, rgba(0,0,0,.62), rgba(0,0,0,0) 75%),
      radial-gradient(140px 380px at 80% 100%, rgba(0,0,0,.56), rgba(0,0,0,0) 76%);
  }
  .plant:after{
    background:
      radial-gradient(240px 240px at 22% 85%, rgba(255,255,255,.06), transparent 70%),
      radial-gradient(300px 280px at 68% 80%, rgba(255,255,255,.05), transparent 70%);
  }

  /* Glitter floor base (mono) */
  #floor{
    position:absolute;
    left:0; right:0; bottom:-14%;
    height:52%;
    background:
      radial-gradient(900px 420px at 60% 30%, rgba(255,255,255,.10), transparent 70%),
      radial-gradient(900px 520px at 40% 40%, rgba(255,255,255,.07), transparent 75%),
      linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.62));
    z-index:34;
    transform: perspective(900px) rotateX(58deg);
    transform-origin: 50% 0%;
  }

  /* FX canvases */
  canvas{position:absolute; inset:0; width:100%; height:100%; display:block; pointer-events:none;}

  /* EDIT #1: parallax separation: dust (slow), wall (medium), floor (faster) */
  #fxDust {z-index:22; mix-blend-mode: screen; filter: blur(.20px); opacity:.78;}
  #fxWall {z-index:40; mix-blend-mode: screen; opacity:.92;}
  #fxFloor{z-index:46; mix-blend-mode: screen;}
  #fxTwk  {z-index:66; mix-blend-mode: screen; opacity:.92;}

  /* Furniture (mono, glossy) */
  #lounge{
    position:absolute;
    right:6%;
    bottom:12%;
    width:54%;
    height:52%;
    z-index:52;
    pointer-events:none;
    opacity:.95;
  }

  #couch{
    position:absolute;
    right:0;
    bottom:0;
    width:70%;
    height:48%;
    border-radius: 18px 18px 22px 22px;
    background:
      radial-gradient(140px 120px at 25% 35%, rgba(255,255,255,.14), transparent 70%),
      radial-gradient(220px 160px at 80% 35%, rgba(255,255,255,.10), transparent 72%),
      linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,.10));
    box-shadow:
      inset 0 0 0 1px rgba(255,255,255,.18),
      inset 0 -22px 40px rgba(0,0,0,.28),
      0 12px 70px rgba(255,255,255,.06);
  }
  #couch:before{
    content:"";
    position:absolute; inset:12% 8% 18% 8%;
    background:
      radial-gradient(10px 10px at 12% 40%, rgba(255,255,255,.18), transparent 70%),
      radial-gradient(10px 10px at 26% 48%, rgba(255,255,255,.14), transparent 70%),
      radial-gradient(10px 10px at 40% 40%, rgba(255,255,255,.16), transparent 70%),
      radial-gradient(10px 10px at 54% 50%, rgba(255,255,255,.12), transparent 70%),
      radial-gradient(10px 10px at 68% 42%, rgba(255,255,255,.14), transparent 70%),
      radial-gradient(10px 10px at 82% 50%, rgba(255,255,255,.12), transparent 70%);
    opacity:.55;
    filter: blur(.2px);
  }
  #table{
    position:absolute;
    right:16%;
    bottom:8%;
    width:36%;
    height:18%;
    border-radius: 14px;
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
    box-shadow:
      inset 0 0 0 1px rgba(255,255,255,.14),
      0 10px 50px rgba(255,255,255,.05);
    backdrop-filter: blur(3px);
  }
  #glass1,#glass2{
    position:absolute;
    bottom:11%;
    width:20px;height:38px;border-radius: 6px 6px 10px 10px;
    background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.04));
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.16), 0 0 26px rgba(255,255,255,.05);
    opacity:.78;
  }
  #glass1{right:30%;}
  #glass2{right:24%; height:34px; opacity:.65;}

  .lamp{
    position:absolute;
    width:14%;
    height:46%;
    bottom:8%;
    opacity:.86;
  }
  .lamp .shade{
    position:absolute; left:18%; right:18%; top:0;
    height:36%;
    border-radius: 10px;
    background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.05));
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.14), 0 0 70px rgba(255,255,255,.06);
  }
  .lamp .stem{
    position:absolute; left:48%; top:34%; width:4%;
    height:40%;
    background: rgba(255,255,255,.10);
  }
  .lamp .base{
    position:absolute; left:24%; right:24%; bottom:0;
    height:16%;
    border-radius: 10px;
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.12);
  }
  .lamp .shade:after{
    content:"";
    position:absolute; inset:-30%;
    background: radial-gradient(circle, rgba(255,255,255,.12), rgba(255,255,255,0) 65%);
    filter: blur(10px);
  }
  #lampL{left:14%;}
  #lampR{right:0%;}

  /* Frames (mono) */
  #frames{
    position:absolute;
    right:6%;
    top:10%;
    width:56%;
    height:42%;
    z-index:44;
    opacity:.85;
    pointer-events:none;
  }
  .frame{
    position:absolute;
    border:1px solid rgba(255,255,255,.22);
    background: rgba(0,0,0,.12);
    box-shadow: 0 0 34px rgba(255,255,255,.05);
    backdrop-filter: blur(2px);
  }
  .frame:before{
    content:"";
    position:absolute; inset:8px;
    background:
      radial-gradient(110px 90px at 30% 40%, rgba(255,255,255,.08), transparent 70%),
      radial-gradient(120px 110px at 70% 60%, rgba(255,255,255,.06), transparent 75%),
      radial-gradient(140px 120px at 40% 70%, rgba(255,255,255,.05), transparent 70%);
    opacity:.9;
    filter: blur(1px);
  }
  .f1{right:0; top:6%; width:22%; height:52%;}
  .f2{right:26%; top:24%; width:14%; height:36%;}
  .f3{right:44%; top:14%; width:16%; height:42%;}
  .f4{right:62%; top:32%; width:12%; height:28%;}

  /* Candles (mono) */
  #candles{
    position:absolute;
    left:8%;
    bottom:14%;
    width:40%;
    height:24%;
    z-index:54;
    pointer-events:none;
  }
  .candle{
    position:absolute; bottom:0;
    width:18px; height:56px;
    border-radius: 8px;
    background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.12), 0 0 22px rgba(255,255,255,.04);
    opacity:.86;
  }
  .candle .flame{
    position:absolute; left:50%; top:-18px;
    width:10px; height:18px;
    transform: translateX(-50%);
    border-radius: 9px;
    background: radial-gradient(circle at 50% 30%, rgba(255,255,255,.90), rgba(255,255,255,.45) 45%, rgba(255,255,255,0) 72%);
    animation: flicker 900ms infinite ease-in-out;
    mix-blend-mode: screen;
  }
  .candle .halo{
    position:absolute; left:50%; top:-42px;
    width:70px; height:70px;
    transform: translateX(-50%);
    background: radial-gradient(circle, rgba(255,255,255,.12), rgba(255,255,255,0) 70%);
    filter: blur(3px);
    opacity:.9;
    animation: breathe 3.2s infinite ease-in-out;
  }
  @keyframes flicker{
    0%,100%{transform: translateX(-50%) scaleY(1) rotate(-1deg); opacity:.95}
    30%{transform: translateX(-50%) scaleY(.92) rotate(1deg); opacity:.70}
    55%{transform: translateX(-50%) scaleY(1.08) rotate(-2deg); opacity:.92}
    80%{transform: translateX(-50%) scaleY(.96) rotate(2deg); opacity:.80}
  }
  @keyframes breathe{
    0%,100%{opacity:.85; transform: translateX(-50%) scale(1)}
    50%{opacity:.55; transform: translateX(-50%) scale(1.08)}
  }

  /* Grain */
  #grain{
    position:absolute; inset:-20%;
    background-image:
      radial-gradient(circle at 20% 30%, rgba(255,255,255,var(--grainA)) 0 1px, transparent 2px),
      radial-gradient(circle at 70% 40%, rgba(255,255,255,var(--grainA)) 0 1px, transparent 2px),
      radial-gradient(circle at 40% 70%, rgba(255,255,255,var(--grainA)) 0 1px, transparent 2px);
    background-size: 120px 120px;
    opacity:.5;
    filter: blur(0.6px);
    z-index:74;
    mix-blend-mode: overlay;
    animation: grainMove 6s linear infinite;
    pointer-events:none;
  }
  @keyframes grainMove{
    0%{transform: translate3d(0,0,0)}
    100%{transform: translate3d(-80px, 60px, 0)}
  }

  /* Stamp (KETA_MONO law) */
  #stamp{
    position:absolute;
    left:10px; right:10px; bottom:10px;
    display:flex; justify-content:space-between; gap:10px;
    padding:8px 10px;
    border:1px solid var(--line);
    background: rgba(0,0,0,.22);
    z-index:90;
    font-size:12px;
    line-height:1.2;
    opacity:.92;
    user-select:none;
    backdrop-filter: blur(6px);
  }
  #stamp .right{opacity:.72; text-align:right}

  /* reduced motion */
  body.rm *{animation:none !important}
</style>
</head>
<body>
<div id="root">

  <div id="top">
    <div class="rail">
      <span class="tag">KETA_MONO</span>
      <span class="sep">::</span>
      <span class="tag">GROTTO</span>
      <span class="sep">::</span>
      <span class="pill"><span class="sq"></span><span id="lux">LUX=56</span></span>
    </div>

    <div class="rail">
      <button class="m" id="rm" aria-pressed="false">MOTION</button>
      <span class="sep">::</span>
      <span class="readout" id="sig">AE/EE/WB</span>
    </div>
  </div>

  <div id="scene">
    <div id="grotto">
      <div class="cave"></div>

      <div id="water"></div>
      <div class="plant"></div>

      <div id="floor"></div>

      <!-- EDIT #1: separate canvases for parallax layers -->
      <canvas id="fxDust"></canvas>
      <canvas id="fxWall"></canvas>
      <canvas id="fxFloor"></canvas>
      <canvas id="fxTwk"></canvas>

      <div id="frames">
        <div class="frame f1"></div>
        <div class="frame f2"></div>
        <div class="frame f3"></div>
        <div class="frame f4"></div>
      </div>

      <div id="candles"></div>

      <div id="lounge">
        <div class="lamp" id="lampL"><div class="shade"></div><div class="stem"></div><div class="base"></div></div>
        <div id="couch"></div>
        <div id="table"></div>
        <div id="glass1"></div><div id="glass2"></div>
        <div class="lamp" id="lampR"><div class="shade"></div><div class="stem"></div><div class="base"></div></div>
      </div>

      <div id="grain"></div>

      <div id="stamp">
        <div>AE-KETA_MONO_GROTTO :: FILE_ID=KM_GROTTO_02 :: ROOM_ID=GROTTO</div>
        <div class="right">VERSION=2 :: UPDATED_AT=<span id="ts"></span> :: CHANGELOG=PARALLAX+MOUTH+WALL_SPARKLE</div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const grotto = $("grotto");

  // timestamp
  const iso = new Date().toISOString();
  $("ts").textContent = iso;

  // candles
  const candles = $("candles");
  const slots = [
    {x: 6,  h: 52},{x: 12, h: 62},{x: 18, h: 46},{x: 26, h: 58},
    {x: 34, h: 44},{x: 44, h: 54},{x: 54, h: 48},{x: 64, h: 60},
    {x: 76, h: 46}
  ];
  slots.forEach((s)=>{
    const c=document.createElement("div");
    c.className="candle";
    c.style.left = s.x+"%";
    c.style.height = s.h+"px";
    c.style.opacity = (0.72 + Math.random()*0.22).toFixed(2);
    const halo=document.createElement("div");
    halo.className="halo";
    halo.style.animationDelay = (-Math.random()*2.5)+"s";
    const flame=document.createElement("div");
    flame.className="flame";
    flame.style.animationDelay = (-Math.random()*0.9)+"s";
    c.appendChild(halo);
    c.appendChild(flame);
    candles.appendChild(c);
  });

  // motion toggle
  const rmBtn = $("rm");
  rmBtn.addEventListener("click", ()=>{
    const on = document.body.classList.toggle("rm");
    rmBtn.setAttribute("aria-pressed", on ? "true":"false");
  });

  // fit canvas
  function fitCanvas(c){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
    const r = grotto.getBoundingClientRect();
    c.width = Math.floor(r.width * dpr);
    c.height = Math.floor(r.height * dpr);
    const ctx = c.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return {ctx, w:r.width, h:r.height};
  }

  const Dust=$("fxDust"), Wall=$("fxWall"), Floor=$("fxFloor"), Twk=$("fxTwk");
  let d=fitCanvas(Dust), w=fitCanvas(Wall), f=fitCanvas(Floor), tC=fitCanvas(Twk);

  window.addEventListener("resize", ()=>{
    d=fitCanvas(Dust); w=fitCanvas(Wall); f=fitCanvas(Floor); tC=fitCanvas(Twk);
  }, {passive:true});

  const rand = (n=1)=>Math.random()*n;
  const clamp = (x,lo,hi)=>Math.max(lo,Math.min(hi,x));

  /* ===== EDIT #1: DENSITY + PARALLAX =====
     - Dust slow drift
     - Wall medium drift (new)
     - Floor faster drift
  */
  function makeSpark(count, layer){
    const arr=[];
    for(let i=0;i<count;i++){
      const baseR = layer===0 ? (0.55+rand(1.1)) : layer===1 ? (0.75+rand(1.4)) : (0.95+rand(2.0));
      const speed = layer===0 ? 0.020 : layer===1 ? 0.040 : 0.070;
      arr.push({
        x: rand(d.w),
        y: rand(d.h),
        r: baseR,
        vx: (rand(1)-0.5)*speed,
        vy: (rand(1)-0.5)*speed*0.8,
        tw: 0.7 + rand(1.7),
        ph: rand(Math.PI*2),
        a: layer===0 ? (0.06+rand(0.14)) : layer===1 ? (0.07+rand(0.18)) : (0.09+rand(0.22)),
        layer
      });
    }
    return arr;
  }

  // Dust increased slightly (parallax), Floor increased 35%, Twinkles increased a bit.
  const dust = makeSpark(520,0);
  const wall = makeSpark(520,1);   // EDIT #3: wall sparkle field driver
  const floor = makeSpark(1250,2); // EDIT #1: denser floor glitter
  const twk  = makeSpark(160,2);

  // Orbs (ambient)
  const orbs = Array.from({length:9}, ()=>({
    x: rand(d.w),
    y: rand(d.h),
    r: 70+rand(200),
    vx: (rand(1)-0.5)*0.020,
    vy: (rand(1)-0.5)*0.014,
    a: 0.04+rand(0.07),
    sp: 2.1+rand(3.2),
    ph: rand(Math.PI*2)
  }));

  function drawOrbs(ctx, W, H, ms){
    for(const o of orbs){
      o.x += o.vx*16; o.y += o.vy*16;
      if(o.x<-240) o.x=W+240; if(o.x>W+240) o.x=-240;
      if(o.y<-240) o.y=H+240; if(o.y>H+240) o.y=-240;

      const pulse = 0.55 + 0.45*Math.sin((ms/1000)*(1/o.sp) + o.ph);
      const a0 = o.a * pulse;

      const g = ctx.createRadialGradient(o.x,o.y,0,o.x,o.y,o.r);
      g.addColorStop(0, `rgba(255,255,255,${a0})`);
      g.addColorStop(0.55, `rgba(255,255,255,${a0*0.20})`);
      g.addColorStop(1, `rgba(255,255,255,0)`);
      ctx.fillStyle=g;
      ctx.fillRect(o.x-o.r, o.y-o.r, o.r*2, o.r*2);
    }
  }

  function drawSparks(ctx, W, H, ms, arr, bias){
    ctx.globalCompositeOperation="lighter";
    for(const p of arr){
      p.x += p.vx*16;
      p.y += p.vy*16;

      if(p.x<0) p.x+=W; if(p.x>W) p.x-=W;
      if(p.y<0) p.y+=H; if(p.y>H) p.y-=H;

      // bias target region
      let yy = p.y;
      if(bias==="floor"){
        const k = 0.35 + 0.65*Math.pow(clamp((p.y/H),0,1), 1.6);
        yy = p.y*(0.52) + (H*(0.64 + 0.36*k))*0.48;
      } else if(bias==="wall"){
        // EDIT #3: cluster sparkles on right wall behind couch
        // pull y upward and x rightwards subtly
        const xr = W*(0.62 + 0.36*Math.random());
        const yr = H*(0.16 + 0.40*Math.random());
        // not teleport; just bias render position
        p._rx = p._rx ?? xr;
        p._ry = p._ry ?? yr;
        const k = 0.55 + 0.45*Math.pow(clamp((p.x/W),0,1), 1.8);
        const j = 0.55 + 0.45*Math.pow(clamp((p.y/H),0,1), 1.2);
        const blend = 0.22;
        const xx = p.x*(1-blend) + p._rx*blend;
        yy = p.y*(1-blend) + p._ry*blend;
        p._xw = xx;
        p._yw = yy;
      }

      const tw = 0.35 + 0.65*Math.sin((ms/1000)*p.tw + p.ph);
      const alpha = clamp(p.a * (0.35 + 0.85*tw), 0, 1);

      const rr = p.r * (0.75 + 0.85*tw);
      const xDraw = bias==="wall" ? (p._xw ?? p.x) : p.x;
      const yDraw = bias==="wall" ? (p._yw ?? yy) : yy;

      const g = ctx.createRadialGradient(xDraw,yDraw,0,xDraw,yDraw,rr*2.3);
      g.addColorStop(0, `rgba(255,255,255,${alpha})`);
      g.addColorStop(0.38, `rgba(255,255,255,${alpha*0.40})`);
      g.addColorStop(1, `rgba(255,255,255,0)`);
      ctx.fillStyle=g;
      ctx.beginPath();
      ctx.arc(xDraw,yDraw,rr*2.0,0,Math.PI*2);
      ctx.fill();

      if(alpha>0.30 && Math.random()<0.012){
        ctx.fillStyle = `rgba(255,255,255,${alpha*0.40})`;
        ctx.fillRect(xDraw-0.5, yDraw-0.5, 1, 1);
      }
    }
    ctx.globalCompositeOperation="source-over";
  }

  // caustic shimmer (mono)
  function drawCaustic(ctx, W, H, ms){
    const tt = ms/1000;
    ctx.globalCompositeOperation="lighter";
    ctx.lineWidth = 1.2;
    ctx.strokeStyle = "rgba(255,255,255,0.055)";
    for(let i=0;i<28;i++){
      const y = (H*0.10) + i*(H*0.018) + Math.sin(tt*0.9 + i)*6;
      ctx.beginPath();
      for(let x=-40;x<W+40;x+=16){
        const yy = y + Math.sin(tt*1.6 + x*0.01 + i*0.5)*6 + Math.cos(tt*1.1 + x*0.02)*4;
        ctx.lineTo(x,yy);
      }
      ctx.stroke();
    }
    const g = ctx.createRadialGradient(W*0.26,H*0.18,0,W*0.26,H*0.18,Math.min(W,H)*0.62);
    g.addColorStop(0, "rgba(255,255,255,0.07)");
    g.addColorStop(0.55, "rgba(255,255,255,0.028)");
    g.addColorStop(1, "rgba(255,255,255,0)");
    ctx.fillStyle=g;
    ctx.fillRect(0,0,W,H);
    ctx.globalCompositeOperation="source-over";
  }

  function loop(ms){
    // Dust (slow) + orbs
    d.ctx.clearRect(0,0,d.w,d.h);
    drawOrbs(d.ctx, d.w, d.h, ms);
    drawSparks(d.ctx, d.w, d.h, ms, dust, null);

    // Wall sparkle field (medium)
    w.ctx.clearRect(0,0,w.w,w.h);
    drawSparks(w.ctx, w.w, w.h, ms, wall, "wall");

    // Floor glitter (fast)
    f.ctx.clearRect(0,0,f.w,f.h);
    drawSparks(f.ctx, f.w, f.h, ms, floor, "floor");

    // Twinkles + caustics (top)
    tC.ctx.clearRect(0,0,tC.w,tC.h);
    drawCaustic(tC.ctx, tC.w, tC.h, ms);

    tC.ctx.globalCompositeOperation="lighter";
    for(const p of twk){
      p.x += p.vx*26; p.y += p.vy*20;
      if(p.x<0) p.x+=tC.w; if(p.x>tC.w) p.x-=tC.w;
      if(p.y<0) p.y+=tC.h; if(p.y>tC.h) p.y-=tC.h;

      const tw = 0.3 + 0.7*Math.sin((ms/1000)*p.tw + p.ph);
      const alpha = clamp(0.10 + tw*0.44, 0, 1);
      const rr = 1.2 + tw*2.9;

      const g = tC.ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,rr*6.2);
      g.addColorStop(0, `rgba(255,255,255,${alpha})`);
      g.addColorStop(0.28, `rgba(255,255,255,${alpha*0.26})`);
      g.addColorStop(1, `rgba(255,255,255,0)`);
      tC.ctx.fillStyle=g;
      tC.ctx.beginPath();
      tC.ctx.arc(p.x,p.y,rr*5.1,0,Math.PI*2);
      tC.ctx.fill();

      if(alpha>0.52){
        tC.ctx.fillStyle=`rgba(255,255,255,${alpha*0.42})`;
        tC.ctx.fillRect(p.x-0.5,p.y-0.5,1,1);
      }
    }
    tC.ctx.globalCompositeOperation="source-over";

    // readouts
    const lux = (Math.sin((ms/1000)*0.75)*0.5+0.5);
    $("lux").textContent = "LUX=" + (lux*100).toFixed(0);
    $("sig").textContent = "AE/EE/WB :: KM_GROTTO_02 :: " + iso.slice(0,10);

    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
})();
</script>

<!--
AE :: KETA_MONO GROTTO (MONOCHROME GLITTER CAVE)
EE :: PARALLAX LAYERS (DUST / WALL / FLOOR / TWINKLE+CAUSTIC)
WB :: SINGLE-FILE / NO NETWORK

FILE_ID: KM_GROTTO_02
ROOM_ID: GROTTO
VERSION: 2
UPDATED_AT: 2026-01-08
CHANGELOG:
- PARALLAX: separated dust/wall/floor layers with distinct drift rates
- MOUTH: sharper cave opening silhouette (second edge)
- WALL_SPARKLE: clustered sparkle field behind couch region
-->
</body>
</html>
