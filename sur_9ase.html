<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KETADATA_DIVA9_SUR_BASE91_ITER_A__PATCHED_FULL.html</title>

<style>
:root{
  --bg:#000; --fg:#fff; --muted:#8a8a8a; --line:#222; --line2:#333;
  --top:44px; --bot:34px;

  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  --sans: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

  --ctl-radius:0px;
  --ctl-alpha:0.86;
  --ctl-bg: rgba(0,0,0,var(--ctl-alpha));
  --note-border: rgba(255,255,255,0.78);
  --drawer-h: 0.52;
}
*{box-sizing:border-box}
html,body{height:100%; margin:0}
body{background:var(--bg); color:var(--fg); font-family:var(--sans); overflow:hidden; user-select:none}
#root{position:fixed; inset:0; background:#000}
#root.invert{filter:invert(1)}

/* FULLSCREEN: hide chrome */
#root.fs .topbar,
#root.fs .bottombar,
#root.fs .drawer,
#root.fs .toast,
#root.fs .ketaNote,
#root.fs #armedBar,
#root.fs #pinnedPanel,
#root.fs #activeStrip,
#root.fs #padPanel,
#root.fs #playerPanel,
#root.fs #ytPanel,
#root.fs #anchor{display:none !important}

/* BLACKOUT/NULL: hard black */
#root.blackout .topbar,
#root.blackout .bottombar,
#root.blackout .drawer,
#root.blackout .toast,
#root.blackout .ketaNote,
#root.blackout #armedBar,
#root.blackout #pinnedPanel,
#root.blackout #activeStrip,
#root.blackout #padPanel,
#root.blackout #playerPanel,
#root.blackout #ytPanel{display:none !important}
#root.blackout #stage{background:#000 !important; filter:none !important}
#root.blackout #motion{display:none !important}
#root.blackout #anchor{display:block !important}

/* Stage */
#stage{position:absolute; inset:0; background:#000; pointer-events:none}
#motion{
  position:absolute; inset:0; pointer-events:none; opacity:0;
  background:repeating-linear-gradient(135deg, rgba(255,255,255,0.06) 0px, rgba(255,255,255,0.06) 1px, rgba(0,0,0,0) 12px, rgba(0,0,0,0) 22px);
  mix-blend-mode:screen;
  transform:translate3d(0,0,0);
}
#motion.run{opacity:0.12; animation:scanflow 2.2s linear infinite}
@keyframes scanflow{0%{transform:translate3d(-80px,60px,0)}100%{transform:translate3d(80px,-60px,0)}}

/* FULL SCREEN SURFACE */
#surfaceFrame{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  border:0;
  background:#000;
  z-index:1;
  display:none;
}
#surfaceFrame.on{display:block}

/* Top bar */
.topbar{
  position:absolute; top:0; left:0; right:0; height:var(--top);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 10px; border-bottom:1px solid var(--line);
  background:linear-gradient(180deg,#070707,#000);
  z-index:10;
}
.brand{display:flex; align-items:center; gap:10px; font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase}
.brand .sq{width:10px; height:10px; border:1px solid var(--fg); background:#000}
.roomBadge{display:flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted); border:1px solid var(--line2); padding:4px 8px}
.actions{display:flex; align-items:center; gap:8px; font-family:var(--mono); font-size:12px}
.btn{
  background:transparent; color:var(--fg);
  border:1px solid var(--line2);
  padding:6px 10px;
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.08em;
  text-transform:uppercase;
  cursor:pointer;
}
.btn:hover{border-color:var(--fg)}
.btn:active{transform:translateY(1px)}
.kbd{border:1px solid var(--line2); padding:2px 6px; color:var(--muted); font-size:11px}
.ketaIcon{
  width:16px; height:16px;
  border:2px solid var(--fg);
  background:var(--fg);
  cursor:pointer;
}
.ketaIcon.open{background:#000}

/* Bottom bar (NO PINNED/SETS toggles here; they live in drawer) */
.bottombar{
  position:absolute; left:0; right:0; bottom:0; height:var(--bot);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 10px; border-top:1px solid var(--line);
  background:linear-gradient(0deg,#070707,#000);
  z-index:10;
  font-family:var(--mono); font-size:11px; color:var(--muted);
}
.toggle{
  border:1px solid var(--line2);
  background:transparent;
  color:var(--fg);
  padding:4px 8px;
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
  cursor:pointer;
}
.toggle:hover{border-color:var(--fg)}

/* Drawer */
.drawer{
  position:absolute; left:0; right:0;
  bottom:var(--bot);
  height:calc((100vh - var(--top) - var(--bot)) * var(--drawer-h));
  min-height:220px;
  border-top:1px solid var(--line);
  background:linear-gradient(180deg,#060606,#000);
  display:none;
  z-index:20;
}
.drawer.open{display:flex; flex-direction:column}
.drawerSizer{
  height:10px;
  cursor:ns-resize;
  border-bottom:1px solid var(--line);
  background:linear-gradient(180deg,#0a0a0a,#050505);
  touch-action:none;
}
.drawerHead{
  padding:8px 10px;
  border-bottom:1px solid var(--line);
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.10em;
  text-transform:uppercase;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.drawerBody{padding:10px; min-height:0; flex:1; overflow:auto}
textarea{
  width:100%;
  border:1px solid var(--line2);
  background:#050505;
  color:var(--fg);
  font-family:var(--mono);
  font-size:12px;
  padding:10px;
  line-height:1.35;
  outline:none;
  resize:vertical;
  min-height:120px;
}
input{outline:none}

/* KETA NOTE */
.ketaNote{
  position:absolute; top:76px; right:16px; left:auto;
  width:340px; height:220px;
  display:none;
  z-index:30;
  resize:both;
  overflow:hidden;
  border-radius:var(--ctl-radius);
  background:var(--ctl-bg);
  border:1px solid var(--note-border);
  backdrop-filter:blur(6px);
}
.ketaNote.open{display:flex; flex-direction:column}
.ketaHead{
  padding:8px 10px;
  border-bottom:1px solid rgba(255,255,255,0.14);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.14em;
  text-transform:uppercase;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:move;
  touch-action:none;
}
.ketaBody{padding:10px; min-height:0; flex:1}
.ketaNote textarea{
  background:#000;
  color:#fff;
  border:1px solid rgba(255,255,255,0.22);
  width:100%;
  height:100%;
  resize:none;
  padding:10px;
  outline:none;
}
.headBtn{
  background:transparent;
  color:var(--fg);
  border:1px solid rgba(255,255,255,0.18);
  padding:2px 8px;
  font-family:var(--mono);
  font-size:12px;
  letter-spacing:.08em;
  text-transform:uppercase;
  cursor:pointer;
}
.headBtn:hover{border-color:rgba(255,255,255,0.6)}
.headBtn:active{transform:translateY(1px)}

/* Armed bar */
#armedBar{
  position:absolute; left:10px; top:calc(var(--top) + 10px);
  z-index:27;
  display:none;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
  padding:8px 10px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,0.86);
  font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase;
}
#armedBar .label{color:var(--muted)}
#armedBar .val{color:var(--fg)}
#armedBar input{
  background:#000; color:#fff; border:1px solid var(--line2);
  padding:6px 8px; font-family:var(--mono); font-size:11px; letter-spacing:.08em;
  width:340px; max-width:calc(100vw - 40px);
}

/* Pinned panel: GRID of draggable modules under ARMED */
#pinnedPanel{
  position:absolute; left:10px; top:calc(var(--top) + 64px);
  z-index:26;
  display:none;
  width:min(820px, calc(100vw - 20px));
  height:360px;
  padding:8px 10px;
  border:1px solid var(--line2);
  background:rgba(0,0,0,0.86);
  font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase;
  overflow:hidden;
}
.pinMod{
  position:absolute;
  width:190px;
  height:52px;
  border:1px solid rgba(255,255,255,0.22);
  background:rgba(0,0,0,0.35);
  color:var(--fg);
  display:flex;
  flex-direction:column;
  justify-content:center;
  padding:6px 8px;
  cursor:pointer;
  user-select:none;
}
.pinMod:hover{border-color:rgba(255,255,255,0.65)}
.pinMod .nm{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.pinMod .sub{color:var(--muted); font-size:10px; letter-spacing:.04em; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.pinMod .grip{
  position:absolute;
  right:6px; top:6px;
  width:10px; height:10px;
  border:1px solid rgba(255,255,255,0.22);
  background:rgba(0,0,0,0.25);
  cursor:move;
  touch-action:none;
}

/* Active strip (SETS strip) */
#activeStrip{
  position:absolute; left:10px; top:calc(var(--top) + 434px);
  z-index:25; display:none; gap:8px; flex-wrap:wrap; align-items:center;
  padding:8px 10px; border:1px solid var(--line2);
  background:rgba(0,0,0,0.86);
  font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase;
}
#activeStrip .label{color:var(--muted)}
.pill{
  border:1px solid rgba(255,255,255,0.22);
  background:rgba(0,0,0,0.25);
  color:var(--fg);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
  padding:6px 8px;
  cursor:pointer;
}
.pill:hover{border-color:rgba(255,255,255,0.65)}
.pill:active{transform:translateY(1px)}

/* Pad */
#padPanel{
  position:absolute;
  left:14px;
  top:calc(var(--top) + 170px);
  width:560px;
  height:420px;
  display:none;
  z-index:31;
  border:1px solid rgba(255,255,255,0.22);
  border-radius:var(--ctl-radius);
  background:rgba(0,0,0,0.86);
  backdrop-filter:blur(6px);
  overflow:hidden;
  resize:both;
  min-width:480px;
  min-height:320px;
}
#padPanel.open{display:flex; flex-direction:column}
#padHead{
  padding:8px 10px;
  border-bottom:1px solid rgba(255,255,255,0.14);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.14em;
  text-transform:uppercase;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:move;
  touch-action:none;
}
#padHead .tabs{display:flex; gap:8px}
#padHead .tabs button{
  height:24px;
  padding:0 8px;
  border:1px solid rgba(255,255,255,0.18);
  background:#000;
  color:#fff;
  font-family:var(--mono);
  font-size:11px;
  cursor:pointer;
}
#padHead .tabs button.on{
  border-color:rgba(255,255,255,0.55);
  background:rgba(255,255,255,0.06);
}
#padBody{padding:10px; min-height:0; flex:1; overflow:auto}
.padList{border:1px solid rgba(255,255,255,0.16); background:rgba(0,0,0,0.20)}
.padItem{
  display:flex; align-items:center; gap:8px;
  padding:8px;
  border-top:1px solid rgba(255,255,255,0.12);
  font-family:var(--mono);
  font-size:11px;
}
.padItem:first-child{border-top:none}
.padItem .name{
  width:160px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.padItem .url{
  flex:1;
  color:var(--muted);
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.padItem button{
  height:24px;
  padding:0 6px;
  font-size:10px;
  font-family:var(--mono);
  letter-spacing:.06em;
  text-transform:uppercase;
  background:#000;
  color:#fff;
  border:1px solid rgba(255,255,255,0.22);
  cursor:pointer;
}
.padItem button:hover{border-color:rgba(255,255,255,0.65)}
.padItem button:active{transform:translateY(1px)}
.chk{
  width:14px; height:14px;
  border:1px solid rgba(255,255,255,0.18);
  display:inline-block;
  background:#000;
  cursor:pointer;
}
.chk.on{background:var(--fg); border-color:var(--fg)}

/* Surface Player */
#playerPanel{
  position:absolute;
  right:14px;
  top:calc(var(--top) + 64px);
  width:380px;
  height:480px;
  display:none;
  z-index:32;
  border:1px solid rgba(255,255,255,0.22);
  border-radius:var(--ctl-radius);
  background:rgba(0,0,0,0.86);
  backdrop-filter:blur(6px);
  overflow:hidden;
  resize:both;
  min-width:360px;
  min-height:220px;
}
#playerPanel.open{display:flex; flex-direction:column}
#playerHead{
  padding:8px 10px;
  border-bottom:1px solid rgba(255,255,255,0.14);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.14em;
  text-transform:uppercase;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:move;
  touch-action:none;
}
#playerBody{padding:10px; min-height:0; flex:1; overflow:auto}
#playerPanel.collapsed{height:auto !important; min-height:0 !important}
#playerPanel.collapsed #playerBody{display:none !important}

.playerRow{
  border:1px solid rgba(255,255,255,0.18);
  padding:8px 10px;
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.06em;
  text-transform:uppercase;
  display:flex;
  gap:8px;
  align-items:center;
  cursor:pointer;
  user-select:none;
  touch-action:none;
}
.playerRow .nm{flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.playerRow .ix{color:var(--muted); width:24px}
.playerRow .acts{display:flex; gap:4px}
.miniBlk{
  background:#000 !important;
  color:#fff !important;
  border:1px solid rgba(255,255,255,0.22) !important;
  font-family:var(--mono);
  font-size:10px;
  letter-spacing:.06em;
  text-transform:uppercase;
  height:22px;
  padding:0 6px;
  cursor:pointer;
}
.miniBlk:hover{border-color:rgba(255,255,255,0.65) !important}
.miniBlk:active{transform:translateY(1px)}
.playerRow.isDragGhost{opacity:0.55; border-style:dashed}
.playerRow.isDropTarget{outline:1px solid rgba(255,255,255,0.7); outline-offset:1px}

/* YT mini screen */
#ytPanel{
  position:absolute;
  right:14px;
  top:calc(var(--top) + 564px);
  width:360px;
  height:260px;
  display:none;
  z-index:33;
  border:1px solid rgba(255,255,255,0.22);
  border-radius:var(--ctl-radius);
  background:rgba(0,0,0,0.86);
  backdrop-filter:blur(6px);
  overflow:hidden;
  resize:both;
  min-width:320px;
  min-height:220px;
}
#ytPanel.open{display:flex; flex-direction:column}
#ytHead{
  padding:8px 10px;
  border-bottom:1px solid rgba(255,255,255,0.14);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.14em;
  text-transform:uppercase;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:move;
  touch-action:none;
}
#ytBody{padding:10px; min-height:0; flex:1; overflow:auto}
#ytFrame{
  width:100%;
  aspect-ratio:16/9;
  border:1px solid rgba(255,255,255,0.18);
  background:#000;
}

/* Toast */
.toast{
  position:absolute;
  left:12px;
  top:calc(var(--top) + 12px);
  padding:8px 10px;
  border:1px solid var(--line2);
  background:rgba(8,8,8,0.82);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.06em;
  color:var(--fg);
  display:none;
  z-index:40;
}

/* SPEC NOTE MODULES */
.specNote{
  position:absolute;
  width:420px;
  height:300px;
  z-index:35;
  border:1px solid rgba(255,255,255,0.22);
  border-radius:var(--ctl-radius);
  background:rgba(0,0,0,0.96);
  backdrop-filter:blur(6px);
  overflow:hidden;
  resize:both;
  min-width:320px;
  min-height:220px;
  display:flex;
  flex-direction:column;
}
.specHead{
  padding:8px 10px;
  border-bottom:1px solid rgba(255,255,255,0.14);
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:.14em;
  text-transform:uppercase;
  display:flex;
  gap:8px;
  align-items:center;
  cursor:move;
  touch-action:none;
}
.specHead input{
  flex:1;
  height:24px;
  background:#000;
  color:#fff;
  border:1px solid rgba(255,255,255,0.22);
  padding:0 8px;
  font-family:var(--mono);
  font-size:11px;
}
.specBody{flex:1; padding:10px; display:flex}
.specBody textarea{
  width:100%;
  height:100%;
  background:#000;
  color:#fff;
  border:1px solid rgba(255,255,255,0.22);
  resize:none;
  padding:10px;
}
.specHead .headBtn{
  background:#000;
  color:#fff;
  border:1px solid rgba(255,255,255,0.22);
}
.specHead .headBtn:hover{border-color:rgba(255,255,255,0.65)}

/* anchor square bottom-right (ONLY visible in NULL/BLACKOUT) */
#anchor{
  position:absolute;
  right:10px;
  bottom:10px;
  width:10px;
  height:10px;
  border:1px solid rgba(255,255,255,0.65);
  background:transparent;
  z-index:999;
  cursor:pointer;
  display:none;
}

/* stage light aura */
:root{ --light:1; }
#stage::before{
  content:"";
  position:absolute; inset:0;
  pointer-events:none;
  background:
    radial-gradient(circle at 60% 40%,
      rgba(255,255,255, calc(0.02 * var(--light))) 0%,
      rgba(255,255,255, calc(0.01 * var(--light))) 28%,
      rgba(0,0,0,0) 62%);
  mix-blend-mode:screen;
}
</style>
</head>

<body>
<div id="root">

  <div id="stage"></div>
  <div id="motion" aria-hidden="true"></div>

  <iframe id="surfaceFrame" title="SURFACE"></iframe>

  <div id="armedBar">
    <span class="label">ARMED</span>
    <span class="val" id="armedName">—</span>
    <button class="btn" id="armedGo" style="padding:4px 8px; font-size:11px">GO</button>
    <button class="btn" id="armedNewTab" style="padding:4px 8px; font-size:11px">NEW TAB</button>
    <button class="btn" id="armedCopy" style="padding:4px 8px; font-size:11px">COPY URL</button>
    <input id="armedUrl" readonly value="—" />
  </div>

  <div id="pinnedPanel"></div>
  <div id="activeStrip"></div>

  <!-- PAD -->
  <div id="padPanel">
    <div id="padHead">
      <div class="tabs">
        <button class="on" data-tab="surfaces">SURFACES</button>
        <button data-tab="spaces">SPACES</button>
        <button data-tab="specs">SPECS</button>
        <button data-tab="schedule">SCHEDULE</button>
        <button data-tab="storage">STORAGE</button>
      </div>
      <div style="flex:1"></div>
      <button class="headBtn" id="padClose">X</button>
    </div>
    <div id="padBody"></div>
  </div>

  <!-- PLAYER -->
  <div id="playerPanel">
    <div id="playerHead">
      <span id="playerTitle">PLAYER</span>
      <div style="display:flex; gap:8px; align-items:center">
        <button class="headBtn" id="playerCollapse" title="COLLAPSE">—</button>
        <button class="headBtn" id="playerPrev">◀</button>
        <button class="headBtn" id="playerPlay">PLAY</button>
        <button class="headBtn" id="playerNext">▶</button>
        <button class="headBtn" id="playerClose">X</button>
      </div>
    </div>

    <div id="playerBody">
      <div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted); margin-bottom:8px">INPUT</div>
      <div style="display:flex; gap:8px; align-items:center">
        <input id="playerInputUrl" spellcheck="false" autocomplete="off"
          style="flex:1; background:#000; color:#fff; border:1px solid rgba(255,255,255,0.22); padding:6px 8px; font-family:var(--mono); font-size:11px; letter-spacing:.06em"
          placeholder="URL OR YOUTUBE LINK" />
        <button class="btn" id="playerAddInput" style="padding:4px 8px; font-size:11px">ADD</button>
        <button class="btn" id="playerSurfaceInput" style="padding:4px 8px; font-size:11px">SURFACE</button>
      </div>
      <div style="margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap">
        <button class="btn" id="playerInputToArmed" style="padding:4px 8px; font-size:11px">ARM INPUT</button>
        <button class="btn" id="playerInputClear" style="padding:4px 8px; font-size:11px">CLEAR</button>
        <button class="btn" id="playerOpenYT" style="padding:4px 8px; font-size:11px">YT</button>
      </div>

      <div style="margin-top:12px; border-top:1px solid var(--line); padding-top:10px">
        <div style="display:flex; gap:8px; align-items:center; justify-content:space-between">
          <div style="font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted)">NOW</div>
          <div id="playerNowLabel" style="font-family:var(--mono); font-size:11px; letter-spacing:.06em; text-transform:uppercase; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:240px">—</div>
        </div>

        <div style="margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap">
          <button class="btn" id="playerSurf" style="padding:4px 8px; font-size:11px">SURFACE</button>
          <button class="btn" id="playerNewTabNow" style="padding:4px 8px; font-size:11px">NEW TAB</button>
          <button class="btn" id="playerArmNow" style="padding:4px 8px; font-size:11px">ARM</button>
          <button class="btn" id="playerAddArmed" style="padding:4px 8px; font-size:11px">ADD ARMED</button>
        </div>

        <div style="margin-top:10px; border-top:1px solid var(--line); padding-top:10px">
          <div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted); margin-bottom:8px">BULK IMPORT</div>
          <textarea id="playerBulkInput" spellcheck="false" autocomplete="off"
            style="width:100%; background:#000; color:#fff; border:1px solid rgba(255,255,255,0.22); padding:6px 8px; font-family:var(--mono); font-size:11px; letter-spacing:.06em; min-height:80px; resize:vertical"
            placeholder="NAME | URL
OR URL (one per line)"></textarea>
          <div style="margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <button class="btn" id="playerImportBulk" style="padding:4px 8px; font-size:11px">IMPORT TO QUEUE</button>
            <button class="btn" id="playerClearBulk" style="padding:4px 8px; font-size:11px">CLEAR</button>
          </div>
        </div>

        <div style="margin-top:10px; border-top:1px solid var(--line); padding-top:10px">
          <div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted); margin-bottom:8px">LOAD SET</div>
          <div id="playerSetsList" style="display:flex; flex-direction:column; gap:6px; max-height:120px; overflow:auto"></div>
        </div>

        <div style="margin-top:10px; border-top:1px solid var(--line); padding-top:10px">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px">
        <div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted)">QUEUE</div>
          <button class="btn" id="playerStopSurface" style="padding:4px 8px; font-size:11px">STOP</button></div>
          <div id="playerQueue" style="display:flex; flex-direction:column; gap:6px"></div>
          <div style="margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <button class="btn" id="playerClear" style="padding:4px 8px; font-size:11px">CLEAR</button>
            <button class="btn" id="playerCreateSet" style="padding:4px 8px; font-size:11px">CREATE SET FROM QUEUE</button>
          </div>

          <div style="margin-top:10px; color:var(--muted); font-family:var(--mono); font-size:11px">
            CLICK = SELECT. DRAG = REORDER (SMOOTH).
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- YT MINI SCREEN (APPLY + ARMED swapped) -->
  <div id="ytPanel">
    <div id="ytHead">
      <span id="ytTitle">YT</span>
      <div style="display:flex; gap:8px; align-items:center">
        <button class="headBtn" id="ytArmed">ARMED</button>
        <button class="headBtn" id="ytClose">X</button>
      </div>
    </div>
    <div id="ytBody">
      <div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted); margin-bottom:8px">EMBED</div>

      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px">
        <input id="ytInput" spellcheck="false" autocomplete="off"
          style="flex:1; background:#000; color:#fff; border:1px solid rgba(255,255,255,0.22); padding:6px 8px; font-family:var(--mono); font-size:11px; letter-spacing:.06em"
          placeholder="YOUTUBE URL / VIDEO ID / PLAYLIST ID" />
        <button class="btn" id="ytApply" style="padding:4px 8px; font-size:11px">APPLY</button>
      </div>

      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; font-family:var(--mono); font-size:11px; letter-spacing:.06em; text-transform:uppercase; color:var(--muted)">
        <label style="display:flex; gap:6px; align-items:center"><input type="checkbox" id="ytAutoplay" />AUTOPLAY</label>
        <label style="display:flex; gap:6px; align-items:center"><input type="checkbox" id="ytMute" />MUTE</label>
        <label style="display:flex; gap:6px; align-items:center"><input type="checkbox" id="ytLoop" />LOOP</label>
        <label style="display:flex; gap:6px; align-items:center"><input type="checkbox" id="ytControls" checked />CONTROLS</label>
        <label style="display:flex; gap:6px; align-items:center"><input type="checkbox" id="ytNoCookie" checked />NOCOOKIE</label>
      </div>

      <div style="margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap">
        <button class="btn" id="ytOpenTab" style="padding:4px 8px; font-size:11px">NEW TAB</button>
        <button class="btn" id="ytClear" style="padding:4px 8px; font-size:11px">CLEAR</button>
      </div>

      <div style="margin-top:10px">
        <iframe id="ytFrame" title="YT"
          referrerpolicy="no-referrer"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen></iframe>
      </div>

      <div style="margin-top:10px; color:var(--muted); font-family:var(--mono); font-size:11px">
        INPUT: VIDEO URL/ID OR PLAYLIST ID. APPLY BUILDS EMBED. (NOCOOKIE DEFAULT)
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- TOP BAR -->
  <div class="topbar">
    <div style="display:flex; gap:10px; align-items:center">
      <div class="brand">
        <span class="sq"></span>
        <span>KETADATA // SHELL8 // KERNEL</span>
        <span style="color:var(--muted); letter-spacing:.02em; text-transform:none">v2 · SUR_BASE91</span>
      </div>
      <div class="roomBadge"><span>ROOM</span><span id="roomName">SUR_BASE</span></div>
    </div>

    <div class="actions">
      <button class="btn" id="btnImport">IMPORT</button>
      <button class="btn" id="btnExport">EXPORT</button>
      <button class="btn" id="btnCopy">COPY</button>
      <span class="kbd" id="lightQuick" title="LIGHT 1–6">L1</span>

      <span class="kbd" title="Run">Space</span>
      <span class="kbd" title="Invert">Shift+I</span>
      <span class="kbd" title="Blackout">Shift+0</span>
      <span class="kbd" title="Fullscreen">Shift+F</span>
      <span class="kbd" title="Landing">Shift+K</span>

      <div id="ketaIcon" class="ketaIcon" title="KETA_NOTE"></div>
    </div>
  </div>

  <!-- DRAWER -->
  <div class="drawer" id="drawer">
    <div class="drawerSizer" id="drawerSizer" title="DRAG"></div>

    <div class="drawerHead">
      <div>SYSTEM</div>
      <div style="display:flex; gap:8px; align-items:center">
        <span id="sig" style="color:var(--muted); font-family:var(--mono); font-size:11px">∅</span>
        <button class="btn" id="btnTogglePinnedStrip">PINNED</button>
        <button class="btn" id="btnToggleSetsStrip">SETS</button>
        <button class="btn" id="btnToggleMotion">MOTION</button>
        <button class="btn" id="btnCloseDrawer">CLOSE</button>
      </div>
    </div>

    <div class="drawerBody">

      <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px">
        <div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted)">SYSTEM UNIVERSALS / REFERENCES</div>
        <button class="btn" id="btnNewSpec" style="padding:4px 8px; font-size:11px">+ SPEC</button>
        <button class="btn" id="btnToggleUniversals" style="padding:4px 8px; font-size:11px">TOGGLE</button>
      </div>
      <textarea id="universals" spellcheck="false" autocomplete="off" placeholder="LAWS / REFERENCES"></textarea>

      <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap" id="specList"></div>

      <div style="margin-top:12px; border-top:1px solid var(--line); padding-top:10px">
        <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px">
          <div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted)">SYSTEM STORAGE</div>
          <button class="btn" id="btnOpenStoragePad" style="padding:4px 8px; font-size:11px">OPEN IN PAD</button>
          <button class="btn" id="btnToggleStorage" style="padding:4px 8px; font-size:11px">TOGGLE</button>
        </div>

        <div id="storageBody">
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px">
            <span style="font-family:var(--mono); font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted)">
              ITEMS: <span id="storageCount">0</span> · BYTES: <span id="storageBytes">0</span>
            </span>
          </div>

          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px">
            <button class="btn" id="btnExportState" style="padding:4px 8px; font-size:11px">EXPORT STATE</button>
            <button class="btn" id="btnExportAll" style="padding:4px 8px; font-size:11px">EXPORT ALL</button>
            <button class="btn" id="btnClearBase" style="padding:4px 8px; font-size:11px">CLEAR BASE</button>
          </div>

          <div style="color:var(--muted); font-family:var(--mono); font-size:10px">
            STORAGE PAD SUPPORTS PER-KEY EXPAND + EXPORT.
          </div>
        </div>
      </div>

      <div style="margin-top:12px; border-top:1px solid var(--line); padding-top:10px">
        <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px">
          <div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted)">SURFACE REGISTRY</div>
          <button class="btn" id="btnToggleSurfaces" style="padding:4px 8px; font-size:11px">TOGGLE</button>
        </div>

        <div id="surfacesBody">
          <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px">
            <input id="newSurfaceName" spellcheck="false" autocomplete="off"
              style="flex:1; background:#000; color:#fff; border:1px solid var(--line2); padding:6px 8px; font-family:var(--mono); font-size:11px"
              placeholder="NAME (OPTIONAL)" />
            <input id="newSurfaceUrl" spellcheck="false" autocomplete="off"
              style="flex:1; background:#000; color:#fff; border:1px solid var(--line2); padding:6px 8px; font-family:var(--mono); font-size:11px"
              placeholder="URL" />
            <button class="btn" id="btnAddSurface" style="padding:4px 8px; font-size:11px">ADD</button>
          </div>

          <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap">
            <textarea id="surfaceBulk" spellcheck="false" autocomplete="off"
              style="min-height:64px; resize:vertical; background:#000; border:1px solid rgba(255,255,255,0.22); color:#fff; padding:8px; font-family:var(--mono); font-size:11px; letter-spacing:.06em"
              placeholder="BULK ADD (ONE PER LINE):
NAME | URL
OR URL"></textarea>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
              <button class="btn" id="btnSurfaceBulkAdd" style="padding:4px 8px; font-size:11px">BULK ADD</button>
              <button class="btn" id="btnSurfaceBulkToQueue" style="padding:4px 8px; font-size:11px">BULK → QUEUE</button>
              <button class="btn" id="btnSurfaceBulkClear" style="padding:4px 8px; font-size:11px">CLEAR</button>
            </div>
          </div>

          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px">
            <button class="btn" id="btnPinnedToQueue" style="padding:4px 8px; font-size:11px">PINNED → QUEUE</button>
            <button class="btn" id="btnPinnedCreateSet" style="padding:4px 8px; font-size:11px">SET FROM PINNED</button>
            <button class="btn" id="btnOpenPad" style="padding:4px 8px; font-size:11px">OPEN PAD</button>
          </div>

          <div id="surfaceList" style="display:flex; flex-direction:column; gap:6px; margin-bottom:8px; max-height:200px; overflow:auto"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- BOTTOM BAR -->
  <div class="bottombar">
    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
      <button class="toggle" id="toggleSystem">SYSTEM</button>
      <button class="toggle" id="toggleRun">RUN</button>
      <button class="toggle" id="togglePlayer">PLAYER</button>
      <button class="toggle" id="togglePad">PAD</button>
      <span>STATE: <span id="sig2">∅</span></span>
      <span style="margin-left:8px">FS: <span id="fsLabel">OFF</span></span>
      <span style="margin-left:8px">BLK: <span id="blkLabel">OFF</span></span>
      <span style="margin-left:8px">LIGHTS: <span style="color:var(--fg)">1–6</span></span>
    </div>
    <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap">
      <span>LIGHT: <span id="lightLabel">1</span></span>
      <span>RUN: <span id="runLabel">OFF</span></span>
      <span>MOTION: <span id="motionLabel">OFF</span></span>
      <span>SURFACE: <span id="surfaceLabel">—</span></span>
    </div>
  </div>

  <!-- KETA NOTE -->
  <div class="ketaNote" id="ketaNote">
    <div class="ketaHead" id="ketaHead">
      <div>KETA_NOTE</div>
      <button class="headBtn" id="btnHideNote">-</button>
    </div>
    <div class="ketaBody">
      <textarea id="ketaText" spellcheck="false" autocomplete="off" placeholder="GLOBAL NOTE"></textarea>
    </div>
  </div>

  <div id="anchor" title="ANCHOR (EXIT NULL)"></div>

  <input id="file" type="file" accept="application/json" style="display:none" />
</div>

<script>
function nowISO(){return new Date().toISOString();}
const $=(id)=>document.getElementById(id);

const root=$("root");
const stage=$("stage");
const motion=$("motion");
const lightQuick=$("lightQuick");
const surfaceFrame=$("surfaceFrame");
const ytFrame=$("ytFrame");

/* ===== utilities ===== */
function uid8(){
  const a=new Uint32Array(1);
  try{crypto.getRandomValues(a);}catch(e){a[0]=Math.floor(Math.random()*1e9);}
  return (a[0]>>>0).toString(16).padStart(8,"0");
}
function hash8(str){
  const s=String(str||"");
  let h=2166136261;
  for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,16777619);}
  return (h>>>0).toString(16).slice(0,8);
}
function canonName(x){return String(x||"").trim().toUpperCase();}
function clamp(n,min,max){return Math.max(min,Math.min(max,n));}
function escHtml(s){
  return String(s??"").replace(/[&<>"']/g,m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
function deriveNameFromUrl(url){
  try{
    const u=new URL(url, location.href);
    const path=(u.pathname||"").split("/").filter(Boolean);
    const last=path.length?path[path.length-1]:(u.hostname||"LINK");
    return String(last).replace(/\.(html?|php|aspx|jsp)$/i,"").replace(/[-_]+/g," ").trim().toUpperCase()||"LINK";
  }catch(e){
    return String(url||"LINK").trim().slice(0,28).toUpperCase()||"LINK";
  }
}
function parseBulkLines(text){
  return String(text||"").split(/\r?\n/).map(l=>l.trim()).filter(l=>l && !l.startsWith("#")).map(l=>{
    let name="", url="";
    if(l.includes("|")){
      const parts=l.split("|");
      name=(parts[0]||"").trim();
      url=(parts.slice(1).join("|")||"").trim();
    }else url=l.trim();
    if(!url && name){ url=name; name=""; }
    if(!name) name=deriveNameFromUrl(url);
    return {name,url};
  }).filter(x=>x.url);
}
function safeRectFromEl(el){
  const r=el.getBoundingClientRect();
  return {x:r.left, y:r.top, w:r.width, h:r.height};
}

/* ===== local-first state ===== */
const PAGE_ID = "SUR_BASE91_ITER_A";
const KEY_PREFIX = "KDT::BASE::INDEP::" + hash8(location.pathname + "|" + PAGE_ID);
const STORAGE_KEY_MAIN   = KEY_PREFIX + "::STATE";
const STORAGE_KEY_BACKUP = KEY_PREFIX + "::STATE::BACKUP";
const STORAGE_KEY_TMP    = KEY_PREFIX + "::STATE::TMP";

function loadFromKey(key){
  try{ const raw=localStorage.getItem(key); if(!raw) return null; return JSON.parse(raw); }
  catch(e){ return null; }
}

const DEFAULT={
  version:"SUR_BASE91_ITER_A",
  updatedAt:nowISO(),
  ketaNote:"",
  universals:"",
  ui:{
    invert:false,
    blackout:false,
    fullscreen:false,

    lightPreset:0,
    lightRunning:false,
    motionOn:false,

    drawerOpen:false,
    noteOpen:false,

    universalsCollapsed:false,
    storageCollapsed:false,
    surfacesCollapsed:false,

    pinnedStripOn:true,
    setsStripOn:true,

    padOpen:false,
    padTab:"surfaces",
    padRect:{x:null,y:null,w:560,h:420},

    playerOpen:true,
    playerCollapsed:false,
    playerRect:{x:null,y:null,w:380,h:480},
    player:{queue:[], index:0, playing:false},

    pinnedPos:{},
    recent:[],

    ytOpen:false,
    ytRect:{x:null,y:null,w:360,h:260},
    yt:{
      input:"",
      autoplay:true,
      mute:true,
      loop:false,
      controls:true,
      nocookie:true,
      lastEmbedSrc:""
    },

    noteRect:{x:null,y:76,w:340,h:220},
    drawerH:0.52,

    surfaceUrl:"",
    surfaceLabel:""
  },
  payload:{
    sets:[],
    surfaces:[],
    specs:[],
    schedule:[]
  }
};

function deepFill(s){
  if(!s || typeof s!=="object") return structuredClone(DEFAULT);

  for(const k of Object.keys(DEFAULT)){ if(s[k]===undefined) s[k]=structuredClone(DEFAULT[k]); }
  if(!s.ui || typeof s.ui!=="object") s.ui={};
  for(const k of Object.keys(DEFAULT.ui)){ if(s.ui[k]===undefined) s.ui[k]=structuredClone(DEFAULT.ui[k]); }
  if(!s.payload || typeof s.payload!=="object") s.payload={};
  for(const k of Object.keys(DEFAULT.payload)){ if(s.payload[k]===undefined) s.payload[k]=structuredClone(DEFAULT.payload[k]); }

  if(!Array.isArray(s.payload.sets)) s.payload.sets=[];
  if(!Array.isArray(s.payload.surfaces)) s.payload.surfaces=[];
  if(!Array.isArray(s.payload.specs)) s.payload.specs=[];
  if(!Array.isArray(s.payload.schedule)) s.payload.schedule=[];

  if(!s.ui.pinnedPos || typeof s.ui.pinnedPos!=="object") s.ui.pinnedPos={};
  if(!s.ui.padRect || typeof s.ui.padRect!=="object") s.ui.padRect=structuredClone(DEFAULT.ui.padRect);
  if(!s.ui.playerRect || typeof s.ui.playerRect!=="object") s.ui.playerRect=structuredClone(DEFAULT.ui.playerRect);
  if(!s.ui.player || typeof s.ui.player!=="object") s.ui.player=structuredClone(DEFAULT.ui.player);
  if(!Array.isArray(s.ui.recent)) s.ui.recent=[];
  if(!s.ui.ytRect || typeof s.ui.ytRect!=="object") s.ui.ytRect=structuredClone(DEFAULT.ui.ytRect);
  if(!s.ui.yt || typeof s.ui.yt!=="object") s.ui.yt=structuredClone(DEFAULT.ui.yt);

  if(!Array.isArray(s.ui.player.queue)) s.ui.player.queue=[];
  if(typeof s.ui.player.index!=="number") s.ui.player.index=0;
  if(typeof s.ui.player.playing!=="boolean") s.ui.player.playing=false;
  if(typeof s.ui.playerCollapsed!=="boolean") s.ui.playerCollapsed=false;

  if(typeof s.ui.yt.input!=="string") s.ui.yt.input="";
  if(typeof s.ui.yt.autoplay!=="boolean") s.ui.yt.autoplay=true;
  if(typeof s.ui.yt.mute!=="boolean") s.ui.yt.mute=true;
  if(typeof s.ui.yt.loop!=="boolean") s.ui.yt.loop=false;
  if(typeof s.ui.yt.controls!=="boolean") s.ui.yt.controls=true;
  if(typeof s.ui.yt.nocookie!=="boolean") s.ui.yt.nocookie=true;
  if(typeof s.ui.yt.lastEmbedSrc!=="string") s.ui.yt.lastEmbedSrc="";

  if(!s.ui.noteRect || typeof s.ui.noteRect!=="object") s.ui.noteRect=structuredClone(DEFAULT.ui.noteRect);
  if(typeof s.ui.drawerH!=="number") s.ui.drawerH=DEFAULT.ui.drawerH;

  s.payload.sets = s.payload.sets.map(set=>{
    const id=String((set&&set.id)||"").trim() || `SET_${uid8()}`;
    const label=canonName((set&&set.label)||"SET") || "SET";
    const items=Array.isArray(set&&set.items)?set.items:[];
    const normItems=items.map(it=>{
      const url=String((it&&it.url)||"").trim(); if(!url) return null;
      const label2=canonName((it&&it.label)||"") || deriveNameFromUrl(url);
      return {label:label2,url};
    }).filter(Boolean);
    return {id,label,items:normItems,createdAt:(set&&set.createdAt)||nowISO(),updatedAt:(set&&set.updatedAt)||nowISO()};
  });

  s.payload.surfaces = s.payload.surfaces.map(surf=>{
    const id=String((surf&&surf.id)||"").trim() || `SURF_${uid8()}`;
    const name=canonName((surf&&surf.name)||"") || "";
    const url=String((surf&&surf.url)||"").trim();
    const pinned=!!(surf&&surf.pinned);
    return {id,name,url,pinned};
  });

  s.payload.specs = s.payload.specs.map(spec=>{
    const id=String((spec&&spec.id)||"").trim() || `SPEC_${uid8()}`;
    const name=String((spec&&spec.name)||"").trim();
    const body=String((spec&&spec.body)||"").trim();
    const createdAt=(spec&&spec.createdAt)||nowISO();
    return {id,name,body,createdAt};
  });

  s.payload.schedule = s.payload.schedule.map(b=>{
    const id=String((b&&b.id)||"").trim()||`BLK_${uid8()}`;
    const day=String((b&&b.day)||"").trim()||nowISO().slice(0,10);
    const start=String((b&&b.start)||"").trim()||"09:00";
    const end=String((b&&b.end)||"").trim()||"10:00";
    const label=String((b&&b.label)||"").trim()||"BLOCK";
    return {id,day,start,end,label};
  });

  return s;
}

let STATE = deepFill(loadFromKey(STORAGE_KEY_MAIN) || loadFromKey(STORAGE_KEY_BACKUP) || null);
let _BOOTING=true;

/* ===== toast/copy ===== */
let toastTimer=null;
function toast(msg){
  if(STATE.ui.blackout || STATE.ui.fullscreen) return;
  const t=$("toast");
  t.textContent=msg;
  t.style.display="block";
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>{t.style.display="none";},900);
}
async function copy(text){
  try{await navigator.clipboard.writeText(String(text||"")); toast("COPIED");}
  catch(e){toast("COPY FAILED");}
}

/* ===== signature/persist ===== */
function stableSig(){
  const core=JSON.stringify({
    v:STATE.version,
    k:hash8(STATE.ketaNote||""),
    i:STATE.ui.invert,
    f:STATE.ui.fullscreen,
    b:STATE.ui.blackout,
    p:STATE.ui.lightPreset,
    r:STATE.ui.lightRunning,
    m:STATE.ui.motionOn,
    dh:STATE.ui.drawerH,
    surface:STATE.ui.surfaceUrl,
    player:hash8(JSON.stringify({q:STATE.ui.player.queue, i:STATE.ui.player.index, on:STATE.ui.player.playing, c:STATE.ui.playerCollapsed})),
    yt:hash8(JSON.stringify(STATE.ui.yt)),
    pinnedPos:hash8(JSON.stringify(STATE.ui.pinnedPos||{})),
    setsSig:hash8(JSON.stringify((STATE.payload.sets||[]).map(s=>({id:s.id,l:s.label,n:(s.items||[]).length,u:s.updatedAt||""})))),
    surfsSig:hash8(JSON.stringify((STATE.payload.surfaces||[]).map(s=>({id:s.id,n:s.name,u:s.url,p:s.pinned})))),
    specsSig:hash8(JSON.stringify((STATE.payload.specs||[]).map(s=>({id:s.id,n:s.name,c:s.createdAt}))))
  });
  let h=2166136261;
  for(let i=0;i<core.length;i++){h^=core.charCodeAt(i);h=Math.imul(h,16777619);}
  return (h>>>0).toString(16).slice(0,8);
}

function persist(silent=false){
  if(_BOOTING) return;
  STATE.updatedAt=nowISO();
  root.style.setProperty("--drawer-h", String(STATE.ui.drawerH));

  const blob=JSON.stringify(STATE);
  try{
    localStorage.setItem(STORAGE_KEY_TMP, blob);
    localStorage.setItem(STORAGE_KEY_MAIN, blob);
    localStorage.setItem(STORAGE_KEY_BACKUP, blob);
  }catch(e){}
  if(!silent) render();
}

(function(){
  const flush=()=>{ try{ persist(true); }catch(e){} };
  window.addEventListener("pagehide", flush, {capture:true});
  window.addEventListener("beforeunload", flush, {capture:true});
  document.addEventListener("visibilitychange", ()=>{ if(document.visibilityState==="hidden") flush(); }, {capture:true});
})();

/* ===== ARMED ===== */
let ARMED={name:"", url:""};
function arm(name,url){
  ARMED.name=canonName(name||"LINK")||"LINK";
  ARMED.url=String(url||"").trim();
  $("armedName").textContent=ARMED.name||"—";
  $("armedUrl").value=ARMED.url||"—";
  $("armedBar").style.display = (ARMED.url && !(STATE.ui.blackout||STATE.ui.fullscreen)) ? "flex":"none";
}
function finalizeBeforeNav(){ persist(true); }
function go(url){
  const u=String(url||"").trim(); if(!u) return;
  finalizeBeforeNav();
  window.location.href=u;
}
function openNewTab(url){
  const u=String(url||"").trim(); if(!u) return;
  finalizeBeforeNav();
  window.open(u,"_blank","noopener,noreferrer");
}

/* ===== Surface ===== */
const DEFAULT_SURFACE_ORIGIN = "https://ketadata.com/";
function normalizeSurfaceUrl(raw){
  const u = String(raw||"").trim();
  if(!u) return "";
  if(/^(https?:|about:|data:|blob:)/i.test(u)) return u;
  try{
    if(window.location && window.location.protocol !== "file:" && window.location.href){
      return new URL(u, window.location.href).href;
    }
  }catch(e){}
  return DEFAULT_SURFACE_ORIGIN + u.replace(/^\/+/, "");
}
function noteRecent(url,label){
  const u=String(url||"").trim();
  if(!u) return;
  const lab=canonName(label||"")||deriveNameFromUrl(u);
  const rec=STATE.ui.recent || (STATE.ui.recent=[]);
  for(let i=rec.length-1;i>=0;i--){ if(rec[i] && String(rec[i].url)===u) rec.splice(i,1); }
  rec.unshift({url:u,label:lab,at:nowISO()});
  if(rec.length>80) rec.length=80;
}
function applySurface(url,label){
  const raw=String(url||"").trim();
  const u=normalizeSurfaceUrl(raw);
  const lab = canonName(label||"") || (u?deriveNameFromUrl(u):"");
  STATE.ui.surfaceUrl=u;
  STATE.ui.surfaceLabel=lab;
  $("surfaceLabel").textContent = u ? lab : "—";
  if(!u){
    surfaceFrame.classList.remove("on");
    surfaceFrame.removeAttribute("src");
    return;
  }
  surfaceFrame.classList.add("on");
  surfaceFrame.src = u;
  noteRecent(u,lab);
}
function clearSurfacePlaying(){
  STATE.ui.surfaceUrl="";
  STATE.ui.surfaceLabel="";
  surfaceFrame.classList.remove("on");
  surfaceFrame.removeAttribute("src");
  $("surfaceLabel").textContent="—";
}

/* ===== Lights ===== */
let lightInterval=null;
let lightCount=0, lightAuxA=0, lightAuxB=0;
function resetStage(){ stage.style.backgroundColor="#000"; stage.style.filter="none"; lightCount=0; lightAuxA=0; lightAuxB=0; }
function stopLight(silent=false){
  if(lightInterval){clearInterval(lightInterval); lightInterval=null;}
  STATE.ui.lightRunning=false; resetStage();
  if(!silent) persist(false);
}
function startLight(preset){
  stopLight(true);
  resetStage();
  STATE.ui.lightPreset=preset;
  STATE.ui.lightRunning=true;

  if(preset===1){
    lightInterval=setInterval(()=>{
      const curr=stage.style.backgroundColor||"black";
      stage.style.backgroundColor=(curr==="black"||curr==="rgb(0, 0, 0)")?"white":"black";
      stage.style.filter="none";
    },50);
  }else if(preset===2){
    lightInterval=setInterval(()=>{
      lightAuxA=(lightAuxA+30)%360; lightAuxB+=0.5;
      const l=50+Math.sin(lightAuxB)*40;
      stage.style.backgroundColor=`hsl(${lightAuxA},100%,${l}%)`;
      stage.style.filter="none";
    },10);
  }else if(preset===3){
    lightInterval=setInterval(()=>{
      lightCount++;
      const beat=lightCount%16;
      if(beat===0||beat===1){stage.style.backgroundColor="#fff";stage.style.filter="invert(1) contrast(3) brightness(2)";}
      else if(beat===2){stage.style.backgroundColor="#000";stage.style.filter="invert(1) contrast(2)";}
      else if(beat===3){stage.style.backgroundColor="#0f0";stage.style.filter="contrast(2) saturate(3)";}
      else if(beat===4){stage.style.backgroundColor="#f0f";stage.style.filter="invert(1) hue-rotate(90deg)";}
      else if(beat===5||beat===6){stage.style.backgroundColor="#0ff";stage.style.filter="invert(0.7) contrast(2)";}
      else if(beat===7){stage.style.backgroundColor="#fff";stage.style.filter="invert(1) brightness(3)";}
      else if(beat===8){stage.style.backgroundColor="#000";stage.style.filter="invert(1) contrast(3)";}
      else if(beat===9||beat===10){stage.style.backgroundColor="#0f0";stage.style.filter="saturate(5) contrast(2)";}
      else if(beat===11){stage.style.backgroundColor="#f0f";stage.style.filter="invert(1) saturate(3)";}
      else {stage.style.backgroundColor="#08f";stage.style.filter="contrast(1.5) brightness(1.2)";}
    },30);
  }else if(preset===4){
    lightInterval=setInterval(()=>{
      lightAuxA+=0.08; lightCount++;
      const red=Math.abs(Math.sin(lightAuxA))*255;
      const pulse=Math.abs(Math.sin(lightAuxA*0.5));
      const contrast=2+pulse*2;
      const saturation=4+pulse*2;
      if(lightCount%8===0){stage.style.backgroundColor="#000";stage.style.filter="brightness(3) contrast(3)";}
      else{
        stage.style.backgroundColor=`rgb(${red},0,0)`;
        stage.style.filter=`contrast(${contrast}) saturate(${saturation}) brightness(${1.2+pulse*0.5})`;
      }
    },20);
  }else if(preset===5){
    lightInterval=setInterval(()=>{
      lightAuxA+=15; lightAuxB=(lightAuxB+2)%100;
      const hue=260+Math.sin(lightAuxA*0.1)*40;
      const saturation=80+Math.cos(lightAuxA*0.05)*20;
      const lightness=30+Math.sin(lightAuxB*0.1)*30;
      const spiralBrightness=1+Math.abs(Math.sin(lightAuxA*0.05))*0.8;
      const spiralContrast=1.5+Math.abs(Math.cos(lightAuxA*0.08))*1;
      stage.style.backgroundColor=`hsl(${hue},${saturation}%,${lightness}%)`;
      stage.style.filter=`contrast(${spiralContrast}) saturate(2) brightness(${spiralBrightness}) hue-rotate(${lightAuxA*0.5}deg)`;
    },25);
  }else if(preset===6){
    lightInterval=setInterval(()=>{
      lightCount++;
      if(lightCount%50===0||lightCount%50===2){stage.style.backgroundColor="#fff";stage.style.filter="brightness(5) contrast(5)";}
      else{stage.style.backgroundColor="#000";stage.style.filter="none";}
    },30);
  }

  persist(false);
}
function selectPreset(p){
  STATE.ui.lightPreset=p;
  if(STATE.ui.lightRunning) startLight(p);
  else persist(false);
}
function toggleRun(){
  if(STATE.ui.blackout) return;
  if(STATE.ui.lightRunning) stopLight(false);
  else startLight(STATE.ui.lightPreset||1);
}
function setLight(n){
  n = clamp(Number(n)||1,1,6);
  STATE.ui.lightPreset = n;
  document.documentElement.style.setProperty("--light", String(n));
  $("lightLabel").textContent = String(n);
  if(lightQuick) lightQuick.textContent = "L"+String(n);
  persist(false);
}

/* ===== Motion / modes ===== */
function syncMotion(){
  if(STATE.ui.motionOn) motion.classList.add("run");
  else motion.classList.remove("run");
}
function setDrawer(on){
  STATE.ui.drawerOpen=!!on;
  if(on) STATE.ui.blackout=false;
  persist(false);
}
function setKetaNote(on){
  STATE.ui.noteOpen=!!on;
  if(on) STATE.ui.blackout=false;
  persist(false);
}
function setInvert(on){ STATE.ui.invert=!!on; persist(false); }

let BLACKOUT_CACHE=null;
function setBlackout(on){
  const next=!!on;
  if(next && !STATE.ui.blackout){
    BLACKOUT_CACHE={
      drawerOpen:!!STATE.ui.drawerOpen,
      noteOpen:!!STATE.ui.noteOpen,
      motionOn:!!STATE.ui.motionOn,
      lightRunning:!!STATE.ui.lightRunning,
      lightPreset:Number(STATE.ui.lightPreset||1),
      padOpen:!!STATE.ui.padOpen,
      playerOpen:!!STATE.ui.playerOpen,
      playerCollapsed:!!STATE.ui.playerCollapsed,
      ytOpen:!!STATE.ui.ytOpen,
      pinnedStripOn:!!STATE.ui.pinnedStripOn,
      setsStripOn:!!STATE.ui.setsStripOn,
      surfaceUrl:String(STATE.ui.surfaceUrl||""),
      surfaceLabel:String(STATE.ui.surfaceLabel||"")
    };
  }
  STATE.ui.blackout=next;
  if(STATE.ui.blackout){
    STATE.ui.motionOn=false;
    stopLight(true);
    resetStage();
    motion.classList.remove("run");
    STATE.ui.drawerOpen=false;
    STATE.ui.noteOpen=false;
    STATE.ui.padOpen=false;
    STATE.ui.playerOpen=false;
    STATE.ui.ytOpen=false;
  }else{
    if(BLACKOUT_CACHE){
      STATE.ui.drawerOpen=!!BLACKOUT_CACHE.drawerOpen;
      STATE.ui.noteOpen=!!BLACKOUT_CACHE.noteOpen;
      STATE.ui.motionOn=!!BLACKOUT_CACHE.motionOn;
      STATE.ui.padOpen=!!BLACKOUT_CACHE.padOpen;
      STATE.ui.playerOpen=!!BLACKOUT_CACHE.playerOpen;
      STATE.ui.playerCollapsed=!!BLACKOUT_CACHE.playerCollapsed;
      STATE.ui.ytOpen=!!BLACKOUT_CACHE.ytOpen;
      STATE.ui.pinnedStripOn=!!BLACKOUT_CACHE.pinnedStripOn;
      STATE.ui.setsStripOn=!!BLACKOUT_CACHE.setsStripOn;
      STATE.ui.surfaceUrl=String(BLACKOUT_CACHE.surfaceUrl||"");
      STATE.ui.surfaceLabel=String(BLACKOUT_CACHE.surfaceLabel||"");
      const wasRunning=!!BLACKOUT_CACHE.lightRunning;
      const wasPreset=Number(BLACKOUT_CACHE.lightPreset||1);
      STATE.ui.lightPreset=wasPreset;
      if(wasRunning) startLight(wasPreset);
      BLACKOUT_CACHE=null;
    }
  }
  persist(false);
}
function toggleBlackout(){ setBlackout(!STATE.ui.blackout); }
function setFullscreen(on){ STATE.ui.fullscreen=!!on; persist(false); }
function toggleFullscreen(){ setFullscreen(!STATE.ui.fullscreen); }

/* ===== file export/import (real download) ===== */
function exportState(){ return JSON.stringify({ STORAGE_KEY: STORAGE_KEY_MAIN, STATE }, null, 2); }
function exportFilename(){
  const sig=stableSig();
  const stamp=new Date().toISOString().replace(/[:.]/g,"-");
  return `KETADATA_SURFACE_${sig}_${stamp}.json`;
}
function downloadJsonFile(filename, text){
  const blob=new Blob([String(text||"")], {type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=filename||"KETADATA_SURFACE_STATE.json";
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 250);
}
function importState(text){
  const parsed=JSON.parse(text);
  const incoming=(parsed && parsed.STATE) ? parsed.STATE : parsed;
  STATE=deepFill(incoming);
  stopLight(true);
  if(STATE.ui.lightRunning && !STATE.ui.blackout) startLight(STATE.ui.lightPreset||1);
  syncYTUIFromState();
  applyYTEmbedFromState(true);
  persist(false);
}

/* ===== draggable panels (FIX: buttons inside header remain clickable) ===== */
function shouldIgnoreDragStart(ev){
  const t=ev.target;
  if(!t) return false;
  if(t.closest && t.closest("button,input,textarea,select,a,label")) return true;
  return false;
}
function makeDragSmooth(el, handle, opts={}){
  if(!el || !handle) return;
  const minTop = Number(opts.minTop ?? 32);
  const minLeft = Number(opts.minLeft ?? 0);
  const pad = Number(opts.pad ?? 8);

  let dragging=false, startX=0, startY=0, baseX=0, baseY=0;

  const onDown=(ev)=>{
    if(STATE.ui.blackout || STATE.ui.fullscreen) return;
    if(ev.button!==undefined && ev.button!==0) return;
    if(shouldIgnoreDragStart(ev)) return;

    dragging=true;
    const rect=el.getBoundingClientRect();
    baseX=rect.left; baseY=rect.top;
    startX=ev.clientX; startY=ev.clientY;

    try{ handle.setPointerCapture(ev.pointerId); }catch(e){}
    ev.preventDefault();
  };

  const onMove=(ev)=>{
    if(!dragging) return;
    const dx=ev.clientX-startX;
    const dy=ev.clientY-startY;

    const vw=window.innerWidth;
    const vh=window.innerHeight;

    const w=el.getBoundingClientRect().width;
    const h=el.getBoundingClientRect().height;

    const maxLeft = Math.max(minLeft, vw - w - pad);
    const maxTop  = Math.max(minTop, vh - h - pad);

    const nx=clamp(baseX+dx, minLeft+pad, maxLeft);
    const ny=clamp(baseY+dy, minTop+pad, maxTop);

    el.style.left = nx+"px";
    el.style.top  = ny+"px";
  };

  const onUp=(ev)=>{
    if(!dragging) return;
    dragging=false;
    try{ handle.releasePointerCapture(ev.pointerId); }catch(e){}
    const rect=el.getBoundingClientRect();
    if(opts.onEnd) opts.onEnd({x:rect.left, y:rect.top, w:rect.width, h:rect.height});
  };

  handle.addEventListener("pointerdown", onDown, {passive:false});
  window.addEventListener("pointermove", onMove, {passive:true});
  window.addEventListener("pointerup", onUp, {passive:true});
}

function applyPanelRect(el, rect, fallback){
  if(!el || !rect) return;
  const vw=window.innerWidth, vh=window.innerHeight;
  const topBar=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--top"))||44;
  const pad=10;

  const w = clamp(Number(rect.w ?? fallback.w), 220, vw - pad*2);
  const h = clamp(Number(rect.h ?? fallback.h), 140, vh - topBar - pad*2);

  let x = (rect.x==null)? (fallback.x ?? 20) : Number(rect.x);
  let y = (rect.y==null)? (fallback.y ?? (topBar+20)) : Number(rect.y);

  x=clamp(x, pad, vw - w - pad);
  y=clamp(y, topBar + pad, vh - h - pad);

  el.style.width = w+"px";
  el.style.height= h+"px";
  el.style.left  = x+"px";
  el.style.top   = y+"px";
}

function attachResizableState(el, rectGetter, rectSetter){
  if(!el || !("ResizeObserver" in window)) return;
  let raf=0;
  const ro=new ResizeObserver(()=>{
    if(STATE.ui.blackout || STATE.ui.fullscreen) return;
    if(raf) cancelAnimationFrame(raf);
    raf=requestAnimationFrame(()=>{
      const r=safeRectFromEl(el);
      const rect=rectGetter();
      rect.w=r.w; rect.h=r.h;
      rectSetter(rect);
      persist(true);
    });
  });
  ro.observe(el);
}

/* ===== reorder (smooth pointer reorder; buttons safe) ===== */
function installSmoothReorder(listEl, onReorder){
  if(!listEl) return;

  let active=null; // {from, ghost, startY, lastTo, pointerId}
  const rows=()=>[...listEl.querySelectorAll(".playerRow")];

  const clearMarks=()=>{
    rows().forEach(r=>r.classList.remove("isDropTarget","isDragGhost"));
  };

  const indexFromEventTarget=(t)=>{
    const row=t && t.closest ? t.closest(".playerRow") : null;
    if(!row) return -1;
    return Number(row.dataset.index||-1);
  };

  const pickToIndex=(clientY)=>{
    const rs=rows();
    if(!rs.length) return 0;
    let best=0;
    for(let i=0;i<rs.length;i++){
      const r=rs[i].getBoundingClientRect();
      const mid=r.top + r.height/2;
      if(clientY >= mid) best=i;
    }
    return clamp(best, 0, rs.length-1);
  };

  const onDown=(ev)=>{
    if(STATE.ui.blackout || STATE.ui.fullscreen) return;
    if(ev.button!==undefined && ev.button!==0) return;
    if(shouldIgnoreDragStart(ev)) return;

    const from=indexFromEventTarget(ev.target);
    if(from<0) return;

    const r=rows()[from];
    if(!r) return;

    active={from, lastTo:from, pointerId:ev.pointerId};

    const rect=r.getBoundingClientRect();
    const ghost=r.cloneNode(true);
    ghost.classList.add("isDragGhost");
    ghost.style.position="fixed";
    ghost.style.left=rect.left+"px";
    ghost.style.top=rect.top+"px";
    ghost.style.width=rect.width+"px";
    ghost.style.height=rect.height+"px";
    ghost.style.zIndex="9999";
    ghost.style.pointerEvents="none";
    ghost.style.opacity="0.65";
    document.body.appendChild(ghost);
    active.ghost=ghost;

    try{ r.setPointerCapture(ev.pointerId); }catch(e){}
    ev.preventDefault();
  };

  const onMove=(ev)=>{
    if(!active) return;
    const g=active.ghost;
    if(g){
      g.style.top = (ev.clientY - g.getBoundingClientRect().height/2)+"px";
      g.style.left = (listEl.getBoundingClientRect().left)+"px";
    }

    const to=pickToIndex(ev.clientY);
    active.lastTo=to;

    clearMarks();
    const rs=rows();
    if(rs[to]) rs[to].classList.add("isDropTarget");
  };

  const onUp=(ev)=>{
    if(!active) return;
    const from=active.from;
    const to=active.lastTo;

    clearMarks();
    if(active.ghost) active.ghost.remove();

    if(typeof onReorder==="function" && from!==to){
      onReorder(from,to);
    }

    active=null;
  };

  listEl.addEventListener("pointerdown", onDown, {passive:false});
  window.addEventListener("pointermove", onMove, {passive:true});
  window.addEventListener("pointerup", onUp, {passive:true});
}

/* ===== data helpers ===== */
function getSurfaceById(id){
  const sid=String(id||"").trim();
  return (STATE.payload.surfaces||[]).find(s=>String(s.id)===sid)||null;
}
function getSpecById(id){
  const sid=String(id||"").trim();
  return (STATE.payload.specs||[]).find(s=>String(s.id)===sid)||null;
}

/* ===== PAD ===== */
function openPad(tab){
  if(tab) STATE.ui.padTab=tab;
  STATE.ui.padOpen=true;
  const panel=$("padPanel");
  panel.classList.add("open");
  panel.style.display="flex";
  applyPanelRect(panel, STATE.ui.padRect, {x:14,y:(parseInt(getComputedStyle(document.documentElement).getPropertyValue("--top"))||44)+120,w:560,h:420});
  renderPad();
  persist(true);
}
function closePad(){
  STATE.ui.padOpen=false;
  const panel=$("padPanel");
  panel.classList.remove("open");
  panel.style.display="none";
  persist(true);
}
function renderPad(){
  const panel=$("padPanel");
  if(!STATE.ui.padOpen || STATE.ui.blackout || STATE.ui.fullscreen){
    panel.classList.remove("open");
    panel.style.display="none";
    return;
  }
  panel.style.display="flex";
  panel.classList.add("open");

  const tab = STATE.ui.padTab || "surfaces";
  $("padHead").querySelectorAll("[data-tab]").forEach(btn=>{
    btn.classList.toggle("on", btn.getAttribute("data-tab")===tab);
  });

  if(tab==="surfaces") renderPadSurfaces();
  else if(tab==="spaces") renderPadSpaces();
  else if(tab==="specs") renderPadSpecs();
  else if(tab==="schedule") renderPadSchedule();
  else if(tab==="storage") renderPadStorage();
}

function renderPadSurfaces(){
  const body=$("padBody");
  body.innerHTML="";

  const head=document.createElement("div");
  head.style.cssText="display:flex; gap:8px; align-items:center; margin-bottom:8px; font-family:var(--mono); font-size:11px; color:var(--muted); letter-spacing:.08em; text-transform:uppercase";
  head.innerHTML=`<div style="flex:1">SURFACES (EDITABLE)</div><button class="headBtn" id="padAddSurf">+ ADD</button><button class="headBtn" id="padToQueue">SELECTED → QUEUE</button>`;
  body.appendChild(head);

  const list=document.createElement("div");
  list.className="padList";
  body.appendChild(list);

  const surfaces=(STATE.payload.surfaces||[]).slice().sort((a,b)=>(b.pinned|0)-(a.pinned|0));
  surfaces.forEach(s=>{
    const it=document.createElement("div");
    it.className="padItem";
    it.innerHTML=`
      <div class="chk" data-id="${s.id}"></div>
      <div class="name" contenteditable="true" data-id="${s.id}" data-field="name">${escHtml(s.name||"(unnamed)")}</div>
      <div class="url" contenteditable="true" data-id="${s.id}" data-field="url">${escHtml(s.url||"")}</div>
      <button data-act="pin" data-id="${s.id}">${s.pinned?"UNPIN":"PIN"}</button>
      <button data-act="arm" data-id="${s.id}">ARM</button>
      <button data-act="surf" data-id="${s.id}">SURF</button>
      <button data-act="del" data-id="${s.id}">DEL</button>
    `;
    list.appendChild(it);
  });

  document.getElementById("padAddSurf")?.addEventListener("click",()=>{
    STATE.payload.surfaces.unshift({id:`SURF_${uid8()}`,name:"",url:"",pinned:false});
    persist(); renderPadSurfaces();
  });

  document.getElementById("padToQueue")?.addEventListener("click",()=>{
    const selected=[...list.querySelectorAll(".chk.on")].map(x=>x.getAttribute("data-id"));
    if(!selected.length){ toast("NO SELECTION"); return; }
    selected.forEach(id=>{
      const s=getSurfaceById(id);
      if(s && s.url){
        STATE.ui.player.queue.push({label:canonName(s.name||"")||deriveNameFromUrl(s.url), url:s.url});
      }
    });
    toast("ADDED TO QUEUE");
    STATE.ui.playerOpen=true;
    persist(true);
    playerRender();
  });

  list.querySelectorAll(".chk").forEach(ch=>{
    ch.addEventListener("click",()=>{ ch.classList.toggle("on"); });
  });

  list.querySelectorAll("[data-act]").forEach(btn=>{
    btn.addEventListener("click",(e)=>{
      e.stopPropagation();
      const id=btn.getAttribute("data-id");
      const act=btn.getAttribute("data-act");
      const s=getSurfaceById(id);
      if(!s) return;
      if(act==="pin"){ s.pinned=!s.pinned; persist(); renderPadSurfaces(); renderPinnedPanel(); renderSurfaceList(); }
      if(act==="arm"){ arm(s.name||deriveNameFromUrl(s.url), s.url); toast("ARMED"); persist(true); }
      if(act==="surf"){ if(s.url){ applySurface(s.url, s.name); toast("SURFACE"); persist(true); } }
      if(act==="del"){
        STATE.payload.surfaces=STATE.payload.surfaces.filter(x=>x.id!==id);
        persist(); renderPadSurfaces(); renderPinnedPanel(); renderSurfaceList();
      }
    });
  });

  list.querySelectorAll('[contenteditable="true"]').forEach(el=>{
    el.addEventListener("input",()=>{
      const id=el.getAttribute("data-id");
      const field=el.getAttribute("data-field");
      const s=getSurfaceById(id);
      if(!s) return;
      s[field]=el.textContent.trim();
      persist(true);
      renderPinnedPanel();
      renderSurfaceList();
    });
    el.addEventListener("keydown",(ev)=>{ if(ev.key==="Enter"){ ev.preventDefault(); el.blur(); } });
  });
}

function renderPadSpaces(){
  const body=$("padBody");
  body.innerHTML="";
  const box=document.createElement("div");
  box.style.cssText="border:1px solid rgba(255,255,255,0.18); padding:12px; background:rgba(0,0,0,0.35)";
  box.innerHTML=`
    <div style="font-family:var(--mono); font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted); margin-bottom:10px">
      SPACES (PLACEHOLDER)
    </div>
    <div style="font-family:var(--mono); font-size:11px; color:var(--fg); line-height:1.4">
      STATIC ROOM MAP FOR NOW.
    </div>
  `;
  body.appendChild(box);
}

function renderPadSpecs(){
  const body=$("padBody");
  body.innerHTML="";

  const head=document.createElement("div");
  head.style.cssText="display:flex; gap:8px; align-items:center; margin-bottom:8px; font-family:var(--mono); font-size:11px; color:var(--muted); letter-spacing:.08em; text-transform:uppercase";
  head.innerHTML=`<div style="flex:1">SPECS</div><button class="headBtn" id="padNewSpec">+ NEW</button>`;
  body.appendChild(head);

  const list=document.createElement("div");
  list.className="padList";
  body.appendChild(list);

  STATE.payload.specs.forEach(sp=>{
    const display = sp.name && sp.name.trim() ? sp.name.trim() : "(unnamed)";
    const it=document.createElement("div");
    it.className="padItem";
    it.innerHTML=`
      <div class="name">${escHtml(display)}</div>
      <div class="url" style="color:var(--muted)">${(sp.createdAt||nowISO()).slice(0,10)}</div>
      <button data-act="open" data-id="${sp.id}">OPEN</button>
      <button data-act="del" data-id="${sp.id}">DEL</button>
    `;
    list.appendChild(it);
  });

  document.getElementById("padNewSpec")?.addEventListener("click",()=>{
    const sp={id:`SPEC_${uid8()}`, name:"", body:"", createdAt:nowISO()};
    STATE.payload.specs.unshift(sp);
    persist();
    openSpecModule(sp);
    renderPadSpecs();
  });

  list.querySelectorAll("[data-act]").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const id=btn.getAttribute("data-id");
      const act=btn.getAttribute("data-act");
      const sp=getSpecById(id);
      if(!sp) return;
      if(act==="del"){
        STATE.payload.specs=STATE.payload.specs.filter(s=>s.id!==id);
        persist(); renderPadSpecs(); renderSpecList();
      }
      if(act==="open"){ openSpecModule(sp); }
    });
  });
}

function renderPadSchedule(){
  const body=$("padBody");
  body.innerHTML="";
  const head=document.createElement("div");
  head.style.cssText="display:flex; gap:8px; align-items:center; margin-bottom:8px; font-family:var(--mono); font-size:11px; color:var(--muted); letter-spacing:.08em; text-transform:uppercase";
  head.innerHTML=`<div style="flex:1">SCHEDULE</div><button class="headBtn" id="schAdd">+ ADD</button>`;
  body.appendChild(head);

  const list=document.createElement("div");
  list.className="padList";
  body.appendChild(list);

  const blocks=(STATE.payload.schedule||[]).slice().sort((a,b)=>{
    if(a.day!==b.day) return a.day<b.day?-1:1;
    return (a.start||"").localeCompare(b.start||"");
  });

  if(blocks.length===0){
    const empty=document.createElement("div");
    empty.style.cssText="padding:12px; font-family:var(--mono); font-size:11px; color:var(--muted)";
    empty.textContent="NO BLOCKS YET.";
    list.appendChild(empty);
  }else{
    blocks.forEach(b=>{
      const row=document.createElement("div");
      row.className="padItem";
      row.innerHTML=`
        <div class="name" style="width:120px" contenteditable="true" data-id="${b.id}" data-field="day">${escHtml(b.day)}</div>
        <div class="url" style="width:70px; color:var(--fg)" contenteditable="true" data-id="${b.id}" data-field="start">${escHtml(b.start)}</div>
        <div class="url" style="width:70px; color:var(--fg)" contenteditable="true" data-id="${b.id}" data-field="end">${escHtml(b.end)}</div>
        <div class="url" style="flex:1; color:var(--fg)" contenteditable="true" data-id="${b.id}" data-field="label">${escHtml(b.label)}</div>
        <button data-act="del" data-id="${b.id}">DEL</button>
      `;
      list.appendChild(row);
    });
  }

  document.getElementById("schAdd")?.addEventListener("click",()=>{
    const b={id:`BLK_${uid8()}`, day:nowISO().slice(0,10), start:"09:00", end:"10:00", label:"BLOCK"};
    STATE.payload.schedule.push(b);
    persist();
    renderPadSchedule();
  });

  list.querySelectorAll('[contenteditable="true"]').forEach(el=>{
    el.addEventListener("keydown",(ev)=>{ if(ev.key==="Enter"){ ev.preventDefault(); el.blur(); } });
    el.addEventListener("blur",()=>{
      const id=el.getAttribute("data-id");
      const field=el.getAttribute("data-field");
      const blk=(STATE.payload.schedule||[]).find(x=>x.id===id);
      if(!blk) return;
      blk[field]=el.textContent.trim();
      persist(true);
    });
  });

  list.querySelectorAll("[data-act='del']").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const id=btn.getAttribute("data-id");
      STATE.payload.schedule=(STATE.payload.schedule||[]).filter(x=>x.id!==id);
      persist();
      renderPadSchedule();
    });
  });
}

/* STORAGE PAD */
function renderPadStorage(){
  const body=$("padBody");
  body.innerHTML="";

  const head=document.createElement("div");
  head.style.cssText="display:flex; gap:8px; align-items:center; margin-bottom:8px; font-family:var(--mono); font-size:11px; color:var(--muted); letter-spacing:.08em; text-transform:uppercase";
  head.innerHTML=`<div style="flex:1">STORAGE (EXPANDABLE)</div><button class="headBtn" id="padStorageRefresh">REFRESH</button>`;
  body.appendChild(head);

  let totalBytes=0;
  try{
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      const v=localStorage.getItem(k)||"";
      totalBytes+=(k.length+v.length)*2;
    }
  }catch(e){}
  const fmtBytes=n=>n<1024?n+" B":n<1048576?(n/1024).toFixed(1)+" KB":(n/1048576).toFixed(2)+" MB";

  const stats=document.createElement("div");
  stats.style.cssText="display:flex; gap:12px; margin-bottom:8px; font-family:var(--mono); font-size:11px; color:var(--muted)";
  stats.innerHTML=`<span>ITEMS: ${localStorage.length}</span><span>BYTES: ${fmtBytes(totalBytes)}</span>`;
  body.appendChild(stats);

  const list=document.createElement("div");
  list.className="padList";
  list.style.maxHeight="360px";
  list.style.overflow="auto";
  body.appendChild(list);

  const keys=[];
  for(let i=0;i<localStorage.length;i++) keys.push(localStorage.key(i));
  keys.sort();

  keys.forEach(k=>{
    const v=localStorage.getItem(k)||"";
    const bytes=(k.length+v.length)*2;

    const row=document.createElement("div");
    row.className="padItem";
    row.style.flexDirection="column";
    row.style.alignItems="stretch";
    row.style.gap="6px";

    row.innerHTML=`
      <div style="display:flex; gap:8px; align-items:center">
        <div class="name" style="width:240px">${escHtml(k)}</div>
        <div class="url" style="flex:1">${fmtBytes(bytes)}</div>
        <button data-act="expand" data-key="${escHtml(k)}">EXPAND</button>
        <button data-act="export" data-key="${escHtml(k)}">EXPORT</button>
        <button data-act="del" data-key="${escHtml(k)}">DEL</button>
      </div>
      <div data-body="${escHtml(k)}" style="display:none; border:1px solid rgba(255,255,255,0.14); padding:8px; background:rgba(0,0,0,0.25)">
        <textarea spellcheck="false" style="min-height:120px; resize:vertical; background:#000; border:1px solid rgba(255,255,255,0.22); color:#fff; padding:8px; font-family:var(--mono); font-size:11px; letter-spacing:.02em"></textarea>
        <div style="margin-top:6px; color:var(--muted); font-family:var(--mono); font-size:10px">
          EDIT + BLUR SAVES TO LOCALSTORAGE.
        </div>
      </div>
    `;
    list.appendChild(row);

    const bodyEl=row.querySelector(`[data-body="${CSS.escape(k)}"]`);
    const ta=bodyEl.querySelector("textarea");
    ta.value=v;

    ta.addEventListener("blur",()=>{
      try{ localStorage.setItem(k, ta.value); toast("SAVED KEY"); }
      catch(e){ toast("SAVE FAIL"); }
      renderStorageInfo();
    });

    row.querySelector("[data-act='expand']").addEventListener("click",()=>{
      const on = bodyEl.style.display!=="none";
      bodyEl.style.display = on ? "none" : "block";
    });
    row.querySelector("[data-act='export']").addEventListener("click",()=>{
      const payload={key:k, value:localStorage.getItem(k)};
      downloadJsonFile(`LS_KEY_${hash8(k)}_${new Date().toISOString().replace(/[:.]/g,"-")}.json`, JSON.stringify(payload,null,2));
      toast("KEY EXPORTED");
    });
    row.querySelector("[data-act='del']").addEventListener("click",()=>{
      localStorage.removeItem(k);
      toast("DELETED KEY");
      renderPadStorage();
      renderStorageInfo();
    });
  });

  document.getElementById("padStorageRefresh")?.addEventListener("click",()=>renderPadStorage());
}

/* ===== SPEC MODULE ===== */
function openSpecModule(sp){
  const el=document.createElement("div");
  el.className="specNote";
  el.innerHTML=`
    <div class="specHead">
      <span style="color:var(--muted)">SPEC</span>
      <input placeholder="name (optional)" value="${escHtml(sp.name||"")}" />
      <button class="headBtn" data-act="close">X</button>
    </div>
    <div class="specBody">
      <textarea>${escHtml(sp.body||"")}</textarea>
    </div>
  `;
  document.body.appendChild(el);

  const n=document.querySelectorAll(".specNote").length;
  el.style.left=(80+(n*18))+"px";
  el.style.top=(90+(n*14))+"px";

  const nameIn=el.querySelector("input");
  const bodyTa=el.querySelector("textarea");
  nameIn.addEventListener("input",()=>{ sp.name=nameIn.value; persist(true); renderSpecList(); });
  bodyTa.addEventListener("input",()=>{ sp.body=bodyTa.value; persist(true); });

  el.querySelector("[data-act='close']").addEventListener("click",()=>{ el.remove(); });

  makeDragSmooth(el, el.querySelector(".specHead"), {minTop:32});
}

/* ===== PLAYER ===== */
function playerNow(){
  const q=STATE.ui.player.queue||[];
  const i=Math.max(0, Math.min(q.length-1, STATE.ui.player.index||0));
  return q[i]||null;
}
function playerSetIndex(i){
  const q=STATE.ui.player.queue||[];
  if(!q.length){ STATE.ui.player.index=0; return; }
  STATE.ui.player.index=Math.max(0, Math.min(q.length-1, i));
}
function renderPlayerSetsList(){
  const el=$("playerSetsList");
  if(!el) return;
  el.innerHTML="";

  const sets=(STATE.payload.sets||[]).slice().sort((a,b)=>{
    const ta=Date.parse(a.updatedAt||a.createdAt||0);
    const tb=Date.parse(b.updatedAt||b.createdAt||0);
    return tb-ta;
  });

  if(sets.length===0){
    const hint=document.createElement("div");
    hint.style.cssText="color:var(--muted); font-family:var(--mono); font-size:11px; padding:8px";
    hint.textContent="NO SETS YET";
    el.appendChild(hint);
    return;
  }

  sets.forEach(s=>{
    const row=document.createElement("div");
    row.style.cssText="display:flex; gap:8px; align-items:center; justify-content:space-between; border:1px solid rgba(255,255,255,0.16); padding:6px 8px; font-family:var(--mono); font-size:11px; cursor:pointer";

    const name=document.createElement("div");
    name.style.cssText="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap";
    name.textContent=canonName(s.label||"SET");

    const count=document.createElement("div");
    count.style.cssText="color:var(--muted); font-size:10px";
    count.textContent=`${(s.items||[]).length}`;

    row.appendChild(name);
    row.appendChild(count);

    row.addEventListener("click",()=>{
      const items=(s.items||[]).map(it=>({label:canonName(it.label||"")||deriveNameFromUrl(it.url), url:String(it.url||"").trim()})).filter(x=>x.url);
      STATE.ui.player.queue=items;
      STATE.ui.player.index=0;
      toast(`LOADED: ${s.label}`);
      STATE.ui.playerOpen=true;
      persist(true);
      playerRender();
    });

    el.appendChild(row);
  });
}
function playerRender(){
  const panel=$("playerPanel");
  if(!STATE.ui.playerOpen || STATE.ui.blackout || STATE.ui.fullscreen){
    panel.classList.remove("open","collapsed");
    panel.style.display="none";
    return;
  }
  panel.style.display="";
  panel.classList.add("open");
  panel.classList.toggle("collapsed", !!STATE.ui.playerCollapsed);

  applyPanelRect(panel, STATE.ui.playerRect, {x:(window.innerWidth-400),y:(parseInt(getComputedStyle(document.documentElement).getPropertyValue("--top"))||44)+64,w:380,h:480});

  const now=playerNow();
  $("playerNowLabel").textContent = now ? (canonName(now.label||"")||deriveNameFromUrl(now.url)) : "—";
  $("playerPlay").textContent = STATE.ui.player.playing ? "PAUSE" : "PLAY";

  const qEl=$("playerQueue");
  qEl.innerHTML="";

  const q=(STATE.ui.player.queue||[]);
  q.forEach((it, idx)=>{
    const row=document.createElement("div");
    row.className="playerRow";
    row.dataset.index=String(idx);

    if(idx===STATE.ui.player.index) row.style.borderColor="var(--fg)";

    const ix=document.createElement("span");
    ix.className="ix";
    ix.textContent=String(idx+1).padStart(2,"0");

    const nm=document.createElement("span");
    nm.className="nm";
    nm.textContent=canonName(it.label||"")||deriveNameFromUrl(it.url);

    const acts=document.createElement("div");
    acts.className="acts";

    const surfBtn=document.createElement("button");
    surfBtn.textContent="S";
    surfBtn.className="miniBlk";
    surfBtn.title="SURFACE";
    surfBtn.addEventListener("click",(e)=>{
      e.stopPropagation();
      if(it.url){ applySurface(it.url, it.label); toast("SURFACE"); persist(true); }
    });

    const delBtn=document.createElement("button");
    delBtn.textContent="X";
    delBtn.className="miniBlk";
    delBtn.title="DELETE";
    delBtn.addEventListener("click",(e)=>{
      e.stopPropagation();
      STATE.ui.player.queue.splice(idx,1);
      if(STATE.ui.player.index>=STATE.ui.player.queue.length) STATE.ui.player.index=Math.max(0,STATE.ui.player.queue.length-1);
      persist(); playerRender();
    });

    acts.appendChild(surfBtn);
    acts.appendChild(delBtn);

    row.appendChild(ix);
    row.appendChild(nm);
    row.appendChild(acts);

    row.addEventListener("click",()=>{
      playerSetIndex(idx);
      persist(true);
      playerRender();
    });

    qEl.appendChild(row);
  });

  installSmoothReorder(qEl, (from,to)=>{
    if(from===to) return;
    const item=STATE.ui.player.queue.splice(from,1)[0];
    STATE.ui.player.queue.splice(to,0,item);

    if(STATE.ui.player.index===from) STATE.ui.player.index=to;
    else if(from<STATE.ui.player.index && to>=STATE.ui.player.index) STATE.ui.player.index--;
    else if(from>STATE.ui.player.index && to<=STATE.ui.player.index) STATE.ui.player.index++;

    persist(true);
    playerRender();
  });

  renderPlayerSetsList();
}
function playerClose(){ STATE.ui.playerOpen=false; persist(true); playerRender(); }
function playerAddArmed(){
  const u=String(ARMED.url||"").trim();
  if(!u){ toast("NO ARMED"); return; }
  const label=canonName(ARMED.name||"")||deriveNameFromUrl(u);
  STATE.ui.player.queue.push({label,url:u});
  toast("ADDED");
  STATE.ui.playerOpen=true;
  persist(true);
  playerRender();
}
function playerPrev(){
  playerSetIndex((STATE.ui.player.index||0)-1);
  if(STATE.ui.player.playing){
    const cur=playerNow();
    if(cur && cur.url){ applySurface(cur.url, cur.label); }
  }
  persist(true); playerRender();
}
function playerNext(){
  playerSetIndex((STATE.ui.player.index||0)+1);
  if(STATE.ui.player.playing){
    const cur=playerNow();
    if(cur && cur.url){ applySurface(cur.url, cur.label); }
  }
  persist(true); playerRender();
}
function playerTogglePlay(){
  STATE.ui.player.playing=!STATE.ui.player.playing;
  if(STATE.ui.player.playing){
    const cur=playerNow();
    if(cur && cur.url){ applySurface(cur.url, cur.label); }
    toast("PLAY");
  }else{
    toast("PAUSE");
  }
  persist(true); playerRender();
}
function playerSurfaceNow(){
  const cur=playerNow();
  if(!cur || !cur.url){ toast("NO NOW"); return; }
  applySurface(cur.url, cur.label);
  toast("SURFACE");
  persist(true);
}
function normalizeUrlMaybe(u){
  const raw=String(u||"").trim();
  if(!raw) return "";
  if(/^[a-zA-Z0-9_-]{11}$/.test(raw)) return `https://www.youtube.com/watch?v=${raw}`;
  if(/^PL[a-zA-Z0-9_-]+$/.test(raw)) return `https://www.youtube.com/playlist?list=${raw}`;
  return raw;
}
function playerAddInputUrl(toSurface=false){
  const inp=$("playerInputUrl");
  const raw=normalizeUrlMaybe(inp.value);
  if(!raw){ toast("NO INPUT"); return; }
  const label=deriveNameFromUrl(raw);
  STATE.ui.player.queue.push({label,url:raw});
  STATE.ui.player.index = Math.max(0, (STATE.ui.player.queue.length-1));
  toast("ADDED");
  if(toSurface) { applySurface(raw,label); toast("SURFACE"); }
  STATE.ui.playerOpen=true;
  persist(true);
  playerRender();
}
function playerArmInput(){
  const raw=normalizeUrlMaybe($("playerInputUrl").value);
  if(!raw){ toast("NO INPUT"); return; }
  arm(deriveNameFromUrl(raw), raw);
  toast("ARMED");
  persist(true);
}
function playerCreateSetFromQueue(){
  const id=`SET_${uid8()}`;
  const name = "QUEUE_"+nowISO().slice(0,10).replace(/-/g,"");
  const items = (STATE.ui.player.queue||[]).map(q=>({label:q.label||deriveNameFromUrl(q.url), url:q.url}));
  STATE.payload.sets.unshift({id,label:name,items,createdAt:nowISO(),updatedAt:nowISO()});
  toast("SET CREATED");
  persist();
  renderSetsStrip();
  renderPlayerSetsList();
}
function playerImportBulk(){
  const text=$("playerBulkInput").value||"";
  const parsed=parseBulkLines(text);
  if(!parsed.length){ toast("NO ITEMS"); return; }

  parsed.forEach(p=>{
    STATE.ui.player.queue.push({label:canonName(p.name||"")||deriveNameFromUrl(p.url), url:p.url});
  });

  toast(`IMPORTED ${parsed.length}`);
  $("playerBulkInput").value="";
  STATE.ui.playerOpen=true;
  persist(true);
  playerRender();
}
/* ===== YT (MINIMAL, NO SHORTS, SAFE) ===== */

function ytParse(input){
  const s = String(input||"").trim();
  if(!s) return { type:"none" };

  // raw IDs
  if(/^[a-zA-Z0-9_-]{11}$/.test(s)) return { type:"video", id:s };
  if(/^PL[a-zA-Z0-9_-]+$/.test(s)) return { type:"playlist", list:s };

  try{
    const u = new URL(s, location.href);
    const host = (u.hostname||"").toLowerCase();
    const path = u.pathname || "";
    const sp = u.searchParams;

    // HARD BLOCK SHORTS
    if(path.includes("/shorts/")) return { type:"unknown" };

    // youtu.be/<id>
    if(host.includes("youtu.be")){
      const id = path.split("/").filter(Boolean)[0] || "";
      if(/^[a-zA-Z0-9_-]{11}$/.test(id)) return { type:"video", id };
    }

    // youtube domains (+ some common variants)
    const isYT =
      host.includes("youtube.com") ||
      host.includes("youtube-nocookie.com") ||
      host.includes("m.youtube.com") ||
      host.includes("music.youtube.com");

    if(isYT){
      const v = sp.get("v");
      const list = sp.get("list");

      // watch?v=<id>
      if(v && /^[a-zA-Z0-9_-]{11}$/.test(v)) return { type:"video", id:v };

      // /playlist?list=<id>
      if((path.includes("/playlist") || path.includes("/watch")) && list && /^PL[a-zA-Z0-9_-]+$/.test(list))
        return { type:"playlist", list };

      // /embed/<id> or /embed/videoseries?list=...
      if(path.includes("/embed/")){
        if(path.includes("/embed/videoseries")){
          if(list && /^PL[a-zA-Z0-9_-]+$/.test(list)) return { type:"playlist", list };
        }else{
          const id = path.split("/embed/")[1]?.split(/[?&#]/)[0] || "";
          if(/^[a-zA-Z0-9_-]{11}$/.test(id)) return { type:"video", id };
        }
      }
    }
  }catch(e){}

  return { type:"unknown" };
}

function ytEnsureFrameAttrs(){
  if(!ytFrame) return;

  // These two lines are the key mitigation for Error 153 in many environments.
  ytFrame.referrerPolicy = "strict-origin-when-cross-origin";
  ytFrame.setAttribute("referrerpolicy", "strict-origin-when-cross-origin");

  // Make sure embeds can actually play.
  ytFrame.setAttribute("allow", "autoplay; encrypted-media; picture-in-picture; fullscreen");
  ytFrame.setAttribute("allowfullscreen", "");
  ytFrame.setAttribute("loading", "lazy");
}

function ytBuildEmbedSrc(){
  const parsed = ytParse(STATE.ui.yt.input);
  if(parsed.type==="none" || parsed.type==="unknown") return "";

  const p = new URLSearchParams();
  p.set("autoplay", STATE.ui.yt.autoplay ? "1" : "0");
  p.set("mute",     STATE.ui.yt.mute ? "1" : "0");
  p.set("controls", STATE.ui.yt.controls ? "1" : "0");
  p.set("playsinline","1");
  p.set("rel","0");
  p.set("modestbranding","1");

  // If we're not on file://, include origin/jsapi (safe).
  const ORIGIN = (location.origin && location.origin !== "null") ? location.origin : "";
  if(ORIGIN){
    p.set("enablejsapi","1");
    p.set("origin", ORIGIN);
  }

  const host = STATE.ui.yt.nocookie
    ? "https://www.youtube-nocookie.com"
    : "https://www.youtube.com";

  if(parsed.type==="video"){
    if(STATE.ui.yt.loop){
      p.set("loop","1");
      p.set("playlist", parsed.id); // YT requires playlist=<id> to loop a single video
    }
    return `${host}/embed/${parsed.id}?${p.toString()}`;
  }

  if(parsed.type==="playlist"){
    p.set("list", parsed.list);
    if(STATE.ui.yt.loop) p.set("loop","1");
    return `${host}/embed/videoseries?${p.toString()}`;
  }

  return "";
}

function applyYTEmbedFromState(silent=false){
  ytEnsureFrameAttrs();

  const src = ytBuildEmbedSrc();
  STATE.ui.yt.lastEmbedSrc = src || "";

  if(!src){
    ytFrame.removeAttribute("src");
    if(!silent) toast("YT CLEARED");
    return;
  }

  if(ytFrame.getAttribute("src") !== src){
    ytFrame.setAttribute("src", src);
  }

  if(!silent) toast("YT APPLIED");
}

function syncYTUIFromState(){
  $("ytInput").value       = STATE.ui.yt.input || "";
  $("ytAutoplay").checked = !!STATE.ui.yt.autoplay;
  $("ytMute").checked     = !!STATE.ui.yt.mute;
  $("ytLoop").checked     = !!STATE.ui.yt.loop;
  $("ytControls").checked = !!STATE.ui.yt.controls;
  $("ytNoCookie").checked = !!STATE.ui.yt.nocookie;
}

function renderYT(){
  const panel = $("ytPanel");
  const openOk = STATE.ui.ytOpen && !STATE.ui.blackout && !STATE.ui.fullscreen;

  if(!openOk){
    panel.classList.remove("open");
    panel.style.display="none";
    return;
  }

  panel.style.display="";
  panel.classList.add("open");

  applyPanelRect(
    panel,
    STATE.ui.ytRect,
    { x: window.innerWidth-390, y: 600, w:360, h:260 }
  );

  syncYTUIFromState();
  applyYTEmbedFromState(true);
}


/* ===== pinned + sets ===== */
function renderPinnedPanel(){
  const el=$("pinnedPanel");
  if(!STATE.ui.pinnedStripOn || STATE.ui.blackout || STATE.ui.fullscreen){
    el.style.display="none";
    el.innerHTML="";
    return;
  }
  const pinned=(STATE.payload.surfaces||[]).filter(s=>s.pinned && s.url);
  if(!pinned.length){
    el.style.display="none";
    el.innerHTML="";
    return;
  }
  el.style.display="block";
  el.innerHTML="";

  const cols=4;
  const cellW=200, cellH=62;
  const originX=10, originY=10;

  pinned.forEach((s, i)=>{
    const mod=document.createElement("div");
    mod.className="pinMod";
    mod.dataset.id=s.id;

    const nm=canonName(s.name||"")||deriveNameFromUrl(s.url);
    mod.innerHTML=`<div class="grip" title="DRAG"></div><div class="nm">${escHtml(nm)}</div><div class="sub">${escHtml(s.url)}</div>`;

    const saved=STATE.ui.pinnedPos[s.id];
    const gx = originX + (i%cols)*cellW;
    const gy = originY + Math.floor(i/cols)*cellH;
    const x = (saved && typeof saved.x==="number") ? saved.x : gx;
    const y = (saved && typeof saved.y==="number") ? saved.y : gy;
    mod.style.left = x+"px";
    mod.style.top  = y+"px";

    mod.addEventListener("click",(e)=>{
      if(e.target && e.target.classList && e.target.classList.contains("grip")) return;
      const setMatch=(STATE.payload.sets||[]).find(ss=>canonName(ss.label)===canonName(nm));
      if(setMatch){ openSetListModule(setMatch); return; }
      arm(nm, s.url);
      toast("ARMED");
      persist(true);
    });

    makeDragSmooth(mod, mod.querySelector(".grip"), {
      minTop: (parseInt(getComputedStyle(document.documentElement).getPropertyValue("--top"))||44),
      onEnd:(rect)=>{
        STATE.ui.pinnedPos[s.id]={x:rect.x,y:rect.y};
        persist(true);
      }
    });

    el.appendChild(mod);
  });
}
function renderSetsStrip(){
  const el=$("activeStrip");
  if(!STATE.ui.setsStripOn || STATE.ui.blackout || STATE.ui.fullscreen){
    el.style.display="none";
    el.innerHTML="";
    return;
  }
  const sets=(STATE.payload.sets||[]).slice();
  if(!sets.length){
    el.style.display="none";
    el.innerHTML="";
    return;
  }
  el.style.display="flex";
  el.innerHTML="";
  const lab=document.createElement("span");
  lab.className="label";
  lab.textContent="SETS";
  el.appendChild(lab);

  sets.slice(0,18).forEach(s=>{
    const b=document.createElement("button");
    b.className="pill";
    b.textContent=canonName(s.label||"SET");
    b.title=`${(s.items||[]).length} items`;
    b.addEventListener("click",()=>{
      const items=(s.items||[]).map(it=>({label:canonName(it.label||"")||deriveNameFromUrl(it.url), url:String(it.url||"").trim()})).filter(x=>x.url);
      STATE.ui.player.queue=items;
      STATE.ui.player.index=0;
      STATE.ui.playerOpen=true;
      toast("SET → QUEUE");
      persist(true);
      playerRender();
    });
    el.appendChild(b);
  });
}
function renderSpecList(){
  const el=$("specList");
  el.innerHTML="";
  (STATE.payload.specs||[]).forEach(sp=>{
    const btn=document.createElement("button");
    btn.className="btn";
    btn.style.padding="4px 8px";
    btn.style.fontSize="11px";
    btn.textContent=(sp.name&&sp.name.trim())?sp.name.trim():"(unnamed)";
    btn.addEventListener("click",()=>openSpecModule(sp));
    el.appendChild(btn);
  });
}
function renderStorageInfo(){
  let count=0, bytes=0;
  try{
    count=localStorage.length;
    for(let i=0;i<count;i++){
      const k=localStorage.key(i);
      const v=localStorage.getItem(k)||"";
      bytes+=(k.length+v.length)*2;
    }
  }catch(e){}
  const fmtBytes=n=>n<1024?n+" B":n<1048576?(n/1024).toFixed(1)+" KB":(n/1048576).toFixed(2)+" MB";
  $("storageCount").textContent=String(count);
  $("storageBytes").textContent=fmtBytes(bytes);
}
function renderSurfaceList(){
  const el=$("surfaceList");
  el.innerHTML="";
  const surfaces=(STATE.payload.surfaces||[]).slice().sort((a,b)=>(b.pinned|0)-(a.pinned|0));
  surfaces.forEach(s=>{
    const row=document.createElement("div");
    row.style.cssText="display:flex; gap:8px; align-items:center; border:1px solid var(--line2); padding:6px 8px; font-family:var(--mono); font-size:11px";

    const nm=document.createElement("div");
    nm.style.cssText="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; cursor:pointer";
    nm.textContent=(canonName(s.name)||deriveNameFromUrl(s.url))+` (${s.pinned?"P":"-"})`;
    nm.title=s.url||"";
    nm.addEventListener("click",()=>{
      if(!s.url) return;
      arm(s.name||deriveNameFromUrl(s.url), s.url);
      toast("ARMED");
      persist(true);
    });

    const pinBtn=document.createElement("button");
    pinBtn.className="btn";
    pinBtn.style.cssText="padding:4px 6px; font-size:10px";
    pinBtn.textContent=s.pinned?"UNPIN":"PIN";
    pinBtn.addEventListener("click",()=>{
      s.pinned=!s.pinned;
      persist();
      renderSurfaceList();
      renderPinnedPanel();
    });

    const toQ=document.createElement("button");
    toQ.className="btn";
    toQ.style.cssText="padding:4px 6px; font-size:10px";
    toQ.textContent="Q";
    toQ.title="ADD TO QUEUE";
    toQ.addEventListener("click",()=>{
      if(!s.url) return;
      STATE.ui.player.queue.push({label:canonName(s.name||"")||deriveNameFromUrl(s.url), url:s.url});
      STATE.ui.playerOpen=true;
      toast("ADDED");
      persist(true);
      playerRender();
    });

    const delBtn=document.createElement("button");
    delBtn.className="btn";
    delBtn.style.cssText="padding:4px 6px; font-size:10px";
    delBtn.textContent="DEL";
    delBtn.addEventListener("click",()=>{
      STATE.payload.surfaces=STATE.payload.surfaces.filter(x=>x.id!==s.id);
      persist();
      renderSurfaceList();
      renderPinnedPanel();
    });

    row.appendChild(nm);
    row.appendChild(pinBtn);
    row.appendChild(toQ);
    row.appendChild(delBtn);
    el.appendChild(row);
  });
}

/* Set list module (for pinned set clicks) */
function openSetListModule(set){
  const el=document.createElement("div");
  el.className="specNote";
  el.style.width="460px";
  el.style.height="360px";

  const label=canonName(set.label||"SET");
  el.innerHTML=`
    <div class="specHead">
      <span style="color:var(--muted)">SET</span>
      <div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${escHtml(label)}</div>
      <button class="headBtn" data-act="toQ">TO Q</button>
      <button class="headBtn" data-act="close">X</button>
    </div>
    <div class="specBody" style="flex-direction:column; gap:8px">
      <div style="display:flex; flex-direction:column; gap:6px; overflow:auto; flex:1" id="setListBody"></div>
    </div>
  `;
  document.body.appendChild(el);

  const n=document.querySelectorAll(".specNote").length;
  el.style.left=(110+(n*16))+"px";
  el.style.top=(110+(n*12))+"px";

  const body=el.querySelector("#setListBody");
  (set.items||[]).forEach(it=>{
    const row=document.createElement("div");
    row.style.cssText="border:1px solid rgba(255,255,255,0.18); padding:6px 8px; display:flex; gap:8px; align-items:center; font-family:var(--mono); font-size:11px; text-transform:uppercase";
    const nm=document.createElement("div");
    nm.style.cssText="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap";
    nm.textContent=canonName(it.label||"")||deriveNameFromUrl(it.url);
    const armBtn=document.createElement("button");
    armBtn.className="miniBlk";
    armBtn.textContent="ARM";
    armBtn.addEventListener("click",(e)=>{ e.stopPropagation(); arm(nm.textContent, it.url); toast("ARMED"); persist(true); });
    const surfBtn=document.createElement("button");
    surfBtn.className="miniBlk";
    surfBtn.textContent="SURF";
    surfBtn.addEventListener("click",(e)=>{ e.stopPropagation(); applySurface(it.url, nm.textContent); toast("SURFACE"); persist(true); });

    row.appendChild(nm);
    row.appendChild(armBtn);
    row.appendChild(surfBtn);
    body.appendChild(row);
  });

  el.querySelector('[data-act="close"]').addEventListener("click",()=>el.remove());
  el.querySelector('[data-act="toQ"]').addEventListener("click",()=>{
    const items=(set.items||[]).map(it=>({label:canonName(it.label||"")||deriveNameFromUrl(it.url), url:String(it.url||"").trim()})).filter(x=>x.url);
    STATE.ui.player.queue=items;
    STATE.ui.player.index=0;
    STATE.ui.playerOpen=true;
    toast("SET → QUEUE");
    persist(true);
    playerRender();
  });

  makeDragSmooth(el, el.querySelector(".specHead"), {minTop:32});
}

/* ===== render ===== */
function render(){
  root.classList.toggle("invert", !!STATE.ui.invert);
  root.classList.toggle("blackout", !!STATE.ui.blackout);
  root.classList.toggle("fs", !!STATE.ui.fullscreen);

  const s=stableSig();
  $("sig").textContent=s;
  $("sig2").textContent=s;

  $("fsLabel").textContent = STATE.ui.fullscreen ? "ON":"OFF";
  $("blkLabel").textContent = STATE.ui.blackout ? "ON":"OFF";
  $("lightLabel").textContent = String(STATE.ui.lightPreset||1);
  $("runLabel").textContent = STATE.ui.lightRunning ? "ON":"OFF";
  $("motionLabel").textContent = STATE.ui.motionOn ? "ON":"OFF";

  $("drawer").classList.toggle("open", !!STATE.ui.drawerOpen);
  root.style.setProperty("--drawer-h", String(STATE.ui.drawerH));

  $("ketaIcon").classList.toggle("open", !!STATE.ui.noteOpen);
  $("ketaNote").classList.toggle("open", !!STATE.ui.noteOpen);

  $("armedBar").style.display = (!!ARMED.url && !(STATE.ui.blackout||STATE.ui.fullscreen)) ? "flex":"none";

  $("ketaText").value = String(STATE.ketaNote||"");
  $("universals").value = String(STATE.universals||"");
  $("surfaceLabel").textContent = STATE.ui.surfaceUrl ? (STATE.ui.surfaceLabel||deriveNameFromUrl(STATE.ui.surfaceUrl)) : "—";

  if(STATE.ui.surfaceUrl){
    if(!surfaceFrame.classList.contains("on")) surfaceFrame.classList.add("on");
    if(surfaceFrame.src !== STATE.ui.surfaceUrl) surfaceFrame.src = STATE.ui.surfaceUrl;
  }else{
    surfaceFrame.classList.remove("on");
    surfaceFrame.removeAttribute("src");
  }

  if(STATE.ui.noteOpen){
  applyPanelRect(
    $("ketaNote"),
    STATE.ui.noteRect,
    { x: window.innerWidth-360, y: 76, w:340, h:220 }
  );
}

  /* apply drawer collapsed toggles */
  $("universals").style.display = STATE.ui.universalsCollapsed ? "none" : "block";
  $("storageBody").style.display = STATE.ui.storageCollapsed ? "none" : "block";
  $("surfacesBody").style.display = STATE.ui.surfacesCollapsed ? "none" : "block";

  /* apply panel rects */
 


  renderPinnedPanel();
  renderSetsStrip();

  renderSpecList();
  renderStorageInfo();
  renderSurfaceList();
  renderPad();
  playerRender();
  renderYT();
  syncMotion();
}

/* ===== hotkeys ===== */
function bindHotkeys(){
  window.addEventListener("keydown",(ev)=>{
    if(ev.repeat) return;
    const ae=document.activeElement;
    const typing = ae && (ae.tagName==="TEXTAREA" || ae.tagName==="INPUT" || ae.isContentEditable);

    if(ev.code==="Space"){
      if(!typing){
        ev.preventDefault();
        toggleRun();
        toast(STATE.ui.lightRunning ? "RUN ON" : "RUN OFF");
      }
      return;
    }

    if(ev.shiftKey && (ev.key==="I"||ev.key==="i")){ if(typing) return; ev.preventDefault(); setInvert(!STATE.ui.invert); return; }
    if(ev.shiftKey && (ev.key===")"||ev.key==="0")){ if(typing) return; ev.preventDefault(); toggleBlackout(); return; }
    if(ev.shiftKey && (ev.key==="F"||ev.key==="f")){ if(typing) return; ev.preventDefault(); toggleFullscreen(); return; }

    if(!typing && !ev.shiftKey && !ev.altKey && !ev.metaKey && !ev.ctrlKey){
      const n=Number(ev.key);
      if(n>=1 && n<=6){
        ev.preventDefault();
        selectPreset(n);
        toast(`LIGHT ${n}`);
      }
    }
  }, {passive:false});
}

/* ===== UI bindings (FIX: script is complete; player buttons work) ===== */
function bindDrawerSizer(){
  const sizer=$("drawerSizer");
  if(!sizer) return;

  let dragging=false;
  const onDown=(ev)=>{
    if(ev.button!==undefined && ev.button!==0) return;
    dragging=true;
    try{ sizer.setPointerCapture(ev.pointerId); }catch(e){}
    ev.preventDefault();
  };
  const onMove=(ev)=>{
    if(!dragging) return;
    const top=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--top"))||44;
    const bot=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--bot"))||34;

    const vh=window.innerHeight;
    const avail=vh - top - bot;
    const drawerTop = ev.clientY; // sizer y
    const desired = (vh - bot) - drawerTop; // height from pointer to bottom bar
    const h = clamp(desired, 180, avail);
    STATE.ui.drawerH = clamp(h / avail, 0.12, 0.95);
    persist(true);
    render();
  };
  const onUp=(ev)=>{
    if(!dragging) return;
    dragging=false;
    try{ sizer.releasePointerCapture(ev.pointerId); }catch(e){}
    persist(true);
  };

  sizer.addEventListener("pointerdown", onDown, {passive:false});
  window.addEventListener("pointermove", onMove, {passive:true});
  window.addEventListener("pointerup", onUp, {passive:true});
}
  

function bindUI(){
  $("toggleSystem").addEventListener("click",()=>setDrawer(!STATE.ui.drawerOpen));
  $("btnCloseDrawer").addEventListener("click",()=>setDrawer(false));

  $("btnToggleMotion").addEventListener("click",()=>{ STATE.ui.motionOn=!STATE.ui.motionOn; persist(true); });
  $("btnTogglePinnedStrip").addEventListener("click",()=>{ STATE.ui.pinnedStripOn=!STATE.ui.pinnedStripOn; persist(true); });
  $("btnToggleSetsStrip").addEventListener("click",()=>{ STATE.ui.setsStripOn=!STATE.ui.setsStripOn; persist(true); });

  $("btnToggleUniversals").addEventListener("click",()=>{
    STATE.ui.universalsCollapsed=!STATE.ui.universalsCollapsed;
    persist(true);
  });
  $("btnToggleStorage").addEventListener("click",()=>{
    STATE.ui.storageCollapsed=!STATE.ui.storageCollapsed;
    persist(true);
  });
  $("btnToggleSurfaces").addEventListener("click",()=>{
    STATE.ui.surfacesCollapsed=!STATE.ui.surfacesCollapsed;
    persist(true);
  });

  $("btnOpenStoragePad").addEventListener("click",()=>{ openPad("storage"); });

  $("armedGo").addEventListener("click",()=>go(ARMED.url));
  $("armedNewTab").addEventListener("click",()=>openNewTab(ARMED.url));
  $("armedCopy").addEventListener("click",()=>copy(ARMED.url||""));

  $("toggleRun").addEventListener("click",toggleRun);

  $("ketaIcon").addEventListener("click",()=>setKetaNote(!STATE.ui.noteOpen));
  $("btnHideNote").addEventListener("click",()=>setKetaNote(false));

  /* ANCHOR: exit blackout -> base-base, remove surface, restore bars, lights ON */
 $("anchor").addEventListener("click",()=>{
  if (!STATE.ui.blackout) return;   // anchor does nothing unless NULL

  setBlackout(false);               // restores base chrome exactly as before NULL
  persist(false);
});


  $("ketaText").addEventListener("input",()=>{ STATE.ketaNote = $("ketaText").value; persist(true); });
  $("universals").addEventListener("input",()=>{ STATE.universals = $("universals").value; persist(true); });

  $("btnExport").addEventListener("click",()=>{ downloadJsonFile(exportFilename(), exportState()); toast("EXPORTED"); });
  $("btnCopy").addEventListener("click",()=>copy(exportState()));
  $("btnImport").addEventListener("click",()=>$("file").click());
  $("file").addEventListener("change",(ev)=>{
    const f=ev.target.files && ev.target.files[0];
    if(!f) return;
    const r=new FileReader();
    r.onload=()=>{ try{importState(String(r.result||"")); toast("IMPORTED");}catch(e){toast("IMPORT FAIL");} };
    r.readAsText(f);
    ev.target.value="";
  });

  $("btnNewSpec").addEventListener("click",()=>{
    const sp={id:`SPEC_${uid8()}`, name:"", body:"", createdAt:nowISO()};
    STATE.payload.specs.unshift(sp);
    persist();
    openSpecModule(sp);
    renderSpecList();
  });

  $("btnExportState").addEventListener("click",()=>{
    downloadJsonFile(exportFilename(), exportState());
    toast("STATE EXPORTED");
  });
  $("btnExportAll").addEventListener("click",()=>{
    const all={};
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      all[k]=localStorage.getItem(k);
    }
    downloadJsonFile("localStorage_dump.json", JSON.stringify(all,null,2));
    toast("ALL EXPORTED");
  });
  $("btnClearBase").addEventListener("click",()=>{
    localStorage.removeItem(STORAGE_KEY_MAIN);
    localStorage.removeItem(STORAGE_KEY_BACKUP);
    localStorage.removeItem(STORAGE_KEY_TMP);
    STATE=deepFill(null);
    persist(false);
    toast("BASE CLEARED");
  });

  $("btnAddSurface").addEventListener("click",()=>{
    const name=$("newSurfaceName").value.trim();
    const url=$("newSurfaceUrl").value.trim();
    if(!url){ toast("NO URL"); return; }
    STATE.payload.surfaces.unshift({id:`SURF_${uid8()}`,name:canonName(name)||deriveNameFromUrl(url),url,pinned:false});
    $("newSurfaceName").value="";
    $("newSurfaceUrl").value="";
    persist();
    renderSurfaceList();
    renderPinnedPanel();
    toast("ADDED");
  });

  $("btnSurfaceBulkAdd").addEventListener("click",()=>{
    const parsed=parseBulkLines($("surfaceBulk").value||"");
    if(!parsed.length){ toast("NO BULK"); return; }
    parsed.forEach(p=>{
      STATE.payload.surfaces.unshift({id:`SURF_${uid8()}`, name:canonName(p.name)||deriveNameFromUrl(p.url), url:p.url, pinned:false});
    });
    $("surfaceBulk").value="";
    persist();
    renderSurfaceList();
    toast("BULK ADDED");
  });

  $("btnSurfaceBulkToQueue").addEventListener("click",()=>{
    const parsed=parseBulkLines($("surfaceBulk").value||"");
    if(!parsed.length){ toast("NO BULK"); return; }
    parsed.forEach(p=>{
      STATE.ui.player.queue.push({label:canonName(p.name)||deriveNameFromUrl(p.url), url:p.url});
    });
    $("surfaceBulk").value="";
    STATE.ui.playerOpen=true;
    toast("BULK → QUEUE");
    persist(true);
    playerRender();
  });

  $("btnSurfaceBulkClear").addEventListener("click",()=>{ $("surfaceBulk").value=""; toast("CLEARED"); });

  $("btnPinnedToQueue").addEventListener("click",()=>{
    const pinned=(STATE.payload.surfaces||[]).filter(s=>s.pinned && s.url);
    if(!pinned.length){ toast("NO PINNED"); return; }
    pinned.forEach(s=>{
      STATE.ui.player.queue.push({label:canonName(s.name)||deriveNameFromUrl(s.url), url:s.url});
    });
    STATE.ui.playerOpen=true;
    toast("PINNED → QUEUE");
    persist(true);
    playerRender();
  });

  $("btnPinnedCreateSet").addEventListener("click",()=>{
    const pinned=(STATE.payload.surfaces||[]).filter(s=>s.pinned && s.url);
    if(!pinned.length){ toast("NO PINNED"); return; }
    const id=`SET_${uid8()}`;
    const label="PINNED_"+nowISO().slice(0,10).replace(/-/g,"");
    const items=pinned.map(s=>({label:canonName(s.name)||deriveNameFromUrl(s.url), url:s.url}));
    STATE.payload.sets.unshift({id,label,items,createdAt:nowISO(),updatedAt:nowISO()});
    toast("SET CREATED");
    persist();
    renderSetsStrip();
    renderPlayerSetsList();
  });

  $("btnOpenPad").addEventListener("click",()=>openPad());

  $("togglePlayer").addEventListener("click",()=>{ STATE.ui.playerOpen=!STATE.ui.playerOpen; persist(true); playerRender(); });
  $("togglePad").addEventListener("click",()=>{ STATE.ui.padOpen ? closePad() : openPad(); });

  $("padClose").addEventListener("click", closePad);
  $("padHead").querySelectorAll("[data-tab]").forEach(btn=>{
    btn.addEventListener("click",()=>{
      STATE.ui.padTab=btn.getAttribute("data-tab");
      persist(true);
      renderPad();
    });
  });

  $("playerClose").addEventListener("click", playerClose);
  $("playerCollapse").addEventListener("click", ()=>{
    STATE.ui.playerCollapsed = !STATE.ui.playerCollapsed;
    persist(true);
    playerRender();
  });
  $("playerPrev").addEventListener("click", playerPrev);
  $("playerNext").addEventListener("click", playerNext);
  $("playerPlay").addEventListener("click", playerTogglePlay);
  $("playerSurf").addEventListener("click", playerSurfaceNow);
  $("playerStopSurface").addEventListener("click", ()=>{
  clearSurfacePlaying();              // removes surface overlay / iframe
  STATE.ui.player.playing = false;    // stops play state only
  toast("SURFACE STOPPED");
  persist(true);
  playerRender();
});
  $("playerNewTabNow").addEventListener("click", ()=>{ const cur=playerNow(); if(!cur||!cur.url){toast("NO NOW");return;} openNewTab(cur.url); });
  $("playerArmNow").addEventListener("click", ()=>{ const cur=playerNow(); if(!cur||!cur.url){toast("NO NOW");return;} arm(cur.label,cur.url); toast("ARMED"); persist(true); });
  $("playerAddArmed").addEventListener("click", playerAddArmed);
  $("playerClear").addEventListener("click", ()=>{ STATE.ui.player.queue=[]; STATE.ui.player.index=0; STATE.ui.player.playing=false; toast("CLEARED"); persist(true); playerRender(); });
  $("playerCreateSet").addEventListener("click", playerCreateSetFromQueue);

  $("playerAddInput").addEventListener("click", ()=>playerAddInputUrl(false));
  $("playerSurfaceInput").addEventListener("click", ()=>playerAddInputUrl(true));
  $("playerInputToArmed").addEventListener("click", playerArmInput);
  $("playerInputClear").addEventListener("click", ()=>{ $("playerInputUrl").value=""; toast("CLEARED"); });
  $("playerOpenYT").addEventListener("click", ()=>{
    STATE.ui.ytOpen=true;
    const cur=playerNow();
    if(cur && cur.url) STATE.ui.yt.input = String(cur.url||"");
    syncYTUIFromState();
    applyYTEmbedFromState(true);
    persist(true);
    renderYT();
  });
  $("playerImportBulk").addEventListener("click", playerImportBulk);
  $("playerClearBulk").addEventListener("click", ()=>{ $("playerBulkInput").value=""; toast("CLEARED"); });

  /* YT UI */
  $("ytClose").addEventListener("click", ()=>{ STATE.ui.ytOpen=false; persist(true); renderYT(); });
  $("ytApply").addEventListener("click", ()=>{
    STATE.ui.yt.input = $("ytInput").value.trim();
    STATE.ui.yt.autoplay = $("ytAutoplay").checked;
    STATE.ui.yt.mute = $("ytMute").checked;
    STATE.ui.yt.loop = $("ytLoop").checked;
    STATE.ui.yt.controls = $("ytControls").checked;
    STATE.ui.yt.nocookie = $("ytNoCookie").checked;
    applyYTEmbedFromState(false);
    persist(true);
    renderYT();
  });
  ["ytAutoplay","ytMute","ytLoop","ytControls","ytNoCookie"].forEach(id=>{
    $(id).addEventListener("change", ()=>{
      STATE.ui.yt.autoplay = $("ytAutoplay").checked;
      STATE.ui.yt.mute = $("ytMute").checked;
      STATE.ui.yt.loop = $("ytLoop").checked;
      STATE.ui.yt.controls = $("ytControls").checked;
      STATE.ui.yt.nocookie = $("ytNoCookie").checked;
      persist(true);
    });
  });
  $("ytOpenTab").addEventListener("click", ()=>{ if(STATE.ui.yt.lastEmbedSrc){ openNewTab(STATE.ui.yt.lastEmbedSrc); } else toast("NO YT"); });
  $("ytClear").addEventListener("click", ()=>{
    $("ytInput").value="";
    STATE.ui.yt.input="";
    STATE.ui.yt.lastEmbedSrc="";
    ytFrame.removeAttribute("src");
    toast("YT CLEARED");
    persist(true);
  });
  $("ytArmed").addEventListener("click", ()=>{
    const src=STATE.ui.yt.lastEmbedSrc || ytFrame.src || "";
    if(!src){ toast("NO YT"); return; }
    arm("YT", src);
    toast("ARMED");
    persist(true);
  });

  /* light quick */
  if(lightQuick){
    lightQuick.addEventListener("click", ()=>{
      const next = (Number(STATE.ui.lightPreset||1)%6)+1;
      setLight(next);
      toast("LIGHT "+next);
    });
  }

  /* player/pad draggable + persist rects */
  makeDragSmooth($("playerPanel"), $("playerHead"), {
    minTop: (parseInt(getComputedStyle(document.documentElement).getPropertyValue("--top"))||44),
    onEnd:(r)=>{ STATE.ui.playerRect={x:r.x,y:r.y,w:r.w,h:r.h}; persist(true); }
  });
  makeDragSmooth($("padPanel"), $("padHead"), {
    minTop: (parseInt(getComputedStyle(document.documentElement).getPropertyValue("--top"))||44),
    onEnd:(r)=>{ STATE.ui.padRect={x:r.x,y:r.y,w:r.w,h:r.h}; persist(true); }
  });
  makeDragSmooth($("ytPanel"), $("ytHead"), {
    minTop: (parseInt(getComputedStyle(document.documentElement).getPropertyValue("--top"))||44),
    onEnd:(r)=>{ STATE.ui.ytRect={x:r.x,y:r.y,w:r.w,h:r.h}; persist(true); }
  });
  makeDragSmooth($("ketaNote"), $("ketaHead"), {
    minTop: (parseInt(getComputedStyle(document.documentElement).getPropertyValue("--top"))||44),
    onEnd:(r)=>{ STATE.ui.noteRect={x:r.x,y:r.y,w:r.w,h:r.h}; persist(true); }
  });

  attachResizableState($("playerPanel"), ()=>STATE.ui.playerRect, (r)=>{ STATE.ui.playerRect=r; });
  attachResizableState($("padPanel"), ()=>STATE.ui.padRect, (r)=>{ STATE.ui.padRect=r; });
  attachResizableState($("ytPanel"), ()=>STATE.ui.ytRect, (r)=>{ STATE.ui.ytRect=r; });
  attachResizableState($("ketaNote"), ()=>STATE.ui.noteRect, (r)=>{ STATE.ui.noteRect=r; });

  bindDrawerSizer();
}

/* ===== boot ===== */
(function boot(){
  try{
    document.documentElement.style.setProperty("--light", String(STATE.ui.lightPreset||1));
    if(STATE.ui.lightRunning && !STATE.ui.blackout) startLight(STATE.ui.lightPreset||1);
    if(STATE.ui.motionOn) motion.classList.add("run");
  }catch(e){}

  /* ensure panel absolute positioning for drags */
  ["padPanel","playerPanel","ytPanel"].forEach(id=>{
    const el=$(id);
    if(el && !el.style.left){
      const r=el.getBoundingClientRect();
      el.style.left=r.left+"px";
      el.style.top=r.top+"px";
    }
  });

  bindHotkeys();
  bindUI();

  _BOOTING=false;
  render();
})();
</script>

<!-- AE/EE/WB SERIALIZATION STAMP :: AE=KETADATA_DIVA9_SUR_BASE91_ITER_A__PATCHED_FULL :: EE=INDEP_BASE_LOCALFIRST :: WB=DRAG_FIX+PLAYER_FIX+DRAWER_SIZER :: FILE_ID=SUR_BASE91_ITER_A :: ROOM_ID=SUR_BASE :: VERSION=v2 :: UPDATED_AT=2026-01-06 :: CHANGELOG=FULL_REMAKE;FIX_SCRIPT_TRUNCATION;FIX_HEADER_DRAG_BUTTON_CLICKS;ADD_SMOOTH_REORDER;PERSIST_PANEL_RECTS;DRAWER_SIZER_TO_TOP;PLAYER_BUTTONS_WORK -->
</body>
</html>
