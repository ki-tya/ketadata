<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>KETADATA // CHROMA_ACID</title>
<style>
  :root{
    --ui: 12px;
    --font: Arial, Helvetica, sans-serif;

    --invert: 0;
    --motion: 1;
    --null: 0;
    --light: 4;

    --pal: "ACID";
    --bg0: #000000;
    --bg1: #0b0b0f;
    --a0:  #7dff00;
    --a1:  #00e5ff;
    --a2:  #ff2bd6;
    --a3:  #ffd400;

    --grain: 0.10;
    --scan:  0.14;
    --aberr: 1.6;
    --bloom: 0.55;
    --speed: 0.55;
    --angle: 145deg;

    --panelBg: rgba(0,0,0,0.55);
    --line: rgba(255,255,255,0.14);
    --line2: rgba(255,255,255,0.26);

    --ctrlH: 28px;
    --padX: 10px;

    --hudX: 16px;
    --hudY: 16px;
    --hudW: 292px;

    --mode: "MIND";
    --seed: 42;

    --explain: 1;
  }

  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    background:#000;
    color:#fff;
    font-family: var(--font);
    font-size: var(--ui);
    line-height: 1.2;
    overflow:hidden;
    filter: invert(var(--invert));
  }

  /* VISUAL */
  #v{
    position:fixed;
    inset:0;
    width:100%;
    height:100%;
    display:block;
    z-index:1;
    background:
      radial-gradient(1200px 900px at 15% 20%, rgba(255,255,255,0.08), transparent 70%),
      linear-gradient(var(--angle), var(--bg0), var(--bg1));
  }

  /* OVERLAYS */
  .hud{
    position:fixed;
    left:var(--hudX);
    top:var(--hudY);
    width:var(--hudW);
    z-index:50;
    background: var(--panelBg);
    border:1px solid var(--line2);
    backdrop-filter: blur(8px);
    padding: 10px;
    overflow:hidden;
    user-select:none;
  }

  .rowTop{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    padding-bottom:10px;
    margin-bottom:10px;
    border-bottom:1px solid var(--line);
  }

  .leftTag{
    display:flex;
    gap:8px;
    align-items:center;
    min-width:0;
  }

  .sqBtn{
    width:var(--ctrlH);
    height:var(--ctrlH);
    border:1px solid var(--line2);
    background: rgba(0,0,0,0.45);
    display:inline-flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
  }
  .sqBtn:hover{ border-color: rgba(255,255,255,0.52); background: rgba(255,255,255,0.06); }
  .sq{
    width:10px;height:10px;background:#fff;display:inline-block;
  }

  .btn{
    height:var(--ctrlH);
    width:100%;
    border:1px solid var(--line2);
    background: rgba(0,0,0,0.45);
    color:#fff;
    font-family: var(--font);
    font-size: var(--ui);
    letter-spacing: .14em;
    text-transform: uppercase;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    white-space:nowrap;
  }
  .btn:hover{ border-color: rgba(255,255,255,0.52); background: rgba(255,255,255,0.06); }
  .btn.on{ border-color: rgba(255,255,255,0.72); background: rgba(255,255,255,0.08); }

  .grid2{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:8px;
    align-items:stretch;
  }

  .lbl{
    margin:10px 0 6px;
    color: rgba(255,255,255,0.72);
    letter-spacing:.14em;
    text-transform:uppercase;
  }

  input[type="range"], input[type="number"], select{
    width:100%;
    height:var(--ctrlH);
    border:1px solid var(--line2);
    background:#000;
    color:#fff;
    font-family: var(--font);
    font-size: var(--ui);
    padding:0 8px;
    outline:none;
  }
  input[type="range"]{
    height:auto;
    padding:0;
    border:none;
    background:transparent;
  }

  .micro{
    position:fixed;
    left:16px;
    bottom:16px;
    z-index:60;
    color: rgba(255,255,255,0.46);
    letter-spacing:.14em;
    text-transform:uppercase;
    font-size: var(--ui);
    user-select:none;
  }
  .kbd{
    padding:2px 6px;
    border:1px solid rgba(255,255,255,0.16);
    background: rgba(0,0,0,0.35);
    margin-right:6px;
  }

  .centerMark{
    position:fixed;
    left:50%;
    top:55%;
    transform: translate(-50%,-50%);
    z-index:40;
    text-align:center;
    pointer-events:none;
    width: min(860px, calc(100vw - 60px));
  }
  .title{
    margin:0;
    font-size: var(--ui);
    letter-spacing:.18em;
    text-transform:uppercase;
    color: rgba(255,255,255,0.88);
    text-shadow: 0 0 18px rgba(255,255,255,0.06);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .explain{
    position:fixed;
    right:16px;
    top:16px;
    width: min(560px, calc(100vw - 32px));
    z-index:55;
    background: rgba(0,0,0,0.50);
    border:1px solid var(--line2);
    backdrop-filter: blur(10px);
    padding: 10px;
    display: block;
  }
  body[data-explain="0"] .explain{ display:none; }

  .block{
    border:1px solid rgba(255,255,255,0.12);
    background: rgba(0,0,0,0.35);
    padding: 10px;
    margin-top:10px;
  }

  .mono{
    letter-spacing:.06em;
    text-transform:uppercase;
    color: rgba(255,255,255,0.72);
  }
  .quote{
    color: rgba(255,255,255,0.62);
    letter-spacing:.04em;
    text-transform:none;
  }

  /* NOTE */
  .note{
    position:fixed;
    right:16px;
    bottom:16px;
    width: min(520px, calc(100vw - 32px));
    z-index:70;
    background: rgba(0,0,0,0.70);
    border:1px solid rgba(255,255,255,0.58);
    display:none;
  }
  .noteHead{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    padding:10px;
    border-bottom:1px solid rgba(255,255,255,0.18);
    letter-spacing:.14em;
    text-transform:uppercase;
  }
  .note textarea{
    width:100%;
    height: 180px;
    resize:vertical;
    padding:10px;
    border:none;
    outline:none;
    background:#000;
    color:#fff;
    font-family: var(--font);
    font-size: var(--ui);
    line-height:1.25;
  }

  /* NULL */
  body[data-null="1"] .hud,
  body[data-null="1"] .micro,
  body[data-null="1"] .explain,
  body[data-null="1"] .centerMark,
  body[data-null="1"] .note{ display:none !important; }
</style>
</head>

<body data-explain="1" data-null="0">
<canvas id="v"></canvas>

<div class="hud" id="hud">
  <div class="rowTop">
    <div class="leftTag">
      <button class="sqBtn" id="btnNote" title="KETA_NOTE (SHIFT+N)"><span class="sq"></span></button>
      <div style="letter-spacing:.14em;text-transform:uppercase;color:rgba(255,255,255,0.78);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
        CHROMA / ACID
      </div>
    </div>
    <button class="sqBtn" id="btnNull" title="NULL (SHIFT+M)"><span class="sq" style="outline:1px solid #fff;background:transparent;"></span></button>
  </div>

  <div class="grid2">
    <button class="btn on" id="btnMotion">MOTION: ON</button>
    <button class="btn" id="btnInvert">INVERT</button>
  </div>

  <div class="lbl">MODE</div>
  <div class="grid2">
    <select id="modeSel">
      <option value="MIND">MIND</option>
      <option value="FLOW">FLOW</option>
      <option value="EXCHANGE">EXCHANGE</option>
    </select>
    <select id="palSel">
      <option value="ACID">ACID</option>
      <option value="VOID">VOID</option>
      <option value="CHROME">CHROME</option>
      <option value="INFRA">INFRA</option>
      <option value="AQUA">AQUA</option>
    </select>
  </div>

  <div class="lbl">LIGHTS</div>
  <div class="grid2">
    <select id="lightSel">
      <option value="1">1</option><option value="2">2</option><option value="3">3</option>
      <option value="4" selected>4</option><option value="5">5</option><option value="6">6</option>
    </select>
    <button class="btn on" id="btnExplain">EXPLAIN: ON</button>
  </div>

  <div class="lbl">SUBSTANCE</div>
  <div class="grid2">
    <div>
      <div class="mono">SPEED</div>
      <input id="speed" type="range" min="0" max="1" step="0.01" value="0.55" />
    </div>
    <div>
      <div class="mono">ABERR</div>
      <input id="aberr" type="range" min="0" max="4" step="0.05" value="1.6" />
    </div>
  </div>

  <div class="grid2" style="margin-top:8px;">
    <div>
      <div class="mono">GRAIN</div>
      <input id="grain" type="range" min="0" max="0.35" step="0.01" value="0.10" />
    </div>
    <div>
      <div class="mono">SCAN</div>
      <input id="scan" type="range" min="0" max="0.35" step="0.01" value="0.14" />
    </div>
  </div>

  <div class="lbl">STATE IO</div>
  <div class="grid2">
    <button class="btn" id="btnExport">EXPORT</button>
    <label class="btn" for="importFile" style="cursor:pointer;">IMPORT</label>
    <input id="importFile" type="file" accept="application/json" style="display:none;" />
  </div>
</div>

<div class="centerMark">
  <p class="title" id="centerTitle">KETADATA // CHROMA_ACID // MODE: MIND</p>
</div>

<div class="explain" id="explain">
  <div class="mono">INTERPRETIVE SURFACE</div>
  <div class="block">
    <div class="mono">SOURCE</div>
    <div class="quote" id="quoteA"></div>
  </div>
  <div class="block">
    <div class="mono">PRIMITIVES (CONDENSED)</div>
    <div class="quote" id="quoteB"></div>
  </div>
  <div class="block">
    <div class="mono">FLOW CONTRACT</div>
    <div class="quote" id="quoteC"></div>
  </div>
</div>

<div class="note" id="note">
  <div class="noteHead">
    <div>KETA_NOTE</div>
    <button class="sqBtn" id="btnNoteHide" title="HIDE"><span class="sq" style="width:12px;height:2px;"></span></button>
  </div>
  <textarea id="noteText" spellcheck="false" placeholder="INSTANT THOUGHT SPACE"></textarea>
</div>

<div class="micro">
  <span class="kbd">SPACE</span> MOTION
  <span class="kbd">SHIFT+I</span> INVERT
  <span class="kbd">SHIFT+N</span> NOTE
  <span class="kbd">SHIFT+M</span> NULL
  <span class="kbd">1–6</span> LIGHT
</div>

<script>
(() => {
  const FILE_ID = "KETADATA_CHROMA_ACID";
  const ROOM_ID = "STUDIO";
  const VERSION_ID = "v1";
  const STORAGE_KEY = `KDT::STATE::${FILE_ID}::${ROOM_ID}::${VERSION_ID}`;
  const NOTE_KEY = "KDT_GLOBAL_KETA_NOTE_V1";

  const $ = (id) => document.getElementById(id);

  const els = {
    c: $("v"),
    hud: $("hud"),
    btnMotion: $("btnMotion"),
    btnInvert: $("btnInvert"),
    btnExplain: $("btnExplain"),
    btnNull: $("btnNull"),
    modeSel: $("modeSel"),
    palSel: $("palSel"),
    lightSel: $("lightSel"),
    speed: $("speed"),
    aberr: $("aberr"),
    grain: $("grain"),
    scan: $("scan"),
    centerTitle: $("centerTitle"),
    explain: $("explain"),
    quoteA: $("quoteA"),
    quoteB: $("quoteB"),
    quoteC: $("quoteC"),
    btnExport: $("btnExport"),
    importFile: $("importFile"),
    btnNote: $("btnNote"),
    note: $("note"),
    noteText: $("noteText"),
    btnNoteHide: $("btnNoteHide"),
  };

  const ctx = els.c.getContext("2d", { alpha:false });

  const PALETTES = {
    ACID:  { bg0:"#000000", bg1:"#0b0b0f", a0:"#7dff00", a1:"#00e5ff", a2:"#ff2bd6", a3:"#ffd400" },
    VOID:  { bg0:"#000000", bg1:"#111111", a0:"#ffffff", a1:"#bdbdbd", a2:"#7a7a7a", a3:"#2a2a2a" },
    CHROME:{ bg0:"#000000", bg1:"#171717", a0:"#f2f2f2", a1:"#c8c8c8", a2:"#8a8a8a", a3:"#3a3a3a" },
    INFRA: { bg0:"#000000", bg1:"#12050a", a0:"#ff1744", a1:"#ff6d00", a2:"#ff00d4", a3:"#ffe600" },
    AQUA:  { bg0:"#000000", bg1:"#041018", a0:"#00ffd5", a1:"#00aaff", a2:"#7dff00", a3:"#ffffff" },
  };

  const TEXT = {
    MIND: {
      a: "DRIFT STABILIZED INTO A WINDOW. BASE IS ORIGIN. STATE IS SUBSTANCE. SURFACES HOLD INSTANT THOUGHT. DEPTH IS ARRANGEMENT.",
      b: "BOTH OR NEITHER. NO FORCED MEANING. FEEDBACK LOOP. STREAMS OF CONSCIOUSNESS.",
      c: "CHROMATIC IS A PARAMETERIZED SURFACE UNDER THE SAME LAWS. DISCIPLINE = SERIALIZATION + ROUTING."
    },
    FLOW: {
      a: "YOU STOPPED FIGHTING DRIFT WITH STRUCTURE. YOU TUNED AN INSTRUMENT: MOTION, INVERT, LIGHTS, TYPE, STATE.",
      b: "DELTA OVER REMAKE. TIGHT LOOP FIRST. WIDE FIELD OPTIONAL.",
      c: "ONE GATING QUESTION MAX WHEN IT SAVES A REWRITE. OTHERWISE: BUILD."
    },
    EXCHANGE: {
      a: "WE MADE PRIMITIVES LEGIBLE. WE SET COMPOUNDING CONSTRAINTS. WE TURNED THEORY INTO IMPLEMENTABLE INTERFACES.",
      b: "TRAPS: MORE-AS-FIRST-RESPONSE. STATE/IO DRIFT. OVER-INSTRUCTION MID-FLOW. CORE PROLIFERATION.",
      c: "COMPOUNDING MOVE: ACCEPTANCE CHECKLIST. NO NEW SURFACES UNTIL SYSTEM + STUDIO + ONE ROOM PASS."
    }
  };

  const state = {
    updatedAt: new Date().toISOString(),
    invert: 0,
    motion: 1,
    nullMode: 0,
    explain: 1,
    mode: "MIND",
    palette: "ACID",
    light: 4,
    speed: 0.55,
    aberr: 1.6,
    grain: 0.10,
    scan: 0.14,
    seed: 42,
  };

  function setCSS(name, value){ document.documentElement.style.setProperty(name, value); }
  function setBodyAttr(name, value){ document.body.setAttribute(name, String(value)); }

  function applyPalette(name){
    const p = PALETTES[name] || PALETTES.ACID;
    setCSS("--bg0", p.bg0);
    setCSS("--bg1", p.bg1);
    setCSS("--a0",  p.a0);
    setCSS("--a1",  p.a1);
    setCSS("--a2",  p.a2);
    setCSS("--a3",  p.a3);
    setCSS("--pal", `"${name}"`);
  }

  function applyUI(){
    setCSS("--invert", state.invert ? 1 : 0);
    setCSS("--motion", state.motion ? 1 : 0);
    setCSS("--null", state.nullMode ? 1 : 0);
    setCSS("--light", state.light);

    setCSS("--speed", state.speed);
    setCSS("--aberr", state.aberr);
    setCSS("--grain", state.grain);
    setCSS("--scan", state.scan);

    setCSS("--mode", `"${state.mode}"`);
    setCSS("--seed", state.seed);

    setBodyAttr("data-explain", state.explain ? 1 : 0);
    setBodyAttr("data-null", state.nullMode ? 1 : 0);

    els.btnMotion.classList.toggle("on", !!state.motion);
    els.btnMotion.textContent = state.motion ? "MOTION: ON" : "MOTION: OFF";

    els.btnInvert.classList.toggle("on", !!state.invert);

    els.btnExplain.classList.toggle("on", !!state.explain);
    els.btnExplain.textContent = state.explain ? "EXPLAIN: ON" : "EXPLAIN: OFF";

    els.centerTitle.textContent = `KETADATA // CHROMA_ACID // MODE: ${state.mode}`;

    els.modeSel.value = state.mode;
    els.palSel.value = state.palette;
    els.lightSel.value = String(state.light);

    els.speed.value = String(state.speed);
    els.aberr.value = String(state.aberr);
    els.grain.value = String(state.grain);
    els.scan.value = String(state.scan);

    els.quoteA.textContent = TEXT[state.mode].a;
    els.quoteB.textContent = TEXT[state.mode].b;
    els.quoteC.textContent = TEXT[state.mode].c;

    applyPalette(state.palette);
  }

  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
  function rnd(seed){
    // deterministic LCG
    let s = seed >>> 0;
    return () => (s = (s * 1664525 + 1013904223) >>> 0) / 4294967296;
  }

  function resize(){
    const dpr = Math.min(2, window.devicePixelRatio || 1);
    els.c.width  = Math.floor(window.innerWidth * dpr);
    els.c.height = Math.floor(window.innerHeight * dpr);
    els.c.style.width = window.innerWidth + "px";
    els.c.style.height = window.innerHeight + "px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }

  function hexToRgb(h){
    const x = h.replace("#","");
    const r = parseInt(x.slice(0,2),16);
    const g = parseInt(x.slice(2,4),16);
    const b = parseInt(x.slice(4,6),16);
    return {r,g,b};
  }
  function rgbToStr(o,a=1){ return `rgba(${o.r},${o.g},${o.b},${a})`; }

  function mix(a,b,t){
    return {
      r: Math.round(a.r + (b.r-a.r)*t),
      g: Math.round(a.g + (b.g-a.g)*t),
      b: Math.round(a.b + (b.b-a.b)*t),
    };
  }

  function draw(t){
    const w = window.innerWidth, h = window.innerHeight;
    const dt = t * 0.001;
    const p = PALETTES[state.palette] || PALETTES.ACID;

    // base
    const g = ctx.createLinearGradient(0,0,w,h);
    g.addColorStop(0, p.bg0);
    g.addColorStop(1, p.bg1);
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);

    const rr = rnd(state.seed + Math.floor(dt * 0.2));

    // intensity mapping
    const L = state.light; // 1..6
    const iA = 0.10 + (L/6) * 0.26;
    const iB = 0.08 + (L/6) * 0.22;
    const iC = 0.06 + (L/6) * 0.20;
    const bloom = 0.10 + (L/6) * 0.55;

    const col0 = hexToRgb(p.a0);
    const col1 = hexToRgb(p.a1);
    const col2 = hexToRgb(p.a2);
    const col3 = hexToRgb(p.a3);

    // acid field: drifting blobs + chroma aberration offsets
    const motion = state.motion ? (0.12 + state.speed * 1.25) : 0.0;
    const ax = Math.sin(dt * 0.7 * motion + state.seed) * 0.5;
    const ay = Math.cos(dt * 0.9 * motion + state.seed*0.7) * 0.5;

    // multi-layer blobs
    const blobs = 9 + Math.floor((L/6) * 10);
    for (let k=0;k<blobs;k++){
      const u = rr();
      const v = rr();
      const baseX = (u*w);
      const baseY = (v*h);
      const r0 = (Math.min(w,h) * (0.10 + rr()*0.22)) * (0.75 + (L/6)*0.75);

      const wob = (k%2===0?1:-1);
      const x = baseX + Math.sin(dt*(0.6+0.12*k)*motion + u*12.3) * (44 + 38*(L/6)) * wob;
      const y = baseY + Math.cos(dt*(0.5+0.10*k)*motion + v*11.1) * (40 + 34*(L/6)) * -wob;

      const sel = k % 4;
      const A = sel===0?col0:sel===1?col1:sel===2?col2:col3;
      const B = sel===0?col1:sel===1?col2:sel===2?col3:col0;

      // core
      const rg = ctx.createRadialGradient(x,y,0, x,y,r0);
      rg.addColorStop(0, rgbToStr(A, iA));
      rg.addColorStop(0.55, rgbToStr(mix(A,B,0.55), iB));
      rg.addColorStop(1, rgbToStr(B, 0));

      ctx.fillStyle = rg;
      ctx.fillRect(x-r0,y-r0,r0*2,r0*2);

      // aberration rings
      const ab = state.aberr;
      ctx.globalCompositeOperation = "screen";
      ctx.fillStyle = rgbToStr(A, 0.035 + bloom*0.05);
      ctx.beginPath();
      ctx.ellipse(x + ab*ax*6, y + ab*ay*6, r0*0.62, r0*0.46, dt*0.2, 0, Math.PI*2);
      ctx.fill();

      ctx.fillStyle = rgbToStr(B, 0.03 + bloom*0.045);
      ctx.beginPath();
      ctx.ellipse(x - ab*ax*5, y - ab*ay*5, r0*0.58, r0*0.44, -dt*0.18, 0, Math.PI*2);
      ctx.fill();

      ctx.globalCompositeOperation = "source-over";
    }

    // scanlines
    if (state.scan > 0){
      ctx.globalCompositeOperation = "overlay";
      ctx.fillStyle = `rgba(255,255,255,${state.scan})`;
      const step = 3;
      for (let y=0; y<h; y+=step){
        ctx.fillRect(0,y,w,1);
      }
      ctx.globalCompositeOperation = "source-over";
    }

    // grain
    if (state.grain > 0){
      const gA = state.grain;
      ctx.globalCompositeOperation = "overlay";
      const n = 1200;
      for (let i=0;i<n;i++){
        const x = Math.floor(rr()*w);
        const y = Math.floor(rr()*h);
        const a = gA * (0.35 + rr()*0.65);
        ctx.fillStyle = `rgba(255,255,255,${a})`;
        ctx.fillRect(x,y,1,1);
      }
      ctx.globalCompositeOperation = "source-over";
    }

    // subtle “feedback loop” ring around center
    ctx.globalCompositeOperation = "screen";
    const cx = w*0.5, cy = h*0.55;
    const ringR = Math.min(w,h) * (0.18 + (L/6)*0.14);
    const ring = ctx.createRadialGradient(cx,cy, ringR*0.25, cx,cy, ringR);
    ring.addColorStop(0, `rgba(255,255,255,0)`);
    ring.addColorStop(0.60, `rgba(255,255,255,${0.06 + (L/6)*0.10})`);
    ring.addColorStop(1, `rgba(255,255,255,0)`);
    ctx.fillStyle = ring;
    ctx.fillRect(0,0,w,h);
    ctx.globalCompositeOperation = "source-over";
  }

  let raf = null;
  function loop(t){
    draw(t);
    raf = requestAnimationFrame(loop);
  }

  function save(){
    state.updatedAt = new Date().toISOString();
    const payload = {
      version: "KETADATA_CHROMA_STATE_v1",
      updatedAt: state.updatedAt,
      fileId: FILE_ID,
      roomId: ROOM_ID,
      versionId: VERSION_ID,
      ui: {
        invert: !!state.invert,
        motion: !!state.motion,
        nullMode: !!state.nullMode,
        explain: !!state.explain,
        mode: state.mode,
        palette: state.palette,
        light: state.light,
        speed: state.speed,
        aberr: state.aberr,
        grain: state.grain,
        scan: state.scan,
        seed: state.seed
      }
    };
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(payload)); }catch(e){}
    try{ localStorage.setItem(NOTE_KEY, els.noteText.value || ""); }catch(e){}
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw){
        const p = JSON.parse(raw);
        if (p && p.ui){
          Object.assign(state, {
            invert: p.ui.invert ? 1 : 0,
            motion: p.ui.motion ? 1 : 0,
            nullMode: p.ui.nullMode ? 1 : 0,
            explain: p.ui.explain ? 1 : 0,
            mode: p.ui.mode || "MIND",
            palette: p.ui.palette || "ACID",
            light: clamp(Number(p.ui.light)||4,1,6),
            speed: clamp(Number(p.ui.speed)||0.55,0,1),
            aberr: clamp(Number(p.ui.aberr)||1.6,0,4),
            grain: clamp(Number(p.ui.grain)||0.10,0,0.35),
            scan: clamp(Number(p.ui.scan)||0.14,0,0.35),
            seed: Number.isFinite(Number(p.ui.seed)) ? Number(p.ui.seed) : 42
          });
        }
      }
    }catch(e){}

    try{
      const note = localStorage.getItem(NOTE_KEY);
      if (typeof note === "string") els.noteText.value = note;
    }catch(e){}
  }

  function downloadJson(filename, obj){
    const blob = new Blob([JSON.stringify(obj, null, 2)], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 500);
  }

  function doExport(){
    const payload = {
      version: "KETADATA_CHROMA_STATE_v1",
      updatedAt: new Date().toISOString(),
      fileId: FILE_ID,
      roomId: ROOM_ID,
      versionId: VERSION_ID,
      ui: {
        invert: !!state.invert,
        motion: !!state.motion,
        nullMode: !!state.nullMode,
        explain: !!state.explain,
        mode: state.mode,
        palette: state.palette,
        light: state.light,
        speed: state.speed,
        aberr: state.aberr,
        grain: state.grain,
        scan: state.scan,
        seed: state.seed
      },
      ketaNote: els.noteText.value || ""
    };
    downloadJson(`KETADATA_CHROMA_ACID_${ROOM_ID}_${VERSION_ID}.json`, payload);
  }

  async function doImport(file){
    try{
      const txt = await file.text();
      const p = JSON.parse(txt);
      if (!p || !p.ui) return;

      state.invert = p.ui.invert ? 1 : 0;
      state.motion = p.ui.motion ? 1 : 0;
      state.nullMode = p.ui.nullMode ? 1 : 0;
      state.explain = p.ui.explain ? 1 : 0;
      state.mode = p.ui.mode || "MIND";
      state.palette = p.ui.palette || "ACID";
      state.light = clamp(Number(p.ui.light)||4,1,6);
      state.speed = clamp(Number(p.ui.speed)||0.55,0,1);
      state.aberr = clamp(Number(p.ui.aberr)||1.6,0,4);
      state.grain = clamp(Number(p.ui.grain)||0.10,0,0.35);
      state.scan = clamp(Number(p.ui.scan)||0.14,0,0.35);
      state.seed = Number.isFinite(Number(p.ui.seed)) ? Number(p.ui.seed) : 42;

      if (typeof p.ketaNote === "string") els.noteText.value = p.ketaNote;

      applyUI();
      save();
    }catch(e){}
  }

  function toggleNote(force){
    const open = els.note.style.display === "block";
    const next = (typeof force === "boolean") ? force : !open;
    els.note.style.display = next ? "block" : "none";
    save();
  }

  function applyFromControls(){
    state.mode = els.modeSel.value;
    state.palette = els.palSel.value;
    state.light = clamp(parseInt(els.lightSel.value,10),1,6);

    state.speed = clamp(parseFloat(els.speed.value),0,1);
    state.aberr = clamp(parseFloat(els.aberr.value),0,4);
    state.grain = clamp(parseFloat(els.grain.value),0,0.35);
    state.scan = clamp(parseFloat(els.scan.value),0,0.35);

    applyUI();
    save();
  }

  function bind(){
    els.btnMotion.addEventListener("click", () => {
      state.motion = state.motion ? 0 : 1;
      applyUI(); save();
    });

    els.btnInvert.addEventListener("click", () => {
      state.invert = state.invert ? 0 : 1;
      applyUI(); save();
    });

    els.btnExplain.addEventListener("click", () => {
      state.explain = state.explain ? 0 : 1;
      applyUI(); save();
    });

    els.btnNull.addEventListener("click", () => {
      state.nullMode = state.nullMode ? 0 : 1;
      applyUI(); save();
    });

    [els.modeSel, els.palSel, els.lightSel].forEach(el => el.addEventListener("change", applyFromControls));
    [els.speed, els.aberr, els.grain, els.scan].forEach(el => el.addEventListener("input", applyFromControls));

    els.btnExport.addEventListener("click", () => doExport());
    els.importFile.addEventListener("change", (e) => {
      const f = e.target.files && e.target.files[0];
      if (f) doImport(f);
      e.target.value = "";
    });

    els.btnNote.addEventListener("click", () => toggleNote());
    els.btnNoteHide.addEventListener("click", () => toggleNote(false));
    els.noteText.addEventListener("input", () => save());

    window.addEventListener("keydown", (e) => {
      const tag = (document.activeElement && document.activeElement.tagName) ? document.activeElement.tagName.toLowerCase() : "";
      const typing = (tag === "textarea" || tag === "input" || tag === "select");
      if (typing) return;

      if (e.code === "Space"){
        e.preventDefault();
        state.motion = state.motion ? 0 : 1;
        applyUI(); save();
      }
      if (e.shiftKey && (e.key === "I" || e.key === "i")){
        e.preventDefault();
        state.invert = state.invert ? 0 : 1;
        applyUI(); save();
      }
      if (e.shiftKey && (e.key === "N" || e.key === "n")){
        e.preventDefault();
        toggleNote();
      }
      if (e.shiftKey && (e.key === "M" || e.key === "m")){
        e.preventDefault();
        state.nullMode = state.nullMode ? 0 : 1;
        applyUI(); save();
      }
      if (!e.shiftKey){
        const k = e.key;
        if (k >= "1" && k <= "6"){
          state.light = parseInt(k,10);
          applyUI(); save();
        }
      }
    });

    window.addEventListener("resize", resize, { passive:true });
  }

  // init
  resize();
  load();
  applyUI();
  bind();
  raf = requestAnimationFrame(loop);
})();
</script>

<!-- ============================================================
KETADATA HTML SERIALIZATION STAMP
AE/EE/WB: WB
FILE_ID: KETADATA_CHROMA_ACID
ROOM_ID: STUDIO
VERSION: v1
UPDATED_AT: 2025-12-29T00:00:00-05:00
CHANGELOG:
- CHROMATIC SURFACE: ACID PALETTES + LIGHTS 1–6 (INTENSITY) + ABERR/GRAIN/SCAN CONTROLS
- SUBSTRATE LAWS: BASE-REACHABLE SURFACE MODEL (STATE IS SUBSTANCE) + OPTIONAL EXPLANATION (EXPLAIN TOGGLE)
- INSTANT THOUGHT: GLOBAL KETA_NOTE (SHIFT+N) STORED IN LOCALSTORAGE
- UNIVERSALS: SPACE MOTION, SHIFT+I INVERT, SHIFT+M NULL, 1–6 LIGHTS
- STATE IO: EXPORT/IMPORT DOWNLOADS/UPLOADS JSON FILES (NO PASTE-ONLY)
============================================================ -->
</body>
</html>
